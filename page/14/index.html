<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.ligoudan.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
<meta property="og:type" content="website">
<meta property="og:title" content="LIGOUDAN">
<meta property="og:url" content="https://www.ligoudan.cn/page/14/index.html">
<meta property="og:site_name" content="LIGOUDAN">
<meta property="og:description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="æç‹—è›‹">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.ligoudan.cn/page/14/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/14/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LIGOUDAN</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LIGOUDAN</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Š</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">326</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">137</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">461</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æç‹—è›‹"
      src="/uploads/ligoudan.png">
  <p class="site-author-name" itemprop="name">æç‹—è›‹</p>
  <div class="site-description" itemprop="description">å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">461</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">137</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">326</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yiyirushi" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;yiyirushi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yuanhaohoo@163.com" title="E-Mail â†’ mailto:yuanhaohoo@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/4a4c02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/4a4c02/" class="post-title-link" itemprop="url">Tomcat å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>19 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-å¿«é€Ÿå…¥é—¨"><a href="#Tomcat-å¿«é€Ÿå…¥é—¨" class="headerlink" title="Tomcat å¿«é€Ÿå…¥é—¨"></a>Tomcat å¿«é€Ÿå…¥é—¨</h1><blockquote>
<p>ğŸ ç‰ˆæœ¬è¯´æ˜</p>
<p>å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼šTomcat 8.5.24</p>
<p>ç¯å¢ƒè¦æ±‚ï¼šJDK7+</p>
</blockquote>
<h2 id="1-Tomcat-ç®€ä»‹"><a href="#1-Tomcat-ç®€ä»‹" class="headerlink" title="1. Tomcat ç®€ä»‹"></a>1. Tomcat ç®€ä»‹</h2><h3 id="1-1-Tomcat-æ˜¯ä»€ä¹ˆ"><a href="#1-1-Tomcat-æ˜¯ä»€ä¹ˆ" class="headerlink" title="1.1. Tomcat æ˜¯ä»€ä¹ˆ"></a>1.1. Tomcat æ˜¯ä»€ä¹ˆ</h3><p>Tomcat æ˜¯ç”± Apache å¼€å‘çš„ä¸€ä¸ª Servlet å®¹å™¨ï¼Œå®ç°äº†å¯¹ Servlet å’Œ JSP çš„æ”¯æŒï¼Œå¹¶æä¾›äº†ä½œä¸º Web æœåŠ¡å™¨çš„ä¸€äº›ç‰¹æœ‰åŠŸèƒ½ï¼Œå¦‚ Tomcat ç®¡ç†å’Œæ§åˆ¶å¹³å°ã€å®‰å…¨åŸŸç®¡ç†å’Œ Tomcat é˜€ç­‰ã€‚</p>
<p>ç”±äº Tomcat æœ¬èº«ä¹Ÿå†…å«äº†ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«è§†ä½œä¸€ä¸ªå•ç‹¬çš„ Web æœåŠ¡å™¨ã€‚ä½†æ˜¯ï¼Œä¸èƒ½å°† Tomcat å’Œ Apache HTTP æœåŠ¡å™¨æ··æ·†ï¼ŒApache HTTP æœåŠ¡å™¨æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å®ç°çš„ HTTP Web æœåŠ¡å™¨ï¼›è¿™ä¸¤ä¸ª HTTP web server ä¸æ˜¯æ†ç»‘åœ¨ä¸€èµ·çš„ã€‚Tomcat åŒ…å«äº†ä¸€ä¸ªé…ç½®ç®¡ç†å·¥å…·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¼–è¾‘ XML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h3 id="1-2-Tomcat-é‡è¦ç›®å½•"><a href="#1-2-Tomcat-é‡è¦ç›®å½•" class="headerlink" title="1.2. Tomcat é‡è¦ç›®å½•"></a>1.2. Tomcat é‡è¦ç›®å½•</h3><ul>
<li><strong>&#x2F;bin</strong> - Tomcat è„šæœ¬å­˜æ”¾ç›®å½•ï¼ˆå¦‚å¯åŠ¨ã€å…³é—­è„šæœ¬ï¼‰ã€‚ <code>*.sh</code> æ–‡ä»¶ç”¨äº Unix ç³»ç»Ÿï¼› <code>*.bat</code> æ–‡ä»¶ç”¨äº Windows ç³»ç»Ÿã€‚</li>
<li><strong>&#x2F;conf</strong> - Tomcat é…ç½®æ–‡ä»¶ç›®å½•ã€‚</li>
<li><strong>&#x2F;logs</strong> - Tomcat é»˜è®¤æ—¥å¿—ç›®å½•ã€‚</li>
<li><strong>&#x2F;webapps</strong> - webapp è¿è¡Œçš„ç›®å½•ã€‚</li>
</ul>
<h3 id="1-3-web-å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„"><a href="#1-3-web-å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„" class="headerlink" title="1.3. web å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„"></a>1.3. web å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„</h3><p>ä¸€èˆ¬ web é¡¹ç›®è·¯å¾„ç»“æ„</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">-- webapp                         # ç«™ç‚¹æ ¹ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- META-INF                   # META-INF ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   `-- MANIFEST.MF            # é…ç½®æ¸…å•æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- WEB-INF                    # WEB-INF ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- classes                # classæ–‡ä»¶ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- *.class            # ç¨‹åºéœ€è¦çš„ class æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   `-- *.xml              # ç¨‹åºéœ€è¦çš„ xml æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- lib                    # åº“æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   `-- *.jar              # ç¨‹åºéœ€è¦çš„ jar åŒ…</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   `-- web.xml                # Webåº”ç”¨ç¨‹åºçš„éƒ¨ç½²æè¿°æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- &lt;userdir&gt;                  # è‡ªå®šä¹‰çš„ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- &lt;userfiles&gt;                # è‡ªå®šä¹‰çš„èµ„æºæ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>webapp</code>ï¼šå·¥ç¨‹å‘å¸ƒæ–‡ä»¶å¤¹ã€‚å…¶å®æ¯ä¸ª war åŒ…éƒ½å¯ä»¥è§†ä¸º webapp çš„å‹ç¼©åŒ…ã€‚</p>
</li>
<li><p><code>META-INF</code>ï¼šMETA-INF ç›®å½•ç”¨äºå­˜æ”¾å·¥ç¨‹è‡ªèº«ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ï¼Œå…ƒæ–‡ä»¶ä¿¡æ¯ï¼Œé€šå¸¸ç”±å¼€å‘å·¥å…·ï¼Œç¯å¢ƒè‡ªåŠ¨ç”Ÿæˆã€‚</p>
</li>
<li><p><code>WEB-INF</code>ï¼šJava web åº”ç”¨çš„å®‰å…¨ç›®å½•ã€‚æ‰€è°“å®‰å…¨å°±æ˜¯å®¢æˆ·ç«¯æ— æ³•è®¿é—®ï¼Œåªæœ‰æœåŠ¡ç«¯å¯ä»¥è®¿é—®çš„ç›®å½•ã€‚</p>
</li>
<li><p><code>/WEB-INF/classes</code>ï¼šå­˜æ”¾ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰ Java class æ–‡ä»¶ã€‚</p>
</li>
<li><p><code>/WEB-INF/lib</code>ï¼šå­˜æ”¾ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰ jar æ–‡ä»¶ã€‚</p>
</li>
<li><p><code>/WEB-INF/web.xml</code>ï¼šweb åº”ç”¨çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ã€‚å®ƒæ˜¯å·¥ç¨‹ä¸­æœ€é‡è¦çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒæè¿°äº† servlet å’Œç»„æˆåº”ç”¨çš„å…¶å®ƒç»„ä»¶ï¼Œä»¥åŠåº”ç”¨åˆå§‹åŒ–å‚æ•°ã€å®‰å…¨ç®¡ç†çº¦æŸç­‰ã€‚</p>
</li>
</ul>
<h3 id="1-4-Tomcat-åŠŸèƒ½"><a href="#1-4-Tomcat-åŠŸèƒ½" class="headerlink" title="1.4. Tomcat åŠŸèƒ½"></a>1.4. Tomcat åŠŸèƒ½</h3><p>Tomcat æ”¯æŒçš„ I&#x2F;O æ¨¡å‹æœ‰ï¼š</p>
<ul>
<li>NIOï¼šéé˜»å¡ I&#x2F;Oï¼Œé‡‡ç”¨ Java NIO ç±»åº“å®ç°ã€‚</li>
<li>NIO2ï¼šå¼‚æ­¥ I&#x2F;Oï¼Œé‡‡ç”¨ JDK 7 æœ€æ–°çš„ NIO2 ç±»åº“å®ç°ã€‚</li>
<li>APRï¼šé‡‡ç”¨ Apache å¯ç§»æ¤è¿è¡Œåº“å®ç°ï¼Œæ˜¯ C&#x2F;C++ ç¼–å†™çš„æœ¬åœ°åº“ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒçš„åº”ç”¨å±‚åè®®æœ‰ï¼š</p>
<ul>
<li>HTTP&#x2F;1.1ï¼šè¿™æ˜¯å¤§éƒ¨åˆ† Web åº”ç”¨é‡‡ç”¨çš„è®¿é—®åè®®ã€‚</li>
<li>AJPï¼šç”¨äºå’Œ Web æœåŠ¡å™¨é›†æˆï¼ˆå¦‚ Apacheï¼‰ã€‚</li>
<li>HTTP&#x2F;2ï¼šHTTP 2.0 å¤§å¹…åº¦çš„æå‡äº† Web æ€§èƒ½ã€‚</li>
</ul>
<h2 id="2-Tomcat-å…¥é—¨"><a href="#2-Tomcat-å…¥é—¨" class="headerlink" title="2. Tomcat å…¥é—¨"></a>2. Tomcat å…¥é—¨</h2><h3 id="2-1-å®‰è£…"><a href="#2-1-å®‰è£…" class="headerlink" title="2.1. å®‰è£…"></a>2.1. å®‰è£…</h3><p><strong>å‰ææ¡ä»¶</strong></p>
<p>Tomcat 8.5 è¦æ±‚ JDK ç‰ˆæœ¬ä¸º 1.7 ä»¥ä¸Šã€‚</p>
<p>è¿›å…¥ <a target="_blank" rel="noopener" href="https://tomcat.apache.org/download-80.cgi">Tomcat å®˜æ–¹ä¸‹è½½åœ°å€</a> é€‰æ‹©åˆé€‚ç‰ˆæœ¬ä¸‹è½½ï¼Œå¹¶è§£å‹åˆ°æœ¬åœ°ã€‚</p>
<p><strong>Windows</strong></p>
<p>æ·»åŠ ç¯å¢ƒå˜é‡ <code>CATALINA_HOME</code> ï¼Œå€¼ä¸º Tomcat çš„å®‰è£…è·¯å¾„ã€‚</p>
<p>è¿›å…¥å®‰è£…ç›®å½•ä¸‹çš„ bin ç›®å½•ï¼Œè¿è¡Œ startup.bat æ–‡ä»¶ï¼Œå¯åŠ¨ Tomcat</p>
<p><strong>Linux &#x2F; Unix</strong></p>
<p>ä¸‹é¢çš„ç¤ºä¾‹ä»¥ 8.5.24 ç‰ˆæœ¬ä¸ºä¾‹ï¼ŒåŒ…å«äº†ä¸‹è½½ã€è§£å‹ã€å¯åŠ¨æ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½è§£å‹åˆ°æœ¬åœ°</span></span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-8/v8.5.24/bin/apache-tomcat-8.5.24.tar.gz</span><br><span class="line">tar -zxf apache-tomcat-8.5.24.tar.gz</span><br><span class="line"><span class="comment"># å¯åŠ¨ Tomcat</span></span><br><span class="line">./apache-tomcat-8.5.24/bin/startup.sh</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨åï¼Œè®¿é—® <code>http://localhost:8080</code> ï¼Œå¯ä»¥çœ‹åˆ° Tomcat å®‰è£…æˆåŠŸçš„æµ‹è¯•é¡µé¢ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/tomcat.png" alt="img"></p>
<h3 id="2-2-é…ç½®"><a href="#2-2-é…ç½®" class="headerlink" title="2.2. é…ç½®"></a>2.2. é…ç½®</h3><p>æœ¬èŠ‚å°†åˆ—ä¸¾ä¸€äº›é‡è¦ã€å¸¸è§çš„é…ç½®é¡¹ã€‚è¯¦ç»†çš„ Tomcat8 é…ç½®å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/config/index.html">Tomcat 8 é…ç½®å®˜æ–¹å‚è€ƒæ–‡æ¡£</a> ã€‚</p>
<h4 id="2-2-1-Server"><a href="#2-2-1-Server" class="headerlink" title="2.2.1. Server"></a>2.2.1. Server</h4><blockquote>
<p>Server å…ƒç´ è¡¨ç¤ºæ•´ä¸ª Catalina servlet å®¹å™¨ã€‚</p>
<p>å› æ­¤ï¼Œå®ƒå¿…é¡»æ˜¯ <code>conf/server.xml</code> é…ç½®æ–‡ä»¶ä¸­çš„æ ¹å…ƒç´ ã€‚å®ƒçš„å±æ€§ä»£è¡¨äº†æ•´ä¸ª servlet å®¹å™¨çš„ç‰¹æ€§ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç° org.apache.catalina.Server æ¥å£ã€‚</td>
<td>é»˜è®¤ org.apache.catalina.core.StandardServer</td>
</tr>
<tr>
<td>address</td>
<td>æœåŠ¡å™¨ç­‰å¾…å…³æœºå‘½ä»¤çš„ TCP &#x2F; IP åœ°å€ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šåœ°å€ï¼Œåˆ™ä½¿ç”¨ localhostã€‚</td>
<td></td>
</tr>
<tr>
<td>port</td>
<td>æœåŠ¡å™¨ç­‰å¾…å…³æœºå‘½ä»¤çš„ TCP &#x2F; IP ç«¯å£å·ã€‚è®¾ç½®ä¸º-1 ä»¥ç¦ç”¨å…³é—­ç«¯å£ã€‚</td>
<td></td>
</tr>
<tr>
<td>shutdown</td>
<td>å¿…é¡»é€šè¿‡ TCP &#x2F; IP è¿æ¥æ¥æ”¶åˆ°æŒ‡å®šç«¯å£å·çš„å‘½ä»¤å­—ç¬¦ä¸²ï¼Œä»¥å…³é—­ Tomcatã€‚</td>
<td></td>
</tr>
</tbody></table>
<h4 id="2-2-2-Service"><a href="#2-2-2-Service" class="headerlink" title="2.2.2. Service"></a>2.2.2. Service</h4><blockquote>
<p>Service å…ƒç´ è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨ç»„ä»¶çš„ç»„åˆï¼Œè¿™äº›ç»„ä»¶å…±äº«ä¸€ä¸ªç”¨äºå¤„ç†ä¼ å…¥è¯·æ±‚çš„å¼•æ“ç»„ä»¶ã€‚Server ä¸­å¯ä»¥æœ‰å¤šä¸ª Serviceã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç°<code>org.apache.catalina.Service</code>æ¥å£ã€‚</td>
<td>é»˜è®¤ <code>org.apache.catalina.core.StandardService</code></td>
</tr>
<tr>
<td>name</td>
<td>æ­¤æœåŠ¡çš„æ˜¾ç¤ºåç§°ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æ ‡å‡† Catalina ç»„ä»¶ï¼Œå°†åŒ…å«åœ¨æ—¥å¿—æ¶ˆæ¯ä¸­ã€‚ä¸ç‰¹å®šæœåŠ¡å™¨å…³è”çš„æ¯ä¸ªæœåŠ¡çš„åç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚</td>
<td></td>
</tr>
</tbody></table>
<p><strong>å®ä¾‹ - <code>conf/server.xml</code> é…ç½®æ–‡ä»¶ç¤ºä¾‹</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-Executor"><a href="#2-2-3-Executor" class="headerlink" title="2.2.3. Executor"></a>2.2.3. Executor</h4><blockquote>
<p>Executor è¡¨ç¤ºå¯ä»¥åœ¨ Tomcat ä¸­çš„ç»„ä»¶ä¹‹é—´å…±äº«çš„çº¿ç¨‹æ± ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç°<code>org.apache.catalina.Executor</code>æ¥å£ã€‚</td>
<td>é»˜è®¤ <code>org.apache.catalina.core.StandardThreadExecutor</code></td>
</tr>
<tr>
<td>name</td>
<td>çº¿ç¨‹æ± åç§°ã€‚</td>
<td>è¦æ±‚å”¯ä¸€, ä¾› Connector å…ƒç´ çš„ executor å±æ€§ä½¿ç”¨</td>
</tr>
<tr>
<td>namePrefix</td>
<td>çº¿ç¨‹åç§°å‰ç¼€ã€‚</td>
<td></td>
</tr>
<tr>
<td>maxThreads</td>
<td>æœ€å¤§æ´»è·ƒçº¿ç¨‹æ•°ã€‚</td>
<td>é»˜è®¤ 200</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>æœ€å°æ´»è·ƒçº¿ç¨‹æ•°ã€‚</td>
<td>é»˜è®¤ 25</td>
</tr>
<tr>
<td>maxIdleTime</td>
<td>å½“å‰æ´»è·ƒçº¿ç¨‹å¤§äº minSpareThreads æ—¶,ç©ºé—²çº¿ç¨‹å…³é—­çš„ç­‰å¾…æœ€å¤§æ—¶é—´ã€‚</td>
<td>é»˜è®¤ 60000ms</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>çº¿ç¨‹æ± æ»¡æƒ…å†µä¸‹çš„è¯·æ±‚æ’é˜Ÿå¤§å°ã€‚</td>
<td>é»˜è®¤ Integer.MAX_VALUE</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> <span class="attr">namePrefix</span>=<span class="string">&quot;catalina-exec-&quot;</span> <span class="attr">maxThreads</span>=<span class="string">&quot;300&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;25&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-Connector"><a href="#2-2-4-Connector" class="headerlink" title="2.2.4. Connector"></a>2.2.4. Connector</h4><blockquote>
<p>Connector ä»£è¡¨è¿æ¥ç»„ä»¶ã€‚Tomcat æ”¯æŒä¸‰ç§åè®®ï¼šHTTP&#x2F;1.1ã€HTTP&#x2F;2.0ã€AJPã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>asyncTimeout</td>
<td>Servlet3.0 è§„èŒƒä¸­çš„å¼‚æ­¥è¯·æ±‚è¶…æ—¶</td>
<td>é»˜è®¤ 30s</td>
</tr>
<tr>
<td>port</td>
<td>è¯·æ±‚è¿æ¥çš„ TCP Port</td>
<td>è®¾ç½®ä¸º 0,åˆ™ä¼šéšæœºé€‰å–ä¸€ä¸ªæœªå ç”¨çš„ç«¯å£å·</td>
</tr>
<tr>
<td>protocol</td>
<td>åè®®. ä¸€èˆ¬æƒ…å†µä¸‹è®¾ç½®ä¸º HTTP&#x2F;1.1,è¿™ç§æƒ…å†µä¸‹è¿æ¥æ¨¡å‹ä¼šåœ¨ NIO å’Œ APR&#x2F;native ä¸­è‡ªåŠ¨æ ¹æ®é…ç½®é€‰æ‹©</td>
<td></td>
</tr>
<tr>
<td>URIEncoding</td>
<td>å¯¹ URI çš„ç¼–ç æ–¹å¼.</td>
<td>å¦‚æœè®¾ç½®ç³»ç»Ÿå˜é‡ org.apache.catalina.STRICT_SERVLET_COMPLIANCE ä¸º true,ä½¿ç”¨ ISO-8859-1 ç¼–ç ;å¦‚æœæœªè®¾ç½®æ­¤ç³»ç»Ÿå˜é‡ä¸”æœªè®¾ç½®æ­¤å±æ€§, ä½¿ç”¨ UTF-8 ç¼–ç </td>
</tr>
<tr>
<td>useBodyEncodingForURI</td>
<td>æ˜¯å¦é‡‡ç”¨æŒ‡å®šçš„ contentType è€Œä¸æ˜¯ URIEncoding æ¥ç¼–ç  URI ä¸­çš„è¯·æ±‚å‚æ•°</td>
<td></td>
</tr>
</tbody></table>
<p>ä»¥ä¸‹å±æ€§åœ¨æ ‡å‡†çš„ Connector(NIO, NIO2 å’Œ APR&#x2F;native)ä¸­æœ‰æ•ˆ:</p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>acceptCount</td>
<td>å½“æœ€å¤§è¯·æ±‚è¿æ¥ maxConnections æ»¡æ—¶çš„æœ€å¤§æ’é˜Ÿå¤§å°</td>
<td>é»˜è®¤ 100,æ³¨æ„æ­¤å±æ€§å’Œ Executor ä¸­å±æ€§ maxQueueSize çš„åŒºåˆ«.è¿™ä¸ªæŒ‡çš„æ˜¯è¯·æ±‚è¿æ¥æ»¡æ—¶çš„å †æ ˆå¤§å°,Executor çš„ maxQueueSize æŒ‡çš„æ˜¯å¤„ç†çº¿ç¨‹æ»¡æ—¶çš„å †æ ˆå¤§å°</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>è¯·æ±‚è¿æ¥è¶…æ—¶</td>
<td>é»˜è®¤ 60000ms</td>
</tr>
<tr>
<td>executor</td>
<td>æŒ‡å®šé…ç½®çš„çº¿ç¨‹æ± åç§°</td>
<td></td>
</tr>
<tr>
<td>keepAliveTimeout</td>
<td>keeAlive è¶…æ—¶æ—¶é—´</td>
<td>é»˜è®¤å€¼ä¸º connectionTimeout é…ç½®å€¼.-1 è¡¨ç¤ºä¸è¶…æ—¶</td>
</tr>
<tr>
<td>maxConnections</td>
<td>æœ€å¤§è¿æ¥æ•°</td>
<td>è¿æ¥æ»¡æ—¶åç»­è¿æ¥æ”¾å…¥æœ€å¤§ä¸º acceptCount çš„é˜Ÿåˆ—ä¸­. å¯¹ NIO å’Œ NIO2 è¿æ¥,é»˜è®¤å€¼ä¸º 10000;å¯¹ APR&#x2F;native,é»˜è®¤å€¼ä¸º 8192</td>
</tr>
<tr>
<td>maxThreads</td>
<td>å¦‚æœæŒ‡å®šäº† Executor, æ­¤å±æ€§å¿½ç•¥;å¦åˆ™ä¸º Connector åˆ›å»ºçš„å†…éƒ¨çº¿ç¨‹æ± æœ€å¤§å€¼</td>
<td>é»˜è®¤ 200</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>å¦‚æœæŒ‡å®šäº† Executor, æ­¤å±æ€§å¿½ç•¥;å¦åˆ™ä¸º Connector åˆ›å»ºçº¿ç¨‹æ± çš„æœ€å°æ´»è·ƒçº¿ç¨‹æ•°</td>
<td>é»˜è®¤ 10</td>
</tr>
<tr>
<td>processorCache</td>
<td>åè®®å¤„ç†å™¨ç¼“å­˜ Processor å¯¹è±¡çš„å¤§å°</td>
<td>-1 è¡¨ç¤ºä¸é™åˆ¶.å½“ä¸ä½¿ç”¨ servlet3.0 çš„å¼‚æ­¥å¤„ç†æƒ…å†µä¸‹: å¦‚æœé…ç½® Executor,é…ç½®ä¸º Executor çš„ maxThreads;å¦åˆ™é…ç½®ä¸º Connnector çš„ maxThreads. å¦‚æœä½¿ç”¨ Serlvet3.0 å¼‚æ­¥å¤„ç†, å– maxThreads å’Œ maxConnections çš„æœ€å¤§å€¼</td>
</tr>
</tbody></table>
<h4 id="2-2-5-Context"><a href="#2-2-5-Context" class="headerlink" title="2.2.5. Context"></a>2.2.5. Context</h4><blockquote>
<p>Context å…ƒç´ è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œå®ƒåœ¨ç‰¹å®šçš„è™šæ‹Ÿä¸»æœºä¸­è¿è¡Œã€‚æ¯ä¸ª Web åº”ç”¨ç¨‹åºéƒ½åŸºäº Web åº”ç”¨ç¨‹åºå­˜æ¡£ï¼ˆWARï¼‰æ–‡ä»¶ï¼Œæˆ–è€…åŒ…å«ç›¸åº”çš„è§£åŒ…å†…å®¹çš„ç›¸åº”ç›®å½•ï¼Œå¦‚ Servlet è§„èŒƒä¸­æ‰€è¿°ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>altDDName</td>
<td>web.xml éƒ¨ç½²æè¿°ç¬¦è·¯å¾„</td>
<td>é»˜è®¤ &#x2F;WEB-INF&#x2F;web.xml</td>
</tr>
<tr>
<td>docBase</td>
<td>Context çš„ Root è·¯å¾„</td>
<td>å’Œ Host çš„ appBase ç›¸ç»“åˆ, å¯ç¡®å®š web åº”ç”¨çš„å®é™…ç›®å½•</td>
</tr>
<tr>
<td>failCtxIfServletStartFails</td>
<td>åŒ Host ä¸­çš„ failCtxIfServletStartFails, åªå¯¹å½“å‰ Context æœ‰æ•ˆ</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>logEffectiveWebXml</td>
<td>æ˜¯å¦æ—¥å¿—æ‰“å° web.xml å†…å®¹(web.xml ç”±é»˜è®¤çš„ web.xml å’Œåº”ç”¨ä¸­çš„ web.xml ç»„æˆ)</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>path</td>
<td>web åº”ç”¨çš„ context path</td>
<td>å¦‚æœä¸ºæ ¹è·¯å¾„,åˆ™é…ç½®ä¸ºç©ºå­—ç¬¦ä¸²(â€œâ€), ä¸èƒ½ä¸é…ç½®</td>
</tr>
<tr>
<td>privileged</td>
<td>æ˜¯å¦ä½¿ç”¨ Tomcat æä¾›çš„ manager servlet</td>
<td></td>
</tr>
<tr>
<td>reloadable</td>
<td>&#x2F;WEB-INF&#x2F;classes&#x2F; å’Œ&#x2F;WEB-INF&#x2F;lib&#x2F; ç›®å½•ä¸­ class æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ˜¯å¦è‡ªåŠ¨é‡æ–°åŠ è½½</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>swallowOutput</td>
<td>true æƒ…å†µä¸‹, System.out å’Œ System.err è¾“å‡ºå°†è¢«å®šå‘åˆ° web åº”ç”¨æ—¥å¿—ä¸­</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
</tbody></table>
<h4 id="2-2-6-Engine"><a href="#2-2-6-Engine" class="headerlink" title="2.2.6. Engine"></a>2.2.6. Engine</h4><blockquote>
<p>Engine å…ƒç´ è¡¨ç¤ºä¸ç‰¹å®šçš„ Catalina æœåŠ¡ç›¸å…³è”çš„æ•´ä¸ªè¯·æ±‚å¤„ç†æœºå™¨ã€‚å®ƒæ¥æ”¶å¹¶å¤„ç†æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å°†å®Œæˆçš„å“åº”è¿”å›ç»™è¿æ¥å™¨ï¼Œä»¥ä¾¿æœ€ç»ˆä¼ è¾“å›å®¢æˆ·ç«¯ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>defaultHost</td>
<td>é»˜è®¤ä¸»æœºåï¼Œç”¨äºæ ‡è¯†å°†å¤„ç†æŒ‡å‘æ­¤æœåŠ¡å™¨ä¸Šä¸»æœºåç§°ä½†æœªåœ¨æ­¤é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„è¯·æ±‚çš„ä¸»æœºã€‚</td>
<td>è¿™ä¸ªåå­—å¿…é¡»åŒ¹é…å…¶ä¸­ä¸€ä¸ªåµŒå¥—çš„ä¸»æœºå…ƒç´ çš„åå­—å±æ€§ã€‚</td>
</tr>
<tr>
<td>name</td>
<td>æ­¤å¼•æ“çš„é€»è¾‘åç§°ï¼Œç”¨äºæ—¥å¿—å’Œé”™è¯¯æ¶ˆæ¯ã€‚</td>
<td>åœ¨åŒä¸€æœåŠ¡å™¨ä¸­ä½¿ç”¨å¤šä¸ªæœåŠ¡å…ƒç´ æ—¶ï¼Œæ¯ä¸ªå¼•æ“å¿…é¡»åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åç§°ã€‚</td>
</tr>
</tbody></table>
<h4 id="2-2-7-Host"><a href="#2-2-7-Host" class="headerlink" title="2.2.7. Host"></a>2.2.7. Host</h4><blockquote>
<p>Host å…ƒç´ è¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå®ƒæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„ç½‘ç»œåç§°ï¼ˆå¦‚â€œ<a target="_blank" rel="noopener" href="http://www.mycompany.comâ€)ä¸è¿è¡Œ/">www.mycompany.comâ€ï¼‰ä¸è¿è¡Œ</a> Tomcat çš„ç‰¹å®šæœåŠ¡å™¨çš„å…³è”ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>åç§°</td>
<td>ç”¨äºæ—¥å¿—è¾“å‡º</td>
</tr>
<tr>
<td>appBase</td>
<td>è™šæ‹Ÿä¸»æœºå¯¹åº”çš„åº”ç”¨åŸºç¡€è·¯å¾„</td>
<td>å¯ä»¥æ˜¯ä¸ªç»å¯¹è·¯å¾„, æˆ–${CATALINA_BASE}ç›¸å¯¹è·¯å¾„</td>
</tr>
<tr>
<td>xmlBase</td>
<td>è™šæ‹Ÿä¸»æœº XML åŸºç¡€è·¯å¾„,é‡Œé¢åº”è¯¥æœ‰ Context xml é…ç½®æ–‡ä»¶</td>
<td>å¯ä»¥æ˜¯ä¸ªç»å¯¹è·¯å¾„, æˆ–${CATALINA_BASE}ç›¸å¯¹è·¯å¾„</td>
</tr>
<tr>
<td>createDirs</td>
<td>å½“ appBase å’Œ xmlBase ä¸å­˜åœ¨æ—¶,æ˜¯å¦åˆ›å»ºç›®å½•</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>autoDeploy</td>
<td>æ˜¯å¦å‘¨æœŸæ€§çš„æ£€æŸ¥ appBase å’Œ xmlBase å¹¶ deploy web åº”ç”¨å’Œ context æè¿°ç¬¦</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>deployIgnore</td>
<td>å¿½ç•¥ deploy çš„æ­£åˆ™</td>
<td></td>
</tr>
<tr>
<td>deployOnStartup</td>
<td>Tomcat å¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨ deploy</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>failCtxIfServletStartFails</td>
<td>é…ç½®ä¸º true æƒ…å†µä¸‹,ä»»ä½• load-on-startup &gt;&#x3D;0 çš„ servlet å¯åŠ¨å¤±è´¥,åˆ™å…¶å¯¹åº”çš„ Contxt ä¹Ÿå¯åŠ¨å¤±è´¥</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
</tbody></table>
<h4 id="2-2-8-Cluster"><a href="#2-2-8-Cluster" class="headerlink" title="2.2.8. Cluster"></a>2.2.8. Cluster</h4><p>ç”±äºåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»æœªç”¨è¿‡ Tomcat é›†ç¾¤é…ç½®ï¼Œæ‰€ä»¥æ²¡ç ”ç©¶ã€‚</p>
<h3 id="2-3-å¯åŠ¨"><a href="#2-3-å¯åŠ¨" class="headerlink" title="2.3. å¯åŠ¨"></a>2.3. å¯åŠ¨</h3><h4 id="2-3-1-éƒ¨ç½²æ–¹å¼"><a href="#2-3-1-éƒ¨ç½²æ–¹å¼" class="headerlink" title="2.3.1. éƒ¨ç½²æ–¹å¼"></a>2.3.1. éƒ¨ç½²æ–¹å¼</h4><p>è¿™ç§æ–¹å¼è¦æ±‚æœ¬åœ°å¿…é¡»å®‰è£… Tomcat ã€‚</p>
<p>å°†æ‰“åŒ…å¥½çš„ war åŒ…æ”¾åœ¨ Tomcat å®‰è£…ç›®å½•ä¸‹çš„ <code>webapps</code> ç›®å½•ä¸‹ï¼Œç„¶ååœ¨ bin ç›®å½•ä¸‹æ‰§è¡Œ <code>startup.bat</code> æˆ– <code>startup.sh</code> ï¼ŒTomcat ä¼šè‡ªåŠ¨è§£å‹ <code>webapps</code> ç›®å½•ä¸‹çš„ war åŒ…ã€‚</p>
<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/xxx</code> ï¼ˆxxx æ˜¯ war åŒ…æ–‡ä»¶åï¼‰ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>ä»¥ä¸Šæ­¥éª¤æ˜¯æœ€ç®€å•çš„ç¤ºä¾‹ã€‚æ­¥éª¤ä¸­çš„ war åŒ…è§£å‹è·¯å¾„ã€å¯åŠ¨ç«¯å£ä»¥åŠä¸€äº›æ›´å¤šçš„åŠŸèƒ½éƒ½å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥å®šåˆ¶ ï¼ˆä¸»è¦æ˜¯ <code>server.xml</code> æˆ– <code>context.xml</code> æ–‡ä»¶ï¼‰ã€‚</p>
</blockquote>
<h4 id="2-3-2-åµŒå…¥å¼"><a href="#2-3-2-åµŒå…¥å¼" class="headerlink" title="2.3.2. åµŒå…¥å¼"></a>2.3.2. åµŒå…¥å¼</h4><h5 id="2-3-2-1-API-æ–¹å¼"><a href="#2-3-2-1-API-æ–¹å¼" class="headerlink" title="2.3.2.1. API æ–¹å¼"></a>2.3.2.1. API æ–¹å¼</h5><p>åœ¨ pom.xml ä¸­æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ  SimpleEmbedTomcatServer.java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleTomcatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONTEXT_PATH</span> <span class="operator">=</span> <span class="string">&quot;/javatool-server&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è®¾å®š profile</span></span><br><span class="line">        Optional&lt;String&gt; profile = Optional.ofNullable(System.getProperty(<span class="string">&quot;spring.profiles.active&quot;</span>));</span><br><span class="line">        System.setProperty(<span class="string">&quot;spring.profiles.active&quot;</span>, profile.orElse(<span class="string">&quot;develop&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">        tomcat.setPort(PORT);</span><br><span class="line">        tomcat.getHost().setAppBase(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        tomcat.addWebapp(CONTEXT_PATH, getAbsolutePath() + <span class="string">&quot;src/main/webapp&quot;</span>);</span><br><span class="line">        tomcat.start();</span><br><span class="line">        tomcat.getServer().await();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getAbsolutePath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">folderPath</span> <span class="operator">=</span> SimpleEmbedTomcatServer.class.getProtectionDomain().getCodeSource().getLocation().getPath()</span><br><span class="line">                .substring(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (folderPath.indexOf(<span class="string">&quot;target&quot;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            path = folderPath.substring(<span class="number">0</span>, folderPath.indexOf(<span class="string">&quot;target&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/javatool-server</code> ã€‚</p>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>æœ¬ç¤ºä¾‹æ˜¯ä½¿ç”¨ <code>org.apache.tomcat.embed</code> å¯åŠ¨åµŒå…¥å¼ Tomcat çš„æœ€ç®€ç¤ºä¾‹ã€‚</p>
<p>è¿™ä¸ªç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ˜¯ Tomcat é»˜è®¤çš„é…ç½®ï¼Œä½†é€šå¸¸ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Tomcat é…ç½®è¿›è¡Œä¸€äº›å®šåˆ¶å’Œè°ƒä¼˜ã€‚ä¸ºäº†åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ç±»å°±è¦ç¨å¾®å†å¤æ‚ä¸€äº›ã€‚è¿™é‡Œä¸æƒ³å†è´´ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaStack/tree/master/codes/javatool/server"><strong>ç¤ºä¾‹é¡¹ç›®</strong></a></p>
</blockquote>
<h5 id="2-3-2-2-ä½¿ç”¨-maven-æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰"><a href="#2-3-2-2-ä½¿ç”¨-maven-æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰" class="headerlink" title="2.3.2.2. ä½¿ç”¨ maven æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰"></a>2.3.2.2. ä½¿ç”¨ maven æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰</h5><p>ä¸æ¨èç†ç”±ï¼šè¿™ç§æ–¹å¼å¯åŠ¨ maven è™½ç„¶æœ€ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼ŒçœŸçš„å¾ˆä¹…å¾ˆä¹…æ²¡å‘å¸ƒæ–°ç‰ˆæœ¬äº†ï¼ˆæœ€æ–°ç‰ˆæœ¬å‘å¸ƒæ—¶é—´ï¼š2013-11-11ï¼‰ã€‚ä¸”è²Œä¼¼åªèƒ½æ‰¾åˆ° Tomcat6 ã€Tomcat7 æ’ä»¶ã€‚</p>
<p><strong>ä½¿ç”¨æ–¹æ³•</strong></p>
<p>åœ¨ pom.xml ä¸­å¼•å…¥æ’ä»¶</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ <code>mvn tomcat7:run</code> å‘½ä»¤ï¼Œå¯åŠ¨ Tomcatã€‚</p>
<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/xxx</code> ï¼ˆxxx æ˜¯ ${project.artifactId} æŒ‡å®šçš„é¡¹ç›®åï¼‰ã€‚</p>
<h4 id="2-3-3-IDE-æ’ä»¶"><a href="#2-3-3-IDE-æ’ä»¶" class="headerlink" title="2.3.3. IDE æ’ä»¶"></a>2.3.3. IDE æ’ä»¶</h4><p>å¸¸è§ Java IDE ä¸€èˆ¬éƒ½æœ‰å¯¹ Tomcat çš„æ”¯æŒã€‚</p>
<p>ä»¥ Intellij IDEA ä¸ºä¾‹ï¼Œæä¾›äº† <strong>Tomcat and TomEE Integration</strong> æ’ä»¶ï¼ˆä¸€èˆ¬é»˜è®¤ä¼šå®‰è£…ï¼‰ã€‚</p>
<p><strong>ä½¿ç”¨æ­¥éª¤</strong></p>
<ul>
<li>ç‚¹å‡» Run&#x2F;Debug Configurations &gt; New Tomcat Server &gt; local ï¼Œæ‰“å¼€ Tomcat é…ç½®é¡µé¢ã€‚</li>
<li>ç‚¹å‡» Confiureâ€¦ æŒ‰é’®ï¼Œè®¾ç½® Tomcat å®‰è£…è·¯å¾„ã€‚</li>
<li>ç‚¹å‡» Deployment æ ‡ç­¾é¡µï¼Œè®¾ç½®è¦å¯åŠ¨çš„åº”ç”¨ã€‚</li>
<li>è®¾ç½®å¯åŠ¨åº”ç”¨çš„ç«¯å£ã€JVM å‚æ•°ã€å¯åŠ¨æµè§ˆå™¨ç­‰ã€‚</li>
<li>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/</code>ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ url ä¸­è®¾ç½®ä¸Šä¸‹æ–‡åç§°ï¼‰ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/tomcat-intellij-run-config.png" alt="img"></p>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ’ä»¶ä¸å¦‚ Eclipse çš„ Tomcat æ’ä»¶å¥½ç”¨ï¼ŒEclipse çš„ Tomcat æ’ä»¶æ”¯æŒå¯¹ Tomcat xml é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚è€Œè¿™é‡Œï¼Œä½ åªèƒ½è‡ªå·±å» Tomcat å®‰è£…è·¯å¾„ä¸‹ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
</blockquote>
<p>æ–‡ä¸­çš„åµŒå…¥å¼å¯åŠ¨ç¤ºä¾‹å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaStack/tree/master/codes/javatool/server"><strong>æˆ‘çš„ç¤ºä¾‹é¡¹ç›®</strong></a></p>
<h2 id="3-Tomcat-æ¶æ„"><a href="#3-Tomcat-æ¶æ„" class="headerlink" title="3. Tomcat æ¶æ„"></a>3. Tomcat æ¶æ„</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113193431.png" alt="img"></p>
<p>Tomcat è¦å®ç° 2 ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>å¤„ç† Socket è¿æ¥</strong>ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚</li>
<li><strong>åŠ è½½å’Œç®¡ç† Servlet</strong>ï¼Œä»¥åŠ<strong>å¤„ç†å…·ä½“çš„ Request è¯·æ±‚</strong>ã€‚</li>
</ul>
<p>ä¸ºæ­¤ï¼ŒTomcat è®¾è®¡äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li><strong>è¿æ¥å™¨ï¼ˆConnectorï¼‰</strong>ï¼šè´Ÿè´£å’Œå¤–éƒ¨é€šä¿¡</li>
<li><strong>å®¹å™¨ï¼ˆContainerï¼‰</strong>ï¼šè´Ÿè´£å†…éƒ¨å¤„ç†</li>
</ul>
<h3 id="3-1-Service"><a href="#3-1-Service" class="headerlink" title="3.1. Service"></a>3.1. Service</h3><p>Tomcat æ”¯æŒçš„ I&#x2F;O æ¨¡å‹æœ‰ï¼š</p>
<ul>
<li>NIOï¼šéé˜»å¡ I&#x2F;Oï¼Œé‡‡ç”¨ Java NIO ç±»åº“å®ç°ã€‚</li>
<li>NIO2ï¼šå¼‚æ­¥ I&#x2F;Oï¼Œé‡‡ç”¨ JDK 7 æœ€æ–°çš„ NIO2 ç±»åº“å®ç°ã€‚</li>
<li>APRï¼šé‡‡ç”¨ Apache å¯ç§»æ¤è¿è¡Œåº“å®ç°ï¼Œæ˜¯ C&#x2F;C++ ç¼–å†™çš„æœ¬åœ°åº“ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒçš„åº”ç”¨å±‚åè®®æœ‰ï¼š</p>
<ul>
<li>HTTP&#x2F;1.1ï¼šè¿™æ˜¯å¤§éƒ¨åˆ† Web åº”ç”¨é‡‡ç”¨çš„è®¿é—®åè®®ã€‚</li>
<li>AJPï¼šç”¨äºå’Œ Web æœåŠ¡å™¨é›†æˆï¼ˆå¦‚ Apacheï¼‰ã€‚</li>
<li>HTTP&#x2F;2ï¼šHTTP 2.0 å¤§å¹…åº¦çš„æå‡äº† Web æ€§èƒ½ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒå¤šç§ I&#x2F;O æ¨¡å‹å’Œåº”ç”¨å±‚åè®®ã€‚ä¸ºäº†å®ç°è¿™ç‚¹ï¼Œä¸€ä¸ªå®¹å™¨å¯èƒ½å¯¹æ¥å¤šä¸ªè¿æ¥å™¨ã€‚ä½†æ˜¯ï¼Œå•ç‹¬çš„è¿æ¥å™¨æˆ–å®¹å™¨éƒ½ä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œéœ€è¦æŠŠå®ƒä»¬ç»„è£…èµ·æ¥æ‰èƒ½å·¥ä½œï¼Œç»„è£…åè¿™ä¸ªæ•´ä½“å«ä½œ Service ç»„ä»¶ã€‚Tomcat å†…å¯èƒ½æœ‰å¤šä¸ª Serviceï¼Œé€šè¿‡åœ¨ Tomcat ä¸­é…ç½®å¤šä¸ª Serviceï¼Œå¯ä»¥å®ç°é€šè¿‡ä¸åŒçš„ç«¯å£å·æ¥è®¿é—®åŒä¸€å°æœºå™¨ä¸Šéƒ¨ç½²çš„ä¸åŒåº”ç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201111093124.png" alt="img"></p>
<p><strong>ä¸€ä¸ª Tomcat å®ä¾‹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Serviceï¼›ä¸€ä¸ª Service æœ‰å¤šä¸ª Connector å’Œ Container</strong>ã€‚Connector å’Œ Container ä¹‹é—´é€šè¿‡æ ‡å‡†çš„ ServletRequest å’Œ ServletResponse é€šä¿¡ã€‚</p>
<h3 id="3-2-è¿æ¥å™¨"><a href="#3-2-è¿æ¥å™¨" class="headerlink" title="3.2. è¿æ¥å™¨"></a>3.2. è¿æ¥å™¨</h3><p>è¿æ¥å™¨å¯¹ Servlet å®¹å™¨å±è”½äº†åè®®åŠ I&#x2F;O æ¨¡å‹ç­‰çš„åŒºåˆ«ï¼Œæ— è®ºæ˜¯ HTTP è¿˜æ˜¯ AJPï¼Œåœ¨å®¹å™¨ä¸­è·å–åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ ServletRequest å¯¹è±¡ã€‚</p>
<p>è¿æ¥å™¨çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p>
<ul>
<li>ç½‘ç»œé€šä¿¡</li>
<li>åº”ç”¨å±‚åè®®è§£æ</li>
<li>Tomcat Request&#x2F;Response ä¸ ServletRequest&#x2F;ServletResponse çš„è½¬åŒ–</li>
</ul>
<p>Tomcat è®¾è®¡äº† 3 ä¸ªç»„ä»¶æ¥å®ç°è¿™ 3 ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ <strong><code>EndPoint</code><strong>ã€</strong><code>Processor</code></strong> å’Œ **<code>Adapter</code>**ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201111101440.png" alt="img"></p>
<p>ç»„ä»¶é—´é€šè¿‡æŠ½è±¡æ¥å£äº¤äº’ã€‚è¿™æ ·åšè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯<strong>å°è£…å˜åŒ–ã€‚</strong>è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„ç²¾é«“ï¼Œå°†ç³»ç»Ÿä¸­ç»å¸¸å˜åŒ–çš„éƒ¨åˆ†å’Œç¨³å®šçš„éƒ¨åˆ†éš”ç¦»ï¼Œæœ‰åŠ©äºå¢åŠ å¤ç”¨æ€§ï¼Œå¹¶é™ä½ç³»ç»Ÿè€¦åˆåº¦ã€‚ç½‘ç»œé€šä¿¡çš„ I&#x2F;O æ¨¡å‹æ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯éé˜»å¡ I&#x2F;Oã€å¼‚æ­¥ I&#x2F;O æˆ–è€… APRã€‚åº”ç”¨å±‚åè®®ä¹Ÿæ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯ HTTPã€HTTPSã€AJPã€‚æµè§ˆå™¨ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿæ˜¯å˜åŒ–çš„ã€‚ä½†æ˜¯æ•´ä½“çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ï¼ŒEndPoint è´Ÿè´£æä¾›å­—èŠ‚æµç»™ Processorï¼ŒProcessor è´Ÿè´£æä¾› Tomcat Request å¯¹è±¡ç»™ Adapterï¼ŒAdapter è´Ÿè´£æä¾› ServletRequest å¯¹è±¡ç»™å®¹å™¨ã€‚</p>
<p>å¦‚æœè¦æ”¯æŒæ–°çš„ I&#x2F;O æ–¹æ¡ˆã€æ–°çš„åº”ç”¨å±‚åè®®ï¼Œåªéœ€è¦å®ç°ç›¸å…³çš„å…·ä½“å­ç±»ï¼Œä¸Šå±‚é€šç”¨çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ã€‚ç”±äº I&#x2F;O æ¨¡å‹å’Œåº”ç”¨å±‚åè®®å¯ä»¥è‡ªç”±ç»„åˆï¼Œæ¯”å¦‚ NIO + HTTP æˆ–è€… NIO2 + AJPã€‚Tomcat çš„è®¾è®¡è€…å°†ç½‘ç»œé€šä¿¡å’Œåº”ç”¨å±‚åè®®è§£ææ”¾åœ¨ä¸€èµ·è€ƒè™‘ï¼Œè®¾è®¡äº†ä¸€ä¸ªå« ProtocolHandler çš„æ¥å£æ¥å°è£…è¿™ä¸¤ç§å˜åŒ–ç‚¹ã€‚å„ç§åè®®å’Œé€šä¿¡æ¨¡å‹çš„ç»„åˆæœ‰ç›¸åº”çš„å…·ä½“å®ç°ç±»ã€‚æ¯”å¦‚ï¼šHttp11NioProtocol å’Œ AjpNioProtocolã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201027091819.png" alt="img"></p>
<h4 id="3-2-1-ProtocolHandler-ç»„ä»¶"><a href="#3-2-1-ProtocolHandler-ç»„ä»¶" class="headerlink" title="3.2.1. ProtocolHandler ç»„ä»¶"></a>3.2.1. ProtocolHandler ç»„ä»¶</h4><p><strong>è¿æ¥å™¨ç”¨ ProtocolHandler æ¥å£æ¥å°è£…é€šä¿¡åè®®å’Œ I&#x2F;O æ¨¡å‹çš„å·®å¼‚</strong>ã€‚ProtocolHandler å†…éƒ¨åˆåˆ†ä¸º EndPoint å’Œ Processor æ¨¡å—ï¼ŒEndPoint è´Ÿè´£åº•å±‚ Socket é€šä¿¡ï¼ŒProccesor è´Ÿè´£åº”ç”¨å±‚åè®®è§£æã€‚</p>
<h5 id="3-2-1-1-EndPoint"><a href="#3-2-1-1-EndPoint" class="headerlink" title="3.2.1.1. EndPoint"></a>3.2.1.1. EndPoint</h5><p>EndPoint æ˜¯é€šä¿¡ç«¯ç‚¹ï¼Œå³é€šä¿¡ç›‘å¬çš„æ¥å£ï¼Œæ˜¯å…·ä½“çš„ Socket æ¥æ”¶å’Œå‘é€å¤„ç†å™¨ï¼Œæ˜¯å¯¹ä¼ è¾“å±‚çš„æŠ½è±¡ï¼Œå› æ­¤ EndPoint æ˜¯ç”¨æ¥å®ç° TCP&#x2F;IP åè®®çš„ã€‚</p>
<p>EndPoint æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯¹åº”çš„æŠ½è±¡å®ç°ç±»æ˜¯ AbstractEndpointï¼Œè€Œ AbstractEndpoint çš„å…·ä½“å­ç±»ï¼Œæ¯”å¦‚åœ¨ NioEndpoint å’Œ Nio2Endpoint ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„å­ç»„ä»¶ï¼šAcceptor å’Œ SocketProcessorã€‚</p>
<p>å…¶ä¸­ Acceptor ç”¨äºç›‘å¬ Socket è¿æ¥è¯·æ±‚ã€‚SocketProcessor ç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„ Socket è¯·æ±‚ï¼Œå®ƒå®ç° Runnable æ¥å£ï¼Œåœ¨ Run æ–¹æ³•é‡Œè°ƒç”¨åè®®å¤„ç†ç»„ä»¶ Processor è¿›è¡Œå¤„ç†ã€‚ä¸ºäº†æé«˜å¤„ç†èƒ½åŠ›ï¼ŒSocketProcessor è¢«æäº¤åˆ°çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚è€Œè¿™ä¸ªçº¿ç¨‹æ± å«ä½œæ‰§è¡Œå™¨ï¼ˆExecutor)ã€‚</p>
<h5 id="3-2-1-2-Processor"><a href="#3-2-1-2-Processor" class="headerlink" title="3.2.1.2. Processor"></a>3.2.1.2. Processor</h5><p>å¦‚æœè¯´ EndPoint æ˜¯ç”¨æ¥å®ç° TCP&#x2F;IP åè®®çš„ï¼Œé‚£ä¹ˆ Processor ç”¨æ¥å®ç° HTTP åè®®ï¼ŒProcessor æ¥æ”¶æ¥è‡ª EndPoint çš„ Socketï¼Œè¯»å–å­—èŠ‚æµè§£ææˆ Tomcat Request å’Œ Response å¯¹è±¡ï¼Œå¹¶é€šè¿‡ Adapter å°†å…¶æäº¤åˆ°å®¹å™¨å¤„ç†ï¼ŒProcessor æ˜¯å¯¹åº”ç”¨å±‚åè®®çš„æŠ½è±¡ã€‚</p>
<p>Processor æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†è¯·æ±‚çš„å¤„ç†ç­‰æ–¹æ³•ã€‚å®ƒçš„æŠ½è±¡å®ç°ç±» AbstractProcessor å¯¹ä¸€äº›åè®®å…±æœ‰çš„å±æ€§è¿›è¡Œå°è£…ï¼Œæ²¡æœ‰å¯¹æ–¹æ³•è¿›è¡Œå®ç°ã€‚å…·ä½“çš„å®ç°æœ‰ AJPProcessorã€HTTP11Processor ç­‰ï¼Œè¿™äº›å…·ä½“å®ç°ç±»å®ç°äº†ç‰¹å®šåè®®çš„è§£ææ–¹æ³•å’Œè¯·æ±‚å¤„ç†æ–¹å¼ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113185929.png" alt="img"></p>
<p>ä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼ŒEndPoint æ¥æ”¶åˆ° Socket è¿æ¥åï¼Œç”Ÿæˆä¸€ä¸ª SocketProcessor ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± å»å¤„ç†ï¼ŒSocketProcessor çš„ Run æ–¹æ³•ä¼šè°ƒç”¨ Processor ç»„ä»¶å»è§£æåº”ç”¨å±‚åè®®ï¼ŒProcessor é€šè¿‡è§£æç”Ÿæˆ Request å¯¹è±¡åï¼Œä¼šè°ƒç”¨ Adapter çš„ Service æ–¹æ³•ã€‚</p>
<h4 id="3-2-2-Adapter"><a href="#3-2-2-Adapter" class="headerlink" title="3.2.2. Adapter"></a>3.2.2. Adapter</h4><p><strong>è¿æ¥å™¨é€šè¿‡é€‚é…å™¨ Adapter è°ƒç”¨å®¹å™¨</strong>ã€‚</p>
<p>ç”±äºåè®®ä¸åŒï¼Œå®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿä¸å°½ç›¸åŒï¼ŒTomcat å®šä¹‰äº†è‡ªå·±çš„ Request ç±»æ¥é€‚é…è¿™äº›è¯·æ±‚ä¿¡æ¯ã€‚</p>
<p>ProtocolHandler æ¥å£è´Ÿè´£è§£æè¯·æ±‚å¹¶ç”Ÿæˆ Tomcat Request ç±»ã€‚ä½†æ˜¯è¿™ä¸ª Request å¯¹è±¡ä¸æ˜¯æ ‡å‡†çš„ ServletRequestï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œä¸èƒ½ç”¨ Tomcat Request ä½œä¸ºå‚æ•°æ¥è°ƒç”¨å®¹å™¨ã€‚Tomcat çš„è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥ CoyoteAdapterï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„ç»å…¸è¿ç”¨ï¼Œè¿æ¥å™¨è°ƒç”¨ CoyoteAdapter çš„ Sevice æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ Tomcat Request å¯¹è±¡ï¼ŒCoyoteAdapter è´Ÿè´£å°† Tomcat Request è½¬æˆ ServletRequestï¼Œå†è°ƒç”¨å®¹å™¨çš„ Service æ–¹æ³•ã€‚</p>
<h3 id="3-3-å®¹å™¨"><a href="#3-3-å®¹å™¨" class="headerlink" title="3.3. å®¹å™¨"></a>3.3. å®¹å™¨</h3><p>Tomcat è®¾è®¡äº† 4 ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯ Engineã€Hostã€Context å’Œ Wrapperã€‚</p>
<ul>
<li><strong>Engine</strong> - Servlet çš„é¡¶å±‚å®¹å™¨ï¼ŒåŒ…å«ä¸€ ä¸ªæˆ–å¤šä¸ª Host å­å®¹å™¨ï¼›</li>
<li><strong>Host</strong> - è™šæ‹Ÿä¸»æœºï¼Œè´Ÿè´£ web åº”ç”¨çš„éƒ¨ç½²å’Œ Context çš„åˆ›å»ºï¼›</li>
<li><strong>Context</strong> - Web åº”ç”¨ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«å¤šä¸ª Wrapperï¼Œè´Ÿè´£ web é…ç½®çš„è§£æã€ç®¡ç†æ‰€æœ‰çš„ Web èµ„æºï¼›</li>
<li><strong>Wrapper</strong> - æœ€åº•å±‚çš„å®¹å™¨ï¼Œæ˜¯å¯¹ Servlet çš„å°è£…ï¼Œè´Ÿè´£ Servlet å®ä¾‹çš„åˆ› å»ºã€æ‰§è¡Œå’Œé”€æ¯ã€‚</li>
</ul>
<h4 id="3-3-1-è¯·æ±‚åˆ†å‘-Servlet-è¿‡ç¨‹"><a href="#3-3-1-è¯·æ±‚åˆ†å‘-Servlet-è¿‡ç¨‹" class="headerlink" title="3.3.1. è¯·æ±‚åˆ†å‘ Servlet è¿‡ç¨‹"></a>3.3.1. è¯·æ±‚åˆ†å‘ Servlet è¿‡ç¨‹</h4><p>Tomcat æ˜¯æ€ä¹ˆç¡®å®šè¯·æ±‚æ˜¯ç”±å“ªä¸ª Wrapper å®¹å™¨é‡Œçš„ Servlet æ¥å¤„ç†çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼ŒTomcat æ˜¯ç”¨ Mapper ç»„ä»¶æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªç½‘è´­ç³»ç»Ÿï¼Œæœ‰é¢å‘ç½‘ç«™ç®¡ç†äººå‘˜çš„åå°ç®¡ç†ç³»ç»Ÿï¼Œè¿˜æœ‰é¢å‘ç»ˆç«¯å®¢æˆ·çš„åœ¨çº¿è´­ç‰©ç³»ç»Ÿã€‚è¿™ä¸¤ä¸ªç³»ç»Ÿè·‘åœ¨åŒä¸€ä¸ª Tomcat ä¸Šï¼Œä¸ºäº†éš”ç¦»å®ƒä»¬çš„è®¿é—®åŸŸåï¼Œé…ç½®äº†ä¸¤ä¸ªè™šæ‹ŸåŸŸåï¼š<code>manage.shopping.com</code>å’Œ<code>user.shopping.com</code>ï¼Œç½‘ç«™ç®¡ç†äººå‘˜é€šè¿‡<code>manage.shopping.com</code>åŸŸåè®¿é—® Tomcat å»ç®¡ç†ç”¨æˆ·å’Œå•†å“ï¼Œè€Œç”¨æˆ·ç®¡ç†å’Œå•†å“ç®¡ç†æ˜¯ä¸¤ä¸ªå•ç‹¬çš„ Web åº”ç”¨ã€‚ç»ˆç«¯å®¢æˆ·é€šè¿‡<code>user.shopping.com</code>åŸŸåå»æœç´¢å•†å“å’Œä¸‹è®¢å•ï¼Œæœç´¢åŠŸèƒ½å’Œè®¢å•ç®¡ç†ä¹Ÿæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Web åº”ç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¼”ç¤ºäº† url åº”å£° Servlet çš„å¤„ç†æµç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113192022.jpg" alt="img"></p>
<p>å‡å¦‚æœ‰ç”¨æˆ·è®¿é—®ä¸€ä¸ª URLï¼Œæ¯”å¦‚å›¾ä¸­çš„<code>http://user.shopping.com:8080/order/buy</code>ï¼ŒTomcat å¦‚ä½•å°†è¿™ä¸ª URL å®šä½åˆ°ä¸€ä¸ª Servlet å‘¢ï¼Ÿ</p>
<ol>
<li><strong>é¦–å…ˆï¼Œæ ¹æ®åè®®å’Œç«¯å£å·é€‰å®š Service å’Œ Engineã€‚</strong></li>
<li><strong>ç„¶åï¼Œæ ¹æ®åŸŸåé€‰å®š Hostã€‚</strong></li>
<li><strong>ä¹‹åï¼Œæ ¹æ® URL è·¯å¾„æ‰¾åˆ° Context ç»„ä»¶ã€‚</strong></li>
<li><strong>æœ€åï¼Œæ ¹æ® URL è·¯å¾„æ‰¾åˆ° Wrapperï¼ˆServletï¼‰ã€‚</strong></li>
</ol>
<p>è¿™ä¸ªè·¯ç”±åˆ†å‘è¿‡ç¨‹å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨ Pipeline-Valve ç®¡é“ã€‚</p>
<h4 id="3-3-2-Pipeline-Value"><a href="#3-3-2-Pipeline-Value" class="headerlink" title="3.3.2. Pipeline-Value"></a>3.3.2. Pipeline-Value</h4><p>Pipeline å¯ä»¥ç†è§£ä¸ºç°å®ä¸­çš„ç®¡é“ï¼ŒValve ä¸ºç®¡é“ä¸­çš„é˜€é—¨ï¼ŒRequest å’Œ Response å¯¹è±¡åœ¨ç®¡é“ä¸­ç»è¿‡å„ä¸ªé˜€é—¨çš„å¤„ç†å’Œæ§åˆ¶ã€‚</p>
<p>Pipeline-Valve æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œè´£ä»»é“¾æ¨¡å¼æ˜¯æŒ‡åœ¨ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šå¤„ç†è€…ä¾æ¬¡å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªå¤„ç†è€…è´Ÿè´£åšè‡ªå·±ç›¸åº”çš„å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åå°†å†è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†è€…ç»§ç»­å¤„ç†ã€‚Valve è¡¨ç¤ºä¸€ä¸ªå¤„ç†ç‚¹ï¼Œæ¯”å¦‚æƒé™è®¤è¯å’Œè®°å½•æ—¥å¿—ã€‚</p>
<p>å…ˆæ¥äº†è§£ä¸€ä¸‹ Valve å’Œ Pipeline æ¥å£çš„è®¾è®¡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/Pipeline%E4%B8%8EValve.png" alt="img"></p>
<ul>
<li>æ¯ä¸€ä¸ªå®¹å™¨éƒ½æœ‰ä¸€ä¸ª Pipeline å¯¹è±¡ï¼Œåªè¦è§¦å‘è¿™ä¸ª Pipeline çš„ç¬¬ä¸€ä¸ª Valveï¼Œè¿™ä¸ªå®¹å™¨é‡Œ Pipeline ä¸­çš„ Valve å°±éƒ½ä¼šè¢«è°ƒç”¨åˆ°ã€‚ä½†æ˜¯ï¼Œä¸åŒå®¹å™¨çš„ Pipeline æ˜¯æ€ä¹ˆé“¾å¼è§¦å‘çš„å‘¢ï¼Œæ¯”å¦‚ Engine ä¸­ Pipeline éœ€è¦è°ƒç”¨ä¸‹å±‚å®¹å™¨ Host ä¸­çš„ Pipelineã€‚</li>
<li>è¿™æ˜¯å› ä¸º Pipeline ä¸­è¿˜æœ‰ä¸ª getBasic æ–¹æ³•ã€‚è¿™ä¸ª BasicValve å¤„äº Valve é“¾è¡¨çš„æœ«ç«¯ï¼Œå®ƒæ˜¯ Pipeline ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ª Valveï¼Œè´Ÿè´£è°ƒç”¨ä¸‹å±‚å®¹å™¨çš„ Pipeline é‡Œçš„ç¬¬ä¸€ä¸ª Valveã€‚</li>
<li>Pipeline ä¸­æœ‰ addValve æ–¹æ³•ã€‚Pipeline ä¸­ç»´æŠ¤äº† Valve é“¾è¡¨ï¼ŒValve å¯ä»¥æ’å…¥åˆ° Pipeline ä¸­ï¼Œå¯¹è¯·æ±‚åšæŸäº›å¤„ç†ã€‚æˆ‘ä»¬è¿˜å‘ç° Pipeline ä¸­æ²¡æœ‰ invoke æ–¹æ³•ï¼Œå› ä¸ºæ•´ä¸ªè°ƒç”¨é“¾çš„è§¦å‘æ˜¯ Valve æ¥å®Œæˆçš„ï¼ŒValve å®Œæˆè‡ªå·±çš„å¤„ç†åï¼Œè°ƒç”¨ <code>getNext.invoke()</code> æ¥è§¦å‘ä¸‹ä¸€ä¸ª Valve è°ƒç”¨ã€‚</li>
<li>Valve ä¸­ä¸»è¦çš„ä¸‰ä¸ªæ–¹æ³•ï¼š<code>setNext</code>ã€<code>getNext</code>ã€<code>invoke</code>ã€‚Valve ä¹‹é—´çš„å…³ç³»æ˜¯å•å‘é“¾å¼ç»“æ„ï¼Œæœ¬èº« <code>invoke</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨ä¸‹ä¸€ä¸ª Valve çš„ <code>invoke</code> æ–¹æ³•ã€‚</li>
<li>å„å±‚å®¹å™¨å¯¹åº”çš„ basic valve åˆ†åˆ«æ˜¯ <code>StandardEngineValve</code>ã€<code>StandardHostValve</code>ã€ <code>StandardContextValve</code>ã€<code>StandardWrapperValve</code>ã€‚</li>
<li>ç”±äº Valve æ˜¯ä¸€ä¸ªå¤„ç†ç‚¹ï¼Œå› æ­¤ invoke æ–¹æ³•å°±æ˜¯æ¥å¤„ç†è¯·æ±‚çš„ã€‚æ³¨æ„åˆ° Valve ä¸­æœ‰ getNext å’Œ setNext æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœåˆ°æœ‰ä¸€ä¸ªé“¾è¡¨å°† Valve é“¾èµ·æ¥äº†ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B.png" alt="img"></p>
<p>æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ç”±è¿æ¥å™¨ä¸­çš„ Adapter è§¦å‘çš„ï¼Œå®ƒä¼šè°ƒç”¨ Engine çš„ç¬¬ä¸€ä¸ª Valveï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>

<h2 id="4-Tomcat-ç”Ÿå‘½å‘¨æœŸ"><a href="#4-Tomcat-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="4. Tomcat ç”Ÿå‘½å‘¨æœŸ"></a>4. Tomcat ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="4-1-Tomcat-çš„å¯åŠ¨è¿‡ç¨‹"><a href="#4-1-Tomcat-çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="4.1. Tomcat çš„å¯åŠ¨è¿‡ç¨‹"></a>4.1. Tomcat çš„å¯åŠ¨è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201118145455.png" alt="img"></p>
<ol>
<li>Tomcat æ˜¯ä¸€ä¸ª Java ç¨‹åºï¼Œå®ƒçš„è¿è¡Œä»æ‰§è¡Œ <code>startup.sh</code> è„šæœ¬å¼€å§‹ã€‚<code>startup.sh</code> ä¼šå¯åŠ¨ä¸€ä¸ª JVM æ¥è¿è¡Œ Tomcat çš„å¯åŠ¨ç±» <code>Bootstrap</code>ã€‚</li>
<li><code>Bootstrap</code> ä¼šåˆå§‹åŒ– Tomcat çš„ç±»åŠ è½½å™¨å¹¶å®ä¾‹åŒ– <code>Catalina</code>ã€‚</li>
<li><code>Catalina</code> ä¼šé€šè¿‡ Digester è§£æ <code>server.xml</code>ï¼Œæ ¹æ®å…¶ä¸­çš„é…ç½®ä¿¡æ¯æ¥åˆ›å»ºç›¸åº”ç»„ä»¶ï¼Œå¹¶è°ƒç”¨ <code>Server</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
<li><code>Server</code> è´Ÿè´£ç®¡ç† <code>Service</code> ç»„ä»¶ï¼Œå®ƒä¼šè°ƒç”¨ <code>Service</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
<li><code>Service</code> è´Ÿè´£ç®¡ç† <code>Connector</code> å’Œé¡¶å±‚å®¹å™¨ <code>Engine</code>ï¼Œå®ƒä¼šè°ƒç”¨ <code>Connector</code> å’Œ <code>Engine</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
</ol>
<h4 id="4-1-1-Catalina-ç»„ä»¶"><a href="#4-1-1-Catalina-ç»„ä»¶" class="headerlink" title="4.1.1. Catalina ç»„ä»¶"></a>4.1.1. Catalina ç»„ä»¶</h4><p>Catalina çš„èŒè´£å°±æ˜¯è§£æ server.xml é…ç½®ï¼Œå¹¶æ®æ­¤å®ä¾‹åŒ– Serverã€‚æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ Server ç»„ä»¶çš„ init æ–¹æ³•å’Œ start æ–¹æ³•ï¼Œå°† Tomcat å¯åŠ¨èµ·æ¥ã€‚</p>
<p>Catalina è¿˜éœ€è¦å¤„ç†å„ç§â€œå¼‚å¸¸â€æƒ…å†µï¼Œæ¯”å¦‚å½“æˆ‘ä»¬é€šè¿‡â€œCtrl + Câ€å…³é—­ Tomcat æ—¶ï¼ŒTomcat å°†å¦‚ä½•ä¼˜é›…çš„åœæ­¢å¹¶ä¸”æ¸…ç†èµ„æºå‘¢ï¼Ÿå› æ­¤ Catalina åœ¨ JVM ä¸­æ³¨å†Œä¸€ä¸ªâ€œå…³é—­é’©å­â€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. å¦‚æœæŒæœ‰çš„ Server å®ä¾‹ä¸ºç©ºï¼Œå°±è§£æ server.xml åˆ›å»ºå‡ºæ¥</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. å¦‚æœåˆ›å»ºå¤±è´¥ï¼ŒæŠ¥é”™é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.noServer&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å¯åŠ¨ Server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹¶æ³¨å†Œå…³é—­é’©å­</span></span><br><span class="line">    <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">            shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨ await æ–¹æ³•ç›‘å¬åœæ­¢è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (await) &#123;</span><br><span class="line">        await();</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆéœ€è¦å…³é—­é’©å­ï¼Ÿ</p>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ JVM å…³é—­æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚å°†ç¼“å­˜æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šï¼Œæˆ–è€…æ¸…ç†ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œå¯ä»¥å‘ JVM æ³¨å†Œä¸€ä¸ªâ€œå…³é—­é’©å­â€ã€‚â€œå…³é—­é’©å­â€å…¶å®å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒJVM åœ¨åœæ­¢ä¹‹å‰ä¼šå°è¯•æ‰§è¡Œè¿™ä¸ªçº¿ç¨‹çš„ <code>run</code> æ–¹æ³•ã€‚</p>
<p>Tomcat çš„â€œå…³é—­é’©å­â€â€”â€” <code>CatalinaShutdownHook</code> åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">CatalinaShutdownHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getServer() != <span class="literal">null</span>) &#123;</span><br><span class="line">                Catalina.<span class="built_in">this</span>.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat çš„â€œå…³é—­é’©å­â€å®é™…ä¸Šå°±æ‰§è¡Œäº† <code>Server</code> çš„ <code>stop</code> æ–¹æ³•ï¼Œ<code>Server</code> çš„ <code>stop</code> æ–¹æ³•ä¼šé‡Šæ”¾å’Œæ¸…ç†æ‰€æœ‰çš„èµ„æºã€‚</p>
<h4 id="4-1-2-Server-ç»„ä»¶"><a href="#4-1-2-Server-ç»„ä»¶" class="headerlink" title="4.1.2. Server ç»„ä»¶"></a>4.1.2. Server ç»„ä»¶</h4><p>Server ç»„ä»¶çš„å…·ä½“å®ç°ç±»æ˜¯ StandardServerï¼ŒServer ç»§æ‰¿äº† LifeCycleBaseï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè¢«ç»Ÿä¸€ç®¡ç†ï¼Œå¹¶ä¸”å®ƒçš„å­ç»„ä»¶æ˜¯ Serviceï¼Œå› æ­¤å®ƒè¿˜éœ€è¦ç®¡ç† Service çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¯åŠ¨æ—¶è°ƒç”¨ Service ç»„ä»¶çš„å¯åŠ¨æ–¹æ³•ï¼Œåœ¨åœæ­¢æ—¶è°ƒç”¨å®ƒä»¬çš„åœæ­¢æ–¹æ³•ã€‚Server åœ¨å†…éƒ¨ç»´æŠ¤äº†è‹¥å¹² Service ç»„ä»¶ï¼Œå®ƒæ˜¯ä»¥æ•°ç»„æ¥ä¿å­˜çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(Service service)</span> &#123;</span><br><span class="line"></span><br><span class="line">    service.setServer(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªé•¿åº¦ +1 çš„æ–°æ•°ç»„</span></span><br><span class="line">        Service results[] = <span class="keyword">new</span> <span class="title class_">Service</span>[services.length + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†è€çš„æ•°æ®å¤åˆ¶è¿‡å»</span></span><br><span class="line">        System.arraycopy(services, <span class="number">0</span>, results, <span class="number">0</span>, services.length);</span><br><span class="line">        results[services.length] = service;</span><br><span class="line">        services = results;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨ Service ç»„ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘ç›‘å¬äº‹ä»¶</span></span><br><span class="line">        support.firePropertyChange(<span class="string">&quot;service&quot;</span>, <span class="literal">null</span>, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server å¹¶æ²¡æœ‰ä¸€å¼€å§‹å°±åˆ†é…ä¸€ä¸ªå¾ˆé•¿çš„æ•°ç»„ï¼Œè€Œæ˜¯åœ¨æ·»åŠ çš„è¿‡ç¨‹ä¸­åŠ¨æ€åœ°æ‰©å±•æ•°ç»„é•¿åº¦ï¼Œå½“æ·»åŠ ä¸€ä¸ªæ–°çš„ Service å®ä¾‹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„å¹¶æŠŠåŸæ¥æ•°ç»„å†…å®¹å¤åˆ¶åˆ°æ–°æ•°ç»„ï¼Œè¿™æ ·åšçš„ç›®çš„å…¶å®æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒServer ç»„ä»¶è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡æ˜¯å¯åŠ¨ä¸€ä¸ª Socket æ¥ç›‘å¬åœæ­¢ç«¯å£ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ èƒ½é€šè¿‡ shutdown å‘½ä»¤æ¥å…³é—­ Tomcatã€‚ä¸çŸ¥é“ä½ ç•™æ„åˆ°æ²¡æœ‰ï¼Œä¸Šé¢ Caralina çš„å¯åŠ¨æ–¹æ³•çš„æœ€åä¸€è¡Œä»£ç å°±æ˜¯è°ƒç”¨äº† Server çš„ await æ–¹æ³•ã€‚</p>
<p>åœ¨ await æ–¹æ³•é‡Œä¼šåˆ›å»ºä¸€ä¸ª Socket ç›‘å¬ 8005 ç«¯å£ï¼Œå¹¶åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œæ¥æ”¶ Socket ä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰æ–°çš„è¿æ¥åˆ°æ¥å°±å»ºç«‹è¿æ¥ï¼Œç„¶åä» Socket ä¸­è¯»å–æ•°æ®ï¼›å¦‚æœè¯»åˆ°çš„æ•°æ®æ˜¯åœæ­¢å‘½ä»¤â€œSHUTDOWNâ€ï¼Œå°±é€€å‡ºå¾ªç¯ï¼Œè¿›å…¥ stop æµç¨‹ã€‚</p>
<h4 id="4-1-3-Service-ç»„ä»¶"><a href="#4-1-3-Service-ç»„ä»¶" class="headerlink" title="4.1.3. Service ç»„ä»¶"></a>4.1.3. Service ç»„ä»¶</h4><p>Service ç»„ä»¶çš„å…·ä½“å®ç°ç±»æ˜¯ StandardServiceã€‚</p>
<p>ã€æºç ã€‘StandardService æºç å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardService</span> <span class="keyword">extends</span> <span class="title class_">LifecycleBase</span> <span class="keyword">implements</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="comment">// åå­—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Server å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥å™¨æ•°ç»„</span></span><br><span class="line">    <span class="keyword">protected</span> Connector connectors[] = <span class="keyword">new</span> <span class="title class_">Connector</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">connectorsLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹åº”çš„ Engine å®¹å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜ å°„å™¨åŠå…¶ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Mapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mapper</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">MapperListener</span> <span class="variable">mapperListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperListener</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StandardService ç»§æ‰¿äº† LifecycleBase æŠ½è±¡ç±»ã€‚</p>
<p>StandardService ç»´æŠ¤äº†ä¸€ä¸ª MapperListener ç”¨äºæ”¯æŒ Tomcat çƒ­éƒ¨ç½²ã€‚å½“ Web åº”ç”¨çš„éƒ¨ç½²å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒMapper ä¸­çš„æ˜ å°„ä¿¡æ¯ä¹Ÿè¦è·Ÿç€å˜åŒ–ï¼ŒMapperListener å°±æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œå®ƒç›‘å¬å®¹å™¨çš„å˜åŒ–ï¼Œå¹¶æŠŠä¿¡æ¯æ›´æ–°åˆ° Mapper ä¸­ï¼Œè¿™æ˜¯å…¸å‹çš„è§‚å¯Ÿè€…æ¨¡å¼ã€‚</p>
<p>ä½œä¸ºâ€œç®¡ç†â€è§’è‰²çš„ç»„ä»¶ï¼Œæœ€é‡è¦çš„æ˜¯ç»´æŠ¤å…¶ä»–ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚æ­¤å¤–åœ¨å¯åŠ¨å„ç§ç»„ä»¶æ—¶ï¼Œè¦æ³¨æ„å®ƒä»¬çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æ³¨æ„å¯åŠ¨çš„é¡ºåºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. è§¦å‘å¯åŠ¨ç›‘å¬å™¨</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. å…ˆå¯åŠ¨ Engineï¼ŒEngine ä¼šå¯åŠ¨å®ƒå­å®¹å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (engine) &#123;</span><br><span class="line">            engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å†å¯åŠ¨ Mapper ç›‘å¬å™¨</span></span><br><span class="line">    mapperListener.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. æœ€åå¯åŠ¨è¿æ¥å™¨ï¼Œè¿æ¥å™¨ä¼šå¯åŠ¨å®ƒå­ç»„ä»¶ï¼Œæ¯”å¦‚ Endpoint</span></span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                connector.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»å¯åŠ¨æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼ŒService å…ˆå¯åŠ¨äº† Engine ç»„ä»¶ï¼Œå†å¯åŠ¨ Mapper ç›‘å¬å™¨ï¼Œæœ€åæ‰æ˜¯å¯åŠ¨è¿æ¥å™¨ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºå†…å±‚ç»„ä»¶å¯åŠ¨å¥½äº†æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰èƒ½å¯åŠ¨å¤–å±‚çš„è¿æ¥å™¨ç»„ä»¶ã€‚è€Œ Mapper ä¹Ÿä¾èµ–å®¹å™¨ç»„ä»¶ï¼Œå®¹å™¨ç»„ä»¶å¯åŠ¨å¥½äº†æ‰èƒ½ç›‘å¬å®ƒä»¬çš„å˜åŒ–ï¼Œå› æ­¤ Mapper å’Œ MapperListener åœ¨å®¹å™¨ç»„ä»¶ä¹‹åå¯åŠ¨ã€‚ç»„ä»¶åœæ­¢çš„é¡ºåºè·Ÿå¯åŠ¨é¡ºåºæ­£å¥½ç›¸åçš„ï¼Œä¹Ÿæ˜¯åŸºäºå®ƒä»¬çš„ä¾èµ–å…³ç³»ã€‚</p>
<h4 id="4-1-4-Engine-ç»„ä»¶"><a href="#4-1-4-Engine-ç»„ä»¶" class="headerlink" title="4.1.4. Engine ç»„ä»¶"></a>4.1.4. Engine ç»„ä»¶</h4><p>Engine æœ¬è´¨æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå› æ­¤å®ƒç»§æ‰¿äº† ContainerBase åŸºç±»ï¼Œå¹¶ä¸”å®ç°äº† Engine æ¥å£ã€‚</p>
<h3 id="4-2-Web-åº”ç”¨çš„éƒ¨ç½²æ–¹å¼"><a href="#4-2-Web-åº”ç”¨çš„éƒ¨ç½²æ–¹å¼" class="headerlink" title="4.2. Web åº”ç”¨çš„éƒ¨ç½²æ–¹å¼"></a>4.2. Web åº”ç”¨çš„éƒ¨ç½²æ–¹å¼</h3><p>æ³¨ï¼šcatalina.homeï¼šå®‰è£…ç›®å½•;catalina.baseï¼šå·¥ä½œç›®å½•;é»˜è®¤å€¼ user.dir</p>
<ul>
<li>Server.xml é…ç½® Host å…ƒç´ ï¼ŒæŒ‡å®š appBase å±æ€§ï¼Œé»˜è®¤$catalina.base&#x2F;webapps&#x2F;</li>
<li>Server.xml é…ç½® Context å…ƒç´ ï¼ŒæŒ‡å®š docBaseï¼Œå…ƒç´ ï¼ŒæŒ‡å®š web åº”ç”¨çš„è·¯å¾„</li>
<li>è‡ªå®šä¹‰é…ç½®ï¼šåœ¨$catalina.base&#x2F;EngineName&#x2F;HostName&#x2F;XXX.xml é…ç½® Context å…ƒç´ </li>
</ul>
<p>HostConfig ç›‘å¬äº† StandardHost å®¹å™¨çš„äº‹ä»¶ï¼Œåœ¨ start æ–¹æ³•ä¸­è§£æä¸Šè¿°é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li>æ‰«æ appbase è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹å’Œ war åŒ…ï¼Œè§£æå„ä¸ªåº”ç”¨çš„ META-INF&#x2F;context.xmlï¼Œå¹¶ åˆ›å»º StandardContextï¼Œå¹¶å°† Context åŠ å…¥åˆ° Host çš„å­å®¹å™¨ä¸­ã€‚</li>
<li>è§£æ$catalina.base&#x2F;EngineName&#x2F;HostName&#x2F;ä¸‹çš„æ‰€æœ‰ Context é…ç½®ï¼Œæ‰¾åˆ°ç›¸åº” web åº” ç”¨çš„ä½ç½®ï¼Œè§£æå„ä¸ªåº”ç”¨çš„ META-INF&#x2F;context.xmlï¼Œå¹¶åˆ›å»º StandardContextï¼Œå¹¶å°† Context åŠ å…¥åˆ° Host çš„å­å®¹å™¨ä¸­ã€‚</li>
</ul>
<p>æ³¨ï¼š</p>
<ul>
<li>HostConfig å¹¶æ²¡æœ‰å®é™…è§£æ Context.xmlï¼Œè€Œæ˜¯åœ¨ ContextConfig ä¸­è¿›è¡Œçš„ã€‚</li>
<li>HostConfig ä¸­ä¼šå®šæœŸæ£€æŸ¥ watched èµ„æºæ–‡ä»¶(context.xml é…ç½®æ–‡ä»¶)</li>
</ul>
<p>ContextConfig è§£æ context.xml é¡ºåºï¼š</p>
<ul>
<li>å…ˆè§£æå…¨å±€çš„é…ç½® config&#x2F;context.xml</li>
<li>ç„¶åè§£æ Host çš„é»˜è®¤é…ç½® EngineName&#x2F;HostName&#x2F;context.xml.default</li>
<li>æœ€åè§£æåº”ç”¨çš„ META-INF&#x2F;context.xml</li>
</ul>
<p>ContextConfig è§£æ web.xml é¡ºåºï¼š</p>
<ul>
<li>å…ˆè§£æå…¨å±€çš„é…ç½® config&#x2F;web.xml</li>
<li>ç„¶åè§£æ Host çš„é»˜è®¤é…ç½® EngineName&#x2F;HostName&#x2F;web.xml.default æ¥ç€è§£æåº”ç”¨çš„ MEB-INF&#x2F;web.xml</li>
<li>æ‰«æåº”ç”¨ WEB-INF&#x2F;lib&#x2F;ä¸‹çš„ jar æ–‡ä»¶ï¼Œè§£æå…¶ä¸­çš„ META-INF&#x2F;web-fragment.xml æœ€ååˆå¹¶ xml å°è£…æˆ WebXmlï¼Œå¹¶è®¾ç½® Context</li>
</ul>
<p>æ³¨ï¼š</p>
<ul>
<li>æ‰«æ web åº”ç”¨å’Œ jar ä¸­çš„æ³¨è§£(Filterã€Listenerã€Servlet)å°±æ˜¯ä¸Šè¿°æ­¥éª¤ä¸­è¿›è¡Œçš„ã€‚</li>
<li>å®¹å™¨çš„å®šæœŸæ‰§è¡Œï¼šbackgroundProcessï¼Œç”± ContainerBase æ¥å®ç°çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨é¡¶å±‚å®¹å™¨ ä¸­æ‰ä¼šå¼€å¯çº¿ç¨‹ã€‚(backgroundProcessorDelay&#x3D;10 æ ‡å¿—ä½æ¥æ§åˆ¶)</li>
</ul>
<h3 id="4-3-LifeCycle"><a href="#4-3-LifeCycle" class="headerlink" title="4.3. LifeCycle"></a>4.3. LifeCycle</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201118105012.png" alt="img"></p>
<h4 id="4-3-1-è¯·æ±‚å¤„ç†è¿‡ç¨‹"><a href="#4-3-1-è¯·æ±‚å¤„ç†è¿‡ç¨‹" class="headerlink" title="4.3.1. è¯·æ±‚å¤„ç†è¿‡ç¨‹"></a>4.3.1. è¯·æ±‚å¤„ç†è¿‡ç¨‹</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/è¯·æ±‚å¤„ç†è¿‡ç¨‹.png" width="600">
</div>

<ol>
<li>æ ¹æ® server.xml é…ç½®çš„æŒ‡å®šçš„ connector ä»¥åŠç«¯å£ç›‘å¬ httpã€æˆ–è€… ajp è¯·æ±‚</li>
<li>è¯·æ±‚åˆ°æ¥æ—¶å»ºç«‹è¿æ¥,è§£æè¯·æ±‚å‚æ•°,åˆ›å»º Request å’Œ Response å¯¹è±¡,è°ƒç”¨é¡¶å±‚å®¹å™¨ pipeline çš„ invoke æ–¹æ³•</li>
<li>å®¹å™¨ä¹‹é—´å±‚å±‚è°ƒç”¨,æœ€ç»ˆè°ƒç”¨ä¸šåŠ¡ servlet çš„ service æ–¹æ³•</li>
<li>Connector å°† response æµä¸­çš„æ•°æ®å†™åˆ° socket ä¸­</li>
</ol>
<h3 id="4-4-Connector-æµç¨‹"><a href="#4-4-Connector-æµç¨‹" class="headerlink" title="4.4. Connector æµç¨‹"></a>4.4. Connector æµç¨‹</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/connector.png" width="600">
</div>

<h4 id="4-4-1-é˜»å¡-IO"><a href="#4-4-1-é˜»å¡-IO" class="headerlink" title="4.4.1. é˜»å¡ IO"></a>4.4.1. é˜»å¡ IO</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/é˜»å¡IO.png" width="600">
</div>

<h4 id="4-4-2-éé˜»å¡-IO"><a href="#4-4-2-éé˜»å¡-IO" class="headerlink" title="4.4.2. éé˜»å¡ IO"></a>4.4.2. éé˜»å¡ IO</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/éé˜»å¡IO.png" width="600">
</div>

<h4 id="4-4-3-IO-å¤šè·¯å¤ç”¨"><a href="#4-4-3-IO-å¤šè·¯å¤ç”¨" class="headerlink" title="4.4.3. IO å¤šè·¯å¤ç”¨"></a>4.4.3. IO å¤šè·¯å¤ç”¨</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/IOå¤šè·¯å¤ç”¨.png" width="600">
</div>

<p>é˜»å¡ä¸éé˜»å¡çš„åŒºåˆ«åœ¨äºè¿›è¡Œè¯»æ“ä½œå’Œå†™æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¦‚æœæ­¤æ—¶å†…æ ¸æ€æ²¡æœ‰æ•°æ®å¯è¯»æˆ–è€…æ²¡æœ‰ç¼“å†²ç©ºé—´å¯å†™æ—¶ï¼Œæ˜¯å¦é˜»å¡ã€‚</p>
<p>IO å¤šè·¯å¤ç”¨çš„å¥½å¤„åœ¨äºå¯åŒæ—¶ç›‘å¬å¤šä¸ª socket çš„å¯è¯»å’Œå¯å†™äº‹ä»¶ï¼Œè¿™æ ·å°±èƒ½ä½¿å¾—åº”ç”¨å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ª socketï¼Œé‡Šæ”¾äº†åº”ç”¨çº¿ç¨‹èµ„æºã€‚</p>
<h4 id="4-4-4-Tomcat-å„ç±»-Connector-å¯¹æ¯”"><a href="#4-4-4-Tomcat-å„ç±»-Connector-å¯¹æ¯”" class="headerlink" title="4.4.4. Tomcat å„ç±» Connector å¯¹æ¯”"></a>4.4.4. Tomcat å„ç±» Connector å¯¹æ¯”</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/Tomcatå„ç±»Connectorå¯¹æ¯”.jpg" width="500">
</div>

<ul>
<li>JIOï¼šç”¨ java.io ç¼–å†™çš„ TCP æ¨¡å—ï¼Œé˜»å¡ IO</li>
<li>NIOï¼šç”¨ java.nio ç¼–å†™çš„ TCP æ¨¡å—ï¼Œéé˜»å¡ IOï¼Œï¼ˆIO å¤šè·¯å¤ç”¨ï¼‰</li>
<li>APRï¼šå…¨ç§° Apache Portable Runtimeï¼Œä½¿ç”¨ JNI çš„æ–¹å¼æ¥è¿›è¡Œè¯»å–æ–‡ä»¶ä»¥åŠè¿›è¡Œç½‘ç»œä¼ è¾“</li>
</ul>
<p>Apache Portable Runtime æ˜¯ä¸€ä¸ªé«˜åº¦å¯ç§»æ¤çš„åº“ï¼Œå®ƒæ˜¯ Apache HTTP Server 2.x çš„æ ¸å¿ƒã€‚ APR å…·æœ‰è®¸å¤šç”¨é€”ï¼ŒåŒ…æ‹¬è®¿é—®é«˜çº§ IO åŠŸèƒ½ï¼ˆå¦‚ sendfileï¼Œepoll å’Œ OpenSSLï¼‰ï¼Œæ“ä½œç³»ç»Ÿçº§åŠŸèƒ½ï¼ˆéšæœºæ•°ç”Ÿæˆï¼Œç³»ç»ŸçŠ¶æ€ç­‰ï¼‰å’Œæœ¬åœ°è¿›ç¨‹å¤„ç†ï¼ˆå…±äº«å†…å­˜ï¼ŒNT ç®¡é“å’Œ Unix å¥—æ¥å­—ï¼‰ã€‚</p>
<p>è¡¨æ ¼ä¸­å­—æ®µå«ä¹‰è¯´æ˜ï¼š</p>
<ul>
<li>Support Polling - æ˜¯å¦æ”¯æŒåŸºäº IO å¤šè·¯å¤ç”¨çš„ socket äº‹ä»¶è½®è¯¢</li>
<li>Polling Size - è½®è¯¢çš„æœ€å¤§è¿æ¥æ•°</li>
<li>Wait for next Request - åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¤„ç†çº¿ç¨‹æ˜¯å¦é‡Šæ”¾ï¼ŒBIO æ˜¯æ²¡æœ‰é‡Šæ”¾çš„ï¼Œæ‰€ä»¥åœ¨ keep-alive&#x3D;true çš„æƒ…å†µä¸‹å¤„ç†çš„å¹¶å‘è¿æ¥æ•°æœ‰é™</li>
<li>Read Request Headers - ç”±äº request header æ•°æ®è¾ƒå°‘ï¼Œå¯ä»¥ç”±å®¹å™¨æå‰è§£æå®Œæ¯•ï¼Œä¸éœ€è¦é˜»å¡</li>
<li>Read Request Body - è¯»å– request body çš„æ•°æ®æ˜¯åº”ç”¨ä¸šåŠ¡é€»è¾‘çš„äº‹æƒ…ï¼ŒåŒæ—¶ Servlet çš„é™åˆ¶ï¼Œæ˜¯éœ€è¦é˜»å¡è¯»å–çš„</li>
<li>Write Response - è·Ÿè¯»å– request body çš„é€»è¾‘ç±»ä¼¼ï¼ŒåŒæ ·éœ€è¦é˜»å¡å†™</li>
</ul>
<p><strong>NIO å¤„ç†ç›¸å…³ç±»</strong></p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/NIOå¤„ç†ç›¸å…³ç±».jpg" width="500">
</div>

<p>Poller çº¿ç¨‹ä» EventQueue è·å– PollerEventï¼Œå¹¶æ‰§è¡Œ PollerEvent çš„ run æ–¹æ³•ï¼Œè°ƒç”¨ Selector çš„ select æ–¹æ³•ï¼Œå¦‚æœæœ‰å¯è¯»çš„ Socket åˆ™åˆ›å»º Http11NioProcessorï¼Œæ”¾å…¥åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼›</p>
<p>CoyoteAdapter æ˜¯ Connector åˆ° Container çš„é€‚é…å™¨ï¼ŒHttp11NioProcessor è°ƒç”¨å…¶æä¾›çš„ service æ–¹æ³•ï¼Œå†…éƒ¨åˆ›å»º Request å’Œ Response å¯¹è±¡ï¼Œå¹¶è°ƒç”¨æœ€é¡¶å±‚å®¹å™¨çš„ Pipeline ä¸­çš„ç¬¬ä¸€ä¸ª Valve çš„ invoke æ–¹æ³•</p>
<p>Mapper ä¸»è¦å¤„ç† http url åˆ° servlet çš„æ˜ å°„è§„åˆ™çš„è§£æï¼Œå¯¹å¤–æä¾› map æ–¹æ³•</p>
<h3 id="4-5-Comet"><a href="#4-5-Comet" class="headerlink" title="4.5. Comet"></a>4.5. Comet</h3><p>Comet æ˜¯ä¸€ç§ç”¨äº web çš„æ¨é€æŠ€æœ¯ï¼Œèƒ½ä½¿æœåŠ¡å™¨å®æ—¶åœ°å°†æ›´æ–°çš„ä¿¡æ¯ä¼ é€åˆ°å®¢æˆ·ç«¯ï¼Œè€Œæ— é¡»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚<br>åœ¨ WebSocket å‡ºæ¥ä¹‹å‰ï¼Œå¦‚æœä¸é€‚ç”¨ cometï¼Œåªèƒ½é€šè¿‡æµè§ˆå™¨ç«¯è½®è¯¢ Server æ¥æ¨¡æ‹Ÿå®ç°æœåŠ¡å™¨ç«¯æ¨é€ã€‚<br>Comet æ”¯æŒ servlet å¼‚æ­¥å¤„ç† IOï¼Œå½“è¿æ¥ä¸Šæ•°æ®å¯è¯»æ—¶è§¦å‘äº‹ä»¶ï¼Œå¹¶å¼‚æ­¥å†™æ•°æ®(é˜»å¡)</p>
<p>Tomcat è¦å®ç° Cometï¼Œåªéœ€ç»§æ‰¿ HttpServlet åŒæ—¶ï¼Œå®ç° CometProcessor æ¥å£</p>
<ul>
<li>Beginï¼šæ–°çš„è¯·æ±‚è¿æ¥æ¥å…¥è°ƒç”¨ï¼Œå¯è¿›è¡Œä¸ Request å’Œ Response ç›¸å…³çš„å¯¹è±¡åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¿å­˜ response å¯¹è±¡ï¼Œç”¨äºåç»­å†™å…¥æ•°æ®</li>
<li>Readï¼šè¯·æ±‚è¿æ¥æœ‰æ•°æ®å¯è¯»æ—¶è°ƒç”¨</li>
<li>Endï¼šå½“æ•°æ®å¯ç”¨æ—¶ï¼Œå¦‚æœè¯»å–åˆ°æ–‡ä»¶ç»“æŸæˆ–è€… response è¢«å…³é—­æ—¶åˆ™è¢«è°ƒç”¨</li>
<li>Errorï¼šåœ¨è¿æ¥ä¸Šå‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨ï¼Œæ•°æ®è¯»å–å¼‚å¸¸ã€è¿æ¥æ–­å¼€ã€å¤„ç†å¼‚å¸¸ã€socket è¶…æ—¶</li>
</ul>
<p>Noteï¼š</p>
<ul>
<li>Readï¼šåœ¨ post è¯·æ±‚æœ‰æ•°æ®ï¼Œä½†åœ¨ begin äº‹ä»¶ä¸­æ²¡æœ‰å¤„ç†ï¼Œåˆ™ä¼šè°ƒç”¨ readï¼Œå¦‚æœ read æ²¡æœ‰è¯»å–æ•°æ®ï¼Œåœ¨ä¼šè§¦å‘ Error å›è°ƒï¼Œå…³é—­ socket</li>
<li>Endï¼šå½“ socket è¶…æ—¶ï¼Œå¹¶ä¸” response è¢«å…³é—­æ—¶ä¹Ÿä¼šè°ƒç”¨ï¼›server è¢«å…³é—­æ—¶è°ƒç”¨</li>
<li>Errorï¼šé™¤äº† socket è¶…æ—¶ä¸ä¼šå…³é—­ socketï¼Œå…¶ä»–éƒ½ä¼šå…³é—­ socket</li>
<li>End å’Œ Error æ—¶é—´è§¦å‘æ—¶åº”å…³é—­å½“å‰ comet ä¼šè¯ï¼Œå³è°ƒç”¨ CometEvent çš„ close æ–¹æ³•<br>Noteï¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è¦åšå¥½çº¿ç¨‹å®‰å…¨çš„æ“ä½œ</li>
</ul>
<h3 id="4-6-å¼‚æ­¥-Servlet"><a href="#4-6-å¼‚æ­¥-Servlet" class="headerlink" title="4.6. å¼‚æ­¥ Servlet"></a>4.6. å¼‚æ­¥ Servlet</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/ä¼ ç»ŸServletå¤„ç†æµç¨‹.png" >
</div>

<p>ä¼ ç»Ÿæµç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼ŒServlet æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œrequest æ•°æ®è§£æï¼›</li>
<li>æ¥ç€ï¼Œè°ƒç”¨ä¸šåŠ¡æ¥å£çš„æŸäº›æ–¹æ³•ï¼Œä»¥å®Œæˆä¸šåŠ¡å¤„ç†ï¼›</li>
<li>æœ€åï¼Œæ ¹æ®å¤„ç†çš„ç»“æœæäº¤å“åº”ï¼ŒServlet çº¿ç¨‹ç»“æŸ</li>
</ul>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/å¼‚æ­¥Servletå¤„ç†æµç¨‹.png" >
</div>

<p>å¼‚æ­¥å¤„ç†æµç¨‹ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚</li>
<li>Servlet å®¹å™¨åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å®¹å™¨ä¸­çš„ä¸€ä¸ª servlet</li>
<li>servlet è°ƒç”¨ request.startAsync()ï¼Œä¿å­˜ AsyncContext, ç„¶åè¿”å›</li>
<li>ä»»ä½•æ–¹å¼å­˜åœ¨çš„å®¹å™¨çº¿ç¨‹éƒ½å°†é€€å‡ºï¼Œä½†æ˜¯ response ä»ç„¶ä¿æŒå¼€æ”¾</li>
<li>ä¸šåŠ¡çº¿ç¨‹ä½¿ç”¨ä¿å­˜çš„ AsyncContext æ¥å®Œæˆå“åº”ï¼ˆçº¿ç¨‹æ± ï¼‰</li>
<li>å®¢æˆ·ç«¯æ”¶åˆ°å“åº”</li>
</ul>
<p>Servlet çº¿ç¨‹å°†è¯·æ±‚è½¬äº¤ç»™ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œä¸šåŠ¡å¤„ç†ï¼Œçº¿ç¨‹æœ¬èº«è¿”å›è‡³å®¹å™¨ï¼Œæ­¤æ—¶ Servlet è¿˜æ²¡æœ‰ç”Ÿæˆå“åº”æ•°æ®ï¼Œå¼‚æ­¥çº¿ç¨‹å¤„ç†å®Œä¸šåŠ¡ä»¥åï¼Œå¯ä»¥ç›´æ¥ç”Ÿæˆå“åº”æ•°æ®ï¼ˆå¼‚æ­¥çº¿ç¨‹æ‹¥æœ‰ ServletRequest å’Œ ServletResponse å¯¹è±¡çš„å¼•ç”¨ï¼‰</p>
<p><strong>ä¸ºä»€ä¹ˆ web åº”ç”¨ä¸­æ”¯æŒå¼‚æ­¥ï¼Ÿ</strong></p>
<p>æ¨å‡ºå¼‚æ­¥ï¼Œä¸»è¦æ˜¯é’ˆå¯¹é‚£äº›æ¯”è¾ƒè€—æ—¶çš„è¯·æ±‚ï¼šæ¯”å¦‚ä¸€æ¬¡ç¼“æ…¢çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸€æ¬¡å¤–éƒ¨ REST API è°ƒç”¨, æˆ–è€…æ˜¯å…¶ä»–ä¸€äº› I&#x2F;O å¯†é›†å‹æ“ä½œã€‚è¿™ç§è€—æ—¶çš„è¯·æ±‚ä¼šå¾ˆå¿«çš„è€—å…‰ Servlet å®¹å™¨çš„çº¿ç¨‹æ± ï¼Œç»§è€Œå½±å“å¯æ‰©å±•æ€§ã€‚</p>
<p>Noteï¼šä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œrequest ä»ç„¶åƒä»»ä½•å…¶ä»–çš„ HTTP çš„ request-response äº¤äº’ä¸€æ ·ï¼Œåªæ˜¯è€—è´¹äº†æ›´é•¿çš„æ—¶é—´è€Œå·²</p>
<p><strong>å¼‚æ­¥äº‹ä»¶ç›‘å¬</strong></p>
<ul>
<li>onStartAsyncï¼šRequest è°ƒç”¨ startAsync æ–¹æ³•æ—¶è§¦å‘</li>
<li>onCompleteï¼šsyncContext è°ƒç”¨ complete æ–¹æ³•æ—¶è§¦å‘</li>
<li>onErrorï¼šå¤„ç†è¯·æ±‚çš„è¿‡ç¨‹å‡ºç°å¼‚å¸¸æ—¶è§¦å‘</li>
<li>onTimeoutï¼šsocket è¶…æ—¶è§¦å‘</li>
</ul>
<p>Note :<br>onError&#x2F; onTimeout è§¦å‘åï¼Œä¼šç´§æ¥ç€å›è°ƒ onComplete<br>onComplete æ‰§è¡Œåï¼Œå°±ä¸å¯å†æ“ä½œ request å’Œ response</p>
<h2 id="5-å‚è€ƒèµ„æ–™"><a href="#5-å‚è€ƒèµ„æ–™" class="headerlink" title="5. å‚è€ƒèµ„æ–™"></a>5. å‚è€ƒèµ„æ–™</h2><ul>
<li><p><strong>å®˜æ–¹</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><p><strong>æ–‡ç« </strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/basic_app_embedded_tomcat/basic_app-tomcat-embedded.html">Creating a Web App with Bootstrap and Tomcat Embedded</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/58eb5fdda0bb9f00692a78fc">Tomcat ç»„æˆä¸å·¥ä½œåŸç†</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/index.html">Tomcat å·¥ä½œåŸç†</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat2/index.html?ca=drs-">Tomcat è®¾è®¡æ¨¡å¼åˆ†æ</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/f37326/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/f37326/" class="post-title-link" itemprop="url">Tomcat å’Œ Jetty</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>845</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Tomcat-å’Œ-Jetty"><a href="#Tomcat-å’Œ-Jetty" class="headerlink" title="Tomcat å’Œ Jetty"></a>Tomcat å’Œ Jetty</h2><p>Web å®¹å™¨ Tomcat æˆ– Jettyï¼Œä½œä¸ºé‡è¦çš„ç³»ç»Ÿä¸­é—´ä»¶ï¼Œè¿æ¥ç€æµè§ˆå™¨å’Œä½ çš„ Web åº”ç”¨ï¼Œå¹¶ä¸”æ”¯æ’‘ç€ Web ç¨‹åºçš„è¿è¡Œï¼Œå¯ä»¥è¯´ï¼Œ<strong>å¼„æ‡‚äº† Tomcat å’Œ Jetty çš„åŸç†ï¼ŒJava Web å¼€å‘å¯¹ä½ æ¥è¯´å°±æ¯«æ— ç§˜å¯†å¯è¨€</strong>ã€‚</p>
<h2 id="Web-å®¹å™¨"><a href="#Web-å®¹å™¨" class="headerlink" title="Web å®¹å™¨"></a>Web å®¹å™¨</h2><p>æ—©æœŸçš„ Web åº”ç”¨ä¸»è¦ç”¨äºæµè§ˆæ–°é—»ç­‰é™æ€é¡µé¢ï¼ŒHTTP æœåŠ¡å™¨ï¼ˆæ¯”å¦‚ Apacheã€Nginxï¼‰å‘æµè§ˆå™¨è¿”å›é™æ€ HTMLï¼Œæµè§ˆå™¨è´Ÿè´£è§£æ HTMLï¼Œå°†ç»“æœå‘ˆç°ç»™ç”¨æˆ·ã€‚</p>
<p>éšç€äº’è”ç½‘çš„å‘å±•ï¼Œæˆ‘ä»¬å·²ç»ä¸æ»¡è¶³äºä»…ä»…æµè§ˆé™æ€é¡µé¢ï¼Œè¿˜å¸Œæœ›é€šè¿‡ä¸€äº›äº¤äº’æ“ä½œï¼Œæ¥è·å–åŠ¨æ€ç»“æœï¼Œå› æ­¤ä¹Ÿå°±éœ€è¦ä¸€äº›æ‰©å±•æœºåˆ¶èƒ½å¤Ÿè®© HTTP æœåŠ¡å™¨è°ƒç”¨æœåŠ¡ç«¯ç¨‹åºã€‚</p>
<p>äºæ˜¯ Sun å…¬å¸æ¨å‡ºäº† Servlet æŠ€æœ¯ã€‚ä½ å¯ä»¥æŠŠ Servlet ç®€å•ç†è§£ä¸ºè¿è¡Œåœ¨æœåŠ¡ç«¯çš„ Java å°ç¨‹åºï¼Œä½†æ˜¯ Servlet æ²¡æœ‰ main æ–¹æ³•ï¼Œä¸èƒ½ç‹¬ç«‹è¿è¡Œï¼Œå› æ­¤å¿…é¡»æŠŠå®ƒéƒ¨ç½²åˆ° Servlet å®¹å™¨ä¸­ï¼Œç”±å®¹å™¨æ¥å®ä¾‹åŒ–å¹¶è°ƒç”¨ Servletã€‚</p>
<p>è€Œ Tomcat å’Œ Jetty å°±æ˜¯ä¸€ä¸ª Servlet å®¹å™¨ã€‚ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå®ƒä»¬ä¹Ÿå…·æœ‰ HTTP æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤<strong>Tomcat æˆ–è€… Jetty å°±æ˜¯ä¸€ä¸ªâ€œHTTP æœåŠ¡å™¨ + Servlet å®¹å™¨â€ï¼Œæˆ‘ä»¬ä¹Ÿå«å®ƒä»¬ Web å®¹å™¨ã€‚</strong></p>
<p>å…¶ä»–åº”ç”¨æœåŠ¡å™¨æ¯”å¦‚ JBoss å’Œ WebLogicï¼Œå®ƒä»¬ä¸ä»…ä»…æœ‰ Servlet å®¹å™¨çš„åŠŸèƒ½ï¼Œä¹ŸåŒ…å« EJB å®¹å™¨ï¼Œæ˜¯å®Œæ•´çš„ Java EE åº”ç”¨æœåŠ¡å™¨ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼ŒTomcat å’Œ Jetty ç®—æ˜¯ä¸€ä¸ªè½»é‡çº§çš„åº”ç”¨æœåŠ¡å™¨ã€‚</p>
<p>åœ¨å¾®æœåŠ¡æ¶æ„æ—¥æ¸æµè¡Œçš„ä»Šå¤©ï¼Œå¼€å‘äººå‘˜æ›´å–œæ¬¢ç¨³å®šçš„ã€è½»é‡çº§çš„åº”ç”¨æœåŠ¡å™¨ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºç”¨å†…åµŒçš„æ–¹å¼æ¥è¿è¡Œ Servlet å®¹å™¨ä¹Ÿé€æ¸æµè¡Œèµ·æ¥ã€‚ä¹‹æ‰€ä»¥é€‰æ‹©è½»é‡çº§ï¼Œæ˜¯å› ä¸ºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªå¤§è€Œå…¨çš„å•ä½“åº”ç”¨ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸ªåŠŸèƒ½å•ä¸€çš„å¾®æœåŠ¡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡çš„æ•°é‡å¿…ç„¶è¦å¢åŠ ï¼Œä½†ä¸ºäº†å‡å°‘èµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”é™ä½éƒ¨ç½²çš„æˆæœ¬ï¼Œæˆ‘ä»¬å¸Œæœ›è¿è¡ŒæœåŠ¡çš„ Web å®¹å™¨ä¹Ÿæ˜¯è½»é‡çº§çš„ï¼ŒWeb å®¹å™¨æœ¬èº«åº”è¯¥æ¶ˆè€—è¾ƒå°‘çš„å†…å­˜å’Œ CPU èµ„æºï¼Œå¹¶ä¸”ç”±åº”ç”¨æœ¬èº«æ¥å¯åŠ¨ä¸€ä¸ªåµŒå…¥å¼çš„ Web å®¹å™¨ï¼Œè€Œä¸æ˜¯é€šè¿‡ Web å®¹å™¨æ¥éƒ¨ç½²å’Œå¯åŠ¨åº”ç”¨ï¼Œè¿™æ ·å¯ä»¥é™ä½åº”ç”¨éƒ¨ç½²çš„å¤æ‚åº¦ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/d5076a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/d5076a/" class="post-title-link" itemprop="url">Tomcatå®¹å™¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>18 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-å®¹å™¨"><a href="#Tomcat-å®¹å™¨" class="headerlink" title="Tomcat å®¹å™¨"></a>Tomcat å®¹å™¨</h1><h2 id="Tomcat-å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½"><a href="#Tomcat-å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½" class="headerlink" title="Tomcat å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½"></a>Tomcat å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½</h2><ul>
<li>çƒ­åŠ è½½çš„å®ç°æ–¹å¼æ˜¯ Web å®¹å™¨å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œå®šæœŸæ£€æµ‹ç±»æ–‡ä»¶çš„å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œå°±é‡æ–°åŠ è½½ç±»ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šæ¸…ç©º Session ï¼Œä¸€èˆ¬ç”¨åœ¨å¼€å‘ç¯å¢ƒã€‚</li>
<li>çƒ­éƒ¨ç½²åŸç†ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±åå°çº¿ç¨‹å®šæ—¶æ£€æµ‹ Web åº”ç”¨çš„å˜åŒ–ï¼Œä½†å®ƒä¼šé‡æ–°åŠ è½½æ•´ä¸ª Web åº”ç”¨ã€‚è¿™ç§æ–¹å¼ä¼šæ¸…ç©º Sessionï¼Œæ¯”çƒ­åŠ è½½æ›´åŠ å¹²å‡€ã€å½»åº•ï¼Œä¸€èˆ¬ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚</li>
</ul>
<p>Tomcat é€šè¿‡å¼€å¯åå°çº¿ç¨‹ï¼Œä½¿å¾—å„ä¸ªå±‚æ¬¡çš„å®¹å™¨ç»„ä»¶éƒ½æœ‰æœºä¼šå®Œæˆä¸€äº›å‘¨æœŸæ€§ä»»åŠ¡ã€‚Tomcat æ˜¯åŸºäº ScheduledThreadPoolExecutor å®ç°å‘¨æœŸæ€§ä»»åŠ¡çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bgFuture = exec.scheduleWithFixedDelay(</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">ContainerBackgroundProcessor</span>(),<span class="comment">// è¦æ‰§è¡Œçš„ Runnable</span></span><br><span class="line">              backgroundProcessorDelay, <span class="comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿå¤šä¹…</span></span><br><span class="line">              backgroundProcessorDelay, <span class="comment">// ä¹‹åæ¯æ¬¡æ‰§è¡Œé—´éš”å¤šä¹…</span></span><br><span class="line">              TimeUnit.SECONDS);        <span class="comment">// æ—¶é—´å•ä½</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¦å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ç±» ContainerBackgroundProcessorï¼Œå®ƒæ˜¯ä¸€ä¸ª Runnableï¼ŒåŒæ—¶ä¹Ÿæ˜¯ ContainerBase çš„å†…éƒ¨ç±»ï¼ŒContainerBase æ˜¯æ‰€æœ‰å®¹å™¨ç»„ä»¶çš„åŸºç±»ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹å®¹å™¨ç»„ä»¶æœ‰å“ªäº›ï¼Œæœ‰ Engineã€Hostã€Context å’Œ Wrapper ç­‰ï¼Œå®ƒä»¬å…·æœ‰çˆ¶å­å…³ç³»ã€‚</p>
<h3 id="ContainerBackgroundProcessor-å®ç°"><a href="#ContainerBackgroundProcessor-å®ç°" class="headerlink" title="ContainerBackgroundProcessor å®ç°"></a>ContainerBackgroundProcessor å®ç°</h3><p>æˆ‘ä»¬æ¥æ¥çœ‹ ContainerBackgroundProcessor å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">ContainerBackgroundProcessor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è¯·æ³¨æ„è¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯ &quot; å®¿ä¸»ç±» &quot; çš„å®ä¾‹</span></span><br><span class="line">        processChildren(ContainerBase.<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processChildren</span><span class="params">(Container container)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. è°ƒç”¨å½“å‰å®¹å™¨çš„ backgroundProcess æ–¹æ³•ã€‚</span></span><br><span class="line">            container.backgroundProcess();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. éå†æ‰€æœ‰çš„å­å®¹å™¨ï¼Œé€’å½’è°ƒç”¨ processChildrenï¼Œ</span></span><br><span class="line">            <span class="comment">// è¿™æ ·å½“å‰å®¹å™¨çš„å­å­™éƒ½ä¼šè¢«å¤„ç†</span></span><br><span class="line">            Container[] children = container.findChildren();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œå®¹å™¨åŸºç±»æœ‰ä¸ªå˜é‡å«åš backgroundProcessorDelayï¼Œå¦‚æœå¤§äº 0ï¼Œè¡¨æ˜å­å®¹å™¨æœ‰è‡ªå·±çš„åå°çº¿ç¨‹ï¼Œæ— éœ€çˆ¶å®¹å™¨æ¥è°ƒç”¨å®ƒçš„ processChildren æ–¹æ³•ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    processChildren(children[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç é€»è¾‘ä¹Ÿæ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œé¦–å…ˆ ContainerBackgroundProcessor æ˜¯ä¸€ä¸ª Runnableï¼Œå®ƒéœ€è¦å®ç° run æ–¹æ³•ï¼Œå®ƒçš„ run å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨äº† processChildren æ–¹æ³•ã€‚è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œå®ƒæŠŠâ€œå®¿ä¸»ç±»â€ï¼Œä¹Ÿå°±æ˜¯<strong>ContainerBase çš„ç±»å®ä¾‹å½“æˆå‚æ•°ä¼ ç»™äº† run æ–¹æ³•</strong>ã€‚</p>
<p>è€Œåœ¨ processChildren æ–¹æ³•é‡Œï¼Œå°±åšäº†ä¸¤æ­¥ï¼šè°ƒç”¨å½“å‰å®¹å™¨çš„ backgroundProcess æ–¹æ³•ï¼Œä»¥åŠé€’å½’è°ƒç”¨å­å­™çš„ backgroundProcess æ–¹æ³•ã€‚è¯·ä½ æ³¨æ„ backgroundProcess æ˜¯ Container æ¥å£ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰ç±»å‹çš„å®¹å™¨éƒ½å¯ä»¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œå®Œæˆéœ€è¦å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
<p>è¿™æ ·çš„è®¾è®¡æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦åœ¨é¡¶å±‚å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯ Engine å®¹å™¨ä¸­å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹<strong>ä¸ä½†ä¼šæ‰§è¡Œ Engine å®¹å™¨çš„å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå®ƒè¿˜ä¼šæ‰§è¡Œæ‰€æœ‰å­å®¹å™¨çš„å‘¨æœŸæ€§ä»»åŠ¡</strong>ã€‚</p>
<h3 id="backgroundProcess-æ–¹æ³•"><a href="#backgroundProcess-æ–¹æ³•" class="headerlink" title="backgroundProcess æ–¹æ³•"></a>backgroundProcess æ–¹æ³•</h3><p>ä¸Šè¿°ä»£ç éƒ½æ˜¯åœ¨åŸºç±» ContainerBase ä¸­å®ç°çš„ï¼Œé‚£å…·ä½“å®¹å™¨ç±»éœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå¦‚æœæœ‰å‘¨æœŸæ€§ä»»åŠ¡è¦æ‰§è¡Œï¼Œå°±å®ç° backgroundProcess æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±é‡ç”¨åŸºç±» ContainerBase çš„æ–¹æ³•ã€‚ContainerBase çš„ backgroundProcess æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. æ‰§è¡Œå®¹å™¨ä¸­ Cluster ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Cluster</span> <span class="variable">cluster</span> <span class="operator">=</span> getClusterInternal();</span><br><span class="line">    <span class="keyword">if</span> (cluster != <span class="literal">null</span>) &#123;</span><br><span class="line">        cluster.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ‰§è¡Œå®¹å™¨ä¸­ Realm ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Realm</span> <span class="variable">realm</span> <span class="operator">=</span> getRealmInternal();</span><br><span class="line">    <span class="keyword">if</span> (realm != <span class="literal">null</span>) &#123;</span><br><span class="line">        realm.backgroundProcess();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. æ‰§è¡Œå®¹å™¨ä¸­ Valve ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Valve</span> <span class="variable">current</span> <span class="operator">=</span> pipeline.getFirst();</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">       current.backgroundProcess();</span><br><span class="line">       current = current.getNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. è§¦å‘å®¹å™¨çš„ &quot; å‘¨æœŸäº‹ä»¶ &quot;ï¼ŒHost å®¹å™¨çš„ç›‘å¬å™¨ HostConfig å°±é å®ƒæ¥è°ƒç”¨</span></span><br><span class="line">    fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¸ä»…æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰å‘¨æœŸæ€§ä»»åŠ¡ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„å…¶ä»–é€šç”¨ç»„ä»¶ï¼Œæ¯”å¦‚è·Ÿé›†ç¾¤ç®¡ç†æœ‰å…³çš„ Cluster ç»„ä»¶ã€è·Ÿå®‰å…¨ç®¡ç†æœ‰å…³çš„ Realm ç»„ä»¶éƒ½å¯ä»¥æœ‰è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡ã€‚</p>
<p>æˆ‘åœ¨å‰é¢çš„ä¸“æ é‡Œæåˆ°è¿‡ï¼Œå®¹å™¨ä¹‹é—´çš„é“¾å¼è°ƒç”¨æ˜¯é€šè¿‡ Pipeline-Valve æœºåˆ¶æ¥å®ç°çš„ï¼Œä»ä¸Šé¢çš„ä»£ç ä½ å¯ä»¥çœ‹åˆ°å®¹å™¨ä¸­çš„ Valve ä¹Ÿå¯ä»¥æœ‰å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå¹¶ä¸”è¢« ContainerBase ç»Ÿä¸€å¤„ç†ã€‚</p>
<p>è¯·ä½ ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œåœ¨ backgroundProcess æ–¹æ³•çš„æœ€åï¼Œè¿˜è§¦å‘äº†å®¹å™¨çš„â€œå‘¨æœŸäº‹ä»¶â€ã€‚æˆ‘ä»¬çŸ¥é“å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æœ‰åˆå§‹åŒ–ã€å¯åŠ¨å’Œåœæ­¢ç­‰ï¼Œé‚£â€œå‘¨æœŸäº‹ä»¶â€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒè·Ÿç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸€æ ·ï¼Œæ˜¯ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œä½ å¯ä»¥è¿™æ ·ç†è§£ï¼š</p>
<p>åˆä¸€æ®µæ—¶é—´è¿‡å»äº†ï¼Œå®¹å™¨è¿˜æ´»ç€ï¼Œä½ æƒ³åšç‚¹ä»€ä¹ˆå—ï¼Ÿå¦‚æœä½ æƒ³åšç‚¹ä»€ä¹ˆï¼Œå°±åˆ›å»ºä¸€ä¸ªç›‘å¬å™¨æ¥ç›‘å¬è¿™ä¸ªâ€œå‘¨æœŸäº‹ä»¶â€ï¼Œäº‹ä»¶åˆ°äº†æˆ‘è´Ÿè´£è°ƒç”¨ä½ çš„æ–¹æ³•ã€‚</p>
<p>æ€»ä¹‹ï¼Œæœ‰äº† ContainerBase ä¸­çš„åå°çº¿ç¨‹å’Œ backgroundProcess æ–¹æ³•ï¼Œå„ç§å­å®¹å™¨å’Œé€šç”¨ç»„ä»¶ä¸éœ€è¦å„è‡ªå¼„ä¸€ä¸ªåå°çº¿ç¨‹æ¥å¤„ç†å‘¨æœŸæ€§ä»»åŠ¡ï¼Œè¿™æ ·çš„è®¾è®¡æ˜¾å¾—ä¼˜é›…å’Œæ•´æ´ã€‚</p>
<h3 id="Tomcat-çƒ­åŠ è½½"><a href="#Tomcat-çƒ­åŠ è½½" class="headerlink" title="Tomcat çƒ­åŠ è½½"></a>Tomcat çƒ­åŠ è½½</h3><p>æœ‰äº† ContainerBase çš„å‘¨æœŸæ€§ä»»åŠ¡å¤„ç†â€œæ¡†æ¶â€ï¼Œä½œä¸ºå…·ä½“å®¹å™¨å­ç±»ï¼Œåªéœ€è¦å®ç°è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡å°±è¡Œã€‚è€Œ Tomcat çš„çƒ­åŠ è½½ï¼Œå°±æ˜¯åœ¨ Context å®¹å™¨ä¸­å®ç°çš„ã€‚Context å®¹å™¨çš„ backgroundProcess æ–¹æ³•æ˜¯è¿™æ ·å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//WebappLoader å‘¨æœŸæ€§çš„æ£€æŸ¥ WEB-INF/classes å’Œ WEB-INF/lib ç›®å½•ä¸‹çš„ç±»æ–‡ä»¶</span></span><br><span class="line">    <span class="type">Loader</span> <span class="variable">loader</span> <span class="operator">=</span> getLoader();</span><br><span class="line">    <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">        loader.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Session ç®¡ç†å™¨å‘¨æœŸæ€§çš„æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸçš„ Session</span></span><br><span class="line">    <span class="type">Manager</span> <span class="variable">manager</span> <span class="operator">=</span> getManager();</span><br><span class="line">    <span class="keyword">if</span> (manager != <span class="literal">null</span>) &#123;</span><br><span class="line">        manager.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘¨æœŸæ€§çš„æ£€æŸ¥é™æ€èµ„æºæ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">    <span class="type">WebResourceRoot</span> <span class="variable">resources</span> <span class="operator">=</span> getResources();</span><br><span class="line">    <span class="keyword">if</span> (resources != <span class="literal">null</span>) &#123;</span><br><span class="line">        resources.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±» ContainerBase çš„ backgroundProcess æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">super</span>.backgroundProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çœ‹åˆ° Context å®¹å™¨é€šè¿‡ WebappLoader æ¥æ£€æŸ¥ç±»æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°ï¼Œé€šè¿‡ Session ç®¡ç†å™¨æ¥æ£€æŸ¥æ˜¯å¦æœ‰ Session è¿‡æœŸï¼Œå¹¶ä¸”é€šè¿‡èµ„æºç®¡ç†å™¨æ¥æ£€æŸ¥é™æ€èµ„æºæ˜¯å¦æœ‰æ›´æ–°ï¼Œæœ€åè¿˜è°ƒç”¨äº†çˆ¶ç±» ContainerBase çš„ backgroundProcess æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨ï¼ŒWebappLoader æ˜¯å¦‚ä½•å®ç°çƒ­åŠ è½½çš„ï¼Œå®ƒä¸»è¦æ˜¯è°ƒç”¨äº† Context å®¹å™¨çš„ reload æ–¹æ³•ï¼Œè€Œ Context çš„ reload æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæ€»ç»“èµ·æ¥ï¼Œä¸»è¦å®Œæˆäº†ä¸‹é¢è¿™äº›ä»»åŠ¡ï¼š</p>
<ol>
<li>åœæ­¢å’Œé”€æ¯ Context å®¹å™¨åŠå…¶æ‰€æœ‰å­å®¹å™¨ï¼Œå­å®¹å™¨å…¶å®å°±æ˜¯ Wrapperï¼Œä¹Ÿå°±æ˜¯è¯´ Wrapper é‡Œé¢ Servlet å®ä¾‹ä¹Ÿè¢«é”€æ¯äº†ã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context å®¹å™¨å…³è”çš„ Listener å’Œ Filterã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context ä¸‹çš„ Pipeline å’Œå„ç§ Valveã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context çš„ç±»åŠ è½½å™¨ï¼Œä»¥åŠç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ–‡ä»¶èµ„æºã€‚</li>
<li>å¯åŠ¨ Context å®¹å™¨ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šé‡æ–°åˆ›å»ºå‰é¢å››æ­¥è¢«é”€æ¯çš„èµ„æºã€‚</li>
</ol>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç±»åŠ è½½å™¨å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚ä¸€ä¸ª Context å®¹å™¨å¯¹åº”ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œç±»åŠ è½½å™¨åœ¨é”€æ¯çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒåŠ è½½çš„æ‰€æœ‰ç±»ä¹Ÿå…¨éƒ¨é”€æ¯ã€‚Context å®¹å™¨åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨æ¥åŠ è½½æ–°çš„ç±»æ–‡ä»¶ã€‚</p>
<p>åœ¨ Context çš„ reload æ–¹æ³•é‡Œï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ Session ç®¡ç†å™¨çš„ distroy æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª Context å…³è”çš„ Session æ˜¯æ²¡æœ‰é”€æ¯çš„ã€‚ä½ è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTomcat çš„çƒ­åŠ è½½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½ éœ€è¦åœ¨ conf ç›®å½•ä¸‹çš„ Context.xml æ–‡ä»¶ä¸­è®¾ç½® reloadable å‚æ•°æ¥å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context <span class="attribute">reloadable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Tomcat-çƒ­éƒ¨ç½²"><a href="#Tomcat-çƒ­éƒ¨ç½²" class="headerlink" title="Tomcat çƒ­éƒ¨ç½²"></a>Tomcat çƒ­éƒ¨ç½²</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹çƒ­éƒ¨ç½²ï¼Œçƒ­éƒ¨ç½²è·Ÿçƒ­åŠ è½½çš„æœ¬è´¨åŒºåˆ«æ˜¯ï¼Œçƒ­éƒ¨ç½²ä¼šé‡æ–°éƒ¨ç½² Web åº”ç”¨ï¼ŒåŸæ¥çš„ Context å¯¹è±¡ä¼šæ•´ä¸ªè¢«é”€æ¯æ‰ï¼Œå› æ­¤è¿™ä¸ª Context æ‰€å…³è”çš„ä¸€åˆ‡èµ„æºéƒ½ä¼šè¢«é”€æ¯ï¼ŒåŒ…æ‹¬ Sessionã€‚</p>
<p>é‚£ä¹ˆ Tomcat çƒ­éƒ¨ç½²åˆæ˜¯ç”±å“ªä¸ªå®¹å™¨æ¥å®ç°çš„å‘¢ï¼Ÿåº”è¯¥ä¸æ˜¯ç”± Contextï¼Œå› ä¸ºçƒ­éƒ¨ç½²è¿‡ç¨‹ä¸­ Context å®¹å™¨è¢«é”€æ¯äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé‡æ‹…å°±è½åœ¨ Host èº«ä¸Šäº†ï¼Œå› ä¸ºå®ƒæ˜¯ Context çš„çˆ¶å®¹å™¨ã€‚</p>
<p>è·Ÿ Context ä¸ä¸€æ ·ï¼ŒHost å®¹å™¨å¹¶æ²¡æœ‰åœ¨ backgroundProcess æ–¹æ³•ä¸­å®ç°å‘¨æœŸæ€§æ£€æµ‹çš„ä»»åŠ¡ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬å™¨ HostConfig æ¥å®ç°çš„ï¼ŒHostConfig å°±æ˜¯å‰é¢æåˆ°çš„â€œå‘¨æœŸäº‹ä»¶â€çš„ç›‘å¬å™¨ï¼Œé‚£â€œå‘¨æœŸäº‹ä»¶â€è¾¾åˆ°æ—¶ï¼ŒHostConfig ä¼šåšä»€ä¹ˆäº‹å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ check æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">        check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒæ‰§è¡Œäº† check æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ check æ–¹æ³•é‡Œåšäº†ä»€ä¹ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">check</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.getAutoDeploy()) &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è¿™ä¸ª Host ä¸‹æ‰€æœ‰å·²ç»éƒ¨ç½²çš„ Web åº”ç”¨</span></span><br><span class="line">        DeployedApplication[] apps =</span><br><span class="line">            deployed.values().toArray(<span class="keyword">new</span> <span class="title class_">DeployedApplication</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; apps.length; i++) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ Web åº”ç”¨ç›®å½•æ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">            checkResources(apps[i], <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œéƒ¨ç½²</span></span><br><span class="line">        deployApps();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å® HostConfig ä¼šæ£€æŸ¥ webapps ç›®å½•ä¸‹çš„æ‰€æœ‰ Web åº”ç”¨ï¼š</p>
<ul>
<li>å¦‚æœåŸæ¥ Web åº”ç”¨ç›®å½•è¢«åˆ æ‰äº†ï¼Œå°±æŠŠç›¸åº” Context å®¹å™¨æ•´ä¸ªé”€æ¯æ‰ã€‚</li>
<li>æ˜¯å¦æœ‰æ–°çš„ Web åº”ç”¨ç›®å½•æ”¾è¿›æ¥äº†ï¼Œæˆ–è€…æœ‰æ–°çš„ WAR åŒ…æ”¾è¿›æ¥äº†ï¼Œå°±éƒ¨ç½²ç›¸åº”çš„ Web åº”ç”¨ã€‚</li>
</ul>
<p>å› æ­¤ HostConfig åšçš„äº‹æƒ…éƒ½æ˜¯æ¯”è¾ƒâ€œå®è§‚â€çš„ï¼Œå®ƒä¸ä¼šå»æ£€æŸ¥å…·ä½“ç±»æ–‡ä»¶æˆ–è€…èµ„æºæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œè€Œæ˜¯æ£€æŸ¥ Web åº”ç”¨ç›®å½•çº§åˆ«çš„å˜åŒ–ã€‚</p>
<h2 id="Tomcat-çš„ç±»åŠ è½½æœºåˆ¶"><a href="#Tomcat-çš„ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="Tomcat çš„ç±»åŠ è½½æœºåˆ¶"></a>Tomcat çš„ç±»åŠ è½½æœºåˆ¶</h2><p>Tomcat çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ <code>WebAppClassLoader</code> æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ƒ<strong>é¦–å…ˆè‡ªå·±å°è¯•å»åŠ è½½æŸä¸ªç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†ä»£ç†ç»™çˆ¶ç±»åŠ è½½å™¨</strong>ï¼Œå…¶ç›®çš„æ˜¯ä¼˜å…ˆåŠ è½½ Web åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ã€‚å…·ä½“å®ç°å°±æ˜¯é‡å†™ ClassLoader çš„ä¸¤ä¸ªæ–¹æ³•ï¼šfindClass å’Œ loadClassã€‚</p>
<h3 id="findClass-æ–¹æ³•"><a href="#findClass-æ–¹æ³•" class="headerlink" title="findClass æ–¹æ³•"></a>findClass æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ findClass æ–¹æ³•çš„å®ç°ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£å’Œé˜…è¯»ï¼Œæˆ‘å»æ‰äº†ä¸€äº›ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. å…ˆåœ¨ Web åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾ç±»</span></span><br><span class="line">            clazz = findClassInternal(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//2. å¦‚æœåœ¨æœ¬åœ°ç›®å½•æ²¡æœ‰æ‰¾åˆ°ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å»æŸ¥æ‰¾</span></span><br><span class="line">            clazz = <span class="built_in">super</span>.findClass(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å¦‚æœçˆ¶ç±»ä¹Ÿæ²¡æ‰¾åˆ°ï¼ŒæŠ›å‡º ClassNotFoundException</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ findClass æ–¹æ³•é‡Œï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å…ˆåœ¨ Web åº”ç”¨æœ¬åœ°ç›®å½•ä¸‹æŸ¥æ‰¾è¦åŠ è½½çš„ç±»ã€‚</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å»æŸ¥æ‰¾ï¼Œå®ƒçš„çˆ¶åŠ è½½å™¨å°±æ˜¯ä¸Šé¢æåˆ°çš„ç³»ç»Ÿç±»åŠ è½½å™¨ AppClassLoaderã€‚</li>
<li>å¦‚ä½•çˆ¶åŠ è½½å™¨ä¹Ÿæ²¡æ‰¾åˆ°è¿™ä¸ªç±»ï¼ŒæŠ›å‡º ClassNotFound å¼‚å¸¸ã€‚</li>
</ol>
<h3 id="loadClass-æ–¹æ³•"><a href="#loadClass-æ–¹æ³•" class="headerlink" title="loadClass æ–¹æ³•"></a>loadClass æ–¹æ³•</h3><p>æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ Tomcat ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•çš„å®ç°ï¼ŒåŒæ ·æˆ‘ä¹Ÿå»æ‰äº†ä¸€äº›ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. å…ˆåœ¨æœ¬åœ° cache æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡</span></span><br><span class="line">        clazz = findLoadedClass0(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. ä»ç³»ç»Ÿç±»åŠ è½½å™¨çš„ cache ä¸­æŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡</span></span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å°è¯•ç”¨ ExtClassLoader ç±»åŠ è½½å™¨ç±»åŠ è½½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">javaseLoader</span> <span class="operator">=</span> getJavaseClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = javaseLoader.loadClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. å°è¯•åœ¨æœ¬åœ°ç›®å½•æœç´¢ class å¹¶åŠ è½½</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. å°è¯•ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ (ä¹Ÿå°±æ˜¯ AppClassLoader) æ¥åŠ è½½</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(name, <span class="literal">false</span>, parent);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resolve)</span><br><span class="line">                        resolveClass(clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. ä¸Šè¿°è¿‡ç¨‹éƒ½åŠ è½½å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadClass æ–¹æ³•ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä¸»è¦æœ‰å…­ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å…ˆåœ¨æœ¬åœ° Cache æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œä¹Ÿå°±æ˜¯è¯´ Tomcat çš„ç±»åŠ è½½å™¨æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚</li>
<li>å¦‚æœ Tomcat ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œå†çœ‹çœ‹ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯å¦åŠ è½½è¿‡ã€‚</li>
<li>å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±è®©<strong>ExtClassLoader</strong>å»åŠ è½½ï¼Œè¿™ä¸€æ­¥æ¯”è¾ƒå…³é”®ï¼Œç›®çš„<strong>é˜²æ­¢ Web åº”ç”¨è‡ªå·±çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»</strong>ã€‚å› ä¸º Tomcat éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå‡å¦‚ Web åº”ç”¨é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªå« Object çš„ç±»ï¼Œå¦‚æœå…ˆåŠ è½½è¿™ä¸ª Object ç±»ï¼Œå°±ä¼šè¦†ç›– JRE é‡Œé¢çš„é‚£ä¸ª Object ç±»ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Tomcat çš„ç±»åŠ è½½å™¨ä¼šä¼˜å…ˆå°è¯•ç”¨ ExtClassLoader å»åŠ è½½ï¼Œå› ä¸º ExtClassLoader ä¼šå§”æ‰˜ç»™ BootstrapClassLoader å»åŠ è½½ï¼ŒBootstrapClassLoader å‘ç°è‡ªå·±å·²ç»åŠ è½½äº† Object ç±»ï¼Œç›´æ¥è¿”å›ç»™ Tomcat çš„ç±»åŠ è½½å™¨ï¼Œè¿™æ · Tomcat çš„ç±»åŠ è½½å™¨å°±ä¸ä¼šå»åŠ è½½ Web åº”ç”¨ä¸‹çš„ Object ç±»äº†ï¼Œä¹Ÿå°±é¿å…äº†è¦†ç›– JRE æ ¸å¿ƒç±»çš„é—®é¢˜ã€‚</li>
<li>å¦‚æœ ExtClassLoader åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¯´ JRE æ ¸å¿ƒç±»ä¸­æ²¡æœ‰è¿™ç±»ï¼Œé‚£ä¹ˆå°±åœ¨æœ¬åœ° Web åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾å¹¶åŠ è½½ã€‚</li>
<li>å¦‚æœæœ¬åœ°ç›®å½•ä¸‹æ²¡æœ‰è¿™ä¸ªç±»ï¼Œè¯´æ˜ä¸æ˜¯ Web åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ï¼Œé‚£ä¹ˆç”±ç³»ç»Ÿç±»åŠ è½½å™¨å»åŠ è½½ã€‚è¿™é‡Œè¯·ä½ æ³¨æ„ï¼ŒWeb åº”ç”¨æ˜¯é€šè¿‡<code>Class.forName</code>è°ƒç”¨äº¤ç»™ç³»ç»Ÿç±»åŠ è½½å™¨çš„ï¼Œå› ä¸º<code>Class.forName</code>çš„é»˜è®¤åŠ è½½å™¨å°±æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</li>
<li>å¦‚æœä¸Šè¿°åŠ è½½è¿‡ç¨‹å…¨éƒ¨å¤±è´¥ï¼ŒæŠ›å‡º ClassNotFound å¼‚å¸¸ã€‚</li>
</ol>
<p>ä»ä¸Šé¢çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTomcat çš„ç±»åŠ è½½å™¨æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œæ²¡æœ‰ä¸€ä¸Šæ¥å°±ç›´æ¥å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨ï¼Œè€Œæ˜¯å…ˆåœ¨æœ¬åœ°ç›®å½•ä¸‹åŠ è½½ï¼Œä¸ºäº†é¿å…æœ¬åœ°ç›®å½•ä¸‹çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»ï¼Œå…ˆå°è¯•ç”¨ JVM æ‰©å±•ç±»åŠ è½½å™¨ ExtClassLoader å»åŠ è½½ã€‚é‚£ä¸ºä»€ä¹ˆä¸å…ˆç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ AppClassLoader å»åŠ è½½ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å°±å˜æˆåŒäº²å§”æ´¾æœºåˆ¶äº†ï¼Œè¿™å°±æ˜¯ Tomcat ç±»åŠ è½½å™¨çš„å·§å¦™ä¹‹å¤„ã€‚</p>
<h3 id="Tomcat-å®ç°åº”ç”¨éš”ç¦»"><a href="#Tomcat-å®ç°åº”ç”¨éš”ç¦»" class="headerlink" title="Tomcat å®ç°åº”ç”¨éš”ç¦»"></a>Tomcat å®ç°åº”ç”¨éš”ç¦»</h3><p>Tomcat ä½œä¸º Web å®¹å™¨ï¼Œéœ€è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœåœ¨ Tomcat ä¸­è¿è¡Œäº†ä¸¤ä¸ª Web åº”ç”¨ç¨‹åºï¼Œä¸¤ä¸ª Web åº”ç”¨ä¸­æœ‰åŒåçš„ Servletï¼Œä½†æ˜¯åŠŸèƒ½ä¸åŒï¼ŒTomcat éœ€è¦åŒæ—¶åŠ è½½å’Œç®¡ç†è¿™ä¸¤ä¸ªåŒåçš„ Servlet ç±»ï¼Œä¿è¯å®ƒä»¬ä¸ä¼šå†²çªï¼Œå› æ­¤ Web åº”ç”¨ä¹‹é—´çš„ç±»éœ€è¦éš”ç¦»ã€‚</li>
<li>ä¸¤ä¸ª Web åº”ç”¨éƒ½ä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ JAR åŒ…ï¼Œæ¯”å¦‚ Springï¼Œé‚£ Spring çš„ JAR åŒ…è¢«åŠ è½½åˆ°å†…å­˜åï¼ŒTomcat è¦ä¿è¯è¿™ä¸¤ä¸ª Web åº”ç”¨èƒ½å¤Ÿå…±äº«ï¼Œä¹Ÿå°±æ˜¯è¯´ Spring çš„ JAR åŒ…åªè¢«åŠ è½½ä¸€æ¬¡ï¼Œå¦åˆ™éšç€ä¾èµ–çš„ç¬¬ä¸‰æ–¹ JAR åŒ…å¢å¤šï¼ŒJVM çš„å†…å­˜ä¼šè†¨èƒ€ã€‚</li>
<li>éœ€è¦éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201130141536.png" alt="img"></p>
<h4 id="WebAppClassLoader"><a href="#WebAppClassLoader" class="headerlink" title="WebAppClassLoader"></a>WebAppClassLoader</h4><p>é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>å¦‚æœä½¿ç”¨ JVM é»˜è®¤ AppClassLoader æ¥åŠ è½½ Web åº”ç”¨ï¼ŒAppClassLoader åªèƒ½åŠ è½½ä¸€ä¸ª Servlet ç±»ï¼Œåœ¨åŠ è½½ç¬¬äºŒä¸ªåŒå Servlet ç±»æ—¶ï¼ŒAppClassLoader ä¼šè¿”å›ç¬¬ä¸€ä¸ª Servlet ç±»çš„ Class å®ä¾‹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ AppClassLoader çœ‹æ¥ï¼ŒåŒåçš„ Servlet ç±»åªè¢«åŠ è½½ä¸€æ¬¡ã€‚</p>
<p>Tomcat çš„è§£å†³æ–¹æ¡ˆæ˜¯è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ WebAppClassLoaderï¼Œ å¹¶ä¸”ç»™æ¯ä¸ª Web åº”ç”¨åˆ›å»ºä¸€ä¸ªç±»åŠ è½½å™¨å®ä¾‹ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒContext å®¹å™¨ç»„ä»¶å¯¹åº”ä¸€ä¸ª Web åº”ç”¨ï¼Œå› æ­¤ï¼Œæ¯ä¸ª Context å®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç»´æŠ¤ä¸€ä¸ª WebAppClassLoader åŠ è½½å™¨å®ä¾‹ã€‚è¿™èƒŒåçš„åŸç†æ˜¯ï¼Œ<strong>ä¸åŒçš„åŠ è½½å™¨å®ä¾‹åŠ è½½çš„ç±»è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ç±»</strong>ï¼Œå³ä½¿å®ƒä»¬çš„ç±»åç›¸åŒã€‚è¿™å°±ç›¸å½“äºåœ¨ Java è™šæ‹Ÿæœºå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä¸ªç›¸äº’éš”ç¦»çš„ Java ç±»ç©ºé—´ï¼Œæ¯ä¸€ä¸ª Web åº”ç”¨éƒ½æœ‰è‡ªå·±çš„ç±»ç©ºé—´ï¼ŒWeb åº”ç”¨ä¹‹é—´é€šè¿‡å„è‡ªçš„ç±»åŠ è½½å™¨äº’ç›¸éš”ç¦»ã€‚</p>
<h4 id="SharedClassLoader"><a href="#SharedClassLoader" class="headerlink" title="SharedClassLoader"></a>SharedClassLoader</h4><p>é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼š</p>
<p>æœ¬è´¨éœ€æ±‚æ˜¯ä¸¤ä¸ª Web åº”ç”¨ä¹‹é—´æ€ä¹ˆå…±äº«åº“ç±»ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤åŠ è½½ç›¸åŒçš„ç±»ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åŒäº²å§”æ´¾æœºåˆ¶é‡Œï¼Œå„ä¸ªå­åŠ è½½å™¨éƒ½å¯ä»¥é€šè¿‡çˆ¶åŠ è½½å™¨å»åŠ è½½ç±»ï¼Œé‚£ä¹ˆæŠŠéœ€è¦å…±äº«çš„ç±»æ”¾åˆ°çˆ¶åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ä¸‹ä¸å°±è¡Œäº†å—ï¼Œåº”ç”¨ç¨‹åºä¹Ÿæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å…±äº« JRE çš„æ ¸å¿ƒç±»ã€‚å› æ­¤ Tomcat çš„è®¾è®¡è€…åˆåŠ äº†ä¸€ä¸ªç±»åŠ è½½å™¨ SharedClassLoaderï¼Œä½œä¸º WebAppClassLoader çš„çˆ¶åŠ è½½å™¨ï¼Œä¸“é—¨æ¥åŠ è½½ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ç±»ã€‚å¦‚æœ WebAppClassLoader è‡ªå·±æ²¡æœ‰åŠ è½½åˆ°æŸä¸ªç±»ï¼Œå°±ä¼šå§”æ‰˜çˆ¶åŠ è½½å™¨ SharedClassLoader å»åŠ è½½è¿™ä¸ªç±»ï¼ŒSharedClassLoader ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åŠ è½½å…±äº«ç±»ï¼Œä¹‹åè¿”å›ç»™ WebAppClassLoaderï¼Œè¿™æ ·å…±äº«çš„é—®é¢˜å°±è§£å†³äº†ã€‚</p>
<h4 id="CatalinaClassloader"><a href="#CatalinaClassloader" class="headerlink" title="CatalinaClassloader"></a>CatalinaClassloader</h4><p>å¦‚ä½•éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ï¼Ÿ</p>
<p>è¦å…±äº«å¯ä»¥é€šè¿‡çˆ¶å­å…³ç³»ï¼Œè¦éš”ç¦»é‚£å°±éœ€è¦å…„å¼Ÿå…³ç³»äº†ã€‚å…„å¼Ÿå…³ç³»å°±æ˜¯æŒ‡ä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯å¹³è¡Œçš„ï¼Œå®ƒä»¬å¯èƒ½æ‹¥æœ‰åŒä¸€ä¸ªçˆ¶åŠ è½½å™¨ï¼Œä½†æ˜¯ä¸¤ä¸ªå…„å¼Ÿç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯éš”ç¦»çš„ã€‚åŸºäºæ­¤ Tomcat åˆè®¾è®¡ä¸€ä¸ªç±»åŠ è½½å™¨ CatalinaClassloaderï¼Œä¸“é—¨æ¥åŠ è½½ Tomcat è‡ªèº«çš„ç±»ã€‚è¿™æ ·è®¾è®¡æœ‰ä¸ªé—®é¢˜ï¼Œé‚£ Tomcat å’Œå„ Web åº”ç”¨ä¹‹é—´éœ€è¦å…±äº«ä¸€äº›ç±»æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h4 id="CommonClassLoader"><a href="#CommonClassLoader" class="headerlink" title="CommonClassLoader"></a>CommonClassLoader</h4><p>è€åŠæ³•ï¼Œè¿˜æ˜¯å†å¢åŠ ä¸€ä¸ª CommonClassLoaderï¼Œä½œä¸º CatalinaClassloader å’Œ SharedClassLoader çš„çˆ¶åŠ è½½å™¨ã€‚CommonClassLoader èƒ½åŠ è½½çš„ç±»éƒ½å¯ä»¥è¢« CatalinaClassLoader å’Œ SharedClassLoader ä½¿ç”¨ï¼Œè€Œ CatalinaClassLoader å’Œ SharedClassLoader èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚WebAppClassLoader å¯ä»¥ä½¿ç”¨ SharedClassLoader åŠ è½½åˆ°çš„ç±»ï¼Œä½†å„ä¸ª WebAppClassLoader å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»ã€‚</p>
<h2 id="Tomcat-å®ç°-Servlet-è§„èŒƒ"><a href="#Tomcat-å®ç°-Servlet-è§„èŒƒ" class="headerlink" title="Tomcat å®ç° Servlet è§„èŒƒ"></a>Tomcat å®ç° Servlet è§„èŒƒ</h2><p>Servlet å®¹å™¨æœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯åˆ›å»º Servlet çš„å®ä¾‹å¹¶ä¸”è°ƒç”¨ Servletã€‚</p>
<p>ä¸€ä¸ª Web åº”ç”¨é‡Œå¾€å¾€æœ‰å¤šä¸ª Servletï¼Œè€Œåœ¨ Tomcat ä¸­ä¸€ä¸ª Web åº”ç”¨å¯¹åº”ä¸€ä¸ª Context å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª Context å®¹å™¨éœ€è¦ç®¡ç†å¤šä¸ª Servlet å®ä¾‹ã€‚ä½† Context å®¹å™¨å¹¶ä¸ç›´æ¥æŒæœ‰ Servlet å®ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡å­å®¹å™¨ Wrapper æ¥ç®¡ç† Servletï¼Œä½ å¯ä»¥æŠŠ Wrapper å®¹å™¨çœ‹ä½œæ˜¯ Servlet çš„åŒ…è£…ã€‚</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ Wrapper å‘¢ï¼ŸContext å®¹å™¨ç›´æ¥ç»´æŠ¤ä¸€ä¸ª Servlet æ•°ç»„ä¸å°±è¡Œäº†å—ï¼Ÿè¿™æ˜¯å› ä¸º Servlet ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç±»å®ä¾‹ï¼Œå®ƒè¿˜æœ‰ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„ URL æ˜ å°„ã€å®ƒçš„åˆå§‹åŒ–å‚æ•°ï¼Œå› æ­¤è®¾è®¡å‡ºäº†ä¸€ä¸ªåŒ…è£…å™¨ï¼ŒæŠŠ Servlet æœ¬èº«å’Œå®ƒç›¸å…³çš„æ•°æ®åŒ…èµ·æ¥ï¼Œæ²¡é”™ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡çš„æ€æƒ³ã€‚</p>
<p>é™¤æ­¤ä»¥å¤–ï¼ŒServlet è§„èŒƒä¸­è¿˜æœ‰ä¸¤ä¸ªé‡è¦ç‰¹æ€§ï¼šListener å’Œ Filterï¼ŒTomcat ä¹Ÿéœ€è¦åˆ›å»ºå®ƒä»¬çš„å®ä¾‹ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºå»è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•ã€‚</p>
<h3 id="Servlet-ç®¡ç†"><a href="#Servlet-ç®¡ç†" class="headerlink" title="Servlet ç®¡ç†"></a>Servlet ç®¡ç†</h3><p>Tomcat æ˜¯ç”¨ Wrapper å®¹å™¨æ¥ç®¡ç† Servlet çš„ï¼Œé‚£ Wrapper å®¹å™¨å…·ä½“é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒé‡Œé¢æœ‰å“ªäº›å…³é”®çš„æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">Servlet</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>å®ƒæ‹¥æœ‰ä¸€ä¸ª Servlet å®ä¾‹ï¼Œå¹¶ä¸” Wrapper é€šè¿‡ loadServlet æ–¹æ³•æ¥å®ä¾‹åŒ– Servletã€‚ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Servlet <span class="title function_">loadServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    Servlet servlet;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. åˆ›å»ºä¸€ä¸ª Servlet å®ä¾‹</span></span><br><span class="line">    servlet = (Servlet) instanceManager.newInstance(servletClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. è°ƒç”¨äº† Servlet çš„ init æ–¹æ³•ï¼Œè¿™æ˜¯ Servlet è§„èŒƒè¦æ±‚çš„</span></span><br><span class="line">    initServlet(servlet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> servlet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å® loadServlet ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šåˆ›å»º Servlet çš„å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨ Servlet çš„ init æ–¹æ³•ï¼Œå› ä¸ºè¿™æ˜¯ Servlet è§„èŒƒè¦æ±‚çš„ã€‚</p>
<p>é‚£æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œä»€ä¹ˆæ—¶å€™ä¼šè°ƒåˆ°è¿™ä¸ª loadServlet æ–¹æ³•å‘¢ï¼Ÿä¸ºäº†åŠ å¿«ç³»ç»Ÿçš„å¯åŠ¨é€Ÿåº¦ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡‡å–èµ„æºå»¶è¿ŸåŠ è½½çš„ç­–ç•¥ï¼ŒTomcat ä¹Ÿä¸ä¾‹å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ Tomcat åœ¨å¯åŠ¨æ—¶ä¸ä¼šåŠ è½½ä½ çš„ Servletï¼Œé™¤éä½ æŠŠ Servlet çš„<code>loadOnStartup</code>å‚æ•°è®¾ç½®ä¸º<code>true</code>ã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ Tomcat åœ¨å¯åŠ¨æ—¶ä¸ä¼šåˆ›å»º Servlet å®ä¾‹ï¼Œä½†æ˜¯ä¼šåˆ›å»º Wrapper å®¹å™¨ï¼Œå°±å¥½æ¯”å°½ç®¡æªé‡Œé¢è¿˜æ²¡æœ‰å­å¼¹ï¼Œå…ˆæŠŠæªé€ å‡ºæ¥ã€‚é‚£å­å¼¹ä»€ä¹ˆæ—¶å€™é€ å‘¢ï¼Ÿæ˜¯çœŸæ­£éœ€è¦å¼€æªçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è¯·æ±‚æ¥è®¿é—®æŸä¸ª Servlet æ—¶ï¼Œè¿™ä¸ª Servlet çš„å®ä¾‹æ‰ä¼šè¢«åˆ›å»ºã€‚</p>
<p>é‚£ Servlet æ˜¯è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹ä¸“æ å‰é¢æåˆ°è¿‡ Tomcat çš„ Pipeline-Valve æœºåˆ¶ï¼Œæ¯ä¸ªå®¹å™¨ç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ Pipelineï¼Œæ¯ä¸ª Pipeline ä¸­æœ‰ä¸€ä¸ª Valve é“¾ï¼Œå¹¶ä¸”æ¯ä¸ªå®¹å™¨ç»„ä»¶æœ‰ä¸€ä¸ª BasicValveï¼ˆåŸºç¡€é˜€ï¼‰ã€‚Wrapper ä½œä¸ºä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå®ƒä¹Ÿæœ‰è‡ªå·±çš„ Pipeline å’Œ BasicValveï¼ŒWrapper çš„ BasicValve å« <strong>StandardWrapperValve</strong>ã€‚</p>
<p>ä½ å¯ä»¥æƒ³åˆ°ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒContext å®¹å™¨çš„ BasicValve ä¼šè°ƒç”¨ Wrapper å®¹å™¨ä¸­ Pipeline ä¸­çš„ç¬¬ä¸€ä¸ª Valveï¼Œç„¶åä¼šè°ƒç”¨åˆ° StandardWrapperValveã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„ invoke æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒåŒæ ·ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. å®ä¾‹åŒ– Servlet</span></span><br><span class="line">    servlet = wrapper.allocate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. ç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾</span></span><br><span class="line">    <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span></span><br><span class="line">        ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. è°ƒç”¨è¿™ä¸ª Filter é“¾ï¼ŒFilter é“¾ä¸­çš„æœ€åä¸€ä¸ª Filter ä¼šè°ƒç”¨ Servlet</span></span><br><span class="line">   filterChain.doFilter(request.getRequest(), response.getResponse());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StandardWrapperValve çš„ invoke æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œå»æ‰å…¶ä»–å¼‚å¸¸å¤„ç†çš„ä¸€äº›ç»†èŠ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸‰æ­¥ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º Servlet å®ä¾‹ï¼›</li>
<li>ç¬¬äºŒæ­¥ï¼Œç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾ï¼›</li>
<li>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨è¿™ä¸ª Filter é“¾ã€‚</li>
</ul>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆéœ€è¦ç»™æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾ï¼Ÿè¿™æ˜¯å› ä¸ºæ¯ä¸ªè¯·æ±‚çš„è¯·æ±‚è·¯å¾„éƒ½ä¸ä¸€æ ·ï¼Œè€Œ Filter éƒ½æœ‰ç›¸åº”çš„è·¯å¾„æ˜ å°„ï¼Œå› æ­¤ä¸æ˜¯æ‰€æœ‰çš„ Filter éƒ½éœ€è¦æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚çš„è·¯å¾„æ¥é€‰æ‹©ç‰¹å®šçš„ä¸€äº› Filter æ¥å¤„ç†ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰çœ‹åˆ°è°ƒåˆ° Servlet çš„ service æ–¹æ³•ï¼Ÿè¿™æ˜¯å› ä¸º Filter é“¾çš„ doFilter æ–¹æ³•ä¼šè´Ÿè´£è°ƒç”¨ Servletï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ Filter é“¾ä¸­çš„æœ€åä¸€ä¸ª Filter ä¼šè´Ÿè´£è°ƒç”¨ Servletã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ Filter çš„å®ç°åŸç†ã€‚</p>
<h3 id="Filter-ç®¡ç†"><a href="#Filter-ç®¡ç†" class="headerlink" title="Filter ç®¡ç†"></a>Filter ç®¡ç†</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œè·Ÿ Servlet ä¸€æ ·ï¼ŒFilter ä¹Ÿå¯ä»¥åœ¨<code>web.xml</code>æ–‡ä»¶é‡Œè¿›è¡Œé…ç½®ï¼Œä¸åŒçš„æ˜¯ï¼ŒFilter çš„ä½œç”¨åŸŸæ˜¯æ•´ä¸ª Web åº”ç”¨ï¼Œå› æ­¤ Filter çš„å®ä¾‹æ˜¯åœ¨ Context å®¹å™¨ä¸­è¿›è¡Œç®¡ç†çš„ï¼ŒContext å®¹å™¨ç”¨ Map é›†åˆæ¥ä¿å­˜ Filterã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, FilterDef&gt; filterDefs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>é‚£ä¸Šé¢æåˆ°çš„ Filter é“¾åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸFilter é“¾çš„å­˜æ´»æœŸå¾ˆçŸ­ï¼Œå®ƒæ˜¯è·Ÿæ¯ä¸ªè¯·æ±‚å¯¹åº”çš„ã€‚ä¸€ä¸ªæ–°çš„è¯·æ±‚æ¥äº†ï¼Œå°±åŠ¨æ€åˆ›å»ºä¸€ä¸ª FIlter é“¾ï¼Œè¯·æ±‚å¤„ç†å®Œäº†ï¼ŒFilter é“¾ä¹Ÿå°±è¢«å›æ”¶äº†ã€‚ç†è§£å®ƒçš„åŸç†ä¹Ÿéå¸¸å…³é”®ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Filter é“¾ä¸­æœ‰ Filter æ•°ç»„ï¼Œè¿™ä¸ªå¥½ç†è§£</span></span><br><span class="line">  <span class="keyword">private</span> ApplicationFilterConfig[] filters = <span class="keyword">new</span> <span class="title class_">ApplicationFilterConfig</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Filter é“¾ä¸­çš„å½“å‰çš„è°ƒç”¨ä½ç½®</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ€»å…±æœ‰å¤šå°‘äº† Filter</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯ä¸ª Filter é“¾å¯¹åº”ä¸€ä¸ª Servletï¼Œä¹Ÿå°±æ˜¯å®ƒè¦è°ƒç”¨çš„ Servlet</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res)</span> &#123;</span><br><span class="line">        internalDoFilter(request,response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest req,</span></span><br><span class="line"><span class="params">                                ServletResponse res)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ª Filter é“¾åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Filter æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> filters[pos++];</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line"></span><br><span class="line">        filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    servlet.service(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä» ApplicationFilterChain çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š</p>
<ul>
<li>Filter é“¾ä¸­é™¤äº†æœ‰ Filter å¯¹è±¡çš„æ•°ç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•´æ•°å˜é‡ posï¼Œè¿™ä¸ªå˜é‡ç”¨æ¥è®°å½•å½“å‰è¢«è°ƒç”¨çš„ Filter åœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚</li>
<li>Filter é“¾ä¸­æœ‰ä¸ª Servlet å®ä¾‹ï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œå› ä¸ºä¸Šé¢æåˆ°äº†ï¼Œæ¯ä¸ª Filter é“¾æœ€åéƒ½ä¼šè°ƒåˆ°ä¸€ä¸ª Servletã€‚</li>
<li>Filter é“¾æœ¬èº«ä¹Ÿå®ç°äº† doFilter æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªå†…éƒ¨æ–¹æ³• internalDoFilterã€‚</li>
<li>internalDoFilter æ–¹æ³•çš„å®ç°æ¯”è¾ƒæœ‰æ„æ€ï¼Œå®ƒåšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå½“å‰ Filter çš„ä½ç½®å°äº Filter æ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ Filter è¿˜æ²¡è°ƒå®Œï¼Œå°±ä» Filter æ•°ç»„æ‹¿ä¸‹ä¸€ä¸ª Filterï¼Œè°ƒç”¨å®ƒçš„ doFilter æ–¹æ³•ã€‚å¦åˆ™ï¼Œæ„å‘³ç€æ‰€æœ‰ Filter éƒ½è°ƒåˆ°äº†ï¼Œå°±è°ƒç”¨ Servlet çš„ service æ–¹æ³•ã€‚</li>
</ul>
<p>ä½†é—®é¢˜æ˜¯ï¼Œæ–¹æ³•ä½“é‡Œæ²¡çœ‹åˆ°å¾ªç¯ï¼Œè°åœ¨ä¸åœåœ°è°ƒç”¨ Filter é“¾çš„ doFIlter æ–¹æ³•å‘¢ï¼ŸFilter æ˜¯æ€ä¹ˆä¾æ¬¡è°ƒåˆ°çš„å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯<strong>Filter æœ¬èº«çš„ doFilter æ–¹æ³•ä¼šè°ƒç”¨ Filter é“¾çš„ doFilter æ–¹æ³•</strong>ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ä»£ç å°±æ˜ç™½äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">        FilterChain chain)</span>&#123;</span><br><span class="line"></span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line">          <span class="comment">// è°ƒç”¨ Filter çš„æ–¹æ³•</span></span><br><span class="line">          chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ Filter çš„ doFilter æ–¹æ³•æœ‰ä¸ªå…³é”®å‚æ•° FilterChainï¼Œå°±æ˜¯ Filter é“¾ã€‚å¹¶ä¸”æ¯ä¸ª Filter åœ¨å®ç° doFilter æ—¶ï¼Œå¿…é¡»è¦è°ƒç”¨ Filter é“¾çš„ doFilter æ–¹æ³•ï¼Œè€Œ Filter é“¾ä¸­ä¿å­˜å½“å‰ FIlter çš„ä½ç½®ï¼Œä¼šè°ƒç”¨ä¸‹ä¸€ä¸ª FIlter çš„ doFilter æ–¹æ³•ï¼Œè¿™æ ·é“¾å¼è°ƒç”¨å°±å®Œæˆäº†ã€‚</p>
<p>Filter é“¾è·Ÿ Tomcat çš„ Pipeline-Valve æœ¬è´¨éƒ½æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°ä¸Šç¨æœ‰ä¸åŒï¼Œä½ å¯ä»¥ç»†ç»†ä½“ä¼šä¸€ä¸‹ã€‚</p>
<h3 id="Listener-ç®¡ç†"><a href="#Listener-ç®¡ç†" class="headerlink" title="Listener ç®¡ç†"></a>Listener ç®¡ç†</h3><p>æˆ‘ä»¬æ¥ç€èŠ Servlet è§„èŒƒé‡Œ Listenerã€‚è·Ÿ Filter ä¸€æ ·ï¼ŒListener ä¹Ÿæ˜¯ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œä½ å¯ä»¥ç›‘å¬å®¹å™¨å†…éƒ¨å‘ç”Ÿçš„äº‹ä»¶ï¼Œä¸»è¦æœ‰ä¸¤ç±»äº‹ä»¶ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç±»æ˜¯ç”Ÿå‘½çŠ¶æ€çš„å˜åŒ–ï¼Œæ¯”å¦‚ Context å®¹å™¨å¯åŠ¨å’Œåœæ­¢ã€Session çš„åˆ›å»ºå’Œé”€æ¯ã€‚</li>
<li>ç¬¬äºŒç±»æ˜¯å±æ€§çš„å˜åŒ–ï¼Œæ¯”å¦‚ Context å®¹å™¨æŸä¸ªå±æ€§å€¼å˜äº†ã€Session çš„æŸä¸ªå±æ€§å€¼å˜äº†ä»¥åŠæ–°çš„è¯·æ±‚æ¥äº†ç­‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥åœ¨<code>web.xml</code>é…ç½®æˆ–è€…é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥æ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨ç›‘å¬å™¨é‡Œå®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚å¯¹äº Tomcat æ¥è¯´ï¼Œå®ƒéœ€è¦è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ‹¿åˆ°ç›‘å¬å™¨ç±»çš„åå­—ï¼Œå®ä¾‹åŒ–è¿™äº›ç±»ï¼Œå¹¶ä¸”åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨è¿™äº›ç›‘å¬å™¨çš„æ–¹æ³•ã€‚</p>
<p>Tomcat æ˜¯é€šè¿‡ Context å®¹å™¨æ¥ç®¡ç†è¿™äº›ç›‘å¬å™¨çš„ã€‚Context å®¹å™¨å°†ä¸¤ç±»äº‹ä»¶åˆ†å¼€æ¥ç®¡ç†ï¼Œåˆ†åˆ«ç”¨ä¸åŒçš„é›†åˆæ¥å­˜æ”¾ä¸åŒç±»å‹äº‹ä»¶çš„ç›‘å¬å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬å±æ€§å€¼å˜åŒ–çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Object&gt; applicationEventListenersList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç”Ÿå‘½äº‹ä»¶çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">private</span> Object applicationLifecycleListenersObjects[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„äº‹æƒ…å°±æ˜¯è§¦å‘ç›‘å¬å™¨äº†ï¼Œæ¯”å¦‚åœ¨ Context å®¹å™¨çš„å¯åŠ¨æ–¹æ³•é‡Œï¼Œå°±è§¦å‘äº†æ‰€æœ‰çš„ ServletContextListenerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. æ‹¿åˆ°æ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨</span></span><br><span class="line">Object instances[] = getApplicationLifecycleListeners();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; instances.length; i++) &#123;</span><br><span class="line">   <span class="comment">//2. åˆ¤æ–­ Listener çš„ç±»å‹æ˜¯ä¸æ˜¯ ServletContextListener</span></span><br><span class="line">   <span class="keyword">if</span> (!(instances[i] <span class="keyword">instanceof</span> ServletContextListener))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. è§¦å‘ Listener çš„æ–¹æ³•</span></span><br><span class="line">   <span class="type">ServletContextListener</span> <span class="variable">lr</span> <span class="operator">=</span> (ServletContextListener) instances[i];</span><br><span class="line">   lr.contextInitialized(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ ServletContextListener æ¥å£æ˜¯ä¸€ç§ç•™ç»™ç”¨æˆ·çš„æ‰©å±•æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥å®ç°è¿™ä¸ªæ¥å£æ¥å®šä¹‰è‡ªå·±çš„ç›‘å¬å™¨ï¼Œç›‘å¬ Context å®¹å™¨çš„å¯åœäº‹ä»¶ã€‚Spring å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚ServletContextListener è·Ÿ Tomcat è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ LifecycleListener æ˜¯ä¸åŒçš„ã€‚LifecycleListener å®šä¹‰åœ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç»„ä»¶ä¸­ï¼Œç”±åŸºç±» LifeCycleBase ç»Ÿä¸€ç®¡ç†ã€‚</p>
<h2 id="Tomcat-æ”¯æŒå¼‚æ­¥-Servlet"><a href="#Tomcat-æ”¯æŒå¼‚æ­¥-Servlet" class="headerlink" title="Tomcat æ”¯æŒå¼‚æ­¥ Servlet"></a>Tomcat æ”¯æŒå¼‚æ­¥ Servlet</h2><h3 id="å¼‚æ­¥ç¤ºä¾‹"><a href="#å¼‚æ­¥ç¤ºä¾‹" class="headerlink" title="å¼‚æ­¥ç¤ºä¾‹"></a>å¼‚æ­¥ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &#123;&quot;/async&quot;&#125;, asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Web åº”ç”¨çº¿ç¨‹æ± ï¼Œç”¨æ¥å¤„ç†å¼‚æ­¥ Servlet</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="comment">//1. è°ƒç”¨ startAsync æˆ–è€…å¼‚æ­¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">AsyncContext</span> <span class="variable">ctx</span> <span class="operator">=</span> req.startAsync();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// ç”¨çº¿ç¨‹æ± æ¥æ‰§è¡Œè€—æ—¶æ“ä½œ</span></span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åœ¨è¿™é‡Œåšè€—æ—¶çš„æ“ä½œ</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ctx.getResponse().getWriter().println(<span class="string">&quot;Handling Async Servlet&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//3. å¼‚æ­¥ Servlet å¤„ç†å®Œäº†è°ƒç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡çš„ complete æ–¹æ³•</span></span><br><span class="line">                ctx.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸‰ä¸ªè¦ç‚¹ï¼š</p>
<ol>
<li>é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥æ³¨å†Œ Servletï¼Œé™¤äº† @WebServlet æ³¨è§£ï¼Œè¿˜éœ€è¦åŠ ä¸Š asyncSupported&#x3D;true çš„å±æ€§ï¼Œè¡¨æ˜å½“å‰çš„ Servlet æ˜¯ä¸€ä¸ªå¼‚æ­¥ Servletã€‚</li>
<li>Web åº”ç”¨ç¨‹åºéœ€è¦è°ƒç”¨ Request å¯¹è±¡çš„ startAsync æ–¹æ³•æ¥æ‹¿åˆ°ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ AsyncContextã€‚è¿™ä¸ªä¸Šä¸‹æ–‡ä¿å­˜äº†è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚</li>
<li>Web åº”ç”¨éœ€è¦å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è€—æ—¶çš„æ“ä½œï¼Œå¤„ç†å®Œæˆåéœ€è¦è°ƒç”¨ AsyncContext çš„ complete æ–¹æ³•ã€‚ç›®çš„æ˜¯å‘Šè¯‰ Tomcatï¼Œè¯·æ±‚å·²ç»å¤„ç†å®Œæˆã€‚</li>
</ol>
<p>è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œè™½ç„¶å¼‚æ­¥ Servlet å…è®¸ç”¨æ›´é•¿çš„æ—¶é—´æ¥å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯ä¹Ÿæœ‰è¶…æ—¶é™åˆ¶çš„ï¼Œé»˜è®¤æ˜¯ 30 ç§’ï¼Œå¦‚æœ 30 ç§’å†…è¯·æ±‚è¿˜æ²¡å¤„ç†å®Œï¼ŒTomcat ä¼šè§¦å‘è¶…æ—¶æœºåˆ¶ï¼Œå‘æµè§ˆå™¨è¿”å›è¶…æ—¶é”™è¯¯ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä½ çš„ Web åº”ç”¨å†è°ƒç”¨<code>ctx.complete</code>æ–¹æ³•ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª IllegalStateException å¼‚å¸¸ã€‚</p>
<h3 id="å¼‚æ­¥-Servlet-åŸç†"><a href="#å¼‚æ­¥-Servlet-åŸç†" class="headerlink" title="å¼‚æ­¥ Servlet åŸç†"></a>å¼‚æ­¥ Servlet åŸç†</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œç›¸ä¿¡ä½ å¯¹ Servlet çš„å¼‚æ­¥å®ç°æœ‰äº†åŸºæœ¬çš„ç†è§£ã€‚è¦ç†è§£ Tomcat åœ¨è¿™ä¸ªè¿‡ç¨‹éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Œå…³é”®å°±æ˜¯è¦å¼„æ¸…æ¥š<code>req.startAsync</code>æ–¹æ³•å’Œ<code>ctx.complete</code>æ–¹æ³•éƒ½åšäº†ä»€ä¹ˆã€‚</p>
<h4 id="startAsync-æ–¹æ³•"><a href="#startAsync-æ–¹æ³•" class="headerlink" title="startAsync æ–¹æ³•"></a>startAsync æ–¹æ³•</h4><p>startAsync æ–¹æ³•å…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ AsyncContext å¯¹è±¡ï¼ŒAsyncContext å¯¹è±¡çš„ä½œç”¨æ˜¯ä¿å­˜è¯·æ±‚çš„ä¸­é—´ä¿¡æ¯ï¼Œæ¯”å¦‚ Request å’Œ Response å¯¹è±¡ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä½ æ¥æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ä¿å­˜è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸º Tomcat çš„å·¥ä½œçº¿ç¨‹åœ¨<code>Request.startAsync</code>è°ƒç”¨ä¹‹åï¼Œå°±ç›´æ¥ç»“æŸå›åˆ°çº¿ç¨‹æ± ä¸­äº†ï¼Œçº¿ç¨‹æœ¬èº«ä¸ä¼šä¿å­˜ä»»ä½•ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼Œæ‰§è¡Œåˆ°ä¸€åŠï¼Œä½ çš„ Web åº”ç”¨æ­£åœ¨å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ Tomcat çš„å·¥ä½œçº¿ç¨‹æ²¡äº†ï¼Œè¿™å°±éœ€è¦æœ‰ä¸ªç¼“å­˜èƒ½å¤Ÿä¿å­˜åŸå§‹çš„ Request å’Œ Response å¯¹è±¡ï¼Œè€Œè¿™ä¸ªç¼“å­˜å°±æ˜¯ AsyncContextã€‚</p>
<p>æœ‰äº† AsyncContextï¼Œä½ çš„ Web åº”ç”¨é€šè¿‡å®ƒæ‹¿åˆ° request å’Œ response å¯¹è±¡ï¼Œæ‹¿åˆ° Request å¯¹è±¡åå°±å¯ä»¥è¯»å–è¯·æ±‚ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œäº†è¿˜éœ€è¦é€šè¿‡ Response å¯¹è±¡å°† HTTP å“åº”å‘é€ç»™æµè§ˆå™¨ã€‚</p>
<p>é™¤äº†åˆ›å»º AsyncContext å¯¹è±¡ï¼ŒstartAsync è¿˜éœ€è¦å®Œæˆä¸€ä¸ªå…³é”®ä»»åŠ¡ï¼Œé‚£å°±æ˜¯å‘Šè¯‰ Tomcat å½“å‰çš„ Servlet å¤„ç†æ–¹æ³•è¿”å›æ—¶ï¼Œä¸è¦æŠŠå“åº”å‘åˆ°æµè§ˆå™¨ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ï¼Œå“åº”è¿˜æ²¡ç”Ÿæˆå‘¢ï¼›å¹¶ä¸”ä¸èƒ½æŠŠ Request å¯¹è±¡å’Œ Response å¯¹è±¡é”€æ¯ï¼Œå› ä¸ºåé¢ Web åº”ç”¨è¿˜è¦ç”¨å‘¢ã€‚</p>
<p>åœ¨ Tomcat ä¸­ï¼Œè´Ÿè´£ flush å“åº”æ•°æ®çš„æ˜¯ CoyoteAdaptorï¼Œå®ƒè¿˜ä¼šé”€æ¯ Request å¯¹è±¡å’Œ Response å¯¹è±¡ï¼Œå› æ­¤éœ€è¦é€šè¿‡æŸç§æœºåˆ¶é€šçŸ¥ CoyoteAdaptorï¼Œå…·ä½“æ¥è¯´æ˜¯é€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.request.getCoyoteRequest().action(ActionCode.ASYNC_START, <span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ª Callbackï¼Œåœ¨è¿™ä¸ª action æ–¹æ³•é‡Œè®¾ç½®äº† Request å¯¹è±¡çš„çŠ¶æ€ï¼Œè®¾ç½®å®ƒä¸ºä¸€ä¸ªå¼‚æ­¥ Servlet è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è¿æ¥å™¨æ˜¯è°ƒç”¨ CoyoteAdapter çš„ service æ–¹æ³•æ¥å¤„ç†è¯·æ±‚çš„ï¼Œè€Œ CoyoteAdapter ä¼šè°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•ï¼Œå½“å®¹å™¨çš„ service æ–¹æ³•è¿”å›æ—¶ï¼ŒCoyoteAdapter åˆ¤æ–­å½“å‰çš„è¯·æ±‚æ˜¯ä¸æ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¸ä¼šé”€æ¯ Request å’Œ Response å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šæŠŠå“åº”ä¿¡æ¯å‘åˆ°æµè§ˆå™¨ã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ç†è§£ä¸€ä¸‹ï¼Œè¿™æ˜¯ CoyoteAdapter çš„ service æ–¹æ³•ï¼Œæˆ‘å¯¹å®ƒè¿›è¡Œäº†ç®€åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•å¤„ç†è¯·æ±‚</span></span><br><span class="line">    connector.getService().getContainer().getPipeline().</span><br><span class="line">           getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœæ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œä»…ä»…è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œ</span></span><br><span class="line">   <span class="comment">// å¦åˆ™è¯´æ˜æ˜¯åŒæ­¥ Servlet è¯·æ±‚ï¼Œå°±å°†å“åº”æ•°æ®åˆ·åˆ°æµè§ˆå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">        async = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.finishRequest();</span><br><span class="line">        response.finishResponse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœä¸æ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå°±é”€æ¯ Request å¯¹è±¡å’Œ Response å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        request.recycle();</span><br><span class="line">        response.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå½“ CoyoteAdaptor çš„ service æ–¹æ³•è¿”å›åˆ° ProtocolHandler ç»„ä»¶æ—¶ï¼ŒProtocolHandler åˆ¤æ–­è¿”å›å€¼ï¼Œå¦‚æœå½“å‰è¯·æ±‚æ˜¯ä¸€ä¸ªå¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå®ƒä¼šæŠŠå½“å‰ Socket çš„åè®®å¤„ç†è€… Processor ç¼“å­˜èµ·æ¥ï¼Œå°† SocketWrapper å¯¹è±¡å’Œç›¸åº”çš„ Processor å­˜åˆ°ä¸€ä¸ª Map æ•°æ®ç»“æ„é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;S,Processor&gt; connections = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>ä¹‹æ‰€ä»¥è¦ç¼“å­˜æ˜¯å› ä¸ºè¿™ä¸ªè¯·æ±‚æ¥ä¸‹æ¥è¿˜è¦æ¥ç€å¤„ç†ï¼Œè¿˜æ˜¯ç”±åŸæ¥çš„ Processor æ¥å¤„ç†ï¼Œé€šè¿‡ SocketWrapper å°±èƒ½ä» Map é‡Œæ‰¾åˆ°ç›¸åº”çš„ Processorã€‚</p>
<h4 id="complete-æ–¹æ³•"><a href="#complete-æ–¹æ³•" class="headerlink" title="complete æ–¹æ³•"></a>complete æ–¹æ³•</h4><p>æ¥ç€æˆ‘ä»¬å†æ¥çœ‹å…³é”®çš„<code>ctx.complete</code>æ–¹æ³•ï¼Œå½“è¯·æ±‚å¤„ç†å®Œæˆæ—¶ï¼ŒWeb åº”ç”¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿæœ€é‡è¦çš„å°±æ˜¯æŠŠå“åº”æ•°æ®å‘é€åˆ°æµè§ˆå™¨ã€‚</p>
<p>è¿™ä»¶äº‹æƒ…ä¸èƒ½ç”± Web åº”ç”¨çº¿ç¨‹æ¥åšï¼Œä¹Ÿå°±æ˜¯è¯´<code>ctx.complete</code>æ–¹æ³•ä¸èƒ½ç›´æ¥æŠŠå“åº”æ•°æ®å‘é€åˆ°æµè§ˆå™¨ï¼Œå› ä¸ºè¿™ä»¶äº‹æƒ…åº”è¯¥ç”± Tomcat çº¿ç¨‹æ¥åšï¼Œä½†å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œè¿æ¥å™¨ä¸­çš„ Endpoint ç»„ä»¶æ£€æµ‹åˆ°æœ‰è¯·æ±‚æ•°æ®è¾¾åˆ°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª SocketProcessor å¯¹è±¡äº¤ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œå› æ­¤ Endpoint çš„é€šä¿¡å¤„ç†å’Œå…·ä½“è¯·æ±‚å¤„ç†åœ¨ä¸¤ä¸ªçº¿ç¨‹é‡Œè¿è¡Œã€‚</p>
<p>åœ¨å¼‚æ­¥ Servlet çš„åœºæ™¯é‡Œï¼ŒWeb åº”ç”¨é€šè¿‡è°ƒç”¨<code>ctx.complete</code>æ–¹æ³•æ—¶ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ SocketProcessor ä»»åŠ¡ç±»ï¼Œäº¤ç»™çº¿ç¨‹æ± å¤„ç†ã€‚å¯¹äºå¼‚æ­¥ Servlet è¯·æ±‚æ¥è¯´ï¼Œç›¸åº”çš„ Socket å’Œåè®®å¤„ç†ç»„ä»¶ Processor éƒ½è¢«ç¼“å­˜èµ·æ¥äº†ï¼Œå¹¶ä¸”è¿™äº›å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ Request å¯¹è±¡æ‹¿åˆ°ã€‚</p>
<p>è®²åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½å·²ç»çŒœåˆ°<code>ctx.complete</code>æ˜¯å¦‚ä½•å®ç°çš„äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥çŠ¶æ€åˆæ³•æ€§ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥è¿™å¥</span></span><br><span class="line">    check();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ Request å¯¹è±¡çš„ action æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯é€šçŸ¥è¿æ¥å™¨ï¼Œè¿™ä¸ªå¼‚æ­¥è¯·æ±‚å¤„ç†å®Œäº†</span></span><br><span class="line">request.getCoyoteRequest().action(ActionCode.ASYNC_COMPLETE, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° complete æ–¹æ³•è°ƒç”¨äº† Request å¯¹è±¡çš„ action æ–¹æ³•ã€‚è€Œåœ¨ action æ–¹æ³•é‡Œï¼Œåˆ™æ˜¯è°ƒç”¨äº† Processor çš„ processSocketEvent æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº†æ“ä½œç  OPEN_READã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASYNC_COMPLETE: &#123;</span><br><span class="line">    clearDispatches();</span><br><span class="line">    <span class="keyword">if</span> (asyncStateMachine.asyncComplete()) &#123;</span><br><span class="line">        processSocketEvent(SocketEvent.OPEN_READ, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥ç€çœ‹ processSocketEvent æ–¹æ³•ï¼Œå®ƒè°ƒç”¨ SocketWrapper çš„ processSocket æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processSocketEvent</span><span class="params">(SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line">    SocketWrapperBase&lt;?&gt; socketWrapper = getSocketWrapper();</span><br><span class="line">    <span class="keyword">if</span> (socketWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        socketWrapper.processSocket(event, dispatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ SocketWrapper çš„ processSocket æ–¹æ³•ä¼šåˆ›å»º SocketProcessor ä»»åŠ¡ç±»ï¼Œå¹¶é€šè¿‡ Tomcat çº¿ç¨‹æ± æ¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processSocket</span><span class="params">(SocketWrapperBase&lt;S&gt; socketWrapper,</span></span><br><span class="line"><span class="params">        SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (socketWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      SocketProcessorBase&lt;S&gt; sc = processorCache.pop();</span><br><span class="line">      <span class="keyword">if</span> (sc == <span class="literal">null</span>) &#123;</span><br><span class="line">          sc = createSocketProcessor(socketWrapper, event);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          sc.reset(socketWrapper, event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// çº¿ç¨‹æ± è¿è¡Œ</span></span><br><span class="line">      <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getExecutor();</span><br><span class="line">      <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="literal">null</span>) &#123;</span><br><span class="line">          executor.execute(sc);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          sc.run();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·ä½ æ³¨æ„ createSocketProcessor å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ SocketEventï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ OPEN_READã€‚é€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±èƒ½æ§åˆ¶ SocketProcessor çš„è¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å†æŠŠè¯·æ±‚å‘é€åˆ°å®¹å™¨è¿›è¡Œå¤„ç†ï¼Œåªéœ€è¦å‘æµè§ˆå™¨ç«¯å‘é€æ•°æ®ï¼Œå¹¶ä¸”é‡æ–°åœ¨è¿™ä¸ª Socket ä¸Šç›‘å¬æ–°çš„è¯·æ±‚å°±è¡Œäº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><strong>å®˜æ–¹</strong><ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><strong>æ•™ç¨‹</strong><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100027701">æ·±å…¥æ‹†è§£ Tomcat &amp; Jetty</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/d404be/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/d404be/" class="post-title-link" itemprop="url">RocketMQ å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>12 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RocketMQ-å¿«é€Ÿå…¥é—¨"><a href="#RocketMQ-å¿«é€Ÿå…¥é—¨" class="headerlink" title="RocketMQ å¿«é€Ÿå…¥é—¨"></a>RocketMQ å¿«é€Ÿå…¥é—¨</h1><p>Apache RocketMQ æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ MQ å’Œæµå¤„ç†å¹³å°ï¼Œå…·æœ‰ä½å»¶è¿Ÿã€é«˜æ€§èƒ½å’Œå¯é æ€§ã€ä¸‡äº¿çº§å®¹é‡å’Œçµæ´»çš„å¯æ‰©å±•æ€§ã€‚</p>
<p>RocketMQ ç”±é˜¿é‡Œå·´å·´å­µåŒ–ï¼Œè¢«æèµ ç»™ Apacheï¼Œæˆä¸º Apache çš„é¡¶çº§é¡¹ç›®ã€‚</p>
<h2 id="RocketMQ-æ¦‚å¿µ"><a href="#RocketMQ-æ¦‚å¿µ" class="headerlink" title="RocketMQ æ¦‚å¿µ"></a>RocketMQ æ¦‚å¿µ</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/rocketmq/rmq-model.png" alt="img"></p>
<h3 id="æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage-Modelï¼‰"><a href="#æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage-Modelï¼‰" class="headerlink" title="æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage Modelï¼‰"></a>æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage Modelï¼‰</h3><p>RocketMQ ä¸»è¦ç”± Producerã€Brokerã€Consumer ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ Producer è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼ŒConsumer è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼ŒBroker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯ã€‚Broker åœ¨å®é™…éƒ¨ç½²è¿‡ç¨‹ä¸­å¯¹åº”ä¸€å°æœåŠ¡å™¨ï¼Œæ¯ä¸ª Broker å¯ä»¥å­˜å‚¨å¤šä¸ª Topic çš„æ¶ˆæ¯ï¼Œæ¯ä¸ª Topic çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åˆ†ç‰‡å­˜å‚¨äºä¸åŒçš„ Brokerã€‚Message Queue ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†åœ°å€ï¼Œæ¯ä¸ª Topic ä¸­çš„æ¶ˆæ¯åœ°å€å­˜å‚¨äºå¤šä¸ª Message Queue ä¸­ã€‚ConsumerGroup ç”±å¤šä¸ª Consumer å®ä¾‹æ„æˆã€‚</p>
<h3 id="æ¶ˆæ¯ï¼ˆMessageï¼‰"><a href="#æ¶ˆæ¯ï¼ˆMessageï¼‰" class="headerlink" title="æ¶ˆæ¯ï¼ˆMessageï¼‰"></a>æ¶ˆæ¯ï¼ˆMessageï¼‰</h3><p>æ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•ä½ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ªä¸»é¢˜ã€‚RocketMQ ä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰å”¯ä¸€çš„ Message IDï¼Œä¸”å¯ä»¥æºå¸¦å…·æœ‰ä¸šåŠ¡æ ‡è¯†çš„ Keyã€‚ç³»ç»Ÿæä¾›äº†é€šè¿‡ Message ID å’Œ Key æŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½ã€‚</p>
<p>æ¶ˆæ¯è¿˜å¯ä»¥å…·æœ‰å¯é€‰ Tag å’Œé¢å¤–çš„é”®å€¼å¯¹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä¸ºæ¶ˆæ¯è®¾ç½®ä¸šåŠ¡å¯†é’¥ï¼Œå¹¶åœ¨ä»£ç†æœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾æ¶ˆæ¯ä»¥è¯Šæ–­å¼€å‘æœŸé—´çš„é—®é¢˜ã€‚</p>
<h3 id="æ ‡ç­¾ï¼ˆTagï¼‰"><a href="#æ ‡ç­¾ï¼ˆTagï¼‰" class="headerlink" title="æ ‡ç­¾ï¼ˆTagï¼‰"></a>æ ‡ç­¾ï¼ˆTagï¼‰</h3><p>ä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ¥è‡ªåŒä¸€ä¸šåŠ¡å•å…ƒçš„æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡ç›®çš„åœ¨åŒä¸€ä¸»é¢˜ä¸‹è®¾ç½®ä¸åŒæ ‡ç­¾ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ– RocketMQ æä¾›çš„æŸ¥è¯¢ç³»ç»Ÿã€‚æ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag å®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§ã€‚</p>
<p>Tag ç›¸å½“äºå­ä¸»é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›äº†é¢å¤–çš„çµæ´»æ€§ã€‚å¯¹äº Tagï¼Œæ¥è‡ªåŒä¸€ä¸šåŠ¡æ¨¡å—çš„å…·æœ‰ä¸åŒç›®çš„çš„æ¶ˆæ¯å¯ä»¥å…·æœ‰ç›¸åŒçš„ä¸»é¢˜å’Œä¸åŒçš„ Tagã€‚</p>
<h3 id="ä¸»é¢˜ï¼ˆTopicï¼‰"><a href="#ä¸»é¢˜ï¼ˆTopicï¼‰" class="headerlink" title="ä¸»é¢˜ï¼ˆTopicï¼‰"></a>ä¸»é¢˜ï¼ˆTopicï¼‰</h3><p>è¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½å±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯ RocketMQ è¿›è¡Œæ¶ˆæ¯è®¢é˜…çš„åŸºæœ¬å•ä½ã€‚</p>
<h3 id="ä»£ç†æœåŠ¡å™¨ï¼ˆBroker-Serverï¼‰"><a href="#ä»£ç†æœåŠ¡å™¨ï¼ˆBroker-Serverï¼‰" class="headerlink" title="ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰"></a>ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰</h3><p>æ¶ˆæ¯ä¸­è½¬è§’è‰²ï¼Œè´Ÿè´£å­˜å‚¨æ¶ˆæ¯ã€è½¬å‘æ¶ˆæ¯ã€‚ä»£ç†æœåŠ¡å™¨åœ¨ RocketMQ ç³»ç»Ÿä¸­è´Ÿè´£æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ã€‚ä»£ç†æœåŠ¡å™¨ä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰ã€‚</p>
<h3 id="åç§°æœåŠ¡ï¼ˆName-Serverï¼‰"><a href="#åç§°æœåŠ¡ï¼ˆName-Serverï¼‰" class="headerlink" title="åç§°æœåŠ¡ï¼ˆName Serverï¼‰"></a>åç§°æœåŠ¡ï¼ˆName Serverï¼‰</h3><p>åç§°æœåŠ¡å……å½“è·¯ç”±æ¶ˆæ¯çš„æä¾›è€…ã€‚ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åç§°æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨ã€‚å¤šä¸ª Namesrv å®ä¾‹ç»„æˆé›†ç¾¤ï¼Œä½†ç›¸äº’ç‹¬ç«‹ï¼Œæ²¡æœ‰ä¿¡æ¯äº¤æ¢ã€‚</p>
<h3 id="æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰"><a href="#æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰" class="headerlink" title="æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰"></a>æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰</h3><p>è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼Œä¸€èˆ¬ç”±ä¸šåŠ¡ç³»ç»Ÿè´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ã€‚ä¸€ä¸ªæ¶ˆæ¯ç”Ÿäº§è€…ä¼šæŠŠä¸šåŠ¡åº”ç”¨ç³»ç»Ÿé‡Œäº§ç”Ÿçš„æ¶ˆæ¯å‘é€åˆ° broker æœåŠ¡å™¨ã€‚RocketMQ æä¾›å¤šç§å‘é€æ–¹å¼ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ã€‚åŒæ­¥å’Œå¼‚æ­¥æ–¹å¼å‡éœ€è¦ Broker è¿”å›ç¡®è®¤ä¿¡æ¯ï¼Œå•å‘å‘é€ä¸éœ€è¦ã€‚</p>
<h3 id="ç”Ÿäº§è€…ç»„ï¼ˆProducer-Groupï¼‰"><a href="#ç”Ÿäº§è€…ç»„ï¼ˆProducer-Groupï¼‰" class="headerlink" title="ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰"></a>ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰</h3><p>åŒä¸€ç±» Producer çš„é›†åˆï¼Œè¿™ç±» Producer å‘é€åŒä¸€ç±»æ¶ˆæ¯ä¸”å‘é€é€»è¾‘ä¸€è‡´ã€‚å¦‚æœå‘é€çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ä¸”åŸå§‹ç”Ÿäº§è€…åœ¨å‘é€ä¹‹åå´©æºƒï¼Œåˆ™ Broker æœåŠ¡å™¨ä¼šè”ç³»åŒä¸€ç”Ÿäº§è€…ç»„çš„å…¶ä»–ç”Ÿäº§è€…å®ä¾‹ä»¥æäº¤æˆ–å›æº¯æ¶ˆè´¹ã€‚</p>
<p>è­¦å‘Šï¼šè€ƒè™‘åˆ°æä¾›çš„ Producer åœ¨å‘é€æ¶ˆæ¯æ–¹é¢è¶³å¤Ÿå¼ºå¤§ï¼Œ<strong>æ¯ä¸ª Producer ç»„åªå…è®¸ä¸€ä¸ªå®ä¾‹ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ç”Ÿæˆå™¨å®ä¾‹åˆå§‹åŒ–</strong>ã€‚</p>
<h3 id="æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰"><a href="#æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰"></a>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</h3><p>è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿè´Ÿè´£å¼‚æ­¥æ¶ˆè´¹ã€‚ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ä¼šä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ã€å¹¶å°†å…¶æä¾›ç»™åº”ç”¨ç¨‹åºã€‚ä»ç”¨æˆ·åº”ç”¨çš„è§’åº¦è€Œè¨€æä¾›äº†ä¸¤ç§æ¶ˆè´¹å½¢å¼ï¼šæ‹‰å–å¼æ¶ˆè´¹ã€æ¨åŠ¨å¼æ¶ˆè´¹ã€‚</p>
<h3 id="æ¶ˆè´¹è€…ç»„ï¼ˆConsumer-Groupï¼‰"><a href="#æ¶ˆè´¹è€…ç»„ï¼ˆConsumer-Groupï¼‰" class="headerlink" title="æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰"></a>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰</h3><p>åŒä¸€ç±» Consumer çš„é›†åˆï¼Œè¿™ç±» Consumer é€šå¸¸æ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™çš„ç›®æ ‡å˜å¾—éå¸¸å®¹æ˜“ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>æ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„ Topic</strong>ã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼šé›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰å’Œå¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ã€‚</p>
<h3 id="æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull-Consumerï¼‰"><a href="#æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull-Consumerï¼‰" class="headerlink" title="æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰"></a>æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰</h3><p>Consumer æ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œåº”ç”¨é€šå¸¸ä¸»åŠ¨è°ƒç”¨ Consumer çš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä» Broker æœåŠ¡å™¨æ‹‰æ¶ˆæ¯ã€ä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶ã€‚ä¸€æ—¦è·å–äº†æ‰¹é‡æ¶ˆæ¯ï¼Œåº”ç”¨å°±ä¼šå¯åŠ¨æ¶ˆè´¹è¿‡ç¨‹ã€‚</p>
<h3 id="æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush-Consumerï¼‰"><a href="#æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush-Consumerï¼‰" class="headerlink" title="æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰"></a>æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰</h3><p>Consumer æ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œè¯¥æ¨¡å¼ä¸‹ Broker æ”¶åˆ°æ•°æ®åä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹ç«¯ï¼Œè¯¥æ¶ˆè´¹æ¨¡å¼ä¸€èˆ¬å®æ—¶æ€§è¾ƒé«˜ã€‚</p>
<h3 id="é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰"><a href="#é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰" class="headerlink" title="é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰"></a>é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰</h3><p>é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹,ç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ã€‚</p>
<h3 id="å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰"><a href="#å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰" class="headerlink" title="å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰"></a>å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰</h3><p>å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯ã€‚</p>
<h3 id="æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal-Ordered-Messageï¼‰"><a href="#æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal-Ordered-Messageï¼‰" class="headerlink" title="æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰"></a>æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰</h3><p>æ™®é€šé¡ºåºæ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…é€šè¿‡åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ Topic åˆ†åŒºï¼Œç§°ä½œ Message Queueï¼‰ æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚</p>
<h3 id="ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly-Ordered-Messageï¼‰"><a href="#ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly-Ordered-Messageï¼‰" class="headerlink" title="ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰"></a>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰</h3><p>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‡æ˜¯æœ‰é¡ºåºçš„ã€‚</p>
<h2 id="RocketMQ-ç‰¹æ€§"><a href="#RocketMQ-ç‰¹æ€§" class="headerlink" title="RocketMQ ç‰¹æ€§"></a>RocketMQ ç‰¹æ€§</h2><h3 id="è®¢é˜…ä¸å‘å¸ƒ"><a href="#è®¢é˜…ä¸å‘å¸ƒ" class="headerlink" title="è®¢é˜…ä¸å‘å¸ƒ"></a>è®¢é˜…ä¸å‘å¸ƒ</h3><p>æ¶ˆæ¯çš„å‘å¸ƒæ˜¯æŒ‡æŸä¸ªç”Ÿäº§è€…å‘æŸä¸ª topic å‘é€æ¶ˆæ¯ï¼›æ¶ˆæ¯çš„è®¢é˜…æ˜¯æŒ‡æŸä¸ªæ¶ˆè´¹è€…å…³æ³¨äº†æŸä¸ª topic ä¸­å¸¦æœ‰æŸäº› tag çš„æ¶ˆæ¯ï¼Œè¿›è€Œä»è¯¥ topic æ¶ˆè´¹æ•°æ®ã€‚</p>
<h3 id="æ¶ˆæ¯é¡ºåº"><a href="#æ¶ˆæ¯é¡ºåº" class="headerlink" title="æ¶ˆæ¯é¡ºåº"></a>æ¶ˆæ¯é¡ºåº</h3><p>æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯ä¸€ç±»æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œèƒ½æŒ‰ç…§å‘é€çš„é¡ºåºæ¥æ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªè®¢å•äº§ç”Ÿäº†ä¸‰æ¡æ¶ˆæ¯åˆ†åˆ«æ˜¯è®¢å•åˆ›å»ºã€è®¢å•ä»˜æ¬¾ã€è®¢å•å®Œæˆã€‚æ¶ˆè´¹æ—¶è¦æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¶ˆè´¹æ‰èƒ½æœ‰æ„ä¹‰ï¼Œä½†æ˜¯åŒæ—¶è®¢å•ä¹‹é—´æ˜¯å¯ä»¥å¹¶è¡Œæ¶ˆè´¹çš„ã€‚RocketMQ å¯ä»¥ä¸¥æ ¼çš„ä¿è¯æ¶ˆæ¯æœ‰åºã€‚</p>
<p>é¡ºåºæ¶ˆæ¯åˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯ä¸åˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼Œå…¨å±€é¡ºåºæ˜¯æŒ‡æŸä¸ª Topic ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¦ä¿è¯é¡ºåºï¼›éƒ¨åˆ†é¡ºåºæ¶ˆæ¯åªè¦ä¿è¯æ¯ä¸€ç»„æ¶ˆæ¯è¢«é¡ºåºæ¶ˆè´¹å³å¯ã€‚</p>
<ul>
<li>å…¨å±€é¡ºåº å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚ é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯</li>
<li>åˆ†åŒºé¡ºåº å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æ ¹æ® sharding key è¿›è¡ŒåŒºå—åˆ†åŒºã€‚ åŒä¸€ä¸ªåˆ†åŒºå†…çš„æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„ FIFO é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚ Sharding key æ˜¯é¡ºåºæ¶ˆæ¯ä¸­ç”¨æ¥åŒºåˆ†ä¸åŒåˆ†åŒºçš„å…³é”®å­—æ®µï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„ Key æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚ é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚é«˜ï¼Œä»¥ sharding key ä½œä¸ºåˆ†åŒºå­—æ®µï¼Œåœ¨åŒä¸€ä¸ªåŒºå—ä¸­ä¸¥æ ¼çš„æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="æ¶ˆæ¯è¿‡æ»¤"><a href="#æ¶ˆæ¯è¿‡æ»¤" class="headerlink" title="æ¶ˆæ¯è¿‡æ»¤"></a>æ¶ˆæ¯è¿‡æ»¤</h3><p>RocketMQ çš„æ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰å±æ€§è¿‡æ»¤ã€‚æ¶ˆæ¯è¿‡æ»¤ç›®å‰æ˜¯åœ¨ Broker ç«¯å®ç°çš„ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ï¼Œç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ã€è€Œä¸”å®ç°ç›¸å¯¹å¤æ‚ã€‚</p>
<h3 id="æ¶ˆæ¯å¯é æ€§"><a href="#æ¶ˆæ¯å¯é æ€§" class="headerlink" title="æ¶ˆæ¯å¯é æ€§"></a>æ¶ˆæ¯å¯é æ€§</h3><p>RocketMQ æ”¯æŒæ¶ˆæ¯çš„é«˜å¯é ï¼Œå½±å“æ¶ˆæ¯å¯é æ€§çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>Broker éæ­£å¸¸å…³é—­</li>
<li>Broker å¼‚å¸¸ Crash</li>
<li>OS Crash</li>
<li>æœºå™¨æ‰ç”µï¼Œä½†æ˜¯èƒ½ç«‹å³æ¢å¤ä¾›ç”µæƒ…å†µ</li>
<li>æœºå™¨æ— æ³•å¼€æœºï¼ˆå¯èƒ½æ˜¯ cpuã€ä¸»æ¿ã€å†…å­˜ç­‰å…³é”®è®¾å¤‡æŸåï¼‰</li>
<li>ç£ç›˜è®¾å¤‡æŸå</li>
</ol>
<p>1)ã€2)ã€3)ã€4) å››ç§æƒ…å†µéƒ½å±äºç¡¬ä»¶èµ„æºå¯ç«‹å³æ¢å¤æƒ…å†µï¼ŒRocketMQ åœ¨è¿™å››ç§æƒ…å†µä¸‹èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œæˆ–è€…ä¸¢å¤±å°‘é‡æ•°æ®ï¼ˆä¾èµ–åˆ·ç›˜æ–¹å¼æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼‰ã€‚</p>
<p>5)ã€6)å±äºå•ç‚¹æ•…éšœï¼Œä¸”æ— æ³•æ¢å¤ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåœ¨æ­¤å•ç‚¹ä¸Šçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±ã€‚RocketMQ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼‚æ­¥å¤åˆ¶ï¼Œå¯ä¿è¯ 99%çš„æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä»ç„¶ä¼šæœ‰æå°‘é‡çš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚é€šè¿‡åŒæ­¥åŒå†™æŠ€æœ¯å¯ä»¥å®Œå…¨é¿å…å•ç‚¹ï¼ŒåŒæ­¥åŒå†™åŠ¿å¿…ä¼šå½±å“æ€§èƒ½ï¼Œé€‚åˆå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æé«˜çš„åœºåˆï¼Œä¾‹å¦‚ä¸ Money ç›¸å…³çš„åº”ç”¨ã€‚æ³¨ï¼šRocketMQ ä» 3.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒåŒæ­¥åŒå†™ã€‚</p>
<h3 id="è‡³å°‘ä¸€æ¬¡"><a href="#è‡³å°‘ä¸€æ¬¡" class="headerlink" title="è‡³å°‘ä¸€æ¬¡"></a>è‡³å°‘ä¸€æ¬¡</h3><p>è‡³å°‘ä¸€æ¬¡(At least Once)æŒ‡æ¯ä¸ªæ¶ˆæ¯å¿…é¡»æŠ•é€’ä¸€æ¬¡ã€‚Consumer å…ˆ Pull æ¶ˆæ¯åˆ°æœ¬åœ°ï¼Œæ¶ˆè´¹å®Œæˆåï¼Œæ‰å‘æœåŠ¡å™¨è¿”å› ackï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹ä¸€å®šä¸ä¼š ack æ¶ˆæ¯ï¼Œæ‰€ä»¥ RocketMQ å¯ä»¥å¾ˆå¥½çš„æ”¯æŒæ­¤ç‰¹æ€§ã€‚</p>
<h3 id="å›æº¯æ¶ˆè´¹"><a href="#å›æº¯æ¶ˆè´¹" class="headerlink" title="å›æº¯æ¶ˆè´¹"></a>å›æº¯æ¶ˆè´¹</h3><p>å›æº¯æ¶ˆè´¹æ˜¯æŒ‡ Consumer å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼Œè¦æ”¯æŒæ­¤åŠŸèƒ½ï¼ŒBroker åœ¨å‘ Consumer æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œæ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº Consumer ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹ 1 å°æ—¶å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆ Broker è¦æä¾›ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´ç»´åº¦æ¥å›é€€æ¶ˆè´¹è¿›åº¦ã€‚RocketMQ æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’ã€‚</p>
<h3 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h3><p>RocketMQ äº‹åŠ¡æ¶ˆæ¯ï¼ˆTransactional Messageï¼‰æ˜¯æŒ‡åº”ç”¨æœ¬åœ°äº‹åŠ¡å’Œå‘é€æ¶ˆæ¯æ“ä½œå¯ä»¥è¢«å®šä¹‰åˆ°å…¨å±€äº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æä¾›ç±»ä¼¼ X&#x2F;Open XA çš„åˆ†å¸ƒäº‹åŠ¡åŠŸèƒ½ï¼Œé€šè¿‡äº‹åŠ¡æ¶ˆæ¯èƒ½è¾¾åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´ã€‚</p>
<h3 id="å®šæ—¶æ¶ˆæ¯"><a href="#å®šæ—¶æ¶ˆæ¯" class="headerlink" title="å®šæ—¶æ¶ˆæ¯"></a>å®šæ—¶æ¶ˆæ¯</h3><p>å®šæ—¶æ¶ˆæ¯ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰æ˜¯æŒ‡æ¶ˆæ¯å‘é€åˆ° broker åï¼Œä¸ä¼šç«‹å³è¢«æ¶ˆè´¹ï¼Œç­‰å¾…ç‰¹å®šæ—¶é—´æŠ•é€’ç»™çœŸæ­£çš„ topicã€‚ broker æœ‰é…ç½®é¡¹ messageDelayLevelï¼Œé»˜è®¤å€¼ä¸ºâ€œ1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hâ€ï¼Œ18 ä¸ª levelã€‚å¯ä»¥é…ç½®è‡ªå®šä¹‰ messageDelayLevelã€‚æ³¨æ„ï¼ŒmessageDelayLevel æ˜¯ broker çš„å±æ€§ï¼Œä¸å±äºæŸä¸ª topicã€‚å‘æ¶ˆæ¯æ—¶ï¼Œè®¾ç½® delayLevel ç­‰çº§å³å¯ï¼šmsg.setDelayLevel(level)ã€‚level æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>level &#x3D;&#x3D; 0ï¼Œæ¶ˆæ¯ä¸ºéå»¶è¿Ÿæ¶ˆæ¯</li>
<li>1&lt;&#x3D;level&lt;&#x3D;maxLevelï¼Œæ¶ˆæ¯å»¶è¿Ÿç‰¹å®šæ—¶é—´ï¼Œä¾‹å¦‚ level&#x3D;&#x3D;1ï¼Œå»¶è¿Ÿ 1s</li>
<li>level &gt; maxLevelï¼Œåˆ™ level&#x3D;&#x3D; maxLevelï¼Œä¾‹å¦‚ level&#x3D;&#x3D;20ï¼Œå»¶è¿Ÿ 2h</li>
</ul>
<p>å®šæ—¶æ¶ˆæ¯ä¼šæš‚å­˜åœ¨åä¸º SCHEDULE_TOPIC_XXXX çš„ topic ä¸­ï¼Œå¹¶æ ¹æ® delayTimeLevel å­˜å…¥ç‰¹å®šçš„ queueï¼ŒqueueId &#x3D; delayTimeLevel â€“ 1ï¼Œå³ä¸€ä¸ª queue åªå­˜ç›¸åŒå»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œä¿è¯å…·æœ‰ç›¸åŒå‘é€å»¶è¿Ÿçš„æ¶ˆæ¯èƒ½å¤Ÿé¡ºåºæ¶ˆè´¹ã€‚broker ä¼šè°ƒåº¦åœ°æ¶ˆè´¹ SCHEDULE_TOPIC_XXXXï¼Œå°†æ¶ˆæ¯å†™å…¥çœŸå®çš„ topicã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®šæ—¶æ¶ˆæ¯ä¼šåœ¨ç¬¬ä¸€æ¬¡å†™å…¥å’Œè°ƒåº¦å†™å…¥çœŸå® topic æ—¶éƒ½ä¼šè®¡æ•°ï¼Œå› æ­¤å‘é€æ•°é‡ã€tps éƒ½ä¼šå˜é«˜ã€‚</p>
<h3 id="æ¶ˆæ¯é‡è¯•"><a href="#æ¶ˆæ¯é‡è¯•" class="headerlink" title="æ¶ˆæ¯é‡è¯•"></a>æ¶ˆæ¯é‡è¯•</h3><p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥é€šå¸¸å¯ä»¥è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>ç”±äºæ¶ˆæ¯æœ¬èº«çš„åŸå› ï¼Œä¾‹å¦‚ååºåˆ—åŒ–å¤±è´¥ï¼Œæ¶ˆæ¯æ•°æ®æœ¬èº«æ— æ³•å¤„ç†ï¼ˆä¾‹å¦‚è¯è´¹å……å€¼ï¼Œå½“å‰æ¶ˆæ¯çš„æ‰‹æœºå·è¢«æ³¨é”€ï¼Œæ— æ³•å……å€¼ï¼‰ç­‰ã€‚è¿™ç§é”™è¯¯é€šå¸¸éœ€è¦è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œå†æ¶ˆè´¹å…¶å®ƒæ¶ˆæ¯ï¼Œè€Œè¿™æ¡å¤±è´¥çš„æ¶ˆæ¯å³ä½¿ç«‹åˆ»é‡è¯•æ¶ˆè´¹ï¼Œ99%ä¹Ÿä¸æˆåŠŸï¼Œæ‰€ä»¥æœ€å¥½æä¾›ä¸€ç§å®šæ—¶é‡è¯•æœºåˆ¶ï¼Œå³è¿‡ 10 ç§’åå†é‡è¯•ã€‚</li>
<li>ç”±äºä¾èµ–çš„ä¸‹æ¸¸åº”ç”¨æœåŠ¡ä¸å¯ç”¨ï¼Œä¾‹å¦‚ db è¿æ¥ä¸å¯ç”¨ï¼Œå¤–ç³»ç»Ÿç½‘ç»œä¸å¯è¾¾ç­‰ã€‚é‡åˆ°è¿™ç§é”™è¯¯ï¼Œå³ä½¿è·³è¿‡å½“å‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹å…¶ä»–æ¶ˆæ¯åŒæ ·ä¹Ÿä¼šæŠ¥é”™ã€‚è¿™ç§æƒ…å†µå»ºè®®åº”ç”¨ sleep 30sï¼Œå†æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥å‡è½» Broker é‡è¯•æ¶ˆæ¯çš„å‹åŠ›ã€‚</li>
</ul>
<p>RocketMQ ä¼šä¸ºæ¯ä¸ªæ¶ˆè´¹ç»„éƒ½è®¾ç½®ä¸€ä¸ª Topic åç§°ä¸ºâ€œ%RETRY%+consumerGroupâ€çš„é‡è¯•é˜Ÿåˆ—ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª Topic çš„é‡è¯•é˜Ÿåˆ—æ˜¯é’ˆå¯¹æ¶ˆè´¹ç»„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ª Topic è®¾ç½®çš„ï¼‰ï¼Œç”¨äºæš‚æ—¶ä¿å­˜å› ä¸ºå„ç§å¼‚å¸¸è€Œå¯¼è‡´ Consumer ç«¯æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚è€ƒè™‘åˆ°å¼‚å¸¸æ¢å¤èµ·æ¥éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä¼šä¸ºé‡è¯•é˜Ÿåˆ—è®¾ç½®å¤šä¸ªé‡è¯•çº§åˆ«ï¼Œæ¯ä¸ªé‡è¯•çº§åˆ«éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„é‡æ–°æŠ•é€’å»¶æ—¶ï¼Œé‡è¯•æ¬¡æ•°è¶Šå¤šæŠ•é€’å»¶æ—¶å°±è¶Šå¤§ã€‚RocketMQ å¯¹äºé‡è¯•æ¶ˆæ¯çš„å¤„ç†æ˜¯å…ˆä¿å­˜è‡³ Topic åç§°ä¸ºâ€œSCHEDULE_TOPIC_XXXXâ€çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œåå°å®šæ—¶ä»»åŠ¡æŒ‰ç…§å¯¹åº”çš„æ—¶é—´è¿›è¡Œ Delay åé‡æ–°ä¿å­˜è‡³â€œ%RETRY%+consumerGroupâ€çš„é‡è¯•é˜Ÿåˆ—ä¸­ã€‚</p>
<h3 id="æ¶ˆæ¯é‡æŠ•"><a href="#æ¶ˆæ¯é‡æŠ•" class="headerlink" title="æ¶ˆæ¯é‡æŠ•"></a>æ¶ˆæ¯é‡æŠ•</h3><p>ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒåŒæ­¥æ¶ˆæ¯å¤±è´¥ä¼šé‡æŠ•ï¼Œå¼‚æ­¥æ¶ˆæ¯æœ‰é‡è¯•ï¼Œoneway æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚æ¶ˆæ¯é‡æŠ•ä¿è¯æ¶ˆæ¯å°½å¯èƒ½å‘é€æˆåŠŸã€ä¸ä¸¢å¤±ï¼Œä½†å¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼Œæ¶ˆæ¯é‡å¤åœ¨ RocketMQ ä¸­æ˜¯æ— æ³•é¿å…çš„é—®é¢˜ã€‚æ¶ˆæ¯é‡å¤åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿï¼Œå½“å‡ºç°æ¶ˆæ¯é‡å¤§ã€ç½‘ç»œæŠ–åŠ¨ï¼Œæ¶ˆæ¯é‡å¤å°±ä¼šæ˜¯å¤§æ¦‚ç‡äº‹ä»¶ã€‚å¦å¤–ï¼Œç”Ÿäº§è€…ä¸»åŠ¨é‡å‘ã€consumer è´Ÿè½½å˜åŒ–ä¹Ÿä¼šå¯¼è‡´é‡å¤æ¶ˆæ¯ã€‚å¦‚ä¸‹æ–¹æ³•å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡è¯•ç­–ç•¥ï¼š</p>
<ul>
<li>retryTimesWhenSendFailed:åŒæ­¥å‘é€å¤±è´¥é‡æŠ•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ï¼Œå› æ­¤ç”Ÿäº§è€…ä¼šæœ€å¤šå°è¯•å‘é€ retryTimesWhenSendFailed + 1 æ¬¡ã€‚ä¸ä¼šé€‰æ‹©ä¸Šæ¬¡å¤±è´¥çš„ brokerï¼Œå°è¯•å‘å…¶ä»– broker å‘é€ï¼Œæœ€å¤§ç¨‹åº¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚è¶…è¿‡é‡æŠ•æ¬¡æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œç”±å®¢æˆ·ç«¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚å½“å‡ºç° RemotingExceptionã€MQClientException å’Œéƒ¨åˆ† MQBrokerException æ—¶ä¼šé‡æŠ•ã€‚</li>
<li>retryTimesWhenSendAsyncFailed:å¼‚æ­¥å‘é€å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•ä¸ä¼šé€‰æ‹©å…¶ä»– brokerï¼Œä»…åœ¨åŒä¸€ä¸ª broker ä¸Šåšé‡è¯•ï¼Œä¸ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚</li>
<li>retryAnotherBrokerWhenNotStoreOK:æ¶ˆæ¯åˆ·ç›˜ï¼ˆä¸»æˆ–å¤‡ï¼‰è¶…æ—¶æˆ– slave ä¸å¯ç”¨ï¼ˆè¿”å›çŠ¶æ€é SEND_OKï¼‰ï¼Œæ˜¯å¦å°è¯•å‘é€åˆ°å…¶ä»– brokerï¼Œé»˜è®¤ falseã€‚ååˆ†é‡è¦æ¶ˆæ¯å¯ä»¥å¼€å¯ã€‚</li>
</ul>
<h3 id="é‡æ§åˆ¶"><a href="#é‡æ§åˆ¶" class="headerlink" title="é‡æ§åˆ¶"></a>é‡æ§åˆ¶</h3><p>ç”Ÿäº§è€…æµæ§ï¼Œå› ä¸º broker å¤„ç†èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆï¼›æ¶ˆè´¹è€…æµæ§ï¼Œå› ä¸ºæ¶ˆè´¹èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆã€‚</p>
<p>ç”Ÿäº§è€…æµæ§ï¼š</p>
<ul>
<li>commitLog æ–‡ä»¶è¢«é”æ—¶é—´è¶…è¿‡ osPageCacheBusyTimeOutMills æ—¶ï¼Œå‚æ•°é»˜è®¤ä¸º 1000msï¼Œè¿”å›æµæ§ã€‚</li>
<li>å¦‚æœå¼€å¯ transientStorePoolEnable &#x3D;&#x3D; trueï¼Œä¸” broker ä¸ºå¼‚æ­¥åˆ·ç›˜çš„ä¸»æœºï¼Œä¸” transientStorePool ä¸­èµ„æºä¸è¶³ï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚</li>
<li>broker æ¯éš” 10ms æ£€æŸ¥ send è¯·æ±‚é˜Ÿåˆ—å¤´éƒ¨è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ waitTimeMillsInSendQueueï¼Œé»˜è®¤ 200msï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚</li>
<li>broker é€šè¿‡æ‹’ç» send è¯·æ±‚æ–¹å¼å®ç°æµé‡æ§åˆ¶ã€‚</li>
</ul>
<p>æ³¨æ„ï¼Œç”Ÿäº§è€…æµæ§ï¼Œä¸ä¼šå°è¯•æ¶ˆæ¯é‡æŠ•ã€‚</p>
<p>æ¶ˆè´¹è€…æµæ§ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°è¶…è¿‡ pullThresholdForQueue æ—¶ï¼Œé»˜è®¤ 1000ã€‚</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯å¤§å°è¶…è¿‡ pullThresholdSizeForQueue æ—¶ï¼Œé»˜è®¤ 100MBã€‚</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯è·¨åº¦è¶…è¿‡ consumeConcurrentlyMaxSpan æ—¶ï¼Œé»˜è®¤ 2000ã€‚</li>
</ul>
<p>æ¶ˆè´¹è€…æµæ§çš„ç»“æœæ˜¯é™ä½æ‹‰å–é¢‘ç‡ã€‚</p>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—"><a href="#æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—"></a>æ­»ä¿¡é˜Ÿåˆ—</h3><p>æ­»ä¿¡é˜Ÿåˆ—ç”¨äºå¤„ç†æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼›è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ— ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚</p>
<p>RocketMQ å°†è¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå°†å­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ã€‚åœ¨ RocketMQ ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ console æ§åˆ¶å°å¯¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡å‘æ¥ä½¿å¾—æ¶ˆè´¹è€…å®ä¾‹å†æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<h2 id="RocketMQ-ç»„ä»¶"><a href="#RocketMQ-ç»„ä»¶" class="headerlink" title="RocketMQ ç»„ä»¶"></a>RocketMQ ç»„ä»¶</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220712060550.png" alt="img"></p>
<p>RocketMQ ç”±å››éƒ¨åˆ†ç»„æˆï¼šNameServerã€Brokerã€Producerã€Consumerã€‚å…¶ä¸­ä»»æ„ä¸€ä¸ªç»„æˆéƒ½å¯ä»¥æ°´å¹³æ‰©å±•ä¸ºé›†ç¾¤æ¨¡å¼ï¼Œä»¥é¿å…å•ç‚¹æ•…éšœé—®é¢˜ã€‚</p>
<h3 id="NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰"><a href="#NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰" class="headerlink" title="NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰"></a>NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰</h3><p>NameServer æ˜¯ä¸€ä¸ª Topic è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå…¶è§’è‰²ç±»ä¼¼ Kafka ä¸­çš„ zookeeperï¼Œæ”¯æŒ Broker çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚æ¯ä¸ª NameServer è®°å½•å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ï¼Œæä¾›ç›¸åº”çš„è¯»å†™æœåŠ¡ï¼Œæ”¯æŒå¿«é€Ÿå­˜å‚¨æ‰©å±•ã€‚</p>
<p>NameServer ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>Broker ç®¡ç†</strong>ï¼ŒNameServer æ¥å— Broker é›†ç¾¤çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥ Broker æ˜¯å¦è¿˜å­˜æ´»ï¼›</li>
<li><strong>è·¯ç”±ä¿¡æ¯ç®¡ç†</strong>ï¼Œæ¯ä¸ª NameServer å°†ä¿å­˜å…³äº Broker é›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶å Producer å’Œ Conumser é€šè¿‡ NameServer å°±å¯ä»¥çŸ¥é“æ•´ä¸ª Broker é›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚</li>
</ul>
<p>NameServer é€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚Broker æ˜¯å‘æ¯ä¸€å° NameServer æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª NameServer å®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ª NameServer å› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBroker ä»ç„¶å¯ä»¥å‘å…¶å®ƒ NameServer åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼ŒProducerã€Consumer ä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥ Broker çš„è·¯ç”±çš„ä¿¡æ¯ã€‚</p>
<p>NameServer æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„æœåŠ¡å™¨ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>Broker ç®¡ç† - NameServer æ¥å—æ¥è‡ª Broker é›†ç¾¤çš„æ³¨å†Œï¼Œå¹¶æä¾›å¿ƒè·³æœºåˆ¶æ¥æ£€æŸ¥ Broker èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ã€‚</li>
<li>è·¯ç”±ç®¡ç† - æ¯ä¸ª NameServer å°†ä¿å­˜æœ‰å…³ Broker é›†ç¾¤çš„å®Œæ•´è·¯ç”±ä¿¡æ¯å’Œå®¢æˆ·ç«¯æŸ¥è¯¢çš„æŸ¥è¯¢é˜Ÿåˆ—ã€‚</li>
</ol>
<p>RocketMQ å®¢æˆ·ç«¯ï¼ˆProducer&#x2F;Consumerï¼‰å°†ä» NameServer æŸ¥è¯¢é˜Ÿåˆ—è·¯ç”±ä¿¡æ¯ã€‚</p>
<p>å°† NameServer åœ°å€åˆ—è¡¨æä¾›ç»™å®¢æˆ·ç«¯æœ‰å››ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ç¼–ç¨‹æ–¹å¼ - ç±»ä¼¼ï¼š<code>producer.setNamesrvAddr(&quot;ip:port&quot;)</code></li>
<li>Java é€‰é¡¹ - ä½¿ç”¨ <code>rocketmq.namesrv.addr</code> å‚æ•°</li>
<li>ç¯å¢ƒå˜é‡ - è®¾ç½®ç¯å¢ƒå˜é‡ <code>NAMESRV_ADDR</code></li>
<li>HTTP ç«¯ç‚¹</li>
</ol>
<blockquote>
<p>æ›´è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="http://rocketmq.apache.org/rocketmq/four-methods-to-feed-name-server-address-list/">here</a></p>
</blockquote>
<h3 id="Brokerï¼ˆä»£ç†ï¼‰"><a href="#Brokerï¼ˆä»£ç†ï¼‰" class="headerlink" title="Brokerï¼ˆä»£ç†ï¼‰"></a>Brokerï¼ˆä»£ç†ï¼‰</h3><p>Broker ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ã€‚</p>
<p>Broker åŒæ—¶æ”¯æŒæ¨æ‹‰æ¨¡å‹ï¼ŒåŒ…å«å®¹é”™æœºåˆ¶ï¼ˆ2 å‰¯æœ¬æˆ– 3 å‰¯æœ¬ï¼‰ï¼Œå¹¶æä¾›å¼ºå¤§çš„å³°å€¼å¡«å……å’ŒæŒ‰åŸå§‹æ—¶é—´é¡ºåºç´¯ç§¯æ•°åƒäº¿æ¶ˆæ¯çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒBroker æä¾›äº†ç¾éš¾æ¢å¤ã€ä¸°å¯Œçš„æŒ‡æ ‡ç»Ÿè®¡å’Œè­¦æŠ¥æœºåˆ¶ï¼Œè¿™äº›éƒ½æ˜¯ä¼ ç»Ÿ MQ æ‰€ç¼ºä¹çš„ã€‚</p>
<p>ä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼ŒBroker åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ï¼š</p>
<ul>
<li><strong>Remoting Module</strong>ï¼šæ•´ä¸ª Broker çš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ª clients ç«¯çš„è¯·æ±‚ã€‚</li>
<li><strong>Client Manager</strong>ï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯(Producer&#x2F;Consumer)å’Œç»´æŠ¤ Consumer çš„ Topic è®¢é˜…ä¿¡æ¯ã€‚</li>
<li><strong>Store Service</strong>ï¼šæä¾›æ–¹ä¾¿ç®€å•çš„ API æ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚</li>
<li><strong>HA Service</strong>ï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾› Master Broker å’Œ Slave Broker ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚</li>
<li><strong>Index Service</strong>ï¼šæ ¹æ®ç‰¹å®šçš„ Message key å¯¹æŠ•é€’åˆ° Broker çš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/rocketmq/rmq-basic-component.png" alt="img"></p>
<h3 id="Producerï¼ˆç”Ÿäº§è€…ï¼‰"><a href="#Producerï¼ˆç”Ÿäº§è€…ï¼‰" class="headerlink" title="Producerï¼ˆç”Ÿäº§è€…ï¼‰"></a>Producerï¼ˆç”Ÿäº§è€…ï¼‰</h3><p>Producers æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚Producer é€šè¿‡ MQ çš„è´Ÿè½½å‡è¡¡æ¨¡å—é€‰æ‹©ç›¸åº”çš„ Broker é›†ç¾¤é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼ŒæŠ•é€’çš„è¿‡ç¨‹æ”¯æŒå¿«é€Ÿå¤±è´¥å¹¶ä¸”ä½å»¶è¿Ÿã€‚</p>
<h3 id="Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰"><a href="#Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰" class="headerlink" title="Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰"></a>Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰</h3><p>Consumer æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥ push æ¨ï¼Œpull æ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ï¼Œå¯ä»¥æ»¡è¶³å¤§å¤šæ•°ç”¨æˆ·çš„éœ€æ±‚ã€‚</p>
<h2 id="RocketMQ-å®‰è£…"><a href="#RocketMQ-å®‰è£…" class="headerlink" title="RocketMQ å®‰è£…"></a>RocketMQ å®‰è£…</h2><h3 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h3><ul>
<li>æ¨è 64 ä½æ“ä½œç³»ç»Ÿï¼šLinux&#x2F;Unix&#x2F;Mac</li>
<li>64bit JDK 1.8+</li>
<li>Maven 3.2.x</li>
<li>Git</li>
</ul>
<h3 id="ä¸‹è½½è§£å‹"><a href="#ä¸‹è½½è§£å‹" class="headerlink" title="ä¸‹è½½è§£å‹"></a>ä¸‹è½½è§£å‹</h3><p>è¿›å…¥å®˜æ–¹ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/dowloading/releases/%EF%BC%8C%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%89%88%E6%9C%AC">https://rocketmq.apache.org/dowloading/releases/ï¼Œé€‰æ‹©åˆé€‚ç‰ˆæœ¬</a></p>
<p>å»ºè®®é€‰æ‹© binary ç‰ˆæœ¬ã€‚</p>
<p>è§£å‹åˆ°æœ¬åœ°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; unzip rocketmq-all-4.2.0-source-release.zip</span><br><span class="line">&gt; <span class="built_in">cd</span> rocketmq-all-4.2.0/</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨-Name-Server"><a href="#å¯åŠ¨-Name-Server" class="headerlink" title="å¯åŠ¨ Name Server"></a>å¯åŠ¨ Name Server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">nohup</span> sh bin/mqnamesrv &amp;</span><br><span class="line">&gt; <span class="built_in">tail</span> -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨-Broker"><a href="#å¯åŠ¨-Broker" class="headerlink" title="å¯åŠ¨ Broker"></a>å¯åŠ¨ Broker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">nohup</span> sh bin/mqbroker -n localhost:9876 -c conf/broker.conf &amp;</span><br><span class="line">&gt; <span class="built_in">tail</span> -f ~/logs/rocketmqlogs/broker.log</span><br><span class="line">The broker[%s, 172.30.30.233:10911] boot success...</span><br></pre></td></tr></table></figure>

<h3 id="æ”¶å‘æ¶ˆæ¯"><a href="#æ”¶å‘æ¶ˆæ¯" class="headerlink" title="æ”¶å‘æ¶ˆæ¯"></a>æ”¶å‘æ¶ˆæ¯</h3><p>æ‰§è¡Œæ”¶å‘æ¶ˆæ¯æ“ä½œä¹‹å‰ï¼Œä¸è®¸å‘Šè¯‰å®¢æˆ·ç«¯å‘½åæœåŠ¡å™¨çš„ä½ç½®ã€‚åœ¨ RocketMQ ä¸­æœ‰å¤šç§æ–¹æ³•æ¥å®ç°è¿™ä¸ªç›®çš„ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•â€”â€”è®¾ç½®ç¯å¢ƒå˜é‡ <code>NAMESRV_ADDR</code> ï¼š</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line">&gt; sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line">SendResult [sendStatus=SEND_OK, msgId= ...</span><br><span class="line"></span><br><span class="line">&gt; sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br><span class="line">ConsumeMessageThread_%d Receive New Messages: [MessageExt...</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="å…³é—­æœåŠ¡å™¨"><a href="#å…³é—­æœåŠ¡å™¨" class="headerlink" title="å…³é—­æœåŠ¡å™¨"></a>å…³é—­æœåŠ¡å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; sh bin/mqshutdown broker</span><br><span class="line">The mqbroker(36695) is running...</span><br><span class="line">Send shutdown request to mqbroker(36695) OK</span><br><span class="line"></span><br><span class="line">&gt; sh bin/mqshutdown namesrv</span><br><span class="line">The mqnamesrv(36664) is running...</span><br><span class="line">Send shutdown request to mqnamesrv(36664) OK</span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ-å…¥é—¨çº§ç¤ºä¾‹"><a href="#RocketMQ-å…¥é—¨çº§ç¤ºä¾‹" class="headerlink" title="RocketMQ å…¥é—¨çº§ç¤ºä¾‹"></a>RocketMQ å…¥é—¨çº§ç¤ºä¾‹</h2><p>é¦–å…ˆåœ¨é¡¹ç›®ä¸­å¼•å…¥ maven ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><p>Producer åœ¨ RocketMQ ä¸­è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚</p>
<p>RocketMQ æœ‰ä¸‰ç§æ¶ˆæ¯å‘é€æ–¹å¼ï¼š</p>
<ul>
<li>å¯é çš„åŒæ­¥å‘é€</li>
<li>å¯é çš„å¼‚æ­¥å‘é€</li>
<li>å•é¡¹å‘é€</li>
</ul>
<h4 id="å¯é çš„åŒæ­¥å‘é€"><a href="#å¯é çš„åŒæ­¥å‘é€" class="headerlink" title="å¯é çš„åŒæ­¥å‘é€"></a>å¯é çš„åŒæ­¥å‘é€</h4><p>å¯é çš„åŒæ­¥ä¼ è¾“ç”¨äºå¹¿æ³›çš„åœºæ™¯ï¼Œå¦‚é‡è¦çš„é€šçŸ¥æ¶ˆæ¯ï¼ŒçŸ­ä¿¡é€šçŸ¥ï¼ŒçŸ­ä¿¡è¥é”€ç³»ç»Ÿç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> +</span><br><span class="line">                    i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//Call send message to deliver message to one of brokers.</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯é çš„å¼‚æ­¥å‘é€"><a href="#å¯é çš„å¼‚æ­¥å‘é€" class="headerlink" title="å¯é çš„å¼‚æ­¥å‘é€"></a>å¯é çš„å¼‚æ­¥å‘é€</h4><p>å¼‚æ­¥ä¼ è¾“é€šå¸¸ç”¨äºå“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index,</span><br><span class="line">                            sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å•å‘ä¼ è¾“"><a href="#å•å‘ä¼ è¾“" class="headerlink" title="å•å‘ä¼ è¾“"></a>å•å‘ä¼ è¾“</h4><p>å•å‘ä¼ è¾“ç”¨äºéœ€è¦ä¸­ç­‰å¯é æ€§çš„æƒ…å†µï¼Œä¾‹å¦‚æ—¥å¿—æ”¶é›†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnewayProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> +</span><br><span class="line">                    i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//Call send message to deliver message to one of brokers.</span></span><br><span class="line">            producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><p>Consumer åœ¨ RocketMQ ä¸­è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderedConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;example_group_name&quot;</span>);</span><br><span class="line">        consumer.setNamesrvAddr(RocketConfig.HOST);</span><br><span class="line"></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;TagA || TagC || TagD&quot;</span>);</span><br><span class="line"></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerOrderly</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">AtomicLong</span> <span class="variable">consumeTimes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeOrderlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span><br><span class="line"><span class="params">                ConsumeOrderlyContext context)</span> &#123;</span><br><span class="line">                context.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">                System.out.printf(Thread.currentThread().getName() + <span class="string">&quot; Receive New Messages: &quot;</span> + msgs + <span class="string">&quot;%n&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.consumeTimes.incrementAndGet();</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.ROLLBACK;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.COMMIT;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    context.setSuspendCurrentQueueTimeMillis(<span class="number">3000</span>);</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">&quot;Consumer Started.%n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ-å®˜æ–¹ç¤ºä¾‹"><a href="#RocketMQ-å®˜æ–¹ç¤ºä¾‹" class="headerlink" title="RocketMQ å®˜æ–¹ç¤ºä¾‹"></a>RocketMQ å®˜æ–¹ç¤ºä¾‹</h2><ul>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/simple-example/">Simple Example</a><ul>
<li>ä½¿ç”¨ RocketMQ é€šè¿‡ä¸‰ç§æ–¹å¼å‘é€æ¶ˆæ¯ï¼šå¯é åŒæ­¥ã€å¯é å¼‚æ­¥ã€å•å‘ä¼ è¾“ã€‚</li>
<li>ä½¿ç”¨ RocketMQ æ¶ˆè´¹æ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/order-example/">Order Example</a>ï¼šRocketMQ ä½¿ç”¨ FIFO é¡ºåºæä¾›æœ‰åºæ¶ˆæ¯ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/broadcast-example/">Broadcasting Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/schedule-example/">Schedule Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/batch-example/">Batch Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/filter-by-sql92-example/">Filter Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/logappender-example/">Logappender Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/openmessaging-example/">OpenMessaging Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/transaction-example/">Transaction Example</a></li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="http://rocketmq.apache.org/docs/quick-start/">RocketMQ å®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/453c6e7ff81c">åˆ†å¸ƒå¼å¼€æ”¾æ¶ˆæ¯ç³»ç»Ÿ(RocketMQ)çš„åŸç†ä¸å®è·µ</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/5aee88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/5aee88/" class="post-title-link" itemprop="url">ActiveMQ å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/%E5%85%B6%E4%BB%96MQ/" itemprop="url" rel="index"><span itemprop="name">å…¶ä»–MQ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>6 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ActiveMQ-å¿«é€Ÿå…¥é—¨"><a href="#ActiveMQ-å¿«é€Ÿå…¥é—¨" class="headerlink" title="ActiveMQ å¿«é€Ÿå…¥é—¨"></a>ActiveMQ å¿«é€Ÿå…¥é—¨</h1><h2 id="JMS-åŸºæœ¬æ¦‚å¿µ"><a href="#JMS-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="JMS åŸºæœ¬æ¦‚å¿µ"></a>JMS åŸºæœ¬æ¦‚å¿µ</h2><p><code>JMS</code> å³ <strong>Java æ¶ˆæ¯æœåŠ¡ï¼ˆJava Message Serviceï¼‰API</strong>ï¼Œæ˜¯ä¸€ä¸ª Java å¹³å°ä¸­å…³äºé¢å‘æ¶ˆæ¯ä¸­é—´ä»¶çš„ APIã€‚å®ƒç”¨äºåœ¨ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¹‹é—´ï¼Œæˆ–åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‘é€æ¶ˆæ¯ï¼Œè¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚Java æ¶ˆæ¯æœåŠ¡æ˜¯ä¸€ä¸ªä¸å…·ä½“å¹³å°æ— å…³çš„ APIï¼Œç»å¤§å¤šæ•° MOM æä¾›å•†éƒ½å¯¹ JMS æä¾›æ”¯æŒã€‚</p>
<h3 id="æ¶ˆæ¯æ¨¡å‹"><a href="#æ¶ˆæ¯æ¨¡å‹" class="headerlink" title="æ¶ˆæ¯æ¨¡å‹"></a>æ¶ˆæ¯æ¨¡å‹</h3><p>JMS æœ‰ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼š</p>
<ul>
<li>Point-to-Point(P2P)</li>
<li>Publish&#x2F;Subscribe(Pub&#x2F;Sub)</li>
</ul>
<h4 id="P2P-çš„ç‰¹ç‚¹"><a href="#P2P-çš„ç‰¹ç‚¹" class="headerlink" title="P2P çš„ç‰¹ç‚¹"></a>P2P çš„ç‰¹ç‚¹</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-pointToPoint.gif" alt="img"></p>
<p>åœ¨ç‚¹å¯¹ç‚¹çš„æ¶ˆæ¯ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯åˆ†å‘ç»™ä¸€ä¸ªå•ç‹¬çš„ä½¿ç”¨è€…ã€‚ç‚¹å¯¹ç‚¹æ¶ˆæ¯å¾€å¾€ä¸é˜Ÿåˆ— <code>javax.jms.Queue</code> ç›¸å…³è”ã€‚</p>
<p>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰(å³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­)ã€‚</p>
<p>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—ã€‚</p>
<p>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸã€‚</p>
<p>å¦‚æœä½ å¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½åº”è¯¥è¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆä½ éœ€è¦ P2P æ¨¡å¼ã€‚</p>
<h4 id="Pub-Sub-çš„ç‰¹ç‚¹"><a href="#Pub-Sub-çš„ç‰¹ç‚¹" class="headerlink" title="Pub&#x2F;Sub çš„ç‰¹ç‚¹"></a>Pub&#x2F;Sub çš„ç‰¹ç‚¹</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-publishSubscribe.gif" alt="img"></p>
<p>å‘å¸ƒ&#x2F;è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿæ”¯æŒä¸€ä¸ªäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å‚ä¸æ¶ˆæ¯çš„ä¼ é€’ã€‚ç”Ÿäº§è€…å‘å¸ƒäº‹ä»¶ï¼Œè€Œä½¿ç”¨è€…è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨äº‹ä»¶ã€‚è¯¥ç±»å‹æ¶ˆæ¯ä¸€èˆ¬ä¸ç‰¹å®šçš„ä¸»é¢˜ <code>javax.jms.Topic</code> å…³è”ã€‚</p>
<p>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…ã€‚</p>
<p>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯ï¼Œè€Œä¸”ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€ã€‚</p>
<p>ä¸ºäº†ç¼“å’Œè¿™æ ·ä¸¥æ ¼çš„æ—¶é—´ç›¸å…³æ€§ï¼ŒJMS å…è®¸è®¢é˜…è€…åˆ›å»ºä¸€ä¸ªå¯æŒä¹…åŒ–çš„è®¢é˜…ã€‚è¿™æ ·ï¼Œå³ä½¿è®¢é˜…è€…æ²¡æœ‰è¢«æ¿€æ´»ï¼ˆè¿è¡Œï¼‰ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœä½ å¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…è¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ Pub&#x2F;Sub æ¨¡å‹ã€‚</p>
<h3 id="JMS-ç¼–ç¨‹æ¨¡å‹"><a href="#JMS-ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="JMS ç¼–ç¨‹æ¨¡å‹"></a>JMS ç¼–ç¨‹æ¨¡å‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-publishSubscribe.gif" alt="img"></p>
<h4 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h4><p>åˆ›å»º <code>Connection</code> å¯¹è±¡çš„å·¥å‚ï¼Œé’ˆå¯¹ä¸¤ç§ä¸åŒçš„ jms æ¶ˆæ¯æ¨¡å‹ï¼Œåˆ†åˆ«æœ‰ <code>QueueConnectionFactory</code> å’Œ<code>TopicConnectionFactory</code> ä¸¤ç§ã€‚å¯ä»¥é€šè¿‡ JNDI æ¥æŸ¥æ‰¾ <code>ConnectionFactory</code> å¯¹è±¡ã€‚</p>
<h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><p><code>Connection</code> è¡¨ç¤ºåœ¨å®¢æˆ·ç«¯å’Œ JMS ç³»ç»Ÿä¹‹é—´å»ºç«‹çš„é“¾æ¥ï¼ˆå¯¹ TCP&#x2F;IP socket çš„åŒ…è£…ï¼‰ã€‚<code>Connection</code> å¯ä»¥äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ª<code>Session</code>ã€‚è·Ÿ <code>ConnectionFactory</code> ä¸€æ ·ï¼Œ<code>Connection</code> ä¹Ÿæœ‰ä¸¤ç§ç±»å‹ï¼š<code>QueueConnection</code> å’Œ <code>TopicConnection</code>ã€‚</p>
<h4 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h4><p><code>Destination</code> æ˜¯ä¸€ä¸ªåŒ…è£…äº†æ¶ˆæ¯ç›®æ ‡æ ‡è¯†ç¬¦çš„è¢«ç®¡å¯¹è±¡ã€‚æ¶ˆæ¯ç›®æ ‡æ˜¯æŒ‡æ¶ˆæ¯å‘å¸ƒå’Œæ¥æ”¶çš„åœ°ç‚¹ï¼Œæˆ–è€…æ˜¯é˜Ÿåˆ— <code>Queue</code> ï¼Œæˆ–è€…æ˜¯ä¸»é¢˜ <code>Topic</code> ã€‚JMS ç®¡ç†å‘˜åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œç„¶åç”¨æˆ·é€šè¿‡ JNDI å‘ç°å®ƒä»¬ã€‚å’Œè¿æ¥å·¥å‚ä¸€æ ·ï¼Œç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä¸¤ç§ç±»å‹çš„ç›®æ ‡ï¼Œç‚¹å¯¹ç‚¹æ¨¡å‹çš„ <code>Queue</code>ï¼Œä»¥åŠå‘å¸ƒè€…&#x2F;è®¢é˜…è€…æ¨¡å‹çš„ <code>Topic</code>ã€‚</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p><code>Session</code> è¡¨ç¤ºä¸€ä¸ªå•çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºå‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚ç”±äºä¼šè¯æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯æŒ‰ç…§å‘é€çš„é¡ºåºä¸€ä¸ªä¸€ä¸ªæ¥æ”¶çš„ã€‚ä¼šè¯çš„å¥½å¤„æ˜¯å®ƒæ”¯æŒäº‹åŠ¡ã€‚å¦‚æœç”¨æˆ·é€‰æ‹©äº†äº‹åŠ¡æ”¯æŒï¼Œä¼šè¯ä¸Šä¸‹æ–‡å°†ä¿å­˜ä¸€ç»„æ¶ˆæ¯ï¼Œç›´åˆ°äº‹åŠ¡è¢«æäº¤æ‰å‘é€è¿™äº›æ¶ˆæ¯ã€‚åœ¨æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå–æ¶ˆè¿™äº›æ¶ˆæ¯ã€‚ä¸€ä¸ªä¼šè¯å…è®¸ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯ï¼Œç”Ÿäº§è€…æ¥å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¥æ¥æ”¶æ¶ˆæ¯ã€‚åŒæ ·ï¼Œ<code>Session</code> ä¹Ÿåˆ† <code>QueueSession</code> å’Œ <code>TopicSession</code>ã€‚</p>
<h4 id="MessageConsumer"><a href="#MessageConsumer" class="headerlink" title="MessageConsumer"></a>MessageConsumer</h4><p><code>MessageConsumer</code> ç”± <code>Session</code> åˆ›å»ºï¼Œå¹¶ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ° <code>Destination</code>ã€‚æ¶ˆè´¹è€…å¯ä»¥åŒæ­¥åœ°ï¼ˆé˜»å¡æ¨¡å¼ï¼‰ï¼Œæˆ–ï¼ˆéé˜»å¡ï¼‰æ¥æ”¶ <code>Queue</code> å’Œ <code>Topic</code> ç±»å‹çš„æ¶ˆæ¯ã€‚åŒæ ·ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…åˆ†ä¸¤ç§ç±»å‹ï¼š<code>QueueSender</code> å’Œ<code>TopicPublisher</code>ã€‚</p>
<h4 id="MessageProducer"><a href="#MessageProducer" class="headerlink" title="MessageProducer"></a>MessageProducer</h4><p><code>MessageProducer</code> ç”± <code>Session</code> åˆ›å»ºï¼Œç”¨äºæ¥æ”¶è¢«å‘é€åˆ° <code>Destination</code> çš„æ¶ˆæ¯ã€‚<code>MessageProducer</code> æœ‰ä¸¤ç§ç±»å‹ï¼š<code>QueueReceiver</code> å’Œ <code>TopicSubscriber</code>ã€‚å¯åˆ†åˆ«é€šè¿‡ <code>session</code> çš„ <code>createReceiver(Queue)</code> æˆ– <code>createSubscriber(Topic)</code> æ¥åˆ›å»ºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ <code>session</code> çš„ <code>creatDurableSubscriber</code> æ–¹æ³•æ¥åˆ›å»ºæŒä¹…åŒ–çš„è®¢é˜…è€…ã€‚</p>
<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><p>æ˜¯åœ¨æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´ä¼ é€çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä»ä¸€ä¸ªåº”ç”¨ç¨‹åºä¼ é€åˆ°å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªæ¶ˆæ¯æœ‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¤´ï¼ˆå¿…é¡»ï¼‰ï¼šåŒ…å«ç”¨äºè¯†åˆ«å’Œä¸ºæ¶ˆæ¯å¯»æ‰¾è·¯ç”±çš„æ“ä½œè®¾ç½®ã€‚</li>
<li>ä¸€ç»„æ¶ˆæ¯å±æ€§ï¼ˆå¯é€‰ï¼‰ï¼šåŒ…å«é¢å¤–çš„å±æ€§ï¼Œæ”¯æŒå…¶ä»–æä¾›è€…å’Œç”¨æˆ·çš„å…¼å®¹ã€‚å¯ä»¥åˆ›å»ºå®šåˆ¶çš„å­—æ®µå’Œè¿‡æ»¤å™¨ï¼ˆæ¶ˆæ¯é€‰æ‹©å™¨ï¼‰ã€‚</li>
<li>ä¸€ä¸ªæ¶ˆæ¯ä½“ï¼ˆå¯é€‰ï¼‰ï¼šå…è®¸ç”¨æˆ·åˆ›å»ºäº”ç§ç±»å‹çš„æ¶ˆæ¯ï¼ˆæ–‡æœ¬æ¶ˆæ¯ï¼Œæ˜ å°„æ¶ˆæ¯ï¼Œå­—èŠ‚æ¶ˆæ¯ï¼Œæµæ¶ˆæ¯å’Œå¯¹è±¡æ¶ˆæ¯ï¼‰ã€‚</li>
</ul>
<p>æ¶ˆæ¯æ¥å£éå¸¸çµæ´»ï¼Œå¹¶æä¾›äº†è®¸å¤šæ–¹å¼æ¥å®šåˆ¶æ¶ˆæ¯çš„å†…å®¹ã€‚</p>
<table>
<thead>
<tr>
<th>Common</th>
<th>Point-to-Point</th>
<th>Publish-Subscribe</th>
</tr>
</thead>
<tbody><tr>
<td>ConnectionFactory</td>
<td>QueueConnectionFactory</td>
<td>TopicConnectionFactory</td>
</tr>
<tr>
<td>Connection</td>
<td>QueueConnection</td>
<td>TopicConnection</td>
</tr>
<tr>
<td>Destination</td>
<td>Queue</td>
<td>Topic</td>
</tr>
<tr>
<td>Session</td>
<td>QueueSession</td>
<td>TopicSession</td>
</tr>
<tr>
<td>MessageProducer</td>
<td>QueueSender</td>
<td>TopicPublisher</td>
</tr>
<tr>
<td>MessageSender</td>
<td>QueueReceiver, QueueBrowser</td>
<td>TopicSubscriber</td>
</tr>
</tbody></table>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p><strong>å®‰è£…æ¡ä»¶</strong></p>
<p>JDK1.7 åŠä»¥ä¸Šç‰ˆæœ¬</p>
<p>æœ¬åœ°é…ç½®äº† <strong>JAVA_HOME</strong> ç¯å¢ƒå˜é‡ã€‚</p>
<p><strong>ä¸‹è½½</strong></p>
<p>æ”¯æŒ Windows&#x2F;Unix&#x2F;Linux&#x2F;Cygwin</p>
<p><a target="_blank" rel="noopener" href="http://activemq.apache.org/download.html">ActiveMQ å®˜æ–¹ä¸‹è½½åœ°å€</a></p>
<p><strong>Windows ä¸‹è¿è¡Œ</strong></p>
<p>ï¼ˆ1ï¼‰è§£å‹å‹ç¼©åŒ…åˆ°æœ¬åœ°ï¼›</p>
<p>ï¼ˆ2ï¼‰æ‰“å¼€æ§åˆ¶å°ï¼Œè¿›å…¥å®‰è£…ç›®å½•çš„ <code>bin</code> ç›®å½•ä¸‹ï¼›</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cd</span><span class="meta"> [activemq_install_dir]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰æ‰§è¡Œ <code>activemq start</code> æ¥å¯åŠ¨ ActiveMQ</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\activemq <span class="literal">start</span></span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ</strong></p>
<p>ï¼ˆ1ï¼‰ActiveMQ é»˜è®¤ç›‘å¬ç«¯å£ä¸º 61616</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|<span class="built_in">find</span> â€œ61616â€</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—® <a target="_blank" rel="noopener" href="http://127.0.0.1:8161/admin/">http://127.0.0.1:8161/admin/</a></p>
<p>ï¼ˆ3ï¼‰è¾“å…¥ç”¨æˆ·åã€å¯†ç </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Login</span>: <span class="keyword">admin</span></span><br><span class="line">Passwort: <span class="keyword">admin</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰ç‚¹å‡»å¯¼èˆªæ çš„ Queues èœå•</p>
<p>ï¼ˆ5ï¼‰æ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆqueueï¼‰</p>
<h2 id="é¡¹ç›®ä¸­çš„åº”ç”¨"><a href="#é¡¹ç›®ä¸­çš„åº”ç”¨" class="headerlink" title="é¡¹ç›®ä¸­çš„åº”ç”¨"></a>é¡¹ç›®ä¸­çš„åº”ç”¨</h2><p><strong>å¼•å…¥ä¾èµ–</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Sender.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SEND_NUMBER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ï¼šè¿æ¥å·¥å‚ï¼ŒJMS ç”¨å®ƒåˆ›å»ºè¿æ¥</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ï¼šJMS å®¢æˆ·ç«¯åˆ°JMS Provider çš„è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Sessionï¼š ä¸€ä¸ªå‘é€æˆ–æ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ï¼šæ¶ˆæ¯çš„ç›®çš„åœ°;æ¶ˆæ¯å‘é€ç»™è°.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// MessageProducerï¼šæ¶ˆæ¯å‘é€è€…</span></span><br><span class="line">        MessageProducer producer;</span><br><span class="line">        <span class="comment">// TextMessage message;</span></span><br><span class="line">        <span class="comment">// æ„é€ ConnectionFactoryå®ä¾‹å¯¹è±¡ï¼Œæ­¤å¤„é‡‡ç”¨ActiveMqçš„å®ç°jar</span></span><br><span class="line">        connectionFactory = <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">&quot;tcp://localhost:61616&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ„é€ ä»å·¥å‚å¾—åˆ°è¿æ¥å¯¹è±¡</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// å¯åŠ¨</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// è·å–æ“ä½œè¿æ¥</span></span><br><span class="line">            session = connection.createSession(Boolean.TRUE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// è·å–sessionæ³¨æ„å‚æ•°å€¼xingbo.xu-queueæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„queueï¼Œé¡»åœ¨åœ¨ActiveMqçš„consoleé…ç½®</span></span><br><span class="line">            destination = session.createQueue(<span class="string">&quot;FirstQueue&quot;</span>);</span><br><span class="line">            <span class="comment">// å¾—åˆ°æ¶ˆæ¯ç”Ÿæˆè€…ã€å‘é€è€…ã€‘</span></span><br><span class="line">            producer = session.createProducer(destination);</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸æŒä¹…åŒ–ï¼Œæ­¤å¤„å­¦ä¹ ï¼Œå®é™…æ ¹æ®é¡¹ç›®å†³å®š</span></span><br><span class="line">            producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">            <span class="comment">// æ„é€ æ¶ˆæ¯ï¼Œæ­¤å¤„å†™æ­»ï¼Œé¡¹ç›®å°±æ˜¯å‚æ•°ï¼Œæˆ–è€…æ–¹æ³•è·å–</span></span><br><span class="line">            sendMessage(session, producer);</span><br><span class="line">            session.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(Session session, MessageProducer producer)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= SEND_NUMBER; i++) &#123;</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> session</span><br><span class="line">                    .createTextMessage(<span class="string">&quot;ActiveMq å‘é€çš„æ¶ˆæ¯&quot;</span> + i);</span><br><span class="line">            <span class="comment">// å‘é€æ¶ˆæ¯åˆ°ç›®çš„åœ°æ–¹</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å‘é€æ¶ˆæ¯ï¼š&quot;</span> + <span class="string">&quot;ActiveMq å‘é€çš„æ¶ˆæ¯&quot;</span> + i);</span><br><span class="line">            producer.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Receiver.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Receiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ï¼šè¿æ¥å·¥å‚ï¼ŒJMS ç”¨å®ƒåˆ›å»ºè¿æ¥</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ï¼šJMS å®¢æˆ·ç«¯åˆ°JMS Provider çš„è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Sessionï¼š ä¸€ä¸ªå‘é€æˆ–æ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ï¼šæ¶ˆæ¯çš„ç›®çš„åœ°;æ¶ˆæ¯å‘é€ç»™è°.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯æ¥æ”¶è€…</span></span><br><span class="line">        MessageConsumer consumer;</span><br><span class="line">        connectionFactory = <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">&quot;tcp://localhost:61616&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ„é€ ä»å·¥å‚å¾—åˆ°è¿æ¥å¯¹è±¡</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// å¯åŠ¨</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// è·å–æ“ä½œè¿æ¥</span></span><br><span class="line">            session = connection.createSession(Boolean.FALSE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// è·å–sessionæ³¨æ„å‚æ•°å€¼xingbo.xu-queueæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„queueï¼Œé¡»åœ¨åœ¨ActiveMqçš„consoleé…ç½®</span></span><br><span class="line">            destination = session.createQueue(<span class="string">&quot;FirstQueue&quot;</span>);</span><br><span class="line">            consumer = session.createConsumer(destination);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//è®¾ç½®æ¥æ”¶è€…æ¥æ”¶æ¶ˆæ¯çš„æ—¶é—´ï¼Œä¸ºäº†ä¾¿äºæµ‹è¯•ï¼Œè¿™é‡Œè°å®šä¸º100s</span></span><br><span class="line">                <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> (TextMessage) consumer.receive(<span class="number">100000</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != message) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯&quot;</span> + message.getText());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿è¡Œ</strong></p>
<p>å…ˆè¿è¡Œ Receiver.java è¿›è¡Œæ¶ˆæ¯ç›‘å¬ï¼Œå†è¿è¡Œ Send.java å‘é€æ¶ˆæ¯ã€‚</p>
<p><strong>è¾“å‡º</strong></p>
<p>Send çš„è¾“å‡ºå†…å®¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯0</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯1</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯2</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯3</span><br></pre></td></tr></table></figure>

<p>Receiver çš„è¾“å‡ºå†…å®¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯0</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯1</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯2</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯3</span><br></pre></td></tr></table></figure>

<h2 id="èµ„æº"><a href="#èµ„æº" class="headerlink" title="èµ„æº"></a>èµ„æº</h2><ul>
<li><a target="_blank" rel="noopener" href="http://activemq.apache.org/">ActiveMQ å®˜ç½‘</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19575-01/819-3669/6n5sg7cgq/index.html">oracle å®˜æ–¹çš„ jms ä»‹ç»</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/3a499f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/3a499f/" class="post-title-link" itemprop="url">Dubbo å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/RPC/Dubbo/" itemprop="url" rel="index"><span itemprop="name">Dubbo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>21 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Dubbo-å¿«é€Ÿå…¥é—¨"><a href="#Dubbo-å¿«é€Ÿå…¥é—¨" class="headerlink" title="Dubbo å¿«é€Ÿå…¥é—¨"></a>Dubbo å¿«é€Ÿå…¥é—¨</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh-cn/">Apache Dubbo</a> æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€è½»é‡çº§çš„å¼€æº Java RPC æ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šé¢å‘æ¥å£çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ™ºèƒ½å®¹é”™å’Œè´Ÿè½½å‡è¡¡ï¼Œä»¥åŠæœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°ã€‚</p>
</blockquote>
<h2 id="ä¸€ã€Dubbo-ç®€ä»‹"><a href="#ä¸€ã€Dubbo-ç®€ä»‹" class="headerlink" title="ä¸€ã€Dubbo ç®€ä»‹"></a>ä¸€ã€Dubbo ç®€ä»‹</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh-cn/">Apache Dubbo</a> æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€è½»é‡çº§çš„å¼€æº Java RPC æ¡†æ¶ã€‚</p>
<p>Dubbo æä¾›äº†ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›ï¼š</p>
<ul>
<li>é¢å‘æ¥å£çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨</li>
<li>æ™ºèƒ½å®¹é”™å’Œè´Ÿè½½å‡è¡¡</li>
<li>æœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°</li>
</ul>
<h3 id="RPC-åŸç†ç®€ä»‹"><a href="#RPC-åŸç†ç®€ä»‹" class="headerlink" title="RPC åŸç†ç®€ä»‹"></a>RPC åŸç†ç®€ä»‹</h3><h4 id="ä»€ä¹ˆæ˜¯-RPC"><a href="#ä»€ä¹ˆæ˜¯-RPC" class="headerlink" title="ä»€ä¹ˆæ˜¯ RPC"></a>ä»€ä¹ˆæ˜¯ RPC</h4><p>RPCï¼ˆRemote Procedure Callï¼‰ï¼Œå³è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚æ¯”å¦‚ä¸¤ä¸ªä¸åŒçš„æœåŠ¡ Aã€B éƒ¨ç½²åœ¨ä¸¤å°ä¸åŒçš„æœºå™¨ä¸Šï¼Œé‚£ä¹ˆæœåŠ¡ A å¦‚æœæƒ³è¦è°ƒç”¨æœåŠ¡ B ä¸­çš„æŸä¸ªæ–¹æ³•è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä½¿ç”¨ HTTP è¯·æ±‚ å½“ç„¶å¯ä»¥ï¼Œä½†æ˜¯å¯èƒ½ä¼šæ¯”è¾ƒæ…¢è€Œä¸”ä¸€äº›ä¼˜åŒ–åšçš„å¹¶ä¸å¥½ã€‚ RPC çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h4 id="RPC-å·¥ä½œæµç¨‹"><a href="#RPC-å·¥ä½œæµç¨‹" class="headerlink" title="RPC å·¥ä½œæµç¨‹"></a>RPC å·¥ä½œæµç¨‹</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200305121252.jpg" alt="img"></p>
<ol>
<li>æœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆclientï¼‰è°ƒç”¨ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡ï¼›</li>
<li>client stub æ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼›</li>
<li>client stub æ‰¾åˆ°æœåŠ¡åœ°å€ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼›</li>
<li>server stub æ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç ï¼›</li>
<li>server stub æ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ï¼›</li>
<li>æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™ server stubï¼›</li>
<li>server stub å°†è¿”å›ç»“æœæ‰“åŒ…æˆæ¶ˆæ¯å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹ï¼›</li>
<li>client stub æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç ï¼›</li>
<li>æœåŠ¡æ¶ˆè´¹æ–¹å¾—åˆ°æœ€ç»ˆç»“æœã€‚</li>
</ol>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-Dubbo"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-Dubbo" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ Dubbo"></a>ä¸ºä»€ä¹ˆéœ€è¦ Dubbo</h3><p><strong>å¦‚æœä½ è¦å¼€å‘åˆ†å¸ƒå¼ç¨‹åºï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥åŸºäº HTTP æ¥å£è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨ Dubbo å‘¢ï¼Ÿ</strong></p>
<p>æˆ‘è§‰å¾—ä¸»è¦å¯ä»¥ä» Dubbo æä¾›çš„ä¸‹é¢å››ç‚¹ç‰¹æ€§æ¥è¯´ä¸ºä»€ä¹ˆè¦ç”¨ Dubboï¼š</p>
<ol>
<li><strong>è´Ÿè½½å‡è¡¡</strong>â€”â€”åŒä¸€ä¸ªæœåŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨æ—¶è¯¥è°ƒç”¨é‚£ä¸€å°æœºå™¨ä¸Šçš„æœåŠ¡ã€‚</li>
<li><strong>æœåŠ¡è°ƒç”¨é“¾è·¯</strong>â€”â€”éšç€ç³»ç»Ÿçš„å‘å±•ï¼ŒæœåŠ¡è¶Šæ¥è¶Šå¤šï¼ŒæœåŠ¡é—´ä¾èµ–å…³ç³»å˜å¾—é”™è¸ªå¤æ‚ï¼Œç”šè‡³åˆ†ä¸æ¸…å“ªä¸ªåº”ç”¨è¦åœ¨å“ªä¸ªåº”ç”¨ä¹‹å‰å¯åŠ¨ï¼Œæ¶æ„å¸ˆéƒ½ä¸èƒ½å®Œæ•´çš„æè¿°åº”ç”¨çš„æ¶æ„å…³ç³»ã€‚Dubbo å¯ä»¥ä¸ºæˆ‘ä»¬è§£å†³æœåŠ¡ä¹‹é—´äº’ç›¸æ˜¯å¦‚ä½•è°ƒç”¨çš„ã€‚</li>
<li><strong>æœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡ã€èµ„æºè°ƒåº¦å’Œæ²»ç†</strong>â€”â€”åŸºäºè®¿é—®å‹åŠ›å®æ—¶ç®¡ç†é›†ç¾¤å®¹é‡ï¼Œæé«˜é›†ç¾¤åˆ©ç”¨ç‡ã€‚</li>
<li><strong>æœåŠ¡æ²»ç†</strong>â€”â€”æŸä¸ªæœåŠ¡æŒ‚æ‰ä¹‹åè°ƒç”¨å¤‡ç”¨æœåŠ¡ã€‚</li>
</ol>
<p>å¦å¤–ï¼ŒDubbo é™¤äº†èƒ½å¤Ÿåº”ç”¨åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¹Ÿå¯ä»¥åº”ç”¨åœ¨ç°åœ¨æ¯”è¾ƒç«çš„å¾®æœåŠ¡ç³»ç»Ÿä¸­ã€‚ä¸è¿‡ï¼Œç”±äº Spring Cloud åœ¨å¾®æœåŠ¡ä¸­åº”ç”¨æ›´åŠ å¹¿æ³›ï¼Œæ‰€ä»¥ï¼Œæˆ‘è§‰å¾—ä¸€èˆ¬æˆ‘ä»¬æ Dubbo çš„è¯ï¼Œå¤§éƒ¨åˆ†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æƒ…å†µã€‚</p>
<h2 id="äºŒã€QuickStart"><a href="#äºŒã€QuickStart" class="headerlink" title="äºŒã€QuickStart"></a>äºŒã€QuickStart</h2><p>ï¼ˆ1ï¼‰æ·»åŠ  maven ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰å®šä¹‰ Provider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DemoService</span> &#123;</span><br><span class="line">    String <span class="title function_">sayHello</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰å®ç° Provider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo.provider;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DemoService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰é…ç½® Provider</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;demo-provider&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;demoService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.dubbo.demo.provider.DemoServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ5ï¼‰å¯åŠ¨ Provider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;META-INF/spring/dubbo-demo-provider.xml&quot;</span>&#125;);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="comment">// press any key to exit</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ6ï¼‰é…ç½® Consumer</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;demo-consumer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ7ï¼‰å¯åŠ¨ Consumer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;META-INF/spring/dubbo-demo-consumer.xml&quot;</span>&#125;);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="comment">// obtain proxy object for remote invocation</span></span><br><span class="line">        <span class="type">DemoService</span> <span class="variable">demoService</span> <span class="operator">=</span> (DemoService) context.getBean(<span class="string">&quot;demoService&quot;</span>);</span><br><span class="line">        <span class="comment">// execute remote invocation</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> demoService.sayHello(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        <span class="comment">// show the result</span></span><br><span class="line">        System.out.println(hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€Dubbo-é…ç½®"><a href="#ä¸‰ã€Dubbo-é…ç½®" class="headerlink" title="ä¸‰ã€Dubbo é…ç½®"></a>ä¸‰ã€Dubbo é…ç½®</h2><p>Dubbo æ‰€æœ‰é…ç½®æœ€ç»ˆéƒ½å°†è½¬æ¢ä¸º URL è¡¨ç¤ºï¼Œå¹¶ç”±æœåŠ¡æä¾›æ–¹ç”Ÿæˆï¼Œç»æ³¨å†Œä¸­å¿ƒä¼ é€’ç»™æ¶ˆè´¹æ–¹ï¼Œå„å±æ€§å¯¹åº” URL çš„å‚æ•°ï¼Œå‚è§é…ç½®é¡¹ä¸€è§ˆè¡¨ä¸­çš„ â€œå¯¹åº” URL å‚æ•°â€ åˆ—ã€‚</p>
<p>åªæœ‰ groupï¼Œinterfaceï¼Œversion æ˜¯æœåŠ¡çš„åŒ¹é…æ¡ä»¶ï¼Œä¸‰è€…å†³å®šæ˜¯ä¸æ˜¯åŒä¸€ä¸ªæœåŠ¡ï¼Œå…¶å®ƒé…ç½®é¡¹å‡ä¸ºè°ƒä¼˜å’Œæ²»ç†å‚æ•°ã€‚</p>
<p>URL æ ¼å¼ï¼š<code>protocol://username:password@host:port/path?key=value&amp;key=value</code></p>
<h3 id="é…ç½®æ–¹å¼"><a href="#é…ç½®æ–¹å¼" class="headerlink" title="é…ç½®æ–¹å¼"></a>é…ç½®æ–¹å¼</h3><p>Dubbo æ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼š</p>
<ul>
<li>xml é…ç½®</li>
<li>properties é…ç½®</li>
<li>API é…ç½®</li>
<li>æ³¨è§£é…ç½®</li>
</ul>
<p>å¦‚æœåŒæ—¶å­˜åœ¨å¤šç§é…ç½®æ–¹å¼ï¼Œéµå¾ªä»¥ä¸‹è¦†ç›–ç­–ç•¥ï¼š</p>
<ul>
<li>JVM å¯åŠ¨ -D å‚æ•°ä¼˜å…ˆï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨æˆ·åœ¨éƒ¨ç½²å’Œå¯åŠ¨æ—¶è¿›è¡Œå‚æ•°é‡å†™ï¼Œæ¯”å¦‚åœ¨å¯åŠ¨æ—¶éœ€æ”¹å˜åè®®çš„ç«¯å£ã€‚</li>
<li>XML æ¬¡ä¹‹ï¼Œå¦‚æœåœ¨ XML ä¸­æœ‰é…ç½®ï¼Œåˆ™ dubbo.properties ä¸­çš„ç›¸åº”é…ç½®é¡¹æ— æ•ˆã€‚</li>
<li>Properties æœ€åï¼Œç›¸å½“äºç¼ºçœå€¼ï¼Œåªæœ‰ XML æ²¡æœ‰é…ç½®æ—¶ï¼Œdubbo.properties çš„ç›¸åº”é…ç½®é¡¹æ‰ä¼šç”Ÿæ•ˆï¼Œé€šå¸¸ç”¨äºå…±äº«å…¬å…±é…ç½®ï¼Œæ¯”å¦‚åº”ç”¨åã€‚</li>
</ul>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboé…ç½®è¦†ç›–ç­–ç•¥.jpg" width="300"/>
</div>

<h4 id="xml-é…ç½®"><a href="#xml-é…ç½®" class="headerlink" title="xml é…ç½®"></a>xml é…ç½®</h4><p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æä¾›æ–¹åº”ç”¨ä¿¡æ¯ï¼Œç”¨äºè®¡ç®—ä¾èµ–å…³ç³» --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;hello-world-app&quot;</span>  /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ä½¿ç”¨ multicast å¹¿æ’­æ³¨å†Œä¸­å¿ƒæš´éœ²æœåŠ¡åœ°å€ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;multicast://224.5.6.7:1234&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ç”¨ dubbo åè®®åœ¨ 20880 ç«¯å£æš´éœ²æœåŠ¡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å£°æ˜éœ€è¦æš´éœ²çš„æœåŠ¡æ¥å£ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;demoServiceLocal&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å’Œæœ¬åœ° bean ä¸€æ ·å®ç°æœåŠ¡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;demoService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.dubbo.demo.provider.DemoServiceImpl&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ç”Ÿæˆè¿œç¨‹æœåŠ¡ä»£ç†ï¼Œå¯ä»¥å’Œæœ¬åœ° bean ä¸€æ ·ä½¿ç”¨ demoService --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;demoServiceRemote&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.dubbo.demo.DemoService&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Dubbo ä¼šæŠŠä»¥ä¸Šé…ç½®é¡¹è§£ææˆä¸‹é¢çš„ URL æ ¼å¼ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">dubbo:</span>//host-ip:<span class="number">20880</span>/<span class="keyword">com</span>.alibaba.dubbo.demo.DemoService</span><br></pre></td></tr></table></figure>

<p>ç„¶ååŸºäº<a target="_blank" rel="noopener" href="http://dubbo.incubator.apache.org/zh-cn/docs/dev/SPI.html">æ‰©å±•ç‚¹è‡ªé€‚åº”æœºåˆ¶</a>ï¼Œé€šè¿‡ URL çš„ <code>dubbo://</code> åè®®å¤´è¯†åˆ«ï¼Œå°±ä¼šè°ƒç”¨ DubboProtocol çš„ export() æ–¹æ³•ï¼Œæ‰“å¼€æœåŠ¡ç«¯å£ 20880ï¼Œå°±å¯ä»¥æŠŠæœåŠ¡ demoService æš´éœ²åˆ° 20880 ç«¯å£äº†ã€‚</p>
<h4 id="properties-é…ç½®"><a href="#properties-é…ç½®" class="headerlink" title="properties é…ç½®"></a>properties é…ç½®</h4><p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo.application.name</span>=<span class="string">foo</span></span><br><span class="line"><span class="attr">dubbo.application.owner</span>=<span class="string">bar</span></span><br><span class="line"><span class="attr">dubbo.registry.address</span>=<span class="string">10.20.153.10:9090</span></span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®é¡¹"><a href="#é…ç½®é¡¹" class="headerlink" title="é…ç½®é¡¹"></a>é…ç½®é¡¹</h3><p>æ‰€æœ‰é…ç½®é¡¹åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p>
<ul>
<li>æœåŠ¡å‘ç°ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºæœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œç›®çš„æ˜¯è®©æ¶ˆè´¹æ–¹æ‰¾åˆ°æä¾›æ–¹ã€‚</li>
<li>æœåŠ¡æ²»ç†ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºæ²»ç†æœåŠ¡é—´çš„å…³ç³»ï¼Œæˆ–ä¸ºå¼€å‘æµ‹è¯•æä¾›ä¾¿åˆ©æ¡ä»¶ã€‚</li>
<li>æ€§èƒ½è°ƒä¼˜ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºè°ƒä¼˜æ€§èƒ½ï¼Œä¸åŒçš„é€‰é¡¹å¯¹æ€§èƒ½ä¼šäº§ç”Ÿå½±å“ã€‚</li>
</ul>
<p>é…ç½®é¡¹æ¸…å•ï¼š</p>
<table>
<thead>
<tr>
<th>æ ‡ç­¾</th>
<th>ç”¨é€”</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td><code>dubbo:service</code></td>
<td>æœåŠ¡é…ç½®</td>
<td>ç”¨äºæš´éœ²ä¸€ä¸ªæœåŠ¡ï¼Œå®šä¹‰æœåŠ¡çš„å…ƒä¿¡æ¯ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥ç”¨å¤šä¸ªåè®®æš´éœ²ï¼Œä¸€ä¸ªæœåŠ¡ä¹Ÿå¯ä»¥æ³¨å†Œåˆ°å¤šä¸ªæ³¨å†Œä¸­å¿ƒ</td>
</tr>
<tr>
<td><code>dubbo:reference</code></td>
<td>å¼•ç”¨é…ç½®</td>
<td>ç”¨äºåˆ›å»ºä¸€ä¸ªè¿œç¨‹æœåŠ¡ä»£ç†ï¼Œä¸€ä¸ªå¼•ç”¨å¯ä»¥æŒ‡å‘å¤šä¸ªæ³¨å†Œä¸­å¿ƒ</td>
</tr>
<tr>
<td><code>dubbo:protocol</code></td>
<td>åè®®é…ç½®</td>
<td>ç”¨äºé…ç½®æä¾›æœåŠ¡çš„åè®®ä¿¡æ¯ï¼Œåè®®ç”±æä¾›æ–¹æŒ‡å®šï¼Œæ¶ˆè´¹æ–¹è¢«åŠ¨æ¥å—</td>
</tr>
<tr>
<td><code>dubbo:application</code></td>
<td>åº”ç”¨é…ç½®</td>
<td>ç”¨äºé…ç½®å½“å‰åº”ç”¨ä¿¡æ¯ï¼Œä¸ç®¡è¯¥åº”ç”¨æ˜¯æä¾›è€…è¿˜æ˜¯æ¶ˆè´¹è€…</td>
</tr>
<tr>
<td><code>dubbo:module</code></td>
<td>æ¨¡å—é…ç½®</td>
<td>ç”¨äºé…ç½®å½“å‰æ¨¡å—ä¿¡æ¯ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>dubbo:registry</code></td>
<td>æ³¨å†Œä¸­å¿ƒé…ç½®</td>
<td>ç”¨äºé…ç½®è¿æ¥æ³¨å†Œä¸­å¿ƒç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td><code>dubbo:monitor</code></td>
<td>ç›‘æ§ä¸­å¿ƒé…ç½®</td>
<td>ç”¨äºé…ç½®è¿æ¥ç›‘æ§ä¸­å¿ƒç›¸å…³ä¿¡æ¯ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>dubbo:provider</code></td>
<td>æä¾›æ–¹é…ç½®</td>
<td>å½“ ProtocolConfig å’Œ ServiceConfig æŸå±æ€§æ²¡æœ‰é…ç½®æ—¶ï¼Œé‡‡ç”¨æ­¤ç¼ºçœå€¼ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>dubbo:consumer</code></td>
<td><code>æ¶ˆè´¹æ–¹é…ç½®</code></td>
<td><code>å½“ ReferenceConfig æŸå±æ€§æ²¡æœ‰é…ç½®æ—¶ï¼Œé‡‡ç”¨æ­¤ç¼ºçœå€¼ï¼Œå¯é€‰</code></td>
</tr>
<tr>
<td><code>dubbo:method</code></td>
<td>æ–¹æ³•é…ç½®</td>
<td>ç”¨äº ServiceConfig å’Œ ReferenceConfig æŒ‡å®šæ–¹æ³•çº§çš„é…ç½®ä¿¡æ¯</td>
</tr>
<tr>
<td><code>dubbo:argument</code></td>
<td>å‚æ•°é…ç½®</td>
<td>ç”¨äºæŒ‡å®šæ–¹æ³•å‚æ•°é…ç½®</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://dubbo.apache.org/books/dubbo-user-book/references/xml/introduction.html">å®˜æ–¹é…ç½®</a></p>
</blockquote>
<h4 id="é…ç½®ä¹‹é—´çš„å…³ç³»"><a href="#é…ç½®ä¹‹é—´çš„å…³ç³»" class="headerlink" title="é…ç½®ä¹‹é—´çš„å…³ç³»"></a>é…ç½®ä¹‹é—´çš„å…³ç³»</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboé…ç½®å…³ç³».jpg" width="600"/>
</div>

<h4 id="é…ç½®è¦†ç›–å…³ç³»"><a href="#é…ç½®è¦†ç›–å…³ç³»" class="headerlink" title="é…ç½®è¦†ç›–å…³ç³»"></a>é…ç½®è¦†ç›–å…³ç³»</h4><p>ä»¥ timeout ä¸ºä¾‹ï¼Œæ˜¾ç¤ºäº†é…ç½®çš„æŸ¥æ‰¾é¡ºåºï¼Œå…¶å®ƒ retries, loadbalance, actives ç­‰ç±»ä¼¼ï¼š</p>
<ul>
<li><strong>æ–¹æ³•çº§ä¼˜å…ˆï¼Œæ¥å£çº§æ¬¡ä¹‹ï¼Œå…¨å±€é…ç½®å†æ¬¡ä¹‹</strong>ã€‚</li>
<li><strong>å¦‚æœçº§åˆ«ä¸€æ ·ï¼Œåˆ™æ¶ˆè´¹æ–¹ä¼˜å…ˆï¼Œæä¾›æ–¹æ¬¡ä¹‹</strong>ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼ŒæœåŠ¡æä¾›æ–¹é…ç½®ï¼Œé€šè¿‡ URL ç»ç”±æ³¨å†Œä¸­å¿ƒä¼ é€’ç»™æ¶ˆè´¹æ–¹ã€‚</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboé…ç½®è¦†ç›–å…³ç³».jpg" width="500"/>
</div>
### åŠ¨æ€é…ç½®ä¸­å¿ƒ

<p>é…ç½®ä¸­å¿ƒï¼ˆv2.7.0ï¼‰åœ¨ Dubbo ä¸­æ‰¿æ‹…ä¸¤ä¸ªèŒè´£ï¼š</p>
<ol>
<li>å¤–éƒ¨åŒ–é…ç½®ã€‚å¯åŠ¨é…ç½®çš„é›†ä¸­å¼å­˜å‚¨ ï¼ˆç®€å•ç†è§£ä¸º dubbo.properties çš„å¤–éƒ¨åŒ–å­˜å‚¨ï¼‰ã€‚</li>
<li>æœåŠ¡æ²»ç†ã€‚æœåŠ¡æ²»ç†è§„åˆ™çš„å­˜å‚¨ä¸é€šçŸ¥ã€‚</li>
</ol>
<p>å¯ç”¨åŠ¨æ€é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:config-center</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dubbo.config-center.address</span>=<span class="string">zookeeper://127.0.0.1:2181</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConfigCenterConfig</span> <span class="variable">configCenter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigCenterConfig</span>();</span><br><span class="line">configCenter.setAddress(<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€Dubbo-æ¶æ„"><a href="#å››ã€Dubbo-æ¶æ„" class="headerlink" title="å››ã€Dubbo æ¶æ„"></a>å››ã€Dubbo æ¶æ„</h2><h3 id="Dubbo-æ ¸å¿ƒç»„ä»¶"><a href="#Dubbo-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="Dubbo æ ¸å¿ƒç»„ä»¶"></a>Dubbo æ ¸å¿ƒç»„ä»¶</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboåŸºæœ¬æ¶æ„.png" width="500"/>
</div>

<p>èŠ‚ç‚¹è§’è‰²ï¼š</p>
<table>
<thead>
<tr>
<th>èŠ‚ç‚¹</th>
<th>è§’è‰²è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Provider</td>
<td>æš´éœ²æœåŠ¡çš„æœåŠ¡æä¾›æ–¹</td>
</tr>
<tr>
<td>Consumer</td>
<td>è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æœåŠ¡æ¶ˆè´¹æ–¹</td>
</tr>
<tr>
<td>Registry</td>
<td>æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ³¨å†Œä¸­å¿ƒ</td>
</tr>
<tr>
<td>Monitor</td>
<td>ç»Ÿè®¡æœåŠ¡çš„è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´çš„ç›‘æ§ä¸­å¿ƒ</td>
</tr>
<tr>
<td>Container</td>
<td>æœåŠ¡è¿è¡Œå®¹å™¨</td>
</tr>
</tbody></table>
<p>è°ƒç”¨å…³ç³»ï¼š</p>
<ol>
<li>æœåŠ¡å®¹å™¨è´Ÿè´£å¯åŠ¨ï¼ŒåŠ è½½ï¼Œè¿è¡ŒæœåŠ¡æä¾›è€…ã€‚</li>
<li>æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨æ—¶ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±æä¾›çš„æœåŠ¡ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…åœ¨å¯åŠ¨æ—¶ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…è‡ªå·±æ‰€éœ€çš„æœåŠ¡ã€‚</li>
<li>æ³¨å†Œä¸­å¿ƒè¿”å›æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ç»™æ¶ˆè´¹è€…ï¼Œå¦‚æœæœ‰å˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒå°†åŸºäºé•¿è¿æ¥æ¨é€å˜æ›´æ•°æ®ç»™æ¶ˆè´¹è€…ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…ï¼Œä»æä¾›è€…åœ°å€åˆ—è¡¨ä¸­ï¼ŒåŸºäºè½¯è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‰ä¸€å°æä¾›è€…è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œå†é€‰å¦ä¸€å°è°ƒç”¨ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…ï¼Œåœ¨å†…å­˜ä¸­ç´¯è®¡è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ï¼Œå®šæ—¶æ¯åˆ†é’Ÿå‘é€ä¸€æ¬¡ç»Ÿè®¡æ•°æ®åˆ°ç›‘æ§ä¸­å¿ƒã€‚</li>
</ol>
<p><strong>é‡è¦çŸ¥è¯†ç‚¹æ€»ç»“ï¼š</strong></p>
<ul>
<li><strong>æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ï¼Œæ³¨å†Œä¸­å¿ƒä¸è½¬å‘è¯·æ±‚ï¼Œå‹åŠ›è¾ƒå°</strong></li>
<li><strong>ç›‘æ§ä¸­å¿ƒè´Ÿè´£ç»Ÿè®¡å„æœåŠ¡è°ƒç”¨æ¬¡æ•°ï¼Œè°ƒç”¨æ—¶é—´ç­‰ï¼Œç»Ÿè®¡å…ˆåœ¨å†…å­˜æ±‡æ€»åæ¯åˆ†é’Ÿä¸€æ¬¡å‘é€åˆ°ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨ï¼Œå¹¶ä»¥æŠ¥è¡¨å±•ç¤º</strong></li>
<li><strong>æ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡æä¾›è€…ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ä¸‰è€…ä¹‹é—´å‡ä¸ºé•¿è¿æ¥ï¼Œç›‘æ§ä¸­å¿ƒé™¤å¤–</strong></li>
<li><strong>æ³¨å†Œä¸­å¿ƒé€šè¿‡é•¿è¿æ¥æ„ŸçŸ¥æœåŠ¡æä¾›è€…çš„å­˜åœ¨ï¼ŒæœåŠ¡æä¾›è€…å®•æœºï¼Œæ³¨å†Œä¸­å¿ƒå°†ç«‹å³æ¨é€äº‹ä»¶é€šçŸ¥æ¶ˆè´¹è€…</strong></li>
<li><strong>æ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒå…¨éƒ¨å®•æœºï¼Œä¸å½±å“å·²è¿è¡Œçš„æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…åœ¨æœ¬åœ°ç¼“å­˜äº†æä¾›è€…åˆ—è¡¨</strong></li>
<li><strong>æ³¨å†Œä¸­å¿ƒå’Œç›‘æ§ä¸­å¿ƒéƒ½æ˜¯å¯é€‰çš„ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ç›´è¿æœåŠ¡æä¾›è€…</strong></li>
<li><strong>æœåŠ¡æä¾›è€…æ— çŠ¶æ€ï¼Œä»»æ„ä¸€å°å®•æ‰åï¼Œä¸å½±å“ä½¿ç”¨</strong></li>
<li><strong>æœåŠ¡æä¾›è€…å…¨éƒ¨å®•æ‰åï¼ŒæœåŠ¡æ¶ˆè´¹è€…åº”ç”¨å°†æ— æ³•ä½¿ç”¨ï¼Œå¹¶æ— é™æ¬¡é‡è¿ç­‰å¾…æœåŠ¡æä¾›è€…æ¢å¤</strong></li>
</ul>
<blockquote>
<p>é—®ï¼šæ³¨å†Œä¸­å¿ƒæŒ‚äº†å¯ä»¥ç»§ç»­é€šä¿¡å—ï¼Ÿ</p>
<p>ç­”ï¼šå¯ä»¥ï¼Œå› ä¸ºåˆšå¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…ä¼šå°†æä¾›è€…çš„åœ°å€ç­‰ä¿¡æ¯<strong>æ‹‰å–åˆ°æœ¬åœ°ç¼“å­˜</strong>ï¼Œæ‰€ä»¥æ³¨å†Œä¸­å¿ƒæŒ‚äº†å¯ä»¥ç»§ç»­é€šä¿¡ã€‚</p>
</blockquote>
<h3 id="Dubbo-æ¶æ„å±‚æ¬¡"><a href="#Dubbo-æ¶æ„å±‚æ¬¡" class="headerlink" title="Dubbo æ¶æ„å±‚æ¬¡"></a>Dubbo æ¶æ„å±‚æ¬¡</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboæ•´ä½“è®¾è®¡.jpg" />
</div>

<p>å›¾ä¾‹è¯´æ˜ï¼š</p>
<ul>
<li>å›¾ä¸­å·¦è¾¹æ·¡è“èƒŒæ™¯çš„ä¸ºæœåŠ¡æ¶ˆè´¹æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œå³è¾¹æ·¡ç»¿è‰²èƒŒæ™¯çš„ä¸ºæœåŠ¡æä¾›æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œä½äºä¸­è½´çº¿ä¸Šçš„ä¸ºåŒæ–¹éƒ½ç”¨åˆ°çš„æ¥å£ã€‚</li>
<li>å›¾ä¸­ä»ä¸‹è‡³ä¸Šåˆ†ä¸ºåå±‚ï¼Œå„å±‚å‡ä¸ºå•å‘ä¾èµ–ï¼Œå³è¾¹çš„é»‘è‰²ç®­å¤´ä»£è¡¨å±‚ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥å‰¥ç¦»ä¸Šå±‚è¢«å¤ç”¨ï¼Œå…¶ä¸­ï¼ŒService å’Œ Config å±‚ä¸º APIï¼Œå…¶å®ƒå„å±‚å‡ä¸º SPIã€‚</li>
<li>å›¾ä¸­ç»¿è‰²å°å—çš„ä¸ºæ‰©å±•æ¥å£ï¼Œè“è‰²å°å—ä¸ºå®ç°ç±»ï¼Œå›¾ä¸­åªæ˜¾ç¤ºç”¨äºå…³è”å„å±‚çš„å®ç°ç±»ã€‚</li>
<li>å›¾ä¸­è“è‰²è™šçº¿ä¸ºåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå³å¯åŠ¨æ—¶ç»„è£…é“¾ï¼Œçº¢è‰²å®çº¿ä¸ºæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ï¼Œå³è¿è¡Œæ—¶è°ƒæ—¶é“¾ï¼Œç´«è‰²ä¸‰è§’ç®­å¤´ä¸ºç»§æ‰¿ï¼Œå¯ä»¥æŠŠå­ç±»çœ‹ä½œçˆ¶ç±»çš„åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œçº¿ä¸Šçš„æ–‡å­—ä¸ºè°ƒç”¨çš„æ–¹æ³•ã€‚</li>
</ul>
<h4 id="å„å±‚è¯´æ˜"><a href="#å„å±‚è¯´æ˜" class="headerlink" title="å„å±‚è¯´æ˜"></a>å„å±‚è¯´æ˜</h4><ul>
<li><strong>config é…ç½®å±‚</strong>ï¼šå¯¹å¤–é…ç½®æ¥å£ï¼Œä»¥ ServiceConfig, ReferenceConfig ä¸ºä¸­å¿ƒï¼Œå¯ä»¥ç›´æ¥åˆå§‹åŒ–é…ç½®ç±»ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ spring è§£æé…ç½®ç”Ÿæˆé…ç½®ç±»</li>
<li><strong>proxy æœåŠ¡ä»£ç†å±‚</strong>ï¼šæœåŠ¡æ¥å£é€æ˜ä»£ç†ï¼Œç”ŸæˆæœåŠ¡çš„å®¢æˆ·ç«¯ Stub å’ŒæœåŠ¡å™¨ç«¯ Skeleton, ä»¥ ServiceProxy ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º ProxyFactory</li>
<li><strong>registry æ³¨å†Œä¸­å¿ƒå±‚</strong>ï¼šå°è£…æœåŠ¡åœ°å€çš„æ³¨å†Œä¸å‘ç°ï¼Œä»¥æœåŠ¡ URL ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º RegistryFactory, Registry, RegistryService</li>
<li><strong>cluster è·¯ç”±å±‚</strong>ï¼šå°è£…å¤šä¸ªæä¾›è€…çš„è·¯ç”±åŠè´Ÿè½½å‡è¡¡ï¼Œå¹¶æ¡¥æ¥æ³¨å†Œä¸­å¿ƒï¼Œä»¥ Invoker ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Cluster, Directory, Router, LoadBalance</li>
<li><strong>monitor ç›‘æ§å±‚</strong>ï¼šRPC è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ç›‘æ§ï¼Œä»¥ Statistics ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º MonitorFactory, Monitor, MonitorService</li>
<li><strong>protocol è¿œç¨‹è°ƒç”¨å±‚</strong>ï¼šå°è£… RPC è°ƒç”¨ï¼Œä»¥ Invocation, Result ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Protocol, Invoker, Exporter</li>
<li><strong>exchange ä¿¡æ¯äº¤æ¢å±‚</strong>ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Exchanger, ExchangeChannel, ExchangeClient, ExchangeServer</li>
<li><strong>transport ç½‘ç»œä¼ è¾“å±‚</strong>ï¼šæŠ½è±¡ mina å’Œ netty ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥ Message ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Channel, Transporter, Client, Server, Codec</li>
<li><strong>serialize æ•°æ®åºåˆ—åŒ–å±‚</strong>ï¼šå¯å¤ç”¨çš„ä¸€äº›å·¥å…·ï¼Œæ‰©å±•æ¥å£ä¸º Serialization, ObjectInput, ObjectOutput, ThreadPool</li>
<li><strong>serialize æ•°æ®åºåˆ—åŒ–å±‚</strong>ï¼šå¯å¤ç”¨çš„ä¸€äº›å·¥å…·ï¼Œæ‰©å±•æ¥å£ä¸º Serialization, ObjectInput, ObjectOutput, ThreadPool</li>
</ul>
<h4 id="å„å±‚å…³ç³»è¯´æ˜"><a href="#å„å±‚å…³ç³»è¯´æ˜" class="headerlink" title="å„å±‚å…³ç³»è¯´æ˜"></a>å„å±‚å…³ç³»è¯´æ˜</h4><ul>
<li>åœ¨ RPC ä¸­ï¼ŒProtocol æ˜¯æ ¸å¿ƒå±‚ï¼Œä¹Ÿå°±æ˜¯åªè¦æœ‰ Protocol + Invoker + Exporter å°±å¯ä»¥å®Œæˆéé€æ˜çš„ RPC è°ƒç”¨ï¼Œç„¶ååœ¨ Invoker çš„ä¸»è¿‡ç¨‹ä¸Š Filter æ‹¦æˆªç‚¹ã€‚</li>
<li>å›¾ä¸­çš„ Consumer å’Œ Provider æ˜¯æŠ½è±¡æ¦‚å¿µï¼Œåªæ˜¯æƒ³è®©çœ‹å›¾è€…æ›´ç›´è§‚çš„äº†è§£å“ªäº›ç±»åˆ†å±äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ï¼Œä¸ç”¨ Client å’Œ Server çš„åŸå› æ˜¯ Dubbo åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä½¿ç”¨ Provider, Consumer, Registry, Monitor åˆ’åˆ†é€»è¾‘æ‹“æ™®èŠ‚ç‚¹ï¼Œä¿æŒç»Ÿä¸€æ¦‚å¿µã€‚</li>
<li>è€Œ Cluster æ˜¯å¤–å›´æ¦‚å¿µï¼Œæ‰€ä»¥ Cluster çš„ç›®çš„æ˜¯å°†å¤šä¸ª Invoker ä¼ªè£…æˆä¸€ä¸ª Invokerï¼Œè¿™æ ·å…¶å®ƒäººåªè¦å…³æ³¨ Protocol å±‚ Invoker å³å¯ï¼ŒåŠ ä¸Š Cluster æˆ–è€…å»æ‰ Cluster å¯¹å…¶å®ƒå±‚éƒ½ä¸ä¼šé€ æˆå½±å“ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªæä¾›è€…æ—¶ï¼Œæ˜¯ä¸éœ€è¦ Cluster çš„ã€‚</li>
<li>Proxy å±‚å°è£…äº†æ‰€æœ‰æ¥å£çš„é€æ˜åŒ–ä»£ç†ï¼Œè€Œåœ¨å…¶å®ƒå±‚éƒ½ä»¥ Invoker ä¸ºä¸­å¿ƒï¼Œåªæœ‰åˆ°äº†æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨æ—¶ï¼Œæ‰ç”¨ Proxy å°† Invoker è½¬æˆæ¥å£ï¼Œæˆ–å°†æ¥å£å®ç°è½¬æˆ Invokerï¼Œä¹Ÿå°±æ˜¯å»æ‰ Proxy å±‚ RPC æ˜¯å¯ä»¥ Run çš„ï¼Œåªæ˜¯ä¸é‚£ä¹ˆé€æ˜ï¼Œä¸é‚£ä¹ˆçœ‹èµ·æ¥åƒè°ƒæœ¬åœ°æœåŠ¡ä¸€æ ·è°ƒè¿œç¨‹æœåŠ¡ã€‚</li>
<li>è€Œ Remoting å®ç°æ˜¯ Dubbo åè®®çš„å®ç°ï¼Œå¦‚æœä½ é€‰æ‹© RMI åè®®ï¼Œæ•´ä¸ª Remoting éƒ½ä¸ä¼šç”¨ä¸Šï¼ŒRemoting å†…éƒ¨å†åˆ’ä¸º Transport ä¼ è¾“å±‚å’Œ Exchange ä¿¡æ¯äº¤æ¢å±‚ï¼ŒTransport å±‚åªè´Ÿè´£å•å‘æ¶ˆæ¯ä¼ è¾“ï¼Œæ˜¯å¯¹ Mina, Netty, Grizzly çš„æŠ½è±¡ï¼Œå®ƒä¹Ÿå¯ä»¥æ‰©å±• UDP ä¼ è¾“ï¼Œè€Œ Exchange å±‚æ˜¯åœ¨ä¼ è¾“å±‚ä¹‹ä¸Šå°è£…äº† Request-Response è¯­ä¹‰ã€‚</li>
<li>Registry å’Œ Monitor å®é™…ä¸Šä¸ç®—ä¸€å±‚ï¼Œè€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ï¼Œåªæ˜¯ä¸ºäº†å…¨å±€æ¦‚è§ˆï¼Œç”¨å±‚çš„æ–¹å¼ç”»åœ¨ä¸€èµ·ã€‚</li>
</ul>
<h2 id="äº”ã€æœåŠ¡å‘ç°"><a href="#äº”ã€æœåŠ¡å‘ç°" class="headerlink" title="äº”ã€æœåŠ¡å‘ç°"></a>äº”ã€æœåŠ¡å‘ç°</h2><p>æœåŠ¡æä¾›è€…æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹ï¼š</p>
<p>Dubbo é…ç½®é¡¹ <code>dubbo://registry</code> å£°æ˜äº†æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼ŒDubbo ä¼šæŠŠä»¥ä¸Šé…ç½®é¡¹è§£ææˆç±»ä¼¼ä¸‹é¢çš„ URL æ ¼å¼ï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry:<span class="regexp">//mu</span>lticast:<span class="regexp">//</span><span class="number">224.5</span>.<span class="number">6.7</span>:<span class="number">1234</span><span class="regexp">/com.alibaba.dubbo.registry.RegistryService?export=URL.encode(&quot;dubbo:/</span><span class="regexp">/host-ip:20880/</span>com.alibaba.dubbo.demo.DemoService<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååŸºäºæ‰©å±•ç‚¹è‡ªé€‚åº”æœºåˆ¶ï¼Œé€šè¿‡ URL çš„â€œregistry:&#x2F;&#x2F;â€åè®®å¤´è¯†åˆ«ï¼Œå°±ä¼šè°ƒç”¨ RegistryProtocol çš„ export() æ–¹æ³•ï¼Œå°† export å‚æ•°ä¸­çš„æä¾›è€… URLï¼Œæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒã€‚</p>
<p>æœåŠ¡æ¶ˆè´¹è€…å‘ç°æœåŠ¡çš„è¿‡ç¨‹ï¼š</p>
<p>Dubbo é…ç½®é¡¹ <code>dubbo://registry</code> å£°æ˜äº†æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼Œè·ŸæœåŠ¡æ³¨å†Œçš„åŸç†ç±»ä¼¼ï¼ŒDubbo ä¹Ÿä¼šæŠŠä»¥ä¸Šé…ç½®é¡¹è§£ææˆä¸‹é¢çš„ URL æ ¼å¼ï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry:<span class="regexp">//mu</span>lticast:<span class="regexp">//</span><span class="number">224.5</span>.<span class="number">6.7</span>:<span class="number">1234</span><span class="regexp">/com.alibaba.dubbo.registry.RegistryService?refer=URL.encode(&quot;consummer:/</span><span class="regexp">/host-ip/</span>com.alibaba.dubbo.demo.DemoService<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååŸºäºæ‰©å±•ç‚¹è‡ªé€‚åº”æœºåˆ¶ï¼Œé€šè¿‡ URL çš„â€œregistry:&#x2F;&#x2F;â€åè®®å¤´è¯†åˆ«ï¼Œå°±ä¼šè°ƒç”¨ RegistryProtocol çš„ refer() æ–¹æ³•ï¼ŒåŸºäº refer å‚æ•°ä¸­çš„æ¡ä»¶ï¼ŒæŸ¥è¯¢æœåŠ¡ demoService çš„åœ°å€ã€‚</p>
<h3 id="å¯åŠ¨æ—¶æ£€æŸ¥"><a href="#å¯åŠ¨æ—¶æ£€æŸ¥" class="headerlink" title="å¯åŠ¨æ—¶æ£€æŸ¥"></a>å¯åŠ¨æ—¶æ£€æŸ¥</h3><p>Dubbo ç¼ºçœä¼šåœ¨å¯åŠ¨æ—¶æ£€æŸ¥ä¾èµ–çš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢ Spring åˆå§‹åŒ–å®Œæˆï¼Œä»¥ä¾¿ä¸Šçº¿æ—¶ï¼Œèƒ½åŠæ—©å‘ç°é—®é¢˜ï¼Œé»˜è®¤ <code>check=&quot;true&quot;</code>ã€‚</p>
<p>å¯ä»¥é€šè¿‡ xmlã€propertiesã€-D å‚æ•°ä¸‰ç§æ–¹å¼è®¾ç½®ã€‚å¯åŠ¨æ—¶æ£€æŸ¥</p>
<h2 id="å…­ã€Dubbo-åè®®"><a href="#å…­ã€Dubbo-åè®®" class="headerlink" title="å…­ã€Dubbo åè®®"></a>å…­ã€Dubbo åè®®</h2><p>Dubbo æ”¯æŒå¤šç§é€šä¿¡åè®®ï¼Œä¸åŒçš„åè®®é’ˆå¯¹ä¸åŒçš„åºåˆ—åŒ–æ–¹å¼ã€‚</p>
<h3 id="dubbo-åè®®"><a href="#dubbo-åè®®" class="headerlink" title="dubbo åè®®"></a>dubbo åè®®</h3><p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html">dubbo</a> åè®®æ˜¯ Dubbo çš„é»˜è®¤é€šä¿¡åè®®ï¼Œé‡‡ç”¨å•ä¸€é•¿è¿æ¥å’Œ NIO å¼‚æ­¥é€šä¿¡ï¼ŒåŸºäº hessian ä½œä¸ºåºåˆ—åŒ–åè®®ã€‚</p>
<p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html">dubbo</a> åè®®é€‚åˆäºå°æ•°æ®é‡å¤§å¹¶å‘çš„æœåŠ¡è°ƒç”¨ï¼Œä»¥åŠæœåŠ¡æ¶ˆè´¹è€…æœºå™¨æ•°è¿œå¤§äºæœåŠ¡æä¾›è€…æœºå™¨æ•°çš„æƒ…å†µã€‚åä¹‹ï¼ŒDubbo ç¼ºçœåè®®ä¸é€‚åˆä¼ é€å¤§æ•°æ®é‡çš„æœåŠ¡ï¼Œæ¯”å¦‚ä¼ æ–‡ä»¶ï¼Œä¼ è§†é¢‘ç­‰ï¼Œé™¤éè¯·æ±‚é‡å¾ˆä½ã€‚</p>
<p>ä¸ºäº†è¦æ”¯æŒé«˜å¹¶å‘åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯æœåŠ¡æä¾›è€…å°±å‡ å°æœºå™¨ï¼Œä½†æ˜¯æœåŠ¡æ¶ˆè´¹è€…æœ‰ä¸Šç™¾å°ï¼Œå¯èƒ½æ¯å¤©è°ƒç”¨é‡è¾¾åˆ°ä¸Šäº¿æ¬¡ï¼æ­¤æ—¶ç”¨é•¿è¿æ¥æ˜¯æœ€åˆé€‚çš„ï¼Œå°±æ˜¯è·Ÿæ¯ä¸ªæœåŠ¡æ¶ˆè´¹è€…ç»´æŒä¸€ä¸ªé•¿è¿æ¥å°±å¯ä»¥ï¼Œå¯èƒ½æ€»å…±å°± 100 ä¸ªè¿æ¥ã€‚ç„¶ååé¢ç›´æ¥åŸºäºé•¿è¿æ¥ NIO å¼‚æ­¥é€šä¿¡ï¼Œå¯ä»¥æ”¯æ’‘é«˜å¹¶å‘è¯·æ±‚ã€‚</p>
<h3 id="rmi-åè®®"><a href="#rmi-åè®®" class="headerlink" title="rmi åè®®"></a>rmi åè®®</h3><p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/rmi.html">rmi</a> - é‡‡ç”¨ JDK æ ‡å‡†çš„ <code>java.rmi.*</code> å®ç°ï¼Œé‡‡ç”¨é˜»å¡å¼çŸ­è¿æ¥å’Œ JDK æ ‡å‡†åºåˆ—åŒ–æ–¹å¼ã€‚</p>
<p>æ³¨æ„ï¼šå¦‚æœæ­£åœ¨ä½¿ç”¨ RMI æä¾›æœåŠ¡ç»™å¤–éƒ¨è®¿é—®ï¼ŒåŒæ—¶åº”ç”¨é‡Œä¾èµ–äº†è€çš„ <code>common-collections</code> åŒ…çš„æƒ…å†µä¸‹ï¼Œå­˜åœ¨ååºåˆ—åŒ–å®‰å…¨é£é™©ã€‚</p>
<h3 id="hessian-åè®®"><a href="#hessian-åè®®" class="headerlink" title="hessian åè®®"></a>hessian åè®®</h3><p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/hessian.html">hessian</a> åè®®ç”¨äºé›†æˆ Hessian çš„æœåŠ¡ï¼ŒHessian åº•å±‚é‡‡ç”¨ Http é€šè®¯ï¼Œé‡‡ç”¨ Servlet æš´éœ²æœåŠ¡ï¼ŒDubbo ç¼ºçœå†…åµŒ Jetty ä½œä¸ºæœåŠ¡å™¨å®ç°ã€‚</p>
<p>Dubbo çš„ Hessian åè®®å¯ä»¥å’ŒåŸç”Ÿ Hessian æœåŠ¡äº’æ“ä½œï¼Œå³ï¼š</p>
<ul>
<li>æä¾›è€…ç”¨ Dubbo çš„ Hessian åè®®æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹è€…ç›´æ¥ç”¨æ ‡å‡† Hessian æ¥å£è°ƒç”¨</li>
<li>æˆ–è€…æä¾›æ–¹ç”¨æ ‡å‡† Hessian æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹æ–¹ç”¨ Dubbo çš„ Hessian åè®®è°ƒç”¨ã€‚</li>
</ul>
<h3 id="thrift-åè®®"><a href="#thrift-åè®®" class="headerlink" title="thrift åè®®"></a>thrift åè®®</h3><p>å½“å‰ dubbo æ”¯æŒçš„ <a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/thrift.html">thrift</a> åè®®æ˜¯å¯¹ thrift åŸç”Ÿåè®®çš„æ‰©å±•ï¼Œåœ¨åŸç”Ÿåè®®çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€äº›é¢å¤–çš„å¤´ä¿¡æ¯ï¼Œæ¯”å¦‚ service nameï¼Œmagic number ç­‰ã€‚</p>
<p>ä½¿ç”¨ dubbo thrift åè®®åŒæ ·éœ€è¦ä½¿ç”¨ thrift çš„ idl compiler ç¼–è¯‘ç”Ÿæˆç›¸åº”çš„ java ä»£ç ï¼Œåç»­ç‰ˆæœ¬ä¸­ä¼šåœ¨è¿™æ–¹é¢åšä¸€äº›å¢å¼ºã€‚</p>
<h3 id="http-åè®®"><a href="#http-åè®®" class="headerlink" title="http åè®®"></a>http åè®®</h3><p><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/http.html">http</a> åè®®åŸºäº HTTP è¡¨å•çš„è¿œç¨‹è°ƒç”¨åè®®ï¼Œé‡‡ç”¨ Spring çš„ HttpInvoker å®ç°ã€‚</p>
<p>ä½¿ç”¨ JSON åºåˆ—åŒ–æ–¹å¼ã€‚</p>
<h3 id="webservice-åè®®"><a href="#webservice-åè®®" class="headerlink" title="webservice åè®®"></a>webservice åè®®</h3><p>åŸºäº WebService çš„è¿œç¨‹è°ƒç”¨åè®®ï¼ŒåŸºäº <a target="_blank" rel="noopener" href="http://cxf.apache.org/">Apache CXF</a> çš„ <code>frontend-simple</code> å’Œ <code>transports-http</code> å®ç°ã€‚</p>
<p>ä½¿ç”¨ SOAP åºåˆ—åŒ–æ–¹å¼ã€‚</p>
<p>å¯ä»¥å’ŒåŸç”Ÿ WebService æœåŠ¡äº’æ“ä½œï¼Œå³ï¼š</p>
<ul>
<li>æä¾›è€…ç”¨ Dubbo çš„ WebService åè®®æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹è€…ç›´æ¥ç”¨æ ‡å‡† WebService æ¥å£è°ƒç”¨ï¼Œ</li>
<li>æˆ–è€…æä¾›æ–¹ç”¨æ ‡å‡† WebService æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹æ–¹ç”¨ Dubbo çš„ WebService åè®®è°ƒç”¨ã€‚</li>
</ul>
<h3 id="rest-åè®®"><a href="#rest-åè®®" class="headerlink" title="rest åè®®"></a>rest åè®®</h3><p>åŸºäºæ ‡å‡†çš„ Java REST APIâ€”â€”JAX-RS 2.0ï¼ˆJava API for RESTful Web Services çš„ç®€å†™ï¼‰å®ç°çš„ REST è°ƒç”¨æ”¯æŒ</p>
<h3 id="memcached-åè®®"><a href="#memcached-åè®®" class="headerlink" title="memcached åè®®"></a>memcached åè®®</h3><p>åŸºäº memcached å®ç°çš„ RPC åè®®ã€‚</p>
<h3 id="redis-åè®®"><a href="#redis-åè®®" class="headerlink" title="redis åè®®"></a>redis åè®®</h3><p>åŸºäº redis å®ç°çš„ RPC åè®®ã€‚</p>
<blockquote>
<p>åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œåºåˆ—åŒ–æœ‰å¤šç§æ–¹å¼ã€‚</p>
<p>JDK è‡ªèº«æä¾›çš„åºåˆ—åŒ–æ–¹å¼ï¼Œæ•ˆç‡ä¸é«˜ï¼Œä½†æ˜¯ Java ç¨‹åºä½¿ç”¨æœ€å¤šã€‚</p>
<p>å¦‚æœæƒ³è¦è¾ƒå¥½çš„å¯è¯»æ€§ï¼Œå¯ä»¥ä½¿ç”¨ JSON ï¼ˆå¸¸è§åº“æœ‰ï¼š<a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson">jackson</a>ã€<a target="_blank" rel="noopener" href="https://github.com/google/gson">gson</a>ã€<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson">fastjson</a>ï¼‰æˆ– SOAP ï¼ˆå³ xml å½¢å¼ï¼‰</p>
<p>å¦‚æœæƒ³è¦æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/apache/thrift">thrift</a>ã€<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">protobuf</a>ã€<a target="_blank" rel="noopener" href="http://hessian.caucho.com/doc/hessian-overview.xtp">hessian</a></p>
<p>æƒ³æ·±å…¥äº†è§£å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/dunwu/java-tutorial/blob/master/docs/lib/serialized">åºåˆ—åŒ–</a></p>
</blockquote>
<h2 id="ä¸ƒã€é›†ç¾¤å®¹é”™"><a href="#ä¸ƒã€é›†ç¾¤å®¹é”™" class="headerlink" title="ä¸ƒã€é›†ç¾¤å®¹é”™"></a>ä¸ƒã€é›†ç¾¤å®¹é”™</h2><p>åœ¨é›†ç¾¤è°ƒç”¨å¤±è´¥æ—¶ï¼ŒDubbo æä¾›äº†å¤šç§å®¹é”™æ–¹æ¡ˆï¼Œç¼ºçœä¸º failover é‡è¯•ã€‚</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboé›†ç¾¤å®¹é”™.jpg" />
</div>

<ul>
<li><strong>Failover</strong> - <strong>å¤±è´¥è‡ªåŠ¨åˆ‡æ¢</strong>ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºè¯»æ“ä½œï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡ retries&#x3D;â€2â€ æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚</li>
<li><strong>Failfast</strong> - <strong>å¿«é€Ÿå¤±è´¥</strong>ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ã€‚é€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚</li>
<li><strong>Failsafe</strong> - <strong>å¤±è´¥å®‰å…¨</strong>ï¼Œå‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚</li>
<li><strong>Failback</strong> - <strong>å¤±è´¥è‡ªåŠ¨æ¢å¤</strong>ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚</li>
<li><strong>Forking</strong> - <strong>å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨</strong>ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡ forks&#x3D;â€2â€ æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚</li>
<li><strong>Broadcast</strong> - <strong>å¹¿æ’­è°ƒç”¨æ‰€æœ‰æä¾›è€…</strong>ï¼Œé€ä¸ªè°ƒç”¨ï¼Œä»»æ„ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚é€šå¸¸ç”¨äºé€šçŸ¥æ‰€æœ‰æä¾›è€…æ›´æ–°ç¼“å­˜æˆ–æ—¥å¿—ç­‰æœ¬åœ°èµ„æºä¿¡æ¯ã€‚</li>
</ul>
<p>é›†ç¾¤å®¹é”™é…ç½®ç¤ºä¾‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failsafe&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">&quot;failsafe&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="å…«ã€è´Ÿè½½å‡è¡¡"><a href="#å…«ã€è´Ÿè½½å‡è¡¡" class="headerlink" title="å…«ã€è´Ÿè½½å‡è¡¡"></a>å…«ã€è´Ÿè½½å‡è¡¡</h2><p>Dubbo æä¾›äº†å¤šç§è´Ÿè½½å‡è¡¡ï¼ˆLoadBalanceï¼‰ç­–ç•¥ï¼Œç¼ºçœä¸º <code>Random</code> éšæœºè°ƒç”¨ã€‚</p>
<p>Dubbo çš„è´Ÿè½½å‡è¡¡é…ç½®å¯ä»¥ç»†ç²’åº¦åˆ°æœåŠ¡ã€æ–¹æ³•çº§åˆ«ï¼Œä¸” <code>dubbo:service</code> å’Œ <code>dubbo:reference</code> å‡å¯é…ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æœåŠ¡ç«¯æœåŠ¡çº§åˆ« --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;...&quot;</span> <span class="attr">loadbalance</span>=<span class="string">&quot;roundrobin&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å®¢æˆ·ç«¯æœåŠ¡çº§åˆ« --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">&quot;...&quot;</span> <span class="attr">loadbalance</span>=<span class="string">&quot;roundrobin&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æœåŠ¡ç«¯æ–¹æ³•çº§åˆ« --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:method</span> <span class="attr">name</span>=<span class="string">&quot;...&quot;</span> <span class="attr">loadbalance</span>=<span class="string">&quot;roundrobin&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dubbo:service</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å®¢æˆ·ç«¯æ–¹æ³•çº§åˆ« --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:method</span> <span class="attr">name</span>=<span class="string">&quot;...&quot;</span> <span class="attr">loadbalance</span>=<span class="string">&quot;roundrobin&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dubbo:reference</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Random"><a href="#Random" class="headerlink" title="Random"></a>Random</h4><ul>
<li><strong>éšæœº</strong>ï¼ŒæŒ‰æƒé‡è®¾ç½®éšæœºæ¦‚ç‡ã€‚</li>
<li>åœ¨ä¸€ä¸ªæˆªé¢ä¸Šç¢°æ’çš„æ¦‚ç‡é«˜ï¼Œä½†è°ƒç”¨é‡è¶Šå¤§åˆ†å¸ƒè¶Šå‡åŒ€ï¼Œè€Œä¸”æŒ‰æ¦‚ç‡ä½¿ç”¨æƒé‡åä¹Ÿæ¯”è¾ƒå‡åŒ€ï¼Œæœ‰åˆ©äºåŠ¨æ€è°ƒæ•´æä¾›è€…æƒé‡ã€‚</li>
</ul>
<h4 id="RoundRobin"><a href="#RoundRobin" class="headerlink" title="RoundRobin"></a>RoundRobin</h4><ul>
<li><strong>è½®è¯¢</strong>ï¼ŒæŒ‰å…¬çº¦åçš„æƒé‡è®¾ç½®è½®è¯¢æ¯”ç‡ã€‚</li>
<li>å­˜åœ¨æ…¢çš„æä¾›è€…ç´¯ç§¯è¯·æ±‚çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼šç¬¬äºŒå°æœºå™¨å¾ˆæ…¢ï¼Œä½†æ²¡æŒ‚ï¼Œå½“è¯·æ±‚è°ƒåˆ°ç¬¬äºŒå°æ—¶å°±å¡åœ¨é‚£ï¼Œä¹…è€Œä¹…ä¹‹ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¡åœ¨è°ƒåˆ°ç¬¬äºŒå°ä¸Šã€‚</li>
</ul>
<h4 id="LeastActive"><a href="#LeastActive" class="headerlink" title="LeastActive"></a>LeastActive</h4><ul>
<li><strong>æœ€å°‘æ´»è·ƒè°ƒç”¨æ•°</strong>ï¼Œç›¸åŒæ´»è·ƒæ•°çš„éšæœºï¼Œæ´»è·ƒæ•°æŒ‡è°ƒç”¨å‰åè®¡æ•°å·®ã€‚</li>
<li>ä½¿æ…¢çš„æä¾›è€…æ”¶åˆ°æ›´å°‘è¯·æ±‚ï¼Œå› ä¸ºè¶Šæ…¢çš„æä¾›è€…çš„è°ƒç”¨å‰åè®¡æ•°å·®ä¼šè¶Šå¤§ã€‚</li>
</ul>
<h4 id="ConsistentHash"><a href="#ConsistentHash" class="headerlink" title="ConsistentHash"></a>ConsistentHash</h4><ul>
<li><strong>ä¸€è‡´æ€§ Hash</strong>ï¼Œç›¸åŒå‚æ•°çš„è¯·æ±‚æ€»æ˜¯å‘åˆ°åŒä¸€æä¾›è€…ã€‚</li>
<li>å½“æŸä¸€å°æä¾›è€…æŒ‚æ—¶ï¼ŒåŸæœ¬å‘å¾€è¯¥æä¾›è€…çš„è¯·æ±‚ï¼ŒåŸºäºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹³æ‘Šåˆ°å…¶å®ƒæä¾›è€…ï¼Œä¸ä¼šå¼•èµ·å‰§çƒˆå˜åŠ¨ã€‚</li>
<li>ç®—æ³•å‚è§ï¼š<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Consistent_hashing">http://en.wikipedia.org/wiki/Consistent_hashing</a></li>
<li>ç¼ºçœåªå¯¹ç¬¬ä¸€ä¸ªå‚æ•° Hashï¼Œå¦‚æœè¦ä¿®æ”¹ï¼Œè¯·é…ç½® <code>&lt;dubbo:parameter key=&quot;hash.arguments&quot; value=&quot;0,1&quot; /&gt;</code></li>
<li>ç¼ºçœç”¨ 160 ä»½è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¦‚æœè¦ä¿®æ”¹ï¼Œè¯·é…ç½® <code>&lt;dubbo:parameter key=&quot;hash.nodes&quot; value=&quot;320&quot; /&gt;</code></li>
</ul>
<h2 id="ä¹ã€Dubbo-æœåŠ¡æ²»ç†"><a href="#ä¹ã€Dubbo-æœåŠ¡æ²»ç†" class="headerlink" title="ä¹ã€Dubbo æœåŠ¡æ²»ç†"></a>ä¹ã€Dubbo æœåŠ¡æ²»ç†</h2><h3 id="æœåŠ¡æ²»ç†ç®€ä»‹"><a href="#æœåŠ¡æ²»ç†ç®€ä»‹" class="headerlink" title="æœåŠ¡æ²»ç†ç®€ä»‹"></a>æœåŠ¡æ²»ç†ç®€ä»‹</h3><ul>
<li>å½“æœåŠ¡è¶Šæ¥è¶Šå¤šæ—¶ï¼ŒæœåŠ¡ URL é…ç½®ç®¡ç†å˜å¾—éå¸¸å›°éš¾ï¼ŒF5 ç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨çš„å•ç‚¹å‹åŠ›ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚</li>
<li>å½“è¿›ä¸€æ­¥å‘å±•ï¼ŒæœåŠ¡é—´ä¾èµ–å…³ç³»å˜å¾—é”™è¸ªå¤æ‚ï¼Œç”šè‡³åˆ†ä¸æ¸…å“ªä¸ªåº”ç”¨è¦åœ¨å“ªä¸ªåº”ç”¨ä¹‹å‰å¯åŠ¨ï¼Œæ¶æ„å¸ˆéƒ½ä¸èƒ½å®Œæ•´çš„æè¿°åº”ç”¨çš„æ¶æ„å…³ç³»ã€‚</li>
<li>æ¥ç€ï¼ŒæœåŠ¡çš„è°ƒç”¨é‡è¶Šæ¥è¶Šå¤§ï¼ŒæœåŠ¡çš„å®¹é‡é—®é¢˜å°±æš´éœ²å‡ºæ¥ï¼Œè¿™ä¸ªæœåŠ¡éœ€è¦å¤šå°‘æœºå™¨æ”¯æ’‘ï¼Ÿä»€ä¹ˆæ—¶å€™è¯¥åŠ æœºå™¨ï¼Ÿ</li>
</ul>
<p>ä»¥ä¸Šé—®é¢˜å¯ä»¥å½’çº³ä¸ºæœåŠ¡æ²»ç†é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo çš„æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
<h4 id="è°ƒç”¨é“¾è·¯"><a href="#è°ƒç”¨é“¾è·¯" class="headerlink" title="è°ƒç”¨é“¾è·¯"></a>è°ƒç”¨é“¾è·¯</h4><p>ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ï¼Œå¾€å¾€ç”±å¤§é‡åˆ†å¸ƒå¼æœåŠ¡ç»„æˆã€‚é‚£ä¹ˆè¿™äº›æœåŠ¡ä¹‹é—´äº’ç›¸æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼Ÿè°ƒç”¨é“¾è·¯æ˜¯å•¥ï¼Ÿè¯´å®è¯ï¼Œå‡ ä¹åˆ°åé¢æ²¡äººæçš„æ¸…æ¥šäº†ï¼Œå› ä¸ºæœåŠ¡å®åœ¨å¤ªå¤šäº†ï¼Œå¯èƒ½å‡ ç™¾ä¸ªç”šè‡³å‡ åƒä¸ªæœåŠ¡ã€‚</p>
<p>é‚£å°±éœ€è¦åŸºäº dubbo åšçš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯¹å„ä¸ªæœåŠ¡ä¹‹é—´çš„è°ƒç”¨è‡ªåŠ¨è®°å½•ä¸‹æ¥ï¼Œç„¶åè‡ªåŠ¨å°†<strong>å„ä¸ªæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œè°ƒç”¨é“¾è·¯ç”Ÿæˆå‡ºæ¥</strong>ï¼Œåšæˆä¸€å¼ å›¾ï¼Œæ˜¾ç¤ºå‡ºæ¥ï¼Œå¤§å®¶æ‰å¯ä»¥çœ‹åˆ°å¯¹å§ã€‚</p>
<h4 id="æœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡"><a href="#æœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡" class="headerlink" title="æœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡"></a>æœåŠ¡è®¿é—®å‹åŠ›ä»¥åŠæ—¶é•¿ç»Ÿè®¡</h4><p>éœ€è¦è‡ªåŠ¨ç»Ÿè®¡<strong>å„ä¸ªæ¥å£å’ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨æ¬¡æ•°ä»¥åŠè®¿é—®å»¶æ—¶</strong>ï¼Œè€Œä¸”è¦åˆ†æˆä¸¤ä¸ªçº§åˆ«ã€‚</p>
<ul>
<li>ä¸€ä¸ªçº§åˆ«æ˜¯æ¥å£ç²’åº¦ï¼Œå°±æ˜¯æ¯ä¸ªæœåŠ¡çš„æ¯ä¸ªæ¥å£æ¯å¤©è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼ŒTP50&#x2F;TP90&#x2F;TP99ï¼Œä¸‰ä¸ªæ¡£æ¬¡çš„è¯·æ±‚å»¶æ—¶åˆ†åˆ«æ˜¯å¤šå°‘ï¼›</li>
<li>ç¬¬äºŒä¸ªçº§åˆ«æ˜¯ä»æºå¤´å…¥å£å¼€å§‹ï¼Œä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚é“¾è·¯ç»è¿‡å‡ åä¸ªæœåŠ¡ä¹‹åï¼Œå®Œæˆä¸€æ¬¡è¯·æ±‚ï¼Œæ¯å¤©å…¨é“¾è·¯èµ°å¤šå°‘æ¬¡ï¼Œå…¨é“¾è·¯è¯·æ±‚å»¶æ—¶çš„ TP50&#x2F;TP90&#x2F;TP99ï¼Œåˆ†åˆ«æ˜¯å¤šå°‘ã€‚</li>
</ul>
<h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><ul>
<li>æœåŠ¡åˆ†å±‚ï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰</li>
<li>è°ƒç”¨é“¾è·¯å¤±è´¥ç›‘æ§å’ŒæŠ¥è­¦</li>
<li>æœåŠ¡é‰´æƒ</li>
<li>æ¯ä¸ªæœåŠ¡çš„å¯ç”¨æ€§çš„ç›‘æ§ï¼ˆæ¥å£è°ƒç”¨æˆåŠŸç‡ï¼Ÿå‡ ä¸ª 9ï¼Ÿ99.99%ï¼Œ99.9%ï¼Œ99%ï¼‰</li>
</ul>
<p>æ‰€è°“å¤±è´¥é‡è¯•ï¼Œå°±æ˜¯ consumer è°ƒç”¨ provider è¦æ˜¯å¤±è´¥äº†ï¼Œæ¯”å¦‚æŠ›å¼‚å¸¸äº†ï¼Œæ­¤æ—¶åº”è¯¥æ˜¯å¯ä»¥é‡è¯•çš„ï¼Œæˆ–è€…è°ƒç”¨è¶…æ—¶äº†ä¹Ÿå¯ä»¥é‡è¯•ã€‚é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:reference <span class="attribute">id</span>=<span class="string">&quot;xxxx&quot;</span> <span class="attribute">interface</span>=<span class="string">&quot;xx&quot;</span> <span class="attribute">check</span>=<span class="string">&quot;true&quot;</span> <span class="attribute">async</span>=<span class="string">&quot;false&quot;</span> <span class="attribute">retries</span>=<span class="string">&quot;3&quot;</span> <span class="attribute">timeout</span>=<span class="string">&quot;2000&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¸ªæ —å­ã€‚</p>
<p>æŸä¸ªæœåŠ¡çš„æ¥å£ï¼Œè¦è€—è´¹ 5sï¼Œä½ è¿™è¾¹ä¸èƒ½å¹²ç­‰ç€ï¼Œä½ è¿™è¾¹é…ç½®äº† timeout ä¹‹åï¼Œæˆ‘ç­‰å¾… 2sï¼Œè¿˜æ²¡è¿”å›ï¼Œæˆ‘ç›´æ¥å°±æ’¤äº†ï¼Œä¸èƒ½å¹²ç­‰ä½ ã€‚</p>
<p>å¯ä»¥ç»“åˆä½ ä»¬å…¬å¸å…·ä½“çš„åœºæ™¯æ¥è¯´è¯´ä½ æ˜¯æ€ä¹ˆè®¾ç½®è¿™äº›å‚æ•°çš„ï¼š</p>
<ul>
<li><code>timeout</code>ï¼šä¸€èˆ¬è®¾ç½®ä¸º <code>200ms</code>ï¼Œæˆ‘ä»¬è®¤ä¸ºä¸èƒ½è¶…è¿‡ <code>200ms</code> è¿˜æ²¡è¿”å›ã€‚</li>
<li><code>retries</code>ï¼šè®¾ç½® retriesï¼Œä¸€èˆ¬æ˜¯åœ¨è¯»è¯·æ±‚çš„æ—¶å€™ï¼Œæ¯”å¦‚ä½ è¦æŸ¥è¯¢ä¸ªæ•°æ®ï¼Œä½ å¯ä»¥è®¾ç½®ä¸ª retriesï¼Œå¦‚æœç¬¬ä¸€æ¬¡æ²¡è¯»åˆ°ï¼ŒæŠ¥é”™ï¼Œé‡è¯•æŒ‡å®šçš„æ¬¡æ•°ï¼Œå°è¯•å†æ¬¡è¯»å–ã€‚</li>
</ul>
<h3 id="è·¯ç”±è§„åˆ™"><a href="#è·¯ç”±è§„åˆ™" class="headerlink" title="è·¯ç”±è§„åˆ™"></a>è·¯ç”±è§„åˆ™</h3><p>è·¯ç”±è§„åˆ™å†³å®šä¸€æ¬¡ dubbo æœåŠ¡è°ƒç”¨çš„ç›®æ ‡æœåŠ¡å™¨ï¼Œåˆ†ä¸ºæ¡ä»¶è·¯ç”±è§„åˆ™å’Œè„šæœ¬è·¯ç”±è§„åˆ™ï¼Œå¹¶ä¸”æ”¯æŒå¯æ‰©å±•ã€‚</p>
<p>å‘æ³¨å†Œä¸­å¿ƒå†™å…¥è·¯ç”±è§„åˆ™çš„æ“ä½œé€šå¸¸ç”±ç›‘æ§ä¸­å¿ƒæˆ–æ²»ç†ä¸­å¿ƒçš„é¡µé¢å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RegistryFactory</span> <span class="variable">registryFactory</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(RegistryFactory.class).getAdaptiveExtension();</span><br><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> registryFactory.getRegistry(URL.valueOf(<span class="string">&quot;zookeeper://10.20.153.10:2181&quot;</span>));</span><br><span class="line">registry.register(URL.valueOf(<span class="string">&quot;condition://0.0.0.0/com.foo.BarService?category=routers&amp;dynamic=false&amp;rule=&quot;</span> + URL.encode(<span class="string">&quot;host = 10.20.153.10 =&gt; host = 10.20.153.11&quot;</span>) + <span class="string">&quot;));</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>condition:&#x2F;&#x2F;</strong> - è¡¨ç¤ºè·¯ç”±è§„åˆ™çš„ç±»å‹ï¼Œæ”¯æŒæ¡ä»¶è·¯ç”±è§„åˆ™å’Œè„šæœ¬è·¯ç”±è§„åˆ™ï¼Œå¯æ‰©å±•ï¼Œå¿…å¡«ã€‚</li>
<li><strong>0.0.0.0</strong> - è¡¨ç¤ºå¯¹æ‰€æœ‰ IP åœ°å€ç”Ÿæ•ˆï¼Œå¦‚æœåªæƒ³å¯¹æŸä¸ª IP çš„ç”Ÿæ•ˆï¼Œè¯·å¡«å…¥å…·ä½“ IPï¼Œå¿…å¡«ã€‚</li>
<li><strong>com.foo.BarService</strong> - è¡¨ç¤ºåªå¯¹æŒ‡å®šæœåŠ¡ç”Ÿæ•ˆï¼Œå¿…å¡«ã€‚</li>
<li><strong>category&#x3D;routers</strong> - è¡¨ç¤ºè¯¥æ•°æ®ä¸ºåŠ¨æ€é…ç½®ç±»å‹ï¼Œå¿…å¡«ã€‚</li>
<li><strong>dynamic&#x3D;false</strong> - è¡¨ç¤ºè¯¥æ•°æ®ä¸ºæŒä¹…æ•°æ®ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä¾ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒï¼Œå¿…å¡«ã€‚</li>
<li><strong>enabled&#x3D;true</strong> - è¦†ç›–è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Œå¯ä¸å¡«ï¼Œç¼ºçœç”Ÿæ•ˆã€‚</li>
<li><strong>force&#x3D;false</strong> - å½“è·¯ç”±ç»“æœä¸ºç©ºæ—¶ï¼Œæ˜¯å¦å¼ºåˆ¶æ‰§è¡Œï¼Œå¦‚æœä¸å¼ºåˆ¶æ‰§è¡Œï¼Œè·¯ç”±ç»“æœä¸ºç©ºçš„è·¯ç”±è§„åˆ™å°†è‡ªåŠ¨å¤±æ•ˆï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º flaseã€‚</li>
<li><strong>runtime&#x3D;false</strong> - æ˜¯å¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œè·¯ç”±è§„åˆ™ï¼Œå¦åˆ™åªåœ¨æä¾›è€…åœ°å€åˆ—è¡¨å˜æ›´æ—¶é¢„å…ˆæ‰§è¡Œå¹¶ç¼“å­˜ç»“æœï¼Œè°ƒç”¨æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–è·¯ç”±ç»“æœã€‚å¦‚æœç”¨äº†å‚æ•°è·¯ç”±ï¼Œå¿…é¡»è®¾ä¸º trueï¼Œéœ€è¦æ³¨æ„è®¾ç½®ä¼šå½±å“è°ƒç”¨çš„æ€§èƒ½ï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º flaseã€‚</li>
<li><strong>priority&#x3D;1</strong> - è·¯ç”±è§„åˆ™çš„ä¼˜å…ˆçº§ï¼Œç”¨äºæ’åºï¼Œä¼˜å…ˆçº§è¶Šå¤§è¶Šé å‰æ‰§è¡Œï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º 0ã€‚</li>
<li><strong>rule&#x3D;URL.encode(â€œhost &#x3D; 10.20.153.10 &#x3D;&gt; host &#x3D; 10.20.153.11â€)</strong> - è¡¨ç¤ºè·¯ç”±è§„åˆ™çš„å†…å®¹ï¼Œå¿…å¡«ã€‚</li>
</ul>
<h3 id="æœåŠ¡é™çº§"><a href="#æœåŠ¡é™çº§" class="headerlink" title="æœåŠ¡é™çº§"></a>æœåŠ¡é™çº§</h3><p>å¯ä»¥é€šè¿‡æœåŠ¡é™çº§åŠŸèƒ½ä¸´æ—¶å±è”½æŸä¸ªå‡ºé”™çš„éå…³é”®æœåŠ¡ï¼Œå¹¶å®šä¹‰é™çº§åçš„è¿”å›ç­–ç•¥ã€‚</p>
<p>å‘æ³¨å†Œä¸­å¿ƒå†™å…¥åŠ¨æ€é…ç½®è¦†ç›–è§„åˆ™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RegistryFactory</span> <span class="variable">registryFactory</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(RegistryFactory.class).getAdaptiveExtension();</span><br><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> registryFactory.getRegistry(URL.valueOf(<span class="string">&quot;zookeeper://10.20.153.10:2181&quot;</span>));</span><br><span class="line">registry.register(URL.valueOf(<span class="string">&quot;override://0.0.0.0/com.foo.BarService?category=configurators&amp;dynamic=false&amp;application=foo&amp;mock=force:return+null&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼š</p>
<p><strong><code>mock=force:return+null</code></strong> è¡¨ç¤ºæ¶ˆè´¹æ–¹å¯¹è¯¥æœåŠ¡çš„æ–¹æ³•è°ƒç”¨éƒ½ç›´æ¥è¿”å› null å€¼ï¼Œä¸å‘èµ·è¿œç¨‹è°ƒç”¨ã€‚ç”¨æ¥å±è”½ä¸é‡è¦æœåŠ¡ä¸å¯ç”¨æ—¶å¯¹è°ƒç”¨æ–¹çš„å½±å“ã€‚<br>è¿˜å¯ä»¥æ”¹ä¸º <strong><code>mock=fail:return+null</code></strong> è¡¨ç¤ºæ¶ˆè´¹æ–¹å¯¹è¯¥æœåŠ¡çš„æ–¹æ³•è°ƒç”¨åœ¨å¤±è´¥åï¼Œå†è¿”å› null å€¼ï¼Œä¸æŠ›å¼‚å¸¸ã€‚ç”¨æ¥å®¹å¿ä¸é‡è¦æœåŠ¡ä¸ç¨³å®šæ—¶å¯¹è°ƒç”¨æ–¹çš„å½±å“ã€‚</p>
<p>æ¯”å¦‚è¯´æœåŠ¡ A è°ƒç”¨æœåŠ¡ Bï¼Œç»“æœæœåŠ¡ B æŒ‚æ‰äº†ï¼ŒæœåŠ¡ A é‡è¯•å‡ æ¬¡è°ƒç”¨æœåŠ¡ Bï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œé‚£ä¹ˆç›´æ¥é™çº§ï¼Œèµ°ä¸€ä¸ªå¤‡ç”¨çš„é€»è¾‘ï¼Œç»™ç”¨æˆ·è¿”å›å“åº”ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰æ¥å£ <code>HelloService</code>ã€‚<code>HelloServiceImpl</code> æœ‰è¯¥æ¥å£çš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dubbo é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- provider é…ç½® --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;dubbo-provider&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.zhss.service.HelloService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;helloServiceImpl&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;helloServiceImpl&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zhss.service.HelloServiceImpl&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- consumer é…ç½® --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;dubbo-consumer&quot;</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;fooService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.test.service.FooService&quot;</span>  <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">mock</span>=<span class="string">&quot;return null&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dubbo:reference</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è°ƒç”¨æ¥å£å¤±è´¥çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ <code>mock</code> ç»Ÿä¸€è¿”å› nullã€‚</p>
<p>mock çš„å€¼ä¹Ÿå¯ä»¥ä¿®æ”¹ä¸º trueï¼Œç„¶åå†è·Ÿæ¥å£åŒä¸€ä¸ªè·¯å¾„ä¸‹å®ç°ä¸€ä¸ª Mock ç±»ï¼Œå‘½åè§„åˆ™æ˜¯ â€œæ¥å£åç§°+<code>Mock</code>â€ åç¼€ã€‚ç„¶ååœ¨ Mock ç±»é‡Œå®ç°è‡ªå·±çš„é™çº§é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceMock</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é™çº§é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="headerlink" title="è®¿é—®æ§åˆ¶"></a>è®¿é—®æ§åˆ¶</h3><h4 id="ç›´è¿"><a href="#ç›´è¿" class="headerlink" title="ç›´è¿"></a>ç›´è¿</h4><p>åœ¨å¼€å‘åŠæµ‹è¯•ç¯å¢ƒä¸‹ï¼Œç»å¸¸éœ€è¦ç»•è¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªæµ‹è¯•æŒ‡å®šæœåŠ¡æä¾›è€…ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦ç‚¹å¯¹ç‚¹ç›´è¿ï¼Œç‚¹å¯¹ç‚¹ç›´è”æ–¹å¼ï¼Œå°†ä»¥æœåŠ¡æ¥å£ä¸ºå•ä½ï¼Œå¿½ç•¥æ³¨å†Œä¸­å¿ƒçš„æä¾›è€…åˆ—è¡¨ï¼ŒA æ¥å£é…ç½®ç‚¹å¯¹ç‚¹ï¼Œä¸å½±å“ B æ¥å£ä»æ³¨å†Œä¸­å¿ƒè·å–åˆ—è¡¨ã€‚</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/rpc/dubbo/dubboè®¿é—®æ§åˆ¶-ç›´è¿.jpg" />
</div>

<p>é…ç½®æ–¹å¼ï¼š</p>
<p>ï¼ˆ1ï¼‰é€šè¿‡ XML é…ç½®</p>
<p>å¦‚æœæ˜¯çº¿ä¸Šéœ€æ±‚éœ€è¦ç‚¹å¯¹ç‚¹ï¼Œå¯åœ¨ <a href="dubbo:reference">dubbo:reference</a> ä¸­é…ç½® url æŒ‡å‘æä¾›è€…ï¼Œå°†ç»•è¿‡æ³¨å†Œä¸­å¿ƒï¼Œå¤šä¸ªåœ°å€ç”¨åˆ†å·éš”å¼€ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;xxxService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.alibaba.xxx.XxxService&quot;</span> <span class="attr">url</span>=<span class="string">&quot;dubbo://localhost:20890&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰é€šè¿‡ -D å‚æ•°æŒ‡å®š</p>
<p>åœ¨ JVM å¯åŠ¨å‚æ•°ä¸­åŠ å…¥-D å‚æ•°æ˜ å°„æœåŠ¡åœ°å€ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dcom<span class="selector-class">.alibaba</span><span class="selector-class">.xxx</span>.XxxService=dubbo:<span class="comment">//localhost:20890</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰é€šè¿‡æ–‡ä»¶æ˜ å°„<br>å¦‚æœæœåŠ¡æ¯”è¾ƒå¤šï¼Œä¹Ÿå¯ä»¥ç”¨æ–‡ä»¶æ˜ å°„ï¼Œç”¨ -Ddubbo.resolve.file æŒ‡å®šæ˜ å°„æ–‡ä»¶è·¯å¾„ï¼Œæ­¤é…ç½®ä¼˜å…ˆçº§é«˜äº <a href="dubbo:reference">dubbo:reference</a> ä¸­çš„é…ç½®ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Ddubbo.<span class="built_in">resolve</span>.<span class="built_in">file</span>=xxx.properties</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨æ˜ å°„æ–‡ä»¶ xxx.properties ä¸­åŠ å…¥é…ç½®ï¼Œå…¶ä¸­ key ä¸ºæœåŠ¡åï¼Œvalue ä¸ºæœåŠ¡æä¾›è€… URLï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com.alibaba.xxx.XxxService</span>=<span class="string">dubbo://localhost:20890</span></span><br></pre></td></tr></table></figure>

<h4 id="åªè®¢é˜…"><a href="#åªè®¢é˜…" class="headerlink" title="åªè®¢é˜…"></a>åªè®¢é˜…</h4><p>ä¸ºæ–¹ä¾¿å¼€å‘æµ‹è¯•ï¼Œç»å¸¸ä¼šåœ¨çº¿ä¸‹å…±ç”¨ä¸€ä¸ªæ‰€æœ‰æœåŠ¡å¯ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼Œè¿™æ—¶ï¼Œå¦‚æœä¸€ä¸ªæ­£åœ¨å¼€å‘ä¸­çš„æœåŠ¡æä¾›è€…æ³¨å†Œï¼Œå¯èƒ½ä¼šå½±å“æ¶ˆè´¹è€…ä¸èƒ½æ­£å¸¸è¿è¡Œã€‚</p>
<p>å¯ä»¥è®©æœåŠ¡æä¾›è€…å¼€å‘æ–¹ï¼Œåªè®¢é˜…æœåŠ¡(å¼€å‘çš„æœåŠ¡å¯èƒ½ä¾èµ–å…¶å®ƒæœåŠ¡)ï¼Œè€Œä¸æ³¨å†Œæ­£åœ¨å¼€å‘çš„æœåŠ¡ï¼Œé€šè¿‡ç›´è¿æµ‹è¯•æ­£åœ¨å¼€å‘çš„æœåŠ¡ã€‚</p>
<p>ç¦ç”¨æ³¨å†Œé…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;10.20.153.10:9090&quot;</span> <span class="attr">register</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;10.20.153.10:9090?register=false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="åªæ³¨å†Œ"><a href="#åªæ³¨å†Œ" class="headerlink" title="åªæ³¨å†Œ"></a>åªæ³¨å†Œ</h4><p>å¦‚æœæœ‰ä¸¤ä¸ªé•œåƒç¯å¢ƒï¼Œä¸¤ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œæœ‰ä¸€ä¸ªæœåŠ¡åªåœ¨å…¶ä¸­ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒæœ‰éƒ¨ç½²ï¼Œå¦ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒè¿˜æ²¡æ¥å¾—åŠéƒ¨ç½²ï¼Œè€Œä¸¤ä¸ªæ³¨å†Œä¸­å¿ƒçš„å…¶å®ƒåº”ç”¨éƒ½éœ€è¦ä¾èµ–æ­¤æœåŠ¡ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥è®©æœåŠ¡æä¾›è€…æ–¹åªæ³¨å†ŒæœåŠ¡åˆ°å¦ä¸€æ³¨å†Œä¸­å¿ƒï¼Œè€Œä¸ä»å¦ä¸€æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡ã€‚</p>
<p>ç¦ç”¨è®¢é˜…é…ç½®</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">&quot;hzRegistry&quot;</span> <span class="attr">address</span>=<span class="string">&quot;10.20.153.10:9090&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">&quot;qdRegistry&quot;</span> <span class="attr">address</span>=<span class="string">&quot;10.20.141.150:9090&quot;</span> <span class="attr">subscribe</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">&quot;hzRegistry&quot;</span> <span class="attr">address</span>=<span class="string">&quot;10.20.153.10:9090&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">&quot;qdRegistry&quot;</span> <span class="attr">address</span>=<span class="string">&quot;10.20.141.150:9090?subscribe=false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="é™æ€æœåŠ¡"><a href="#é™æ€æœåŠ¡" class="headerlink" title="é™æ€æœåŠ¡"></a>é™æ€æœåŠ¡</h4><p>æœ‰æ—¶å€™å¸Œæœ›äººå·¥ç®¡ç†æœåŠ¡æä¾›è€…çš„ä¸Šçº¿å’Œä¸‹çº¿ï¼Œæ­¤æ—¶éœ€å°†æ³¨å†Œä¸­å¿ƒæ ‡è¯†ä¸ºéåŠ¨æ€ç®¡ç†æ¨¡å¼ã€‚</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry <span class="attribute">address</span>=<span class="string">&quot;10.20.141.150:9090&quot;</span> <span class="attribute">dynamic</span>=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;10.20.141.150:9090?dynamic=false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœåŠ¡æä¾›è€…åˆæ¬¡æ³¨å†Œæ—¶ä¸ºç¦ç”¨çŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ã€‚æ–­çº¿æ—¶ï¼Œå°†ä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œéœ€äººå·¥ç¦ç”¨ã€‚</p>
<h3 id="åŠ¨æ€é…ç½®"><a href="#åŠ¨æ€é…ç½®" class="headerlink" title="åŠ¨æ€é…ç½®"></a>åŠ¨æ€é…ç½®</h3><p>å‘æ³¨å†Œä¸­å¿ƒå†™å…¥åŠ¨æ€é…ç½®è¦†ç›–è§„åˆ™ã€‚è¯¥åŠŸèƒ½é€šå¸¸ç”±ç›‘æ§ä¸­å¿ƒæˆ–æ²»ç†ä¸­å¿ƒçš„é¡µé¢å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RegistryFactory</span> <span class="variable">registryFactory</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(RegistryFactory.class).getAdaptiveExtension();</span><br><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> registryFactory.getRegistry(URL.valueOf(<span class="string">&quot;zookeeper://10.20.153.10:2181&quot;</span>));</span><br><span class="line">registry.register(URL.valueOf(<span class="string">&quot;override://0.0.0.0/com.foo.BarService?category=configurators&amp;dynamic=false&amp;application=foo&amp;timeout=1000&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼š</p>
<ul>
<li><strong>override:&#x2F;&#x2F;</strong> - è¡¨ç¤ºæ•°æ®é‡‡ç”¨è¦†ç›–æ–¹å¼ï¼Œæ”¯æŒ override å’Œ absentï¼Œå¯æ‰©å±•ï¼Œå¿…å¡«ã€‚</li>
<li><strong>0.0.0.0</strong> - è¡¨ç¤ºå¯¹æ‰€æœ‰ IP åœ°å€ç”Ÿæ•ˆï¼Œå¦‚æœåªæƒ³è¦†ç›–æŸä¸ª IP çš„æ•°æ®ï¼Œè¯·å¡«å…¥å…·ä½“ IPï¼Œå¿…å¡«ã€‚</li>
<li><strong>com.foo.BarService</strong> - è¡¨ç¤ºåªå¯¹æŒ‡å®šæœåŠ¡ç”Ÿæ•ˆï¼Œå¿…å¡«ã€‚</li>
<li><strong>category&#x3D;configurators</strong> - è¡¨ç¤ºè¯¥æ•°æ®ä¸ºåŠ¨æ€é…ç½®ç±»å‹ï¼Œå¿…å¡«ã€‚</li>
<li><strong>dynamic&#x3D;false</strong> - è¡¨ç¤ºè¯¥æ•°æ®ä¸ºæŒä¹…æ•°æ®ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä¾ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒï¼Œå¿…å¡«ã€‚</li>
<li><strong>enabled&#x3D;true</strong> - è¦†ç›–è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Œå¯ä¸å¡«ï¼Œç¼ºçœç”Ÿæ•ˆã€‚</li>
<li><strong>application&#x3D;foo</strong> - è¡¨ç¤ºåªå¯¹æŒ‡å®šåº”ç”¨ç”Ÿæ•ˆï¼Œå¯ä¸å¡«ï¼Œè¡¨ç¤ºå¯¹æ‰€æœ‰åº”ç”¨ç”Ÿæ•ˆã€‚</li>
<li><strong>timeout&#x3D;1000</strong> - è¡¨ç¤ºå°†æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„ timeout å‚æ•°çš„å€¼è¦†ç›–ä¸º 1000ã€‚å¦‚æœæƒ³è¦†ç›–å…¶å®ƒå‚æ•°ï¼Œç›´æ¥åŠ åœ¨ override çš„ URL å‚æ•°ä¸Šã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li>ç¦ç”¨æä¾›è€…ï¼š(é€šå¸¸ç”¨äºä¸´æ—¶è¸¢é™¤æŸå°æä¾›è€…æœºå™¨ï¼Œç›¸ä¼¼çš„ï¼Œç¦æ­¢æ¶ˆè´¹è€…è®¿é—®è¯·ä½¿ç”¨è·¯ç”±è§„åˆ™)</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span>:<span class="type"></span>//<span class="number">10.20</span><span class="number">.153</span><span class="number">.10</span>/com.foo.BarService?category=configurators&amp;<span class="keyword">dynamic</span>=<span class="literal">false</span>&amp;disbaled=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è°ƒæ•´æƒé‡ï¼š(é€šå¸¸ç”¨äºå®¹é‡è¯„ä¼°ï¼Œç¼ºçœæƒé‡ä¸º 100)</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span>:<span class="type"></span>//<span class="number">10.20</span><span class="number">.153</span><span class="number">.10</span>/com.foo.BarService?category=configurators&amp;<span class="keyword">dynamic</span>=<span class="literal">false</span>&amp;weight=<span class="number">200</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š(ç¼ºçœè´Ÿè½½å‡è¡¡ç­–ç•¥ä¸º random)</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span>:<span class="type"></span>//<span class="number">10.20</span><span class="number">.153</span><span class="number">.10</span>/com.foo.BarService?category=configurators&amp;<span class="keyword">dynamic</span>=<span class="literal">false</span>&amp;loadbalance=leastactive</span><br></pre></td></tr></table></figure>

<ul>
<li>æœåŠ¡é™çº§ï¼š(é€šå¸¸ç”¨äºä¸´æ—¶å±è”½æŸä¸ªå‡ºé”™çš„éå…³é”®æœåŠ¡)</li>
</ul>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override://0.0.0.0/com.foo.BarService?category=configurators<span class="variable">&amp;dynamic</span>=false<span class="variable">&amp;application</span>=foo<span class="variable">&amp;mock</span>=force:<span class="keyword">return</span>+<span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<h2 id="åã€å¤šç‰ˆæœ¬"><a href="#åã€å¤šç‰ˆæœ¬" class="headerlink" title="åã€å¤šç‰ˆæœ¬"></a>åã€å¤šç‰ˆæœ¬</h2><p>å½“ä¸€ä¸ªæ¥å£å®ç°ï¼Œå‡ºç°ä¸å…¼å®¹å‡çº§æ—¶ï¼Œå¯ä»¥ç”¨ç‰ˆæœ¬å·è¿‡æ¸¡ï¼Œç‰ˆæœ¬å·ä¸åŒçš„æœåŠ¡ç›¸äº’é—´ä¸å¼•ç”¨ã€‚</p>
<p>å¯ä»¥æŒ‰ç…§ä»¥ä¸‹çš„æ­¥éª¤è¿›è¡Œç‰ˆæœ¬è¿ç§»ï¼š</p>
<ol>
<li>åœ¨ä½å‹åŠ›æ—¶é—´æ®µï¼Œå…ˆå‡çº§ä¸€åŠæä¾›è€…ä¸ºæ–°ç‰ˆæœ¬</li>
<li>å†å°†æ‰€æœ‰æ¶ˆè´¹è€…å‡çº§ä¸ºæ–°ç‰ˆæœ¬</li>
<li>ç„¶åå°†å‰©ä¸‹çš„ä¸€åŠæä¾›è€…å‡çº§ä¸ºæ–°ç‰ˆæœ¬</li>
</ol>
<p>è€ç‰ˆæœ¬æœåŠ¡æä¾›è€…é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.foo.BarService&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.0&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ–°ç‰ˆæœ¬æœåŠ¡æä¾›è€…é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">&quot;com.foo.BarService&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.0.0&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>è€ç‰ˆæœ¬æœåŠ¡æ¶ˆè´¹è€…é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;barService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.foo.BarService&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.0&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ–°ç‰ˆæœ¬æœåŠ¡æ¶ˆè´¹è€…é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;barService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.foo.BarService&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.0.0&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸éœ€è¦åŒºåˆ†ç‰ˆæœ¬ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹çš„æ–¹å¼é…ç½® [<a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/docs/user/demos/multi-versions.html#fn1">1]</a>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;barService&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;com.foo.BarService&quot;</span> <span class="attr">version</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="åä¸€ã€Dubbo-SPI"><a href="#åä¸€ã€Dubbo-SPI" class="headerlink" title="åä¸€ã€Dubbo SPI"></a>åä¸€ã€Dubbo SPI</h2><p>SPI å…¨ç§°ä¸º Service Provider Interfaceï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚SPI çš„æœ¬è´¨æ˜¯<strong>å°†æ¥å£å®ç°ç±»çš„å…¨é™å®šåé…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œå¹¶ç”±æœåŠ¡åŠ è½½å™¨è¯»å–é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å®ç°ç±»</strong>ã€‚è¿™æ ·å¯ä»¥åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€ä¸ºæ¥å£æ›¿æ¢å®ç°ç±»ã€‚æ­£å› æ­¤ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„é€šè¿‡ SPI æœºåˆ¶ä¸ºæˆ‘ä»¬çš„ç¨‹åºæä¾›æ‹“å±•åŠŸèƒ½ã€‚SPI æœºåˆ¶åœ¨ç¬¬ä¸‰æ–¹æ¡†æ¶ä¸­ä¹Ÿæœ‰æ‰€åº”ç”¨ï¼Œæ¯”å¦‚ Dubbo å°±æ˜¯é€šè¿‡ SPI æœºåˆ¶åŠ è½½æ‰€æœ‰çš„ç»„ä»¶ã€‚ä¸è¿‡ï¼ŒDubbo å¹¶æœªä½¿ç”¨ Java åŸç”Ÿçš„ SPI æœºåˆ¶ï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œäº†å¢å¼ºï¼Œä½¿å…¶èƒ½å¤Ÿæ›´å¥½çš„æ»¡è¶³éœ€æ±‚ã€‚åœ¨ Dubbo ä¸­ï¼ŒSPI æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ã€‚åŸºäº SPIï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å¯¹ Dubbo è¿›è¡Œæ‹“å±•ã€‚</p>
<p>Dubbo SPI çš„ç›¸å…³é€»è¾‘è¢«å°è£…åœ¨äº† <code>ExtensionLoader</code> ç±»ä¸­ï¼Œé€šè¿‡ <code>ExtensionLoader</code>ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½æŒ‡å®šçš„å®ç°ç±»ã€‚Dubbo SPI æ‰€éœ€çš„é…ç½®æ–‡ä»¶éœ€æ”¾ç½®åœ¨ <code>META-INF/dubbo</code> è·¯å¾„ä¸‹ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><strong>å®˜æ–¹</strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/dubbo">Dubbo Github</a></li>
<li><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh-cn/">Dubbo å®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://dubbo.gitbooks.io/dubbo-admin-book/content/">ç®¡ç†å‘˜æ‰‹å†Œ</a></li>
</ul>
</li>
<li><strong>æ–‡ç« </strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/distributed-system/dubbo-service-management.md">å¦‚ä½•åŸºäº Dubbo è¿›è¡ŒæœåŠ¡æ²»ç†ã€æœåŠ¡é™çº§ã€å¤±è´¥é‡è¯•ä»¥åŠè¶…æ—¶é‡è¯•ï¼Ÿ</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/baf673/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/baf673/" class="post-title-link" itemprop="url">æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/MQ%E7%BB%BC%E5%90%88/" itemprop="url" rel="index"><span itemprop="name">MQç»¼åˆ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>12 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•å¤ºå‘½è¿ç¯é—®"><a href="#æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•å¤ºå‘½è¿ç¯é—®" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•å¤ºå‘½è¿ç¯é—®"></a>æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•å¤ºå‘½è¿ç¯é—®</h1><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</h2><h3 id="è§£è€¦"><a href="#è§£è€¦" class="headerlink" title="è§£è€¦"></a>è§£è€¦</h3><p>çœ‹è¿™ä¹ˆä¸ªåœºæ™¯ã€‚A ç³»ç»Ÿå‘é€æ•°æ®åˆ° BCD ä¸‰ä¸ªç³»ç»Ÿï¼Œé€šè¿‡æ¥å£è°ƒç”¨å‘é€ã€‚å¦‚æœ E ç³»ç»Ÿä¹Ÿè¦è¿™ä¸ªæ•°æ®å‘¢ï¼Ÿé‚£å¦‚æœ C ç³»ç»Ÿç°åœ¨ä¸éœ€è¦äº†å‘¢ï¼ŸA ç³»ç»Ÿè´Ÿè´£äººå‡ ä¹å´©æºƒâ€¦â€¦</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-1.png" alt="img"></p>
<p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒA ç³»ç»Ÿè·Ÿå…¶å®ƒå„ç§ä¹±ä¸ƒå…«ç³Ÿçš„ç³»ç»Ÿä¸¥é‡è€¦åˆï¼ŒA ç³»ç»Ÿäº§ç”Ÿä¸€æ¡æ¯”è¾ƒå…³é”®çš„æ•°æ®ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½éœ€è¦ A ç³»ç»Ÿå°†è¿™ä¸ªæ•°æ®å‘é€è¿‡æ¥ã€‚A ç³»ç»Ÿè¦æ—¶æ—¶åˆ»åˆ»è€ƒè™‘ BCDE å››ä¸ªç³»ç»Ÿå¦‚æœæŒ‚äº†è¯¥å’‹åŠï¼Ÿè¦ä¸è¦é‡å‘ï¼Œè¦ä¸è¦æŠŠæ¶ˆæ¯å­˜èµ·æ¥ï¼Ÿå¤´å‘éƒ½ç™½äº†å•Šï¼</p>
<p>å¦‚æœä½¿ç”¨ MQï¼ŒA ç³»ç»Ÿäº§ç”Ÿä¸€æ¡æ•°æ®ï¼Œå‘é€åˆ° MQ é‡Œé¢å»ï¼Œå“ªä¸ªç³»ç»Ÿéœ€è¦æ•°æ®è‡ªå·±å» MQ é‡Œé¢æ¶ˆè´¹ã€‚å¦‚æœæ–°ç³»ç»Ÿéœ€è¦æ•°æ®ï¼Œç›´æ¥ä» MQ é‡Œæ¶ˆè´¹å³å¯ï¼›å¦‚æœæŸä¸ªç³»ç»Ÿä¸éœ€è¦è¿™æ¡æ•°æ®äº†ï¼Œå°±å–æ¶ˆå¯¹ MQ æ¶ˆæ¯çš„æ¶ˆè´¹å³å¯ã€‚è¿™æ ·ä¸‹æ¥ï¼ŒA ç³»ç»Ÿå‹æ ¹å„¿ä¸éœ€è¦å»è€ƒè™‘è¦ç»™è°å‘é€æ•°æ®ï¼Œä¸éœ€è¦ç»´æŠ¤è¿™ä¸ªä»£ç ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘äººå®¶æ˜¯å¦è°ƒç”¨æˆåŠŸã€å¤±è´¥è¶…æ—¶ç­‰æƒ…å†µã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-2.png" alt="img"></p>
<p><strong>æ€»ç»“</strong>ï¼šé€šè¿‡ä¸€ä¸ª MQï¼ŒPub&#x2F;Sub å‘å¸ƒè®¢é˜…æ¶ˆæ¯è¿™ä¹ˆä¸€ä¸ªæ¨¡å‹ï¼ŒA ç³»ç»Ÿå°±è·Ÿå…¶å®ƒç³»ç»Ÿå½»åº•è§£è€¦äº†ã€‚</p>
<p><strong>é¢è¯•æŠ€å·§</strong>ï¼šä½ éœ€è¦å»è€ƒè™‘ä¸€ä¸‹ä½ è´Ÿè´£çš„ç³»ç»Ÿä¸­æ˜¯å¦æœ‰ç±»ä¼¼çš„åœºæ™¯ï¼Œå°±æ˜¯ä¸€ä¸ªç³»ç»Ÿæˆ–è€…ä¸€ä¸ªæ¨¡å—ï¼Œè°ƒç”¨äº†å¤šä¸ªç³»ç»Ÿæˆ–è€…æ¨¡å—ï¼Œäº’ç›¸ä¹‹é—´çš„è°ƒç”¨å¾ˆå¤æ‚ï¼Œç»´æŠ¤èµ·æ¥å¾ˆéº»çƒ¦ã€‚ä½†æ˜¯å…¶å®è¿™ä¸ªè°ƒç”¨æ˜¯ä¸éœ€è¦ç›´æ¥åŒæ­¥è°ƒç”¨æ¥å£çš„ï¼Œå¦‚æœç”¨ MQ ç»™å®ƒå¼‚æ­¥åŒ–è§£è€¦ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½ å°±éœ€è¦å»è€ƒè™‘åœ¨ä½ çš„é¡¹ç›®é‡Œï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è¿ç”¨è¿™ä¸ª MQ å»è¿›è¡Œç³»ç»Ÿçš„è§£è€¦ã€‚åœ¨ç®€å†ä¸­ä½“ç°å‡ºæ¥è¿™å—ä¸œè¥¿ï¼Œç”¨ MQ ä½œè§£è€¦ã€‚</p>
<h3 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h3><p>å†æ¥çœ‹ä¸€ä¸ªåœºæ™¯ï¼ŒA ç³»ç»Ÿæ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œéœ€è¦åœ¨è‡ªå·±æœ¬åœ°å†™åº“ï¼Œè¿˜éœ€è¦åœ¨ BCD ä¸‰ä¸ªç³»ç»Ÿå†™åº“ï¼Œè‡ªå·±æœ¬åœ°å†™åº“è¦ 3msï¼ŒBCD ä¸‰ä¸ªç³»ç»Ÿåˆ†åˆ«å†™åº“è¦ 300msã€450msã€200msã€‚æœ€ç»ˆè¯·æ±‚æ€»å»¶æ—¶æ˜¯ 3 + 300 + 450 + 200 &#x3D; 953msï¼Œæ¥è¿‘ 1sï¼Œç”¨æˆ·æ„Ÿè§‰æä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œæ…¢æ­»äº†æ…¢æ­»äº†ã€‚ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘èµ·è¯·æ±‚ï¼Œç­‰å¾…ä¸ª 1sï¼Œè¿™å‡ ä¹æ˜¯ä¸å¯æ¥å—çš„ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-3.png" alt="img"></p>
<p>ä¸€èˆ¬äº’è”ç½‘ç±»çš„ä¼ä¸šï¼Œå¯¹äºç”¨æˆ·ç›´æ¥çš„æ“ä½œï¼Œä¸€èˆ¬è¦æ±‚æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åœ¨ 200 ms ä»¥å†…å®Œæˆï¼Œå¯¹ç”¨æˆ·å‡ ä¹æ˜¯æ— æ„ŸçŸ¥çš„ã€‚</p>
<p>å¦‚æœ<strong>ä½¿ç”¨ MQ</strong>ï¼Œé‚£ä¹ˆ A ç³»ç»Ÿè¿ç»­å‘é€ 3 æ¡æ¶ˆæ¯åˆ° MQ é˜Ÿåˆ—ä¸­ï¼Œå‡å¦‚è€—æ—¶ 5msï¼ŒA ç³»ç»Ÿä»æ¥å—ä¸€ä¸ªè¯·æ±‚åˆ°è¿”å›å“åº”ç»™ç”¨æˆ·ï¼Œæ€»æ—¶é•¿æ˜¯ 3 + 5 &#x3D; 8msï¼Œå¯¹äºç”¨æˆ·è€Œè¨€ï¼Œå…¶å®æ„Ÿè§‰ä¸Šå°±æ˜¯ç‚¹ä¸ªæŒ‰é’®ï¼Œ8ms ä»¥åå°±ç›´æ¥è¿”å›äº†ï¼Œçˆ½ï¼ç½‘ç«™åšå¾—çœŸå¥½ï¼ŒçœŸå¿«ï¼</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-4.png" alt="img"></p>
<h3 id="å‰Šå³°"><a href="#å‰Šå³°" class="headerlink" title="å‰Šå³°"></a>å‰Šå³°</h3><p>æ¯å¤© 0:00 åˆ° 12:00ï¼ŒA ç³»ç»Ÿé£å¹³æµªé™ï¼Œæ¯ç§’å¹¶å‘è¯·æ±‚æ•°é‡å°± 50 ä¸ªã€‚ç»“æœæ¯æ¬¡ä¸€åˆ° 12:00 ~ 13:00 ï¼Œæ¯ç§’å¹¶å‘è¯·æ±‚æ•°é‡çªç„¶ä¼šæš´å¢åˆ° 5k+ æ¡ã€‚ä½†æ˜¯ç³»ç»Ÿæ˜¯ç›´æ¥åŸºäº MySQL çš„ï¼Œå¤§é‡çš„è¯·æ±‚æ¶Œå…¥ MySQLï¼Œæ¯ç§’é’Ÿå¯¹ MySQL æ‰§è¡Œçº¦ 5k æ¡ SQLã€‚</p>
<p>ä¸€èˆ¬çš„ MySQLï¼Œæ‰›åˆ°æ¯ç§’ 2k ä¸ªè¯·æ±‚å°±å·®ä¸å¤šäº†ï¼Œå¦‚æœæ¯ç§’è¯·æ±‚åˆ° 5k çš„è¯ï¼Œå¯èƒ½å°±ç›´æ¥æŠŠ MySQL ç»™æ‰“æ­»äº†ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œç”¨æˆ·ä¹Ÿå°±æ²¡æ³•å†ä½¿ç”¨ç³»ç»Ÿäº†ã€‚</p>
<p>ä½†æ˜¯é«˜å³°æœŸä¸€è¿‡ï¼Œåˆ°äº†ä¸‹åˆçš„æ—¶å€™ï¼Œå°±æˆäº†ä½å³°æœŸï¼Œå¯èƒ½ä¹Ÿå°± 1w çš„ç”¨æˆ·åŒæ—¶åœ¨ç½‘ç«™ä¸Šæ“ä½œï¼Œæ¯ç§’ä¸­çš„è¯·æ±‚æ•°é‡å¯èƒ½ä¹Ÿå°± 50 ä¸ªè¯·æ±‚ï¼Œå¯¹æ•´ä¸ªç³»ç»Ÿå‡ ä¹æ²¡æœ‰ä»»ä½•çš„å‹åŠ›ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-5.png" alt="img"></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œæ¯ç§’ 5k ä¸ªè¯·æ±‚å†™å…¥ MQï¼ŒA ç³»ç»Ÿæ¯ç§’é’Ÿæœ€å¤šå¤„ç† 2k ä¸ªè¯·æ±‚ï¼Œå› ä¸º MySQL æ¯ç§’é’Ÿæœ€å¤šå¤„ç† 2k ä¸ªã€‚A ç³»ç»Ÿä» MQ ä¸­æ…¢æ…¢æ‹‰å–è¯·æ±‚ï¼Œæ¯ç§’é’Ÿå°±æ‹‰å– 2k ä¸ªè¯·æ±‚ï¼Œä¸è¦è¶…è¿‡è‡ªå·±æ¯ç§’èƒ½å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é‡å°± okï¼Œè¿™æ ·ä¸‹æ¥ï¼Œå“ªæ€•æ˜¯é«˜å³°æœŸçš„æ—¶å€™ï¼ŒA ç³»ç»Ÿä¹Ÿç»å¯¹ä¸ä¼šæŒ‚æ‰ã€‚è€Œ MQ æ¯ç§’é’Ÿ 5k ä¸ªè¯·æ±‚è¿›æ¥ï¼Œå°± 2k ä¸ªè¯·æ±‚å‡ºå»ï¼Œç»“æœå°±å¯¼è‡´åœ¨ä¸­åˆé«˜å³°æœŸï¼ˆ1 ä¸ªå°æ—¶ï¼‰ï¼Œå¯èƒ½æœ‰å‡ åä¸‡ç”šè‡³å‡ ç™¾ä¸‡çš„è¯·æ±‚ç§¯å‹åœ¨ MQ ä¸­ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-6.png" alt="img"></p>
<p>è¿™ä¸ªçŸ­æš‚çš„é«˜å³°æœŸç§¯å‹æ˜¯ ok çš„ï¼Œå› ä¸ºé«˜å³°æœŸè¿‡äº†ä¹‹åï¼Œæ¯ç§’é’Ÿå°± 50 ä¸ªè¯·æ±‚è¿› MQï¼Œä½†æ˜¯ A ç³»ç»Ÿä¾ç„¶ä¼šæŒ‰ç…§æ¯ç§’ 2k ä¸ªè¯·æ±‚çš„é€Ÿåº¦åœ¨å¤„ç†ã€‚æ‰€ä»¥è¯´ï¼Œåªè¦é«˜å³°æœŸä¸€è¿‡ï¼ŒA ç³»ç»Ÿå°±ä¼šå¿«é€Ÿå°†ç§¯å‹çš„æ¶ˆæ¯ç»™è§£å†³æ‰ã€‚</p>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹"><a href="#æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹"></a>æ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹</h2><p>ä¼˜ç‚¹ä¸Šé¢å·²ç»è¯´äº†ï¼Œå°±æ˜¯<strong>åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹æœ‰å…¶å¯¹åº”çš„å¥½å¤„</strong>ï¼Œ<strong>è§£è€¦</strong>ã€<strong>å¼‚æ­¥</strong>ã€<strong>å‰Šå³°</strong>ã€‚</p>
<p>ç¼ºç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ul>
<li>ç³»ç»Ÿå¯ç”¨æ€§é™ä½<br>ç³»ç»Ÿå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œè¶Šå®¹æ˜“æŒ‚æ‰ã€‚æœ¬æ¥ä½ å°±æ˜¯ A ç³»ç»Ÿè°ƒç”¨ BCD ä¸‰ä¸ªç³»ç»Ÿçš„æ¥å£å°±å¥½äº†ï¼Œäºº ABCD å››ä¸ªç³»ç»Ÿå¥½å¥½çš„ï¼Œæ²¡å•¥é—®é¢˜ï¼Œä½ ååŠ ä¸ª MQ è¿›æ¥ï¼Œä¸‡ä¸€ MQ æŒ‚äº†å’‹æ•´ï¼ŒMQ ä¸€æŒ‚ï¼Œæ•´å¥—ç³»ç»Ÿå´©æºƒçš„ï¼Œä½ ä¸å°±å®Œäº†ï¼Ÿå¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Œå¯ä»¥<a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md">ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹</a>ã€‚</li>
<li>ç³»ç»Ÿå¤æ‚åº¦æé«˜<br>ç¡¬ç”Ÿç”ŸåŠ ä¸ª MQ è¿›æ¥ï¼Œä½ æ€ä¹ˆ<a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-that-messages-are-not-repeatedly-consumed.md">ä¿è¯æ¶ˆæ¯æ²¡æœ‰é‡å¤æ¶ˆè´¹</a>ï¼Ÿæ€ä¹ˆ<a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages.md">å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µ</a>ï¼Ÿæ€ä¹ˆä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ï¼Ÿå¤´å¤§å¤´å¤§ï¼Œé—®é¢˜ä¸€å¤§å †ï¼Œç—›è‹¦ä¸å·²ã€‚</li>
<li>ä¸€è‡´æ€§é—®é¢˜<br>A ç³»ç»Ÿå¤„ç†å®Œäº†ç›´æ¥è¿”å›æˆåŠŸäº†ï¼Œäººéƒ½ä»¥ä¸ºä½ è¿™ä¸ªè¯·æ±‚å°±æˆåŠŸäº†ï¼›ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œè¦æ˜¯ BCD ä¸‰ä¸ªç³»ç»Ÿé‚£é‡Œï¼ŒBD ä¸¤ä¸ªç³»ç»Ÿå†™åº“æˆåŠŸäº†ï¼Œç»“æœ C ç³»ç»Ÿå†™åº“å¤±è´¥äº†ï¼Œå’‹æ•´ï¼Ÿä½ è¿™æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚</li>
</ul>
<p>æ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—å®é™…æ˜¯ä¸€ç§éå¸¸å¤æ‚çš„æ¶æ„ï¼Œä½ å¼•å…¥å®ƒæœ‰å¾ˆå¤šå¥½å¤„ï¼Œä½†æ˜¯ä¹Ÿå¾—é’ˆå¯¹å®ƒå¸¦æ¥çš„åå¤„åšå„ç§é¢å¤–çš„æŠ€æœ¯æ–¹æ¡ˆå’Œæ¶æ„æ¥è§„é¿æ‰ï¼Œåšå¥½ä¹‹åï¼Œä½ ä¼šå‘ç°ï¼Œå¦ˆå‘€ï¼Œç³»ç»Ÿå¤æ‚åº¦æå‡äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œä¹Ÿè®¸æ˜¯å¤æ‚äº† 10 å€ã€‚ä½†æ˜¯å…³é”®æ—¶åˆ»ï¼Œç”¨ï¼Œè¿˜æ˜¯å¾—ç”¨çš„ã€‚</p>
<h2 id="Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"><a href="#Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ" class="headerlink" title="Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"></a>Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</h2><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>å•æœºååé‡</td>
<td>ä¸‡çº§ï¼Œæ¯” RocketMQã€Kafka ä½ä¸€ä¸ªæ•°é‡çº§</td>
<td>åŒ ActiveMQ</td>
<td>10 ä¸‡çº§ï¼Œæ”¯æ’‘é«˜åå</td>
<td>10 ä¸‡çº§ï¼Œé«˜ååï¼Œä¸€èˆ¬é…åˆå¤§æ•°æ®ç±»çš„ç³»ç»Ÿæ¥è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯</td>
</tr>
<tr>
<td>topic æ•°é‡å¯¹ååé‡çš„å½±å“</td>
<td></td>
<td></td>
<td>topic å¯ä»¥è¾¾åˆ°å‡ ç™¾&#x2F;å‡ åƒçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰è¾ƒå°å¹…åº¦çš„ä¸‹é™ï¼Œè¿™æ˜¯ RocketMQ çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼Œå¯ä»¥æ”¯æ’‘å¤§é‡çš„ topic</td>
<td>topic ä»å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼ŒKafka å°½é‡ä¿è¯ topic æ•°é‡ä¸è¦è¿‡å¤šï¼Œå¦‚æœè¦æ”¯æ’‘å¤§è§„æ¨¡çš„ topicï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨èµ„æº</td>
</tr>
<tr>
<td>æ—¶æ•ˆæ€§</td>
<td>ms çº§</td>
<td>å¾®ç§’çº§ï¼Œè¿™æ˜¯ RabbitMQ çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæœ€ä½</td>
<td>ms çº§</td>
<td>å»¶è¿Ÿåœ¨ ms çº§ä»¥å†…</td>
</tr>
<tr>
<td>å¯ç”¨æ€§</td>
<td>é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨</td>
<td>åŒ ActiveMQ</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨</td>
</tr>
<tr>
<td>æ¶ˆæ¯å¯é æ€§</td>
<td>æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®</td>
<td>åŸºæœ¬ä¸ä¸¢</td>
<td>ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ° 0 ä¸¢å¤±</td>
<td>åŒ RocketMQ</td>
</tr>
<tr>
<td>åŠŸèƒ½æ”¯æŒ</td>
<td>MQ é¢†åŸŸçš„åŠŸèƒ½æå…¶å®Œå¤‡</td>
<td>åŸºäº erlang å¼€å‘ï¼Œå¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶å¾ˆä½</td>
<td>MQ åŠŸèƒ½è¾ƒä¸ºå®Œå–„ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰©å±•æ€§å¥½</td>
<td>åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨</td>
</tr>
</tbody></table>
<p>ç»¼ä¸Šï¼Œå„ç§å¯¹æ¯”ä¹‹åï¼Œæœ‰å¦‚ä¸‹å»ºè®®ï¼š</p>
<ul>
<li>ä¸€èˆ¬çš„ä¸šåŠ¡ç³»ç»Ÿè¦å¼•å…¥ MQï¼Œæœ€æ—©å¤§å®¶éƒ½ç”¨ ActiveMQï¼Œä½†æ˜¯ç°åœ¨ç¡®å®å¤§å®¶ç”¨çš„ä¸å¤šäº†ï¼Œæ²¡ç»è¿‡å¤§è§„æ¨¡ååé‡åœºæ™¯çš„éªŒè¯ï¼Œç¤¾åŒºä¹Ÿä¸æ˜¯å¾ˆæ´»è·ƒï¼Œæ‰€ä»¥å¤§å®¶è¿˜æ˜¯ç®—äº†å§ï¼Œæˆ‘ä¸ªäººä¸æ¨èç”¨è¿™ä¸ªäº†ï¼›</li>
<li>åæ¥å¤§å®¶å¼€å§‹ç”¨ RabbitMQï¼Œä½†æ˜¯ç¡®å® erlang è¯­è¨€é˜»æ­¢äº†å¤§é‡çš„ Java å·¥ç¨‹å¸ˆå»æ·±å…¥ç ”ç©¶å’ŒæŒæ§å®ƒï¼Œå¯¹å…¬å¸è€Œè¨€ï¼Œå‡ ä¹å¤„äºä¸å¯æ§çš„çŠ¶æ€ï¼Œä½†æ˜¯ç¡®å®äººå®¶æ˜¯å¼€æºçš„ï¼Œæ¯”è¾ƒç¨³å®šçš„æ”¯æŒï¼Œæ´»è·ƒåº¦ä¹Ÿé«˜ï¼›</li>
<li>ä¸è¿‡ç°åœ¨ç¡®å®è¶Šæ¥è¶Šå¤šçš„å…¬å¸ä¼šå»ç”¨ RocketMQï¼Œç¡®å®å¾ˆä¸é”™ï¼Œæ¯•ç«Ÿæ˜¯é˜¿é‡Œå‡ºå“ï¼Œä½†ç¤¾åŒºå¯èƒ½æœ‰çªç„¶é»„æ‰çš„é£é™©ï¼ˆç›®å‰ RocketMQ å·²æç»™ <a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq">Apache</a>ï¼Œä½† GitHub ä¸Šçš„æ´»è·ƒåº¦å…¶å®ä¸ç®—é«˜ï¼‰å¯¹è‡ªå·±å…¬å¸æŠ€æœ¯å®åŠ›æœ‰ç»å¯¹è‡ªä¿¡çš„ï¼Œæ¨èç”¨ RocketMQï¼Œå¦åˆ™å›å»è€è€å®å®ç”¨ RabbitMQ å§ï¼Œäººå®¶æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºï¼Œç»å¯¹ä¸ä¼šé»„ã€‚</li>
<li>æ‰€ä»¥<strong>ä¸­å°å‹å…¬å¸</strong>ï¼ŒæŠ€æœ¯å®åŠ›è¾ƒä¸ºä¸€èˆ¬ï¼ŒæŠ€æœ¯æŒ‘æˆ˜ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œç”¨ RabbitMQ æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›<strong>å¤§å‹å…¬å¸</strong>ï¼ŒåŸºç¡€æ¶æ„ç ”å‘å®åŠ›è¾ƒå¼ºï¼Œç”¨ RocketMQ æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚</li>
<li>å¦‚æœæ˜¯<strong>å¤§æ•°æ®é¢†åŸŸ</strong>çš„å®æ—¶è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯ï¼Œç”¨ Kafka æ˜¯ä¸šå†…æ ‡å‡†çš„ï¼Œç»å¯¹æ²¡é—®é¢˜ï¼Œç¤¾åŒºæ´»è·ƒåº¦å¾ˆé«˜ï¼Œç»å¯¹ä¸ä¼šé»„ï¼Œä½•å†µå‡ ä¹æ˜¯å…¨ä¸–ç•Œè¿™ä¸ªé¢†åŸŸçš„äº‹å®æ€§è§„èŒƒã€‚</li>
</ul>
<h2 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ</h2><h3 id="RabbitMQ-çš„é«˜å¯ç”¨æ€§"><a href="#RabbitMQ-çš„é«˜å¯ç”¨æ€§" class="headerlink" title="RabbitMQ çš„é«˜å¯ç”¨æ€§"></a>RabbitMQ çš„é«˜å¯ç”¨æ€§</h3><p>RabbitMQ æ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ï¼Œå› ä¸ºæ˜¯<strong>åŸºäºä¸»ä»</strong>ï¼ˆéåˆ†å¸ƒå¼ï¼‰åšé«˜å¯ç”¨æ€§çš„ï¼Œæˆ‘ä»¬å°±ä»¥ RabbitMQ ä¸ºä¾‹å­è®²è§£ç¬¬ä¸€ç§ MQ çš„é«˜å¯ç”¨æ€§æ€ä¹ˆå®ç°ã€‚</p>
<p>RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼šå•æœºæ¨¡å¼ã€æ™®é€šé›†ç¾¤æ¨¡å¼ã€é•œåƒé›†ç¾¤æ¨¡å¼ã€‚</p>
<h4 id="å•æœºæ¨¡å¼"><a href="#å•æœºæ¨¡å¼" class="headerlink" title="å•æœºæ¨¡å¼"></a>å•æœºæ¨¡å¼</h4><p>å•æœºæ¨¡å¼ï¼Œå°±æ˜¯ Demo çº§åˆ«çš„ï¼Œä¸€èˆ¬å°±æ˜¯ä½ æœ¬åœ°å¯åŠ¨äº†ç©ç©å„¿çš„ ğŸ˜„ï¼Œæ²¡äººç”Ÿäº§ç”¨å•æœºæ¨¡å¼ã€‚</p>
<h4 id="æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰"><a href="#æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰" class="headerlink" title="æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰"></a>æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰</h4><p>æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚ä½ <strong>åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š</strong>ï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-7.png" alt="img"></p>
<p>è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œ<strong>æ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼</strong>ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰<strong>æ•°æ®æ‹‰å–çš„å¼€é”€</strong>ï¼Œåè€…å¯¼è‡´<strong>å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆ</strong>ã€‚</p>
<p>è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ <strong>å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–</strong>ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œ<strong>æ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢</strong>ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚</p>
<p>æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±<strong>æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§</strong>ï¼Œ<strong>è¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„</strong>ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚</p>
<h4 id="é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰"><a href="#é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰" class="headerlink" title="é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰"></a>é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰</h4><p>è¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼š<strong>å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š</strong>ï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ª<strong>å®Œæ•´é•œåƒ</strong>ï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠ<strong>æ¶ˆæ¯åŒæ­¥</strong>åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-8.png" alt="img"></p>
<p>é‚£ä¹ˆ<strong>å¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼</strong>å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯<strong>é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥</strong>ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±<strong>æ²¡æœ‰æ‰©å±•æ€§å¯è¨€</strong>äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶<strong>æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•</strong>ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h3 id="Kafka-çš„é«˜å¯ç”¨æ€§"><a href="#Kafka-çš„é«˜å¯ç”¨æ€§" class="headerlink" title="Kafka çš„é«˜å¯ç”¨æ€§"></a>Kafka çš„é«˜å¯ç”¨æ€§</h3><p>Kafka ä¸€ä¸ªæœ€åŸºæœ¬çš„æ¶æ„è®¤è¯†ï¼šç”±å¤šä¸ª broker ç»„æˆï¼Œæ¯ä¸ª broker æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›ä½ åˆ›å»ºä¸€ä¸ª topicï¼Œè¿™ä¸ª topic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition å¯ä»¥å­˜åœ¨äºä¸åŒçš„ broker ä¸Šï¼Œæ¯ä¸ª partition å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p>
<p>è¿™å°±æ˜¯<strong>å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª topic çš„æ•°æ®ï¼Œæ˜¯<strong>åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®</strong>ã€‚</p>
<p>å®é™…ä¸Š RabbmitMQ ä¹‹ç±»çš„ï¼Œå¹¶ä¸æ˜¯åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒå°±æ˜¯ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªä¸è¿‡æä¾›äº†ä¸€äº›é›†ç¾¤ã€HA(High Availability, é«˜å¯ç”¨æ€§) çš„æœºåˆ¶è€Œå·²ï¼Œå› ä¸ºæ— è®ºæ€ä¹ˆç©å„¿ï¼ŒRabbitMQ ä¸€ä¸ª queue çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹é‡Œçš„ï¼Œé•œåƒé›†ç¾¤ä¸‹ï¼Œä¹Ÿæ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æ”¾è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ã€‚</p>
<p>Kafka 0.8 ä»¥å‰ï¼Œæ˜¯æ²¡æœ‰ HA æœºåˆ¶çš„ï¼Œå°±æ˜¯ä»»ä½•ä¸€ä¸ª broker å®•æœºäº†ï¼Œé‚£ä¸ª broker ä¸Šçš„ partition å°±åºŸäº†ï¼Œæ²¡æ³•å†™ä¹Ÿæ²¡æ³•è¯»ï¼Œæ²¡æœ‰ä»€ä¹ˆé«˜å¯ç”¨æ€§å¯è¨€ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å‡è®¾åˆ›å»ºäº†ä¸€ä¸ª topicï¼ŒæŒ‡å®šå…¶ partition æ•°é‡æ˜¯ 3 ä¸ªï¼Œåˆ†åˆ«åœ¨ä¸‰å°æœºå™¨ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœç¬¬äºŒå°æœºå™¨å®•æœºäº†ï¼Œä¼šå¯¼è‡´è¿™ä¸ª topic çš„ 1&#x2F;3 çš„æ•°æ®å°±ä¸¢äº†ï¼Œå› æ­¤è¿™ä¸ªæ˜¯åšä¸åˆ°é«˜å¯ç”¨çš„ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/kafka-before.png" alt="img"></p>
<p>Kafka 0.8 ä»¥åï¼Œæä¾›äº† HA æœºåˆ¶ï¼Œå°±æ˜¯ replicaï¼ˆå¤åˆ¶å“ï¼‰ å‰¯æœ¬æœºåˆ¶ã€‚æ¯ä¸ª partition çš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª replica å‰¯æœ¬ã€‚æ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª leader æ‰“äº¤é“ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚å†™çš„æ—¶å€™ï¼Œleader ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ follower ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» leader ä¸Šçš„æ•°æ®å³å¯ã€‚åªèƒ½è¯»å†™ leaderï¼Ÿå¾ˆç®€å•ï¼Œ<strong>è¦æ˜¯ä½ å¯ä»¥éšæ„è¯»å†™æ¯ä¸ª followerï¼Œé‚£ä¹ˆå°±è¦ care æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜</strong>ï¼Œç³»ç»Ÿå¤æ‚åº¦å¤ªé«˜ï¼Œå¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚Kafka ä¼šå‡åŒ€åœ°å°†ä¸€ä¸ª partition çš„æ‰€æœ‰ replica åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·æ‰å¯ä»¥æé«˜å®¹é”™æ€§ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/kafka-after.png" alt="img"></p>
<p>è¿™ä¹ˆæï¼Œå°±æœ‰æ‰€è°“çš„<strong>é«˜å¯ç”¨æ€§</strong>äº†ï¼Œå› ä¸ºå¦‚æœæŸä¸ª broker å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œé‚£ä¸ª broker ä¸Šé¢çš„ partition åœ¨å…¶ä»–æœºå™¨ä¸Šéƒ½æœ‰å‰¯æœ¬çš„ã€‚å¦‚æœè¿™ä¸ªå®•æœºçš„ broker ä¸Šé¢æœ‰æŸä¸ª partition çš„ leaderï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä» follower ä¸­<strong>é‡æ–°é€‰ä¸¾</strong>ä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ï¼Œå¤§å®¶ç»§ç»­è¯»å†™é‚£ä¸ªæ–°çš„ leader å³å¯ã€‚è¿™å°±æœ‰æ‰€è°“çš„é«˜å¯ç”¨æ€§äº†ã€‚</p>
<p><strong>å†™æ•°æ®</strong>çš„æ—¶å€™ï¼Œç”Ÿäº§è€…å°±å†™ leaderï¼Œç„¶å leader å°†æ•°æ®è½åœ°å†™æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– follower è‡ªå·±ä¸»åŠ¨ä» leader æ¥ pull æ•°æ®ã€‚ä¸€æ—¦æ‰€æœ‰ follower åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ ack ç»™ leaderï¼Œleader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œè¿˜å¯ä»¥é€‚å½“è°ƒæ•´è¿™ä¸ªè¡Œä¸ºï¼‰</p>
<p><strong>æ¶ˆè´¹</strong>çš„æ—¶å€™ï¼Œåªä¼šä» leader å»è¯»ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¤§è‡´æ˜ç™½äº† Kafka æ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨æœºåˆ¶çš„äº†ï¼Œå¯¹å§ï¼Ÿä¸è‡³äºä¸€æ— æ‰€çŸ¥ï¼Œç°åœºè¿˜èƒ½ç»™é¢è¯•å®˜ç”»ç”»å›¾ã€‚è¦æ˜¯é‡ä¸Šé¢è¯•å®˜ç¡®å®æ˜¯ Kafka é«˜æ‰‹ï¼Œæ·±æŒ–äº†é—®ï¼Œé‚£ä½ åªèƒ½è¯´ä¸å¥½æ„æ€ï¼Œå¤ªæ·±å…¥çš„ä½ æ²¡ç ”ç©¶è¿‡ã€‚</p>
<h2 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿï¼ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼‰"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿï¼ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼‰" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿï¼ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼‰"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Ÿï¼ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼‰</h2><p>é¦–å…ˆï¼Œæ¯”å¦‚ RabbitMQã€RocketMQã€Kafkaï¼Œéƒ½æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼Œæ­£å¸¸ã€‚å› ä¸ºè¿™é—®é¢˜é€šå¸¸ä¸æ˜¯ MQ è‡ªå·±ä¿è¯çš„ï¼Œæ˜¯ç”±æˆ‘ä»¬å¼€å‘æ¥ä¿è¯çš„ã€‚æŒ‘ä¸€ä¸ª Kafka æ¥ä¸¾ä¸ªä¾‹å­ï¼Œè¯´è¯´æ€ä¹ˆé‡å¤æ¶ˆè´¹å§ã€‚</p>
<p>Kafka å®é™…ä¸Šæœ‰ä¸ª offset çš„æ¦‚å¿µï¼Œå°±æ˜¯æ¯ä¸ªæ¶ˆæ¯å†™è¿›å»ï¼Œéƒ½æœ‰ä¸€ä¸ª offsetï¼Œä»£è¡¨æ¶ˆæ¯çš„åºå·ï¼Œç„¶å consumer æ¶ˆè´¹äº†æ•°æ®ä¹‹åï¼Œ<strong>æ¯éš”ä¸€æ®µæ—¶é—´</strong>ï¼ˆå®šæ—¶å®šæœŸï¼‰ï¼Œä¼šæŠŠè‡ªå·±æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯çš„ offset æäº¤ä¸€ä¸‹ï¼Œè¡¨ç¤ºâ€œæˆ‘å·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œä¸‹æ¬¡æˆ‘è¦æ˜¯é‡å¯å•¥çš„ï¼Œä½ å°±è®©æˆ‘ç»§ç»­ä»ä¸Šæ¬¡æ¶ˆè´¹åˆ°çš„ offset æ¥ç»§ç»­æ¶ˆè´¹å§â€ã€‚</p>
<p>ä½†æ˜¯å‡¡äº‹æ€»æœ‰æ„å¤–ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰ç”Ÿäº§ç»å¸¸é‡åˆ°çš„ï¼Œå°±æ˜¯ä½ æœ‰æ—¶å€™é‡å¯ç³»ç»Ÿï¼Œçœ‹ä½ æ€ä¹ˆé‡å¯äº†ï¼Œå¦‚æœç¢°åˆ°ç‚¹ç€æ€¥çš„ï¼Œç›´æ¥ kill è¿›ç¨‹äº†ï¼Œå†é‡å¯ã€‚è¿™ä¼šå¯¼è‡´ consumer æœ‰äº›æ¶ˆæ¯å¤„ç†äº†ï¼Œä½†æ˜¯æ²¡æ¥å¾—åŠæäº¤ offsetï¼Œå°´å°¬äº†ã€‚é‡å¯ä¹‹åï¼Œå°‘æ•°æ¶ˆæ¯ä¼šå†æ¬¡æ¶ˆè´¹ä¸€æ¬¡ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ã€‚</p>
<p>æœ‰è¿™ä¹ˆä¸ªåœºæ™¯ã€‚æ•°æ® 1&#x2F;2&#x2F;3 ä¾æ¬¡è¿›å…¥ kafkaï¼Œkafka ä¼šç»™è¿™ä¸‰æ¡æ•°æ®æ¯æ¡åˆ†é…ä¸€ä¸ª offsetï¼Œä»£è¡¨è¿™æ¡æ•°æ®çš„åºå·ï¼Œæˆ‘ä»¬å°±å‡è®¾åˆ†é…çš„ offset ä¾æ¬¡æ˜¯ 152&#x2F;153&#x2F;154ã€‚æ¶ˆè´¹è€…ä» kafka å»æ¶ˆè´¹çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºå»æ¶ˆè´¹ã€‚å‡å¦‚å½“æ¶ˆè´¹è€…æ¶ˆè´¹äº† <code>offset=153</code> çš„è¿™æ¡æ•°æ®ï¼Œåˆšå‡†å¤‡å»æäº¤ offset åˆ° zookeeperï¼Œæ­¤æ—¶æ¶ˆè´¹è€…è¿›ç¨‹è¢«é‡å¯äº†ã€‚é‚£ä¹ˆæ­¤æ—¶æ¶ˆè´¹è¿‡çš„æ•°æ® 1&#x2F;2 çš„ offset å¹¶æ²¡æœ‰æäº¤ï¼Œkafka ä¹Ÿå°±ä¸çŸ¥é“ä½ å·²ç»æ¶ˆè´¹äº† <code>offset=153</code> è¿™æ¡æ•°æ®ã€‚é‚£ä¹ˆé‡å¯ä¹‹åï¼Œæ¶ˆè´¹è€…ä¼šæ‰¾ kafka è¯´ï¼Œå˜¿ï¼Œå“¥å„¿ä»¬ï¼Œä½ ç»™æˆ‘æ¥ç€æŠŠä¸Šæ¬¡æˆ‘æ¶ˆè´¹åˆ°çš„é‚£ä¸ªåœ°æ–¹åé¢çš„æ•°æ®ç»§ç»­ç»™æˆ‘ä¼ é€’è¿‡æ¥ã€‚ç”±äºä¹‹å‰çš„ offset æ²¡æœ‰æäº¤æˆåŠŸï¼Œé‚£ä¹ˆæ•°æ® 1&#x2F;2 ä¼šå†æ¬¡ä¼ è¿‡æ¥ï¼Œå¦‚æœæ­¤æ—¶æ¶ˆè´¹è€…æ²¡æœ‰å»é‡çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´é‡å¤æ¶ˆè´¹ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-10.png" alt="img"></p>
<p>å¦‚æœæ¶ˆè´¹è€…å¹²çš„äº‹å„¿æ˜¯æ‹¿ä¸€æ¡æ•°æ®å°±å¾€æ•°æ®åº“é‡Œå†™ä¸€æ¡ï¼Œä¼šå¯¼è‡´è¯´ï¼Œä½ å¯èƒ½å°±æŠŠæ•°æ® 1&#x2F;2 åœ¨æ•°æ®åº“é‡Œæ’å…¥äº† 2 æ¬¡ï¼Œé‚£ä¹ˆæ•°æ®å°±é”™å•¦ã€‚</p>
<p>å…¶å®é‡å¤æ¶ˆè´¹ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯ä½ æ²¡è€ƒè™‘åˆ°é‡å¤æ¶ˆè´¹ä¹‹åï¼Œ<strong>æ€ä¹ˆä¿è¯å¹‚ç­‰æ€§</strong>ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­å§ã€‚å‡è®¾ä½ æœ‰ä¸ªç³»ç»Ÿï¼Œæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯å°±å¾€æ•°æ®åº“é‡Œæ’å…¥ä¸€æ¡æ•°æ®ï¼Œè¦æ˜¯ä½ ä¸€ä¸ªæ¶ˆæ¯é‡å¤ä¸¤æ¬¡ï¼Œä½ ä¸å°±æ’å…¥äº†ä¸¤æ¡ï¼Œè¿™æ•°æ®ä¸å°±é”™äº†ï¼Ÿä½†æ˜¯ä½ è¦æ˜¯æ¶ˆè´¹åˆ°ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œè‡ªå·±åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œè‹¥æ˜¯å°±ç›´æ¥æ‰”äº†ï¼Œè¿™æ ·ä¸å°±ä¿ç•™äº†ä¸€æ¡æ•°æ®ï¼Œä»è€Œä¿è¯äº†æ•°æ®çš„æ­£ç¡®æ€§ã€‚</p>
<p>ä¸€æ¡æ•°æ®é‡å¤å‡ºç°ä¸¤æ¬¡ï¼Œæ•°æ®åº“é‡Œå°±åªæœ‰ä¸€æ¡æ•°æ®ï¼Œè¿™å°±ä¿è¯äº†ç³»ç»Ÿçš„å¹‚ç­‰æ€§ã€‚</p>
<p>å¹‚ç­‰æ€§ï¼Œé€šä¿—ç‚¹è¯´ï¼Œå°±ä¸€ä¸ªæ•°æ®ï¼Œæˆ–è€…ä¸€ä¸ªè¯·æ±‚ï¼Œç»™ä½ é‡å¤æ¥å¤šæ¬¡ï¼Œä½ å¾—ç¡®ä¿å¯¹åº”çš„æ•°æ®æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œ<strong>ä¸èƒ½å‡ºé”™</strong>ã€‚</p>
<p>æ‰€ä»¥ç¬¬äºŒä¸ªé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆä¿è¯æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼Ÿ</p>
<p>å…¶å®è¿˜æ˜¯å¾—ç»“åˆä¸šåŠ¡æ¥æ€è€ƒï¼Œæˆ‘è¿™é‡Œç»™å‡ ä¸ªæ€è·¯ï¼š</p>
<ul>
<li>æ¯”å¦‚ä½ æ‹¿ä¸ªæ•°æ®è¦å†™åº“ï¼Œä½ å…ˆæ ¹æ®ä¸»é”®æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœè¿™æ•°æ®éƒ½æœ‰äº†ï¼Œä½ å°±åˆ«æ’å…¥äº†ï¼Œupdate ä¸€ä¸‹å¥½å§ã€‚</li>
<li>æ¯”å¦‚ä½ æ˜¯å†™ Redisï¼Œé‚£æ²¡é—®é¢˜äº†ï¼Œåæ­£æ¯æ¬¡éƒ½æ˜¯ setï¼Œå¤©ç„¶å¹‚ç­‰æ€§ã€‚</li>
<li>æ¯”å¦‚ä½ ä¸æ˜¯ä¸Šé¢ä¸¤ä¸ªåœºæ™¯ï¼Œé‚£åšçš„ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½ éœ€è¦è®©ç”Ÿäº§è€…å‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œé‡Œé¢åŠ ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ idï¼Œç±»ä¼¼è®¢å• id ä¹‹ç±»çš„ä¸œè¥¿ï¼Œç„¶åä½ è¿™é‡Œæ¶ˆè´¹åˆ°äº†ä¹‹åï¼Œå…ˆæ ¹æ®è¿™ä¸ª id å»æ¯”å¦‚ Redis é‡ŒæŸ¥ä¸€ä¸‹ï¼Œä¹‹å‰æ¶ˆè´¹è¿‡å—ï¼Ÿå¦‚æœæ²¡æœ‰æ¶ˆè´¹è¿‡ï¼Œä½ å°±å¤„ç†ï¼Œç„¶åè¿™ä¸ª id å†™ Redisã€‚å¦‚æœæ¶ˆè´¹è¿‡äº†ï¼Œé‚£ä½ å°±åˆ«å¤„ç†äº†ï¼Œä¿è¯åˆ«é‡å¤å¤„ç†ç›¸åŒçš„æ¶ˆæ¯å³å¯ã€‚</li>
<li>æ¯”å¦‚åŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šé‡å¤æ’å…¥å¤šæ¡ã€‚å› ä¸ºæœ‰å”¯ä¸€é”®çº¦æŸäº†ï¼Œé‡å¤æ•°æ®æ’å…¥åªä¼šæŠ¥é”™ï¼Œä¸ä¼šå¯¼è‡´æ•°æ®åº“ä¸­å‡ºç°è„æ•°æ®ã€‚</li>
</ul>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/mq-11.png" alt="img"></p>
<p>å½“ç„¶ï¼Œå¦‚ä½•ä¿è¯ MQ çš„æ¶ˆè´¹æ˜¯å¹‚ç­‰æ€§çš„ï¼Œéœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡æ¥çœ‹ã€‚</p>
<h2 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿï¼ˆå¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼‰</h2><p>æ•°æ®çš„ä¸¢å¤±é—®é¢˜ï¼Œå¯èƒ½å‡ºç°åœ¨ç”Ÿäº§è€…ã€MQã€æ¶ˆè´¹è€…ä¸­ï¼Œå’±ä»¬ä» RabbitMQ å’Œ Kafka åˆ†åˆ«æ¥åˆ†æä¸€ä¸‹å§ã€‚</p>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><p><img src="https://github.com/doocs/advanced-java/blob/master/images/rabbitmq-message-lose.png" alt="img"></p>
<h4 id="ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®"><a href="#ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®" class="headerlink" title="ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®"></a>ç”Ÿäº§è€…å¼„ä¸¢äº†æ•°æ®</h4><p>ç”Ÿäº§è€…å°†æ•°æ®å‘é€åˆ° RabbitMQ çš„æ—¶å€™ï¼Œå¯èƒ½æ•°æ®å°±åœ¨åŠè·¯ç»™æä¸¢äº†ï¼Œå› ä¸ºç½‘ç»œé—®é¢˜å•¥çš„ï¼Œéƒ½æœ‰å¯èƒ½ã€‚</p>
<p>æ­¤æ—¶å¯ä»¥é€‰æ‹©ç”¨ RabbitMQ æä¾›çš„äº‹åŠ¡åŠŸèƒ½ï¼Œå°±æ˜¯ç”Ÿäº§è€…<strong>å‘é€æ•°æ®ä¹‹å‰</strong>å¼€å¯ RabbitMQ äº‹åŠ¡<code>channel.txSelect</code>ï¼Œç„¶åå‘é€æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯æ²¡æœ‰æˆåŠŸè¢« RabbitMQ æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ä¼šæ”¶åˆ°å¼‚å¸¸æŠ¥é”™ï¼Œæ­¤æ—¶å°±å¯ä»¥å›æ»šäº‹åŠ¡<code>channel.txRollback</code>ï¼Œç„¶åé‡è¯•å‘é€æ¶ˆæ¯ï¼›å¦‚æœæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯ä»¥æäº¤äº‹åŠ¡<code>channel.txCommit</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯äº‹åŠ¡</span></span><br><span class="line">channel.txSelect</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå‘é€æ¶ˆæ¯</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    channel.txRollback</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå†æ¬¡é‡å‘è¿™æ¡æ¶ˆæ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤äº‹åŠ¡</span></span><br><span class="line">channel.txCommit</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯é—®é¢˜æ˜¯ï¼ŒRabbitMQ äº‹åŠ¡æœºåˆ¶ï¼ˆåŒæ­¥ï¼‰ä¸€æï¼ŒåŸºæœ¬ä¸Š<strong>ååé‡ä¼šä¸‹æ¥ï¼Œå› ä¸ºå¤ªè€—æ€§èƒ½</strong>ã€‚</p>
<p>æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä½ è¦ç¡®ä¿è¯´å†™ RabbitMQ çš„æ¶ˆæ¯åˆ«ä¸¢ï¼Œå¯ä»¥å¼€å¯ <code>confirm</code> æ¨¡å¼ï¼Œåœ¨ç”Ÿäº§è€…é‚£é‡Œè®¾ç½®å¼€å¯ <code>confirm</code>æ¨¡å¼ä¹‹åï¼Œä½ æ¯æ¬¡å†™çš„æ¶ˆæ¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œç„¶åå¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª <code>ack</code> æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚å¦‚æœ RabbitMQ æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå›è°ƒä½ çš„ä¸€ä¸ª <code>nack</code> æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•ã€‚è€Œä¸”ä½ å¯ä»¥ç»“åˆè¿™ä¸ªæœºåˆ¶è‡ªå·±åœ¨å†…å­˜é‡Œç»´æŠ¤æ¯ä¸ªæ¶ˆæ¯ id çš„çŠ¶æ€ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡å‘ã€‚</p>
<p>äº‹åŠ¡æœºåˆ¶å’Œ <code>confirm</code> æœºåˆ¶æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œ<strong>äº‹åŠ¡æœºåˆ¶æ˜¯åŒæ­¥çš„</strong>ï¼Œä½ æäº¤ä¸€ä¸ªäº‹åŠ¡ä¹‹åä¼š<strong>é˜»å¡</strong>åœ¨é‚£å„¿ï¼Œä½†æ˜¯ <code>confirm</code> æœºåˆ¶æ˜¯<strong>å¼‚æ­¥</strong>çš„ï¼Œä½ å‘é€ä¸ªæ¶ˆæ¯ä¹‹åå°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åé‚£ä¸ªæ¶ˆæ¯ RabbitMQ æ¥æ”¶äº†ä¹‹åä¼šå¼‚æ­¥å›è°ƒä½ çš„ä¸€ä¸ªæ¥å£é€šçŸ¥ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶åˆ°äº†ã€‚</p>
<p>æ‰€ä»¥ä¸€èˆ¬åœ¨ç”Ÿäº§è€…è¿™å—<strong>é¿å…æ•°æ®ä¸¢å¤±</strong>ï¼Œéƒ½æ˜¯ç”¨ <code>confirm</code> æœºåˆ¶çš„ã€‚</p>
<h4 id="RabbitMQ-å¼„ä¸¢äº†æ•°æ®"><a href="#RabbitMQ-å¼„ä¸¢äº†æ•°æ®" class="headerlink" title="RabbitMQ å¼„ä¸¢äº†æ•°æ®"></a>RabbitMQ å¼„ä¸¢äº†æ•°æ®</h4><p>å°±æ˜¯ RabbitMQ è‡ªå·±å¼„ä¸¢äº†æ•°æ®ï¼Œè¿™ä¸ªä½ å¿…é¡»<strong>å¼€å¯ RabbitMQ çš„æŒä¹…åŒ–</strong>ï¼Œå°±æ˜¯æ¶ˆæ¯å†™å…¥ä¹‹åä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå“ªæ€•æ˜¯ RabbitMQ è‡ªå·±æŒ‚äº†ï¼Œ<strong>æ¢å¤ä¹‹åä¼šè‡ªåŠ¨è¯»å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®</strong>ï¼Œä¸€èˆ¬æ•°æ®ä¸ä¼šä¸¢ã€‚é™¤éæå…¶ç½•è§çš„æ˜¯ï¼ŒRabbitMQ è¿˜æ²¡æŒä¹…åŒ–ï¼Œè‡ªå·±å°±æŒ‚äº†ï¼Œ<strong>å¯èƒ½å¯¼è‡´å°‘é‡æ•°æ®ä¸¢å¤±</strong>ï¼Œä½†æ˜¯è¿™ä¸ªæ¦‚ç‡è¾ƒå°ã€‚</p>
<p>è®¾ç½®æŒä¹…åŒ–æœ‰<strong>ä¸¤ä¸ªæ­¥éª¤</strong>ï¼š</p>
<ul>
<li>åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–<br>è¿™æ ·å°±å¯ä»¥ä¿è¯ RabbitMQ æŒä¹…åŒ– queue çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ä¼šæŒä¹…åŒ– queue é‡Œçš„æ•°æ®çš„ã€‚</li>
<li>ç¬¬äºŒä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ <code>deliveryMode</code> è®¾ç½®ä¸º 2<br>å°±æ˜¯å°†æ¶ˆæ¯è®¾ç½®ä¸ºæŒä¹…åŒ–çš„ï¼Œæ­¤æ—¶ RabbitMQ å°±ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šå»ã€‚</li>
</ul>
<p>å¿…é¡»è¦åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªæŒä¹…åŒ–æ‰è¡Œï¼ŒRabbitMQ å“ªæ€•æ˜¯æŒ‚äº†ï¼Œå†æ¬¡é‡å¯ï¼Œä¹Ÿä¼šä»ç£ç›˜ä¸Šé‡å¯æ¢å¤ queueï¼Œæ¢å¤è¿™ä¸ª queue é‡Œçš„æ•°æ®ã€‚</p>
<p>æ³¨æ„ï¼Œå“ªæ€•æ˜¯ä½ ç»™ RabbitMQ å¼€å¯äº†æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿæœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯å†™åˆ°äº† RabbitMQ ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œç»“æœä¸å·§ï¼Œæ­¤æ—¶ RabbitMQ æŒ‚äº†ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜é‡Œçš„ä¸€ç‚¹ç‚¹æ•°æ®ä¸¢å¤±ã€‚</p>
<p>æ‰€ä»¥ï¼ŒæŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ <code>confirm</code> æœºåˆ¶é…åˆèµ·æ¥ï¼Œåªæœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥ç”Ÿäº§è€… <code>ack</code> äº†ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯åœ¨æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹å‰ï¼ŒRabbitMQ æŒ‚äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œç”Ÿäº§è€…æ”¶ä¸åˆ° <code>ack</code>ï¼Œä½ ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±é‡å‘çš„ã€‚</p>
<h4 id="æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®"><a href="#æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®" class="headerlink" title="æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®"></a>æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®</h4><p>RabbitMQ å¦‚æœä¸¢å¤±äº†æ•°æ®ï¼Œä¸»è¦æ˜¯å› ä¸ºä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œ<strong>åˆšæ¶ˆè´¹åˆ°ï¼Œè¿˜æ²¡å¤„ç†ï¼Œç»“æœè¿›ç¨‹æŒ‚äº†</strong>ï¼Œæ¯”å¦‚é‡å¯äº†ï¼Œé‚£ä¹ˆå°±å°´å°¬äº†ï¼ŒRabbitMQ è®¤ä¸ºä½ éƒ½æ¶ˆè´¹äº†ï¼Œè¿™æ•°æ®å°±ä¸¢äº†ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™å¾—ç”¨ RabbitMQ æä¾›çš„ <code>ack</code> æœºåˆ¶ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ å¿…é¡»å…³é—­ RabbitMQ çš„è‡ªåŠ¨ <code>ack</code>ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª api æ¥è°ƒç”¨å°±è¡Œï¼Œç„¶åæ¯æ¬¡ä½ è‡ªå·±ä»£ç é‡Œç¡®ä¿å¤„ç†å®Œçš„æ—¶å€™ï¼Œå†åœ¨ç¨‹åºé‡Œ <code>ack</code> ä¸€æŠŠã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœä½ è¿˜æ²¡å¤„ç†å®Œï¼Œä¸å°±æ²¡æœ‰ <code>ack</code> äº†ï¼Ÿé‚£ RabbitMQ å°±è®¤ä¸ºä½ è¿˜æ²¡å¤„ç†å®Œï¼Œè¿™ä¸ªæ—¶å€™ RabbitMQ ä¼šæŠŠè¿™ä¸ªæ¶ˆè´¹åˆ†é…ç»™åˆ«çš„ consumer å»å¤„ç†ï¼Œæ¶ˆæ¯æ˜¯ä¸ä¼šä¸¢çš„ã€‚</p>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/rabbitmq-message-lose-solution.png" alt="img"></p>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><h4 id="æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®-1"><a href="#æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®-1" class="headerlink" title="æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®"></a>æ¶ˆè´¹ç«¯å¼„ä¸¢äº†æ•°æ®</h4><p>å”¯ä¸€å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…å¼„ä¸¢æ•°æ®çš„æƒ…å†µï¼Œå°±æ˜¯è¯´ï¼Œä½ æ¶ˆè´¹åˆ°äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œç„¶åæ¶ˆè´¹è€…é‚£è¾¹<strong>è‡ªåŠ¨æäº¤äº† offset</strong>ï¼Œè®© Kafka ä»¥ä¸ºä½ å·²ç»æ¶ˆè´¹å¥½äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½†å…¶å®ä½ æ‰åˆšå‡†å¤‡å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä½ è¿˜æ²¡å¤„ç†ï¼Œä½ è‡ªå·±å°±æŒ‚äº†ï¼Œæ­¤æ—¶è¿™æ¡æ¶ˆæ¯å°±ä¸¢å’¯ã€‚</p>
<p>è¿™ä¸æ˜¯è·Ÿ RabbitMQ å·®ä¸å¤šå—ï¼Œå¤§å®¶éƒ½çŸ¥é“ Kafka ä¼šè‡ªåŠ¨æäº¤ offsetï¼Œé‚£ä¹ˆåªè¦<strong>å…³é—­è‡ªåŠ¨æäº¤</strong> offsetï¼Œåœ¨å¤„ç†å®Œä¹‹åè‡ªå·±æ‰‹åŠ¨æäº¤ offsetï¼Œå°±å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢ã€‚ä½†æ˜¯æ­¤æ—¶ç¡®å®è¿˜æ˜¯<strong>å¯èƒ½ä¼šæœ‰é‡å¤æ¶ˆè´¹</strong>ï¼Œæ¯”å¦‚ä½ åˆšå¤„ç†å®Œï¼Œè¿˜æ²¡æäº¤ offsetï¼Œç»“æœè‡ªå·±æŒ‚äº†ï¼Œæ­¤æ—¶è‚¯å®šä¼šé‡å¤æ¶ˆè´¹ä¸€æ¬¡ï¼Œè‡ªå·±ä¿è¯å¹‚ç­‰æ€§å°±å¥½äº†ã€‚</p>
<p>ç”Ÿäº§ç¯å¢ƒç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯´æˆ‘ä»¬çš„ Kafka æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†æ•°æ®ä¹‹åæ˜¯å†™åˆ°ä¸€ä¸ªå†…å­˜çš„ queue é‡Œå…ˆç¼“å†²ä¸€ä¸‹ï¼Œç»“æœæœ‰çš„æ—¶å€™ï¼Œä½ åˆšæŠŠæ¶ˆæ¯å†™å…¥å†…å­˜ queueï¼Œç„¶åæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æäº¤ offsetã€‚ç„¶åæ­¤æ—¶æˆ‘ä»¬é‡å¯äº†ç³»ç»Ÿï¼Œå°±ä¼šå¯¼è‡´å†…å­˜ queue é‡Œè¿˜æ²¡æ¥å¾—åŠå¤„ç†çš„æ•°æ®å°±ä¸¢å¤±äº†ã€‚</p>
<h4 id="Kafka-å¼„ä¸¢äº†æ•°æ®"><a href="#Kafka-å¼„ä¸¢äº†æ•°æ®" class="headerlink" title="Kafka å¼„ä¸¢äº†æ•°æ®"></a>Kafka å¼„ä¸¢äº†æ•°æ®</h4><p>è¿™å—æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯ Kafka æŸä¸ª broker å®•æœºï¼Œç„¶åé‡æ–°é€‰ä¸¾ partition çš„ leaderã€‚å¤§å®¶æƒ³æƒ³ï¼Œè¦æ˜¯æ­¤æ—¶å…¶ä»–çš„ follower åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥ï¼Œç»“æœæ­¤æ—¶ leader æŒ‚äº†ï¼Œç„¶åé€‰ä¸¾æŸä¸ª follower æˆ leader ä¹‹åï¼Œä¸å°±å°‘äº†ä¸€äº›æ•°æ®ï¼Ÿè¿™å°±ä¸¢äº†ä¸€äº›æ•°æ®å•Šã€‚</p>
<p>ç”Ÿäº§ç¯å¢ƒä¹Ÿé‡åˆ°è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ï¼Œä¹‹å‰ Kafka çš„ leader æœºå™¨å®•æœºäº†ï¼Œå°† follower åˆ‡æ¢ä¸º leader ä¹‹åï¼Œå°±ä¼šå‘ç°è¯´è¿™ä¸ªæ•°æ®å°±ä¸¢äº†ã€‚</p>
<p>æ‰€ä»¥æ­¤æ—¶ä¸€èˆ¬æ˜¯è¦æ±‚èµ·ç è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ç»™ topic è®¾ç½® <code>replication.factor</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬ã€‚</li>
<li>åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® <code>min.insync.replicas</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚ä¸€ä¸ª leader è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª follower è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ leader æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª follower å§ã€‚</li>
<li>åœ¨ producer ç«¯è®¾ç½® <code>acks=all</code>ï¼šè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯<strong>å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†</strong>ã€‚</li>
<li>åœ¨ producer ç«¯è®¾ç½® <code>retries=MAX</code>ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªæ˜¯<strong>è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•</strong>ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚</li>
</ul>
<p>æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒå°±æ˜¯æŒ‰ç…§ä¸Šè¿°è¦æ±‚é…ç½®çš„ï¼Œè¿™æ ·é…ç½®ä¹‹åï¼Œè‡³å°‘åœ¨ Kafka broker ç«¯å°±å¯ä»¥ä¿è¯åœ¨ leader æ‰€åœ¨ broker å‘ç”Ÿæ•…éšœï¼Œè¿›è¡Œ leader åˆ‡æ¢æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</p>
<h4 id="ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ"><a href="#ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ" class="headerlink" title="ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ"></a>ç”Ÿäº§è€…ä¼šä¸ä¼šå¼„ä¸¢æ•°æ®ï¼Ÿ</h4><p>å¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ€è·¯è®¾ç½®äº† <code>acks=all</code>ï¼Œä¸€å®šä¸ä¼šä¸¢ï¼Œè¦æ±‚æ˜¯ï¼Œä½ çš„ leader æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„ follower éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚</p>
<h2 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ</h2><p>æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä»¥å‰åšè¿‡ä¸€ä¸ª mysql <code>binlog</code> åŒæ­¥çš„ç³»ç»Ÿï¼Œå‹åŠ›è¿˜æ˜¯éå¸¸å¤§çš„ï¼Œæ—¥åŒæ­¥æ•°æ®è¦è¾¾åˆ°ä¸Šäº¿ï¼Œå°±æ˜¯è¯´æ•°æ®ä»ä¸€ä¸ª mysql åº“åŸå°ä¸åŠ¨åœ°åŒæ­¥åˆ°å¦ä¸€ä¸ª mysql åº“é‡Œé¢å»ï¼ˆmysql -&gt; mysqlï¼‰ã€‚å¸¸è§çš„ä¸€ç‚¹åœ¨äºè¯´æ¯”å¦‚å¤§æ•°æ® teamï¼Œå°±éœ€è¦åŒæ­¥ä¸€ä¸ª mysql åº“è¿‡æ¥ï¼Œå¯¹å…¬å¸çš„ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®åšå„ç§å¤æ‚çš„æ“ä½œã€‚</p>
<p>ä½ åœ¨ mysql é‡Œå¢åˆ æ”¹ä¸€æ¡æ•°æ®ï¼Œå¯¹åº”å‡ºæ¥äº†å¢åˆ æ”¹ 3 æ¡ <code>binlog</code> æ—¥å¿—ï¼Œæ¥ç€è¿™ä¸‰æ¡ <code>binlog</code> å‘é€åˆ° MQ é‡Œé¢ï¼Œå†æ¶ˆè´¹å‡ºæ¥ä¾æ¬¡æ‰§è¡Œï¼Œèµ·ç å¾—ä¿è¯äººå®¶æ˜¯æŒ‰ç…§é¡ºåºæ¥çš„å§ï¼Ÿä¸ç„¶æœ¬æ¥æ˜¯ï¼šå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ï¼›ä½ æ¥æ˜¯æ¢äº†é¡ºåºç»™æ‰§è¡Œæˆåˆ é™¤ã€ä¿®æ”¹ã€å¢åŠ ï¼Œä¸å…¨é”™äº†ä¹ˆã€‚</p>
<p>æœ¬æ¥è¿™ä¸ªæ•°æ®åŒæ­¥è¿‡æ¥ï¼Œåº”è¯¥æœ€åè¿™ä¸ªæ•°æ®è¢«åˆ é™¤äº†ï¼›ç»“æœä½ æé”™äº†è¿™ä¸ªé¡ºåºï¼Œæœ€åè¿™ä¸ªæ•°æ®ä¿ç•™ä¸‹æ¥äº†ï¼Œæ•°æ®åŒæ­¥å°±å‡ºé”™äº†ã€‚</p>
<p>å…ˆçœ‹çœ‹é¡ºåºä¼šé”™ä¹±çš„ä¿©åœºæ™¯ï¼š</p>
<ul>
<li><strong>RabbitMQ</strong>ï¼šä¸€ä¸ª queueï¼Œå¤šä¸ª consumerã€‚æ¯”å¦‚ï¼Œç”Ÿäº§è€…å‘ RabbitMQ é‡Œå‘é€äº†ä¸‰æ¡æ•°æ®ï¼Œé¡ºåºä¾æ¬¡æ˜¯ data1&#x2F;data2&#x2F;data3ï¼Œå‹å…¥çš„æ˜¯ RabbitMQ çš„ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«ä» MQ ä¸­æ¶ˆè´¹è¿™ä¸‰æ¡æ•°æ®ä¸­çš„ä¸€æ¡ï¼Œç»“æœæ¶ˆè´¹è€… 2 å…ˆæ‰§è¡Œå®Œæ“ä½œï¼ŒæŠŠ data2 å­˜å…¥æ•°æ®åº“ï¼Œç„¶åæ˜¯ data1&#x2F;data3ã€‚è¿™ä¸æ˜æ˜¾ä¹±äº†ã€‚</li>
</ul>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/rabbitmq-order-01.png" alt="img"></p>
<ul>
<li><strong>Kafka</strong>ï¼šæ¯”å¦‚è¯´æˆ‘ä»¬å»ºäº†ä¸€ä¸ª topicï¼Œæœ‰ä¸‰ä¸ª partitionã€‚ç”Ÿäº§è€…åœ¨å†™çš„æ—¶å€™ï¼Œå…¶å®å¯ä»¥æŒ‡å®šä¸€ä¸ª keyï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬æŒ‡å®šäº†æŸä¸ªè®¢å• id ä½œä¸º keyï¼Œé‚£ä¹ˆè¿™ä¸ªè®¢å•ç›¸å…³çš„æ•°æ®ï¼Œä¸€å®šä¼šè¢«åˆ†å‘åˆ°åŒä¸€ä¸ª partition ä¸­å»ï¼Œè€Œä¸”è¿™ä¸ª partition ä¸­çš„æ•°æ®ä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚<br>æ¶ˆè´¹è€…ä» partition ä¸­å–å‡ºæ¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚åˆ°è¿™é‡Œï¼Œé¡ºåºè¿˜æ˜¯ ok çš„ï¼Œæ²¡æœ‰é”™ä¹±ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åœ¨æ¶ˆè´¹è€…é‡Œå¯èƒ½ä¼šæ<strong>å¤šä¸ªçº¿ç¨‹æ¥å¹¶å‘å¤„ç†æ¶ˆæ¯</strong>ã€‚å› ä¸ºå¦‚æœæ¶ˆè´¹è€…æ˜¯å•çº¿ç¨‹æ¶ˆè´¹å¤„ç†ï¼Œè€Œå¤„ç†æ¯”è¾ƒè€—æ—¶çš„è¯ï¼Œæ¯”å¦‚å¤„ç†ä¸€æ¡æ¶ˆæ¯è€—æ—¶å‡ å msï¼Œé‚£ä¹ˆ 1 ç§’é’Ÿåªèƒ½å¤„ç†å‡ åæ¡æ¶ˆæ¯ï¼Œè¿™ååé‡å¤ªä½äº†ã€‚è€Œå¤šä¸ªçº¿ç¨‹å¹¶å‘è·‘çš„è¯ï¼Œé¡ºåºå¯èƒ½å°±ä¹±æ‰äº†ã€‚</li>
</ul>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/kafka-order-01.png" alt="img"></p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><h4 id="RabbitMQ-1"><a href="#RabbitMQ-1" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><p><img src="https://github.com/doocs/advanced-java/blob/master/images/rabbitmq-order-02.png" alt="img"></p>
<h4 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h4><ul>
<li>ä¸€ä¸ª topicï¼Œä¸€ä¸ª partitionï¼Œä¸€ä¸ª consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªã€‚</li>
<li>å†™ N ä¸ªå†…å­˜ queueï¼Œå…·æœ‰ç›¸åŒ key çš„æ•°æ®éƒ½åˆ°åŒä¸€ä¸ªå†…å­˜ queueï¼›ç„¶åå¯¹äº N ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ queue å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚</li>
</ul>
<p><img src="https://github.com/doocs/advanced-java/blob/master/images/kafka-order-02.png" alt="img"></p>
<h2 id="å¦‚ä½•è§£å†³æ¶ˆæ¯é˜Ÿåˆ—çš„å»¶æ—¶ä»¥åŠè¿‡æœŸå¤±æ•ˆé—®é¢˜ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ä»¥åè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæœ‰å‡ ç™¾ä¸‡æ¶ˆæ¯æŒç»­ç§¯å‹å‡ å°æ—¶ï¼Œè¯´è¯´æ€ä¹ˆè§£å†³ï¼Ÿ"><a href="#å¦‚ä½•è§£å†³æ¶ˆæ¯é˜Ÿåˆ—çš„å»¶æ—¶ä»¥åŠè¿‡æœŸå¤±æ•ˆé—®é¢˜ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ä»¥åè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæœ‰å‡ ç™¾ä¸‡æ¶ˆæ¯æŒç»­ç§¯å‹å‡ å°æ—¶ï¼Œè¯´è¯´æ€ä¹ˆè§£å†³ï¼Ÿ" class="headerlink" title="å¦‚ä½•è§£å†³æ¶ˆæ¯é˜Ÿåˆ—çš„å»¶æ—¶ä»¥åŠè¿‡æœŸå¤±æ•ˆé—®é¢˜ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ä»¥åè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæœ‰å‡ ç™¾ä¸‡æ¶ˆæ¯æŒç»­ç§¯å‹å‡ å°æ—¶ï¼Œè¯´è¯´æ€ä¹ˆè§£å†³ï¼Ÿ"></a>å¦‚ä½•è§£å†³æ¶ˆæ¯é˜Ÿåˆ—çš„å»¶æ—¶ä»¥åŠè¿‡æœŸå¤±æ•ˆé—®é¢˜ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ä»¥åè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæœ‰å‡ ç™¾ä¸‡æ¶ˆæ¯æŒç»­ç§¯å‹å‡ å°æ—¶ï¼Œè¯´è¯´æ€ä¹ˆè§£å†³ï¼Ÿ</h2><p>ä½ çœ‹è¿™é—®æ³•ï¼Œå…¶å®æœ¬è´¨é’ˆå¯¹çš„åœºæ™¯ï¼Œéƒ½æ˜¯è¯´ï¼Œå¯èƒ½ä½ çš„æ¶ˆè´¹ç«¯å‡ºäº†é—®é¢˜ï¼Œä¸æ¶ˆè´¹äº†ï¼›æˆ–è€…æ¶ˆè´¹çš„é€Ÿåº¦æå…¶æ…¢ã€‚æ¥ç€å°±å‘çˆ¹äº†ï¼Œå¯èƒ½ä½ çš„æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤çš„ç£ç›˜éƒ½å¿«å†™æ»¡äº†ï¼Œéƒ½æ²¡äººæ¶ˆè´¹ï¼Œè¿™ä¸ªæ—¶å€™æ€ä¹ˆåŠï¼Ÿæˆ–è€…æ˜¯è¿™æ•´ä¸ªå°±ç§¯å‹äº†å‡ ä¸ªå°æ—¶ï¼Œä½ è¿™ä¸ªæ—¶å€™æ€ä¹ˆåŠï¼Ÿæˆ–è€…æ˜¯ä½ ç§¯å‹çš„æ—¶é—´å¤ªé•¿äº†ï¼Œå¯¼è‡´æ¯”å¦‚ RabbitMQ è®¾ç½®äº†æ¶ˆæ¯è¿‡æœŸæ—¶é—´åå°±æ²¡äº†æ€ä¹ˆåŠï¼Ÿ</p>
<p>æ‰€ä»¥å°±è¿™äº‹å„¿ï¼Œå…¶å®çº¿ä¸ŠæŒºå¸¸è§çš„ï¼Œä¸€èˆ¬ä¸å‡ºï¼Œä¸€å‡ºå°±æ˜¯å¤§ caseã€‚ä¸€èˆ¬å¸¸è§äºï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¶ˆè´¹ç«¯æ¯æ¬¡æ¶ˆè´¹ä¹‹åè¦å†™ mysqlï¼Œç»“æœ mysql æŒ‚äº†ï¼Œæ¶ˆè´¹ç«¯ hang é‚£å„¿äº†ï¼Œä¸åŠ¨äº†ï¼›æˆ–è€…æ˜¯æ¶ˆè´¹ç«¯å‡ºäº†ä¸ªä»€ä¹ˆå²”å­ï¼Œå¯¼è‡´æ¶ˆè´¹é€Ÿåº¦æå…¶æ…¢ã€‚</p>
<h3 id="é¢è¯•é¢˜å‰–æ"><a href="#é¢è¯•é¢˜å‰–æ" class="headerlink" title="é¢è¯•é¢˜å‰–æ"></a>é¢è¯•é¢˜å‰–æ</h3><p>å…³äºè¿™ä¸ªäº‹å„¿ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥æ¢³ç†å§ï¼Œå…ˆå‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬ç°åœ¨æ¶ˆè´¹ç«¯å‡ºæ•…éšœäº†ï¼Œç„¶åå¤§é‡æ¶ˆæ¯åœ¨ mq é‡Œç§¯å‹ï¼Œç°åœ¨å‡ºäº‹æ•…äº†ï¼Œæ…Œäº†ã€‚</p>
<h3 id="å¤§é‡æ¶ˆæ¯åœ¨-mq-é‡Œç§¯å‹äº†å‡ ä¸ªå°æ—¶äº†è¿˜æ²¡è§£å†³"><a href="#å¤§é‡æ¶ˆæ¯åœ¨-mq-é‡Œç§¯å‹äº†å‡ ä¸ªå°æ—¶äº†è¿˜æ²¡è§£å†³" class="headerlink" title="å¤§é‡æ¶ˆæ¯åœ¨ mq é‡Œç§¯å‹äº†å‡ ä¸ªå°æ—¶äº†è¿˜æ²¡è§£å†³"></a>å¤§é‡æ¶ˆæ¯åœ¨ mq é‡Œç§¯å‹äº†å‡ ä¸ªå°æ—¶äº†è¿˜æ²¡è§£å†³</h3><p>å‡ åƒä¸‡æ¡æ•°æ®åœ¨ MQ é‡Œç§¯å‹äº†ä¸ƒå…«ä¸ªå°æ—¶ï¼Œä»ä¸‹åˆ 4 ç‚¹å¤šï¼Œç§¯å‹åˆ°äº†æ™šä¸Š 11 ç‚¹å¤šã€‚è¿™ä¸ªæ˜¯æˆ‘ä»¬çœŸå®é‡åˆ°è¿‡çš„ä¸€ä¸ªåœºæ™¯ï¼Œç¡®å®æ˜¯çº¿ä¸Šæ•…éšœäº†ï¼Œè¿™ä¸ªæ—¶å€™è¦ä¸ç„¶å°±æ˜¯ä¿®å¤ consumer çš„é—®é¢˜ï¼Œè®©å®ƒæ¢å¤æ¶ˆè´¹é€Ÿåº¦ï¼Œç„¶åå‚»å‚»çš„ç­‰å¾…å‡ ä¸ªå°æ—¶æ¶ˆè´¹å®Œæ¯•ã€‚è¿™ä¸ªè‚¯å®šä¸èƒ½åœ¨é¢è¯•çš„æ—¶å€™è¯´å§ã€‚</p>
<p>ä¸€ä¸ªæ¶ˆè´¹è€…ä¸€ç§’æ˜¯ 1000 æ¡ï¼Œä¸€ç§’ 3 ä¸ªæ¶ˆè´¹è€…æ˜¯ 3000 æ¡ï¼Œä¸€åˆ†é’Ÿå°±æ˜¯ 18 ä¸‡æ¡ã€‚æ‰€ä»¥å¦‚æœä½ ç§¯å‹äº†å‡ ç™¾ä¸‡åˆ°ä¸Šåƒä¸‡çš„æ•°æ®ï¼Œå³ä½¿æ¶ˆè´¹è€…æ¢å¤äº†ï¼Œä¹Ÿéœ€è¦å¤§æ¦‚ 1 å°æ—¶çš„æ—¶é—´æ‰èƒ½æ¢å¤è¿‡æ¥ã€‚</p>
<p>ä¸€èˆ¬è¿™ä¸ªæ—¶å€™ï¼Œåªèƒ½ä¸´æ—¶ç´§æ€¥æ‰©å®¹äº†ï¼Œå…·ä½“æ“ä½œæ­¥éª¤å’Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆä¿®å¤ consumer çš„é—®é¢˜ï¼Œç¡®ä¿å…¶æ¢å¤æ¶ˆè´¹é€Ÿåº¦ï¼Œç„¶åå°†ç°æœ‰ consumer éƒ½åœæ‰ã€‚</li>
<li>æ–°å»ºä¸€ä¸ª topicï¼Œpartition æ˜¯åŸæ¥çš„ 10 å€ï¼Œä¸´æ—¶å»ºç«‹å¥½åŸå…ˆ 10 å€çš„ queue æ•°é‡ã€‚</li>
<li>ç„¶åå†™ä¸€ä¸ªä¸´æ—¶çš„åˆ†å‘æ•°æ®çš„ consumer ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºéƒ¨ç½²ä¸Šå»æ¶ˆè´¹ç§¯å‹çš„æ•°æ®ï¼Œ<strong>æ¶ˆè´¹ä¹‹åä¸åšè€—æ—¶çš„å¤„ç†</strong>ï¼Œç›´æ¥å‡åŒ€è½®è¯¢å†™å…¥ä¸´æ—¶å»ºç«‹å¥½çš„ 10 å€æ•°é‡çš„ queueã€‚</li>
<li>æ¥ç€ä¸´æ—¶å¾ç”¨ 10 å€çš„æœºå™¨æ¥éƒ¨ç½² consumerï¼Œæ¯ä¸€æ‰¹ consumer æ¶ˆè´¹ä¸€ä¸ªä¸´æ—¶ queue çš„æ•°æ®ã€‚è¿™ç§åšæ³•ç›¸å½“äºæ˜¯ä¸´æ—¶å°† queue èµ„æºå’Œ consumer èµ„æºæ‰©å¤§ 10 å€ï¼Œä»¥æ­£å¸¸çš„ 10 å€é€Ÿåº¦æ¥æ¶ˆè´¹æ•°æ®ã€‚</li>
<li>ç­‰å¿«é€Ÿæ¶ˆè´¹å®Œç§¯å‹æ•°æ®ä¹‹åï¼Œ<strong>å¾—æ¢å¤åŸå…ˆéƒ¨ç½²çš„æ¶æ„</strong>ï¼Œ<strong>é‡æ–°</strong>ç”¨åŸå…ˆçš„ consumer æœºå™¨æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="mq-ä¸­çš„æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆäº†"><a href="#mq-ä¸­çš„æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆäº†" class="headerlink" title="mq ä¸­çš„æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆäº†"></a>mq ä¸­çš„æ¶ˆæ¯è¿‡æœŸå¤±æ•ˆäº†</h3><p>å‡è®¾ä½ ç”¨çš„æ˜¯ RabbitMQï¼ŒRabbtiMQ æ˜¯å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´çš„ï¼Œä¹Ÿå°±æ˜¯ TTLã€‚å¦‚æœæ¶ˆæ¯åœ¨ queue ä¸­ç§¯å‹è¶…è¿‡ä¸€å®šçš„æ—¶é—´å°±ä¼šè¢« RabbitMQ ç»™æ¸…ç†æ‰ï¼Œè¿™ä¸ªæ•°æ®å°±æ²¡äº†ã€‚é‚£è¿™å°±æ˜¯ç¬¬äºŒä¸ªå‘äº†ã€‚è¿™å°±ä¸æ˜¯è¯´æ•°æ®ä¼šå¤§é‡ç§¯å‹åœ¨ mq é‡Œï¼Œè€Œæ˜¯<strong>å¤§é‡çš„æ•°æ®ä¼šç›´æ¥æä¸¢</strong>ã€‚</p>
<p>è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå°±ä¸æ˜¯è¯´è¦å¢åŠ  consumer æ¶ˆè´¹ç§¯å‹çš„æ¶ˆæ¯ï¼Œå› ä¸ºå®é™…ä¸Šæ²¡å•¥ç§¯å‹ï¼Œè€Œæ˜¯ä¸¢äº†å¤§é‡çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥é‡‡å–ä¸€ä¸ªæ–¹æ¡ˆï¼Œå°±æ˜¯<strong>æ‰¹é‡é‡å¯¼</strong>ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰çº¿ä¸Šä¹Ÿæœ‰ç±»ä¼¼çš„åœºæ™¯å¹²è¿‡ã€‚å°±æ˜¯å¤§é‡ç§¯å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å½“æ—¶å°±ç›´æ¥ä¸¢å¼ƒæ•°æ®äº†ï¼Œç„¶åç­‰è¿‡äº†é«˜å³°æœŸä»¥åï¼Œæ¯”å¦‚å¤§å®¶ä¸€èµ·å–å’–å•¡ç†¬å¤œåˆ°æ™šä¸Š 12 ç‚¹ä»¥åï¼Œç”¨æˆ·éƒ½ç¡è§‰äº†ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¼€å§‹å†™ç¨‹åºï¼Œå°†ä¸¢å¤±çš„é‚£æ‰¹æ•°æ®ï¼Œå†™ä¸ªä¸´æ—¶ç¨‹åºï¼Œä¸€ç‚¹ä¸€ç‚¹çš„æŸ¥å‡ºæ¥ï¼Œç„¶åé‡æ–°çŒå…¥ mq é‡Œé¢å»ï¼ŒæŠŠç™½å¤©ä¸¢çš„æ•°æ®ç»™ä»–è¡¥å›æ¥ã€‚ä¹Ÿåªèƒ½æ˜¯è¿™æ ·äº†ã€‚</p>
<p>å‡è®¾ 1 ä¸‡ä¸ªè®¢å•ç§¯å‹åœ¨ mq é‡Œé¢ï¼Œæ²¡æœ‰å¤„ç†ï¼Œå…¶ä¸­ 1000 ä¸ªè®¢å•éƒ½ä¸¢äº†ï¼Œä½ åªèƒ½æ‰‹åŠ¨å†™ç¨‹åºæŠŠé‚£ 1000 ä¸ªè®¢å•ç»™æŸ¥å‡ºæ¥ï¼Œæ‰‹åŠ¨å‘åˆ° mq é‡Œå»å†è¡¥ä¸€æ¬¡ã€‚</p>
<h3 id="mq-éƒ½å¿«å†™æ»¡äº†"><a href="#mq-éƒ½å¿«å†™æ»¡äº†" class="headerlink" title="mq éƒ½å¿«å†™æ»¡äº†"></a>mq éƒ½å¿«å†™æ»¡äº†</h3><p>å¦‚æœæ¶ˆæ¯ç§¯å‹åœ¨ mq é‡Œï¼Œä½ å¾ˆé•¿æ—¶é—´éƒ½æ²¡æœ‰å¤„ç†æ‰ï¼Œæ­¤æ—¶å¯¼è‡´ mq éƒ½å¿«å†™æ»¡äº†ï¼Œå’‹åŠï¼Ÿè¿™ä¸ªè¿˜æœ‰åˆ«çš„åŠæ³•å—ï¼Ÿæ²¡æœ‰ï¼Œè°è®©ä½ ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ‰§è¡Œçš„å¤ªæ…¢äº†ï¼Œä½ ä¸´æ—¶å†™ç¨‹åºï¼Œæ¥å…¥æ•°æ®æ¥æ¶ˆè´¹ï¼Œ<strong>æ¶ˆè´¹ä¸€ä¸ªä¸¢å¼ƒä¸€ä¸ªï¼Œéƒ½ä¸è¦äº†</strong>ï¼Œå¿«é€Ÿæ¶ˆè´¹æ‰æ‰€æœ‰çš„æ¶ˆæ¯ã€‚ç„¶åèµ°ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œåˆ°äº†æ™šä¸Šå†è¡¥æ•°æ®å§ã€‚</p>
<h2 id="å¦‚æœè®©ä½ å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ¶æ„è®¾è®¡å•Šï¼Ÿè¯´ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚"><a href="#å¦‚æœè®©ä½ å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ¶æ„è®¾è®¡å•Šï¼Ÿè¯´ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚" class="headerlink" title="å¦‚æœè®©ä½ å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ¶æ„è®¾è®¡å•Šï¼Ÿè¯´ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚"></a>å¦‚æœè®©ä½ å†™ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥å¦‚ä½•è¿›è¡Œæ¶æ„è®¾è®¡å•Šï¼Ÿè¯´ä¸€ä¸‹ä½ çš„æ€è·¯ã€‚</h2><h3 id="é¢è¯•å®˜å¿ƒç†åˆ†æ"><a href="#é¢è¯•å®˜å¿ƒç†åˆ†æ" class="headerlink" title="é¢è¯•å®˜å¿ƒç†åˆ†æ"></a>é¢è¯•å®˜å¿ƒç†åˆ†æ</h3><p>å…¶å®èŠåˆ°è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬é¢è¯•å®˜è¦è€ƒå¯Ÿä¸¤å—ï¼š</p>
<ul>
<li>ä½ æœ‰æ²¡æœ‰å¯¹æŸä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åšè¿‡è¾ƒä¸ºæ·±å…¥çš„åŸç†çš„äº†è§£ï¼Œæˆ–è€…ä»æ•´ä½“äº†è§£æŠŠæ¡ä½ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶æ„åŸç†ã€‚</li>
<li>çœ‹çœ‹ä½ çš„è®¾è®¡èƒ½åŠ›ï¼Œç»™ä½ ä¸€ä¸ªå¸¸è§çš„ç³»ç»Ÿï¼Œå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œçœ‹çœ‹ä½ èƒ½ä¸èƒ½ä»å…¨å±€æŠŠæ¡ä¸€ä¸‹æ•´ä½“æ¶æ„è®¾è®¡ï¼Œç»™å‡ºä¸€äº›å…³é”®ç‚¹å‡ºæ¥ã€‚</li>
</ul>
<p>è¯´å®è¯ï¼Œé—®ç±»ä¼¼é—®é¢˜çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†äººåŸºæœ¬éƒ½ä¼šè’™ï¼Œå› ä¸ºå¹³æ—¶ä»æ¥æ²¡æœ‰æ€è€ƒè¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œå¤§å¤šæ•°äººå°±æ˜¯å¹³æ—¶åŸ‹å¤´ç”¨ï¼Œä»æ¥ä¸å»æ€è€ƒèƒŒåçš„ä¸€äº›ä¸œè¥¿ã€‚ç±»ä¼¼çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€ä¸ª Spring æ¡†æ¶ä½ ä¼šæ€ä¹ˆåšï¼Ÿå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€ä¸ª Dubbo æ¡†æ¶ä½ ä¼šæ€ä¹ˆåšï¼Ÿå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€ä¸ª MyBatis æ¡†æ¶ä½ ä¼šæ€ä¹ˆåšï¼Ÿ</p>
<h3 id="é¢è¯•é¢˜å‰–æ-1"><a href="#é¢è¯•é¢˜å‰–æ-1" class="headerlink" title="é¢è¯•é¢˜å‰–æ"></a>é¢è¯•é¢˜å‰–æ</h3><p>å…¶å®å›ç­”è¿™ç±»é—®é¢˜ï¼Œè¯´ç™½äº†ï¼Œä¸æ±‚ä½ çœ‹è¿‡é‚£æŠ€æœ¯çš„æºç ï¼Œèµ·ç ä½ è¦å¤§æ¦‚çŸ¥é“é‚£ä¸ªæŠ€æœ¯çš„åŸºæœ¬åŸç†ã€æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€åŸºæœ¬æ¶æ„æ„æˆï¼Œç„¶åå‚ç…§ä¸€äº›å¼€æºçš„æŠ€æœ¯æŠŠä¸€ä¸ªç³»ç»Ÿè®¾è®¡å‡ºæ¥çš„æ€è·¯è¯´ä¸€ä¸‹å°±å¥½ã€‚</p>
<p>æ¯”å¦‚è¯´è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œæˆ‘ä»¬ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥è€ƒè™‘ä¸€ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆè¿™ä¸ª mq å¾—æ”¯æŒå¯ä¼¸ç¼©æ€§å§ï¼Œå°±æ˜¯éœ€è¦çš„æ—¶å€™å¿«é€Ÿæ‰©å®¹ï¼Œå°±å¯ä»¥å¢åŠ ååé‡å’Œå®¹é‡ï¼Œé‚£æ€ä¹ˆæï¼Ÿè®¾è®¡ä¸ªåˆ†å¸ƒå¼çš„ç³»ç»Ÿå‘—ï¼Œå‚ç…§ä¸€ä¸‹ kafka çš„è®¾è®¡ç†å¿µï¼Œbroker -&gt; topic -&gt; partitionï¼Œæ¯ä¸ª partition æ”¾ä¸€ä¸ªæœºå™¨ï¼Œå°±å­˜ä¸€éƒ¨åˆ†æ•°æ®ã€‚å¦‚æœç°åœ¨èµ„æºä¸å¤Ÿäº†ï¼Œç®€å•å•Šï¼Œç»™ topic å¢åŠ  partitionï¼Œç„¶ååšæ•°æ®è¿ç§»ï¼Œå¢åŠ æœºå™¨ï¼Œä¸å°±å¯ä»¥å­˜æ”¾æ›´å¤šæ•°æ®ï¼Œæä¾›æ›´é«˜çš„ååé‡äº†ï¼Ÿ</li>
<li>å…¶æ¬¡ä½ å¾—è€ƒè™‘ä¸€ä¸‹è¿™ä¸ª mq çš„æ•°æ®è¦ä¸è¦è½åœ°ç£ç›˜å§ï¼Ÿé‚£è‚¯å®šè¦äº†ï¼Œè½ç£ç›˜æ‰èƒ½ä¿è¯åˆ«è¿›ç¨‹æŒ‚äº†æ•°æ®å°±ä¸¢äº†ã€‚é‚£è½ç£ç›˜çš„æ—¶å€™æ€ä¹ˆè½å•Šï¼Ÿé¡ºåºå†™ï¼Œè¿™æ ·å°±æ²¡æœ‰ç£ç›˜éšæœºè¯»å†™çš„å¯»å€å¼€é”€ï¼Œç£ç›˜é¡ºåºè¯»å†™çš„æ€§èƒ½æ˜¯å¾ˆé«˜çš„ï¼Œè¿™å°±æ˜¯ kafka çš„æ€è·¯ã€‚</li>
<li>å…¶æ¬¡ä½ è€ƒè™‘ä¸€ä¸‹ä½ çš„ mq çš„å¯ç”¨æ€§å•Šï¼Ÿè¿™ä¸ªäº‹å„¿ï¼Œå…·ä½“å‚è€ƒä¹‹å‰å¯ç”¨æ€§é‚£ä¸ªç¯èŠ‚è®²è§£çš„ kafka çš„é«˜å¯ç”¨ä¿éšœæœºåˆ¶ã€‚å¤šå‰¯æœ¬ -&gt; leader &amp; follower -&gt; broker æŒ‚äº†é‡æ–°é€‰ä¸¾ leader å³å¯å¯¹å¤–æœåŠ¡ã€‚</li>
<li>èƒ½ä¸èƒ½æ”¯æŒæ•°æ® 0 ä¸¢å¤±å•Šï¼Ÿå¯ä»¥çš„ï¼Œå‚è€ƒæˆ‘ä»¬ä¹‹å‰è¯´çš„é‚£ä¸ª kafka æ•°æ®é›¶ä¸¢å¤±æ–¹æ¡ˆã€‚</li>
</ul>
<p>mq è‚¯å®šæ˜¯å¾ˆå¤æ‚çš„ï¼Œé¢è¯•å®˜é—®ä½ è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®æ˜¯ä¸ªå¼€æ”¾é¢˜ï¼Œä»–å°±æ˜¯çœ‹çœ‹ä½ æœ‰æ²¡æœ‰ä»æ¶æ„è§’åº¦æ•´ä½“æ„æ€å’Œè®¾è®¡çš„æ€ç»´ä»¥åŠèƒ½åŠ›ã€‚ç¡®å®è¿™ä¸ªé—®é¢˜å¯ä»¥åˆ·æ‰ä¸€å¤§æ‰¹äººï¼Œå› ä¸ºå¤§éƒ¨åˆ†äººå¹³æ—¶ä¸æ€è€ƒè¿™äº›ä¸œè¥¿ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/d848b7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/d848b7/" class="post-title-link" itemprop="url">Flinkç®€ä»‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>10 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-ç®€ä»‹"><a href="#Flink-ç®€ä»‹" class="headerlink" title="Flink ç®€ä»‹"></a>Flink ç®€ä»‹</h1><blockquote>
<p>å…³é”®æ¦‚å¿µï¼šæºæºä¸æ–­çš„æµå¼æ•°æ®å¤„ç†ã€äº‹ä»¶æ—¶é—´ã€æœ‰çŠ¶æ€æµå¤„ç†å’ŒçŠ¶æ€å¿«ç…§</p>
</blockquote>
<h2 id="æµå¤„ç†"><a href="#æµå¤„ç†" class="headerlink" title="æµå¤„ç†"></a>æµå¤„ç†</h2><p>ä»»ä½•ç±»å‹çš„æ•°æ®éƒ½å¯ä»¥å½¢æˆä¸€ç§äº‹ä»¶æµã€‚ä¿¡ç”¨å¡äº¤æ˜“ã€ä¼ æ„Ÿå™¨æµ‹é‡ã€æœºå™¨æ—¥å¿—ã€ç½‘ç«™æˆ–ç§»åŠ¨åº”ç”¨ç¨‹åºä¸Šçš„ç”¨æˆ·äº¤äº’è®°å½•ï¼Œæ‰€æœ‰è¿™äº›æ•°æ®éƒ½å½¢æˆä¸€ç§æµã€‚</p>
<p>æ•°æ®å¯ä»¥è¢«ä½œä¸º <em>æ— ç•Œ</em> æˆ–è€… <em>æœ‰ç•Œ</em> æµæ¥å¤„ç†ã€‚</p>
<ol>
<li><strong>æ— ç•Œæµ</strong> æœ‰å®šä¹‰æµçš„å¼€å§‹ï¼Œä½†æ²¡æœ‰å®šä¹‰æµçš„ç»“æŸã€‚å®ƒä»¬ä¼šæ— ä¼‘æ­¢åœ°äº§ç”Ÿæ•°æ®ã€‚æ— ç•Œæµçš„æ•°æ®å¿…é¡»æŒç»­å¤„ç†ï¼Œå³æ•°æ®è¢«æ‘„å–åéœ€è¦ç«‹åˆ»å¤„ç†ã€‚æˆ‘ä»¬ä¸èƒ½ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½åˆ°è¾¾å†å¤„ç†ï¼Œå› ä¸ºè¾“å…¥æ˜¯æ— é™çš„ï¼Œåœ¨ä»»ä½•æ—¶å€™è¾“å…¥éƒ½ä¸ä¼šå®Œæˆã€‚å¤„ç†æ— ç•Œæ•°æ®é€šå¸¸è¦æ±‚ä»¥ç‰¹å®šé¡ºåºæ‘„å–äº‹ä»¶ï¼Œä¾‹å¦‚äº‹ä»¶å‘ç”Ÿçš„é¡ºåºï¼Œä»¥ä¾¿èƒ½å¤Ÿæ¨æ–­ç»“æœçš„å®Œæ•´æ€§ã€‚</li>
<li><strong>æœ‰ç•Œæµ</strong> æœ‰å®šä¹‰æµçš„å¼€å§‹ï¼Œä¹Ÿæœ‰å®šä¹‰æµçš„ç»“æŸã€‚æœ‰ç•Œæµå¯ä»¥åœ¨æ‘„å–æ‰€æœ‰æ•°æ®åå†è¿›è¡Œè®¡ç®—ã€‚æœ‰ç•Œæµæ‰€æœ‰æ•°æ®å¯ä»¥è¢«æ’åºï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æœ‰åºæ‘„å–ã€‚æœ‰ç•Œæµå¤„ç†é€šå¸¸è¢«ç§°ä¸ºæ‰¹å¤„ç†ã€‚</li>
</ol>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/bounded-unbounded.png" alt="Bounded and unbounded streams"></p>
<p><strong>Apache Flink æ“…é•¿å¤„ç†æ— ç•Œå’Œæœ‰ç•Œæ•°æ®é›†</strong> ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶å’ŒçŠ¶æ€åŒ–ä½¿å¾— Flink çš„è¿è¡Œæ—¶(runtime)èƒ½å¤Ÿè¿è¡Œä»»ä½•å¤„ç†æ— ç•Œæµçš„åº”ç”¨ã€‚æœ‰ç•Œæµåˆ™ç”±ä¸€äº›ä¸“ä¸ºå›ºå®šå¤§å°æ•°æ®é›†ç‰¹æ®Šè®¾è®¡çš„ç®—æ³•å’Œæ•°æ®ç»“æ„è¿›è¡Œå†…éƒ¨å¤„ç†ï¼Œäº§ç”Ÿäº†å‡ºè‰²çš„æ€§èƒ½ã€‚</p>
<p><strong>æ‰¹å¤„ç†</strong>æ˜¯æœ‰ç•Œæ•°æ®æµå¤„ç†çš„èŒƒä¾‹ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥é€‰æ‹©åœ¨è®¡ç®—ç»“æœè¾“å‡ºä¹‹å‰è¾“å…¥æ•´ä¸ªæ•°æ®é›†ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä½ å¯ä»¥å¯¹æ•´ä¸ªæ•°æ®é›†çš„æ•°æ®è¿›è¡Œæ’åºã€ç»Ÿè®¡æˆ–æ±‡æ€»è®¡ç®—åå†è¾“å‡ºç»“æœã€‚</p>
<p><strong>æµå¤„ç†</strong>æ­£ç›¸åï¼Œå…¶æ¶‰åŠæ— ç•Œæ•°æ®æµã€‚è‡³å°‘ç†è®ºä¸Šæ¥è¯´ï¼Œå®ƒçš„æ•°æ®è¾“å…¥æ°¸è¿œä¸ä¼šç»“æŸï¼Œå› æ­¤ç¨‹åºå¿…é¡»æŒç»­ä¸æ–­åœ°å¯¹åˆ°è¾¾çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚</p>
<p>åœ¨ Flink ä¸­ï¼Œåº”ç”¨ç¨‹åºç”±ç”¨æˆ·è‡ªå®šä¹‰<strong>ç®—å­</strong>è½¬æ¢è€Œæ¥çš„<strong>æµå¼ dataflows</strong> æ‰€ç»„æˆã€‚è¿™äº›æµå¼ dataflows å½¢æˆäº†æœ‰å‘å›¾ï¼Œä»¥ä¸€ä¸ªæˆ–å¤šä¸ª<strong>æº</strong>ï¼ˆsourceï¼‰å¼€å§‹ï¼Œå¹¶ä»¥ä¸€ä¸ªæˆ–å¤šä¸ª<strong>æ±‡</strong>ï¼ˆsinkï¼‰ç»“æŸã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/program_dataflow.svg" alt="A DataStream program, and its dataflow."></p>
<p>é€šå¸¸ï¼Œç¨‹åºä»£ç ä¸­çš„ transformation å’Œ dataflow ä¸­çš„ç®—å­ï¼ˆoperatorï¼‰ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä½†æœ‰æ—¶ä¹Ÿä¼šå‡ºç°ä¸€ä¸ª transformation åŒ…å«å¤šä¸ªç®—å­çš„æƒ…å†µï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>
<p>Flink åº”ç”¨ç¨‹åºå¯ä»¥æ¶ˆè´¹æ¥è‡ªæ¶ˆæ¯é˜Ÿåˆ—æˆ–åˆ†å¸ƒå¼æ—¥å¿—è¿™ç±»æµå¼æ•°æ®æºï¼ˆä¾‹å¦‚ Apache Kafka æˆ– Kinesisï¼‰çš„å®æ—¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä»å„ç§çš„æ•°æ®æºä¸­æ¶ˆè´¹æœ‰ç•Œçš„å†å²æ•°æ®ã€‚åŒæ ·ï¼ŒFlink åº”ç”¨ç¨‹åºç”Ÿæˆçš„ç»“æœæµä¹Ÿå¯ä»¥å‘é€åˆ°å„ç§æ•°æ®æ±‡ä¸­ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/flink-application-sources-sinks.png" alt="Flink application with sources and sinks"></p>
<h3 id="å¹¶è¡Œ-Dataflows"><a href="#å¹¶è¡Œ-Dataflows" class="headerlink" title="å¹¶è¡Œ Dataflows"></a>å¹¶è¡Œ Dataflows</h3><p>Flink ç¨‹åºæœ¬è´¨ä¸Šæ˜¯åˆ†å¸ƒå¼å¹¶è¡Œç¨‹åºã€‚åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œä¸€ä¸ªæµæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª<strong>æµåˆ†åŒº</strong>ï¼ˆStream Partitionï¼‰ï¼Œæ¯ä¸ªç®—å­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª<strong>ç®—å­å­ä»»åŠ¡</strong>ï¼ˆOperator Subtaskï¼‰ã€‚æ¯ä¸ªå­ä»»åŠ¡å½¼æ­¤ç‹¬ç«‹ï¼Œå¹¶åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œæˆ–åœ¨ä¸åŒçš„è®¡ç®—æœºæˆ–å®¹å™¨ä¸­è¿è¡Œã€‚</p>
<p>ç®—å­å­ä»»åŠ¡æ•°å°±æ˜¯å…¶å¯¹åº”ç®—å­çš„<strong>å¹¶è¡Œåº¦</strong>ã€‚åœ¨åŒä¸€ç¨‹åºä¸­ï¼Œä¸åŒç®—å­ä¹Ÿå¯èƒ½å…·æœ‰ä¸åŒçš„å¹¶è¡Œåº¦ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/parallel_dataflow.svg" alt="A parallel dataflow"></p>
<p>Flink ç®—å­ä¹‹é—´å¯ä»¥é€šè¿‡<em>ä¸€å¯¹ä¸€</em>ï¼ˆ_ç›´ä¼ _ï¼‰æ¨¡å¼æˆ–<em>é‡æ–°åˆ†å‘</em>æ¨¡å¼ä¼ è¾“æ•°æ®ï¼š</p>
<ul>
<li><strong>ä¸€å¯¹ä¸€</strong>æ¨¡å¼ï¼ˆä¾‹å¦‚ä¸Šå›¾ä¸­çš„ <em>Source</em> å’Œ <em>map()</em> ç®—å­ä¹‹é—´ï¼‰å¯ä»¥ä¿ç•™å…ƒç´ çš„åˆ†åŒºå’Œé¡ºåºä¿¡æ¯ã€‚è¿™æ„å‘³ç€ <em>map()</em> ç®—å­çš„ subtask[1] è¾“å…¥çš„æ•°æ®ä»¥åŠå…¶é¡ºåºä¸ <em>Source</em> ç®—å­çš„ subtask[1] è¾“å‡ºçš„æ•°æ®å’Œé¡ºåºå®Œå…¨ç›¸åŒï¼Œå³åŒä¸€åˆ†åŒºçš„æ•°æ®åªä¼šè¿›å…¥åˆ°ä¸‹æ¸¸ç®—å­çš„åŒä¸€åˆ†åŒºã€‚</li>
<li><strong>é‡æ–°åˆ†å‘</strong>æ¨¡å¼ï¼ˆä¾‹å¦‚ä¸Šå›¾ä¸­çš„ <em>map()</em> å’Œ <em>keyBy&#x2F;window</em> ä¹‹é—´ï¼Œä»¥åŠ <em>keyBy&#x2F;window</em> å’Œ <em>Sink</em> ä¹‹é—´ï¼‰åˆ™ä¼šæ›´æ”¹æ•°æ®æ‰€åœ¨çš„æµåˆ†åŒºã€‚å½“ä½ åœ¨ç¨‹åºä¸­é€‰æ‹©ä½¿ç”¨ä¸åŒçš„ _transformation_ï¼Œæ¯ä¸ª<em>ç®—å­å­ä»»åŠ¡</em>ä¹Ÿä¼šæ ¹æ®ä¸åŒçš„ transformation å°†æ•°æ®å‘é€åˆ°ä¸åŒçš„ç›®æ ‡å­ä»»åŠ¡ã€‚ä¾‹å¦‚ä»¥ä¸‹è¿™å‡ ç§ transformation å’Œå…¶å¯¹åº”åˆ†å‘æ•°æ®çš„æ¨¡å¼ï¼š_keyBy()_ï¼ˆé€šè¿‡æ•£åˆ—é”®é‡æ–°åˆ†åŒºï¼‰ã€_broadcast()_ï¼ˆå¹¿æ’­ï¼‰æˆ– _rebalance()<em>ï¼ˆéšæœºé‡æ–°åˆ†å‘ï¼‰ã€‚åœ¨<em>é‡æ–°åˆ†å‘</em>æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…ƒç´ åªæœ‰åœ¨æ¯å¯¹è¾“å‡ºå’Œè¾“å…¥å­ä»»åŠ¡ä¹‹é—´æ‰èƒ½ä¿ç•™å…¶ä¹‹é—´çš„é¡ºåºä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œ_keyBy&#x2F;window</em> çš„ subtask[2] æ¥æ”¶åˆ°çš„ <em>map()</em> çš„ subtask[1] ä¸­çš„å…ƒç´ éƒ½æ˜¯æœ‰åºçš„ï¼‰ã€‚å› æ­¤ï¼Œä¸Šå›¾æ‰€ç¤ºçš„ <em>keyBy&#x2F;window</em> å’Œ <em>Sink</em> ç®—å­ä¹‹é—´æ•°æ®çš„é‡æ–°åˆ†å‘æ—¶ï¼Œä¸åŒé”®ï¼ˆkeyï¼‰çš„èšåˆç»“æœåˆ°è¾¾ Sink çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚</li>
</ul>
<h3 id="è‡ªå®šä¹‰æ—¶é—´æµå¤„ç†"><a href="#è‡ªå®šä¹‰æ—¶é—´æµå¤„ç†" class="headerlink" title="è‡ªå®šä¹‰æ—¶é—´æµå¤„ç†"></a>è‡ªå®šä¹‰æ—¶é—´æµå¤„ç†</h3><p>å¯¹äºå¤§å¤šæ•°æµæ•°æ®å¤„ç†åº”ç”¨ç¨‹åºè€Œè¨€ï¼Œèƒ½å¤Ÿä½¿ç”¨å¤„ç†å®æ—¶æ•°æ®çš„ä»£ç é‡æ–°å¤„ç†å†å²æ•°æ®å¹¶äº§ç”Ÿç¡®å®šå¹¶ä¸€è‡´çš„ç»“æœéå¸¸æœ‰ä»·å€¼ã€‚</p>
<p>åœ¨å¤„ç†æµå¼æ•°æ®æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸æ›´éœ€è¦å…³æ³¨äº‹ä»¶æœ¬èº«å‘ç”Ÿçš„é¡ºåºè€Œä¸æ˜¯äº‹ä»¶è¢«ä¼ è¾“ä»¥åŠå¤„ç†çš„é¡ºåºï¼Œå› ä¸ºè¿™èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ¨ç†å‡ºä¸€ç»„äº‹ä»¶ï¼ˆäº‹ä»¶é›†åˆï¼‰æ˜¯ä½•æ—¶å‘ç”Ÿä»¥åŠç»“æŸçš„ã€‚ä¾‹å¦‚ç”µå­å•†åŠ¡äº¤æ˜“æˆ–é‡‘èäº¤æ˜“ä¸­æ¶‰åŠåˆ°çš„äº‹ä»¶é›†åˆã€‚</p>
<p>ä¸ºäº†æ»¡è¶³ä¸Šè¿°è¿™ç±»çš„å®æ—¶æµå¤„ç†åœºæ™¯ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨è®°å½•åœ¨æ•°æ®æµä¸­çš„äº‹ä»¶æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œä¸æ˜¯å¤„ç†æ•°æ®çš„æœºå™¨æ—¶é’Ÿçš„æ—¶é—´æˆ³ã€‚</p>
<h3 id="æœ‰çŠ¶æ€æµå¤„ç†"><a href="#æœ‰çŠ¶æ€æµå¤„ç†" class="headerlink" title="æœ‰çŠ¶æ€æµå¤„ç†"></a>æœ‰çŠ¶æ€æµå¤„ç†</h3><p>Flink ä¸­çš„ç®—å­å¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€‚è¿™æ„å‘³ç€å¦‚ä½•å¤„ç†ä¸€ä¸ªäº‹ä»¶å¯èƒ½å–å†³äºè¯¥äº‹ä»¶ä¹‹å‰æ‰€æœ‰äº‹ä»¶æ•°æ®çš„ç´¯ç§¯ç»“æœã€‚Flink ä¸­çš„çŠ¶æ€ä¸ä»…å¯ä»¥ç”¨äºç®€å•çš„åœºæ™¯ï¼ˆä¾‹å¦‚ç»Ÿè®¡ä»ªè¡¨æ¿ä¸Šæ¯åˆ†é’Ÿæ˜¾ç¤ºçš„æ•°æ®ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¤æ‚çš„åœºæ™¯ï¼ˆä¾‹å¦‚è®­ç»ƒä½œå¼Šæ£€æµ‹æ¨¡å‹ï¼‰ã€‚</p>
<p>Flink åº”ç”¨ç¨‹åºå¯ä»¥åœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸Šå¹¶è¡Œè¿è¡Œï¼Œå…¶ä¸­æ¯ä¸ªç®—å­çš„å„ä¸ªå¹¶è¡Œå®ä¾‹ä¼šåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­ç‹¬ç«‹è¿è¡Œï¼Œå¹¶ä¸”é€šå¸¸æƒ…å†µä¸‹æ˜¯ä¼šåœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿è¡Œã€‚</p>
<p>æœ‰çŠ¶æ€ç®—å­çš„å¹¶è¡Œå®ä¾‹ç»„åœ¨å­˜å‚¨å…¶å¯¹åº”çŠ¶æ€æ—¶é€šå¸¸æ˜¯æŒ‰ç…§é”®ï¼ˆkeyï¼‰è¿›è¡Œåˆ†ç‰‡å­˜å‚¨çš„ã€‚æ¯ä¸ªå¹¶è¡Œå®ä¾‹ç®—å­è´Ÿè´£å¤„ç†ä¸€ç»„ç‰¹å®šé”®çš„äº‹ä»¶æ•°æ®ï¼Œå¹¶ä¸”è¿™ç»„é”®å¯¹åº”çš„çŠ¶æ€ä¼šä¿å­˜åœ¨æœ¬åœ°ã€‚</p>
<p>å¦‚ä¸‹å›¾çš„ Flink ä½œä¸šï¼Œå…¶å‰ä¸‰ä¸ªç®—å­çš„å¹¶è¡Œåº¦ä¸º 2ï¼Œæœ€åä¸€ä¸ª sink ç®—å­çš„å¹¶è¡Œåº¦ä¸º 1ï¼Œå…¶ä¸­ç¬¬ä¸‰ä¸ªç®—å­æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå¹¶ä¸”ä½ å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªç®—å­å’Œç¬¬ä¸‰ä¸ªç®—å­ä¹‹é—´æ˜¯å…¨äº’è”çš„ï¼ˆfully-connectedï¼‰ï¼Œå®ƒä»¬ä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®åˆ†å‘ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ç°è¿™ç§ç±»å‹çš„ Flink ç¨‹åºæ˜¯ä¸ºäº†é€šè¿‡æŸäº›é”®å¯¹æ•°æ®æµè¿›è¡Œåˆ†åŒºï¼Œä»¥ä¾¿å°†éœ€è¦ä¸€èµ·å¤„ç†çš„äº‹ä»¶è¿›è¡Œæ±‡åˆï¼Œç„¶ååšç»Ÿä¸€è®¡ç®—å¤„ç†ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/parallel-job.png" alt="State is sharded"></p>
<p>Flink åº”ç”¨ç¨‹åºçš„çŠ¶æ€è®¿é—®éƒ½åœ¨æœ¬åœ°è¿›è¡Œï¼Œå› ä¸ºè¿™æœ‰åŠ©äºå…¶æé«˜ååé‡å’Œé™ä½å»¶è¿Ÿã€‚é€šå¸¸æƒ…å†µä¸‹ Flink åº”ç”¨ç¨‹åºéƒ½æ˜¯å°†çŠ¶æ€å­˜å‚¨åœ¨ JVM å †ä¸Šï¼Œä½†å¦‚æœçŠ¶æ€å¤ªå¤§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©å°†å…¶ä»¥ç»“æ„åŒ–æ•°æ®æ ¼å¼å­˜å‚¨åœ¨é«˜é€Ÿç£ç›˜ä¸­ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/local-state.png" alt="State is local"></p>
<h3 id="é€šè¿‡çŠ¶æ€å¿«ç…§å®ç°çš„å®¹é”™"><a href="#é€šè¿‡çŠ¶æ€å¿«ç…§å®ç°çš„å®¹é”™" class="headerlink" title="é€šè¿‡çŠ¶æ€å¿«ç…§å®ç°çš„å®¹é”™"></a>é€šè¿‡çŠ¶æ€å¿«ç…§å®ç°çš„å®¹é”™</h3><p>é€šè¿‡çŠ¶æ€å¿«ç…§å’Œæµé‡æ”¾ä¸¤ç§æ–¹å¼çš„ç»„åˆï¼ŒFlink èƒ½å¤Ÿæä¾›å¯å®¹é”™çš„ï¼Œç²¾ç¡®ä¸€æ¬¡è®¡ç®—çš„è¯­ä¹‰ã€‚è¿™äº›çŠ¶æ€å¿«ç…§åœ¨æ‰§è¡Œæ—¶ä¼šè·å–å¹¶å­˜å‚¨åˆ†å¸ƒå¼ pipeline ä¸­æ•´ä½“çš„çŠ¶æ€ï¼Œå®ƒä¼šå°†æ•°æ®æºä¸­æ¶ˆè´¹æ•°æ®çš„åç§»é‡è®°å½•ä¸‹æ¥ï¼Œå¹¶å°†æ•´ä¸ª job graph ä¸­ç®—å­è·å–åˆ°è¯¥æ•°æ®ï¼ˆè®°å½•çš„åç§»é‡å¯¹åº”çš„æ•°æ®ï¼‰æ—¶çš„çŠ¶æ€è®°å½•å¹¶å­˜å‚¨ä¸‹æ¥ã€‚å½“å‘ç”Ÿæ•…éšœæ—¶ï¼ŒFlink ä½œä¸šä¼šæ¢å¤ä¸Šæ¬¡å­˜å‚¨çš„çŠ¶æ€ï¼Œé‡ç½®æ•°æ®æºä»çŠ¶æ€ä¸­è®°å½•çš„ä¸Šæ¬¡æ¶ˆè´¹çš„åç§»é‡å¼€å§‹é‡æ–°è¿›è¡Œæ¶ˆè´¹å¤„ç†ã€‚è€Œä¸”çŠ¶æ€å¿«ç…§åœ¨æ‰§è¡Œæ—¶ä¼šå¼‚æ­¥è·å–çŠ¶æ€å¹¶å­˜å‚¨ï¼Œå¹¶ä¸ä¼šé˜»å¡æ­£åœ¨è¿›è¡Œçš„æ•°æ®å¤„ç†é€»è¾‘ã€‚</p>
<h2 id="çŠ¶æ€"><a href="#çŠ¶æ€" class="headerlink" title="çŠ¶æ€"></a>çŠ¶æ€</h2><p>åªæœ‰åœ¨æ¯ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶ä¸Šè¿›è¡Œè½¬æ¢æ“ä½œçš„åº”ç”¨æ‰ä¸éœ€è¦çŠ¶æ€ï¼Œæ¢è¨€ä¹‹ï¼Œæ¯ä¸€ä¸ªå…·æœ‰ä¸€å®šå¤æ‚åº¦çš„æµå¤„ç†åº”ç”¨éƒ½æ˜¯æœ‰çŠ¶æ€çš„ã€‚ä»»ä½•è¿è¡ŒåŸºæœ¬ä¸šåŠ¡é€»è¾‘çš„æµå¤„ç†åº”ç”¨éƒ½éœ€è¦åœ¨ä¸€å®šæ—¶é—´å†…å­˜å‚¨æ‰€æ¥æ”¶çš„äº‹ä»¶æˆ–ä¸­é—´ç»“æœï¼Œä»¥ä¾›åç»­çš„æŸä¸ªæ—¶é—´ç‚¹ï¼ˆä¾‹å¦‚æ”¶åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶æˆ–è€…ç»è¿‡ä¸€æ®µç‰¹å®šæ—¶é—´ï¼‰è¿›è¡Œè®¿é—®å¹¶è¿›è¡Œåç»­å¤„ç†ã€‚</p>
<p><img src="https://flink.apache.org/img/function-state.png" alt="img"></p>
<p>åº”ç”¨çŠ¶æ€æ˜¯ Flink ä¸­çš„ä¸€ç­‰å…¬æ°‘ï¼ŒFlink æä¾›äº†è®¸å¤šçŠ¶æ€ç®¡ç†ç›¸å…³çš„ç‰¹æ€§æ”¯æŒï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>å¤šç§çŠ¶æ€åŸºç¡€ç±»å‹</strong>ï¼šFlink ä¸ºå¤šç§ä¸åŒçš„æ•°æ®ç»“æ„æä¾›äº†ç›¸å¯¹åº”çš„çŠ¶æ€åŸºç¡€ç±»å‹ï¼Œä¾‹å¦‚åŸå­å€¼ï¼ˆvalueï¼‰ï¼Œåˆ—è¡¨ï¼ˆlistï¼‰ä»¥åŠæ˜ å°„ï¼ˆmapï¼‰ã€‚å¼€å‘è€…å¯ä»¥åŸºäºå¤„ç†å‡½æ•°å¯¹çŠ¶æ€çš„è®¿é—®æ–¹å¼ï¼Œé€‰æ‹©æœ€é«˜æ•ˆã€æœ€é€‚åˆçš„çŠ¶æ€åŸºç¡€ç±»å‹ã€‚</li>
<li><strong>æ’ä»¶åŒ–çš„ State Backend</strong>ï¼šState Backend è´Ÿè´£ç®¡ç†åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œ checkpointã€‚Flink æ”¯æŒå¤šç§ state backendï¼Œå¯ä»¥å°†çŠ¶æ€å­˜åœ¨å†…å­˜æˆ–è€… <a target="_blank" rel="noopener" href="https://rocksdb.org/">RocksDB</a>ã€‚RocksDB æ˜¯ä¸€ç§é«˜æ•ˆçš„åµŒå…¥å¼ã€æŒä¹…åŒ–é”®å€¼å­˜å‚¨å¼•æ“ã€‚Flink ä¹Ÿæ”¯æŒæ’ä»¶å¼çš„è‡ªå®šä¹‰ state backend è¿›è¡ŒçŠ¶æ€å­˜å‚¨ã€‚</li>
<li><strong>ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰</strong>ï¼šFlink çš„ checkpoint å’Œæ•…éšœæ¢å¤ç®—æ³•ä¿è¯äº†æ•…éšœå‘ç”Ÿååº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚å› æ­¤ï¼ŒFlink èƒ½å¤Ÿåœ¨åº”ç”¨ç¨‹åºå‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯¹åº”ç”¨ç¨‹åºé€æ˜ï¼Œä¸é€ æˆæ­£ç¡®æ€§çš„å½±å“ã€‚</li>
<li><strong>è¶…å¤§æ•°æ®é‡çŠ¶æ€</strong>ï¼šFlink èƒ½å¤Ÿåˆ©ç”¨å…¶å¼‚æ­¥ä»¥åŠå¢é‡å¼çš„ checkpoint ç®—æ³•ï¼Œå­˜å‚¨æ•° TB çº§åˆ«çš„åº”ç”¨çŠ¶æ€ã€‚</li>
<li><strong>å¯å¼¹æ€§ä¼¸ç¼©çš„åº”ç”¨</strong>ï¼šFlink èƒ½å¤Ÿé€šè¿‡åœ¨æ›´å¤šæˆ–æ›´å°‘çš„å·¥ä½œèŠ‚ç‚¹ä¸Šå¯¹çŠ¶æ€è¿›è¡Œé‡æ–°åˆ†å¸ƒï¼Œæ”¯æŒæœ‰çŠ¶æ€åº”ç”¨çš„åˆ†å¸ƒå¼çš„æ¨ªå‘ä¼¸ç¼©ã€‚</li>
</ul>
<h2 id="æ—¶é—´"><a href="#æ—¶é—´" class="headerlink" title="æ—¶é—´"></a>æ—¶é—´</h2><h3 id="æ—¶é—´è¯­ä¹‰"><a href="#æ—¶é—´è¯­ä¹‰" class="headerlink" title="æ—¶é—´è¯­ä¹‰"></a>æ—¶é—´è¯­ä¹‰</h3><p>Flink æ”¯æŒä»¥ä¸‹ä¸‰ç§æ—¶é—´è¯­ä¹‰:</p>
<ul>
<li>**äº‹ä»¶æ—¶é—´(event time)**ï¼š äº‹ä»¶äº§ç”Ÿçš„æ—¶é—´ï¼Œè®°å½•çš„æ˜¯è®¾å¤‡ç”Ÿäº§(æˆ–è€…å­˜å‚¨)äº‹ä»¶çš„æ—¶é—´</li>
<li>**æ‘„å–æ—¶é—´(ingestion time)**ï¼š Flink è¯»å–äº‹ä»¶æ—¶è®°å½•çš„æ—¶é—´</li>
<li>**å¤„ç†æ—¶é—´(processing time)**ï¼š Flink pipeline ä¸­å…·ä½“ç®—å­å¤„ç†äº‹ä»¶çš„æ—¶é—´</li>
</ul>
<p>ä¸ºäº†è·å¾—å¯é‡ç°çš„ç»“æœï¼Œä¾‹å¦‚åœ¨è®¡ç®—è¿‡å»çš„ç‰¹å®šä¸€å¤©é‡Œç¬¬ä¸€ä¸ªå°æ—¶è‚¡ç¥¨çš„æœ€é«˜ä»·æ ¼æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨äº‹ä»¶æ—¶é—´ã€‚è¿™æ ·çš„è¯ï¼Œæ— è®ºä»€ä¹ˆæ—¶é—´å»è®¡ç®—éƒ½ä¸ä¼šå½±å“è¾“å‡ºç»“æœã€‚ç„¶è€Œå¦‚æœä½¿ç”¨å¤„ç†æ—¶é—´çš„è¯ï¼Œå®æ—¶åº”ç”¨ç¨‹åºçš„ç»“æœæ˜¯ç”±ç¨‹åºè¿è¡Œçš„æ—¶é—´æ‰€å†³å®šã€‚å¤šæ¬¡è¿è¡ŒåŸºäºå¤„ç†æ—¶é—´çš„å®æ—¶ç¨‹åºï¼Œå¯èƒ½å¾—åˆ°çš„ç»“æœéƒ½ä¸ç›¸åŒï¼Œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å†æ¬¡åˆ†æå†å²æ•°æ®æˆ–è€…æµ‹è¯•æ–°ä»£ç å˜å¾—å¼‚å¸¸å›°éš¾ã€‚</p>
<h3 id="Event-Time"><a href="#Event-Time" class="headerlink" title="Event Time"></a>Event Time</h3><p>å¦‚æœæƒ³è¦ä½¿ç”¨äº‹ä»¶æ—¶é—´ï¼Œéœ€è¦é¢å¤–ç»™ Flink æä¾›ä¸€ä¸ªæ—¶é—´æˆ³æå–å™¨å’Œ Watermark ç”Ÿæˆå™¨ï¼ŒFlink å°†ä½¿ç”¨å®ƒä»¬æ¥è·Ÿè¸ªäº‹ä»¶æ—¶é—´çš„è¿›åº¦ã€‚</p>
<h3 id="Watermark"><a href="#Watermark" class="headerlink" title="Watermark"></a>Watermark</h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥æ¼”ç¤ºä¸ºä»€ä¹ˆéœ€è¦ watermarks åŠå…¶å·¥ä½œæ–¹å¼ã€‚</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¸¦æœ‰æ··ä¹±æ—¶é—´æˆ³çš„äº‹ä»¶æµï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ˜¾ç¤ºçš„æ•°å­—è¡¨è¾¾çš„æ˜¯è¿™äº›äº‹ä»¶å®é™…å‘ç”Ÿæ—¶é—´çš„æ—¶é—´æˆ³ã€‚åˆ°è¾¾çš„ç¬¬ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿåœ¨æ—¶é—´ 4ï¼Œéšåå‘ç”Ÿçš„äº‹ä»¶å‘ç”Ÿåœ¨æ›´æ—©çš„æ—¶é—´ 2ï¼Œä¾æ­¤ç±»æ¨ï¼š</p>
<p>Â·Â·Â· 23 19 22 24 21 14 17 13 12 15 9 11 7 2 4 â†’</p>
<p>å‡è®¾æˆ‘ä»¬è¦å¯¹æ•°æ®æµæ’åºï¼Œæˆ‘ä»¬æƒ³è¦è¾¾åˆ°çš„ç›®çš„æ˜¯ï¼šåº”ç”¨ç¨‹åºåº”è¯¥åœ¨æ•°æ®æµé‡Œçš„äº‹ä»¶åˆ°è¾¾æ—¶å°±æœ‰ä¸€ä¸ªç®—å­ï¼ˆæˆ‘ä»¬æš‚ä¸”ç§°ä¹‹ä¸ºæ’åºï¼‰å¼€å§‹å¤„ç†äº‹ä»¶ï¼Œè¿™ä¸ªç®—å­æ‰€è¾“å‡ºçš„æµæ˜¯æŒ‰ç…§æ—¶é—´æˆ³æ’åºå¥½çš„ã€‚</p>
<p>è®©æˆ‘ä»¬é‡æ–°å®¡è§†è¿™äº›æ•°æ®:</p>
<p>(1) æˆ‘ä»¬çš„æ’åºå™¨çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªäº‹ä»¶çš„æ—¶é—´æˆ³æ˜¯ 4ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç«‹å³å°†å…¶ä½œä¸ºå·²æ’åºçš„æµé‡Šæ”¾ã€‚å› ä¸ºæˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šå®ƒæ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”è¾ƒæ—©çš„äº‹ä»¶æœ‰å¯èƒ½å¹¶æœªåˆ°è¾¾ã€‚äº‹å®ä¸Šï¼Œå¦‚æœç«™åœ¨ä¸Šå¸è§†è§’ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¿…é¡»è¦ç­‰åˆ°æ—¶é—´æˆ³ä¸º 2 çš„å…ƒç´ åˆ°æ¥æ—¶ï¼Œæ’åºå™¨æ‰å¯ä»¥æœ‰äº‹ä»¶è¾“å‡ºã€‚</p>
<p><em>éœ€è¦ä¸€äº›ç¼“å†²ï¼Œéœ€è¦ä¸€äº›æ—¶é—´ï¼Œä½†è¿™éƒ½æ˜¯å€¼å¾—çš„</em></p>
<p>(2) æ¥ä¸‹æ¥çš„è¿™ä¸€æ­¥ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©çš„æ˜¯å›ºæ‰§çš„ç­‰å¾…ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šæœ‰ç»“æœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ—¶é—´æˆ³ä¸º 4 çš„äº‹ä»¶ï¼Œç„¶åçœ‹åˆ°äº†æ—¶é—´æˆ³ä¸º 2 çš„äº‹ä»¶ã€‚å¯æ˜¯ï¼Œæ—¶é—´æˆ³å°äº 2 çš„äº‹ä»¶æ¥ä¸‹æ¥ä¼šä¸ä¼šåˆ°æ¥å‘¢ï¼Ÿå¯èƒ½ä¼šï¼Œä¹Ÿå¯èƒ½ä¸ä¼šã€‚å†æ¬¡ç«™åœ¨ä¸Šå¸è§†è§’ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šçœ‹åˆ°æ—¶é—´æˆ³ 1ã€‚</p>
<p><em>æœ€ç»ˆï¼Œæˆ‘ä»¬å¿…é¡»å‹‡äºæ‰¿æ‹…è´£ä»»ï¼Œå¹¶å‘å‡ºæŒ‡ä»¤ï¼ŒæŠŠå¸¦æœ‰æ—¶é—´æˆ³ 2 çš„äº‹ä»¶ä½œä¸ºå·²æ’åºçš„äº‹ä»¶æµçš„å¼€å§‹</em></p>
<p>(3) ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ç­–ç•¥ï¼Œè¯¥ç­–ç•¥å®šä¹‰ï¼šå¯¹äºä»»ä½•ç»™å®šæ—¶é—´æˆ³çš„äº‹ä»¶ï¼ŒFlink ä½•æ—¶åœæ­¢ç­‰å¾…è¾ƒæ—©äº‹ä»¶çš„åˆ°æ¥ã€‚</p>
<p><em>è¿™æ­£æ˜¯ watermarks çš„ä½œç”¨</em> â€” å®ƒä»¬å®šä¹‰ä½•æ—¶åœæ­¢ç­‰å¾…è¾ƒæ—©çš„äº‹ä»¶ã€‚</p>
<p>Flink ä¸­äº‹ä»¶æ—¶é—´çš„å¤„ç†å–å†³äº _watermark ç”Ÿæˆå™¨_ï¼Œåè€…å°†å¸¦æœ‰æ—¶é—´æˆ³çš„ç‰¹æ®Šå…ƒç´ æ’å…¥æµä¸­å½¢æˆ _watermarks_ã€‚äº‹ä»¶æ—¶é—´ <em>t</em> çš„ watermark ä»£è¡¨ <em>t</em> ä¹‹å‰ï¼ˆå¾ˆå¯èƒ½ï¼‰éƒ½å·²ç»åˆ°è¾¾ã€‚</p>
<p>å½“ watermark ä»¥ 2 æˆ–æ›´å¤§çš„æ—¶é—´æˆ³åˆ°è¾¾æ—¶ï¼Œäº‹ä»¶æµçš„æ’åºå™¨åº”åœæ­¢ç­‰å¾…ï¼Œå¹¶è¾“å‡º 2 ä½œä¸ºå·²ç»æ’åºå¥½çš„æµã€‚</p>
<p>(4) æˆ‘ä»¬å¯èƒ½ä¼šæ€è€ƒï¼Œå¦‚ä½•å†³å®š watermarks çš„ä¸åŒç”Ÿæˆç­–ç•¥</p>
<p>æ¯ä¸ªäº‹ä»¶éƒ½ä¼šå»¶è¿Ÿä¸€æ®µæ—¶é—´ååˆ°è¾¾ï¼Œç„¶è€Œè¿™äº›å»¶è¿Ÿæœ‰æ‰€ä¸åŒï¼Œæœ‰äº›äº‹ä»¶å¯èƒ½æ¯”å…¶ä»–äº‹ä»¶å»¶è¿Ÿå¾—æ›´å¤šã€‚ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯å‡å®šè¿™äº›å»¶è¿Ÿå—æŸä¸ªæœ€å¤§å»¶è¿Ÿçš„é™åˆ¶ã€‚Flink å°†æ­¤ç­–ç•¥ç§°ä¸º <em>æœ€å¤§æ— åºè¾¹ç•Œ (bounded-out-of-orderness)</em> watermarkã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åƒå‡ºæ›´å¥½çš„ç”Ÿæˆ watermark çš„æ–¹æ³•ï¼Œä½†æ˜¯å¯¹äºå¤§å¤šæ•°åº”ç”¨è€Œè¨€ï¼Œå›ºå®šå»¶è¿Ÿç­–ç•¥å·²ç»è¶³å¤Ÿäº†ã€‚</p>
<h3 id="å»¶è¿Ÿ-VS-æ­£ç¡®æ€§"><a href="#å»¶è¿Ÿ-VS-æ­£ç¡®æ€§" class="headerlink" title="å»¶è¿Ÿ VS æ­£ç¡®æ€§"></a>å»¶è¿Ÿ VS æ­£ç¡®æ€§</h3><p>watermarks ç»™äº†å¼€å‘è€…æµå¤„ç†çš„ä¸€ç§é€‰æ‹©ï¼Œå®ƒä»¬ä½¿å¼€å‘äººå‘˜åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶å¯ä»¥æ§åˆ¶å»¶è¿Ÿå’Œå®Œæ•´æ€§ä¹‹é—´çš„æƒè¡¡ã€‚ä¸æ‰¹å¤„ç†ä¸åŒï¼Œæ‰¹å¤„ç†ä¸­çš„å¥¢ä¾ˆä¹‹å¤„åœ¨äºå¯ä»¥åœ¨äº§ç”Ÿä»»ä½•ç»“æœä¹‹å‰å®Œå…¨äº†è§£è¾“å…¥ï¼Œè€Œä½¿ç”¨æµå¼ä¼ è¾“ï¼Œæˆ‘ä»¬ä¸è¢«å…è®¸ç­‰å¾…æ‰€æœ‰çš„æ—¶é—´éƒ½äº§ç”Ÿäº†ï¼Œæ‰è¾“å‡ºæ’åºå¥½çš„æ•°æ®ï¼Œè¿™ä¸æµç›¸è¿èƒŒã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠ watermarks çš„è¾¹ç•Œæ—¶é—´é…ç½®çš„ç›¸å¯¹è¾ƒçŸ­ï¼Œä»è€Œå†’ç€åœ¨è¾“å…¥äº†è§£ä¸å®Œå…¨çš„æƒ…å†µä¸‹äº§ç”Ÿç»“æœçš„é£é™©-å³å¯èƒ½ä¼šå¾ˆå¿«äº§ç”Ÿé”™è¯¯ç»“æœã€‚æˆ–è€…ï¼Œä½ å¯ä»¥ç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œå¹¶åˆ©ç”¨å¯¹è¾“å…¥æµçš„æ›´å…¨é¢çš„äº†è§£æ¥äº§ç”Ÿç»“æœã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥å®æ–½æ··åˆè§£å†³æ–¹æ¡ˆï¼Œå…ˆå¿«é€Ÿäº§ç”Ÿåˆæ­¥ç»“æœï¼Œç„¶ååœ¨å¤„ç†å…¶ä»–ï¼ˆæœ€æ–°ï¼‰æ•°æ®æ—¶å‘è¿™äº›ç»“æœæä¾›æ›´æ–°ã€‚å¯¹äºæœ‰ä¸€äº›å¯¹å»¶è¿Ÿçš„å®¹å¿ç¨‹åº¦å¾ˆä½ï¼Œä½†æ˜¯åˆå¯¹ç»“æœæœ‰å¾ˆä¸¥æ ¼çš„è¦æ±‚çš„åœºæ™¯ä¸‹ï¼Œæˆ–è®¸æ˜¯ä¸€ä¸ªç¦éŸ³ã€‚</p>
<h3 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h3><p>å»¶è¿Ÿæ˜¯ç›¸å¯¹äº watermarks å®šä¹‰çš„ã€‚<code>Watermark(t)</code> è¡¨ç¤ºäº‹ä»¶æµçš„æ—¶é—´å·²ç»åˆ°è¾¾äº† <em>t</em>; watermark ä¹‹åçš„æ—¶é—´æˆ³ â‰¤ <em>t</em> çš„ä»»ä½•äº‹ä»¶éƒ½è¢«ç§°ä¹‹ä¸ºå»¶è¿Ÿäº‹ä»¶ã€‚</p>
<h3 id="ä½¿ç”¨-Watermarks"><a href="#ä½¿ç”¨-Watermarks" class="headerlink" title="ä½¿ç”¨ Watermarks"></a>ä½¿ç”¨ Watermarks</h3><p>å¦‚æœæƒ³è¦ä½¿ç”¨åŸºäºå¸¦æœ‰äº‹ä»¶æ—¶é—´æˆ³çš„äº‹ä»¶æµï¼ŒFlink éœ€è¦çŸ¥é“ä¸æ¯ä¸ªäº‹ä»¶ç›¸å…³çš„æ—¶é—´æˆ³ï¼Œè€Œä¸”æµå¿…é¡»åŒ…å« watermarkã€‚</p>
<p>åŠ¨æ‰‹ç»ƒä¹ ä¸­ä½¿ç”¨çš„å‡ºç§Ÿè½¦æ•°æ®æºå·²ç»ä¸ºæˆ‘ä»¬å¤„ç†äº†è¿™äº›è¯¦ç»†ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œåœ¨æ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨å°†å¿…é¡»è‡ªå·±è¿›è¡Œå¤„ç†ï¼Œè¿™é€šå¸¸æ˜¯é€šè¿‡å®ç°ä¸€ä¸ªç±»æ¥å®ç°çš„ï¼Œè¯¥ç±»ä»äº‹ä»¶ä¸­æå–æ—¶é—´æˆ³ï¼Œå¹¶æ ¹æ®éœ€è¦ç”Ÿæˆ watermarksã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>WatermarkStrategy</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Event&gt; stream = ...</span><br><span class="line"></span><br><span class="line">WatermarkStrategy&lt;Event&gt; strategy = WatermarkStrategy</span><br><span class="line">        .&lt;Event&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">20</span>))</span><br><span class="line">        .withTimestampAssigner((event, timestamp) -&gt; event.timestamp);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Event&gt; withTimestampsAndWatermarks =</span><br><span class="line">    stream.assignTimestampsAndWatermarks(strategy);</span><br></pre></td></tr></table></figure>

<h2 id="çª—å£"><a href="#çª—å£" class="headerlink" title="çª—å£"></a>çª—å£</h2><p>æˆ‘ä»¬åœ¨æ“ä½œæ— ç•Œæ•°æ®æµæ—¶ï¼Œç»å¸¸éœ€è¦åº”å¯¹ä»¥ä¸‹é—®é¢˜ï¼Œæˆ‘ä»¬ç»å¸¸æŠŠæ— ç•Œæ•°æ®æµåˆ†è§£æˆæœ‰ç•Œæ•°æ®æµèšåˆåˆ†æï¼š</p>
<ul>
<li>æ¯åˆ†é’Ÿçš„æµè§ˆé‡</li>
<li>æ¯ä½ç”¨æˆ·æ¯å‘¨çš„ä¼šè¯æ•°</li>
<li>æ¯ä¸ªä¼ æ„Ÿå™¨æ¯åˆ†é’Ÿçš„æœ€é«˜æ¸©åº¦</li>
</ul>
<p>ç”¨ Flink è®¡ç®—çª—å£åˆ†æå–å†³äºä¸¤ä¸ªä¸»è¦çš„æŠ½è±¡æ“ä½œï¼š_Window Assigners_ï¼Œå°†äº‹ä»¶åˆ†é…ç»™çª—å£ï¼ˆæ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„çª—å£å¯¹è±¡ï¼‰ï¼Œä»¥åŠ _Window Functions_ï¼Œå¤„ç†çª—å£å†…çš„æ•°æ®ã€‚</p>
<p>Flink çš„çª—å£ API è¿˜å…·æœ‰ <em>Triggers</em> å’Œ <em>Evictors</em> çš„æ¦‚å¿µï¼Œ<em>Triggers</em> ç¡®å®šä½•æ—¶è°ƒç”¨çª—å£å‡½æ•°ï¼Œè€Œ <em>Evictors</em> åˆ™å¯ä»¥åˆ é™¤åœ¨çª—å£ä¸­æ”¶é›†çš„å…ƒç´ ã€‚</p>
<p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¸€èˆ¬è¿™æ ·ä½¿ç”¨é”®æ§äº‹ä»¶æµï¼ˆåŸºäº key åˆ†ç»„çš„è¾“å…¥äº‹ä»¶æµï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .reduce|aggregate|process(&lt;window function&gt;)</span><br></pre></td></tr></table></figure>

<p>æ‚¨ä¸æ˜¯å¿…é¡»ä½¿ç”¨é”®æ§äº‹ä»¶æµï¼ˆkeyed streamï¼‰ï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸ä½¿ç”¨é”®æ§äº‹ä»¶æµï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±ä¸èƒ½ <em>å¹¶è¡Œ</em> å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .windowAll(&lt;window assigner&gt;)</span><br><span class="line">    .reduce|aggregate|process(&lt;window function&gt;)</span><br></pre></td></tr></table></figure>

<h3 id="çª—å£åˆ†é…å™¨"><a href="#çª—å£åˆ†é…å™¨" class="headerlink" title="çª—å£åˆ†é…å™¨"></a>çª—å£åˆ†é…å™¨</h3><p>Flink æœ‰ä¸€äº›å†…ç½®çš„çª—å£åˆ†é…å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/window-assigners.svg" alt="Window assigners"></p>
<p>é€šè¿‡ä¸€äº›ç¤ºä¾‹æ¥å±•ç¤ºå…³äºè¿™äº›çª—å£å¦‚ä½•ä½¿ç”¨ï¼Œæˆ–è€…å¦‚ä½•åŒºåˆ†å®ƒä»¬ï¼š</p>
<ul>
<li>æ»šåŠ¨æ—¶é—´çª—å£<ul>
<li><em>æ¯åˆ†é’Ÿé¡µé¢æµè§ˆé‡</em></li>
<li><code>TumblingEventTimeWindows.of(Time.minutes(1))</code></li>
</ul>
</li>
<li>æ»‘åŠ¨æ—¶é—´çª—å£<ul>
<li><em>æ¯ 10 ç§’é’Ÿè®¡ç®—å‰ 1 åˆ†é’Ÿçš„é¡µé¢æµè§ˆé‡</em></li>
<li><code>SlidingEventTimeWindows.of(Time.minutes(1), Time.seconds(10))</code></li>
</ul>
</li>
<li>ä¼šè¯çª—å£<ul>
<li><em>æ¯ä¸ªä¼šè¯çš„ç½‘é¡µæµè§ˆé‡ï¼Œå…¶ä¸­ä¼šè¯ä¹‹é—´çš„é—´éš”è‡³å°‘ä¸º 30 åˆ†é’Ÿ</em></li>
<li><code>EventTimeSessionWindows.withGap(Time.minutes(30))</code></li>
</ul>
</li>
</ul>
<p>ä»¥ä¸‹éƒ½æ˜¯ä¸€äº›å¯ä»¥ä½¿ç”¨çš„é—´éš”æ—¶é—´ <code>Time.milliseconds(n)</code>, <code>Time.seconds(n)</code>, <code>Time.minutes(n)</code>, <code>Time.hours(n)</code>, å’Œ <code>Time.days(n)</code>ã€‚</p>
<p>åŸºäºæ—¶é—´çš„çª—å£åˆ†é…å™¨ï¼ˆåŒ…æ‹¬ä¼šè¯æ—¶é—´ï¼‰æ—¢å¯ä»¥å¤„ç† <code>äº‹ä»¶æ—¶é—´</code>ï¼Œä¹Ÿå¯ä»¥å¤„ç† <code>å¤„ç†æ—¶é—´</code>ã€‚è¿™ä¸¤ç§åŸºäºæ—¶é—´çš„å¤„ç†æ²¡æœ‰å“ªä¸€ä¸ªæ›´å¥½ï¼Œæˆ‘ä»¬å¿…é¡»æŠ˜è¡·ã€‚ä½¿ç”¨ <code>å¤„ç†æ—¶é—´</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ¥å—ä»¥ä¸‹é™åˆ¶ï¼š</p>
<ul>
<li>æ— æ³•æ­£ç¡®å¤„ç†å†å²æ•°æ®,</li>
<li>æ— æ³•æ­£ç¡®å¤„ç†è¶…è¿‡æœ€å¤§æ— åºè¾¹ç•Œçš„æ•°æ®,</li>
<li>ç»“æœå°†æ˜¯ä¸ç¡®å®šçš„,</li>
</ul>
<p>ä½†æ˜¯æœ‰è‡ªå·±çš„ä¼˜åŠ¿ï¼Œè¾ƒä½çš„å»¶è¿Ÿã€‚</p>
<p>ä½¿ç”¨åŸºäºè®¡æ•°çš„çª—å£æ—¶ï¼Œè¯·è®°ä½ï¼Œåªæœ‰çª—å£å†…çš„äº‹ä»¶æ•°é‡åˆ°è¾¾çª—å£è¦æ±‚çš„æ•°å€¼æ—¶ï¼Œè¿™äº›çª—å£æ‰ä¼šè§¦å‘è®¡ç®—ã€‚å°½ç®¡å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰è§¦å‘å™¨è‡ªå·±å®ç°è¯¥è¡Œä¸ºï¼Œä½†æ— æ³•åº”å¯¹è¶…æ—¶å’Œå¤„ç†éƒ¨åˆ†çª—å£ã€‚</p>
<p>æˆ‘ä»¬å¯èƒ½åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæƒ³ä½¿ç”¨å…¨å±€ window assigner å°†æ¯ä¸ªäº‹ä»¶ï¼ˆç›¸åŒçš„ keyï¼‰éƒ½åˆ†é…ç»™æŸä¸€ä¸ªæŒ‡å®šçš„å…¨å±€çª—å£ã€‚ å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„å»ºè®®æ˜¯ä½¿ç”¨ <code>ProcessFunction</code>ï¼Œå…·ä½“ä»‹ç»åœ¨<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#process-functions">è¿™é‡Œ</a>ã€‚</p>
<h3 id="çª—å£åº”ç”¨å‡½æ•°"><a href="#çª—å£åº”ç”¨å‡½æ•°" class="headerlink" title="çª—å£åº”ç”¨å‡½æ•°"></a>çª—å£åº”ç”¨å‡½æ•°</h3><p>æˆ‘ä»¬æœ‰ä¸‰ç§æœ€åŸºæœ¬çš„æ“ä½œçª—å£å†…çš„äº‹ä»¶çš„é€‰é¡¹:</p>
<ol>
<li>åƒæ‰¹é‡å¤„ç†ï¼Œ<code>ProcessWindowFunction</code> ä¼šç¼“å­˜ <code>Iterable</code> å’Œçª—å£å†…å®¹ï¼Œä¾›æ¥ä¸‹æ¥å…¨é‡è®¡ç®—ï¼›</li>
<li>æˆ–è€…åƒæµå¤„ç†ï¼Œæ¯ä¸€æ¬¡æœ‰äº‹ä»¶è¢«åˆ†é…åˆ°çª—å£æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>ReduceFunction</code> æˆ–è€… <code>AggregateFunction</code> æ¥å¢é‡è®¡ç®—ï¼›</li>
<li>æˆ–è€…ç»“åˆä¸¤è€…ï¼Œé€šè¿‡ <code>ReduceFunction</code> æˆ–è€… <code>AggregateFunction</code> é¢„èšåˆçš„å¢é‡è®¡ç®—ç»“æœåœ¨è§¦å‘çª—å£æ—¶ï¼Œ æä¾›ç»™ <code>ProcessWindowFunction</code> åšå…¨é‡è®¡ç®—ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥å±•ç¤ºä¸€æ®µ 1 å’Œ 3 çš„ç¤ºä¾‹ï¼Œæ¯ä¸€ä¸ªå®ç°éƒ½æ˜¯è®¡ç®—ä¼ æ„Ÿå™¨çš„æœ€å¤§å€¼ã€‚åœ¨æ¯ä¸€ä¸ªä¸€åˆ†é’Ÿå¤§å°çš„äº‹ä»¶æ—¶é—´çª—å£å†…, ç”Ÿæˆä¸€ä¸ªåŒ…å« <code>(key,end-of-window-timestamp, max_value)</code> çš„ä¸€ç»„ç»“æœã€‚</p>
<h4 id="ProcessWindowFunction-ç¤ºä¾‹"><a href="#ProcessWindowFunction-ç¤ºä¾‹" class="headerlink" title="ProcessWindowFunction ç¤ºä¾‹"></a>ProcessWindowFunction ç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; input = ...</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(x -&gt; x.key)</span><br><span class="line">    .window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1</span>)))</span><br><span class="line">    .process(<span class="keyword">new</span> <span class="title class_">MyWastefulMax</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWastefulMax</span> <span class="keyword">extends</span> <span class="title class_">ProcessWindowFunction</span>&lt;</span><br><span class="line">        SensorReading,                  <span class="comment">// è¾“å…¥ç±»å‹</span></span><br><span class="line">        Tuple3&lt;String, Long, Integer&gt;,  <span class="comment">// è¾“å‡ºç±»å‹</span></span><br><span class="line">        String,                         <span class="comment">// é”®ç±»å‹</span></span><br><span class="line">        TimeWindow&gt; &#123;                   <span class="comment">// çª—å£ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(</span></span><br><span class="line"><span class="params">            String key,</span></span><br><span class="line"><span class="params">            Context context,</span></span><br><span class="line"><span class="params">            Iterable&lt;SensorReading&gt; events,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;String, Long, Integer&gt;&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (SensorReading event : events) &#123;</span><br><span class="line">            max = Math.max(event.value, max);</span><br><span class="line">        &#125;</span><br><span class="line">        out.collect(Tuple3.of(key, context.window().getEnd(), max));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å½“å‰å®ç°ä¸­æœ‰ä¸€äº›å€¼å¾—å…³æ³¨çš„åœ°æ–¹ï¼š</p>
<ul>
<li>Flink ä¼šç¼“å­˜æ‰€æœ‰åˆ†é…ç»™çª—å£çš„äº‹ä»¶æµï¼Œç›´åˆ°è§¦å‘çª—å£ä¸ºæ­¢ã€‚è¿™ä¸ªæ“ä½œå¯èƒ½æ˜¯ç›¸å½“æ˜‚è´µçš„ã€‚</li>
<li>Flink ä¼šä¼ é€’ç»™ <code>ProcessWindowFunction</code> ä¸€ä¸ª <code>Context</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å†…åŒ…å«äº†ä¸€äº›çª—å£ä¿¡æ¯ã€‚<code>Context</code> æ¥å£ å±•ç¤ºå¤§è‡´å¦‚ä¸‹:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> W <span class="title function_">window</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">currentProcessingTime</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">currentWatermark</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title function_">windowState</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title function_">globalState</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>windowState</code> å’Œ <code>globalState</code> å¯ä»¥ç”¨æ¥å­˜å‚¨å½“å‰çš„çª—å£çš„ keyã€çª—å£æˆ–è€…å½“å‰ key çš„æ¯ä¸€ä¸ªçª—å£ä¿¡æ¯ã€‚è¿™åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šå¾ˆæœ‰ç”¨ï¼Œè¯•æƒ³ï¼Œæˆ‘ä»¬åœ¨å¤„ç†å½“å‰çª—å£çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šç”¨åˆ°ä¸Šä¸€ä¸ªçª—å£çš„ä¿¡æ¯ã€‚</p>
<h4 id="å¢é‡èšåˆç¤ºä¾‹"><a href="#å¢é‡èšåˆç¤ºä¾‹" class="headerlink" title="å¢é‡èšåˆç¤ºä¾‹"></a>å¢é‡èšåˆç¤ºä¾‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; input = ...</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(x -&gt; x.key)</span><br><span class="line">    .window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1</span>)))</span><br><span class="line">    .reduce(<span class="keyword">new</span> <span class="title class_">MyReducingMax</span>(), <span class="keyword">new</span> <span class="title class_">MyWindowFunction</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyReducingMax</span> <span class="keyword">implements</span> <span class="title class_">ReduceFunction</span>&lt;SensorReading&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> SensorReading <span class="title function_">reduce</span><span class="params">(SensorReading r1, SensorReading r2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r1.value() &gt; r2.value() ? r1 : r2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWindowFunction</span> <span class="keyword">extends</span> <span class="title class_">ProcessWindowFunction</span>&lt;</span><br><span class="line">    SensorReading, Tuple3&lt;String, Long, SensorReading&gt;, String, TimeWindow&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(</span></span><br><span class="line"><span class="params">            String key,</span></span><br><span class="line"><span class="params">            Context context,</span></span><br><span class="line"><span class="params">            Iterable&lt;SensorReading&gt; maxReading,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;String, Long, SensorReading&gt;&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SensorReading</span> <span class="variable">max</span> <span class="operator">=</span> maxReading.iterator().next();</span><br><span class="line">        out.collect(Tuple3.of(key, context.window().getEnd(), max));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ <code>Iterable&lt;SensorReading&gt;</code> å°†åªåŒ…å«ä¸€ä¸ªè¯»æ•° â€“ <code>MyReducingMax</code> è®¡ç®—å‡ºçš„é¢„å…ˆæ±‡æ€»çš„æœ€å¤§å€¼ã€‚</p>
<h3 id="æ™šåˆ°çš„äº‹ä»¶"><a href="#æ™šåˆ°çš„äº‹ä»¶" class="headerlink" title="æ™šåˆ°çš„äº‹ä»¶"></a>æ™šåˆ°çš„äº‹ä»¶</h3><p>é»˜è®¤åœºæ™¯ä¸‹ï¼Œè¶…è¿‡æœ€å¤§æ— åºè¾¹ç•Œçš„äº‹ä»¶ä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯ Flink ç»™äº†æˆ‘ä»¬ä¸¤ä¸ªé€‰æ‹©å»æ§åˆ¶è¿™äº›äº‹ä»¶ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ç§ç§°ä¸º<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#side-outputs">æ—è·¯è¾“å‡º</a> çš„æœºåˆ¶æ¥å®‰æ’å°†è¦åˆ é™¤çš„äº‹ä»¶æ”¶é›†åˆ°ä¾§è¾“å‡ºæµä¸­ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªç¤ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OutputTag&lt;Event&gt; lateTag = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;Event&gt;(<span class="string">&quot;late&quot;</span>)&#123;&#125;;</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Event&gt; result = stream.</span><br><span class="line">    .keyBy(...)</span><br><span class="line">    .window(...)</span><br><span class="line">    .sideOutputLateData(lateTag)</span><br><span class="line">    .process(...);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Event&gt; lateStream = result.getSideOutput(lateTag);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜å¯ä»¥æŒ‡å®š <em>å…è®¸çš„å»¶è¿Ÿ(allowed lateness)</em> çš„é—´éš”ï¼Œåœ¨è¿™ä¸ªé—´éš”æ—¶é—´å†…ï¼Œå»¶è¿Ÿçš„äº‹ä»¶å°†ä¼šç»§ç»­åˆ†é…ç»™çª—å£ï¼ˆåŒæ—¶çŠ¶æ€ä¼šè¢«ä¿ç•™ï¼‰ï¼Œé»˜è®¤çŠ¶æ€ä¸‹ï¼Œæ¯ä¸ªå»¶è¿Ÿäº‹ä»¶éƒ½ä¼šå¯¼è‡´çª—å£å‡½æ•°è¢«å†æ¬¡è°ƒç”¨ï¼ˆæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸º <em>late firing</em> ï¼‰ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå…è®¸çš„å»¶è¿Ÿä¸º 0ã€‚æ¢å¥è¯è¯´ï¼Œwatermark ä¹‹åçš„å…ƒç´ å°†è¢«ä¸¢å¼ƒï¼ˆæˆ–å‘é€åˆ°ä¾§è¾“å‡ºæµï¼‰ã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .keyBy(...)</span><br><span class="line">    .window(...)</span><br><span class="line">    .allowedLateness(Time.seconds(<span class="number">10</span>))</span><br><span class="line">    .process(...);</span><br></pre></td></tr></table></figure>

<p>å½“å…è®¸çš„å»¶è¿Ÿå¤§äºé›¶æ—¶ï¼Œåªæœ‰é‚£äº›è¶…è¿‡æœ€å¤§æ— åºè¾¹ç•Œä»¥è‡³äºä¼šè¢«ä¸¢å¼ƒçš„äº‹ä»¶æ‰ä¼šè¢«å‘é€åˆ°ä¾§è¾“å‡ºæµï¼ˆå¦‚æœå·²é…ç½®ï¼‰ã€‚</p>
<h3 id="æ·±å…¥äº†è§£çª—å£æ“ä½œ"><a href="#æ·±å…¥äº†è§£çª—å£æ“ä½œ" class="headerlink" title="æ·±å…¥äº†è§£çª—å£æ“ä½œ"></a>æ·±å…¥äº†è§£çª—å£æ“ä½œ</h3><p>Flink çš„çª—å£ API æŸäº›æ–¹é¢æœ‰ä¸€äº›å¥‡æ€ªçš„è¡Œä¸ºï¼Œå¯èƒ½å’Œæˆ‘ä»¬é¢„æœŸçš„è¡Œä¸ºä¸ä¸€è‡´ã€‚ æ ¹æ® <a target="_blank" rel="noopener" href="https://flink.apache.org/community.html#mailing-lists">Flink ç”¨æˆ·é‚®ä»¶åˆ—è¡¨</a> å’Œå…¶ä»–åœ°æ–¹ä¸€äº›é¢‘ç¹è¢«é—®èµ·çš„é—®é¢˜, ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰å…³ Windows çš„åº•å±‚äº‹å®ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¼šè®©æ‚¨æ„Ÿåˆ°æƒŠè®¶ã€‚</p>
<h4 id="æ»‘åŠ¨çª—å£æ˜¯é€šè¿‡å¤åˆ¶æ¥å®ç°çš„"><a href="#æ»‘åŠ¨çª—å£æ˜¯é€šè¿‡å¤åˆ¶æ¥å®ç°çš„" class="headerlink" title="æ»‘åŠ¨çª—å£æ˜¯é€šè¿‡å¤åˆ¶æ¥å®ç°çš„"></a>æ»‘åŠ¨çª—å£æ˜¯é€šè¿‡å¤åˆ¶æ¥å®ç°çš„</h4><p>æ»‘åŠ¨çª—å£åˆ†é…å™¨å¯ä»¥åˆ›å»ºè®¸å¤šçª—å£å¯¹è±¡ï¼Œå¹¶å°†æ¯ä¸ªäº‹ä»¶å¤åˆ¶åˆ°æ¯ä¸ªç›¸å…³çš„çª—å£ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ¯éš” 15 åˆ†é’Ÿå°±æœ‰ 24 å°æ—¶çš„æ»‘åŠ¨çª—å£ï¼Œåˆ™æ¯ä¸ªäº‹ä»¶å°†è¢«å¤åˆ¶åˆ° 4 * 24 &#x3D; 96 ä¸ªçª—å£ä¸­ã€‚</p>
<h4 id="æ—¶é—´çª—å£ä¼šå’Œæ—¶é—´å¯¹é½"><a href="#æ—¶é—´çª—å£ä¼šå’Œæ—¶é—´å¯¹é½" class="headerlink" title="æ—¶é—´çª—å£ä¼šå’Œæ—¶é—´å¯¹é½"></a>æ—¶é—´çª—å£ä¼šå’Œæ—¶é—´å¯¹é½</h4><p>ä»…ä»…å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå°æ—¶çš„å¤„ç†æ—¶é—´çª—å£å¹¶åœ¨ 12:05 å¼€å§‹è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸æ„å‘³ç€ç¬¬ä¸€ä¸ªçª—å£å°†åœ¨ 1:05 å…³é—­ã€‚ç¬¬ä¸€ä¸ªçª—å£å°†é•¿ 55 åˆ†é’Ÿï¼Œå¹¶åœ¨ 1:00 å…³é—­ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œæ»‘åŠ¨çª—å£å’Œæ»šåŠ¨çª—å£åˆ†é…å™¨æ‰€é‡‡ç”¨çš„ offset å‚æ•°å¯ç”¨äºæ”¹å˜çª—å£çš„å¯¹é½æ–¹å¼ã€‚æœ‰å…³è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·å‚è§ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/windows/#tumbling-windows">æ»šåŠ¨çª—å£</a> å’Œ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/windows/#sliding-windows">æ»‘åŠ¨çª—å£</a> ã€‚</p>
<h4 id="window-åé¢å¯ä»¥æ¥-window"><a href="#window-åé¢å¯ä»¥æ¥-window" class="headerlink" title="window åé¢å¯ä»¥æ¥ window"></a>window åé¢å¯ä»¥æ¥ window</h4><p>æ¯”å¦‚è¯´:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stream</span><br><span class="line">    .keyBy(t -&gt; t.key)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .reduce(&lt;reduce function&gt;)</span><br><span class="line">    .windowAll(&lt;same window assigner&gt;)</span><br><span class="line">    .reduce(&lt;same reduce function&gt;)</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½æˆ‘ä»¬ä¼šçŒœæµ‹ä»¥ Flink çš„èƒ½åŠ›ï¼Œæƒ³è¦åšåˆ°è¿™æ ·çœ‹èµ·æ¥æ˜¯å¯è¡Œçš„ï¼ˆå‰ææ˜¯ä½ ä½¿ç”¨çš„æ˜¯ ReduceFunction æˆ– AggregateFunction ï¼‰ï¼Œä½†ä¸æ˜¯ã€‚</p>
<p>ä¹‹æ‰€ä»¥å¯è¡Œï¼Œæ˜¯å› ä¸ºæ—¶é—´çª—å£äº§ç”Ÿçš„äº‹ä»¶æ˜¯æ ¹æ®çª—å£ç»“æŸæ—¶çš„æ—¶é—´åˆ†é…æ—¶é—´æˆ³çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå°æ—¶å°æ—¶çš„çª—å£æ‰€äº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶éƒ½å°†å¸¦æœ‰æ ‡è®°ä¸€ä¸ªå°æ—¶ç»“æŸçš„æ—¶é—´æˆ³ã€‚åé¢çš„çª—å£å†…çš„æ•°æ®æ¶ˆè´¹å’Œå‰é¢çš„æµäº§ç”Ÿçš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚</p>
<h4 id="ç©ºçš„æ—¶é—´çª—å£ä¸ä¼šè¾“å‡ºç»“æœ"><a href="#ç©ºçš„æ—¶é—´çª—å£ä¸ä¼šè¾“å‡ºç»“æœ" class="headerlink" title="ç©ºçš„æ—¶é—´çª—å£ä¸ä¼šè¾“å‡ºç»“æœ"></a>ç©ºçš„æ—¶é—´çª—å£ä¸ä¼šè¾“å‡ºç»“æœ</h4><p>äº‹ä»¶ä¼šè§¦å‘çª—å£çš„åˆ›å»ºã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœåœ¨ç‰¹å®šçš„çª—å£å†…æ²¡æœ‰äº‹ä»¶ï¼Œå°±ä¸ä¼šæœ‰çª—å£ï¼Œå°±ä¸ä¼šæœ‰è¾“å‡ºç»“æœã€‚</p>
<h4 id="å»¶è¿Ÿæ—¶é—´ä¼šå¯¼è‡´å»¶è¿Ÿèšåˆ"><a href="#å»¶è¿Ÿæ—¶é—´ä¼šå¯¼è‡´å»¶è¿Ÿèšåˆ" class="headerlink" title="å»¶è¿Ÿæ—¶é—´ä¼šå¯¼è‡´å»¶è¿Ÿèšåˆ"></a>å»¶è¿Ÿæ—¶é—´ä¼šå¯¼è‡´å»¶è¿Ÿèšåˆ</h4><p>ä¼šè¯çª—å£çš„å®ç°æ˜¯åŸºäºçª—å£çš„ä¸€ä¸ªæŠ½è±¡èƒ½åŠ›ï¼Œçª—å£å¯ä»¥ _èšåˆ_ã€‚ä¼šè¯çª—å£ä¸­çš„æ¯ä¸ªæ•°æ®åœ¨åˆå§‹è¢«æ¶ˆè´¹æ—¶ï¼Œéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæ–°çš„çª—å£ï¼Œä½†æ˜¯å¦‚æœçª—å£ä¹‹é—´çš„é—´éš”è¶³å¤Ÿå°ï¼Œå¤šä¸ªçª—å£å°±ä¼šè¢«èšåˆã€‚å»¶è¿Ÿäº‹ä»¶å¯ä»¥å¼¥åˆä¸¤ä¸ªå…ˆå‰åˆ†å¼€çš„ä¼šè¯é—´éš”ï¼Œä»è€Œäº§ç”Ÿä¸€ä¸ªè™½ç„¶æœ‰å»¶è¿Ÿä½†æ˜¯æ›´åŠ å‡†ç¡®åœ°ç»“æœã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink å®˜æ–¹æ–‡æ¡£</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/692bd7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/692bd7/" class="post-title-link" itemprop="url">Flink äº‹ä»¶é©±åŠ¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-äº‹ä»¶é©±åŠ¨"><a href="#Flink-äº‹ä»¶é©±åŠ¨" class="headerlink" title="Flink äº‹ä»¶é©±åŠ¨"></a>Flink äº‹ä»¶é©±åŠ¨</h1><h2 id="å¤„ç†å‡½æ•°ï¼ˆProcess-Functionsï¼‰"><a href="#å¤„ç†å‡½æ•°ï¼ˆProcess-Functionsï¼‰" class="headerlink" title="å¤„ç†å‡½æ•°ï¼ˆProcess Functionsï¼‰"></a>å¤„ç†å‡½æ•°ï¼ˆProcess Functionsï¼‰</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><code>ProcessFunction</code> å°†äº‹ä»¶å¤„ç†ä¸ Timerï¼ŒState ç»“åˆåœ¨ä¸€èµ·ï¼Œä½¿å…¶æˆä¸ºæµå¤„ç†åº”ç”¨çš„å¼ºå¤§æ„å»ºæ¨¡å—ã€‚ è¿™æ˜¯ä½¿ç”¨ Flink åˆ›å»ºäº‹ä»¶é©±åŠ¨åº”ç”¨ç¨‹åºçš„åŸºç¡€ã€‚å®ƒå’Œ <code>RichFlatMapFunction</code> ååˆ†ç›¸ä¼¼ï¼Œ ä½†æ˜¯å¢åŠ äº† Timerã€‚</p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>å¦‚æœä½ å·²ç»ä½“éªŒäº† <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/streaming_analytics/">æµå¼åˆ†æè®­ç»ƒ</a> çš„<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/streaming_analytics/#hands-on">åŠ¨æ‰‹å®è·µ</a>ï¼Œ ä½ åº”è¯¥è®°å¾—ï¼Œå®ƒæ˜¯é‡‡ç”¨ <code>TumblingEventTimeWindow</code> æ¥è®¡ç®—æ¯ä¸ªå°æ—¶å†…æ¯ä¸ªå¸æœºçš„å°è´¹æ€»å’Œï¼Œ åƒä¸‹é¢çš„ç¤ºä¾‹è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æ¯ä¸ªå¸æœºæ¯å°æ—¶çš„å°è´¹æ€»å’Œ</span></span><br><span class="line">DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt; hourlyTips = fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .window(TumblingEventTimeWindows.of(Time.hours(<span class="number">1</span>)))</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">AddTips</span>());</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>KeyedProcessFunction</code> å»å®ç°ç›¸åŒçš„æ“ä½œæ›´åŠ ç›´æ¥ä¸”æ›´æœ‰å­¦ä¹ æ„ä¹‰ã€‚ è®©æˆ‘ä»¬å¼€å§‹ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢ä¸Šé¢çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æ¯ä¸ªå¸æœºæ¯å°æ—¶çš„å°è´¹æ€»å’Œ</span></span><br><span class="line">DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt; hourlyTips = fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">PseudoWindow</span>(Time.hours(<span class="number">1</span>)));</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä»£ç ç‰‡æ®µä¸­ï¼Œä¸€ä¸ªåä¸º <code>PseudoWindow</code> çš„ <code>KeyedProcessFunction</code> è¢«åº”ç”¨äº KeyedStreamï¼Œ å…¶ç»“æœæ˜¯ä¸€ä¸ª <code>DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt;</code> ï¼ˆä¸ä½¿ç”¨ Flink å†…ç½®æ—¶é—´çª—å£çš„å®ç°ç”Ÿæˆçš„æµç›¸åŒï¼‰ã€‚</p>
<p><code>PseudoWindow</code> çš„æ€»ä½“è½®å»“ç¤ºæ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ—¶é•¿è·¨åº¦ä¸ºä¸€å°æ—¶çš„çª—å£ä¸­è®¡ç®—æ¯ä¸ªå¸æœºçš„å°è´¹æ€»å’Œã€‚</span></span><br><span class="line"><span class="comment">// å¸æœºIDä½œä¸º keyã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PseudoWindow</span> <span class="keyword">extends</span></span><br><span class="line">        <span class="title class_">KeyedProcessFunction</span>&lt;Long, TaxiFare, Tuple3&lt;Long, Long, Float&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> durationMsec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PseudoWindow</span><span class="params">(Time duration)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.durationMsec = duration.toMilliseconds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// åœ¨åˆå§‹åŒ–æœŸé—´è°ƒç”¨ä¸€æ¬¡ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ªç¥¨ä»·äº‹ä»¶ï¼ˆTaxiFare-Eventï¼‰è¾“å…¥ï¼ˆåˆ°è¾¾ï¼‰æ—¶è°ƒç”¨ï¼Œä»¥å¤„ç†è¾“å…¥çš„ç¥¨ä»·äº‹ä»¶ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(</span></span><br><span class="line"><span class="params">            TaxiFare fare,</span></span><br><span class="line"><span class="params">            Context ctx,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å½“å½“å‰æ°´å°ï¼ˆwatermarkï¼‰è¡¨æ˜çª—å£ç°åœ¨éœ€è¦å®Œæˆçš„æ—¶å€™è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp,</span></span><br><span class="line"><span class="params">            OnTimerContext context,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>æœ‰å‡ ç§ç±»å‹çš„ ProcessFunctions â€“ ä¸ä»…åŒ…æ‹¬ <code>KeyedProcessFunction</code>ï¼Œè¿˜åŒ…æ‹¬ <code>CoProcessFunctions</code>ã€<code>BroadcastProcessFunctions</code> ç­‰.</li>
<li><code>KeyedProcessFunction</code> æ˜¯ä¸€ç§ <code>RichFunction</code>ã€‚ä½œä¸º <code>RichFunction</code>ï¼Œå®ƒå¯ä»¥è®¿é—®ä½¿ç”¨ Managed Keyed State æ‰€éœ€çš„ <code>open</code> å’Œ <code>getRuntimeContext</code> æ–¹æ³•ã€‚</li>
<li>æœ‰ä¸¤ä¸ªå›è°ƒæ–¹æ³•é¡»è¦å®ç°ï¼š <code>processElement</code> å’Œ <code>onTimer</code>ã€‚æ¯ä¸ªè¾“å…¥äº‹ä»¶éƒ½ä¼šè°ƒç”¨ <code>processElement</code> æ–¹æ³•ï¼› å½“è®¡æ—¶å™¨è§¦å‘æ—¶è°ƒç”¨ <code>onTimer</code>ã€‚å®ƒä»¬å¯ä»¥æ˜¯åŸºäºäº‹ä»¶æ—¶é—´ï¼ˆevent timeï¼‰çš„ timerï¼Œä¹Ÿå¯ä»¥æ˜¯åŸºäºå¤„ç†æ—¶é—´ï¼ˆprocessing timeï¼‰çš„ timerã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œ<code>processElement</code> å’Œ <code>onTimer</code> éƒ½æä¾›äº†ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºä¸ <code>TimerService</code> äº¤äº’ã€‚ è¿™ä¸¤ä¸ªå›è°ƒè¿˜ä¼ é€’äº†ä¸€ä¸ªå¯ç”¨äºå‘å‡ºç»“æœçš„ <code>Collector</code>ã€‚</li>
</ul>
<h4 id="open-æ–¹æ³•"><a href="#open-æ–¹æ³•" class="headerlink" title="open() æ–¹æ³•"></a><code>open()</code> æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯ä¸ªçª—å£éƒ½æŒæœ‰æ‰˜ç®¡çš„ Keyed state çš„å…¥å£ï¼Œå¹¶ä¸”æ ¹æ®çª—å£çš„ç»“æŸæ—¶é—´æ‰§è¡Œ keyed ç­–ç•¥ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªå¸æœºéƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„MapStateå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> MapState&lt;Long, Float&gt; sumOfTips;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line"></span><br><span class="line">    MapStateDescriptor&lt;Long, Float&gt; sumDesc =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(<span class="string">&quot;sumOfTips&quot;</span>, Long.class, Float.class);</span><br><span class="line">    sumOfTips = getRuntimeContext().getMapState(sumDesc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºç¥¨ä»·äº‹ä»¶ï¼ˆfare-eventï¼‰å¯èƒ½ä¼šä¹±åºåˆ°è¾¾ï¼Œæœ‰æ—¶éœ€è¦åœ¨è®¡ç®—è¾“å‡ºå‰ä¸€ä¸ªå°æ—¶ç»“æœå‰ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªå°æ—¶çš„äº‹ä»¶ã€‚ è¿™æ ·èƒ½å¤Ÿä¿è¯â€œä¹±åºé€ æˆçš„å»¶è¿Ÿæ•°æ®â€å¾—åˆ°æ­£ç¡®å¤„ç†ï¼ˆæ”¾åˆ°å‰ä¸€ä¸ªå°æ—¶ä¸­ï¼‰ã€‚ å®é™…ä¸Šï¼Œå¦‚æœ Watermark å»¶è¿Ÿæ¯”çª—å£é•¿åº¦é•¿å¾—å¤šï¼Œåˆ™å¯èƒ½æœ‰å¤šä¸ªçª—å£åŒæ—¶æ‰“å¼€ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸¤ä¸ªã€‚ æ­¤å®ç°é€šè¿‡ä½¿ç”¨ <code>MapState</code> æ¥æ”¯æŒå¤„ç†è¿™ä¸€ç‚¹ï¼Œè¯¥ <code>MapState</code> å°†æ¯ä¸ªçª—å£çš„ç»“æŸæ—¶é—´æˆ³æ˜ å°„åˆ°è¯¥çª—å£çš„å°è´¹æ€»å’Œã€‚</p>
<h4 id="processElement-æ–¹æ³•"><a href="#processElement-æ–¹æ³•" class="headerlink" title="processElement() æ–¹æ³•"></a><code>processElement()</code> æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(</span></span><br><span class="line"><span class="params">        TaxiFare fare,</span></span><br><span class="line"><span class="params">        Context ctx,</span></span><br><span class="line"><span class="params">        Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">eventTime</span> <span class="operator">=</span> fare.getEventTime();</span><br><span class="line">    <span class="type">TimerService</span> <span class="variable">timerService</span> <span class="operator">=</span> ctx.timerService();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventTime &lt;= timerService.currentWatermark()) &#123;</span><br><span class="line">        <span class="comment">// äº‹ä»¶å»¶è¿Ÿï¼›å…¶å¯¹åº”çš„çª—å£å·²ç»è§¦å‘ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å°† eventTime å‘ä¸Šå–å€¼å¹¶å°†ç»“æœèµ‹å€¼åˆ°åŒ…å«å½“å‰äº‹ä»¶çš„çª—å£çš„æœ«å°¾æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endOfWindow</span> <span class="operator">=</span> (eventTime - (eventTime % durationMsec) + durationMsec - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨çª—å£å®Œæˆæ—¶å°†å¯ç”¨å›è°ƒ</span></span><br><span class="line">        timerService.registerEventTimeTimer(endOfWindow);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†æ­¤ç¥¨ä»·çš„å°è´¹æ·»åŠ åˆ°è¯¥çª—å£çš„æ€»è®¡ä¸­ã€‚</span></span><br><span class="line">        <span class="type">Float</span> <span class="variable">sum</span> <span class="operator">=</span> sumOfTips.get(endOfWindow);</span><br><span class="line">        <span class="keyword">if</span> (sum == <span class="literal">null</span>) &#123;</span><br><span class="line">            sum = <span class="number">0.0F</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sum += fare.tip;</span><br><span class="line">        sumOfTips.put(endOfWindow, sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦è€ƒè™‘çš„äº‹é¡¹ï¼š</p>
<ul>
<li>å»¶è¿Ÿçš„äº‹ä»¶æ€ä¹ˆå¤„ç†ï¼Ÿwatermark åé¢çš„äº‹ä»¶ï¼ˆå³å»¶è¿Ÿçš„ï¼‰æ­£åœ¨è¢«åˆ é™¤ã€‚ å¦‚æœä½ æƒ³åšä¸€äº›æ¯”è¿™æ›´é«˜çº§çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ—è·¯è¾“å‡ºï¼ˆSide outputsï¼‰ï¼Œè¿™å°†åœ¨<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#side-outputs">ä¸‹ä¸€èŠ‚</a>ä¸­è§£é‡Šã€‚</li>
<li>æœ¬ä¾‹ä½¿ç”¨ä¸€ä¸ª <code>MapState</code>ï¼Œå…¶ä¸­ keys æ˜¯æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼Œå¹¶ä¸ºåŒä¸€æ—¶é—´æˆ³è®¾ç½®ä¸€ä¸ª Timerã€‚ è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ¨¡å¼ï¼›å®ƒä½¿å¾—åœ¨ Timer è§¦å‘æ—¶æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯å˜å¾—ç®€å•é«˜æ•ˆã€‚</li>
</ul>
<h4 id="onTimer-æ–¹æ³•"><a href="#onTimer-æ–¹æ³•" class="headerlink" title="onTimer() æ–¹æ³•"></a><code>onTimer()</code> æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">long</span> timestamp,</span></span><br><span class="line"><span class="params">        OnTimerContext context,</span></span><br><span class="line"><span class="params">        Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">driverId</span> <span class="operator">=</span> context.getCurrentKey();</span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾åˆšç»“æŸçš„ä¸€å°æ—¶ç»“æœã€‚</span></span><br><span class="line">    <span class="type">Float</span> <span class="variable">sumOfTips</span> <span class="operator">=</span> <span class="built_in">this</span>.sumOfTips.get(timestamp);</span><br><span class="line"></span><br><span class="line">    Tuple3&lt;Long, Long, Float&gt; result = Tuple3.of(driverId, timestamp, sumOfTips);</span><br><span class="line">    out.collect(result);</span><br><span class="line">    <span class="built_in">this</span>.sumOfTips.remove(timestamp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š</p>
<ul>
<li>ä¼ é€’ç»™ <code>onTimer</code> çš„ <code>OnTimerContext context</code> å¯ç”¨äºç¡®å®šå½“å‰ keyã€‚</li>
<li>æˆ‘ä»¬çš„ pseudo-windows åœ¨å½“å‰ Watermark åˆ°è¾¾æ¯å°æ—¶ç»“æŸæ—¶è§¦å‘ï¼Œæ­¤æ—¶è°ƒç”¨ <code>onTimer</code>ã€‚ è¿™ä¸ª <code>onTimer</code> æ–¹æ³•ä» <code>sumOfTips</code> ä¸­åˆ é™¤ç›¸å…³çš„æ¡ç›®ï¼Œè¿™æ ·åšçš„æ•ˆæœæ˜¯ä¸å¯èƒ½å®¹çº³å»¶è¿Ÿçš„äº‹ä»¶ã€‚ è¿™ç›¸å½“äºåœ¨ä½¿ç”¨ Flink çš„æ—¶é—´çª—å£æ—¶å°† allowedLateness è®¾ç½®ä¸ºé›¶ã€‚</li>
</ul>
<h3 id="æ€§èƒ½è€ƒè™‘"><a href="#æ€§èƒ½è€ƒè™‘" class="headerlink" title="æ€§èƒ½è€ƒè™‘"></a>æ€§èƒ½è€ƒè™‘</h3><p>Flink æä¾›äº†ä¸º RocksDB ä¼˜åŒ–çš„ <code>MapState</code> å’Œ <code>ListState</code> ç±»å‹ã€‚ ç›¸å¯¹äº <code>ValueState</code>ï¼Œæ›´å»ºè®®ä½¿ç”¨ <code>MapState</code> å’Œ <code>ListState</code>ï¼Œå› ä¸ºä½¿ç”¨ RocksDBStateBackend çš„æƒ…å†µä¸‹ï¼Œ <code>MapState</code> å’Œ <code>ListState</code> æ¯” <code>ValueState</code> æ€§èƒ½æ›´å¥½ã€‚ RocksDBStateBackend å¯ä»¥é™„åŠ åˆ° <code>ListState</code>ï¼Œè€Œæ— éœ€è¿›è¡Œï¼ˆåï¼‰åºåˆ—åŒ–ï¼Œ å¯¹äº <code>MapState</code>ï¼Œæ¯ä¸ª key&#x2F;value éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ RocksDB å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆåœ°è®¿é—®å’Œæ›´æ–° <code>MapState</code>ã€‚</p>
<h2 id="æ—è·¯è¾“å‡ºï¼ˆSide-Outputsï¼‰"><a href="#æ—è·¯è¾“å‡ºï¼ˆSide-Outputsï¼‰" class="headerlink" title="æ—è·¯è¾“å‡ºï¼ˆSide Outputsï¼‰"></a>æ—è·¯è¾“å‡ºï¼ˆSide Outputsï¼‰</h2><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>æœ‰å‡ ä¸ªå¾ˆå¥½çš„ç†ç”±å¸Œæœ›ä» Flink ç®—å­è·å¾—å¤šä¸ªè¾“å‡ºæµï¼Œå¦‚ä¸‹æŠ¥å‘Šæ¡ç›®ï¼š</p>
<ul>
<li>å¼‚å¸¸æƒ…å†µï¼ˆexceptionsï¼‰</li>
<li>æ ¼å¼é”™è¯¯çš„äº‹ä»¶ï¼ˆmalformed eventsï¼‰</li>
<li>å»¶è¿Ÿçš„äº‹ä»¶ï¼ˆlate eventsï¼‰</li>
<li>operator å‘Šè­¦ï¼ˆoperational alertsï¼‰ï¼Œå¦‚ä¸å¤–éƒ¨æœåŠ¡çš„è¿æ¥è¶…æ—¶</li>
</ul>
<p>æ—è·¯è¾“å‡ºï¼ˆSide outputsï¼‰æ˜¯ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•ã€‚é™¤äº†é”™è¯¯æŠ¥å‘Šä¹‹å¤–ï¼Œæ—è·¯è¾“å‡ºä¹Ÿæ˜¯å®ç°æµçš„ n è·¯åˆ†å‰²çš„å¥½æ–¹æ³•ã€‚</p>
<h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>ç°åœ¨ä½ å¯ä»¥å¯¹ä¸Šä¸€èŠ‚ä¸­å¿½ç•¥çš„å»¶è¿Ÿäº‹ä»¶æ‰§è¡ŒæŸäº›æ“ä½œã€‚</p>
<p>Side output channel ä¸ <code>OutputTag&lt;T&gt;</code> ç›¸å…³è”ã€‚è¿™äº›æ ‡è®°æ‹¥æœ‰è‡ªå·±çš„åç§°ï¼Œå¹¶ä¸å¯¹åº” DataStream ç±»å‹ä¸€è‡´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OutputTag&lt;TaxiFare&gt; lateFares = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;TaxiFare&gt;(<span class="string">&quot;lateFares&quot;</span>) &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªé™æ€ <code>OutputTag&lt;TaxiFare&gt;</code> ï¼Œå½“åœ¨ <code>PseudoWindow</code> çš„ <code>processElement</code> æ–¹æ³•ä¸­å‘å‡ºå»¶è¿Ÿäº‹ä»¶æ—¶ï¼Œå¯ä»¥å¼•ç”¨å®ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (eventTime &lt;= timerService.currentWatermark()) &#123;</span><br><span class="line">    <span class="comment">// äº‹ä»¶å»¶è¿Ÿï¼Œå…¶å¯¹åº”çš„çª—å£å·²ç»è§¦å‘ã€‚</span></span><br><span class="line">    ctx.output(lateFares, fare);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    . . .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥åŠå½“åœ¨ä½œä¸šçš„ <code>main</code> ä¸­ä»è¯¥æ—è·¯è¾“å‡ºè®¿é—®æµæ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æ¯ä¸ªå¸æœºæ¯å°æ—¶çš„å°è´¹æ€»å’Œ</span></span><br><span class="line"><span class="type">SingleOutputStreamOperator</span> <span class="variable">hourlyTips</span> <span class="operator">=</span> fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">PseudoWindow</span>(Time.hours(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">hourlyTips.getSideOutput(lateFares).print();</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ä¸ªåŒåçš„ OutputTag æ¥å¼•ç”¨åŒä¸€ä¸ªæ—è·¯è¾“å‡ºï¼Œä½†å¦‚æœè¿™æ ·åšï¼Œå®ƒä»¬å¿…é¡»å…·æœ‰ç›¸åŒçš„ç±»å‹ã€‚</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ å·²ç»äº†è§£äº†å¦‚ä½•ä½¿ç”¨ <code>ProcessFunction</code> é‡æ–°å®ç°ä¸€ä¸ªç®€å•çš„æ—¶é—´çª—å£ã€‚ å½“ç„¶ï¼Œå¦‚æœ Flink å†…ç½®çš„çª—å£ API èƒ½å¤Ÿæ»¡è¶³ä½ çš„å¼€å‘éœ€æ±‚ï¼Œé‚£ä¹ˆä¸€å®šè¦ä¼˜å…ˆä½¿ç”¨å®ƒã€‚ ä½†å¦‚æœä½ å‘ç°è‡ªå·±åœ¨è€ƒè™‘ç”¨ Flink çš„çª—å£åšäº›é”™ç»¼å¤æ‚çš„äº‹æƒ…ï¼Œä¸è¦å®³æ€•è‡ªå·±åŠ¨æ‰‹ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>ProcessFunctions</code> å¯¹äºè®¡ç®—åˆ†æä¹‹å¤–çš„è®¸å¤šå…¶ä»–ç”¨ä¾‹ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ ä¸‹é¢çš„å®è·µç»ƒä¹ æä¾›äº†ä¸€ä¸ªå®Œå…¨ä¸åŒçš„ä¾‹å­ã€‚</p>
<p><code>ProcessFunctions</code> çš„å¦ä¸€ä¸ªå¸¸è§ç”¨ä¾‹æ˜¯æ¸…ç†è¿‡æ—¶ Stateã€‚å¦‚æœä½ å›æƒ³ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://github.com/apache/flink-training/blob/release-1.14//rides-and-fares">Rides and Fares Exercise </a>ï¼Œ å…¶ä¸­ä½¿ç”¨ <code>RichCoFlatMapFunction</code> æ¥è®¡ç®—ç®€å• Joinï¼Œé‚£ä¹ˆç¤ºä¾‹æ–¹æ¡ˆå‡è®¾ TaxiRides å’Œ TaxiFares ä¸¤ä¸ªäº‹ä»¶æ˜¯ä¸¥æ ¼åŒ¹é…ä¸ºä¸€ä¸ªæœ‰æ•ˆ æ•°æ®å¯¹ï¼ˆå¿…é¡»åŒæ—¶å‡ºç°ï¼‰å¹¶ä¸”æ¯ä¸€ç»„è¿™æ ·çš„æœ‰æ•ˆæ•°æ®å¯¹éƒ½å’Œä¸€ä¸ªå”¯ä¸€çš„ <code>rideId</code> ä¸¥æ ¼å¯¹åº”ã€‚å¦‚æœæ•°æ®å¯¹ä¸­çš„æŸä¸ª TaxiRides äº‹ä»¶ï¼ˆTaxiFares äº‹ä»¶ï¼‰ ä¸¢å¤±ï¼Œåˆ™åŒä¸€ <code>rideId</code> å¯¹åº”çš„å¦ä¸€ä¸ªå‡ºç°çš„ TaxiFares äº‹ä»¶ï¼ˆTaxiRides äº‹ä»¶ï¼‰å¯¹åº”çš„ State åˆ™æ°¸è¿œä¸ä¼šè¢«æ¸…ç†æ‰ã€‚ æ‰€ä»¥è¿™é‡Œå¯ä»¥ä½¿ç”¨ <code>KeyedCoProcessFunction</code> çš„å®ç°ä»£æ›¿å®ƒï¼ˆ<code>RichCoFlatMapFunction</code>ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨è®¡æ—¶å™¨æ¥æ£€æµ‹å’Œæ¸…é™¤ä»»ä½•è¿‡æ—¶ çš„ Stateã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink å®˜æ–¹æ–‡æ¡£</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/6c8f32/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="æç‹—è›‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="å¤©æ°”ä¸é”™å“‡ï¼Œä½ çœ‹è¿™å¤§å†°é›¹ä¸‹å¾—">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/6c8f32/" class="post-title-link" itemprop="url">Flink ETL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>9.2k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>8 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-ETL"><a href="#Flink-ETL" class="headerlink" title="Flink ETL"></a>Flink ETL</h1><p>Apache Flink çš„ä¸€ç§å¸¸è§åº”ç”¨åœºæ™¯æ˜¯ ETLï¼ˆæŠ½å–ã€è½¬æ¢ã€åŠ è½½ï¼‰ç®¡é“ä»»åŠ¡ã€‚ä»ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®æºè·å–æ•°æ®ï¼Œè¿›è¡Œä¸€äº›è½¬æ¢æ“ä½œå’Œä¿¡æ¯è¡¥å……ï¼Œå°†ç»“æœå­˜å‚¨èµ·æ¥ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Flink çš„ DataStream API å®ç°è¿™ç±»åº”ç”¨ã€‚</p>
<p>è¿™é‡Œæ³¨æ„ï¼ŒFlink çš„ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/table/overview/">Table å’Œ SQL API</a> å®Œå…¨å¯ä»¥æ»¡è¶³å¾ˆå¤š ETL ä½¿ç”¨åœºæ™¯ã€‚ä½†æ— è®ºä½ æœ€ç»ˆæ˜¯å¦ç›´æ¥ä½¿ç”¨ DataStream APIï¼Œå¯¹è¿™é‡Œä»‹ç»çš„åŸºæœ¬çŸ¥è¯†æœ‰æ‰å®çš„ç†è§£éƒ½æ˜¯æœ‰ä»·å€¼çš„ã€‚</p>
<h2 id="æ— çŠ¶æ€çš„è½¬æ¢"><a href="#æ— çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æ— çŠ¶æ€çš„è½¬æ¢"></a>æ— çŠ¶æ€çš„è½¬æ¢</h2><p>æœ¬èŠ‚æ¶µç›–äº† <code>map()</code> å’Œ <code>flatmap()</code>ï¼Œè¿™ä¸¤ç§ç®—å­å¯ä»¥ç”¨æ¥å®ç°æ— çŠ¶æ€è½¬æ¢çš„åŸºæœ¬æ“ä½œã€‚</p>
<h3 id="map"><a href="#map" class="headerlink" title="map()"></a><code>map()</code></h3><p>åœ¨ç¬¬ä¸€ä¸ªç»ƒä¹ ä¸­ï¼Œä½ å°†è¿‡æ»¤å‡ºç§Ÿè½¦è¡Œç¨‹æ•°æ®ä¸­çš„äº‹ä»¶ã€‚åœ¨åŒä¸€ä»£ç ä»“åº“ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>GeoUtils</code> ç±»ï¼Œæä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• <code>GeoUtils.mapToGridCell(float lon, float lat)</code>ï¼Œå®ƒå¯ä»¥å°†ä½ç½®åæ ‡ï¼ˆç»åº¦ï¼Œç»´åº¦ï¼‰æ˜ å°„åˆ° 100x100 ç±³çš„å¯¹åº”ä¸åŒåŒºåŸŸçš„ç½‘æ ¼å•å…ƒã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä¸ºæ¯ä¸ªå‡ºç§Ÿè½¦è¡Œç¨‹æ—¶é—´çš„æ•°æ®å¯¹è±¡å¢åŠ  <code>startCell</code> å’Œ <code>endCell</code> å­—æ®µã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç»§æ‰¿ <code>TaxiRide</code> çš„ <code>EnrichedRide</code> ç±»ï¼Œæ·»åŠ è¿™äº›å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EnrichedRide</span> <span class="keyword">extends</span> <span class="title class_">TaxiRide</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> startCell;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> endCell;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnrichedRide</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnrichedRide</span><span class="params">(TaxiRide ride)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rideId = ride.rideId;</span><br><span class="line">        <span class="built_in">this</span>.isStart = ride.isStart;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.startCell = GeoUtils.mapToGridCell(ride.startLon, ride.startLat);</span><br><span class="line">        <span class="built_in">this</span>.endCell = GeoUtils.mapToGridCell(ride.endLon, ride.endLat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">            Integer.toString(<span class="built_in">this</span>.startCell) + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">            Integer.toString(<span class="built_in">this</span>.endCell);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªåº”ç”¨æ¥è½¬æ¢è¿™ä¸ªæµ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;TaxiRide&gt; rides = env.addSource(<span class="keyword">new</span> <span class="title class_">TaxiRideSource</span>(...));</span><br><span class="line"></span><br><span class="line">DataStream&lt;EnrichedRide&gt; enrichedNYCRides = rides</span><br><span class="line">    .filter(<span class="keyword">new</span> <span class="title class_">RideCleansingSolution</span>.NYCFilter())</span><br><span class="line">    .map(<span class="keyword">new</span> <span class="title class_">Enrichment</span>());</span><br><span class="line"></span><br><span class="line">enrichedNYCRides.print();</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨è¿™ä¸ª <code>MapFunction</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Enrichment</span> <span class="keyword">implements</span> <span class="title class_">MapFunction</span>&lt;TaxiRide, EnrichedRide&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EnrichedRide <span class="title function_">map</span><span class="params">(TaxiRide taxiRide)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EnrichedRide</span>(taxiRide);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flatmap"><a href="#flatmap" class="headerlink" title="flatmap()"></a><code>flatmap()</code></h3><p><code>MapFunction</code> åªé€‚ç”¨äºä¸€å¯¹ä¸€çš„è½¬æ¢ï¼šå¯¹æ¯ä¸ªè¿›å…¥ç®—å­çš„æµå…ƒç´ ï¼Œ<code>map()</code> å°†ä»…è¾“å‡ºä¸€ä¸ªè½¬æ¢åçš„å…ƒç´ ã€‚å¯¹äºé™¤æ­¤ä»¥å¤–çš„åœºæ™¯ï¼Œä½ å°†è¦ä½¿ç”¨ <code>flatmap()</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;TaxiRide&gt; rides = env.addSource(<span class="keyword">new</span> <span class="title class_">TaxiRideSource</span>(...));</span><br><span class="line"></span><br><span class="line">DataStream&lt;EnrichedRide&gt; enrichedNYCRides = rides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">NYCEnrichment</span>());</span><br><span class="line"></span><br><span class="line">enrichedNYCRides.print();</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç”¨åˆ°çš„ <code>FlatMapFunction</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NYCEnrichment</span> <span class="keyword">implements</span> <span class="title class_">FlatMapFunction</span>&lt;TaxiRide, EnrichedRide&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(TaxiRide taxiRide, Collector&lt;EnrichedRide&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        FilterFunction&lt;TaxiRide&gt; valid = <span class="keyword">new</span> <span class="title class_">RideCleansing</span>.NYCFilter();</span><br><span class="line">        <span class="keyword">if</span> (valid.filter(taxiRide)) &#123;</span><br><span class="line">            out.collect(<span class="keyword">new</span> <span class="title class_">EnrichedRide</span>(taxiRide));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ¥å£ä¸­æä¾›çš„ <code>Collector</code> ï¼Œ<code>flatmap()</code> å¯ä»¥è¾“å‡ºä½ æƒ³è¦çš„ä»»æ„æ•°é‡çš„å…ƒç´ ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªéƒ½ä¸å‘ã€‚</p>
<h2 id="Keyed-Streams"><a href="#Keyed-Streams" class="headerlink" title="Keyed Streams"></a>Keyed Streams</h2><h3 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy()"></a><code>keyBy()</code></h3><p>å°†ä¸€ä¸ªæµæ ¹æ®å…¶ä¸­çš„ä¸€äº›å±æ€§æ¥è¿›è¡Œåˆ†åŒºæ˜¯ååˆ†æœ‰ç”¨çš„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿æ‰€æœ‰å…·æœ‰ç›¸åŒå±æ€§çš„äº‹ä»¶åˆ†åˆ°ç›¸åŒçš„ç»„é‡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³æ‰¾åˆ°ä»æ¯ä¸ªç½‘æ ¼å•å…ƒå‡ºå‘çš„æœ€è¿œçš„å‡ºç§Ÿè½¦è¡Œç¨‹ã€‚æŒ‰ SQL æŸ¥è¯¢çš„æ–¹å¼æ¥è€ƒè™‘ï¼Œè¿™æ„å‘³ç€è¦å¯¹ <code>startCell</code> è¿›è¡Œ GROUP BY å†æ’åºï¼Œåœ¨ Flink ä¸­è¿™éƒ¨åˆ†å¯ä»¥ç”¨ <code>keyBy(KeySelector)</code> å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">NYCEnrichment</span>())</span><br><span class="line">    .keyBy(enrichedRide -&gt; enrichedRide.startCell)</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª <code>keyBy</code> ä¼šé€šè¿‡ shuffle æ¥ä¸ºæ•°æ®æµè¿›è¡Œé‡æ–°åˆ†åŒºã€‚æ€»ä½“æ¥è¯´è¿™ä¸ªå¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œå®ƒæ¶‰åŠç½‘ç»œé€šä¿¡ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/keyBy.png" alt="keyBy and network shuffle"></p>
<h3 id="é€šè¿‡è®¡ç®—å¾—åˆ°é”®"><a href="#é€šè¿‡è®¡ç®—å¾—åˆ°é”®" class="headerlink" title="é€šè¿‡è®¡ç®—å¾—åˆ°é”®"></a>é€šè¿‡è®¡ç®—å¾—åˆ°é”®</h3><p>KeySelector ä¸ä»…é™äºä»äº‹ä»¶ä¸­æŠ½å–é”®ã€‚ä½ ä¹Ÿå¯ä»¥æŒ‰æƒ³è¦çš„æ–¹å¼è®¡ç®—å¾—åˆ°é”®å€¼ï¼Œåªè¦æœ€ç»ˆç»“æœæ˜¯ç¡®å®šçš„ï¼Œå¹¶ä¸”å®ç°äº† <code>hashCode()</code> å’Œ <code>equals()</code>ã€‚è¿™äº›é™åˆ¶æ¡ä»¶ä¸åŒ…æ‹¬äº§ç”Ÿéšæœºæ•°æˆ–è€…è¿”å› Arrays æˆ– Enums çš„ KeySelectorï¼Œä½†ä½ å¯ä»¥ç”¨å…ƒç»„å’Œ POJO æ¥ç»„æˆé”®ï¼Œåªè¦ä»–ä»¬çš„å…ƒç´ éµå¾ªä¸Šè¿°æ¡ä»¶ã€‚</p>
<p>é”®å¿…é¡»æŒ‰ç¡®å®šçš„æ–¹å¼äº§ç”Ÿï¼Œå› ä¸ºå®ƒä»¬ä¼šåœ¨éœ€è¦çš„æ—¶å€™è¢«é‡æ–°è®¡ç®—ï¼Œè€Œä¸æ˜¯ä¸€ç›´è¢«å¸¦åœ¨æµè®°å½•ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ¯”èµ·åˆ›å»ºä¸€ä¸ªæ–°çš„å¸¦æœ‰ <code>startCell</code> å­—æ®µçš„ <code>EnrichedRide</code> ç±»ï¼Œç”¨è¿™ä¸ªå­—æ®µä½œä¸º keyï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyBy(enrichedRide -&gt; enrichedRide.startCell)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ›´å€¾å‘äºè¿™æ ·åšï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyBy(ride -&gt; GeoUtils.mapToGridCell(ride.startLon, ride.startLat))</span><br></pre></td></tr></table></figure>

<h3 id="Keyed-Stream-çš„èšåˆ"><a href="#Keyed-Stream-çš„èšåˆ" class="headerlink" title="Keyed Stream çš„èšåˆ"></a>Keyed Stream çš„èšåˆ</h3><p>ä»¥ä¸‹ä»£ç ä¸ºæ¯ä¸ªè¡Œç¨‹ç»“æŸäº‹ä»¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åŒ…å« <code>startCell</code> å’Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰çš„å…ƒç»„æµï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.joda.time.Interval;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;Integer, Minutes&gt;&gt; minutesByStartCell = enrichedNYCRides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">FlatMapFunction</span>&lt;EnrichedRide, Tuple2&lt;Integer, Minutes&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(EnrichedRide ride,</span></span><br><span class="line"><span class="params">                            Collector&lt;Tuple2&lt;Integer, Minutes&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ride.isStart) &#123;</span><br><span class="line">                <span class="type">Interval</span> <span class="variable">rideInterval</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interval</span>(ride.startTime, ride.endTime);</span><br><span class="line">                <span class="type">Minutes</span> <span class="variable">duration</span> <span class="operator">=</span> rideInterval.toDuration().toStandardMinutes();</span><br><span class="line">                out.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(ride.startCell, duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥äº§ç”Ÿä¸€ä¸ªæµï¼Œå¯¹æ¯ä¸ª <code>startCell</code> ä»…åŒ…å«é‚£äº›æœ€é•¿è¡Œç¨‹çš„æ•°æ®ã€‚</p>
<p>æœ‰å¾ˆå¤šç§æ–¹æ³•è¡¨ç¤ºä½¿ç”¨å“ªä¸ªå­—æ®µä½œä¸ºé”®ã€‚å‰é¢ä½¿ç”¨ <code>EnrichedRide</code> POJO çš„ä¾‹å­ï¼Œç”¨å­—æ®µåæ¥æŒ‡å®šé”®ã€‚è€Œè¿™ä¸ªä½¿ç”¨ <code>Tuple2</code> å¯¹è±¡çš„ä¾‹å­ä¸­ï¼Œç”¨å­—æ®µåœ¨å…ƒç»„ä¸­çš„åºå·ï¼ˆä» 0 å¼€å§‹ï¼‰æ¥æŒ‡å®šé”®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">minutesByStartCell</span><br><span class="line">  .keyBy(value -&gt; value.f0) <span class="comment">// .keyBy(value -&gt; value.startCell)</span></span><br><span class="line">  .maxBy(<span class="number">1</span>) <span class="comment">// duration</span></span><br><span class="line">  .print();</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ¯æ¬¡è¡Œç¨‹æ—¶é•¿è¾¾åˆ°æ–°çš„æœ€å¤§å€¼ï¼Œéƒ½ä¼šè¾“å‡ºä¸€æ¡æ–°è®°å½•ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªå¯¹åº” 50797 ç½‘æ ¼å•å…ƒçš„æ•°æ®ï¼š</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta prompt_">4&gt; </span>(<span class="number">64549</span>,<span class="number">5</span>M)</span><br><span class="line"><span class="meta prompt_">4&gt; </span>(<span class="number">46298</span>,<span class="number">18</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">51549</span>,<span class="number">14</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">53043</span>,<span class="number">13</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">56031</span>,<span class="number">22</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">6</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">8</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">11</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">12</span>M)</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€"><a href="#ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€" class="headerlink" title="ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€"></a>ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€</h3><p>è¿™æ˜¯åŸ¹è®­ä¸­ç¬¬ä¸€ä¸ªæ¶‰åŠåˆ°æœ‰çŠ¶æ€æµçš„ä¾‹å­ã€‚å°½ç®¡çŠ¶æ€çš„å¤„ç†æ˜¯é€æ˜çš„ï¼ŒFlink å¿…é¡»è·Ÿè¸ªæ¯ä¸ªä¸åŒçš„é”®çš„æœ€å¤§æ—¶é•¿ã€‚</p>
<p>åªè¦åº”ç”¨ä¸­æœ‰çŠ¶æ€ï¼Œä½ å°±åº”è¯¥è€ƒè™‘çŠ¶æ€çš„å¤§å°ã€‚å¦‚æœé”®å€¼çš„æ•°é‡æ˜¯æ— é™çš„ï¼Œé‚£ Flink çš„çŠ¶æ€éœ€è¦çš„ç©ºé—´ä¹ŸåŒæ ·æ˜¯æ— é™çš„ã€‚</p>
<p>åœ¨æµå¤„ç†åœºæ™¯ä¸­ï¼Œè€ƒè™‘æœ‰é™çª—å£çš„èšåˆå¾€å¾€æ¯”æ•´ä¸ªæµèšåˆæ›´æœ‰æ„ä¹‰ã€‚</p>
<h3 id="reduce-å’Œå…¶ä»–èšåˆç®—å­"><a href="#reduce-å’Œå…¶ä»–èšåˆç®—å­" class="headerlink" title="reduce() å’Œå…¶ä»–èšåˆç®—å­"></a><code>reduce()</code> å’Œå…¶ä»–èšåˆç®—å­</h3><p>ä¸Šé¢ç”¨åˆ°çš„ <code>maxBy()</code> åªæ˜¯ Flink ä¸­ <code>KeyedStream</code> ä¸Šä¼—å¤šèšåˆå‡½æ•°ä¸­çš„ä¸€ä¸ªã€‚è¿˜æœ‰ä¸€ä¸ªæ›´é€šç”¨çš„ <code>reduce()</code> å‡½æ•°å¯ä»¥ç”¨æ¥å®ç°ä½ çš„è‡ªå®šä¹‰èšåˆã€‚</p>
<h2 id="æœ‰çŠ¶æ€çš„è½¬æ¢"><a href="#æœ‰çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æœ‰çŠ¶æ€çš„è½¬æ¢"></a>æœ‰çŠ¶æ€çš„è½¬æ¢</h2><h3 id="Flink-ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ"><a href="#Flink-ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ" class="headerlink" title="Flink ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ"></a>Flink ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ</h3><p>åœ¨ Flink ä¸å‚ä¸ç®¡ç†çŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨çŠ¶æ€ï¼Œä½† Flink ä¸ºå…¶ç®¡ç†çŠ¶æ€æä¾›äº†ä¸€äº›å¼•äººæ³¨ç›®çš„ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>æœ¬åœ°æ€§</strong>: Flink çŠ¶æ€æ˜¯å­˜å‚¨åœ¨ä½¿ç”¨å®ƒçš„æœºå™¨æœ¬åœ°çš„ï¼Œå¹¶ä¸”å¯ä»¥ä»¥å†…å­˜è®¿é—®é€Ÿåº¦æ¥è·å–</li>
<li><strong>æŒä¹…æ€§</strong>: Flink çŠ¶æ€æ˜¯å®¹é”™çš„ï¼Œä¾‹å¦‚ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨æŒ‰ä¸€å®šçš„æ—¶é—´é—´éš”äº§ç”Ÿ checkpointï¼Œå¹¶ä¸”åœ¨ä»»åŠ¡å¤±è´¥åè¿›è¡Œæ¢å¤</li>
<li><strong>çºµå‘å¯æ‰©å±•æ€§</strong>: Flink çŠ¶æ€å¯ä»¥å­˜å‚¨åœ¨é›†æˆçš„ RocksDB å®ä¾‹ä¸­ï¼Œè¿™ç§æ–¹å¼ä¸‹å¯ä»¥é€šè¿‡å¢åŠ æœ¬åœ°ç£ç›˜æ¥æ‰©å±•ç©ºé—´</li>
<li><strong>æ¨ªå‘å¯æ‰©å±•æ€§</strong>: Flink çŠ¶æ€å¯ä»¥éšç€é›†ç¾¤çš„æ‰©ç¼©å®¹é‡æ–°åˆ†å¸ƒ</li>
<li><strong>å¯æŸ¥è¯¢æ€§</strong>: Flink çŠ¶æ€å¯ä»¥é€šè¿‡ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/queryable_state/">çŠ¶æ€æŸ¥è¯¢ API</a> ä»å¤–éƒ¨è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
</ul>
<p>åœ¨æœ¬èŠ‚ä¸­ä½ å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Flink çš„ API æ¥ç®¡ç† keyed stateã€‚</p>
<h3 id="Rich-Functions"><a href="#Rich-Functions" class="headerlink" title="Rich Functions"></a>Rich Functions</h3><p>è‡³æ­¤ï¼Œä½ å·²ç»çœ‹åˆ°äº† Flink çš„å‡ ç§å‡½æ•°æ¥å£ï¼ŒåŒ…æ‹¬ <code>FilterFunction</code>ï¼Œ <code>MapFunction</code>ï¼Œå’Œ <code>FlatMapFunction</code>ã€‚è¿™äº›éƒ½æ˜¯å•ä¸€æŠ½è±¡æ–¹æ³•æ¨¡å¼ã€‚</p>
<p>å¯¹å…¶ä¸­çš„æ¯ä¸€ä¸ªæ¥å£ï¼ŒFlink åŒæ ·æä¾›äº†ä¸€ä¸ªæ‰€è°“ â€œrichâ€ çš„å˜ä½“ï¼Œå¦‚ <code>RichFlatMapFunction</code>ï¼Œå…¶ä¸­å¢åŠ äº†ä»¥ä¸‹æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><code>open(Configuration c)</code></li>
<li><code>close()</code></li>
<li><code>getRuntimeContext()</code></li>
</ul>
<p><code>open()</code> ä»…åœ¨ç®—å­åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ã€‚å¯ä»¥ç”¨æ¥åŠ è½½ä¸€äº›é™æ€æ•°æ®ï¼Œæˆ–è€…å»ºç«‹å¤–éƒ¨æœåŠ¡çš„é“¾æ¥ç­‰ã€‚</p>
<p><code>getRuntimeContext()</code> ä¸ºæ•´å¥—æ½œåœ¨æœ‰è¶£çš„ä¸œè¥¿æä¾›äº†ä¸€ä¸ªè®¿é—®é€”å¾„ï¼Œæœ€æ˜æ˜¾çš„ï¼Œå®ƒæ˜¯ä½ åˆ›å»ºå’Œè®¿é—® Flink çŠ¶æ€çš„é€”å¾„ã€‚</p>
<h3 id="ä¸€ä¸ªä½¿ç”¨-Keyed-State-çš„ä¾‹å­"><a href="#ä¸€ä¸ªä½¿ç”¨-Keyed-State-çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªä½¿ç”¨ Keyed State çš„ä¾‹å­"></a>ä¸€ä¸ªä½¿ç”¨ Keyed State çš„ä¾‹å­</h3><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæƒ³è±¡ä½ æœ‰ä¸€ä¸ªè¦å»é‡çš„äº‹ä»¶æ•°æ®æµï¼Œå¯¹æ¯ä¸ªé”®åªä¿ç•™ç¬¬ä¸€ä¸ªäº‹ä»¶ã€‚ä¸‹é¢æ˜¯å®Œæˆè¿™ä¸ªåŠŸèƒ½çš„åº”ç”¨ï¼Œä½¿ç”¨ä¸€ä¸ªåä¸º <code>Deduplicator</code> çš„ <code>RichFlatMapFunction</code> ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String key;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> timestamp;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="title class_">EventSource</span>())</span><br><span class="line">        .keyBy(e -&gt; e.key)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> <span class="title class_">Deduplicator</span>())</span><br><span class="line">        .print();</span><br><span class="line"></span><br><span class="line">    env.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œ<code>Deduplicator</code> éœ€è¦è®°å½•æ¯ä¸ªé”®æ˜¯å¦å·²ç»æœ‰äº†ç›¸åº”çš„è®°å½•ã€‚å®ƒå°†é€šè¿‡ä½¿ç”¨ Flink çš„ <em>keyed state</em> æ¥å£æ¥åšè¿™ä»¶äº‹ã€‚</p>
<p>å½“ä½ ä½¿ç”¨åƒè¿™æ ·çš„ keyed stream çš„æ—¶å€™ï¼ŒFlink ä¼šä¸ºæ¯ä¸ªçŠ¶æ€ä¸­ç®¡ç†çš„æ¡ç›®ç»´æŠ¤ä¸€ä¸ªé”®å€¼å­˜å‚¨ã€‚</p>
<p>Flink æ”¯æŒå‡ ç§ä¸åŒæ–¹å¼çš„ keyed stateï¼Œè¿™ä¸ªä¾‹å­ä½¿ç”¨çš„æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªï¼Œå«åš <code>ValueState</code>ã€‚æ„æ€æ˜¯å¯¹äº <em>æ¯ä¸ªé”®</em> ï¼ŒFlink å°†å­˜å‚¨ä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ â€”â€” åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­˜å‚¨çš„æ˜¯ä¸€ä¸ª <code>Boolean</code> ç±»å‹çš„å¯¹è±¡ã€‚</p>
<p>æˆ‘ä»¬çš„ <code>Deduplicator</code> ç±»æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>open()</code> å’Œ <code>flatMap()</code>ã€‚<code>open()</code> æ–¹æ³•é€šè¿‡å®šä¹‰ <code>ValueStateDescriptor&lt;Boolean&gt;</code> å»ºç«‹äº†ç®¡ç†çŠ¶æ€çš„ä½¿ç”¨ã€‚æ„é€ å™¨çš„å‚æ•°å®šä¹‰äº†è¿™ä¸ªçŠ¶æ€çš„åå­—ï¼ˆâ€œkeyHasBeenSeenâ€ï¼‰ï¼Œå¹¶ä¸”ä¸ºå¦‚ä½•åºåˆ—åŒ–è¿™äº›å¯¹è±¡æä¾›äº†ä¿¡æ¯ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­çš„ <code>Types.BOOLEAN</code>ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deduplicator</span> <span class="keyword">extends</span> <span class="title class_">RichFlatMapFunction</span>&lt;Event, Event&gt; &#123;</span><br><span class="line">    ValueState&lt;Boolean&gt; keyHasBeenSeen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line">        ValueStateDescriptor&lt;Boolean&gt; desc = <span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;keyHasBeenSeen&quot;</span>, Types.BOOLEAN);</span><br><span class="line">        keyHasBeenSeen = getRuntimeContext().getState(desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(Event event, Collector&lt;Event&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (keyHasBeenSeen.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">            out.collect(event);</span><br><span class="line">            keyHasBeenSeen.update(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ flatMap æ–¹æ³•è°ƒç”¨ <code>keyHasBeenSeen.value()</code> æ—¶ï¼ŒFlink ä¼šåœ¨ <em>å½“å‰é”®çš„ä¸Šä¸‹æ–‡</em> ä¸­æ£€ç´¢çŠ¶æ€å€¼ï¼Œåªæœ‰å½“çŠ¶æ€ä¸º <code>null</code> æ—¶ï¼Œæ‰ä¼šè¾“å‡ºå½“å‰äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåŒæ—¶ä¹Ÿå°†æ›´æ–° <code>keyHasBeenSeen</code> ä¸º <code>true</code>ã€‚</p>
<p>è¿™ç§è®¿é—®å’Œæ›´æ–°æŒ‰é”®åˆ†åŒºçš„çŠ¶æ€çš„æœºåˆ¶ä¹Ÿè®¸çœ‹ä¸Šå»å¾ˆç¥å¥‡ï¼Œå› ä¸ºåœ¨ <code>Deduplicator</code> çš„å®ç°ä¸­ï¼Œé”®ä¸æ˜¯æ˜ç¡®å¯è§çš„ã€‚å½“ Flink è¿è¡Œæ—¶è°ƒç”¨ <code>RichFlatMapFunction</code> çš„ <code>open</code> æ–¹æ³•æ—¶ï¼Œ æ˜¯æ²¡æœ‰äº‹ä»¶çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸Šä¸‹æ–‡ä¸­ä¸å«æœ‰ä»»ä½•é”®ã€‚ä½†å½“å®ƒè°ƒç”¨ <code>flatMap</code> æ–¹æ³•ï¼Œè¢«å¤„ç†çš„äº‹ä»¶çš„é”®åœ¨è¿è¡Œæ—¶ä¸­å°±æ˜¯å¯ç”¨çš„äº†ï¼Œå¹¶ä¸”è¢«ç”¨æ¥ç¡®å®šæ“ä½œå“ªä¸ª Flink çŠ¶æ€åç«¯çš„å…¥å£ã€‚</p>
<p>éƒ¨ç½²åœ¨åˆ†å¸ƒå¼é›†ç¾¤æ—¶ï¼Œå°†ä¼šæœ‰å¾ˆå¤š <code>Deduplicator</code> çš„å®ä¾‹ï¼Œæ¯ä¸€ä¸ªå®ä¾‹å°†è´Ÿè´£æ•´ä¸ªé”®ç©ºé—´çš„äº’æ–¥å­é›†ä¸­çš„ä¸€ä¸ªã€‚æ‰€ä»¥ï¼Œå½“ä½ çœ‹åˆ°ä¸€ä¸ªå•ç‹¬çš„ <code>ValueState</code>ï¼Œæ¯”å¦‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValueState&lt;Boolean&gt; keyHasBeenSeen;</span><br></pre></td></tr></table></figure>

<p>è¦ç†è§£è¿™ä¸ªä»£è¡¨çš„ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå•ç‹¬çš„å¸ƒå°”ç±»å‹å˜é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„å…±äº«é”®å€¼å­˜å‚¨ã€‚</p>
<h3 id="æ¸…ç†çŠ¶æ€"><a href="#æ¸…ç†çŠ¶æ€" class="headerlink" title="æ¸…ç†çŠ¶æ€"></a>æ¸…ç†çŠ¶æ€</h3><p>ä¸Šé¢ä¾‹å­æœ‰ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼šå½“é”®ç©ºé—´æ˜¯æ— ç•Œçš„æ—¶å€™å°†å‘ç”Ÿä»€ä¹ˆï¼ŸFlink ä¼šå¯¹æ¯ä¸ªä½¿ç”¨è¿‡çš„é”®éƒ½å­˜å‚¨ä¸€ä¸ª <code>Boolean</code> ç±»å‹çš„å®ä¾‹ã€‚å¦‚æœæ˜¯é”®æ˜¯æœ‰é™çš„é›†åˆè¿˜å¥½ï¼Œä½†åœ¨é”®æ— é™å¢é•¿çš„åº”ç”¨ä¸­ï¼Œæ¸…é™¤å†ä¹Ÿä¸ä¼šä½¿ç”¨çš„çŠ¶æ€æ˜¯å¾ˆå¿…è¦çš„ã€‚è¿™é€šè¿‡åœ¨çŠ¶æ€å¯¹è±¡ä¸Šè°ƒç”¨ <code>clear()</code> æ¥å®ç°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyHasBeenSeen.clear()</span><br></pre></td></tr></table></figure>

<p>å¯¹ä¸€ä¸ªç»™å®šçš„é”®å€¼ï¼Œä½ ä¹Ÿè®¸æƒ³åœ¨å®ƒä¸€æ®µæ—¶é—´ä¸ä½¿ç”¨åæ¥åšè¿™ä»¶äº‹ã€‚å½“å­¦ä¹  <code>ProcessFunction</code> çš„ç›¸å…³ç« èŠ‚æ—¶ï¼Œä½ å°†çœ‹åˆ°åœ¨äº‹ä»¶é©±åŠ¨çš„åº”ç”¨ä¸­æ€ä¹ˆç”¨å®šæ—¶å™¨æ¥åšè¿™ä¸ªã€‚</p>
<p>ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/state/#state-time-to-live-ttl">çŠ¶æ€çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰</a>ï¼Œä¸ºçŠ¶æ€æè¿°ç¬¦é…ç½®ä½ æƒ³è¦æ—§çŠ¶æ€è‡ªåŠ¨è¢«æ¸…é™¤çš„æ—¶é—´ã€‚</p>
<h3 id="Non-keyed-State"><a href="#Non-keyed-State" class="headerlink" title="Non-keyed State"></a>Non-keyed State</h3><p>åœ¨æ²¡æœ‰é”®çš„ä¸Šä¸‹æ–‡ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ Flink ç®¡ç†çš„çŠ¶æ€ã€‚è¿™ä¹Ÿè¢«ç§°ä½œ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/state/#operator-state">ç®—å­çš„çŠ¶æ€</a>ã€‚å®ƒåŒ…å«çš„æ¥å£æ˜¯å¾ˆä¸ä¸€æ ·çš„ï¼Œç”±äºå¯¹ç”¨æˆ·å®šä¹‰çš„å‡½æ•°æ¥è¯´ä½¿ç”¨ non-keyed state æ˜¯ä¸å¤ªå¸¸è§çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚è¿™ä¸ªç‰¹æ€§æœ€å¸¸ç”¨äº source å’Œ sink çš„å®ç°ã€‚</p>
<h2 id="Connected-Streams"><a href="#Connected-Streams" class="headerlink" title="Connected Streams"></a>Connected Streams</h2><p>ç›¸æ¯”äºä¸‹é¢è¿™ç§é¢„å…ˆå®šä¹‰çš„è½¬æ¢ï¼š</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/transformation.svg" alt="simple transformation"></p>
<p>æœ‰æ—¶ä½ æƒ³è¦æ›´çµæ´»åœ°è°ƒæ•´è½¬æ¢çš„æŸäº›åŠŸèƒ½ï¼Œæ¯”å¦‚æ•°æ®æµçš„é˜ˆå€¼ã€è§„åˆ™æˆ–è€…å…¶ä»–å‚æ•°ã€‚Flink æ”¯æŒè¿™ç§éœ€æ±‚çš„æ¨¡å¼ç§°ä¸º <em>connected streams</em> ï¼Œä¸€ä¸ªå•ç‹¬çš„ç®—å­æœ‰ä¸¤ä¸ªè¾“å…¥æµã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/connected-streams.svg" alt="connected streams"></p>
<p>connected stream ä¹Ÿå¯ä»¥è¢«ç”¨æ¥å®ç°æµçš„å…³è”ã€‚</p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ªæ§åˆ¶æµæ˜¯ç”¨æ¥æŒ‡å®šå“ªäº›è¯éœ€è¦ä» <code>streamOfWords</code> é‡Œè¿‡æ»¤æ‰çš„ã€‚ ä¸€ä¸ªç§°ä¸º <code>ControlFunction</code> çš„ <code>RichCoFlatMapFunction</code> ä½œç”¨äºè¿æ¥çš„æµæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    DataStream&lt;String&gt; control = env</span><br><span class="line">        .fromElements(<span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;IGNORE&quot;</span>)</span><br><span class="line">        .keyBy(x -&gt; x);</span><br><span class="line"></span><br><span class="line">    DataStream&lt;String&gt; streamOfWords = env</span><br><span class="line">        .fromElements(<span class="string">&quot;Apache&quot;</span>, <span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;Flink&quot;</span>, <span class="string">&quot;IGNORE&quot;</span>)</span><br><span class="line">        .keyBy(x -&gt; x);</span><br><span class="line"></span><br><span class="line">    control</span><br><span class="line">        .connect(streamOfWords)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> <span class="title class_">ControlFunction</span>())</span><br><span class="line">        .print();</span><br><span class="line"></span><br><span class="line">    env.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ³¨æ„ä¸¤ä¸ªæµåªæœ‰é”®ä¸€è‡´çš„æ—¶å€™æ‰èƒ½è¿æ¥ã€‚ <code>keyBy</code> çš„ä½œç”¨æ˜¯å°†æµæ•°æ®åˆ†åŒºï¼Œå½“ keyed stream è¢«è¿æ¥æ—¶ï¼Œä»–ä»¬å¿…é¡»æŒ‰ç›¸åŒçš„æ–¹å¼åˆ†åŒºã€‚è¿™æ ·ä¿è¯äº†ä¸¤ä¸ªæµä¸­æ‰€æœ‰é”®ç›¸åŒçš„äº‹ä»¶å‘åˆ°åŒä¸€ä¸ªå®ä¾‹ä¸Šã€‚è¿™æ ·ä¹Ÿä½¿æŒ‰é”®å…³è”ä¸¤ä¸ªæµæˆä¸ºå¯èƒ½ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªæµéƒ½æ˜¯ <code>DataStream&lt;String&gt;</code> ç±»å‹çš„ï¼Œå¹¶ä¸”éƒ½å°†å­—ç¬¦ä¸²ä½œä¸ºé”®ã€‚æ­£å¦‚ä½ å°†åœ¨ä¸‹é¢çœ‹åˆ°çš„ï¼Œ<code>RichCoFlatMapFunction</code> åœ¨çŠ¶æ€ä¸­å­˜äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡è¢«ä¸¤ä¸ªæµå…±äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ControlFunction</span> <span class="keyword">extends</span> <span class="title class_">RichCoFlatMapFunction</span>&lt;String, String, String&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> ValueState&lt;Boolean&gt; blocked;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration config)</span> &#123;</span><br><span class="line">        blocked = getRuntimeContext()</span><br><span class="line">            .getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;blocked&quot;</span>, Boolean.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap1</span><span class="params">(String control_value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        blocked.update(Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap2</span><span class="params">(String data_value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (blocked.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">            out.collect(data_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RichCoFlatMapFunction</code> æ˜¯ä¸€ç§å¯ä»¥è¢«ç”¨äºä¸€å¯¹è¿æ¥æµçš„ <code>FlatMapFunction</code>ï¼Œå¹¶ä¸”å®ƒå¯ä»¥è°ƒç”¨ rich function çš„æ¥å£ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€‚</p>
<p>å¸ƒå°”å˜é‡ <code>blocked</code> è¢«ç”¨äºè®°å½•åœ¨æ•°æ®æµ <code>control</code> ä¸­å‡ºç°è¿‡çš„é”®ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯å•è¯ï¼‰ï¼Œå¹¶ä¸”è¿™äº›å•è¯ä» <code>streamOfWords</code> è¿‡æ»¤æ‰ã€‚è¿™æ˜¯ <em>keyed</em> stateï¼Œå¹¶ä¸”å®ƒæ˜¯è¢«ä¸¤ä¸ªæµå…±äº«çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ªæµå¿…é¡»æœ‰ç›¸åŒçš„é”®å€¼ç©ºé—´ã€‚</p>
<p>åœ¨ Flink è¿è¡Œæ—¶ä¸­ï¼Œ<code>flatMap1</code> å’Œ <code>flatMap2</code> åœ¨è¿æ¥æµæœ‰æ–°å…ƒç´ åˆ°æ¥æ—¶è¢«è°ƒç”¨ â€”â€” åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ<code>control</code> æµä¸­çš„å…ƒç´ ä¼šè¿›å…¥ <code>flatMap1</code>ï¼Œ<code>streamOfWords</code> ä¸­çš„å…ƒç´ ä¼šè¿›å…¥ <code>flatMap2</code>ã€‚è¿™æ˜¯ç”±ä¸¤ä¸ªæµè¿æ¥çš„é¡ºåºå†³å®šçš„ï¼Œæœ¬ä¾‹ä¸­ä¸º <code>control.connect(streamOfWords)</code>ã€‚</p>
<p>è®¤è¯†åˆ°ä½ æ²¡æ³•æ§åˆ¶ <code>flatMap1</code> å’Œ <code>flatMap2</code> çš„è°ƒç”¨é¡ºåºæ˜¯å¾ˆé‡è¦çš„ã€‚è¿™ä¸¤ä¸ªè¾“å…¥æµæ˜¯ç›¸äº’ç«äº‰çš„å…³ç³»ï¼ŒFlink è¿è¡Œæ—¶å°†æ ¹æ®ä»ä¸€ä¸ªæµæˆ–å¦ä¸€ä¸ªæµä¸­æ¶ˆè´¹çš„äº‹ä»¶åšå®ƒè¦åšçš„ã€‚å¯¹äºéœ€è¦ä¿è¯æ—¶é—´å’Œ&#x2F;æˆ–é¡ºåºçš„åœºæ™¯ï¼Œä½ ä¼šå‘ç°åœ¨ Flink çš„ç®¡ç†çŠ¶æ€ä¸­ç¼“å­˜äº‹ä»¶ä¸€ç›´åˆ°å®ƒä»¬èƒ½å¤Ÿè¢«å¤„ç†æ˜¯å¿…é¡»çš„ã€‚ï¼ˆæ³¨æ„ï¼šå¦‚æœä½ çœŸçš„æ„Ÿåˆ°ç»æœ›ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ç®—å­å®ç° <code>InputSelectable</code> æ¥å£ï¼Œåœ¨ä¸¤è¾“å…¥ç®—å­æ¶ˆè´¹å®ƒçš„è¾“å…¥æµæ—¶å¢åŠ ä¸€äº›é¡ºåºä¸Šçš„é™åˆ¶ã€‚ï¼‰</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink å®˜æ–¹æ–‡æ¡£</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/47/">47</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 â€“ 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">æç‹—è›‹</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">3.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">53:28</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/yiyirushi/" class="github-corner" title="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" aria-label="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: 'ğŸŒ“',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
