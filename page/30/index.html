<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.ligoudan.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="天气不错哇，你看这大冰雹下得">
<meta property="og:type" content="website">
<meta property="og:title" content="LIGOUDAN">
<meta property="og:url" content="https://www.ligoudan.cn/page/30/index.html">
<meta property="og:site_name" content="LIGOUDAN">
<meta property="og:description" content="天气不错哇，你看这大冰雹下得">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="李狗蛋">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.ligoudan.cn/page/30/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/30/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LIGOUDAN</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LIGOUDAN</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">好好学习，天天向上</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">326</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">137</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">461</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="李狗蛋"
      src="/uploads/ligoudan.png">
  <p class="site-author-name" itemprop="name">李狗蛋</p>
  <div class="site-description" itemprop="description">天气不错哇，你看这大冰雹下得</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">461</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">137</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">326</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yiyirushi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yiyirushi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yuanhaohoo@163.com" title="E-Mail → mailto:yuanhaohoo@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/8cc787/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/8cc787/" class="post-title-link" itemprop="url">JavaWeb 之 Jsp 指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-07 23:04:47" itemprop="dateCreated datePublished" datetime="2020-02-07T23:04:47+08:00">2020-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaEE/JavaWeb/" itemprop="url" rel="index"><span itemprop="name">JavaWeb</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaWeb-之-Jsp-指南"><a href="#JavaWeb-之-Jsp-指南" class="headerlink" title="JavaWeb 之 Jsp 指南"></a>JavaWeb 之 Jsp 指南</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="什么是-Java-Server-Pages"><a href="#什么是-Java-Server-Pages" class="headerlink" title="什么是 Java Server Pages"></a>什么是 Java Server Pages</h3><p><code>JSP</code>全称<code>Java Server Pages</code>，是一种动态网页开发技术。</p>
<p>它使用 JSP 标签在 HTML 网页中插入 Java 代码。标签通常以 <code>&lt;%</code> 开头以 <code>%&gt;</code> 结束。</p>
<p>JSP 是一种 Java servlet，主要用于实现 Java web 应用程序的用户界面部分。网页开发者们通过结合 HTML 代码、XHTML 代码、XML 元素以及嵌入 JSP 操作和命令来编写 JSP。</p>
<p>JSP 通过网页表单获取用户输入数据、访问数据库及其他数据源，然后动态地创建网页。</p>
<p>JSP 标签有多种功能，比如访问数据库、记录用户选择信息、访问 JavaBeans 组件等，还可以在不同的网页中传递控制信息和共享信息。</p>
<h3 id="为什么使用-JSP"><a href="#为什么使用-JSP" class="headerlink" title="为什么使用 JSP"></a>为什么使用 JSP</h3><p>JSP 也是一种 Servlet，因此 JSP 能够完成 Servlet 能完成的任何工作。</p>
<p>JSP 程序与 CGI 程序有着相似的功能，但和 CGI 程序相比，JSP 程序有如下优势：</p>
<ul>
<li>性能更加优越，因为 JSP 可以直接在 HTML 网页中动态嵌入元素而不需要单独引用 CGI 文件。</li>
<li>服务器调用的是已经编译好的 JSP 文件，而不像 CGI&#x2F;Perl 那样必须先载入解释器和目标脚本。</li>
<li>JSP 基于 Java Servlets API，因此，JSP 拥有各种强大的企业级 Java API，包括 JDBC，JNDI，EJB，JAXP 等等。</li>
<li>JSP 页面可以与处理业务逻辑的 servlets 一起使用，这种模式被 Java servlet 模板引擎所支持。</li>
</ul>
<p>最后，JSP 是 Java EE 不可或缺的一部分，是一个完整的企业级应用平台。这意味着 JSP 可以用最简单的方式来实现最复杂的应用。</p>
<h3 id="JSP-的优势"><a href="#JSP-的优势" class="headerlink" title="JSP 的优势"></a>JSP 的优势</h3><p>以下列出了使用 JSP 带来的其他好处：</p>
<ul>
<li>与 ASP 相比：JSP 有两大优势。首先，动态部分用 Java 编写，而不是 VB 或其他 MS 专用语言，所以更加强大与易用。第二点就是 JSP 易于移植到非 MS 平台上。</li>
<li>与纯 Servlets 相比：JSP 可以很方便的编写或者修改 HTML 网页而不用去面对大量的 println 语句。</li>
<li>与 SSI 相比：SSI 无法使用表单数据、无法进行数据库链接。</li>
<li>与 JavaScript 相比：虽然 JavaScript 可以在客户端动态生成 HTML，但是很难与服务器交互，因此不能提供复杂的服务，比如访问数据库和图像处理等等。</li>
<li>与静态 HTML 相比：静态 HTML 不包含动态信息。</li>
</ul>
<h2 id="JSP-工作原理"><a href="#JSP-工作原理" class="headerlink" title="JSP 工作原理"></a>JSP 工作原理</h2><p><strong>JSP 是一种 Servlet</strong>，但工作方式和 Servlet 有所差别。</p>
<p>Servlet 是先将源代码编译为 class 文件后部署到服务器下的，<strong>先编译后部署</strong>。</p>
<p>Jsp 是先将源代码部署到服务器再编译，<strong>先部署后编译</strong>。</p>
<p>Jsp 会在客户端第一次请求 Jsp 文件时被编译为 HttpJspPage 类（Servlet 的一个子类）。该类会被服务器临时存放在服务器工作目录里。所以，第一次请求 Jsp 后，访问速度会变快就是这个道理。</p>
<h3 id="JSP-工作流程"><a href="#JSP-工作流程" class="headerlink" title="JSP 工作流程"></a>JSP 工作流程</h3><p>网络服务器需要一个 JSP 引擎，也就是一个容器来处理 JSP 页面。容器负责截获对 JSP 页面的请求。本教程使用内嵌 JSP 容器的 Apache 来支持 JSP 开发。</p>
<p>JSP 容器与 Web 服务器协同合作，为 JSP 的正常运行提供必要的运行环境和其他服务，并且能够正确识别专属于 JSP 网页的特殊元素。</p>
<p>下图显示了 JSP 容器和 JSP 文件在 Web 应用中所处的位置。</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/jsp-arch.jpg" alt="img"></p>
<h4 id="工作步骤"><a href="#工作步骤" class="headerlink" title="工作步骤"></a>工作步骤</h4><p>以下步骤表明了 Web 服务器是如何使用 JSP 来创建网页的：</p>
<ul>
<li>就像其他普通的网页一样，您的浏览器发送一个 HTTP 请求给服务器。</li>
<li>Web 服务器识别出这是一个对 JSP 网页的请求，并且将该请求传递给 JSP 引擎。通过使用 URL 或者.jsp 文件来完成。</li>
<li>JSP 引擎从磁盘中载入 JSP 文件，然后将它们转化为 servlet。这种转化只是简单地将所有模板文本改用 println()语句，并且将所有的 JSP 元素转化成 Java 代码。</li>
<li>JSP 引擎将 servlet 编译成可执行类，并且将原始请求传递给 servlet 引擎。</li>
<li>Web 服务器的某组件将会调用 servlet 引擎，然后载入并执行 servlet 类。在执行过程中，servlet 产生 HTML 格式的输出并将其内嵌于 HTTP response 中上交给 Web 服务器。</li>
<li>Web 服务器以静态 HTML 网页的形式将 HTTP response 返回到您的浏览器中。</li>
<li>最终，Web 浏览器处理 HTTP response 中动态产生的 HTML 网页，就好像在处理静态网页一样。</li>
</ul>
<p>以上提及到的步骤可以用下图来表示：</p>
<p>一般情况下，JSP 引擎会检查 JSP 文件对应的 servlet 是否已经存在，并且检查 JSP 文件的修改日期是否早于 servlet。如果 JSP 文件的修改日期早于对应的 servlet，那么容器就可以确定 JSP 文件没有被修改过并且 servlet 有效。这使得整个流程与其他脚本语言（比如 PHP）相比要高效快捷一些。</p>
<h3 id="JSP-生命周期"><a href="#JSP-生命周期" class="headerlink" title="JSP 生命周期"></a>JSP 生命周期</h3><p>理解 JSP 底层功能的关键就是去理解它们所遵守的生命周期。</p>
<p>JSP 生命周期就是从创建到销毁的整个过程，类似于 servlet 生命周期，区别在于 JSP 生命周期还包括将 JSP 文件编译成 servlet。</p>
<p>以下是 JSP 生命周期中所走过的几个阶段：</p>
<ul>
<li><strong>编译阶段：</strong>servlet 容器编译 servlet 源文件，生成 servlet 类</li>
<li><strong>初始化阶段：</strong>加载与 JSP 对应的 servlet 类，创建其实例，并调用它的初始化方法</li>
<li><strong>执行阶段：</strong>调用与 JSP 对应的 servlet 实例的服务方法</li>
<li><strong>销毁阶段：</strong>调用与 JSP 对应的 servlet 实例的销毁方法，然后销毁 servlet 实例</li>
</ul>
<p>很明显，JSP 生命周期的四个主要阶段和 servlet 生命周期非常相似，下面给出图示：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/jsp_life_cycle.jpg" alt="img"></p>
<h4 id="JSP-编译"><a href="#JSP-编译" class="headerlink" title="JSP 编译"></a>JSP 编译</h4><p>当浏览器请求 JSP 页面时，JSP 引擎会首先去检查是否需要编译这个文件。如果这个文件没有被编译过，或者在上次编译后被更改过，则编译这个 JSP 文件。</p>
<p>编译的过程包括三个步骤：</p>
<ul>
<li>解析 JSP 文件。</li>
<li>将 JSP 文件转为 servlet。</li>
<li>编译 servlet。</li>
</ul>
<h4 id="JSP-初始化"><a href="#JSP-初始化" class="headerlink" title="JSP 初始化"></a>JSP 初始化</h4><p>容器载入 JSP 文件后，它会在为请求提供任何服务前调用 jspInit()方法。如果您需要执行自定义的 JSP 初始化任务，复写 jspInit()方法就行了，就像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jspInit</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">// 初始化代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般来讲程序只初始化一次，servlet 也是如此。通常情况下您可以在 jspInit()方法中初始化数据库连接、打开文件和创建查询表。</p>
<h4 id="JSP-执行"><a href="#JSP-执行" class="headerlink" title="JSP 执行"></a>JSP 执行</h4><p>这一阶段描述了 JSP 生命周期中一切与请求相关的交互行为，直到被销毁。</p>
<p>当 JSP 网页完成初始化后，JSP 引擎将会调用 <code>_jspService()</code> 方法。</p>
<p><code>_jspService()</code> 方法需要一个 HttpServletRequest 对象和一个 HttpServletResponse 对象作为它的参数，就像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">_jspService</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                 HttpServletResponse response)</span> &#123;</span><br><span class="line">   <span class="comment">// 服务端处理代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_jspService()</code> 方法在每个 request 中被调用一次并且负责产生与之相对应的 response，并且它还负责产生所有 7 个 HTTP 方法的回应，比如 GET、POST、DELETE 等等。</p>
<h4 id="JSP-清理"><a href="#JSP-清理" class="headerlink" title="JSP 清理"></a>JSP 清理</h4><p>JSP 生命周期的销毁阶段描述了当一个 JSP 网页从容器中被移除时所发生的一切。</p>
<p>jspDestroy()方法在 JSP 中等价于 servlet 中的销毁方法。当您需要执行任何清理工作时复写 jspDestroy()方法，比如释放数据库连接或者关闭文件夹等等。</p>
<p>jspDestroy()方法的格式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jspDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// 清理代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>脚本程序可以包含任意量的 Java 语句、变量、方法或表达式，只要它们在脚本语言中是有效的。</p>
<p>脚本程序的语法格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span> 代码片段 <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>或者，您也可以编写与其等价的 XML 语句，就像下面这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:scriptlet</span>&gt;</span></span><br><span class="line">  代码片段</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:scriptlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>任何文本、HTML 标签、JSP 元素必须写在脚本程序的外面。</p>
<p>下面给出一个示例，同时也是本教程的第一个 JSP 示例：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    Hello World!<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="language-vbscript">&lt;% out.println(<span class="string">&quot;Your IP address is &quot;</span> + <span class="built_in">request</span>.getRemoteAddr()); %&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>请确保 Apache Tomcat 已经安装在 C:\apache-tomcat-7.0.2 目录下并且运行环境已经正确设置。</p>
<p>将以上代码保存在 hello.jsp 中，然后将它放置在 C:\apache-tomcat-7.0.2\webapps\ROOT 目录下，打开浏览器并在地址栏中输入 <code>http://localhost:8080/hello.jsp</code> 。运行后得到以下结果：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/jsp_hello_world.jpg" alt="img"></p>
<h4 id="中文编码问题"><a href="#中文编码问题" class="headerlink" title="中文编码问题"></a>中文编码问题</h4><p>如果我们要在页面正常显示中文，我们需要在 JSP 文件头部添加以下代码：<code>&lt;&gt;</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@<span class="built_in"> page </span><span class="attribute">language</span>=<span class="string">&quot;java&quot;</span> <span class="attribute">contentType</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line"><span class="attribute">pageEncoding</span>=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br></pre></td></tr></table></figure>

<p>接下来我们将以上程序修改为：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-vbscript">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-vbscript">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    Hello World!<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="language-vbscript">&lt;% out.println(<span class="string">&quot;你的 IP 地址 &quot;</span> + <span class="built_in">request</span>.getRemoteAddr()); %&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这样中文就可以正常显示了。</p>
<h3 id="JSP-声明"><a href="#JSP-声明" class="headerlink" title="JSP 声明"></a>JSP 声明</h3><p>一个声明语句可以声明一个或多个变量、方法，供后面的 Java 代码使用。在 JSP 文件中，您必须先声明这些变量和方法然后才能使用它们。</p>
<p>JSP 声明的语法格式：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! declaration; [ declaration; ]+ ... %&gt;</span><br></pre></td></tr></table></figure>

<p>或者，您也可以编写与其等价的 XML 语句，就像下面这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:declaration</span>&gt;</span></span><br><span class="line">  代码片段</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:declaration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>程序示例：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! <span class="keyword">int</span> i = <span class="number">0</span>; %&gt; &lt;%! <span class="keyword">int</span> a, b, c; %&gt; &lt;%! Circle a = new Circle(<span class="number">2.0</span>); %&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JSP-表达式"><a href="#JSP-表达式" class="headerlink" title="JSP 表达式"></a>JSP 表达式</h3><p>一个 JSP 表达式中包含的脚本语言表达式，先被转化成 String，然后插入到表达式出现的地方。</p>
<p>由于表达式的值会被转化成 String，所以您可以在一个文本行中使用表达式而不用去管它是否是 HTML 标签。</p>
<p>表达式元素中可以包含任何符合 Java 语言规范的表达式，但是不能使用分号来结束表达式。</p>
<p>JSP 表达式的语法格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>= 表达式 <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>同样，您也可以编写与之等价的 XML 语句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:expression</span>&gt;</span></span><br><span class="line">  表达式</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:expression</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>程序示例：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-vbscript">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-vbscript">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      今天的日期是: </span><span class="language-vbscript">&lt;%= (<span class="keyword">new</span> java.util.<span class="built_in">Date</span>()).toLocale<span class="built_in">String</span>()%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行后得到以下结果：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">今天的日期是: 2016<span class="string">-6</span><span class="string">-25</span> 13:40:07</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="JSP-注释"><a href="#JSP-注释" class="headerlink" title="JSP 注释"></a>JSP 注释</h3><p>JSP 注释主要有两个作用：为代码作注释以及将某段代码注释掉。</p>
<p>JSP 注释的语法格式：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-vbscript">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-vbscript">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JSP注释示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="language-vbscript">&lt;%-- 该部分注释在网页中不会被显示--%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      今天的日期是: </span><span class="language-vbscript">&lt;%= (<span class="keyword">new</span> java.util.<span class="built_in">Date</span>()).toLocale<span class="built_in">String</span>()%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行后得到以下结果：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">今天的日期是: 2016<span class="string">-6</span><span class="string">-25</span> 13:41:26</span><br></pre></td></tr></table></figure>

<p>不同情况下使用注释的语法规则：</p>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;%-- 注释 --%&gt;</code></td>
<td>JSP 注释，注释内容不会被发送至浏览器甚至不会被编译</td>
</tr>
<tr>
<td><code>&lt;!-- 注释 --&gt;</code></td>
<td>HTML 注释，通过浏览器查看网页源代码时可以看见注释内容</td>
</tr>
<tr>
<td><code>&lt;%</code></td>
<td>代表静态 <code>&lt;%</code> 常量</td>
</tr>
<tr>
<td><code>%&gt;</code></td>
<td>代表静态 <code>%&gt;</code> 常量</td>
</tr>
<tr>
<td><code>&#39;</code></td>
<td>在属性中使用的单引号</td>
</tr>
<tr>
<td><code>&quot;</code></td>
<td>在属性中使用的双引号</td>
</tr>
</tbody></table>
<h3 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h3><p>JSP 提供对 Java 语言的全面支持。您可以在 JSP 程序中使用 Java API 甚至建立 Java 代码块，包括判断语句和循环语句等等。</p>
<h4 id="if…else-语句"><a href="#if…else-语句" class="headerlink" title="if…else 语句"></a>if…else 语句</h4><p><code>If…else</code>块，请看下面这个例子：</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-perl">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-perl">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt; &lt;%</span><span class="language-perl">! <span class="keyword">int</span> day = <span class="number">1</span>; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>02.JSP语法 - if...else示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>IF...ELSE 实例<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl"> <span class="keyword">if</span> (day == <span class="number">1</span> | day == <span class="number">7</span>) &#123; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>今天是周末<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl"> &#125; <span class="keyword">else</span> &#123; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>今天不是周末<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl"> &#125; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行后得到以下结果：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">IF</span></span>...<span class="keyword">ELSE</span> 实例</span><br><span class="line">今天不是周末</span><br></pre></td></tr></table></figure>

<h4 id="switch…case-语句"><a href="#switch…case-语句" class="headerlink" title="switch…case 语句"></a>switch…case 语句</h4><p>现在来看看 switch…case 块，与 if…else 块有很大的不同，它使用 out.println()，并且整个都装在脚本程序的标签中，就像下面这样：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-ruby">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt; &lt;%</span><span class="language-ruby">! int day = <span class="number">3</span>; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>02.JSP语法 - switch...case示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Sswitch...case示例<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-ruby"> switch(day) &#123; <span class="keyword">case</span> <span class="number">0</span>: out.println(<span class="string">&quot;星期天&quot;</span>); <span class="keyword">break</span>; <span class="keyword">case</span> <span class="number">1</span>:</span></span><br><span class="line"><span class="language-ruby">    out.println(<span class="string">&quot;星期一&quot;</span>); <span class="keyword">break</span>; <span class="keyword">case</span> <span class="number">2</span>: out.println(<span class="string">&quot;星期二&quot;</span>); <span class="keyword">break</span>; <span class="keyword">case</span> <span class="number">3</span>:</span></span><br><span class="line"><span class="language-ruby">    out.println(<span class="string">&quot;星期三&quot;</span>); <span class="keyword">break</span>; <span class="keyword">case</span> <span class="number">4</span>: out.println(<span class="string">&quot;星期四&quot;</span>); <span class="keyword">break</span>; <span class="keyword">case</span> <span class="number">5</span>:</span></span><br><span class="line"><span class="language-ruby">    out.println(<span class="string">&quot;星期五&quot;</span>); <span class="keyword">break</span>; <span class="symbol">default:</span> out.println(<span class="string">&quot;星期六&quot;</span>); &#125; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>浏览器访问，运行后得出以下结果：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SWITCH</span>...<span class="keyword">CASE</span> 实例</span><br><span class="line"></span><br><span class="line">星期三</span><br></pre></td></tr></table></figure>

<h4 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h4><p>在 JSP 程序中可以使用 Java 的三个基本循环类型：for，while，和 do…while。</p>
<p>让我们来看看 for 循环的例子，以下输出的不同字体大小的”菜鸟教程”：</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-perl">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-perl">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt; &lt;%</span><span class="language-perl">! <span class="keyword">int</span> fontSize; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>For 循环实例<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl"><span class="keyword">for</span> ( fontSize = <span class="number">1</span>; fontSize &lt;= <span class="number">3</span>; fontSize++)&#123; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;green&quot;</span> <span class="attr">size</span>=<span class="string">&quot;&lt;%=</span></span></span><span class="language-perl"> fontSize </span><span class="language-xml"><span class="tag"><span class="string">%&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      菜鸟教程 &lt;/font</span></span><br><span class="line"><span class="language-xml">    &gt;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl">&#125;</span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行后得到以下结果：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/7B4B85CF-FE4B-43CB-AAFF-F8594AD4342C.jpg" alt="img"></p>
<p>将上例改用 while 循环来写：</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-perl">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-perl">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt; &lt;%</span><span class="language-perl">! <span class="keyword">int</span> fontSize; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>While 循环实例<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl"><span class="keyword">while</span> ( fontSize &lt;= <span class="number">3</span>)&#123; </span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;green&quot;</span> <span class="attr">size</span>=<span class="string">&quot;&lt;%=</span></span></span><span class="language-perl"> fontSize </span><span class="language-xml"><span class="tag"><span class="string">%&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      菜鸟教程 &lt;/font</span></span><br><span class="line"><span class="language-xml">    &gt;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%</span><span class="language-perl">fontSize++;</span><span class="language-xml">%&gt; &lt;%</span><span class="language-perl">&#125;</span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>浏览器访问，输出结果为（fontSize 初始化为 0，所以多输出了一行）：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/4F744CC9-E484-45BA-AF18-27AFCF4AD45C.jpg" alt="img"></p>
<p>JSP 运算符</p>
<p>JSP 支持所有 Java 逻辑和算术运算符。</p>
<p>下表罗列出了 JSP 常见运算符，优先级从高到底：</p>
<table>
<thead>
<tr>
<th><strong>类别</strong></th>
<th><strong>操作符</strong></th>
<th><strong>结合性</strong></th>
</tr>
</thead>
<tbody><tr>
<td>后缀</td>
<td><code>() [] .</code> (点运算符)</td>
<td>左到右</td>
</tr>
<tr>
<td>一元</td>
<td><code>++ - - ! ~</code></td>
<td>右到左</td>
</tr>
<tr>
<td>可乘性</td>
<td><code>* / %</code></td>
<td>左到右</td>
</tr>
<tr>
<td>可加性</td>
<td><code>+ -</code></td>
<td>左到右</td>
</tr>
<tr>
<td>移位</td>
<td><code>&gt;&gt; &gt;&gt;&gt; &lt;&lt;</code></td>
<td>左到右</td>
</tr>
<tr>
<td>关系</td>
<td><code>&gt; &gt;= &lt; &lt;=</code></td>
<td>左到右</td>
</tr>
<tr>
<td>相等&#x2F;不等</td>
<td><code>== !=</code></td>
<td>左到右</td>
</tr>
<tr>
<td>位与</td>
<td><code>&amp;</code></td>
<td>左到右</td>
</tr>
<tr>
<td>位异或</td>
<td><code>^</code></td>
<td>左到右</td>
</tr>
<tr>
<td>位或</td>
<td>&#96;</td>
<td>&#96;</td>
</tr>
<tr>
<td>逻辑与</td>
<td><code>&amp;&amp;</code></td>
<td>左到右</td>
</tr>
<tr>
<td>逻辑或</td>
<td>&#96;</td>
<td></td>
</tr>
<tr>
<td>条件判断</td>
<td><code>?:</code></td>
<td>右到左</td>
</tr>
<tr>
<td>赋值</td>
<td>&#96;&#x3D; +&#x3D; -&#x3D; *&#x3D; &#x2F;&#x3D; %&#x3D; &gt;&gt;&#x3D; &lt;&lt;&#x3D; &amp;&#x3D; ^&#x3D;</td>
<td>&#x3D;&#96;</td>
</tr>
<tr>
<td>逗号</td>
<td><code>,</code></td>
<td>左到右</td>
</tr>
</tbody></table>
<h3 id="JSP-字面量"><a href="#JSP-字面量" class="headerlink" title="JSP 字面量"></a>JSP 字面量</h3><p>JSP 语言定义了以下几个字面量：</p>
<ul>
<li>布尔值(boolean)：true 和 false;</li>
<li>整型(int)：与 Java 中的一样;</li>
<li>浮点型(float)：与 Java 中的一样;</li>
<li>字符串(string)：以单引号或双引号开始和结束;</li>
<li>Null：null。</li>
</ul>
<h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><p>JSP 指令用来设置整个 JSP 页面相关的属性，如网页的编码方式和脚本语言。</p>
<p>JSP 指令以开<code>&lt;%@</code>开始，以<code>%&gt;</code>结束。</p>
<p>JSP 指令语法格式如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ directive attribute=<span class="string">&quot;value&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>指令可以有很多个属性，它们以键值对的形式存在，并用逗号隔开。</p>
<p>JSP 中的三种指令标签：</p>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;%@ page ... %&gt;</code></td>
<td>定义网页依赖属性，比如脚本语言、error 页面、缓存需求等等</td>
</tr>
<tr>
<td><code>&lt;%@ include ... %&gt;</code></td>
<td>包含其他文件</td>
</tr>
<tr>
<td><code>&lt;%@ taglib ... %&gt;</code></td>
<td>引入标签库的定义，可以是自定义标签</td>
</tr>
</tbody></table>
<h3 id="Page-指令"><a href="#Page-指令" class="headerlink" title="Page 指令"></a>Page 指令</h3><p>Page 指令为容器提供当前页面的使用说明。一个 JSP 页面可以包含多个<code>page</code>指令。</p>
<p>Page 指令的语法格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ page attribute=<span class="string">&quot;value&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>等价的 XML 格式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:directive.page</span> <span class="attr">attribute</span>=<span class="string">&quot;value&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@<span class="built_in"> page </span><span class="attribute">language</span>=<span class="string">&quot;java&quot;</span> <span class="attribute">contentType</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line"><span class="attribute">pageEncoding</span>=<span class="string">&quot;UTF-8&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>下表列出与 Page 指令相关的属性：</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>buffer</td>
<td>指定 out 对象使用缓冲区的大小</td>
</tr>
<tr>
<td>autoFlush</td>
<td>控制 out 对象的 缓存区</td>
</tr>
<tr>
<td>contentType</td>
<td>指定当前 JSP 页面的 MIME 类型和字符编码</td>
</tr>
<tr>
<td>errorPage</td>
<td>指定当 JSP 页面发生异常时需要转向的错误处理页面</td>
</tr>
<tr>
<td>isErrorPage</td>
<td>指定当前页面是否可以作为另一个 JSP 页面的错误处理页面</td>
</tr>
<tr>
<td>extends</td>
<td>指定 servlet 从哪一个类继承</td>
</tr>
<tr>
<td>import</td>
<td>导入要使用的 Java 类</td>
</tr>
<tr>
<td>info</td>
<td>定义 JSP 页面的描述信息</td>
</tr>
<tr>
<td>isThreadSafe</td>
<td>指定对 JSP 页面的访问是否为线程安全</td>
</tr>
<tr>
<td>language</td>
<td>定义 JSP 页面所用的脚本语言，默认是 Java</td>
</tr>
<tr>
<td>session</td>
<td>指定 JSP 页面是否使用 session</td>
</tr>
<tr>
<td>isELIgnored</td>
<td>指定是否执行 EL 表达式</td>
</tr>
<tr>
<td>isScriptingEnabled</td>
<td>确定脚本元素能否被使用</td>
</tr>
</tbody></table>
<h3 id="Include-指令"><a href="#Include-指令" class="headerlink" title="Include 指令"></a>Include 指令</h3><p>JSP 可以通过<code>include</code>指令来包含其他文件。</p>
<p>被包含的文件可以是 JSP 文件、HTML 文件或文本文件。包含的文件就好像是该 JSP 文件的一部分，会被同时编译执行。</p>
<p>Include 指令的语法格式如下：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ include <span class="keyword">file</span>=<span class="string">&quot;文件相对 url 地址&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>include</strong> 指令中的文件名实际上是一个相对的 URL 地址。</p>
<p>如果您没有给文件关联一个路径，JSP 编译器默认在当前路径下寻找。</p>
<p>等价的 XML 语法：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.<span class="keyword">include</span> <span class="keyword">file</span>=<span class="string">&quot;文件相对 url 地址&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Taglib-指令"><a href="#Taglib-指令" class="headerlink" title="Taglib 指令"></a>Taglib 指令</h3><p>JSP 允许用户自定义标签，一个自定义标签库就是自定义标签的集合。</p>
<p><code>taglib</code>指令引入一个自定义标签集合的定义，包括库路径、自定义标签。</p>
<p><code>taglib</code>指令的语法：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib uri=<span class="string">&quot;uri&quot;</span> prefix=<span class="string">&quot;prefixOfTag&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>uri 属性确定标签库的位置，prefix 属性指定标签库的前缀。</p>
<p>等价的 XML 语法：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.taglib <span class="attribute">uri</span>=<span class="string">&quot;uri&quot;</span> <span class="attribute">prefix</span>=<span class="string">&quot;prefixOfTag&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-动作元素"><a href="#JSP-动作元素" class="headerlink" title="JSP 动作元素"></a>JSP 动作元素</h2><p>JSP 动作元素是一组 JSP 内置的标签，只需要书写很少的标记代码就能使用 JSP 提供的丰富功能。JSP 动作元素是对常用的 JSP 功能的抽象与封装，包括两种，自定义 JSP 动作元素与标准 JSP 动作元素。</p>
<p>与 JSP 指令元素不同的是，JSP 动作元素在请求处理阶段起作用。JSP 动作元素是用 XML 语法写成的。</p>
<p>利用 JSP 动作可以动态地插入文件、重用 JavaBean 组件、把用户重定向到另外的页面、为 Java 插件生成 HTML 代码。</p>
<p>动作元素只有一种语法，它符合 XML 标准：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:action_name</span> <span class="attr">attribute</span>=<span class="string">&quot;value&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>动作元素基本上都是预定义的函数，JSP 规范定义了一系列的标准动作，它用 JSP 作为前缀，可用的标准动作元素如下：</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>jsp:include</td>
<td>在页面被请求的时候引入一个文件。</td>
</tr>
<tr>
<td>jsp:useBean</td>
<td>寻找或者实例化一个 JavaBean。</td>
</tr>
<tr>
<td>jsp:setProperty</td>
<td>设置 JavaBean 的属性。</td>
</tr>
<tr>
<td>jsp:getProperty</td>
<td>输出某个 JavaBean 的属性。</td>
</tr>
<tr>
<td>jsp:forward</td>
<td>把请求转到一个新的页面。</td>
</tr>
<tr>
<td>jsp:plugin</td>
<td>根据浏览器类型为 Java 插件生成 OBJECT 或 EMBED 标记。</td>
</tr>
<tr>
<td>jsp:element</td>
<td>定义动态 XML 元素</td>
</tr>
<tr>
<td>jsp:attribute</td>
<td>设置动态定义的 XML 元素属性。</td>
</tr>
<tr>
<td>jsp:body</td>
<td>设置动态定义的 XML 元素内容。</td>
</tr>
<tr>
<td>jsp:text</td>
<td>在 JSP 页面和文档中使用写入文本的模板</td>
</tr>
</tbody></table>
<h3 id="常见的属性"><a href="#常见的属性" class="headerlink" title="常见的属性"></a>常见的属性</h3><p>所有的动作要素都有两个属性：id 属性和 scope 属性。</p>
<ul>
<li><strong>id 属性：</strong>id 属性是动作元素的唯一标识，可以在 JSP 页面中引用。动作元素创建的 id 值可以通过 PageContext 来调用。</li>
<li><strong>scope 属性：</strong>该属性用于识别动作元素的生命周期。 id 属性和 scope 属性有直接关系，scope 属性定义了相关联 id 对象的寿命。 scope 属性有四个可能的值： (a) page, (b)request, (c)session, 和 (d) application。</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title="&lt;jsp:include&gt;"></a><code>&lt;jsp:include&gt;</code></h3><p><code>&lt;jsp:include&gt;</code> 用来包含静态和动态的文件。该动作把指定文件插入正在生成的页面。</p>
<p>如果被包含的文件为 JSP 程序，则会先执行 JSP 程序，再将执行结果包含进来。</p>
<p>语法格式如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:include <span class="attribute">page</span>=<span class="string">&quot;相对 URL 地址&quot;</span> <span class="attribute">flush</span>=<span class="string">&quot;true&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>前面已经介绍过 include 指令，它是在 JSP 文件被转换成 Servlet 的时候引入文件，而这里的 jsp:include 动作不同，插入文件的时间是在页面被请求的时候。</p>
<p>以下是 include 动作相关的属性列表。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>page</td>
<td>包含在页面中的相对 URL 地址。</td>
</tr>
<tr>
<td>flush</td>
<td>布尔属性，定义在包含资源前是否刷新缓存区。</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>以下我们定义了两个文件 <strong>date.jsp</strong> 和 <strong>main.jsp</strong>，代码如下所示：</p>
<p>date.jsp 文件代码：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-vbscript">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-vbscript">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  今天的日期是: </span><span class="language-vbscript">&lt;%= (<span class="keyword">new</span> java.util.<span class="built_in">Date</span>())%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>main.jsp 文件代码：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-ruby">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>include 动作实例<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:include</span> <span class="attr">page</span>=<span class="string">&quot;date.jsp&quot;</span> <span class="attr">flush</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>现在将以上两个文件放在服务器的根目录下，访问 main.jsp 文件。显示结果如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> 动作实例</span><br><span class="line"></span><br><span class="line"><span class="section">今天的日期是: 2016-6-25 14:08:17</span></span><br></pre></td></tr></table></figure>

<h3 id="-1"><a href="#-1" class="headerlink" title="&lt;jsp:useBean&gt;"></a><code>&lt;jsp:useBean&gt;</code></h3><p><strong>jsp:useBean</strong> 动作用来加载一个将在 JSP 页面中使用的 JavaBean。</p>
<p>这个功能非常有用，因为它使得我们可以发挥 Java 组件复用的优势。</p>
<p>jsp:useBean 动作最简单的语法为：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:useBean <span class="built_in">id</span>=<span class="string">&quot;name&quot;</span> <span class="built_in">class</span>=<span class="string">&quot;package.class&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>在类载入后，我们既可以通过 jsp:setProperty 和 jsp:getProperty 动作来修改和检索 bean 的属性。</p>
<p>以下是 useBean 动作相关的属性列表。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>class</td>
<td>指定 Bean 的完整包名。</td>
</tr>
<tr>
<td>type</td>
<td>指定将引用该对象变量的类型。</td>
</tr>
<tr>
<td>beanName</td>
<td>通过 java.beans.Beans 的 instantiate() 方法指定 Bean 的名字。</td>
</tr>
</tbody></table>
<p>在给出具体实例前，让我们先来看下 jsp:setProperty 和 jsp:getProperty 动作元素：</p>
<h3 id="-2"><a href="#-2" class="headerlink" title="&lt;jsp:setProperty&gt;"></a><code>&lt;jsp:setProperty&gt;</code></h3><p>jsp:setProperty 用来设置已经实例化的 Bean 对象的属性，有两种用法。首先，你可以在 jsp:useBean 元素的外面（后面）使用 jsp:setProperty，如下所示：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp<span class="function">:useBean</span> id=<span class="string">&quot;myName&quot;</span> <span class="string">...</span> /&gt;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">&lt;jsp<span class="function">:setProperty</span> name=<span class="string">&quot;myName&quot;</span> property=<span class="string">&quot;someProperty&quot;</span> <span class="string">.../</span>&gt;</span><br></pre></td></tr></table></figure>

<p>此时，不管 jsp:useBean 是找到了一个现有的 Bean，还是新创建了一个 Bean 实例，jsp:setProperty 都会执行。第二种用法是把 jsp:setProperty 放入 jsp:useBean 元素的内部，如下所示：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp<span class="function">:useBean</span> id=<span class="string">&quot;myName&quot;</span> <span class="string">...</span> &gt;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">   &lt;jsp<span class="function">:setProperty</span> name=<span class="string">&quot;myName&quot;</span> property=<span class="string">&quot;someProperty&quot;</span> <span class="string">.../</span>&gt;</span><br><span class="line">&lt;<span class="string">/jsp</span><span class="function">:useBean</span>&gt;</span><br></pre></td></tr></table></figure>

<p>此时，jsp:setProperty 只有在新建 Bean 实例时才会执行，如果是使用现有实例则不执行 jsp:setProperty。</p>
<p>jsp:setProperty 动作有下面四个属性,如下表：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>name 属性是必需的。它表示要设置属性的是哪个 Bean。</td>
</tr>
<tr>
<td>property</td>
<td>property 属性是必需的。它表示要设置哪个属性。有一个特殊用法：如果 property 的值是”*“，表示所有名字和 Bean 属性名字匹配的请求参数都将被传递给相应的属性 set 方法。</td>
</tr>
<tr>
<td>value</td>
<td>value 属性是可选的。该属性用来指定 Bean 属性的值。字符串数据会在目标类中通过标准的 valueOf 方法自动转换成数字、boolean、Boolean、 byte、Byte、char、Character。例如，boolean 和 Boolean 类型的属性值（比如”true”）通过 Boolean.valueOf 转换，int 和 Integer 类型的属性值（比如”42”）通过 Integer.valueOf 转换。 　　 value 和 param 不能同时使用，但可以使用其中任意一个。</td>
</tr>
<tr>
<td>param</td>
<td>param 是可选的。它指定用哪个请求参数作为 Bean 属性的值。如果当前请求没有参数，则什么事情也不做，系统不会把 null 传递给 Bean 属性的 set 方法。因此，你可以让 Bean 自己提供默认属性值，只有当请求参数明确指定了新值时才修改默认属性值。</td>
</tr>
</tbody></table>
<h3 id="-3"><a href="#-3" class="headerlink" title="&lt;jsp:getProperty&gt;"></a><code>&lt;jsp:getProperty&gt;</code></h3><p>jsp:getProperty 动作提取指定 Bean 属性的值，转换成字符串，然后输出。语法格式如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp<span class="function">:useBean</span> id=<span class="string">&quot;myName&quot;</span> <span class="string">...</span> /&gt;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">&lt;jsp<span class="function">:getProperty</span> name=<span class="string">&quot;myName&quot;</span> property=<span class="string">&quot;someProperty&quot;</span> <span class="string">.../</span>&gt;</span><br></pre></td></tr></table></figure>

<p>下表是与 getProperty 相关联的属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>要检索的 Bean 属性名称。Bean 必须已定义。</td>
</tr>
<tr>
<td>property</td>
<td>表示要提取 Bean 属性的值</td>
</tr>
</tbody></table>
<p>实例</p>
<p>以下实例我们使用了 Bean:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runoob.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;菜鸟教程&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>(message);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.message = message;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译以上实例文件 TestBean.java ：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>javac TestBean.java</span><br></pre></td></tr></table></figure>

<p>编译完成后会在当前目录下生成一个 <strong>TestBean.class</strong> 文件， 将该文件拷贝至当前 JSP 项目的 <strong>WebContent&#x2F;WEB-INF&#x2F;classes&#x2F;com&#x2F;runoob&#x2F;main</strong> 下( com&#x2F;runoob&#x2F;main 包路径，没有需要手动创建)。</p>
<p>下面是一个 Eclipse 中目录结构图：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/6AC33FBA-0B76-4BFD-A690-E856E9E01900.jpg" alt="img"></p>
<p>下面是一个很简单的例子，它的功能是装载一个 Bean，然后设置&#x2F;读取它的 message 属性。</p>
<p>现在让我们在 main.jsp 文件中调用该 Bean:</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-ruby">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Jsp 使用 JavaBean 实例<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:useBean</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.runoob.main.TestBean&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">property</span>=<span class="string">&quot;message&quot;</span> <span class="attr">value</span>=<span class="string">&quot;菜鸟教程...&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>输出信息....<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">property</span>=<span class="string">&quot;message&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>浏览器访问，执行以上文件，输出如下所示：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/D7AD87A8-3392-4D4E-8731-18806B0644CD.jpg" alt="img"></p>
<h3 id="-4"><a href="#-4" class="headerlink" title="&lt;jsp:forward&gt;"></a><code>&lt;jsp:forward&gt;</code></h3><p>jsp:forward 动作把请求转到另外的页面。jsp:forward 标记只有一个属性 page。语法格式如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:forward</span> <span class="attr">page</span>=<span class="string">&quot;相对 URL 地址&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下是 forward 相关联的属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>page</td>
<td>page 属性包含的是一个相对 URL。page 的值既可以直接给出，也可以在请求的时候动态计算，可以是一个 JSP 页面或者一个 Java Servlet.</td>
</tr>
</tbody></table>
<p>实例</p>
<p>以下实例我们使用了两个文件，分别是： date.jsp 和 main.jsp。</p>
<p>date.jsp 文件代码如下：</p>
<figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-vbscript">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-vbscript">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  今天的日期是: </span><span class="language-vbscript">&lt;%= (<span class="keyword">new</span> java.util.<span class="built_in">Date</span>()).toLocale<span class="built_in">String</span>()%&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>main.jsp 文件代码：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-ruby">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>forward 动作实例<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:forward</span> <span class="attr">page</span>=<span class="string">&quot;date.jsp&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>现在将以上两个文件放在服务器的根目录下，访问 main.jsp 文件。显示结果如下：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">今天的日期是: 2016<span class="string">-6</span><span class="string">-25</span> 14:37:25</span><br></pre></td></tr></table></figure>

<h3 id="-5"><a href="#-5" class="headerlink" title="&lt;jsp:plugin&gt;"></a><code>&lt;jsp:plugin&gt;</code></h3><p>jsp:plugin 动作用来根据浏览器的类型，插入通过 Java 插件 运行 Java Applet 所必需的 OBJECT 或 EMBED 元素。</p>
<p>如果需要的插件不存在，它会下载插件，然后执行 Java 组件。 Java 组件可以是一个 applet 或一个 JavaBean。</p>
<p>plugin 动作有多个对应 HTML 元素的属性用于格式化 Java 组件。param 元素可用于向 Applet 或 Bean 传递参数。</p>
<p>以下是使用 plugin 动作元素的典型实例:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:plugin</span> <span class="attr">type</span>=<span class="string">&quot;applet&quot;</span> <span class="attr">codebase</span>=<span class="string">&quot;dirname&quot;</span> <span class="attr">code</span>=<span class="string">&quot;MyApplet.class&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">width</span>=<span class="string">&quot;60&quot;</span> <span class="attr">height</span>=<span class="string">&quot;80&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">jsp:param</span> <span class="attr">name</span>=<span class="string">&quot;fontcolor&quot;</span> <span class="attr">value</span>=<span class="string">&quot;red&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">jsp:param</span> <span class="attr">name</span>=<span class="string">&quot;background&quot;</span> <span class="attr">value</span>=<span class="string">&quot;black&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">jsp:fallback</span>&gt;</span></span><br><span class="line">      Unable to initialize Java Plugin</span><br><span class="line">   <span class="tag">&lt;/<span class="name">jsp:fallback</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果你有兴趣可以尝试使用 applet 来测试 <code>jsp:plugin</code> 动作元素，<code>&lt;fallback&gt;</code> 元素是一个新元素，在组件出现故障的错误是发送给用户错误信息。</p>
<h3 id="、-、"><a href="#、-、" class="headerlink" title="&lt;jsp:element&gt; 、 &lt;jsp:attribute&gt;、&lt;jsp:body&gt;"></a><code>&lt;jsp:element&gt;</code> 、 <code>&lt;jsp:attribute&gt;</code>、<code>&lt;jsp:body&gt;</code></h3><p><code>&lt;jsp:element&gt;</code> 、 <code>&lt;jsp:attribute&gt;</code>、<code>&lt;jsp:body&gt;</code> 动作元素动态定义 XML 元素。动态是非常重要的，这就意味着 XML 元素在编译时是动态生成的而非静态。</p>
<p>以下实例动态定义了 XML 元素：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span></span><br><span class="line"><span class="language-ruby">pageEncoding=<span class="string">&quot;UTF-8&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">jsp:element</span> <span class="attr">name</span>=<span class="string">&quot;xmlElement&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">jsp:attribute</span> <span class="attr">name</span>=<span class="string">&quot;xmlElementAttr&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        属性值</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">jsp:attribute</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">jsp:body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        XML 元素的主体</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">jsp:body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">jsp:element</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>浏览器访问以下页面，输出结果如下所示：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/7D8C47F0-0DDE-4F1D-8BE1-B2C9C955683E.jpg" alt="img"></p>
<h3 id="-6"><a href="#-6" class="headerlink" title="&lt;jsp:text&gt;"></a><code>&lt;jsp:text&gt;</code></h3><p><a href="jsp:text">jsp:text</a>动作元素允许在 JSP 页面和文档中使用写入文本的模板，语法格式如下：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:<span class="built_in">text</span>&gt;模板数据&lt;/jsp:<span class="built_in">text</span>&gt;</span><br></pre></td></tr></table></figure>

<p>以上文本模板不能包含其他元素，只能只能包含文本和 EL 表达式（注：EL 表达式将在后续章节中介绍）。请注意，在 XML 文件中，您不能使用表达式如 ${whatever &gt; 0}，因为&gt;符号是非法的。 你可以使用 ${whatever gt 0}表达式或者嵌入在一个 CDATA 部分的值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:text</span>&gt;</span>&lt;![CDATA[&lt;br&gt;]]&gt;<span class="tag">&lt;/<span class="name">jsp:text</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果你需要在 XHTML 中声明 DOCTYPE,必须使用到 <code>&lt;jsp:text&gt;</code> 动作元素，实例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:text</span>&gt;</span>&lt;![CDATA[&lt;!DOCTYPE html</span><br><span class="line">PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span><br><span class="line">&quot;DTD/xhtml1-strict.dtd&quot;&gt;]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>jsp:text action<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">books</span>&gt;</span><span class="tag">&lt;<span class="name">book</span>&gt;</span><span class="tag">&lt;<span class="name">jsp:text</span>&gt;</span></span><br><span class="line">    Welcome to JSP Programming</span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:text</span>&gt;</span><span class="tag">&lt;/<span class="name">book</span>&gt;</span><span class="tag">&lt;/<span class="name">books</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>你可以对以上实例尝试使用<a href="jsp:text">jsp:text</a>及不使用该动作元素执行结果的区别。</p>
<h2 id="JSP-隐式对象"><a href="#JSP-隐式对象" class="headerlink" title="JSP 隐式对象"></a>JSP 隐式对象</h2><p>JSP 隐式对象是 JSP 容器为每个页面提供的 Java 对象，开发者可以直接使用它们而不用显式声明。JSP 隐式对象也被称为预定义变量。</p>
<p>JSP 所支持的九大隐式对象：</p>
<table>
<thead>
<tr>
<th><strong>对象</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>request</td>
<td><strong>HttpServletRequest</strong>类的实例</td>
</tr>
<tr>
<td>response</td>
<td><strong>HttpServletResponse</strong>类的实例</td>
</tr>
<tr>
<td>out</td>
<td><strong>PrintWriter</strong>类的实例，用于把结果输出至网页上</td>
</tr>
<tr>
<td>session</td>
<td><strong>HttpSession</strong>类的实例</td>
</tr>
<tr>
<td>application</td>
<td><strong>ServletContext</strong>类的实例，与应用上下文有关</td>
</tr>
<tr>
<td>config</td>
<td><strong>ServletConfig</strong>类的实例</td>
</tr>
<tr>
<td>pageContext</td>
<td><strong>PageContext</strong>类的实例，提供对 JSP 页面所有对象以及命名空间的访问</td>
</tr>
<tr>
<td>page</td>
<td>类似于 Java 类中的 this 关键字</td>
</tr>
<tr>
<td>Exception</td>
<td><strong>Exception</strong>类的对象，代表发生错误的 JSP 页面中对应的异常对象</td>
</tr>
</tbody></table>
<h3 id="request-对象"><a href="#request-对象" class="headerlink" title="request 对象"></a>request 对象</h3><p><code>request</code>对象是<code>javax.servlet.http.HttpServletRequest</code> 类的实例。</p>
<p>每当客户端请求一个 JSP 页面时，JSP 引擎就会制造一个新的<code>request</code>对象来代表这个请求。</p>
<p><code>request</code>对象提供了一系列方法来获取 HTTP 头信息，cookies，HTTP 方法等等。</p>
<h3 id="response-对象"><a href="#response-对象" class="headerlink" title="response 对象"></a>response 对象</h3><p><code>response</code>对象是<code>javax.servlet.http.HttpServletResponse</code>类的实例。</p>
<p>当服务器创建<code>request</code>对象时会同时创建用于响应这个客户端的<code>response</code>对象。</p>
<p><code>response</code>对象也定义了处理 HTTP 头模块的接口。通过这个对象，开发者们可以添加新的 cookies，时间戳，HTTP 状态码等等。</p>
<h3 id="out-对象"><a href="#out-对象" class="headerlink" title="out 对象"></a>out 对象</h3><p><code>out</code>对象是<code>javax.servlet.jsp.JspWriter</code>类的实例，用来在<code>response</code>对象中写入内容。</p>
<p>最初的<code>JspWriter</code>类对象根据页面是否有缓存来进行不同的实例化操作。可以在<code>page</code>指令中使用<code>buffered=&#39;false&#39;</code>属性来轻松关闭缓存。</p>
<p><code>JspWriter</code>类包含了大部分<code>java.io.PrintWriter</code>类中的方法。不过，<code>JspWriter</code>新增了一些专为处理缓存而设计的方法。还有就是，<code>JspWriter</code>类会抛出<code>IOExceptions</code>异常，而<code>PrintWriter</code>不会。</p>
<p>下表列出了我们将会用来输出<code>boolean</code>，<code>char</code>，<code>int</code>，<code>double</code>，<code>String</code>，<code>object</code>等类型数据的重要方法：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>out.print(dataType dt)</strong></td>
<td>输出 Type 类型的值</td>
</tr>
<tr>
<td><strong>out.println(dataType dt)</strong></td>
<td>输出 Type 类型的值然后换行</td>
</tr>
<tr>
<td><strong>out.flush()</strong></td>
<td>刷新输出流</td>
</tr>
</tbody></table>
<h3 id="session-对象"><a href="#session-对象" class="headerlink" title="session 对象"></a>session 对象</h3><p><code>session</code>对象是<code>javax.servlet.http.HttpSession</code>类的实例。和 Java Servlets 中的<code>session</code>对象有一样的行为。</p>
<p><code>session</code>对象用来跟踪在各个客户端请求间的会话。</p>
<h3 id="application-对象"><a href="#application-对象" class="headerlink" title="application 对象"></a>application 对象</h3><p><code>application</code>对象直接包装了 servlet 的<code>ServletContext</code>类的对象，是<code>javax.servlet.ServletContext</code>类的实例。</p>
<p>这个对象在 JSP 页面的整个生命周期中都代表着这个 JSP 页面。这个对象在 JSP 页面初始化时被创建，随着<code>jspDestroy()</code>方法的调用而被移除。</p>
<p>通过向<code>application</code>中添加属性，则所有组成您 web 应用的 JSP 文件都能访问到这些属性。</p>
<h3 id="config-对象"><a href="#config-对象" class="headerlink" title="config 对象"></a>config 对象</h3><p><code>config</code>对象是<code>javax.servlet.ServletConfig</code>类的实例，直接包装了 servlet 的<code>ServletConfig</code>类的对象。</p>
<p>这个对象允许开发者访问 Servlet 或者 JSP 引擎的初始化参数，比如文件路径等。</p>
<p>以下是 config 对象的使用方法，不是很重要，所以不常用：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.getServletName()<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>它返回包含在<code>&lt;servlet-name&gt;</code>元素中的 servlet 名字，注意，<code>&lt;servlet-name&gt;</code>元素在<code>WEB-INF\web.xml</code>文件中定义。</p>
<h3 id="pageContext-对象"><a href="#pageContext-对象" class="headerlink" title="pageContext 对象"></a>pageContext 对象</h3><p><code>pageContext</code>对象是<code>javax.servlet.jsp.PageContext</code>类的实例，用来代表整个 JSP 页面。</p>
<p>这个对象主要用来访问页面信息，同时过滤掉大部分实现细节。</p>
<p>这个对象存储了<code>request</code>对象和<code>response</code>对象的引用。<code>application</code>对象，<code>config</code>对象，<code>session</code>对象，<code>out</code>对象可以通过访问这个对象的属性来导出。</p>
<p><code>pageContext</code>对象也包含了传给 JSP 页面的指令信息，包括缓存信息，ErrorPage URL,页面 scope 等。</p>
<p><code>PageContext</code>类定义了一些字段，包括 PAGE_SCOPE，REQUEST_SCOPE，SESSION_SCOPE， APPLICATION_SCOPE。它也提供了 40 余种方法，有一半继承自<code>javax.servlet.jsp.JspContext</code> 类。</p>
<p>其中一个重要的方法就是<code>removeArribute()</code>，它可接受一个或两个参数。比如，pageContext.removeArribute(“attrName”)移除四个 scope 中相关属性，但是下面这种方法只移除特定 scope 中的相关属性：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pageContext.removeAttribute<span class="punctuation">(</span><span class="string">&quot;attrName&quot;</span><span class="punctuation">,</span> PAGE_SCOPE<span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>

<h3 id="page-对象"><a href="#page-对象" class="headerlink" title="page 对象"></a>page 对象</h3><p>这个对象就是页面实例的引用。它可以被看做是整个 JSP 页面的代表。</p>
<p><code>page</code>对象就是<code>this</code>对象的同义词。</p>
<h3 id="exception-对象"><a href="#exception-对象" class="headerlink" title="exception 对象"></a>exception 对象</h3><p><code>exception</code>对象包装了从先前页面中抛出的异常信息。它通常被用来产生对出错条件的适当响应。</p>
<h2 id="EL-表达式"><a href="#EL-表达式" class="headerlink" title="EL 表达式"></a>EL 表达式</h2><p>EL 表达式是用<code>$&#123;&#125;</code>括起来的脚本，用来更方便地读取对象。EL 表达式写在 JSP 的 HTML 代码中，而不能写在<code>&lt;%</code>与<code>%&gt;</code>引起的 JSP 脚本中。</p>
<p>JSP 表达式语言（EL）使得访问存储在 JavaBean 中的数据变得非常简单。JSP EL 既可以用来创建算术表达式也可以用来创建逻辑表达式。在 JSP EL 表达式内可以使用整型数，浮点数，字符串，常量 true、false，还有 null。</p>
<h3 id="一个简单的语法"><a href="#一个简单的语法" class="headerlink" title="一个简单的语法"></a>一个简单的语法</h3><p>典型的，当您需要在 JSP 标签中指定一个属性值时，只需要简单地使用字符串即可：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:setProperty <span class="attribute">name</span>=<span class="string">&quot;box&quot;</span> <span class="attribute">property</span>=<span class="string">&quot;perimeter&quot;</span> <span class="attribute">value</span>=<span class="string">&quot;100&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>JSP EL 允许您指定一个表达式来表示属性值。一个简单的表达式语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;<span class="built_in">expr</span>&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中，expr 指的是表达式。在 JSP EL 中通用的操作符是”.”和”[]”。这两个操作符允许您通过内嵌的 JSP 对象访问各种各样的 JavaBean 属性。</p>
<p>举例来说，上面的 <code>&lt;jsp:setProperty&gt;</code> 标签可以使用表达式语言改写成如下形式：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:setProperty</span><br><span class="line">  <span class="attribute">name</span>=<span class="string">&quot;box&quot;</span></span><br><span class="line">  <span class="attribute">property</span>=<span class="string">&quot;perimeter&quot;</span></span><br><span class="line">  <span class="attribute">value</span>=<span class="string">&quot;<span class="variable">$&#123;2*box.width+2*box.height&#125;</span>&quot;</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>当 JSP 编译器在属性中见到”${}”格式后，它会产生代码来计算这个表达式，并且产生一个替代品来代替表达式的值。</p>
<p>您也可以在标签的模板文本中使用表达式语言。比如 <code>&lt;jsp:text&gt;</code> 标签简单地将其主体中的文本插入到 JSP 输出中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jsp:text</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello JSP!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jsp:text</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在，在<a href="jsp:text">jsp:text</a>标签主体中使用表达式，就像这样：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:<span class="type">text</span>&gt;</span><br><span class="line">  <span class="type">Box</span> Perimeter <span class="keyword">is</span>: $&#123;<span class="number">2</span>*<span class="type">box</span>.width + <span class="number">2</span>*<span class="type">box</span>.height&#125;</span><br><span class="line">&lt;/jsp:<span class="type">text</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在 EL 表达式中可以使用圆括号来组织子表达式。比如 <code>$&#123;(1 + 2) _ 3&#125;</code> 等于 9，但是 <code>$&#123;1 + (2 _ 3)&#125;</code> 等于 7。</p>
<p>想要停用对 EL 表达式的评估的话，需要使用 page 指令将 isELIgnored 属性值设为 true：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page isELIgnored =<span class="string">&quot;true|false&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<p>这样，EL 表达式就会被忽略。若设为 false，则容器将会计算 EL 表达式。</p>
<h3 id="EL-中的基础操作符"><a href="#EL-中的基础操作符" class="headerlink" title="EL 中的基础操作符"></a>EL 中的基础操作符</h3><p>EL 表达式支持大部分 Java 所提供的算术和逻辑操作符：</p>
<table>
<thead>
<tr>
<th><strong>操作符</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>.</td>
<td>访问一个 Bean 属性或者一个映射条目</td>
</tr>
<tr>
<td>[]</td>
<td>访问一个数组或者链表的元素</td>
</tr>
<tr>
<td>( )</td>
<td>组织一个子表达式以改变优先级</td>
</tr>
<tr>
<td>+</td>
<td>加</td>
</tr>
<tr>
<td>-</td>
<td>减或负</td>
</tr>
<tr>
<td>*</td>
<td>乘</td>
</tr>
<tr>
<td>&#x2F; or div</td>
<td>除</td>
</tr>
<tr>
<td>% or mod</td>
<td>取模</td>
</tr>
<tr>
<td>&#x3D;&#x3D; or eq</td>
<td>测试是否相等</td>
</tr>
<tr>
<td>!&#x3D; or ne</td>
<td>测试是否不等</td>
</tr>
<tr>
<td>&lt; or lt</td>
<td>测试是否小于</td>
</tr>
<tr>
<td>&gt; or gt</td>
<td>测试是否大于</td>
</tr>
<tr>
<td>&lt;&#x3D; or le</td>
<td>测试是否小于等于</td>
</tr>
<tr>
<td>&gt;&#x3D; or ge</td>
<td>测试是否大于等于</td>
</tr>
<tr>
<td>&amp;&amp; or and</td>
<td>测试逻辑与</td>
</tr>
<tr>
<td>|| or or</td>
<td>测试逻辑或</td>
</tr>
<tr>
<td>! or not</td>
<td>测试取反</td>
</tr>
<tr>
<td>empty</td>
<td>测试是否空值</td>
</tr>
</tbody></table>
<h3 id="JSP-EL-中的函数"><a href="#JSP-EL-中的函数" class="headerlink" title="JSP EL 中的函数"></a>JSP EL 中的函数</h3><p>JSP EL 允许您在表达式中使用函数。这些函数必须被定义在自定义标签库中。函数的使用语法如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;ns:<span class="keyword">func</span><span class="params">(param1, param2, ...)</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ns 指的是命名空间（namespace），func 指的是函数的名称，param1 指的是第一个参数，param2 指的是第二个参数，以此类推。比如，有函数 fn:length，在 JSTL 库中定义，可以像下面这样来获取一个字符串的长度：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="function"><span class="keyword">fn</span>:<span class="title">length</span>(<span class="params"><span class="string">&quot;Get my length&quot;</span></span>)&#125;</span></span><br></pre></td></tr></table></figure>

<p>要使用任何标签库中的函数，您需要将这些库安装在服务器中，然后使用 <code>&lt;taglib&gt;</code> 标签在 JSP 文件中包含这些库。</p>
<h3 id="JSP-EL-隐含对象"><a href="#JSP-EL-隐含对象" class="headerlink" title="JSP EL 隐含对象"></a>JSP EL 隐含对象</h3><p>JSP EL 支持下表列出的隐含对象：</p>
<table>
<thead>
<tr>
<th><strong>隐含对象</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>pageScope</td>
<td>page 作用域</td>
</tr>
<tr>
<td>requestScope</td>
<td>request 作用域</td>
</tr>
<tr>
<td>sessionScope</td>
<td>session 作用域</td>
</tr>
<tr>
<td>applicationScope</td>
<td>application 作用域</td>
</tr>
<tr>
<td>param</td>
<td>Request 对象的参数，字符串</td>
</tr>
<tr>
<td>paramValues</td>
<td>Request 对象的参数，字符串集合</td>
</tr>
<tr>
<td>header</td>
<td>HTTP 信息头，字符串</td>
</tr>
<tr>
<td>headerValues</td>
<td>HTTP 信息头，字符串集合</td>
</tr>
<tr>
<td>initParam</td>
<td>上下文初始化参数</td>
</tr>
<tr>
<td>cookie</td>
<td>Cookie 值</td>
</tr>
<tr>
<td>pageContext</td>
<td>当前页面的 pageContext</td>
</tr>
</tbody></table>
<p>您可以在表达式中使用这些对象，就像使用变量一样。接下来会给出几个例子来更好的理解这个概念。</p>
<h3 id="pageContext-对象-1"><a href="#pageContext-对象-1" class="headerlink" title="pageContext 对象"></a>pageContext 对象</h3><p>pageContext 对象是 JSP 中 pageContext 对象的引用。通过 pageContext 对象，您可以访问 request 对象。比如，访问 request 对象传入的查询字符串，就像这样：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$&#123;</span>pageContext.request.<span class="keyword">query</span>String&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scope-对象"><a href="#Scope-对象" class="headerlink" title="Scope 对象"></a>Scope 对象</h3><p>pageScope，requestScope，sessionScope，applicationScope 变量用来访问存储在各个作用域层次的变量。</p>
<p>举例来说，如果您需要显式访问在 applicationScope 层的 box 变量，可以这样来访问：applicationScope.box。</p>
<h3 id="param-和-paramValues-对象"><a href="#param-和-paramValues-对象" class="headerlink" title="param 和 paramValues 对象"></a>param 和 paramValues 对象</h3><p>param 和 paramValues 对象用来访问参数值，通过使用 request.getParameter 方法和 request.getParameterValues 方法。</p>
<p>举例来说，访问一个名为 order 的参数，可以这样使用表达式：<code>$&#123;param.order&#125;</code>，或者<code>$&#123;param[&quot;order&quot;]&#125;</code>。</p>
<p>接下来的例子表明了如何访问 request 中的 username 参数：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;%@ page import=&quot;java.io.*,java.util.*&quot; %&gt;</span> <span class="variable">&lt;% String title = &quot;Accessing Request</span></span><br><span class="line"><span class="variable">Param&quot;; %&gt;</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line">  <span class="variable">&lt;head&gt;</span></span><br><span class="line">    <span class="variable">&lt;title&gt;</span><span class="variable">&lt;% out.print(title); %&gt;</span><span class="variable">&lt;/title&gt;</span></span><br><span class="line">  <span class="variable">&lt;/head&gt;</span></span><br><span class="line">  <span class="variable">&lt;body&gt;</span></span><br><span class="line">    <span class="variable">&lt;center&gt;</span></span><br><span class="line">      <span class="variable">&lt;h1&gt;</span><span class="variable">&lt;% out.print(title); %&gt;</span><span class="variable">&lt;/h1&gt;</span></span><br><span class="line">    <span class="variable">&lt;/center&gt;</span></span><br><span class="line">    <span class="variable">&lt;div align=&quot;center&quot;&gt;</span></span><br><span class="line">      <span class="variable">&lt;p&gt;</span>$&#123;param[<span class="string">&quot;username&quot;</span>]&#125;<span class="variable">&lt;/p&gt;</span></span><br><span class="line">    <span class="variable">&lt;/div&gt;</span></span><br><span class="line">  <span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<p>param 对象返回单一的字符串，而 paramValues 对象则返回一个字符串数组。</p>
<h3 id="header-和-headerValues-对象"><a href="#header-和-headerValues-对象" class="headerlink" title="header 和 headerValues 对象"></a>header 和 headerValues 对象</h3><p>header 和 headerValues 对象用来访问信息头，通过使用 request.getHeader 方法和 request.getHeaders 方法。</p>
<p>举例来说，要访问一个名为 user-agent 的信息头，可以这样使用表达式：<code>$&#123;header.user-agent&#125;</code>，或者 <code>$&#123;header[&quot;user-agent&quot;]&#125;</code>。</p>
<p>接下来的例子表明了如何访问 user-agent 信息头：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;%@ page import=&quot;java.io.*,java.util.*&quot; %&gt;</span> <span class="variable">&lt;% String title = &quot;User Agent</span></span><br><span class="line"><span class="variable">Example&quot;; %&gt;</span></span><br><span class="line"><span class="variable">&lt;html&gt;</span></span><br><span class="line">  <span class="variable">&lt;head&gt;</span></span><br><span class="line">    <span class="variable">&lt;title&gt;</span><span class="variable">&lt;% out.print(title); %&gt;</span><span class="variable">&lt;/title&gt;</span></span><br><span class="line">  <span class="variable">&lt;/head&gt;</span></span><br><span class="line">  <span class="variable">&lt;body&gt;</span></span><br><span class="line">    <span class="variable">&lt;center&gt;</span></span><br><span class="line">      <span class="variable">&lt;h1&gt;</span><span class="variable">&lt;% out.print(title); %&gt;</span><span class="variable">&lt;/h1&gt;</span></span><br><span class="line">    <span class="variable">&lt;/center&gt;</span></span><br><span class="line">    <span class="variable">&lt;div align=&quot;center&quot;&gt;</span></span><br><span class="line">      <span class="variable">&lt;p&gt;</span>$&#123;header[<span class="string">&quot;user-agent&quot;</span>]&#125;<span class="variable">&lt;/p&gt;</span></span><br><span class="line">    <span class="variable">&lt;/div&gt;</span></span><br><span class="line">  <span class="variable">&lt;/body&gt;</span></span><br><span class="line"><span class="variable">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2014/01/jsp-expression-language.jpg" alt="img"></p>
<p>header 对象返回单一值，而 headerValues 则返回一个字符串数组。</p>
<h2 id="JSTL"><a href="#JSTL" class="headerlink" title="JSTL"></a>JSTL</h2><p>JSP 标准标签库（JSTL）是一个 JSP 标签集合，它封装了 JSP 应用的通用核心功能。</p>
<p>JSTL 支持通用的、结构化的任务，比如迭代，条件判断，XML 文档操作，国际化标签，SQL 标签。 除了这些，它还提供了一个框架来使用集成 JSTL 的自定义标签。</p>
<p>根据 JSTL 标签所提供的功能，可以将其分为 5 个类别。</p>
<ul>
<li><strong>核心标签</strong></li>
<li><strong>格式化标签</strong></li>
<li><strong>SQL 标签</strong></li>
<li><strong>XML 标签</strong></li>
<li><strong>JSTL 函数</strong></li>
</ul>
<h3 id="JSTL-库安装"><a href="#JSTL-库安装" class="headerlink" title="JSTL 库安装"></a>JSTL 库安装</h3><p>Apache Tomcat 安装 JSTL 库步骤如下：</p>
<p>从 Apache 的标准标签库中下载的二进包(jakarta-taglibs-standard-current.zip)。</p>
<ul>
<li>官方下载地址：<a target="_blank" rel="noopener" href="http://archive.apache.org/dist/jakarta/taglibs/standard/binaries/">http://archive.apache.org/dist/jakarta/taglibs/standard/binaries/</a></li>
<li>本站下载地址：<a target="_blank" rel="noopener" href="http://static.runoob.com/download/jakarta-taglibs-standard-1.1.2.tar.gz">jakarta-taglibs-standard-1.1.2.zip</a></li>
</ul>
<p>下载 <strong>jakarta-taglibs-standard-1.1.2.zip</strong> 包并解压，将 <strong>jakarta-taglibs-standard-1.1.2&#x2F;lib&#x2F;</strong> 下的两个 jar 文件：<strong>standard.jar</strong> 和 <strong>jstl.jar</strong> 文件拷贝到 <strong>&#x2F;WEB-INF&#x2F;lib&#x2F;</strong> 下。</p>
<p>将 tld 下的需要引入的 tld 文件复制到 WEB-INF 目录下。</p>
<p>接下来我们在 web.xml 文件中添加以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span></span></span><br><span class="line"><span class="tag">  <span class="attr">version</span>=<span class="string">&quot;2.4&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/j2ee</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsp-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/fmt<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/fmt.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/fmt-rt<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/fmt-rt.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/core<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/c.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/core-rt<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/c-rt.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/sql<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/sql.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/sql-rt<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/sql-rt.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/x<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/x.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-uri</span>&gt;</span>http://java.sun.com/jsp/jstl/x-rt<span class="tag">&lt;/<span class="name">taglib-uri</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">taglib-location</span>&gt;</span>/WEB-INF/x-rt.tld<span class="tag">&lt;/<span class="name">taglib-location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jsp-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用任何库，你必须在每个 JSP 文件中的头部包含 <strong><code>&lt;taglib&gt;</code></strong> 标签。</p>
<h3 id="核心标签"><a href="#核心标签" class="headerlink" title="核心标签"></a>核心标签</h3><p>核心标签是最常用的 JSTL 标签。引用核心标签库的语法如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib prefix=<span class="string">&quot;c&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-out-tag.html"><code>&lt;c:out&gt;</code></a></td>
<td align="left">用于在 JSP 中显示数据，就像&lt;%&#x3D; … &gt;</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-set-tag.html"><code>&lt;c:set&gt;</code></a></td>
<td align="left">用于保存数据</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-remove-tag.html"><code>&lt;c:remove&gt;</code></a></td>
<td align="left">用于删除数据</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-catch-tag.html"><code>&lt;c:catch&gt;</code></a></td>
<td align="left">用来处理产生错误的异常状况，并且将错误信息储存起来</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-if-tag.html"><code>&lt;c:if&gt;</code></a></td>
<td align="left">与我们在一般程序中用的 if 一样</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-choose-tag.html"><code>&lt;c:choose&gt;</code></a></td>
<td align="left">本身只当做 <code>&lt;c:when&gt;</code> 和 <code>&lt;c:otherwise&gt;</code> 的父标签</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-choose-tag.html"><code>&lt;c:when&gt;</code></a></td>
<td align="left"><code>&lt;c:choose&gt;</code> 的子标签，用来判断条件是否成立</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-choose-tag.html"><code>&lt;c:otherwise&gt;</code></a></td>
<td align="left"><code>&lt;c:choose&gt;</code> 的子标签，接在 <code>&lt;c:when&gt;</code> 标签后，当 <code>&lt;c:when&gt;</code> 标签判断为 false 时被执行</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-import-tag.html"><code>&lt;c:import&gt;</code></a></td>
<td align="left">检索一个绝对或相对 URL，然后将其内容暴露给页面</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-foreach-tag.html"><code>&lt;c:forEach&gt;</code></a></td>
<td align="left">基础迭代标签，接受多种集合类型</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-foreach-tag.html"><code>&lt;c:forTokens&gt;</code></a></td>
<td align="left">根据指定的分隔符来分隔内容并迭代输出</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-param-tag.html"><code>&lt;c:param&gt;</code></a></td>
<td align="left">用来给包含或重定向的页面传递参数</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-redirect-tag.html"><code>&lt;c:redirect&gt;</code></a></td>
<td align="left">重定向至一个新的 URL.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-core-url-tag.html"><code>&lt;c:url&gt;</code></a></td>
<td align="left">使用可选的查询参数来创造一个 URL</td>
</tr>
</tbody></table>
<h3 id="格式化标签"><a href="#格式化标签" class="headerlink" title="格式化标签"></a>格式化标签</h3><p>JSTL 格式化标签用来格式化并输出文本、日期、时间、数字。引用格式化标签库的语法如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib prefix=<span class="string">&quot;fmt&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/fmt&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-formatnumber-tag.html"><code>&lt;fmt:formatNumber&gt;</code></a></td>
<td align="left">使用指定的格式或精度格式化数字</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-parsenumber-tag.html"><code>&lt;fmt:parseNumber&gt;</code></a></td>
<td align="left">解析一个代表着数字，货币或百分比的字符串</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-formatdate-tag.html"><code>&lt;fmt:formatDate&gt;</code></a></td>
<td align="left">使用指定的风格或模式格式化日期和时间</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-parsedate-tag.html"><code>&lt;fmt:parseDate&gt;</code></a></td>
<td align="left">解析一个代表着日期或时间的字符串</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-bundle-tag.html"><code>&lt;fmt:bundle&gt;</code></a></td>
<td align="left">绑定资源</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-setlocale-tag.html"><code>&lt;fmt:setLocale&gt;</code></a></td>
<td align="left">指定地区</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-setbundle-tag.html"><code>&lt;fmt:setBundle&gt;</code></a></td>
<td align="left">绑定资源</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-timezone-tag.html"><code>&lt;fmt:timeZone&gt;</code></a></td>
<td align="left">指定时区</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-settimezone-tag.html"><code>&lt;fmt:setTimeZone&gt;</code></a></td>
<td align="left">指定时区</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-message-tag.html"><code>&lt;fmt:message&gt;</code></a></td>
<td align="left">显示资源配置文件信息</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-format-requestencoding-tag.html"><code>&lt;fmt:requestEncoding&gt;</code></a></td>
<td align="left">设置 request 的字符编码</td>
</tr>
</tbody></table>
<h3 id="SQL-标签"><a href="#SQL-标签" class="headerlink" title="SQL 标签"></a>SQL 标签</h3><p>JSTL SQL 标签库提供了与关系型数据库（Oracle，MySQL，SQL Server 等等）进行交互的标签。引用 SQL 标签库的语法如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib prefix=<span class="string">&quot;sql&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/sql&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-setdatasource-tag.html"><code>&lt;sql:setDataSource&gt;</code></a></td>
<td align="left">指定数据源</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-query-tag.html"><code>&lt;sql:query&gt;</code></a></td>
<td align="left">运行 SQL 查询语句</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-update-tag.html"><code>&lt;sql:update&gt;</code></a></td>
<td align="left">运行 SQL 更新语句</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-param-tag.html"><code>&lt;sql:param&gt;</code></a></td>
<td align="left">将 SQL 语句中的参数设为指定值</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-dateparam-tag.html"><code>&lt;sql:dateParam&gt;</code></a></td>
<td align="left">将 SQL 语句中的日期参数设为指定的 java.util.Date 对象值</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-sql-transaction-tag.html"><code>&lt;sql:transaction&gt;</code></a></td>
<td align="left">在共享数据库连接中提供嵌套的数据库行为元素，将所有语句以一个事务的形式来运行</td>
</tr>
</tbody></table>
<h3 id="XML-标签"><a href="#XML-标签" class="headerlink" title="XML 标签"></a>XML 标签</h3><p>JSTL XML 标签库提供了创建和操作 XML 文档的标签。引用 XML 标签库的语法如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib prefix=<span class="string">&quot;x&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/xml&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在使用 xml 标签前，你必须将 XML 和 XPath 的相关包拷贝至你的 <code>&lt;Tomcat 安装目录&gt;\lib</code> 下:</p>
<ul>
<li><p>XercesImpl.jar</p>
<p>下载地址： <a target="_blank" rel="noopener" href="http://www.apache.org/dist/xerces/j/">http://www.apache.org/dist/xerces/j/</a></p>
</li>
<li><p>xalan.jar</p>
<p>下载地址： <a target="_blank" rel="noopener" href="http://xml.apache.org/xalan-j/index.html">http://xml.apache.org/xalan-j/index.html</a></p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-out-tag.html"><code>&lt;x:out&gt;</code></a></td>
<td align="left">与 <code>&lt;%= ... &gt;</code>,类似，不过只用于 XPath 表达式</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-parse-tag.html"><code>&lt;x:parse&gt;</code></a></td>
<td align="left">解析 XML 数据</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-set-tag.html"><code>&lt;x:set&gt;</code></a></td>
<td align="left">设置 XPath 表达式</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-if-tag.html"><code>&lt;x:if&gt;</code></a></td>
<td align="left">判断 XPath 表达式，若为真，则执行本体中的内容，否则跳过本体</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-foreach-tag.html"><code>&lt;x:forEach&gt;</code></a></td>
<td align="left">迭代 XML 文档中的节点</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-choose-tag.html"><code>&lt;x:choose&gt;</code></a></td>
<td align="left"><code>&lt;x:when&gt;</code> 和 <code>&lt;x:otherwise&gt;</code> 的父标签</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-choose-tag.html"><code>&lt;x:when&gt;</code></a></td>
<td align="left"><code>&lt;x:choose&gt;</code> 的子标签，用来进行条件判断</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-choose-tag.html"><code>&lt;x:otherwise&gt;</code></a></td>
<td align="left"><code>&lt;x:choose&gt;</code> 的子标签，当 <code>&lt;x:when&gt;</code> 判断为 false 时被执行</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-transform-tag.html"><code>&lt;x:transform&gt;</code></a></td>
<td align="left">将 XSL 转换应用在 XML 文档中</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-xml-param-tag.html"><code>&lt;x:param&gt;</code></a></td>
<td align="left">与 <code>&lt;x:transform&gt;</code> 共同使用，用于设置 XSL 样式表</td>
</tr>
</tbody></table>
<h3 id="JSTL-函数"><a href="#JSTL-函数" class="headerlink" title="JSTL 函数"></a>JSTL 函数</h3><p>JSTL 包含一系列标准函数，大部分是通用的字符串处理函数。引用 JSTL 函数库的语法如下：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">%</span>@ taglib prefix=<span class="string">&quot;fn&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/functions&quot;</span> <span class="meta">%</span>&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-contains.html">fn:contains()</a></td>
<td align="left">测试输入的字符串是否包含指定的子串</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-containsignoreCase.html">fn:containsIgnoreCase()</a></td>
<td align="left">测试输入的字符串是否包含指定的子串，大小写不敏感</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-endswith.html">fn:endsWith()</a></td>
<td align="left">测试输入的字符串是否以指定的后缀结尾</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-escapexml.html">fn:escapeXml()</a></td>
<td align="left">跳过可以作为 XML 标记的字符</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-indexof.html">fn:indexOf()</a></td>
<td align="left">返回指定字符串在输入字符串中出现的位置</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-join.html">fn:join()</a></td>
<td align="left">将数组中的元素合成一个字符串然后输出</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-length.html">fn:length()</a></td>
<td align="left">返回字符串长度</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-replace.html">fn:replace()</a></td>
<td align="left">将输入字符串中指定的位置替换为指定的字符串然后返回</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-split.html">fn:split()</a></td>
<td align="left">将字符串用指定的分隔符分隔然后组成一个子字符串数组并返回</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-startswith.html">fn:startsWith()</a></td>
<td align="left">测试输入字符串是否以指定的前缀开始</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-substring.html">fn:substring()</a></td>
<td align="left">返回字符串的子集</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-substringafter.html">fn:substringAfter()</a></td>
<td align="left">返回字符串在指定子串之后的子集</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-substringbefore.html">fn:substringBefore()</a></td>
<td align="left">返回字符串在指定子串之前的子集</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-tolowercase.html">fn:toLowerCase()</a></td>
<td align="left">将字符串中的字符转为小写</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-touppercase.html">fn:toUpperCase()</a></td>
<td align="left">将字符串中的字符转为大写</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://www.runoob.com/jsp/jstl-function-trim.html">fn:trim()</a></td>
<td align="left">移除首尾的空白符</td>
</tr>
</tbody></table>
<h2 id="Taglib"><a href="#Taglib" class="headerlink" title="Taglib"></a>Taglib</h2><h3 id="JSP-自定义标签"><a href="#JSP-自定义标签" class="headerlink" title="JSP 自定义标签"></a>JSP 自定义标签</h3><p>自定义标签是用户定义的 JSP 语言元素。当 JSP 页面包含一个自定义标签时将被转化为 servlet，标签转化为对被 称为 tag handler 的对象的操作，即当 servlet 执行时 Web container 调用那些操作。</p>
<p>JSP 标签扩展可以让你创建新的标签并且可以直接插入到一个 JSP 页面。 JSP 2.0 规范中引入 Simple Tag Handlers 来编写这些自定义标记。</p>
<p>你可以继承 SimpleTagSupport 类并重写的 doTag()方法来开发一个最简单的自定义标签。</p>
<h3 id="创建”Hello”标签"><a href="#创建”Hello”标签" class="headerlink" title="创建”Hello”标签"></a>创建”Hello”标签</h3><p>接下来，我们想创建一个自定义标签叫作<a href="ex:Hello">ex:Hello</a>，标签格式为：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;ex:Hello /&gt;</span></span><br></pre></td></tr></table></figure>

<p>要创建自定义的 JSP 标签，你首先必须创建处理标签的 Java 类。所以，让我们创建一个 HelloTag 类，如下所示：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runoob; <span class="keyword">import</span> javax.servlet.jsp.tagext.*; <span class="keyword">import</span></span><br><span class="line">javax.servlet.jsp.*; <span class="keyword">import</span> java.io.*; public <span class="class"><span class="keyword">class</span> <span class="title">HelloTag</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="type">SimpleTagSupport</span> &#123; public void doTag() <span class="keyword">throws</span> <span class="type">JspException</span>, <span class="type">IOException</span> &#123;</span><br><span class="line"><span class="type">JspWriter</span> out = getJspContext().getOut(); out.println(<span class="string">&quot;Hello Custom Tag!&quot;</span>); &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>以下代码重写了 doTag()方法，方法中使用了 getJspContext()方法来获取当前的 JspContext 对象，并将”Hello Custom Tag!”传递给 JspWriter 对象。</p>
<p>编译以上类，并将其复制到环境变量 CLASSPATH 目录中。最后创建如下标签库：<code>&lt;Tomcat安装目录&gt;webapps\ROOT\WEB-INF\custom.tld</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tlib-version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">tlib-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsp-version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">jsp-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short-name</span>&gt;</span>Example TLD<span class="tag">&lt;/<span class="name">short-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag-class</span>&gt;</span>com.runoob.HelloTag<span class="tag">&lt;/<span class="name">tag-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body-content</span>&gt;</span>empty<span class="tag">&lt;/<span class="name">body-content</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来，我们就可以在 JSP 文件中使用 Hello 标签：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ taglib prefix=<span class="string">&quot;ex&quot;</span> uri=<span class="string">&quot;WEB-INF/custom.tld&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>A sample custom tag<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ex:Hello</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>以上程序输出结果为：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Custom <span class="keyword">Tag</span>!</span><br></pre></td></tr></table></figure>

<h3 id="访问标签体"><a href="#访问标签体" class="headerlink" title="访问标签体"></a>访问标签体</h3><p>你可以像标准标签库一样在标签中包含消息内容。如我们要在我们自定义的 Hello 中包含内容，格式如下：</p>
<figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">ex</span>:Hello&gt;</span><br><span class="line">  This <span class="keyword">is</span> message body</span><br><span class="line">&lt;/<span class="keyword">ex</span>:Hello&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以修改标签处理类文件，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runoob;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.jsp.tagext.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.jsp.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTag</span> <span class="keyword">extends</span> <span class="title class_">SimpleTagSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTag</span><span class="params">()</span></span><br><span class="line">      <span class="keyword">throws</span> JspException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">       getJspBody().invoke(sw);</span><br><span class="line">       getJspContext().getOut().println(sw.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们需要修改 TLD 文件，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tlib-version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">tlib-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsp-version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">jsp-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short-name</span>&gt;</span>Example TLD with Body<span class="tag">&lt;/<span class="name">short-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag-class</span>&gt;</span>com.runoob.HelloTag<span class="tag">&lt;/<span class="name">tag-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body-content</span>&gt;</span>scriptless<span class="tag">&lt;/<span class="name">body-content</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在我们可以在 JSP 使用修改后的标签，如下所示:</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ taglib prefix=<span class="string">&quot;ex&quot;</span> uri=<span class="string">&quot;WEB-INF/custom.tld&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>A sample custom tag<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ex:Hello</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      This is message body</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ex:Hello</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>以上程序输出结果如下所示：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This <span class="keyword">is</span> message <span class="keyword">body</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义标签属性"><a href="#自定义标签属性" class="headerlink" title="自定义标签属性"></a>自定义标签属性</h3><p>你可以在自定义标准中设置各种属性，要接收属性，值自定义标签类必须实现 setter 方法， JavaBean 中的 setter 方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runoob;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.jsp.tagext.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.jsp.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTag</span> <span class="keyword">extends</span> <span class="title class_">SimpleTagSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.message = msg;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doTag</span><span class="params">()</span></span><br><span class="line">      <span class="keyword">throws</span> JspException, IOException</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">/* 从属性中使用消息 */</span></span><br><span class="line">          <span class="type">JspWriter</span> <span class="variable">out</span> <span class="operator">=</span> getJspContext().getOut();</span><br><span class="line">          out.println( message );</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">/* 从内容体中使用消息 */</span></span><br><span class="line">          getJspBody().invoke(sw);</span><br><span class="line">          getJspContext().getOut().println(sw.toString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>属性的名称是”message”，所以 setter 方法是的 setMessage()。现在让我们在 TLD 文件中使用的 <code>&lt;attribute&gt;</code> 元素添加此属性：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">taglib</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tlib-version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">tlib-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsp-version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">jsp-version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short-name</span>&gt;</span>Example TLD with Body<span class="tag">&lt;/<span class="name">short-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag-class</span>&gt;</span>com.runoob.HelloTag<span class="tag">&lt;/<span class="name">tag-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body-content</span>&gt;</span>scriptless<span class="tag">&lt;/<span class="name">body-content</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attribute</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>message<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">taglib</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在我们就可以在 JSP 文件中使用 message 属性了，如下所示：</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&lt;%</span><span class="language-ruby">@ taglib prefix=<span class="string">&quot;ex&quot;</span> uri=<span class="string">&quot;WEB-INF/custom.tld&quot;</span></span><span class="language-xml">%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>A sample custom tag<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ex:Hello</span> <span class="attr">message</span>=<span class="string">&quot;This is custom tag&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>以上实例数据输出结果为：</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">This</span> <span class="keyword">is</span> custom <span class="meta">tag</span></span><br></pre></td></tr></table></figure>

<p>你还可以包含以下属性：</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">定义属性的名称。每个标签的是属性名称必须是唯一的。</td>
</tr>
<tr>
<td align="left">required</td>
<td align="left">指定属性是否是必须的或者可选的,如果设置为 false 为可选。</td>
</tr>
<tr>
<td align="left">rtexprvalue</td>
<td align="left">声明在运行表达式时，标签属性是否有效。</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">定义该属性的 Java 类类型 。默认指定为 <strong>String</strong></td>
</tr>
<tr>
<td align="left">description</td>
<td align="left">描述信息</td>
</tr>
<tr>
<td align="left">fragment</td>
<td align="left">如果声明了该属性,属性值将被视为一个 <strong>JspFragment</strong>。</td>
</tr>
</tbody></table>
<p>以下是指定相关的属性实例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>attribute_name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">required</span>&gt;</span>false<span class="tag">&lt;/<span class="name">required</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>java.util.Date<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">fragment</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>如果你使用了两个属性，修改 TLD 文件，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>attribute_name1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">required</span>&gt;</span>false<span class="tag">&lt;/<span class="name">required</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>java.util.Boolean<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">fragment</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>attribute_name2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">required</span>&gt;</span>true<span class="tag">&lt;/<span class="name">required</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>java.util.Date<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/e5b79f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/e5b79f/" class="post-title-link" itemprop="url">Maven 快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-07 23:04:47" itemprop="dateCreated datePublished" datetime="2020-02-07T23:04:47+08:00">2020-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E8%BD%AF%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">软件</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E8%BD%AF%E4%BB%B6/%E6%9E%84%E5%BB%BA/" itemprop="url" rel="index"><span itemprop="name">构建</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E8%BD%AF%E4%BB%B6/%E6%9E%84%E5%BB%BA/Maven/" itemprop="url" rel="index"><span itemprop="name">Maven</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Maven-快速入门"><a href="#Maven-快速入门" class="headerlink" title="Maven 快速入门"></a>Maven 快速入门</h1><h2 id="Maven-简介"><a href="#Maven-简介" class="headerlink" title="Maven 简介"></a>Maven 简介</h2><h3 id="Maven-是什么"><a href="#Maven-是什么" class="headerlink" title="Maven 是什么"></a>Maven 是什么</h3><p><a target="_blank" rel="noopener" href="https://github.com/apache/maven">Maven</a> 是一个项目管理工具。它负责管理项目开发过程中的几乎所有的东西。</p>
<ul>
<li><strong>版本</strong> - maven 有自己的版本定义和规则。</li>
<li><strong>构建</strong> - maven 支持许多种的应用程序类型，对于每一种支持的应用程序类型都定义好了一组构建规则和工具集。</li>
<li><strong>输出物管理</strong> - maven 可以管理项目构建的产物，并将其加入到用户库中。这个功能可以用于项目组和其他部门之间的交付行为。</li>
<li><strong>依赖关系</strong> - maven 对依赖关系的特性进行细致的分析和划分，避免开发过程中的依赖混乱和相互污染行为</li>
<li><strong>文档和构建结果</strong> - maven 的 site 命令支持各种文档信息的发布，包括构建过程的各种输出，javadoc，产品文档等。</li>
<li><strong>项目关系</strong> - 一个大型的项目通常有几个小项目或者模块组成，用 maven 可以很方便地管理。</li>
<li><strong>移植性管理</strong> - maven 可以针对不同的开发场景，输出不同种类的输出结果。</li>
</ul>
<h3 id="Maven-的生命周期"><a href="#Maven-的生命周期" class="headerlink" title="Maven 的生命周期"></a>Maven 的生命周期</h3><p>maven 把项目的构建划分为不同的生命周期(lifecycle)。粗略一点的话，它这个过程(phase)包括：编译、测试、打包、集成测试、验证、部署。maven 中所有的执行动作(goal)都需要指明自己在这个过程中的执行位置，然后 maven 执行的时候，就依照过程的发展依次调用这些 goal 进行各种处理。</p>
<p>这个也是 maven 的一个基本调度机制。一般来说，位置稍后的过程都会依赖于之前的过程。当然，maven 同样提供了配置文件，可以依照用户要求，跳过某些阶段。</p>
<h3 id="Maven-的标准工程结构"><a href="#Maven-的标准工程结构" class="headerlink" title="Maven 的标准工程结构"></a>Maven 的标准工程结构</h3><p>Maven 的标准工程结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|-- pom.xml(maven的核心配置文件)</span><br><span class="line">|-- src</span><br><span class="line">|-- main</span><br><span class="line">  |-- java(java源代码目录)</span><br><span class="line">  |-- resources(资源文件目录)</span><br><span class="line">|-- test</span><br><span class="line">    |-- java(单元测试代码目录)</span><br><span class="line">|-- target(输出目录，所有的输出物都存放在这个目录下)</span><br><span class="line">    |-- classes(编译后的class文件存放处)</span><br></pre></td></tr></table></figure>

<h3 id="Maven-的”约定优于配置”"><a href="#Maven-的”约定优于配置”" class="headerlink" title="Maven 的”约定优于配置”"></a>Maven 的”约定优于配置”</h3><p>所谓的”约定优于配置”，在 maven 中并不是完全不可以修改的，他们只是一些配置的默认值而已。但是除非必要，并不需要去修改那些约定内容。maven 默认的文件存放结构如下：</p>
<p>每一个阶段的任务都知道怎么正确完成自己的工作，比如 compile 任务就知道从 src&#x2F;main&#x2F;java 下编译所有的 java 文件，并把它的输出 class 文件存放到 target&#x2F;classes 中。</p>
<p>对 maven 来说，采用”约定优于配置”的策略可以减少修改配置的工作量，也可以降低学习成本，更重要的是，给项目引入了统一的规范。</p>
<h3 id="Maven-的版本规范"><a href="#Maven-的版本规范" class="headerlink" title="Maven 的版本规范"></a>Maven 的版本规范</h3><p>maven 使用如下几个要素来唯一定位某一个输出物：</p>
<ul>
<li><strong>groupId</strong> - 团体、组织的标识符。团体标识的约定是，它以创建这个项目的组织名称的逆向域名(reverse domain name)开头。一般对应着 JAVA 的包的结构。例如 org.apache</li>
<li><strong>artifactId</strong> - 单独项目的唯一标识符。比如我们的 tomcat, commons 等。不要在 artifactId 中包含点号(.)。</li>
<li><strong>version</strong> - 一个项目的特定版本。</li>
<li><strong>packaging</strong> - 项目的类型，默认是 jar，描述了项目打包后的输出。类型为 jar 的项目产生一个 JAR 文件，类型为 war 的项目产生一个 web 应用。</li>
</ul>
<p>例如：想在 maven 工程中引入 4.12 版本的 junit 包，添加如下依赖即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>maven 有自己的版本规范，一般是如下定义 <code>&lt;major version&gt;</code>、<code>&lt;minor version&gt;</code>、<code>&lt;incremental version&gt;-&lt;qualifier&gt;</code> ，比如 1.2.3-beta-01。要说明的是，maven 自己判断版本的算法是 major,minor,incremental 部分用数字比 较，qualifier 部分用字符串比较，所以要小心 alpha-2 和 alpha-15 的比较关系，最好用 alpha-02 的格式。</p>
<p>maven 在版本管理时候可以使用几个特殊的字符串 SNAPSHOT，LATEST，RELEASE。比如”1.0-SNAPSHOT”。各个部分的含义和处理逻辑如下说明：</p>
<ul>
<li><strong>SNAPSHOT</strong> - 这个版本一般用于开发过程中，表示不稳定的版本。</li>
<li><strong>LATEST</strong> - 指某个特定构件的最新发布，这个发布可能是一个发布版，也可能是一个 snapshot 版，具体看哪个时间最后。</li>
<li><strong>RELEASE</strong> - 指最后一个发布版。</li>
</ul>
<h2 id="Maven-安装"><a href="#Maven-安装" class="headerlink" title="Maven 安装"></a>Maven 安装</h2><blockquote>
<p>Linux 环境安装可以使用我写一键安装脚本：<a target="_blank" rel="noopener" href="https://github.com/dunwu/linux-tutorial/tree/master/codes/linux/ops/service/maven">https://github.com/dunwu/linux-tutorial/tree/master/codes/linux/ops/service/maven</a></p>
</blockquote>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>Maven 依赖于 Java，所以本地必须安装 JDK。</p>
<p>打开控制台，执行 <code>java -version</code> 确认本地已安装 JDK。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -version</span></span><br><span class="line">java version &quot;1.8.0_191&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_191-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="下载解压"><a href="#下载解压" class="headerlink" title="下载解压"></a>下载解压</h3><p>进入 **<a target="_blank" rel="noopener" href="https://maven.apache.org/download.cgi">官网下载地址</a>**，选择合适版本，下载并解压到本地。解压命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下解压命令分别针对 zip 包和 tar 包</span></span><br><span class="line">unzip apache-maven-3.6.3-bin.zip</span><br><span class="line">tar xzvf apache-maven-3.6.3-bin.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>添加环境变量 <code>MAVEN_HOME</code>，值为 Maven 的安装路径。</p>
<h4 id="配置-Unix-系统环境变量"><a href="#配置-Unix-系统环境变量" class="headerlink" title="配置 Unix 系统环境变量"></a>配置 Unix 系统环境变量</h4><p>输入 <code>vi /etc/profile</code> ，添加环境变量如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MAVEN 的根路径</span></span><br><span class="line">export MAVEN_HOME=/opt/maven/apache-maven-3.5.2</span><br><span class="line">export PATH=$MAVEN_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>

<p>执行 <code>source /etc/profile</code> ，立即生效。</p>
<h4 id="配置-Windows-系统环境变量"><a href="#配置-Windows-系统环境变量" class="headerlink" title="配置 Windows 系统环境变量"></a>配置 Windows 系统环境变量</h4><p>右键 “计算机”，选择 “属性”，之后点击 “高级系统设置”，点击”环境变量”，来设置环境变量，有以下系统变量需要配置：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200108143017.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200108143038.png" alt="img"></p>
<h3 id="检测安装成功"><a href="#检测安装成功" class="headerlink" title="检测安装成功"></a>检测安装成功</h3><p>检验是否安装成功，执行 <code>mvn -v</code> 命令，如果输出类似下面的 maven 版本信息，说明配置成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn -v</span></span><br><span class="line">Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-18T02:33:14+08:00)</span><br><span class="line">Maven home: /opt/maven/apache-maven-3.5.4</span><br><span class="line">Java version: 1.8.0_191, vendor: Oracle Corporation, runtime: /mnt/disk1/jdk1.8.0_191/jre</span><br><span class="line">Default locale: zh_CN, platform encoding: UTF-8</span><br><span class="line">OS name: &quot;linux&quot;, version: &quot;3.10.0-327.el7.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Maven-配置文件"><a href="#Maven-配置文件" class="headerlink" title="Maven 配置文件"></a>Maven 配置文件</h3><p><code>setting.xml</code> 文件是 Maven 的默认配置文件，其默认路径为：<code>&lt;Maven 安装目录&gt;/conf/settings.xml</code>。</p>
<p>如果需要修改 Maven 配置，直接修改 <code>setting.xml</code> 并保持即可。</p>
<p>例如：想要修改本地仓库位置可以按如下配置，这样，所有通过 Maven 下载打包的 jar 包都会存储在 <code>D:\maven\repo</code> 路径下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.1.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\maven\repo<span class="tag">&lt;<span class="name">localRepository</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 略 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><h3 id="创建-Maven-工程"><a href="#创建-Maven-工程" class="headerlink" title="创建 Maven 工程"></a>创建 Maven 工程</h3><h4 id="初始化工程"><a href="#初始化工程" class="headerlink" title="初始化工程"></a>初始化工程</h4><p>执行指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=com.mycompany.app -DartifactId=my-app -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.4 -DinteractiveMode=false</span><br></pre></td></tr></table></figure>

<p>会在当前路径新建一个名为 <code>my-app</code> 的 Maven 工程，其目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">my-app</span><br><span class="line">|-- pom.xml</span><br><span class="line">`-- src</span><br><span class="line">    |-- main</span><br><span class="line">    |   `-- java</span><br><span class="line">    |       `-- com</span><br><span class="line">    |           `-- mycompany</span><br><span class="line">    |               `-- app</span><br><span class="line">    |                   `-- App.java</span><br><span class="line">    `-- test</span><br><span class="line">        `-- java</span><br><span class="line">            `-- com</span><br><span class="line">                `-- mycompany</span><br><span class="line">                    `-- app</span><br><span class="line">                        `-- AppTest.java</span><br></pre></td></tr></table></figure>

<p>其中， <code>src/main/java</code> 目录包含 java 源码， <code>src/test/java</code> 目录包含 java 测试源码，而 <code>pom.xml</code> 文件是 maven 工程的配置文件。</p>
<h4 id="POM-配置"><a href="#POM-配置" class="headerlink" title="POM 配置"></a>POM 配置</h4><p>pom.xml 是 maven 工程的配置文件，它描述了 maven 工程的构建方式，其配置信息是很复杂的，这里给一个最简单的配置示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h4><p>执行以下命令，即可构建项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven.test.skip=true -B -U</span><br></pre></td></tr></table></figure>

<p>构建成功后，会输出类似下面的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  2.953 s</span><br><span class="line">[INFO] Finished at: 2019-11-24T13:05:10+01:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>这时，在当前路径下会产生一个 <code>target</code> 目录，其中包含了构建的输出物，如：jar 包、class 文件等。</p>
<p>这时，我们可以执行以下命令启动 jar 包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp target/my-app-1.0-SNAPSHOT.jar com.mycompany.app.App</span><br></pre></td></tr></table></figure>

<h3 id="在-Intellij-中创建-Maven-工程"><a href="#在-Intellij-中创建-Maven-工程" class="headerlink" title="在 Intellij 中创建 Maven 工程"></a>在 Intellij 中创建 Maven 工程</h3><p>（1）创建 Maven 工程</p>
<p>依次点击 File -&gt; New -&gt; Project 打开创建工程对话框，选择 Maven 工程。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/1555414103572.png" alt="img"></p>
<p>（2）输入项目信息</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/1555415549748.png" alt="img"></p>
<p>（3）点击 Intellij 侧边栏中的 Maven 工具界面，有几个可以直接使用的 maven 命令，可以帮助你进行构建。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/1555415806237.png" alt="img"></p>
<h3 id="在-Eclipse-中创建-Maven-工程"><a href="#在-Eclipse-中创建-Maven-工程" class="headerlink" title="在 Eclipse 中创建 Maven 工程"></a>在 Eclipse 中创建 Maven 工程</h3><p>（1）Maven 插件</p>
<p>在 Eclipse 中创建 Maven 工程，需要安装 Maven 插件。</p>
<p>一般较新版本的 Eclipse 都会带有 Maven 插件，如果你的 Eclipse 中已经有 Maven 插件，可以跳过这一步骤。</p>
<p>点击 Help -&gt; Eclipse Marketplace，搜索 maven 关键字，选择安装红框对应的 Maven 插件。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195117.png" alt="img"></p>
<p>（2）Maven 环境配置</p>
<p>点击 Window -&gt; Preferences</p>
<p>如下图所示，配置 settings.xml 文件的位置</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195128.png" alt="img"></p>
<p>（3）创建 Maven 工程</p>
<p>File -&gt; New -&gt; Maven Project -&gt; Next，在接下来的窗口中会看到一大堆的项目模板，选择合适的模板。</p>
<p>接下来设置项目的参数，如下：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195151.png" alt="img"></p>
<p><strong>groupId</strong>是项目组织唯一的标识符，实际对应 JAVA 的包的结构，是 main 目录里 java 的目录结构。</p>
<p><strong>artifactId</strong>就是项目的唯一的标识符，实际对应项目的名称，就是项目根目录的名称。</p>
<p>点击 Finish，Eclipse 会创建一个 Maven 工程。</p>
<p>（4）使用 Maven 进行构建</p>
<p>Eclipse 中构建方式：</p>
<p>在 Elipse 项目上右击 -&gt; Run As 就能看到很多 Maven 操作。这些操作和 maven 命令是等效的。例如 Maven clean，等同于 mvn clean 命令。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195208.png" alt="img"></p>
<p>你也可以点击 Maven build，输入组合命令，并保存下来。如下图：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195219.png" alt="img"></p>
<p>Maven 命令构建方式：</p>
<p>当然，你也可以直接使用 maven 命令进行构建。</p>
<p>进入工程所在目录，输入 maven 命令就可以了。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20181127195243.png" alt="img"></p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="如何添加依赖"><a href="#如何添加依赖" class="headerlink" title="如何添加依赖"></a>如何添加依赖</h3><p>在 Maven 工程中添加依赖 jar 包，很简单，只要在 POM 文件中引入对应的<code>&lt;dependency&gt;</code>标签即可。</p>
<p>参考下例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zp.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>MavenDemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>MavenDemo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;dependency&gt;</code> 标签最常用的四个属性标签：</p>
<ul>
<li><code>&lt;groupId&gt;</code> - 项目组织唯一的标识符，实际对应 JAVA 的包的结构。</li>
<li><code>&lt;artifactId&gt;</code> - 项目唯一的标识符，实际对应项目的名称，就是项目根目录的名称。</li>
<li><code>&lt;version&gt;</code> - jar 包的版本号。可以直接填版本数字，也可以在 properties 标签中设置属性值。</li>
<li><code>&lt;scope&gt;</code> - jar 包的作用范围。可以填写 compile、runtime、test、system 和 provided。用来在编译、测试等场景下选择对应的 classpath。</li>
</ul>
<h3 id="如何寻找-jar-包"><a href="#如何寻找-jar-包" class="headerlink" title="如何寻找 jar 包"></a>如何寻找 jar 包</h3><p>可以在 <a target="_blank" rel="noopener" href="http://mvnrepository.com/">http://mvnrepository.com/</a> 站点搜寻你想要的 jar 包版本</p>
<p>例如，想要使用 log4j，可以找到需要的版本号，然后拷贝对应的 maven 标签信息，将其添加到 pom .xml 文件中。</p>
<h3 id="如何使用-Maven-插件-Plugin"><a href="#如何使用-Maven-插件-Plugin" class="headerlink" title="如何使用 Maven 插件(Plugin)"></a>如何使用 Maven 插件(Plugin)</h3><p>要添加 Maven 插件，可以在 pom.xml 文件中添加 <code>&lt;plugin&gt;</code> 标签。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;configuration&gt;</code> 标签用来配置插件的一些使用参数。</p>
<h3 id="如何一次编译多个工程"><a href="#如何一次编译多个工程" class="headerlink" title="如何一次编译多个工程"></a>如何一次编译多个工程</h3><p>假设要创建一个父 maven 工程，它有两个子工程：my-app 和 my-webapp：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+- pom.xml</span><br><span class="line">+- my-app</span><br><span class="line">| +- pom.xml</span><br><span class="line">| +- src</span><br><span class="line">|   +- main</span><br><span class="line">|     +- java</span><br><span class="line">+- my-webapp</span><br><span class="line">| +- pom.xml</span><br><span class="line">| +- src</span><br><span class="line">|   +- main</span><br><span class="line">|     +- webapp</span><br></pre></td></tr></table></figure>

<p>app 工程的 pom.xml 如下，重点在于在 modules 中引入两个子 module：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="string"><span class="tag">                      http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-webapp<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>选择编译 XXX 时，会依次对它的所有 Module 执行相同操作。</p>
<h3 id="常用-Maven-插件"><a href="#常用-Maven-插件" class="headerlink" title="常用 Maven 插件"></a>常用 Maven 插件</h3><blockquote>
<p>更多详情请参考：<a target="_blank" rel="noopener" href="https://maven.apache.org/plugins/">https://maven.apache.org/plugins/</a></p>
</blockquote>
<h4 id="maven-antrun-plugin"><a href="#maven-antrun-plugin" class="headerlink" title="maven-antrun-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-antrun-plugin/">maven-antrun-plugin</a></h4><p>maven-antrun-plugin 能让用户在 Maven 项目中运行 Ant 任务。用户可以直接在该插件的配置以 Ant 的方式编写 Target， 然后交给该插件的 run 目标去执行。在一些由 Ant 往 Maven 迁移的项目中，该插件尤其有用。此外当你发现需要编写一些自定义程度很高的任务，同时又觉 得 Maven 不够灵活时，也可以以 Ant 的方式实现之。maven-antrun-plugin 的 run 目标通常与生命周期绑定运行。</p>
<h4 id="maven-archetype-plugin"><a href="#maven-archetype-plugin" class="headerlink" title="maven-archetype-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/archetype/maven-archetype-plugin/">maven-archetype-plugin</a></h4><p>Archtype 指项目的骨架，Maven 初学者最开始执行的 Maven 命令可能就是<strong>mvn archetype:generate</strong>，这实际上就是让 maven-archetype-plugin 生成一个很简单的项目骨架，帮助开发者快速上手。可能也有人看到一些文档写了<strong>mvn archetype:create</strong>， 但实际上 create 目标已经被弃用了，取而代之的是 generate 目标，该目标使用交互式的方式提示用户输入必要的信息以创建项目，体验更好。 maven-archetype-plugin 还有一些其他目标帮助用户自己定义项目原型，例如你由一个产品需要交付给很多客户进行二次开发，你就可以为 他们提供一个 Archtype，帮助他们快速上手。</p>
<h4 id="maven-assembly-plugin"><a href="#maven-assembly-plugin" class="headerlink" title="maven-assembly-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-assembly-plugin/">maven-assembly-plugin</a></h4><p>maven-assembly-plugin 的用途是将项目打包，该包可能包含了项目的可执行文件、源代码、readme、平台脚本等等。 maven-assembly-plugin 支持各种主流的格式如 zip、tar.gz、jar 和 war 等，具体打包哪些文件是高度可控的，例如用户可以 按文件级别的粒度、文件集级别的粒度、模块级别的粒度、以及依赖级别的粒度控制打包，此外，包含和排除配置也是支持的。maven-assembly- plugin 要求用户使用一个名为<code>assembly.xml</code>的元数据文件来表述打包，它的 single 目标可以直接在命令行调用，也可以被绑定至生命周期。</p>
<h4 id="maven-dependency-plugin"><a href="#maven-dependency-plugin" class="headerlink" title="maven-dependency-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-dependency-plugin/">maven-dependency-plugin</a></h4><p>maven-dependency-plugin 最大的用途是帮助分析项目依赖，<strong>dependency:list</strong>能够列出项目最终解析到的依赖列表，<strong>dependency:tree</strong>能进一步的描绘项目依赖树，<strong>dependency:analyze</strong>可以告诉你项目依赖潜在的问题，如果你有直接使用到的却未声明的依赖，该目标就会发出警告。maven-dependency-plugin 还有很多目标帮助你操作依赖文件，例如<strong>dependency:copy-dependencies</strong>能将项目依赖从本地 Maven 仓库复制到某个特定的文件夹下面。</p>
<h4 id="maven-enforcer-plugin"><a href="#maven-enforcer-plugin" class="headerlink" title="maven-enforcer-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-enforcer-plugin/">maven-enforcer-plugin</a></h4><p>在一个稍大一点的组织或团队中，你无法保证所有成员都熟悉 Maven，那他们做一些比较愚蠢的事情就会变得很正常，例如给项目引入了外部的 SNAPSHOT 依赖而导致构建不稳定，使用了一个与大家不一致的 Maven 版本而经常抱怨构建出现诡异问题。maven-enforcer- plugin 能够帮助你避免之类问题，它允许你创建一系列规则强制大家遵守，包括设定 Java 版本、设定 Maven 版本、禁止某些依赖、禁止 SNAPSHOT 依赖。只要在一个父 POM 配置规则，然后让大家继承，当规则遭到破坏的时候，Maven 就会报错。除了标准的规则之外，你还可以扩展该插 件，编写自己的规则。maven-enforcer-plugin 的 enforce 目标负责检查规则，它默认绑定到生命周期的 validate 阶段。</p>
<h4 id="maven-help-plugin"><a href="#maven-help-plugin" class="headerlink" title="maven-help-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-help-plugin/">maven-help-plugin</a></h4><p>maven-help-plugin 是一个小巧的辅助工具，最简单的<strong>help:system</strong>可以打印所有可用的环境变量和 Java 系统属性。<strong>help:effective-pom</strong>和<strong>help:effective-settings</strong>最 为有用，它们分别打印项目的有效 POM 和有效 settings，有效 POM 是指合并了所有父 POM（包括 Super POM）后的 XML，当你不确定 POM 的某些信息从何而来时，就可以查看有效 POM。有效 settings 同理，特别是当你发现自己配置的 settings.xml 没有生效时，就可以用<strong>help:effective-settings</strong>来验证。此外，maven-help-plugin 的 describe 目标可以帮助你描述任何一个 Maven 插件的信息，还有 all-profiles 目标和 active-profiles 目标帮助查看项目的 Profile。</p>
<h4 id="maven-release-plugin"><a href="#maven-release-plugin" class="headerlink" title="maven-release-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-release-plugin/">maven-release-plugin</a></h4><p>maven-release-plugin 的用途是帮助自动化项目版本发布，它依赖于 POM 中的 SCM 信息。<strong>release:prepare</strong>用来准备版本发布，具体的工作包括检查是否有未提交代码、检查是否有 SNAPSHOT 依赖、升级项目的 SNAPSHOT 版本至 RELEASE 版本、为项目打标签等等。<strong>release:perform</strong>则 是签出标签中的 RELEASE 源码，构建并发布。版本发布是非常琐碎的工作，它涉及了各种检查，而且由于该工作仅仅是偶尔需要，因此手动操作很容易遗漏一 些细节，maven-release-plugin 让该工作变得非常快速简便，不易出错。maven-release-plugin 的各种目标通常直接在 命令行调用，因为版本发布显然不是日常构建生命周期的一部分。</p>
<h4 id="maven-resources-plugin"><a href="#maven-resources-plugin" class="headerlink" title="maven-resources-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-resources-plugin/">maven-resources-plugin</a></h4><p>为了使项目结构更为清晰，Maven 区别对待 Java 代码文件和资源文件，maven-compiler-plugin 用来编译 Java 代码，maven-resources-plugin 则用来处理资源文件。默认的主资源文件目录是<code>src/main/resources</code>，很多用户会需要添加额外的资源文件目录，这个时候就可以通过配置 maven-resources-plugin 来实现。此外，资源文件过滤也是 Maven 的一大特性，你可以在资源文件中使用*${propertyName}*形式的 Maven 属性，然后配置 maven-resources-plugin 开启对资源文件的过滤，之后就可以针对不同环境通过命令行或者 Profile 传入属性的值，以实现更为灵活的构建。</p>
<h4 id="maven-surefire-plugin"><a href="#maven-surefire-plugin" class="headerlink" title="maven-surefire-plugin"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/plugins/maven-surefire-plugin/">maven-surefire-plugin</a></h4><p>可能是由于历史的原因，Maven 2.3 中用于执行测试的插件不是 maven-test-plugin，而是 maven-surefire-plugin。其实大部分时间内，只要你的测试 类遵循通用的命令约定（以 Test 结尾、以 TestCase 结尾、或者以 Test 开头），就几乎不用知晓该插件的存在。然而在当你想要跳过测试、排除某些 测试类、或者使用一些 TestNG 特性的时候，了解 maven-surefire-plugin 的一些配置选项就很有用了。例如 <strong>mvn test -Dtest&#x3D;FooTest</strong> 这样一条命令的效果是仅运行 FooTest 测试类，这是通过控制 maven-surefire-plugin 的 test 参数实现的。</p>
<h4 id="build-helper-maven-plugin"><a href="#build-helper-maven-plugin" class="headerlink" title="build-helper-maven-plugin"></a><a target="_blank" rel="noopener" href="http://mojo.codehaus.org/build-helper-maven-plugin/">build-helper-maven-plugin</a></h4><p>Maven 默认只允许指定一个主 Java 代码目录和一个测试 Java 代码目录，虽然这其实是个应当尽量遵守的约定，但偶尔你还是会希望能够指定多个 源码目录（例如为了应对遗留项目），build-helper-maven-plugin 的 add-source 目标就是服务于这个目的，通常它被绑定到 默认生命周期的 generate-sources 阶段以添加额外的源码目录。需要强调的是，这种做法还是不推荐的，因为它破坏了 Maven 的约定，而且可能会遇到其他严格遵守约定的插件工具无法正确识别额外的源码目录。</p>
<p>build-helper-maven-plugin 的另一个非常有用的目标是 attach-artifact，使用该目标你可以以 classifier 的形式选取部分项目文件生成附属构件，并同时 install 到本地仓库，也可以 deploy 到远程仓库。</p>
<h4 id="exec-maven-plugin"><a href="#exec-maven-plugin" class="headerlink" title="exec-maven-plugin"></a><a target="_blank" rel="noopener" href="http://mojo.codehaus.org/exec-maven-plugin/">exec-maven-plugin</a></h4><p>exec-maven-plugin 很好理解，顾名思义，它能让你运行任何本地的系统程序，在某些特定情况下，运行一个 Maven 外部的程序可能就是最简单的问题解决方案，这就是<strong>exec:exec</strong>的 用途，当然，该插件还允许你配置相关的程序运行参数。除了 exec 目标之外，exec-maven-plugin 还提供了一个 java 目标，该目标要求你 提供一个 mainClass 参数，然后它能够利用当前项目的依赖作为 classpath，在同一个 JVM 中运行该 mainClass。有时候，为了简单的 演示一个命令行 Java 程序，你可以在 POM 中配置好 exec-maven-plugin 的相关运行参数，然后直接在命令运行<strong>mvn exec:java</strong> 以查看运行效果。</p>
<h4 id="jetty-maven-plugin"><a href="#jetty-maven-plugin" class="headerlink" title="jetty-maven-plugin"></a><a target="_blank" rel="noopener" href="http://wiki.eclipse.org/Jetty/Feature/Jetty_Maven_Plugin">jetty-maven-plugin</a></h4><p>在进行 Web 开发的时候，打开浏览器对应用进行手动的测试几乎是无法避免的，这种测试方法通常就是将项目打包成 war 文件，然后部署到 Web 容器 中，再启动容器进行验证，这显然十分耗时。为了帮助开发者节省时间，jetty-maven-plugin 应运而生，它完全兼容 Maven 项目的目录结构，能够周期性地检查源文件，一旦发现变更后自动更新到内置的 Jetty Web 容器中。做一些基本配置后（例如 Web 应用的 contextPath 和自动扫描变更的时间间隔），你只要执行 <strong>mvn jetty:run</strong> ，然后在 IDE 中修改代码，代码经 IDE 自动编译后产生变更，再由 jetty-maven-plugin 侦测到后更新至 Jetty 容器，这时你就可以直接 测试 Web 页面了。需要注意的是，jetty-maven-plugin 并不是宿主于 Apache 或 Codehaus 的官方插件，因此使用的时候需要额外 的配置<code>settings.xml</code>的 pluginGroups 元素，将 org.mortbay.jetty 这个 pluginGroup 加入。</p>
<h4 id="versions-maven-plugin"><a href="#versions-maven-plugin" class="headerlink" title="versions-maven-plugin"></a><a target="_blank" rel="noopener" href="http://mojo.codehaus.org/versions-maven-plugin/">versions-maven-plugin</a></h4><p>很多 Maven 用户遇到过这样一个问题，当项目包含大量模块的时候，为他们集体更新版本就变成一件烦人的事情，到底有没有自动化工具能帮助完成这件 事情呢？（当然你可以使用 sed 之类的文本操作工具，不过不在本文讨论范围）答案是肯定的，versions-maven- plugin 提供了很多目标帮助你管理 Maven 项目的各种版本信息。例如最常用的，命令 <strong>mvn versions:set -DnewVersion&#x3D;1.1-SNAPSHOT</strong> 就能帮助你把所有模块的版本更新到 1.1-SNAPSHOT。该插件还提供了其他一些很有用的目标，display-dependency- updates 能告诉你项目依赖有哪些可用的更新；类似的 display-plugin-updates 能告诉你可用的插件更新；然后 use- latest-versions 能自动帮你将所有依赖升级到最新版本。最后，如果你对所做的更改满意，则可以使用 <strong>mvn versions:commit</strong> 提交，不满意的话也可以使用 <strong>mvn versions:revert</strong> 进行撤销。</p>
<h3 id="Maven-命令"><a href="#Maven-命令" class="headerlink" title="Maven 命令"></a>Maven 命令</h3><p>常用 maven 命令清单：</p>
<table>
<thead>
<tr>
<th><strong>生命周期</strong></th>
<th><strong>阶段描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>mvn validate</td>
<td>验证项目是否正确，以及所有为了完整构建必要的信息是否可用</td>
</tr>
<tr>
<td>mvn generate-sources</td>
<td>生成所有需要包含在编译过程中的源代码</td>
</tr>
<tr>
<td>mvn process-sources</td>
<td>处理源代码，比如过滤一些值</td>
</tr>
<tr>
<td>mvn generate-resources</td>
<td>生成所有需要包含在打包过程中的资源文件</td>
</tr>
<tr>
<td>mvn process-resources</td>
<td>复制并处理资源文件至目标目录，准备打包</td>
</tr>
<tr>
<td>mvn compile</td>
<td>编译项目的源代码</td>
</tr>
<tr>
<td>mvn process-classes</td>
<td>后处理编译生成的文件，例如对 Java 类进行字节码增强（bytecode enhancement）</td>
</tr>
<tr>
<td>mvn generate-test-sources</td>
<td>生成所有包含在测试编译过程中的测试源码</td>
</tr>
<tr>
<td>mvn process-test-sources</td>
<td>处理测试源码，比如过滤一些值</td>
</tr>
<tr>
<td>mvn generate-test-resources</td>
<td>生成测试需要的资源文件</td>
</tr>
<tr>
<td>mvn process-test-resources</td>
<td>复制并处理测试资源文件至测试目标目录</td>
</tr>
<tr>
<td>mvn test-compile</td>
<td>编译测试源码至测试目标目录</td>
</tr>
<tr>
<td>mvn test</td>
<td>使用合适的单元测试框架运行测试。这些测试应该不需要代码被打包或发布</td>
</tr>
<tr>
<td>mvn prepare-package</td>
<td>在真正的打包之前，执行一些准备打包必要的操作。这通常会产生一个包的展开的处理过的版本（将会在 Maven 2.1+中实现）</td>
</tr>
<tr>
<td>mvn package</td>
<td>将编译好的代码打包成可分发的格式，如 JAR，WAR，或者 EAR</td>
</tr>
<tr>
<td>mvn pre-integration-test</td>
<td>执行一些在集成测试运行之前需要的动作。如建立集成测试需要的环境</td>
</tr>
<tr>
<td>mvn integration-test</td>
<td>如果有必要的话，处理包并发布至集成测试可以运行的环境</td>
</tr>
<tr>
<td>mvn post-integration-test</td>
<td>执行一些在集成测试运行之后需要的动作。如清理集成测试环境。</td>
</tr>
<tr>
<td>mvn verify</td>
<td>执行所有检查，验证包是有效的，符合质量规范</td>
</tr>
<tr>
<td>mvn install</td>
<td>安装包至本地仓库，以备本地的其它项目作为依赖使用</td>
</tr>
<tr>
<td>mvn deploy</td>
<td>复制最终的包至远程仓库，共享给其它开发人员和项目（通常和一次正式的发布相关）</td>
</tr>
</tbody></table>
<p>示例：最常用的 maven 构建命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=true -B -U</span><br></pre></td></tr></table></figure>

<p>清理本地输出物，并构建 maven 项目，最后将输出物归档在本地仓库。</p>
<blockquote>
<p>:bulb: 想了解更多 maven 命令行细节可以参考官方文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">Maven 构建生命周期说明</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/ref/3.6.3/maven-embedder/cli.html">Maven 命令行参数说明</a></li>
</ul>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/maven">Maven Github</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/ref/current">Maven 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">Maven in 5 Minutes</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/guides/getting-started/index.html">Maven Getting Started Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://www.oschina.net/question/158170_29368">maven 常见问题问答</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazy-fox/archive/2012/02/09/2343722.html">常用 Maven 插件介绍</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/9e7fab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/9e7fab/" class="post-title-link" itemprop="url">网络技术之 VPN</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-03 10:56:00" itemprop="dateCreated datePublished" datetime="2020-02-03T10:56:00+08:00">2020-02-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">网络技术</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网络技术之-VPN"><a href="#网络技术之-VPN" class="headerlink" title="网络技术之 VPN"></a>网络技术之 VPN</h1><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203095528.png" alt="img"></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>虚拟专用网络(VPN)的功能是：在公用网络上建立专用网络，进行加密通讯。在企业网络中有广泛应用。VPN 网关通过对数据包的加密和数据包目标地址的转换实现远程访问。VPN 可通过服务器、硬件、软件等多种方式实现。</p>
<p>VPN 属于远程访问技术，简单地说就是利用公用网络架设专用网络。例如某公司员工出差到外地，他想访问企业内网的服务器资源，这种访问就属于远程访问。<br>在传统的企业网络配置中，要进行远程访问，传统的方法是租用 DDN（数字数据网）专线或帧中继，这样的通讯方案必然导致高昂的网络通讯和维护费用。对于移动用户（移动办公人员）与远端个人用户而言，一般会通过拨号线路（Internet）进入企业的局域网，但这样必然带来安全上的隐患。<br>让外地员工访问到内网资源，利用 VPN 的解决方法就是在内网中架设一台 VPN 服务器。外地员工在当地连上互联网后，通过互联网连接 VPN 服务器，然后通过 VPN 服务器进入企业内网。为了保证数据安全，VPN 服务器和客户机之间的通讯数据都进行了加密处理。有了数据加密，就可以认为数据是在一条专用的数据链路上进行安全传输，就如同专门架设了一个专用网络一样，但实际上 VPN 使用的是互联网上的公用链路，因此 VPN 称为虚拟专用网络，其实质上就是利用加密技术在公网上封装出一个数据通讯隧道。有了 VPN 技术，用户无论是在外地出差还是在家中办公，只要能上互联网就能利用 VPN 访问内网资源，这就是 VPN 在企业中应用得如此广泛的原因。</p>
<h2 id="VPN-的作用"><a href="#VPN-的作用" class="headerlink" title="VPN 的作用"></a>VPN 的作用</h2><h3 id="隐藏-IP-和位置"><a href="#隐藏-IP-和位置" class="headerlink" title="隐藏 IP 和位置"></a>隐藏 IP 和位置</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203100404.png" alt="img"></p>
<p>VPN 可以隐藏使用者的 IP 地址和位置。</p>
<p>使用 VPN 的最常见原因之一是屏蔽您的真实 IP 地址。</p>
<p>您的 IP 地址是由 ISP 分配的唯一数字地址。 您在线上所做的所有事情都链接到您的 IP 地址，因此可以用来将您与在线活动进行匹配。 大多数网站记录其访问者的 IP 地址。</p>
<p>广告商还可以使用您的 IP 地址，根据您的身份和浏览历史为您提供有针对性的广告。</p>
<p>连接到 VPN 服务器时，您将使用该 VPN 服务器的 IP 地址。 您访问的任何网站都会看到 VPN 服务器的 IP 地址，而不是您自己的。</p>
<p>您将能够绕过 IP 地址阻止并浏览网站，而不会将您的活动作为一个个人追溯到您。</p>
<h3 id="通信加密"><a href="#通信加密" class="headerlink" title="通信加密"></a>通信加密</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203100543.png" alt="img"></p>
<p>使用 VPN 时，可以对信息进行加密，使得密码，电子邮件，照片，银行数据和其他敏感信息不会被拦截。</p>
<p>如果在公共场所使用公共 WiFi 连接网络时，敏感数据有被盗的风险。黑客可以利用开放和未加密的网络来窃取重要数据，例如您的密码，电子邮件，照片，银行数据和其他敏感信息。</p>
<p>VPN 可以加密信息，使黑客更难以拦截和窃取数据。</p>
<h3 id="翻墙"><a href="#翻墙" class="headerlink" title="翻墙"></a>翻墙</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203100706.png" alt="img"></p>
<p>轻松解除对 Facebook 和 Twitter，Skype，YouTube 和 Gmail 等网站和服务的阻止。 即使您被告知您所在的国家&#x2F;地区不可用它，或者您所在的学校或办公室网络限制访问，也可以获取所需的东西。</p>
<p>某些服务（例如 Netflix 或 BBC iPlayer）会根据您访问的国家&#x2F;地区限制访问内容。使用 VPN 可以绕过这些地理限制并解锁“隐藏”内容的唯一可靠方法。</p>
<h3 id="避免被监听"><a href="#避免被监听" class="headerlink" title="避免被监听"></a>避免被监听</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203100933.png" alt="img"></p>
<p>使用 VPN 可以向政府、ISP、黑客隐藏通信信息。</p>
<p>您的 Internet 服务提供商（ISP）可以看到您访问的所有网站，并且几乎可以肯定会记录该信息。</p>
<p>在某些国家&#x2F;地区，ISP 需要长时间收集和存储用户数据，并且政府能够访问，存储和搜索该信息。</p>
<p>在美国，英国，澳大利亚和欧洲大部分地区就是这种情况，仅举几例。</p>
<p>由于 VPN 会加密从设备到 VPN 服务器的互联网流量，因此您的 ISP 或任何其他第三方将无法监视您的在线活动。</p>
<p>要了解有关监视技术和全球大规模监视问题的更多信息，请访问 EFF 和 Privacy International。 您还可以在此处找到全球监视披露的更新列表。</p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>VPN 会在您的设备和私人服务器之间建立私人和加密的互联网连接。 这意味着您的数据无法被 ISP 或任何其他第三方读取或理解。 然后，私有服务器将您的流量发送到您要访问的网站或服务上。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203102422.png" alt="img"></p>
<p>VPN 的基本处理过程如下：</p>
<ol>
<li>要保护主机发送明文信息到其他 VPN 设备。</li>
<li>VPN 设备根据网络管理员设置的规则，确定是对数据进行加密还是直接传输。</li>
<li>对需要加密的数据，VPN 设备将其整个数据包（包括要传输的数据、源 IP 地址和目的 lP 地址）进行加密并附上数据签名，加上新的数据报头（包括目的地 VPN 设备需要的安全信息和一些初始化参数）重新封装。</li>
<li>将封装后的数据包通过隧道在公共网络上传输。</li>
<li>数据包到达目的 VPN 设备后，将其解封，核对数字签名无误后，对数据包解密。</li>
</ol>
<h2 id="VPN-协议"><a href="#VPN-协议" class="headerlink" title="VPN 协议"></a>VPN 协议</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200203102656.png" alt="img"></p>
<ul>
<li><p>OpenVPN</p>
</li>
<li><p>IKEv2 &#x2F; IPSec</p>
</li>
<li><p>SSTP</p>
</li>
<li><p>PPTP</p>
</li>
<li><p>Wireguard</p>
</li>
</ul>
<h2 id="VPN-服务"><a href="#VPN-服务" class="headerlink" title="VPN 服务"></a>VPN 服务</h2><p>你可以选择付费 VPN 或自行搭建 VPN。</p>
<p>VPN 服务商：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://go.nordvpn.net/aff_c?offer_id=15&aff_id=22023&url_id=902">NordVPN</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linkev.com/?a_fid=techacro">ExpressVPN</a></li>
<li><a target="_blank" rel="noopener" href="https://cybertool.co/tchacrobat_fs_izci9mc6y">CyberGhostVPN</a></li>
<li><a target="_blank" rel="noopener" href="https://click.tunnelbear.com/aff_c?offer_id=36&aff_id=7306">TunnelBear</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ipvanish.com/">IPVanish</a></li>
</ul>
<p>开源 VPN：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://openvpn.net/">OpenVPN</a></li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9C">百度百科 - VPN</a></li>
<li><a target="_blank" rel="noopener" href="https://www.expressvpn.com/what-is-vpn">What is a VPN</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=_wQTRMBAvzg">What is a VPN and How Does it Work</a></li>
<li><a target="_blank" rel="noopener" href="https://www.top10vpn.com/guides/what-is-a-vpn/">What Is a VPN (Virtual Private Network) and How Does It Work?</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/0276bb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/0276bb/" class="post-title-link" itemprop="url">深入剖析共识性算法 Paxos</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-02 22:00:00" itemprop="dateCreated datePublished" datetime="2020-02-02T22:00:00+08:00">2020-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA/" itemprop="url" rel="index"><span itemprop="name">分布式理论</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="深入剖析共识性算法-Paxos"><a href="#深入剖析共识性算法-Paxos" class="headerlink" title="深入剖析共识性算法 Paxos"></a>深入剖析共识性算法 Paxos</h1><blockquote>
<p>Paxos 是一种基于消息传递且具有容错性的共识性（consensus）算法。</p>
<p>Paxos 算法解决的问题正是分布式一致性问题。在一个节点数为 2N+1 的分布式集群中，只要半数以上的节点（N + 1）还正常工作，整个系统仍可以正常工作。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202310200757219.png"></p>
<h2 id="Paxos-背景"><a href="#Paxos-背景" class="headerlink" title="Paxos 背景"></a>Paxos 背景</h2><p>Paxos 是 Leslie Lamport 于 1990 年提出的一种基于消息传递且具有高度容错特性的<strong>共识（consensus）算法</strong>。</p>
<p>为描述 Paxos 算法，Lamport 虚拟了一个叫做 Paxos 的希腊城邦，这个岛按照议会民主制的政治模式制订法律，但是没有人愿意将自己的全部时间和精力放在这种事情上。所以无论是议员，议长或者传递纸条的服务员都不能承诺别人需要时一定会出现，也无法承诺批准决议或者传递消息的时间。</p>
<p>Paxos 算法包含 2 个部分：</p>
<ul>
<li><strong>Basic Paxos 算法</strong>：描述的多节点之间如何就某个值达成共识。</li>
<li><strong>Multi Paxos 思想</strong>：描述的是执行多个 Basic Paxos 实例，就一系列值达成共识。</li>
</ul>
<p>Paxos 算法解决的问题正是分布式共识性问题，即一个分布式系统中的各个进程如何就某个值（决议）达成一致。</p>
<p>Paxos 算法运行在允许宕机故障的异步系统中，不要求可靠的消息传递，可容忍消息丢失、延迟、乱序以及重复。它利用大多数 (Majority) 机制保证了 2N+1 的容错能力，即 2N+1 个节点的系统最多允许 N 个节点同时出现故障。</p>
<h2 id="Basic-Paxos-算法"><a href="#Basic-Paxos-算法" class="headerlink" title="Basic Paxos 算法"></a>Basic Paxos 算法</h2><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>Paxos 将分布式系统中的节点分 Proposer、Acceptor、Learner 三种角色。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20210528150700.png" alt="img"></p>
<ul>
<li><strong>提议者（Proposer）</strong>：发出提案（Proposal），用于投票表决。Proposal 信息包括提案编号 (Proposal ID) 和提议的值 (Value)。在绝大多数场景中，集群中收到客户端请求的节点，才是提议者。这样做的好处是，对业务代码没有入侵性，也就是说，我们不需要在业务代码中实现算法逻辑。</li>
<li><strong>接受者（Acceptor）</strong>：对每个 Proposal 进行投票，若 Proposal 获得多数 Acceptor 的接受，则称该 Proposal 被批准。一般来说，集群中的所有节点都在扮演接受者的角色，参与共识协商，并接受和存储数据。</li>
<li><strong>学习者（Learner）</strong>：不参与接受，从 Proposers&#x2F;Acceptors 学习、记录最新达成共识的提案（Value）。一般来说，学习者是数据备份节点，比如主从架构中的从节点，被动地接受数据，容灾备份。</li>
</ul>
<p>在多副本状态机中，每个副本都同时具有 Proposer、Acceptor、Learner 三种角色。</p>
<p>这三种角色，在本质上代表的是三种功能：</p>
<ul>
<li>提议者代表的是接入和协调功能，收到客户端请求后，发起二阶段提交，进行共识协商；</li>
<li>接受者代表投票协商和存储数据，对提议的值进行投票，并接受达成共识的值，存储保存；</li>
<li>学习者代表存储数据，不参与共识协商，只接受达成共识的值，存储保存。</li>
</ul>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>Paxos 算法有 3 个阶段，其中，前 2 个阶段负责协商并达成共识：</p>
<ol>
<li><strong>准备（Prepare）阶段</strong>：Proposer 向 Acceptors 发出 Prepare 请求，Acceptors 针对收到的 Prepare 请求进行 Promise 承诺。</li>
<li><strong>接受（Accept）阶段</strong>：Proposer 收到多数 Acceptors 承诺的 Promise 后，向 Acceptors 发出 Propose 请求，Acceptors 针对收到的 Propose 请求进行 Accept 处理。</li>
<li><strong>学习（Learn）阶段</strong>：Proposer 在收到多数 Acceptors 的 Accept 之后，标志着本次 Accept 成功，决议形成，将形成的决议发送给所有 Learners。</li>
</ol>
<p>看到这里，了解过分布式事务的读者，想必会觉得眼熟：这不就是两阶段提交嘛！没错，这里采用的正式两阶段提交的思想。两阶段提交是达成共识的常用方式。</p>
<p>Paxos 算法流程中的每条消息描述如下：</p>
<ul>
<li><p><strong>Prepare</strong>: Proposer 生成全局唯一且递增的 Proposal ID (可使用时间戳加 Server ID)，向所有 Acceptors 发送 Prepare 请求，这里无需携带提案内容，只携带 Proposal ID 即可。</p>
</li>
<li><p><strong>Promise</strong>: Acceptors 收到 Prepare 请求后，做出“两个承诺，一个应答”。</p>
<ul>
<li><p>两个承诺：</p>
<ul>
<li>不再接受 Proposal ID 小于等于当前请求的 Prepare 请求。</li>
<li>不再接受 Proposal ID 小于当前请求的 Propose 请求。</li>
</ul>
</li>
<li><p>一个应答：</p>
<ul>
<li>不违背以前作出的承诺下，回复已经 Accept 过的提案中 Proposal ID 最大的那个提案的 Value 和 Proposal ID，没有则返回空值。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Propose</strong>: Proposer 收到多数 Acceptors 的 Promise 应答后，从应答中选择 Proposal ID 最大的提案的 Value，作为本次要发起的提案。如果所有应答的提案 Value 均为空值，则可以自己随意决定提案 Value。然后携带当前 Proposal ID，向所有 Acceptors 发送 Propose 请求。</p>
</li>
<li><p><strong>Accept</strong>: Acceptor 收到 Propose 请求后，在不违背自己之前作出的承诺下，接受并持久化当前 Proposal ID 和提案 Value。</p>
</li>
<li><p><strong>Learn</strong>: Proposer 收到多数 Acceptors 的 Accept 后，决议形成，将形成的决议发送给所有 Learners。</p>
</li>
</ul>
<h3 id="Prepare-阶段"><a href="#Prepare-阶段" class="headerlink" title="Prepare 阶段"></a>Prepare 阶段</h3><p>在准备请求中是不需要指定提议的值的，只需要携带提案编号就可以了。</p>
<p>下图的示例中，首先客户端 1、2 作为提议者，分别向所有接受者发送包含提案编号的准备请求：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220628231557.png"></p>
<p>接着，当节点 A、B 收到提案编号为 1 的准备请求，节点 C 收到提案编号为 5 的准备请求后，将进行这样的处理：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220628231908.png"></p>
<ul>
<li>由于之前没有通过任何提案，所以节点 A、B 将返回一个 “尚无提案” 的响应。也就是说节点 A 和 B 在告诉提议者，我之前没有通过任何提案呢，并承诺以后不再响应提案编号小于等于 1 的准备请求，不会通过编号小于 1 的提案。</li>
<li>节点 C 也是如此，它将返回一个 “尚无提案”的响应，并承诺以后不再响应提案编号小于等于 5 的准备请求，不会通过编号小于 5 的提案。</li>
</ul>
<p>另外，当节点 A、B 收到提案编号为 5 的准备请求，和节点 C 收到提案编号为 1 的准备请求的时候，将进行这样的处理过程：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220628232029.png"></p>
<ul>
<li><p>当节点 A、B 收到提案编号为 5 的准备请求的时候，因为提案编号 5 大于它们之前响应的准备请求的提案编号 1，而且两个节点都没有通过任何提案，所以它将返回一个 “尚无提案”的响应，并承诺以后不再响应提案编号小于等于 5 的准备请求，不会通过编号小于 5 的提案。</p>
</li>
<li><p>当节点 C 收到提案编号为 1 的准备请求的时候，由于提案编号 1 小于它之前响应的准备请求的提案编号 5，所以丢弃该准备请求，不做响应。</p>
</li>
</ul>
<h3 id="Accept-阶段"><a href="#Accept-阶段" class="headerlink" title="Accept 阶段"></a>Accept 阶段</h3><p>首先客户端 1、2 在收到大多数节点的准备响应之后，会分别发送接受请求：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220628232309.png"></p>
<ul>
<li><p>当客户端 1 收到大多数的接受者（节点 A、B）的准备响应后，根据响应中提案编号最大的提案的值，设置接受请求中的值。因为该值在来自节点 A、B 的准备响应中都为空（也就是图 5 中的“尚无提案”），所以就把自己的提议值 3 作为提案的值，发送接受请求[1, 3]。</p>
</li>
<li><p>当客户端 2 收到大多数的接受者的准备响应后（节点 A、B 和节点 C），根据响应中提案编号最大的提案的值，来设置接受请求中的值。因为该值在来自节点 A、B、C 的准备响应中都为空（也就是图 5 和图 6 中的“尚无提案”），所以就把自己的提议值 7 作为提案的值，发送接受请求[5, 7]。</p>
</li>
</ul>
<p>当三个节点收到 2 个客户端的接受请求时，会进行这样的处理：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220628232515.png"></p>
<ul>
<li>当节点 A、B、C 收到接受请求[1, 3]的时候，由于提案的提案编号 1 小于三个节点承诺能通过的提案的最小提案编号 5，所以提案[1, 3]将被拒绝。</li>
<li>当节点 A、B、C 收到接受请求[5, 7]的时候，由于提案的提案编号 5 不小于三个节点承诺能通过的提案的最小提案编号 5，所以就通过提案[5, 7]，也就是接受了值 7，三个节点就 X 值为 7 达成了共识。</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Basic Paxos 是通过二阶段提交的方式来达成共识的。</p>
<p>除了共识，Basic Paxos 还实现了容错，在少于一半的节点出现故障时，集群也能工作。它不像分布式事务算法那样，必须要所有节点都同意后才提交操作，因为“所有节点都同意”这个原则，在出现节点故障的时候会导致整个集群不可用。也就是说，“大多数节点都同意”的原则，赋予了 Basic Paxos 容错的能力，让它能够容忍少于一半的节点的故障。</p>
<p>本质上而言，提案编号的大小代表着优先级，你可以这么理解，根据提案编号的大小，接受者保证三个承诺，具体来说：</p>
<ul>
<li>如果准备请求的提案编号，小于等于接受者已经响应的准备请求的提案编号，那么接受者将承诺不响应这个准备请求；</li>
<li>如果接受请求中的提案的提案编号，小于接受者已经响应的准备请求的提案编号，那么接受者将承诺不通过这个提案；</li>
<li>如果接受者之前有通过提案，那么接受者将承诺，会在准备请求的响应中，包含已经通过的最大编号的提案信息。</li>
</ul>
<h2 id="Multi-Paxos-思想"><a href="#Multi-Paxos-思想" class="headerlink" title="Multi Paxos 思想"></a>Multi Paxos 思想</h2><p>兰伯特提到的 Multi-Paxos 是一种思想，不是算法。而 Multi-Paxos 算法是一个统称，它是指基于 Multi-Paxos 思想，通过多个 Basic Paxos 实例实现一系列值的共识的算法（比如 Chubby 的 Multi-Paxos 实现、Raft 算法等）。</p>
<h3 id="Basic-Paxos-的问题"><a href="#Basic-Paxos-的问题" class="headerlink" title="Basic Paxos 的问题"></a>Basic Paxos 的问题</h3><p>Basic Paxos 有以下问题，导致它不能应用于实际：</p>
<ul>
<li><strong>Basic Paxos 算法只能对一个值形成决议</strong>。</li>
<li><strong>Basic Paxos 算法会消耗大量网络带宽</strong>。Basic Paxos 中，决议的形成至少需要两次网络通信，在高并发情况下可能需要更多的网络通信，极端情况下甚至可能形成活锁。如果想连续确定多个值，Basic Paxos 搞不定了。</li>
</ul>
<h3 id="Multi-Paxos-的改进"><a href="#Multi-Paxos-的改进" class="headerlink" title="Multi Paxos 的改进"></a>Multi Paxos 的改进</h3><p>Multi Paxos 正是为解决以上问题而提出。Multi Paxos 基于 Basic Paxos 做了两点改进：</p>
<ul>
<li><strong>针对每一个要确定的值，运行一次 Paxos 算法实例（Instance），形成决议</strong>。每一个 Paxos 实例使用唯一的 Instance ID 标识。</li>
<li><strong>在所有 Proposer 中选举一个 Leader，由 Leader 唯一地提交 Proposal 给 Acceptor 进行表决</strong>。这样没有 Proposer 竞争，解决了活锁问题。在系统中仅有一个 Leader 进行 Value 提交的情况下，Prepare 阶段就可以跳过，从而将两阶段变为一阶段，提高效率。</li>
</ul>
<p>Multi Paxos 首先需要选举 Leader，Leader 的确定也是一次决议的形成，所以可执行一次 Basic Paxos 实例来选举出一个 Leader。选出 Leader 之后只能由 Leader 提交 Proposal，在 Leader 宕机之后服务临时不可用，需要重新选举 Leader 继续服务。在系统中仅有一个 Leader 进行 Proposal 提交的情况下，Prepare 阶段可以跳过。</p>
<p>Multi Paxos 通过改变 Prepare 阶段的作用范围至后面 Leader 提交的所有实例，从而使得 Leader 的连续提交只需要执行一次 Prepare 阶段，后续只需要执行 Accept 阶段，将两阶段变为一阶段，提高了效率。为了区分连续提交的多个实例，每个实例使用一个 Instance ID 标识，Instance ID 由 Leader 本地递增生成即可。</p>
<p>Multi Paxos 允许有多个自认为是 Leader 的节点并发提交 Proposal 而不影响其安全性，这样的场景即退化为 Basic Paxos。</p>
<p>Chubby 和 Boxwood 均使用 Multi Paxos。ZooKeeper 使用的 Zab 也是 Multi Paxos 的变形。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://research.microsoft.com/en-us/um/people/lamport/pubs/lamport-paxos.pdf">Part-time Parliament 论文</a></li>
<li><a target="_blank" rel="noopener" href="https://lamport.azurewebsites.net/pubs/paxos-simple.pdf">Paxos Made Simple 论文</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31780743">Paxos 算法详解</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=Paxos%E7%AE%97%E6%B3%95">Wiki - Paxos 算法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1TW411M7Fx?from=search&seid=11524608198747599965">一致性算法（Paxos、Raft、Zab）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av36556594">Raft 作者讲解 Paxos 视频</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=d7nAGI_NZPk">Paxos 算法讲解视频</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100046101">分布式协议与算法实战</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/b067d6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/b067d6/" class="post-title-link" itemprop="url">Java并发和容器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-02 17:54:36" itemprop="dateCreated datePublished" datetime="2020-02-02T17:54:36+08:00">2020-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaSE/" itemprop="url" rel="index"><span itemprop="name">JavaSE</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/JavaSE/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">并发</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-并发和容器"><a href="#Java-并发和容器" class="headerlink" title="Java 并发和容器"></a>Java 并发和容器</h1><h2 id="同步容器"><a href="#同步容器" class="headerlink" title="同步容器"></a>同步容器</h2><h3 id="同步容器简介"><a href="#同步容器简介" class="headerlink" title="同步容器简介"></a>同步容器简介</h3><p>在 Java 中，同步容器主要包括 2 类：</p>
<ul>
<li><code>Vector</code>、<code>Stack</code>、<code>Hashtable</code><ul>
<li><code>Vector</code> - <code>Vector</code> 实现了 <code>List</code> 接口。<code>Vector</code> 实际上就是一个数组，和 <code>ArrayList</code> 类似。但是 <code>Vector</code> 中的方法都是 <code>synchronized</code> 方法，即进行了同步措施。</li>
<li><code>Stack</code> - <code>Stack</code> 也是一个同步容器，它的方法也用 <code>synchronized</code> 进行了同步，它实际上是继承于 <code>Vector</code> 类。</li>
<li><code>Hashtable</code>- <code>Hashtable</code> 实现了 <code>Map</code> 接口，它和 <code>HashMap</code> 很相似，但是 <code>Hashtable</code> 进行了同步处理，而 <code>HashMap</code> 没有。</li>
</ul>
</li>
<li><code>Collections</code> 类中提供的静态工厂方法创建的类（由 <code>Collections.synchronizedXXX</code> 等方法）</li>
</ul>
<h3 id="同步容器的问题"><a href="#同步容器的问题" class="headerlink" title="同步容器的问题"></a>同步容器的问题</h3><p>同步容器的同步原理就是在其 <code>get</code>、<code>set</code>、<code>size</code> 等主要方法上用 <code>synchronized</code> 修饰。 <strong><code>synchronized</code> 可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块</strong>。</p>
<blockquote>
<p>想详细了解 <code>synchronized</code> 用法和原理可以参考：<a target="_blank" rel="noopener" href="https://dunwu.github.io/waterdrop/pages/2c6488/">Java 并发核心机制</a></p>
</blockquote>
<h4 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h4><p><code>synchronized</code> 的互斥同步会产生阻塞和唤醒线程的开销。显然，这种方式比没有使用 <code>synchronized</code> 的容器性能要差很多。</p>
<blockquote>
<p>注：尤其是在 Java 1.6 没有对 <code>synchronized</code> 进行优化前，阻塞开销很高。</p>
</blockquote>
<h4 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h4><p>同步容器真的绝对安全吗？</p>
<p>其实也未必。在做复合操作（非原子操作）时，仍然需要加锁来保护。常见复合操作如下：</p>
<ul>
<li><strong>迭代</strong>：反复访问元素，直到遍历完全部元素；</li>
<li><strong>跳转</strong>：根据指定顺序寻找当前元素的下一个（下 n 个）元素；</li>
<li><strong>条件运算</strong>：例如若没有则添加等；</li>
</ul>
<p>❌ 不安全的示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VectorDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Vector&lt;Integer&gt; vector = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            vector.clear();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        vector.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        vector.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            thread1.start();</span><br><span class="line">            thread2.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;同时存在 10 个以上线程，退出&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上程序执行时可能会出现数组越界错误。</p>
<p><code>Vector</code> 是线程安全的，那为什么还会报这个错？</p>
<p>这是因为，对于 Vector，虽然能保证每一个时刻只能有一个线程访问它，但是不排除这种可能：</p>
<p>当某个线程在某个时刻执行这句时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;vector.size();i++)</span><br><span class="line">    vector.get(i);</span><br></pre></td></tr></table></figure>

<p>假若此时 vector 的 size 方法返回的是 10，i 的值为 9</p>
<p>然后另外一个线程执行了这句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;vector.size();i++)</span><br><span class="line">    vector.remove(i);</span><br></pre></td></tr></table></figure>

<p>将下标为 9 的元素删除了。</p>
<p>那么通过 get 方法访问下标为 9 的元素肯定就会出问题了。</p>
<p>✔️️️ 安全示例</p>
<p>因此为了保证线程安全，必须在方法调用端做额外的同步措施，如下面所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VectorDemo2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Vector&lt;Integer&gt; vector = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (VectorDemo2.class) &#123;   <span class="comment">//进行额外的同步</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                            vector.remove(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (VectorDemo2.class) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                            vector.get(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            thread1.start();</span><br><span class="line">            thread2.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;同时存在 10 个以上线程，退出&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConcurrentModificationException</code> 异常</p>
<p>在对 <code>Vector</code> 等容器并发地进行迭代修改时，会报 <code>ConcurrentModificationException</code> 异常，关于这个异常将会在后续文章中讲述。</p>
<p>但是在并发容器中不会出现这个问题。</p>
<h2 id="并发容器简介"><a href="#并发容器简介" class="headerlink" title="并发容器简介"></a>并发容器简介</h2><p>同步容器将所有对容器状态的访问都串行化，以保证线程安全性，这种策略会严重降低并发性。</p>
<p>Java 1.5 后提供了多种并发容器，<strong>使用并发容器来替代同步容器，可以极大地提高伸缩性并降低风险</strong>。</p>
<p>J.U.C 包中提供了几个非常有用的并发容器作为线程安全的容器：</p>
<table>
<thead>
<tr>
<th>并发容器</th>
<th>对应的普通容器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>ConcurrentHashMap</code></td>
<td><code>HashMap</code></td>
<td>Java 1.8 之前采用分段锁机制细化锁粒度，降低阻塞，从而提高并发性；Java 1.8 之后基于 CAS 实现。</td>
</tr>
<tr>
<td><code>ConcurrentSkipListMap</code></td>
<td><code>SortedMap</code></td>
<td>基于跳表实现的</td>
</tr>
<tr>
<td><code>CopyOnWriteArrayList</code></td>
<td><code>ArrayList</code></td>
<td></td>
</tr>
<tr>
<td><code>CopyOnWriteArraySet</code></td>
<td><code>Set</code></td>
<td>基于 <code>CopyOnWriteArrayList</code> 实现。</td>
</tr>
<tr>
<td><code>ConcurrentSkipListSet</code></td>
<td><code>SortedSet</code></td>
<td>基于 <code>ConcurrentSkipListMap</code> 实现。</td>
</tr>
<tr>
<td><code>ConcurrentLinkedQueue</code></td>
<td><code>Queue</code></td>
<td>线程安全的无界队列。底层采用单链表。支持 FIFO。</td>
</tr>
<tr>
<td><code>ConcurrentLinkedDeque</code></td>
<td><code>Deque</code></td>
<td>线程安全的无界双端队列。底层采用双向链表。支持 FIFO 和 FILO。</td>
</tr>
<tr>
<td><code>ArrayBlockingQueue</code></td>
<td><code>Queue</code></td>
<td>数组实现的阻塞队列。</td>
</tr>
<tr>
<td><code>LinkedBlockingQueue</code></td>
<td><code>Queue</code></td>
<td>链表实现的阻塞队列。</td>
</tr>
<tr>
<td><code>LinkedBlockingDeque</code></td>
<td><code>Deque</code></td>
<td>双向链表实现的双端阻塞队列。</td>
</tr>
</tbody></table>
<p>J.U.C 包中提供的并发容器命名一般分为三类：</p>
<ul>
<li><code>Concurrent</code><ul>
<li>这类型的锁竞争相对于 <code>CopyOnWrite</code> 要高一些，但写操作代价要小一些。</li>
<li>此外，<code>Concurrent</code> 往往提供了较低的遍历一致性，即：当利用迭代器遍历时，如果容器发生修改，迭代器仍然可以继续进行遍历。代价就是，在获取容器大小 <code>size()</code> ，容器是否为空等方法，不一定完全精确，但这是为了获取并发吞吐量的设计取舍，可以理解。与之相比，如果是使用同步容器，就会出现 <code>fail-fast</code> 问题，即：检测到容器在遍历过程中发生了修改，则抛出 <code>ConcurrentModificationException</code>，不再继续遍历。</li>
</ul>
</li>
<li><code>CopyOnWrite</code> - 一个线程写，多个线程读。读操作时不加锁，写操作时通过在副本上加锁保证并发安全，空间开销较大。</li>
<li><code>Blocking</code> - 内部实现一般是基于锁，提供阻塞队列的能力。</li>
</ul>
<p>:x: 错误示例，产生 <code>ConcurrentModificationException</code> 异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKeys</span><span class="params">(Map&lt;String, Object&gt; map, <span class="keyword">final</span> String... keys)</span> &#123;</span><br><span class="line">    map.keySet().removeIf(key -&gt; ArrayUtil.contains(keys, key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:x: 错误示例，产生 <code>ConcurrentModificationException</code> 异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="title function_">removeKeys</span><span class="params">(Map&lt;String, Object&gt; map, <span class="keyword">final</span> String... keys)</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> (K key : keys) &#123;</span><br><span class="line">		map.remove(key);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="并发场景下的-Map"><a href="#并发场景下的-Map" class="headerlink" title="并发场景下的 Map"></a>并发场景下的 Map</h3><p>如果对数据有强一致要求，则需使用 <code>Hashtable</code>；在大部分场景通常都是弱一致性的情况下，使用 <code>ConcurrentHashMap</code> 即可；如果数据量在千万级别，且存在大量增删改操作，则可以考虑使用 <code>ConcurrentSkipListMap</code>。</p>
<h3 id="并发场景下的-List"><a href="#并发场景下的-List" class="headerlink" title="并发场景下的 List"></a>并发场景下的 List</h3><p>读多写少用 <code>CopyOnWriteArrayList</code>。</p>
<p>写多读少用 <code>ConcurrentLinkedQueue</code> ，但由于是无界的，要有容量限制，避免无限膨胀，导致内存溢出。</p>
<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>Map 接口的两个实现是 ConcurrentHashMap 和 ConcurrentSkipListMap，它们从应用的角度来看，主要区别在于<strong>ConcurrentHashMap 的 key 是无序的，而 ConcurrentSkipListMap 的 key 是有序的</strong>。所以如果你需要保证 key 的顺序，就只能使用 ConcurrentSkipListMap。</p>
<p>使用 ConcurrentHashMap 和 ConcurrentSkipListMap 需要注意的地方是，它们的 key 和 value 都不能为空，否则会抛出<code>NullPointerException</code>这个运行时异常。</p>
<h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p><code>ConcurrentHashMap</code> 是线程安全的 <code>HashMap</code> ，用于替代 <code>Hashtable</code>。</p>
<h4 id="ConcurrentHashMap-的特性"><a href="#ConcurrentHashMap-的特性" class="headerlink" title="ConcurrentHashMap 的特性"></a><code>ConcurrentHashMap</code> 的特性</h4><p><code>ConcurrentHashMap</code> <code>实现了</code> <code>ConcurrentMap</code> 接口，而 <code>ConcurrentMap</code> 接口扩展了 <code>Map</code> 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">ConcurrentMap</span>&lt;K,V&gt;, Serializable &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConcurrentHashMap</code> 的实现包含了 <code>HashMap</code> 所有的基本特性，如：数据结构、读写策略等。</p>
<p><code>ConcurrentHashMap</code> 没有实现对 <code>Map</code> 加锁以提供独占访问。因此无法通过在客户端加锁的方式来创建新的原子操作。但是，一些常见的复合操作，如：“若没有则添加”、“若相等则移除”、“若相等则替换”，都已经实现为原子操作，并且是围绕 <code>ConcurrentMap</code> 的扩展接口而实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ConcurrentMap</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅当 K 没有相应的映射值才插入</span></span><br><span class="line">    V <span class="title function_">putIfAbsent</span><span class="params">(K key, V value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅当 K 被映射到 V 时才移除</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object key, Object value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅当 K 被映射到 oldValue 时才替换为 newValue</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">replace</span><span class="params">(K key, V oldValue, V newValue)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅当 K 被映射到某个值时才替换为 newValue</span></span><br><span class="line">    V <span class="title function_">replace</span><span class="params">(K key, V value)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同于 <code>Hashtable</code>，<code>ConcurrentHashMap</code> 提供的迭代器不会抛出 <code>ConcurrentModificationException</code>，因此不需要在迭代过程中对容器加锁。</p>
<blockquote>
<p>:bell: 注意：一些需要对整个 <code>Map</code> 进行计算的方法，如 <code>size</code> 和 <code>isEmpty</code> ，由于返回的结果在计算时可能已经过期，所以<strong>并非实时的精确值</strong>。这是一种策略上的权衡，在并发环境下，这类方法由于总在不断变化，所以获取其实时精确值的意义不大。<code>ConcurrentHashMap</code> 弱化这类方法，以换取更重要操作（如：<code>get</code>、<code>put</code>、<code>containesKey</code>、<code>remove</code> 等）的性能。</p>
</blockquote>
<h4 id="ConcurrentHashMap-的用法"><a href="#ConcurrentHashMap-的用法" class="headerlink" title="ConcurrentHashMap 的用法"></a>ConcurrentHashMap 的用法</h4><p>示例：不会出现 <code>ConcurrentModificationException</code></p>
<p><code>ConcurrentHashMap</code> 的基本操作与 <code>HashMap</code> 的用法基本一样。不同于 <code>HashMap</code>、<code>Hashtable</code>，<code>ConcurrentHashMap</code> 提供的迭代器不会抛出 <code>ConcurrentModificationException</code>，因此不需要在迭代过程中对容器加锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentHashMapDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HashMap 在并发迭代访问时会抛出 ConcurrentModificationException 异常</span></span><br><span class="line">        <span class="comment">// Map&lt;Integer, Character&gt; map = new HashMap&lt;&gt;();</span></span><br><span class="line">        Map&lt;Integer, Character&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">wthread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;写操作线程开始执行&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">                map.put(i, (<span class="type">char</span>) (<span class="string">&#x27;a&#x27;</span> + i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">rthread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读操作线程开始执行&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Integer key : map.keySet()) &#123;</span><br><span class="line">                System.out.println(key + <span class="string">&quot; - &quot;</span> + map.get(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        wthread.start();</span><br><span class="line">        rthread.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ConcurrentHashMap-的原理"><a href="#ConcurrentHashMap-的原理" class="headerlink" title="ConcurrentHashMap 的原理"></a>ConcurrentHashMap 的原理</h4><blockquote>
<p><code>ConcurrentHashMap</code> 一直在演进，尤其在 Java 1.7 和 Java 1.8，其数据结构和并发机制有很大的差异。</p>
</blockquote>
<ul>
<li>Java 1.7<ul>
<li>数据结构：<strong>数组＋单链表</strong></li>
<li>并发机制：采用分段锁机制细化锁粒度，降低阻塞，从而提高并发性。</li>
</ul>
</li>
<li>Java 1.8<ul>
<li>数据结构：<strong>数组＋单链表＋红黑树</strong></li>
<li>并发机制：取消分段锁，之后基于 CAS + synchronized 实现。</li>
</ul>
</li>
</ul>
<h5 id="Java-1-7-的实现"><a href="#Java-1-7-的实现" class="headerlink" title="Java 1.7 的实现"></a>Java 1.7 的实现</h5><p>分段锁，是将内部进行分段（Segment），里面是 <code>HashEntry</code> 数组，和 <code>HashMap</code> 类似，哈希相同的条目也是以链表形式存放。<br><code>HashEntry</code> 内部使用 <code>volatile</code> 的 <code>value</code> 字段来保证可见性，也利用了不可变对象的机制，以改进利用 <code>Unsafe</code> 提供的底层能力，比如 volatile access，去直接完成部分操作，以最优化性能，毕竟 <code>Unsafe</code> 中的很多操作都是 JVM intrinsic 优化过的。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200605214405.png" alt="img"></p>
<p>在进行并发写操作时，<code>ConcurrentHashMap</code> 会获取可重入锁（<code>ReentrantLock</code>），以保证数据一致性。所以，在并发修改期间，相应 <code>Segment</code> 是被锁定的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentHashMap</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K, V&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">ConcurrentMap</span>&lt;K, V&gt;, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将整个hashmap分成几个小的map，每个segment都是一个锁；与hashtable相比，这么设计的目的是对于put, remove等操作，可以减少并发冲突，对</span></span><br><span class="line">    <span class="comment">// 不属于同一个片段的节点可以并发操作，大大提高了性能</span></span><br><span class="line">    <span class="keyword">final</span> Segment&lt;K,V&gt;[] segments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 本质上Segment类就是一个小的hashmap，里面table数组存储了各个节点的数据，继承了ReentrantLock, 可以作为互拆锁使用</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Segment</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">transient</span> <span class="keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;</span><br><span class="line">        <span class="keyword">transient</span> <span class="type">int</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基本节点，存储Key， Value值</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HashEntry</span>&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V value;</span><br><span class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Java-1-8-的实现"><a href="#Java-1-8-的实现" class="headerlink" title="Java 1.8 的实现"></a>Java 1.8 的实现</h5><ul>
<li>数据结构改进：与 HashMap 一样，将原先 <strong>数组＋单链表</strong> 的数据结构，变更为 <strong>数组＋单链表＋红黑树</strong> 的结构。当出现哈希冲突时，数据会存入数组指定桶的单链表，当链表长度达到 8，则将其转换为红黑树结构，这样其查询的时间复杂度可以降低到 $$O(logN)$$，以改进性能。</li>
<li>并发机制改进：<ul>
<li>取消 segments 字段，<strong>直接采用 <code>transient volatile HashEntry&lt;K,V&gt;[] table</code> 保存数据，采用 table 数组元素作为锁，从而实现了对每一行数据进行加锁，进一步减少并发冲突的概率</strong>。</li>
<li>使用 CAS + <code>sychronized</code> 操作，在特定场景进行无锁并发操作。使用 Unsafe、LongAdder 之类底层手段，进行极端情况的优化。现代 JDK 中，synchronized 已经被不断优化，可以不再过分担心性能差异，另外，相比于 ReentrantLock，它可以减少内存消耗，这是个非常大的优势。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// 如果table为空，初始化；否则，根据hash值计算得到数组索引i，如果tab[i]为空，直接新建节点Node即可。注：tab[i]实质为链表或者红黑树的首节点。</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果tab[i]不为空并且hash值为MOVED，说明该链表正在进行transfer操作，返回扩容完成后的table。</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 针对首个节点进行加锁操作，而不是segment，进一步减少线程冲突</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// 如果在链表中找到值为key的节点e，直接设置e.val = value即可。</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 如果没有找到值为key的节点，直接新建Node并加入链表即可。</span></span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果首节点为TreeBin类型，说明为红黑树结构，执行putTreeVal操作。</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果节点数&gt;＝8，那么转换链表结构为红黑树结构。</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计数增加1，有可能触发transfer操作(扩容)。</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ConcurrentHashMap-的实战"><a href="#ConcurrentHashMap-的实战" class="headerlink" title="ConcurrentHashMap 的实战"></a>ConcurrentHashMap 的实战</h4><blockquote>
<p>示例摘自：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">《Java 业务开发常见错误 100 例》</a></p>
</blockquote>
<h5 id="ConcurrentHashMap-错误示例"><a href="#ConcurrentHashMap-错误示例" class="headerlink" title="ConcurrentHashMap 错误示例"></a>ConcurrentHashMap 错误示例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//线程个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">//总元素数量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ITEM_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ConcurrentHashMap&lt;String, Long&gt; concurrentHashMap = getData(ITEM_COUNT - <span class="number">100</span>);</span><br><span class="line">    <span class="comment">//初始900个元素</span></span><br><span class="line">    System.out.println(<span class="string">&quot;init size:&quot;</span> + concurrentHashMap.size());</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(THREAD_COUNT);</span><br><span class="line">    <span class="comment">//使用线程池并发处理逻辑</span></span><br><span class="line">    forkJoinPool.execute(() -&gt; IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>).parallel().forEach(i -&gt; &#123;</span><br><span class="line">        <span class="comment">//查询还需要补充多少个元素</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">gap</span> <span class="operator">=</span> ITEM_COUNT - concurrentHashMap.size();</span><br><span class="line">        System.out.println(<span class="string">&quot;gap size:&quot;</span> + gap);</span><br><span class="line">        <span class="comment">//补充元素</span></span><br><span class="line">        concurrentHashMap.putAll(getData(gap));</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">//等待所有任务完成</span></span><br><span class="line">    forkJoinPool.shutdown();</span><br><span class="line">    forkJoinPool.awaitTermination(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">    <span class="comment">//最后元素个数会是1000吗？</span></span><br><span class="line">    System.out.println(<span class="string">&quot;finish size:&quot;</span> + concurrentHashMap.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Long&gt; <span class="title function_">getData</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LongStream.rangeClosed(<span class="number">1</span>, count)</span><br><span class="line">        .boxed()</span><br><span class="line">        .collect(</span><br><span class="line">            Collectors.toConcurrentMap(</span><br><span class="line">                i -&gt; UUID.randomUUID().toString(),</span><br><span class="line">                i -&gt; i,</span><br><span class="line">                (o1, o2) -&gt; o1,</span><br><span class="line">                ConcurrentHashMap::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始大小 900 符合预期，还需要填充 100 个元素。</p>
<p>预期结果为 1000 个元素，实际大于 1000 个元素。</p>
<p>【分析】</p>
<p>ConcurrentHashMap 对外提供的方法或能力的限制：</p>
<ul>
<li>使用了 ConcurrentHashMap，不代表对它的多个操作之间的状态是一致的，是没有其他线程在操作它的，如果需要确保需要手动加锁。</li>
<li>诸如 size、isEmpty 和 containsValue 等聚合方法，在并发情况下可能会反映 ConcurrentHashMap 的中间状态。因此在并发情况下，这些方法的返回值只能用作参考，而不能用于流程控制。显然，利用 size 方法计算差异值，是一个流程控制。</li>
<li>诸如 putAll 这样的聚合方法也不能确保原子性，在 putAll 的过程中去获取数据可能会获取到部分数据。</li>
</ul>
<h5 id="ConcurrentHashMap-错误示例修正-1-0-版"><a href="#ConcurrentHashMap-错误示例修正-1-0-版" class="headerlink" title="ConcurrentHashMap 错误示例修正 1.0 版"></a>ConcurrentHashMap 错误示例修正 1.0 版</h5><p>通过 synchronized 加锁，当然可以保证数据一致性，但是牺牲了 ConcurrentHashMap 的性能，没哟真正发挥出 ConcurrentHashMap 的特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//线程个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">//总元素数量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ITEM_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ConcurrentHashMap&lt;String, Long&gt; concurrentHashMap = getData(ITEM_COUNT - <span class="number">100</span>);</span><br><span class="line">    <span class="comment">//初始900个元素</span></span><br><span class="line">    System.out.println(<span class="string">&quot;init size:&quot;</span> + concurrentHashMap.size());</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(THREAD_COUNT);</span><br><span class="line">    <span class="comment">//使用线程池并发处理逻辑</span></span><br><span class="line">    forkJoinPool.execute(() -&gt; IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>).parallel().forEach(i -&gt; &#123;</span><br><span class="line">        <span class="comment">//查询还需要补充多少个元素</span></span><br><span class="line">        <span class="keyword">synchronized</span> (concurrentHashMap) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">gap</span> <span class="operator">=</span> ITEM_COUNT - concurrentHashMap.size();</span><br><span class="line">            System.out.println(<span class="string">&quot;gap size:&quot;</span> + gap);</span><br><span class="line">            <span class="comment">//补充元素</span></span><br><span class="line">            concurrentHashMap.putAll(getData(gap));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">//等待所有任务完成</span></span><br><span class="line">    forkJoinPool.shutdown();</span><br><span class="line">    forkJoinPool.awaitTermination(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">    <span class="comment">//最后元素个数会是1000吗？</span></span><br><span class="line">    System.out.println(<span class="string">&quot;finish size:&quot;</span> + concurrentHashMap.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Long&gt; <span class="title function_">getData</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LongStream.rangeClosed(<span class="number">1</span>, count)</span><br><span class="line">        .boxed()</span><br><span class="line">        .collect(</span><br><span class="line">            Collectors.toConcurrentMap(</span><br><span class="line">                i -&gt; UUID.randomUUID().toString(),</span><br><span class="line">                i -&gt; i,</span><br><span class="line">                (o1, o2) -&gt; o1,</span><br><span class="line">                ConcurrentHashMap::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ConcurrentHashMap-错误示例修正-2-0-版"><a href="#ConcurrentHashMap-错误示例修正-2-0-版" class="headerlink" title="ConcurrentHashMap 错误示例修正 2.0 版"></a>ConcurrentHashMap 错误示例修正 2.0 版</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//循环次数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">LOOP_COUNT</span> <span class="operator">=</span> <span class="number">10000000</span>;</span><br><span class="line"><span class="comment">//线程个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">//总元素数量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ITEM_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">    stopWatch.start(<span class="string">&quot;normaluse&quot;</span>);</span><br><span class="line">    Map&lt;String, Long&gt; normaluse = normaluse();</span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    Assert.isTrue(normaluse.size() == ITEM_COUNT, <span class="string">&quot;normaluse size error&quot;</span>);</span><br><span class="line">    Assert.isTrue(normaluse.values().stream()</span><br><span class="line">            .mapToLong(aLong -&gt; aLong).reduce(<span class="number">0</span>, Long::sum) == LOOP_COUNT</span><br><span class="line">        , <span class="string">&quot;normaluse count error&quot;</span>);</span><br><span class="line">    stopWatch.start(<span class="string">&quot;gooduse&quot;</span>);</span><br><span class="line">    Map&lt;String, Long&gt; gooduse = gooduse();</span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    Assert.isTrue(gooduse.size() == ITEM_COUNT, <span class="string">&quot;gooduse size error&quot;</span>);</span><br><span class="line">    Assert.isTrue(gooduse.values().stream()</span><br><span class="line">            .mapToLong(l -&gt; l)</span><br><span class="line">            .reduce(<span class="number">0</span>, Long::sum) == LOOP_COUNT</span><br><span class="line">        , <span class="string">&quot;gooduse count error&quot;</span>);</span><br><span class="line">    System.out.println(stopWatch.prettyPrint());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Long&gt; <span class="title function_">normaluse</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ConcurrentHashMap&lt;String, Long&gt; freqs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(ITEM_COUNT);</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(THREAD_COUNT);</span><br><span class="line">    forkJoinPool.execute(() -&gt; IntStream.rangeClosed(<span class="number">1</span>, LOOP_COUNT).parallel().forEach(i -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;item&quot;</span> + ThreadLocalRandom.current().nextInt(ITEM_COUNT);</span><br><span class="line">            <span class="keyword">synchronized</span> (freqs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (freqs.containsKey(key)) &#123;</span><br><span class="line">                    freqs.put(key, freqs.get(key) + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    freqs.put(key, <span class="number">1L</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line">    forkJoinPool.shutdown();</span><br><span class="line">    forkJoinPool.awaitTermination(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">    <span class="keyword">return</span> freqs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Long&gt; <span class="title function_">gooduse</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ConcurrentHashMap&lt;String, LongAdder&gt; freqs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(ITEM_COUNT);</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(THREAD_COUNT);</span><br><span class="line">    forkJoinPool.execute(() -&gt; IntStream.rangeClosed(<span class="number">1</span>, LOOP_COUNT).parallel().forEach(i -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;item&quot;</span> + ThreadLocalRandom.current().nextInt(ITEM_COUNT);</span><br><span class="line">            freqs.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">LongAdder</span>()).increment();</span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br><span class="line">    forkJoinPool.shutdown();</span><br><span class="line">    forkJoinPool.awaitTermination(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">    <span class="keyword">return</span> freqs.entrySet().stream()</span><br><span class="line">        .collect(Collectors.toMap(</span><br><span class="line">            e -&gt; e.getKey(),</span><br><span class="line">            e -&gt; e.getValue().longValue())</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h3><p><code>CopyOnWriteArrayList</code> 是线程安全的 <code>ArrayList</code>。<code>CopyOnWrite</code> 字面意思为<strong>写的时候会将共享变量新复制一份</strong>出来。复制的好处在于<strong>读操作是无锁的</strong>（也就是无阻塞）。</p>
<p>CopyOnWriteArrayList <strong>仅适用于写操作非常少的场景</strong>，而且能够容忍读写的短暂不一致。如果读写比例均衡或者有大量写操作的话，使用 CopyOnWriteArrayList 的性能会非常糟糕。</p>
<h4 id="CopyOnWriteArrayList-原理"><a href="#CopyOnWriteArrayList-原理" class="headerlink" title="CopyOnWriteArrayList 原理"></a>CopyOnWriteArrayList 原理</h4><p>CopyOnWriteArrayList 内部维护了一个数组，成员变量 array 就指向这个内部数组，所有的读操作都是基于 array 进行的，如下图所示，迭代器 Iterator 遍历的就是 array 数组。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200702204541.png" alt="img"></p>
<ul>
<li>lock - 执行写时复制操作，需要使用可重入锁加锁</li>
<li>array - 对象数组，用于存放元素</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The lock protecting all mutators */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">transient</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The array, accessed only via getArray/setArray. */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/CopyOnWriteArrayList.png" alt="img"></p>
<p>（1）读操作</p>
<p>在 <code>CopyOnWriteAarrayList</code> 中，读操作不同步，因为它们在内部数组的快照上工作，所以多个迭代器可以同时遍历而不会相互阻塞（图 1,2,4）。</p>
<p>CopyOnWriteArrayList 的读操作是不用加锁的，性能很高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">get</span><span class="params">(Object[] a, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）写操作</p>
<p>所有的写操作都是同步的。他们在备份数组（图 3）的副本上工作。写操作完成后，后备阵列将被替换为复制的阵列，并释放锁定。支持数组变得易变，所以替换数组的调用是原子（图 5）。</p>
<p>写操作后创建的迭代器将能够看到修改的结构（图 6,7）。</p>
<p>写时复制集合返回的迭代器不会抛出 <code>ConcurrentModificationException</code>，因为它们在数组的快照上工作，并且无论后续的修改（2,4）如何，都会像迭代器创建时那样完全返回元素。</p>
<p><strong>添加操作</strong> - 添加的逻辑很简单，先将原容器 copy 一份，然后在新副本上执行写操作，之后再切换引用。当然此过程是要加锁的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">//ReentrantLock加锁，保证线程安全</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="comment">//拷贝原容器，长度为原容器长度加一</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//在新副本上执行添加操作</span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">//将原容器引用指向新副本</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//解锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>删除操作</strong> - 删除操作同理，将除要删除元素之外的其他元素拷贝到新副本中，然后切换引用，将原容器引用指向新副本。同属写操作，需要加锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="comment">//加锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="type">E</span> <span class="variable">oldValue</span> <span class="operator">=</span> get(elements, index);</span><br><span class="line">        <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> len - index - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//如果要删除的是列表末端数据，拷贝前len-1个数据到新副本上，再切换引用</span></span><br><span class="line">            setArray(Arrays.copyOf(elements, len - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则，将除要删除元素之外的其他元素拷贝到新副本中，并切换引用</span></span><br><span class="line">            Object[] newElements = <span class="keyword">new</span> <span class="title class_">Object</span>[len - <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            System.arraycopy(elements, index + <span class="number">1</span>, newElements, index,</span><br><span class="line">                              numMoved);</span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//解锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CopyOnWriteArrayList-示例"><a href="#CopyOnWriteArrayList-示例" class="headerlink" title="CopyOnWriteArrayList 示例"></a>CopyOnWriteArrayList 示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyOnWriteArrayListDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReadTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; list;</span><br><span class="line"></span><br><span class="line">        ReadTask(List&lt;String&gt; list) &#123;</span><br><span class="line">            <span class="built_in">this</span>.list = list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String str : list) &#123;</span><br><span class="line">                System.out.println(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WriteTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; list;</span><br><span class="line">        <span class="type">int</span> index;</span><br><span class="line"></span><br><span class="line">        WriteTask(List&lt;String&gt; list, <span class="type">int</span> index) &#123;</span><br><span class="line">            <span class="built_in">this</span>.list = list;</span><br><span class="line">            <span class="built_in">this</span>.index = index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            list.remove(index);</span><br><span class="line">            list.add(index, <span class="string">&quot;write_&quot;</span> + index);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NUM</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// ArrayList 在并发迭代访问时会抛出 ConcurrentModificationException 异常</span></span><br><span class="line">        <span class="comment">// List&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line">        CopyOnWriteArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; NUM; i++) &#123;</span><br><span class="line">            list.add(<span class="string">&quot;main_&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(NUM);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; NUM; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">ReadTask</span>(list));</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">WriteTask</span>(list, i));</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayListDemo</span>().run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CopyOnWriteArrayList-实战"><a href="#CopyOnWriteArrayList-实战" class="headerlink" title="CopyOnWriteArrayList 实战"></a>CopyOnWriteArrayList 实战</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WrongCopyOnWriteList</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        testRead();</span><br><span class="line">        testWrite();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">testWrite</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; copyOnWriteArrayList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; synchronizedList = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">loopCount</span> <span class="operator">=</span> <span class="number">100000</span>;</span><br><span class="line">        stopWatch.start(<span class="string">&quot;Write:copyOnWriteArrayList&quot;</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, loopCount)</span><br><span class="line">            .parallel()</span><br><span class="line">            .forEach(__ -&gt; copyOnWriteArrayList.add(ThreadLocalRandom.current().nextInt(loopCount)));</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        stopWatch.start(<span class="string">&quot;Write:synchronizedList&quot;</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, loopCount)</span><br><span class="line">            .parallel()</span><br><span class="line">            .forEach(__ -&gt; synchronizedList.add(ThreadLocalRandom.current().nextInt(loopCount)));</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        log.info(stopWatch.prettyPrint());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;copyOnWriteArrayList&quot;</span>, copyOnWriteArrayList.size());</span><br><span class="line">        result.put(<span class="string">&quot;synchronizedList&quot;</span>, synchronizedList.size());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addAll</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        list.addAll(IntStream.rangeClosed(<span class="number">1</span>, <span class="number">1000000</span>).boxed().collect(Collectors.toList()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">testRead</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; copyOnWriteArrayList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; synchronizedList = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        addAll(copyOnWriteArrayList);</span><br><span class="line">        addAll(synchronizedList);</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">loopCount</span> <span class="operator">=</span> <span class="number">1000000</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> copyOnWriteArrayList.size();</span><br><span class="line">        stopWatch.start(<span class="string">&quot;Read:copyOnWriteArrayList&quot;</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, loopCount)</span><br><span class="line">            .parallel()</span><br><span class="line">            .forEach(__ -&gt; copyOnWriteArrayList.get(ThreadLocalRandom.current().nextInt(count)));</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        stopWatch.start(<span class="string">&quot;Read:synchronizedList&quot;</span>);</span><br><span class="line">        IntStream.range(<span class="number">0</span>, loopCount)</span><br><span class="line">            .parallel()</span><br><span class="line">            .forEach(__ -&gt; synchronizedList.get(ThreadLocalRandom.current().nextInt(count)));</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        log.info(stopWatch.prettyPrint());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        result.put(<span class="string">&quot;copyOnWriteArrayList&quot;</span>, copyOnWriteArrayList.size());</span><br><span class="line">        result.put(<span class="string">&quot;synchronizedList&quot;</span>, synchronizedList.size());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读性能差不多是写性能的一百倍。</p>
<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>Set 接口的两个实现是 CopyOnWriteArraySet 和 ConcurrentSkipListSet，使用场景可以参考前面讲述的 CopyOnWriteArrayList 和 ConcurrentSkipListMap，它们的原理都是一样的。</p>
<h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>Java 并发包里面 Queue 这类并发容器是最复杂的，你可以从以下两个维度来分类。一个维度是<strong>阻塞与非阻塞</strong>，所谓阻塞指的是：<strong>当队列已满时，入队操作阻塞；当队列已空时，出队操作阻塞</strong>。另一个维度是<strong>单端与双端</strong>，单端指的是只能队尾入队，队首出队；而双端指的是队首队尾皆可入队出队。Java 并发包里<strong>阻塞队列都用 Blocking 关键字标识，单端队列使用 Queue 标识，双端队列使用 Deque 标识</strong>。</p>
<h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p><code>BlockingQueue</code> 顾名思义，是一个<strong>阻塞队列</strong>。**<code>BlockingQueue</code> 基本都是基于锁实现<strong>。在 <code>BlockingQueue</code> 中，</strong>当队列已满时，入队操作阻塞；当队列已空时，出队操作阻塞**。</p>
<p><code>BlockingQueue</code> 接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Queue</span>&lt;E&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>核心 API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取并移除队列头结点，如果必要，其会等待直到队列出现元素</span></span><br><span class="line">E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">// 插入元素，如果队列已满，则等待直到队列出现空闲空间</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>

<p><code>BlockingQueue</code> 对插入操作、移除操作、获取元素操作提供了四种不同的方法用于不同的场景中使用：</p>
<ul>
<li>抛出异常；</li>
<li>返回特殊值（<code>null</code> 或 <code>true</code>&#x2F;<code>false</code>，取决于具体的操作）；</li>
<li>阻塞等待此操作，直到这个操作成功；</li>
<li>阻塞等待此操作，直到成功或者超时指定时间。</li>
</ul>
<p>总结如下：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Throws exception</strong></th>
<th><strong>Special value</strong></th>
<th><strong>Blocks</strong></th>
<th><strong>Times out</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Insert</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e, time, unit)</td>
</tr>
<tr>
<td>Remove</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time, unit)</td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek()</td>
<td><strong>not applicable</strong></td>
<td><strong>not applicable</strong></td>
</tr>
</tbody></table>
<p><code>BlockingQueue</code> 的各个实现类都遵循了这些规则。</p>
<p><code>BlockingQueue</code> 不接受 <code>null</code> 值元素。</p>
<p>JDK 提供了以下阻塞队列：</p>
<ul>
<li><code>ArrayBlockingQueue</code> - 一个由<strong>数组结构组成的有界阻塞队列</strong>。</li>
<li><code>LinkedBlockingQueue</code> - 一个由<strong>链表结构组成的有界阻塞队列</strong>。</li>
<li><code>PriorityBlockingQueue</code> - 一个<strong>支持优先级排序的无界阻塞队列</strong>。</li>
<li><code>SynchronousQueue</code> - 一个<strong>不存储元素的阻塞队列</strong>。</li>
<li><code>DelayQueue</code> - 一个使用优先级队列实现的无界阻塞队列。</li>
<li><code>LinkedTransferQueue</code> - 一个<strong>由链表结构组成的无界阻塞队列</strong>。</li>
</ul>
<p><code>BlockingQueue</code> 基本都是基于锁实现。</p>
<h3 id="PriorityBlockingQueue-类"><a href="#PriorityBlockingQueue-类" class="headerlink" title="PriorityBlockingQueue 类"></a>PriorityBlockingQueue 类</h3><p><code>PriorityBlockingQueue</code> 类定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PriorityBlockingQueue-要点"><a href="#PriorityBlockingQueue-要点" class="headerlink" title="PriorityBlockingQueue 要点"></a>PriorityBlockingQueue 要点</h4><ul>
<li><code>PriorityBlockingQueue</code> 可以视为 <code>PriorityQueue</code> 的线程安全版本。</li>
<li><code>PriorityBlockingQueue</code> 实现了 <code>BlockingQueue</code>，也是一个阻塞队列。</li>
<li><code>PriorityBlockingQueue</code> 实现了 <code>Serializable</code>，支持序列化。</li>
<li><code>PriorityBlockingQueue</code> 不接受 <code>null</code> 值元素。</li>
<li><code>PriorityBlockingQueue</code> 的插入操作 <code>put</code> 方法不会 block，因为它是无界队列（take 方法在队列为空的时候会阻塞）。</li>
</ul>
<h4 id="PriorityBlockingQueue-原理"><a href="#PriorityBlockingQueue-原理" class="headerlink" title="PriorityBlockingQueue 原理"></a>PriorityBlockingQueue 原理</h4><p><code>PriorityBlockingQueue</code> 有两个重要成员：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Object[] queue;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>queue</code> 是一个 <code>Object</code> 数组，用于保存 <code>PriorityBlockingQueue</code> 的元素。</li>
<li>而可重入锁 <code>lock</code> 则用于在执行插入、删除操作时，保证这个方法在当前线程释放锁之前，其他线程不能访问。</li>
</ul>
<p><code>PriorityBlockingQueue</code> 的容量虽然有初始化大小，但是不限制大小，如果当前容量已满，插入新元素时会自动扩容。</p>
<h3 id="ArrayBlockingQueue-类"><a href="#ArrayBlockingQueue-类" class="headerlink" title="ArrayBlockingQueue 类"></a>ArrayBlockingQueue 类</h3><p><code>ArrayBlockingQueue</code> 是由数组结构组成的<strong>有界阻塞队列</strong>。</p>
<h4 id="ArrayBlockingQueue-要点"><a href="#ArrayBlockingQueue-要点" class="headerlink" title="ArrayBlockingQueue 要点"></a>ArrayBlockingQueue 要点</h4><p><code>ArrayBlockingQueue</code> 类定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">// 数组的大小就决定了队列的边界，所以初始化时必须指定容量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayBlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123; <span class="comment">//... &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayBlockingQueue</span><span class="params">(<span class="type">int</span> capacity, <span class="type">boolean</span> fair)</span> &#123; <span class="comment">//... &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayBlockingQueue</span><span class="params">(<span class="type">int</span> capacity, <span class="type">boolean</span> fair, Collection&lt;? extends E&gt; c)</span> &#123; <span class="comment">//... &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li><code>ArrayBlockingQueue</code> 实现了 <code>BlockingQueue</code>，也是一个阻塞队列。</li>
<li><code>ArrayBlockingQueue</code> 实现了 <code>Serializable</code>，支持序列化。</li>
<li><code>ArrayBlockingQueue</code> 是基于数组实现的有界阻塞队列。所以初始化时必须指定容量。</li>
</ul>
<h4 id="ArrayBlockingQueue-原理"><a href="#ArrayBlockingQueue-原理" class="headerlink" title="ArrayBlockingQueue 原理"></a>ArrayBlockingQueue 原理</h4><p><code>ArrayBlockingQueue</code> 的重要成员如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于存放元素的数组</span></span><br><span class="line"><span class="keyword">final</span> Object[] items;</span><br><span class="line"><span class="comment">// 下一次读取操作的位置</span></span><br><span class="line"><span class="type">int</span> takeIndex;</span><br><span class="line"><span class="comment">// 下一次写入操作的位置</span></span><br><span class="line"><span class="type">int</span> putIndex;</span><br><span class="line"><span class="comment">// 队列中的元素数量</span></span><br><span class="line"><span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下几个就是控制并发用的同步器</span></span><br><span class="line"><span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</span><br></pre></td></tr></table></figure>

<p><code>ArrayBlockingQueue</code> 内部以 <code>final</code> 的数组保存数据，数组的大小就决定了队列的边界。</p>
<p><code>ArrayBlockingQueue</code> 实现并发同步的原理就是，读操作和写操作都需要获取到 AQS 独占锁才能进行操作。</p>
<ul>
<li>如果队列为空，这个时候读操作的线程进入到读线程队列排队，等待写线程写入新的元素，然后唤醒读线程队列的第一个等待线程。</li>
<li>如果队列已满，这个时候写操作的线程进入到写线程队列排队，等待读线程将队列元素移除，然后唤醒写线程队列的第一个等待线程。</li>
</ul>
<p>对于 <code>ArrayBlockingQueue</code>，我们可以在构造的时候指定以下三个参数：</p>
<ul>
<li>队列容量，其限制了队列中最多允许的元素个数；</li>
<li>指定独占锁是公平锁还是非公平锁。非公平锁的吞吐量比较高，公平锁可以保证每次都是等待最久的线程获取到锁；</li>
<li>可以指定用一个集合来初始化，将此集合中的元素在构造方法期间就先添加到队列中。</li>
</ul>
<h3 id="LinkedBlockingQueue-类"><a href="#LinkedBlockingQueue-类" class="headerlink" title="LinkedBlockingQueue 类"></a>LinkedBlockingQueue 类</h3><p><code>LinkedBlockingQueue</code> 是由链表结构组成的有界阻塞队列。容易被误解为无边界，但其实其行为和内部代码都是基于有界的逻辑实现的，只不过如果我们没有在创建队列时就指定容量，那么其容量限制就自动被设置为 <code>Integer.MAX_VALUE</code>，成为了无界队列。</p>
<h4 id="LinkedBlockingQueue-要点"><a href="#LinkedBlockingQueue-要点" class="headerlink" title="LinkedBlockingQueue 要点"></a>LinkedBlockingQueue 要点</h4><p><code>LinkedBlockingQueue</code> 类定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>LinkedBlockingQueue</code> 实现了 <code>BlockingQueue</code>，也是一个阻塞队列。</li>
<li><code>LinkedBlockingQueue</code> 实现了 <code>Serializable</code>，支持序列化。</li>
<li><code>LinkedBlockingQueue</code> 是基于单链表实现的阻塞队列，可以当做无界队列也可以当做有界队列来使用。</li>
<li><code>LinkedBlockingQueue</code> 中元素按照插入顺序保存（FIFO）。</li>
</ul>
<h4 id="LinkedBlockingQueue-原理"><a href="#LinkedBlockingQueue-原理" class="headerlink" title="LinkedBlockingQueue 原理"></a>LinkedBlockingQueue 原理</h4><p><code>LinkedBlockingQueue</code> 中的重要数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 队列容量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> capacity;</span><br><span class="line"><span class="comment">// 队列中的元素数量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 队头</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"><span class="comment">// 队尾</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">// take, poll, peek 等读操作的方法需要获取到这个锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// 如果读操作的时候队列是空的，那么等待 notEmpty 条件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> takeLock.newCondition();</span><br><span class="line"><span class="comment">// put, offer 等写操作的方法需要获取到这个锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// 如果写操作的时候队列是满的，那么等待 notFull 条件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> putLock.newCondition();</span><br></pre></td></tr></table></figure>

<p>这里用了两对 <code>Lock</code> 和 <code>Condition</code>，简单介绍如下：</p>
<ul>
<li><code>takeLock</code> 和 <code>notEmpty</code> 搭配：如果要获取（take）一个元素，需要获取 <code>takeLock</code> 锁，但是获取了锁还不够，如果队列此时为空，还需要队列不为空（<code>notEmpty</code>）这个条件（<code>Condition</code>）。</li>
<li><code>putLock</code> 需要和 <code>notFull</code> 搭配：如果要插入（put）一个元素，需要获取 <code>putLock</code> 锁，但是获取了锁还不够，如果队列此时已满，还需要队列不是满的（notFull）这个条件（<code>Condition</code>）。</li>
</ul>
<h3 id="SynchronousQueue-类"><a href="#SynchronousQueue-类" class="headerlink" title="SynchronousQueue 类"></a>SynchronousQueue 类</h3><p>SynchronousQueue 是<strong>不存储元素的阻塞队列</strong>。每个删除操作都要等待插入操作，反之每个插入操作也都要等待删除动作。那么这个队列的容量是多少呢？是 1 吗？其实不是的，其内部容量是 0。</p>
<p><code>SynchronousQueue</code> 定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronousQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>SynchronousQueue</code> 这个类，在线程池的实现类 <code>ScheduledThreadPoolExecutor</code> 中得到了应用。</p>
<p><code>SynchronousQueue</code> 的队列其实是虚的，即队列容量为 0。数据必须从某个写线程交给某个读线程，而不是写到某个队列中等待被消费。</p>
<p><code>SynchronousQueue</code> 中不能使用 peek 方法（在这里这个方法直接返回 null），peek 方法的语义是只读取不移除，显然，这个方法的语义是不符合 SynchronousQueue 的特征的。</p>
<p><code>SynchronousQueue</code> 也不能被迭代，因为根本就没有元素可以拿来迭代的。</p>
<p>虽然 <code>SynchronousQueue</code> 间接地实现了 Collection 接口，但是如果你将其当做 Collection 来用的话，那么集合是空的。</p>
<p>当然，<code>SynchronousQueue</code> 也不允许传递 null 值的（并发包中的容器类好像都不支持插入 null 值，因为 null 值往往用作其他用途，比如用于方法的返回值代表操作失败）。</p>
<h3 id="ConcurrentLinkedDeque-类"><a href="#ConcurrentLinkedDeque-类" class="headerlink" title="ConcurrentLinkedDeque 类"></a>ConcurrentLinkedDeque 类</h3><p><code>Deque</code> 的侧重点是支持对队列头尾都进行插入和删除，所以提供了特定的方法，如:</p>
<ul>
<li>尾部插入时需要的 <code>addLast(e)</code>、<code>offerLast(e)</code>。</li>
<li>尾部删除所需要的 <code>removeLast()</code>、<code>pollLast()</code>。</li>
</ul>
<h3 id="Queue-的并发应用"><a href="#Queue-的并发应用" class="headerlink" title="Queue 的并发应用"></a>Queue 的并发应用</h3><p>Queue 被广泛使用在生产者 - 消费者场景。而在并发场景，利用 <code>BlockingQueue</code> 的阻塞机制，可以减少很多并发协调工作。</p>
<p>这么多并发 Queue 的实现，如何选择呢？</p>
<ul>
<li>考虑应用场景中对队列边界的要求。<code>ArrayBlockingQueue</code> 是有明确的容量限制的，而 <code>LinkedBlockingQueue</code> 则取决于我们是否在创建时指定，<code>SynchronousQueue</code> 则干脆不能缓存任何元素。</li>
<li>从空间利用角度，数组结构的 <code>ArrayBlockingQueue</code> 要比 <code>LinkedBlockingQueue</code> 紧凑，因为其不需要创建所谓节点，但是其初始分配阶段就需要一段连续的空间，所以初始内存需求更大。</li>
<li>通用场景中，<code>LinkedBlockingQueue</code> 的吞吐量一般优于 <code>ArrayBlockingQueue</code>，因为它实现了更加细粒度的锁操作。</li>
<li><code>ArrayBlockingQueue</code> 实现比较简单，性能更好预测，属于表现稳定的“选手”。</li>
<li>可能令人意外的是，很多时候 <code>SynchronousQueue</code> 的性能表现，往往大大超过其他实现，尤其是在队列元素较小的场景。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/10484692/">《Java 并发编程实战》</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">《Java 并发编程的艺术》</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010425776/article/details/54890215">https://blog.csdn.net/u010425776/article/details/54890215</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangxiaotongfan/article/details/52074160">https://blog.csdn.net/wangxiaotongfan/article/details/52074160</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/hosee/blog/675884">https://my.oschina.net/hosee/blog/675884</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c0642afe03e0">https://www.jianshu.com/p/c0642afe03e0</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f6730d5784ad">https://www.jianshu.com/p/f6730d5784ad</a></li>
<li><a target="_blank" rel="noopener" href="http://www.javarticles.com/2012/06/copyonwritearraylist.html">http://www.javarticles.com/2012/06/copyonwritearraylist.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xrq730/p/5020760.html">https://www.cnblogs.com/xrq730/p/5020760.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/leesf456/p/5547853.html">https://www.cnblogs.com/leesf456/p/5547853.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/chengxiao/p/6881974.html">http://www.cnblogs.com/chengxiao/p/6881974.html</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/dolphin0520/p/3933404.html">http://www.cnblogs.com/dolphin0520/p/3933404.html</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5b551e8df265da0f84562403">HashMap? ConcurrentHashMap? 相信看完这篇没人能难住你！</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/4907dc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/4907dc/" class="post-title-link" itemprop="url">深入剖析共识性算法 Raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-01 22:07:00" itemprop="dateCreated datePublished" datetime="2020-02-01T22:07:00+08:00">2020-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA/" itemprop="url" rel="index"><span itemprop="name">分布式理论</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="深入剖析共识性算法-Raft"><a href="#深入剖析共识性算法-Raft" class="headerlink" title="深入剖析共识性算法 Raft"></a>深入剖析共识性算法 Raft</h1><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200201221202.png" alt="img"></p>
<h2 id="Raft-简介"><a href="#Raft-简介" class="headerlink" title="Raft 简介"></a>Raft 简介</h2><p><strong><a target="_blank" rel="noopener" href="https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf">Raft</a> 是一种为了管理日志复制的分布式共识性算法</strong>。从本质上说，<strong>Raft 算法是通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致</strong>。</p>
<p><a target="_blank" rel="noopener" href="https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf">Raft</a> 出现之前，Paxos 一直是分布式共识性算法的标准。Paxos <strong>难以理解，更难以实现</strong>。Raft 的设计目标是简化 Paxos，使得算法<strong>既容易理解，也容易实现</strong>。</p>
<p>Paxos 和 Raft 都是分布式共识性算法，这个过程如同投票选举领袖（Leader），参选者（Candidate）需要说服大多数投票者（Follower）投票给他，一旦选举出领袖，就由领袖发号施令。Paxos 和 Raft 的区别在于选举的具体过程不同。</p>
<p><strong>Raft 可以解决分布式 CAP 理论中的 CP</strong>，即 <em>一致性（C：Consistency）</em> 和 _分区容忍性（P：Partition Tolerance）_，并不能解决 <em>可用性（A：Availability）</em> 的问题。</p>
<h3 id="分布式共识性"><a href="#分布式共识性" class="headerlink" title="分布式共识性"></a>分布式共识性</h3><p>分布式共识性 (distributed consensus) 是分布式系统中最基本的问题，用来保证一个分布式系统的可靠性以及容错能力。简单来说，**<em>分布式共识性是指多个服务器的保持状态一致</em>**。</p>
<p>在分布式系统中，可能出现各种意外（断电、网络拥塞、CPU&#x2F;内存耗尽等等），使得服务器宕机或无法访问，最终导致无法和其他服务器保持状态一致。为了应对这种情况，就需要有一种一致性协议来进行容错，使得分布式系统中即使有部分服务器宕机或无法访问，整体依然可以对外提供服务。</p>
<p>以容错方式达成一致，自然不能要求所有服务器都达成一致状态，只要<strong>超过半数以上</strong>的服务器达成一致就可以了。假设有 N 台服务器， 大于等于 <code>N/2 + 1</code> 台服务器就算是半数以上了 。</p>
<h3 id="复制状态机"><a href="#复制状态机" class="headerlink" title="复制状态机"></a>复制状态机</h3><p><strong><code>复制状态机（Replicated State Machines）</code></strong> 是指一组服务器上的状态机产生相同状态的副本，并且在一些机器宕掉的情况下也可以继续运行。一致性算法管理着来自客户端指令的复制日志。状态机从日志中处理相同顺序的相同指令，所以产生的结果也是相同的。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200131233906.png" alt="img"></p>
<p>复制状态机通常都是基于复制日志实现的，如上图。每一个服务器存储一个包含一系列指令的日志，并且按照日志的顺序进行执行。每一个日志都按照相同的顺序包含相同的指令，所以每一个服务器都执行相同的指令序列。因为每个状态机都是确定的，每一次执行操作都产生相同的状态和同样的序列。</p>
<p>保证复制日志相同就是一致性算法的工作了。在一台服务器上，一致性模块接收客户端发送来的指令然后增加到自己的日志中去。它和其他服务器上的一致性模块进行通信来保证每一个服务器上的日志最终都以相同的顺序包含相同的请求，尽管有些服务器会宕机。一旦指令被正确的复制，每一个服务器的状态机按照日志顺序处理他们，然后输出结果被返回给客户端。因此，服务器集群看起来形成一个高可靠的状态机。</p>
<p>实际系统中使用的一致性算法通常含有以下特性：</p>
<ul>
<li><strong>安全性保证</strong>（绝对不会返回一个错误的结果）：在非拜占庭错误情况下，包括网络延迟、分区、丢包、冗余和乱序等错误都可以保证正确。</li>
<li><strong>可用性</strong>：集群中只要有大多数的机器可运行并且能够相互通信、和客户端通信，就可以保证可用。因此，一个典型的包含 5 个节点的集群可以容忍两个节点的失败。服务器被停止就认为是失败。他们当有稳定的存储的时候可以从状态中恢复回来并重新加入集群。</li>
<li><strong>不依赖时序来保证一致性</strong>：物理时钟错误或者极端的消息延迟只有在最坏情况下才会导致可用性问题。</li>
<li>通常情况下，一条指令可以尽可能快的在集群中大多数节点响应一轮远程过程调用时完成。小部分比较慢的节点不会影响系统整体的性能。</li>
</ul>
<h3 id="RAFT-应用"><a href="#RAFT-应用" class="headerlink" title="RAFT 应用"></a>RAFT 应用</h3><p>RAFT 可以做什么？</p>
<p>通过 RAFT 提供的复制状态机，可以解决分布式系统的复制、修复、节点管理等问题。Raft 极大的简化当前分布式系统的设计与实现，让开发者只关注于业务逻辑，将其抽象实现成对应的状态机即可。基于这套框架，可以构建很多分布式应用：</p>
<ul>
<li>分布式存储系统：比如分布式消息队列、分布式块系统、分布式文件系统、分布式表格系统等。代表有：Redis、Etcd、Consul</li>
<li>高可靠元信息管理：比如各类 Master 模块的 HA</li>
</ul>
<h2 id="Raft-基础"><a href="#Raft-基础" class="headerlink" title="Raft 基础"></a>Raft 基础</h2><p>Raft 将一致性问题分解成了三个子问题：</p>
<ul>
<li><strong>选举 Leader</strong></li>
<li><strong>日志复制</strong></li>
<li><strong>安全性</strong></li>
</ul>
<p>在后续章节，会详细讲解这个子问题。现在，先了解一下 Raft 的一些核心概念。</p>
<h3 id="服务器角色"><a href="#服务器角色" class="headerlink" title="服务器角色"></a>服务器角色</h3><p>在 Raft 中，任何时刻，每个服务器都处于这三个角色之一 ：</p>
<ul>
<li><strong><code>Leader</code></strong> - 领导者，通常一个系统中是<strong>一主（Leader）多从（Follower）</strong>。Leader <strong>负责处理所有的客户端请求</strong>。</li>
<li><strong><code>Follower</code></strong> - 跟随者，<strong>不会发送任何请求</strong>，只是简单的 <strong>响应来自 Leader 或者 Candidate 的请求</strong>。</li>
<li><strong><code>Candidate</code></strong> - 参选者，选举新 Leader 时的临时角色。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200131215742.png" alt="img"></p>
<blockquote>
<p>:bulb: 图示说明：</p>
<ul>
<li>Follower 只响应来自其他服务器的请求。在一定时限内，如果 Follower 接收不到消息，就会转变成 Candidate，并发起选举。</li>
<li>Candidate 向 Follower 发起投票请求，如果获得集群中半数以上的选票，就会转变为 Leader。</li>
<li>在一个 Term 内，Leader 始终保持不变，直到下线了。Leader 需要周期性向所有 Follower 发送心跳消息，以阻止 Follower 转变为 Candidate。</li>
</ul>
</blockquote>
<h3 id="任期"><a href="#任期" class="headerlink" title="任期"></a>任期</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200131220742.png" alt="img"></p>
<p>Raft 把时间分割成任意长度的 <strong><em><code>任期（Term）</code></em><strong>，任期用连续的整数标记。每一段任期从一次</strong>选举</strong>开始。<strong>Raft 保证了在一个给定的任期内，最多只有一个领导者</strong>。</p>
<ul>
<li>如果选举成功，Leader 会管理整个集群直到任期结束。</li>
<li>如果选举失败，那么这个任期就会因为没有 Leader 而结束。</li>
</ul>
<p><strong>不同服务器节点观察到的任期转换状态可能不一样</strong>：</p>
<ul>
<li>服务器节点可能观察到多次的任期转换。</li>
<li>服务器节点也可能观察不到任何一次任期转换。</li>
</ul>
<p><strong>任期在 Raft 算法中充当逻辑时钟的作用，使得服务器节点可以查明一些过期的信息（比如过期的 Leader）。每个服务器节点都会存储一个当前任期号，这一编号在整个时期内单调的增长。当服务器之间通信的时候会交换当前任期号。</strong></p>
<ul>
<li>如果一个服务器的当前任期号比其他人小，那么他会更新自己的编号到较大的编号值。</li>
<li>如果一个 Candidate 或者 Leader 发现自己的任期号过期了，那么他会立即恢复成跟随者状态。</li>
<li>如果一个节点接收到一个包含过期的任期号的请求，那么他会直接拒绝这个请求。</li>
</ul>
<h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>Raft 算法中服务器节点之间的通信使用 **_<code>远程过程调用（RPC）</code>_**。</p>
<p>基本的一致性算法只需要两种 RPC：</p>
<ul>
<li><strong><code>RequestVote RPC</code></strong> - 请求投票 RPC，由 Candidate 在选举期间发起。</li>
<li><strong><code>AppendEntries RPC</code></strong> - 附加条目 RPC，由 Leader 发起，用来复制日志和提供一种心跳机制。</li>
</ul>
<h2 id="选举-Leader"><a href="#选举-Leader" class="headerlink" title="选举 Leader"></a>选举 Leader</h2><h3 id="选举规则"><a href="#选举规则" class="headerlink" title="选举规则"></a>选举规则</h3><p><strong>领导者心跳消息</strong>：Raft 使用一种心跳机制来触发 Leader 选举。<strong>Leader 需要周期性的向所有 Follower 发送心跳消息</strong>，以此维持 Leader 身份。</p>
<p><strong>随机的竞选超时时间</strong>：每个 Follower 都设置了一个<strong>随机的竞选超时时间</strong>，一般为 <code>150ms ~ 300ms</code>，如果在竞选超时时间内没有收到 Leader 的心跳消息，就会认为当前 Term 没有可用的 Leader，并发起选举来选出新的 Leader。开始一次选举过程，Follower 先要增加自己的当前 Term 号，并<strong>转换为 Candidate</strong>。</p>
<p>Candidate 会并行的<strong>向集群中的所有服务器节点发送投票请求（<code>RequestVote RPC</code>）</strong>，它会保持当前状态直到以下三件事情之一发生：</p>
<ul>
<li><strong>自己成为 Leader</strong></li>
<li><strong>其他的服务器成为 Leader</strong></li>
<li><strong>没有任何服务器成为 Leader</strong></li>
</ul>
<h4 id="自己成为-Leader"><a href="#自己成为-Leader" class="headerlink" title="自己成为 Leader"></a>自己成为 Leader</h4><ul>
<li>当一个 Candidate 从整个集群<strong>半数以上</strong>的服务器节点获得了针对同一个 Term 的选票，那么它就赢得了这次选举并成为 Leader。每个服务器最多会对一个 Term 投出一张选票，按照<strong>先来先服务（FIFO）的原则</strong>。_要求半数以上选票的规则确保了最多只会有一个 Candidate 赢得此次选举_。</li>
<li>一旦 Candidate 赢得选举，就立即成为 Leader。然后它会向其他的服务器发送心跳消息来建立自己的权威并且阻止新的领导人的产生。</li>
</ul>
<h4 id="其他的服务器成为-Leader"><a href="#其他的服务器成为-Leader" class="headerlink" title="其他的服务器成为 Leader"></a>其他的服务器成为 Leader</h4><p>等待投票期间，Candidate 可能会从其他的服务器接收到声明它是 Leader 的 <code>AppendEntries RPC</code>。</p>
<ul>
<li>如果这个 Leader 的 Term 号（包含在此次的 RPC 中）不小于 Candidate 当前的 Term，那么 Candidate 会承认 Leader 合法并回到 Follower 状态。</li>
<li>如果此次 RPC 中的 Term 号比自己小，那么 Candidate 就会拒绝这个消息并继续保持 Candidate 状态。</li>
</ul>
<h4 id="没有任何服务器成为-Leader"><a href="#没有任何服务器成为-Leader" class="headerlink" title="没有任何服务器成为 Leader"></a>没有任何服务器成为 Leader</h4><p>如果有多个 Follower 同时成为 Candidate，那么选票可能会被瓜分以至于没有 Candidate 可以赢得半数以上的投票。当这种情况发生的时候，每一个 Candidate 都会竞选超时，然后通过增加当前 Term 号来开始一轮新的选举。然而，没有其他机制的话，选票可能会被无限的重复瓜分。</p>
<p>Raft 算法使用随机选举超时时间的方法来确保很少会发生选票瓜分的情况，就算发生也能很快的解决。为了阻止选票起初就被瓜分，竞选超时时间是一个<strong>随机的时间</strong>，在一个固定的区间（例如 150-300 毫秒）随机选择，这样可以把选举都分散开。</p>
<ul>
<li>以至于在大多数情况下，只有一个服务器会超时，然后它赢得选举，成为 Leader，并在其他服务器超时之前发送心跳包。</li>
<li>同样的机制也被用在选票瓜分的情况下：每一个 Candidate 在开始一次选举的时候会重置一个随机的选举超时时间，然后在超时时间内等待投票的结果；这样减少了在新的选举中另外的选票瓜分的可能性。</li>
</ul>
<hr>
<p>理解了上面的选举规则后，我们通过动图来加深认识。</p>
<h3 id="单-Candidate-选举"><a href="#单-Candidate-选举" class="headerlink" title="单 Candidate 选举"></a>单 Candidate 选举</h3><p>（1）下图表示一个分布式系统的最初阶段，此时只有 Follower，没有 Leader。Follower A 等待一个随机的选举超时时间之后，没收到 Leader 发来的心跳消息。因此，将 Term 由 0 增加为 1，转换为 Candidate，进入选举状态。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-01.gif" alt="img"></p>
<p>（2）此时，A 向所有其他节点发送投票请求。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-02.gif" alt="img"></p>
<p>（3）其它节点会对投票请求进行回复，如果超过半数以上的节点投票了，那么该 Candidate 就会立即变成 Term 为 1 的 Leader。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-03.gif" alt="img"></p>
<p>（4）Leader 会周期性地发送心跳消息给所有 Follower，Follower 接收到心跳包，会重新开始计时。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-04.gif" alt="img"></p>
<h3 id="多-Candidate-选举"><a href="#多-Candidate-选举" class="headerlink" title="多 Candidate 选举"></a>多 Candidate 选举</h3><p>（1）如果有多个 Follower 成为 Candidate，并且所获得票数相同，那么就需要重新开始投票。例如下图中 Candidate B 和 Candidate D 都发起 Term 为 4 的选举，且都获得两票，因此需要重新开始投票。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-multi-candidate-01.gif" alt="img"></p>
<p>（2）当重新开始投票时，由于每个节点设置的随机竞选超时时间不同，因此能下一次再次出现多个 Candidate 并获得同样票数的概率很低。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-multi-candidate-02.gif" alt="img"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Raft 算法通过：领导者心跳消息、随机选举超时时间、得到大多数选票才通过原则、任期最新者优先、先来先服务的投票原则、等，保证了一个任期只有一位领导，也极大地减少了选举失败的情况。</p>
<h2 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h2><h3 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h3><p><strong>日志由含日志索引（log index）的日志条目（log entry）组成</strong>。每个日志条目包含它被创建时的 Term 号（下图中方框中的数字），和一个复制状态机需要执行的指令。如果一个日志条目被复制到半数以上的服务器上，就被认为可以提交（Commit）了。</p>
<ul>
<li>日志条目中的 Term 号被用来检查是否出现不一致的情况，它实际上是创建这条日志的领导者的任期编号。</li>
<li>日志条目中的日志索引用来表明它在日志中的位置，它是一个单调递增的整数。</li>
</ul>
<p><img src="https://pic3.zhimg.com/80/v2-ee29a89e4eb63468e142bb6103dbe4de_hd.jpg" alt="img"></p>
<p>Raft 日志同步保证如下两点：</p>
<ul>
<li>如果不同日志中的两个日志条目有着相同的日志索引和 Term，则<strong>它们所存储的命令是相同的</strong>。<ul>
<li>这个特性基于这条原则：Leader 最多在一个 Term 内、在指定的一个日志索引上创建一条日志条目，同时日志条目在日志中的位置也从来不会改变。</li>
</ul>
</li>
<li>如果不同日志中的两个日志条目有着相同的日志索引和 Term，则<strong>它们之前的所有条目都是完全一样的</strong>。<ul>
<li>这个特性由 <code>AppendEntries RPC</code> 的一个简单的一致性检查所保证。在发送 <code>AppendEntries RPC</code> 时，Leader 会把新日志条目之前的日志条目的日志索引和 Term 号一起发送。如果 Follower 在它的日志中找不到包含相同日志索引和 Term 号的日志条目，它就会拒绝接收新的日志条目。</li>
</ul>
</li>
</ul>
<h3 id="日志复制流程"><a href="#日志复制流程" class="headerlink" title="日志复制流程"></a>日志复制流程</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200201115848.png" alt="img"></p>
<ol>
<li>Leader 负责处理所有客户端的请求。</li>
<li>Leader 把请求作为日志条目加入到它的日志中，然后并行的向其他服务器发送 <code>AppendEntries RPC</code> 请求，要求 Follower 复制日志条目。</li>
<li>Follower 复制成功后，返回确认消息。</li>
<li>当这个日志条目被半数以上的服务器复制后，Leader 提交这个日志条目到它的复制状态机，并向客户端返回执行结果。</li>
</ol>
<blockquote>
<p>注意：如果 Follower 崩溃或者运行缓慢，再或者网络丢包，Leader 会不断的重复尝试发送 <code>AppendEntries RPC</code> 请求 （尽管已经回复了客户端），直到所有的跟随者都最终复制了所有的日志条目。</p>
</blockquote>
<p>下面，通过一组动图来加深认识：</p>
<p>（1）来自客户端的修改都会被传入 Leader。注意该修改还未被提交，只是写入日志中。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-01.gif" alt="img"></p>
<p>（2）Leader 会把修改复制到所有 Follower。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-02.gif" alt="img"></p>
<p>（3）Leader 会等待大多数的 Follower 也进行了修改，然后才将修改提交。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-03.gif" alt="img"></p>
<p>（4）此时 Leader 会通知的所有 Follower 让它们也提交修改，此时所有节点的值达成一致。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-04.gif" alt="img"></p>
<h3 id="日志一致性"><a href="#日志一致性" class="headerlink" title="日志一致性"></a>日志一致性</h3><p>一般情况下，Leader 和 Followers 的日志保持一致，因此日志条目一致性检查通常不会失败。然而，Leader 崩溃可能会导致日志不一致：旧的 Leader 可能没有完全复制完日志中的所有条目。</p>
<h4 id="Leader-和-Follower-日志不一致的可能"><a href="#Leader-和-Follower-日志不一致的可能" class="headerlink" title="Leader 和 Follower 日志不一致的可能"></a>Leader 和 Follower 日志不一致的可能</h4><p>Leader 和 Follower 可能存在多种日志不一致的可能。</p>
<p><img src="https://pic4.zhimg.com/80/v2-d36c587901391cae50788061f568d24f_hd.jpg" alt="img"></p>
<blockquote>
<p>:bulb: 图示说明：</p>
<p>上图阐述了 Leader 和 Follower 可能存在多种日志不一致的可能，每一个方框表示一个日志条目，里面的数字表示任期号 。</p>
<p>当一个 Leader 成功当选时，Follower 可能出现以下情况（a-f）：</p>
<ul>
<li><strong>存在未更新日志条目</strong>，如（a、b）。</li>
<li><strong>存在未提交日志条目</strong>，如（c、d）。</li>
<li>或<strong>两种情况都存在</strong>，如（e、f）。</li>
</ul>
<p>_例如，场景 f 可能会这样发生，某服务器在 Term2 的时候是 Leader，已附加了一些日志条目到自己的日志中，但在提交之前就崩溃了；很快这个机器就被重启了，在 Term3 重新被选为 Leader，并且又增加了一些日志条目到自己的日志中；在 Term 2 和 Term 3 的日志被提交之前，这个服务器又宕机了，并且在接下来的几个任期里一直处于宕机状态_。</p>
</blockquote>
<h4 id="Leader-和-Follower-日志一致的保证"><a href="#Leader-和-Follower-日志一致的保证" class="headerlink" title="Leader 和 Follower 日志一致的保证"></a>Leader 和 Follower 日志一致的保证</h4><p>Leader 通过强制 Followers 复制它的日志来处理日志的不一致，<strong>Followers 上的不一致的日志会被 Leader 的日志覆盖</strong>。</p>
<ul>
<li>Leader 为了使 Followers 的日志同自己的一致，Leader 需要找到 Followers 同它的日志一致的地方，然后覆盖 Followers 在该位置之后的条目。</li>
<li>Leader 会从后往前试，每次日志条目失败后尝试前一个日志条目，直到成功找到每个 Follower 的日志一致位点，然后向后逐条覆盖 Followers 在该位置之后的条目。</li>
</ul>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>前面描述了 Raft 算法是如何选举 Leader 和复制日志的。</p>
<p>Raft 还增加了一些限制来完善 Raft 算法，以保证安全性：保证了任意 Leader 对于给定的 Term，都拥有了之前 Term 的所有被提交的日志条目。</p>
<h3 id="选举限制"><a href="#选举限制" class="headerlink" title="选举限制"></a>选举限制</h3><p>拥有最新的已提交的日志条目的 Follower 才有资格成为 Leader。</p>
<p>Raft 使用投票的方式来阻止一个 Candidate 赢得选举除非这个 Candidate 包含了所有已经提交的日志条目。 Candidate 为了赢得选举必须联系集群中的大部分节点，这意味着每一个已经提交的日志条目在这些服务器节点中肯定存在于至少一个节点上。如果 Candidate 的日志至少和大多数的服务器节点一样新（这个新的定义会在下面讨论），那么他一定持有了所有已经提交的日志条目。</p>
<p><code>RequestVote RPC</code> 实现了这样的限制：<strong>RequestVote RPC 中包含了 Candidate 的日志信息， Follower 会拒绝掉那些日志没有自己新的投票请求</strong>。</p>
<p>如何判断哪个日志条目比较新？</p>
<p>Raft 通过比较两份日志中最后一条日志条目的日志索引和 Term 来判断哪个日志比较新。</p>
<ul>
<li>先判断 Term，哪个数值大即代表哪个日志比较新。</li>
<li>如果 Term 相同，再比较 日志索引，哪个数值大即代表哪个日志比较新。</li>
</ul>
<h3 id="提交旧任期的日志条目"><a href="#提交旧任期的日志条目" class="headerlink" title="提交旧任期的日志条目"></a>提交旧任期的日志条目</h3><p>一个当前 Term 的日志条目被复制到了半数以上的服务器上，Leader 就认为它是可以被提交的。如果这个 Leader 在提交日志条目前就下线了，后续的 Leader 可能会覆盖掉这个日志条目。</p>
<p><img src="https://pic4.zhimg.com/80/v2-12a5ebab63781f9ec49e14e331775537_hd.jpg" alt="img"></p>
<blockquote>
<p>💡 图示说明：</p>
<p>上图解释了为什么 Leader 无法对旧 Term 的日志条目进行提交。</p>
<ul>
<li>阶段 (a) ，S1 是 Leader，且 S1 写入日志条目为 (Term 2，日志索引 2），只有 S2 复制了这个日志条目。</li>
<li>阶段 (b)，S1 下线，S5 被选举为 Term3 的 Leader。S5 写入日志条目为 (Term 3，日志索引 2）。</li>
<li>阶段 (c)，S5 下线，S1 重新上线，并被选举为 Term4 的 Leader。此时，Term 2 的那条日志条目已经被复制到了集群中的大多数节点上，但是还没有被提交。</li>
<li>阶段 (d)，S1 再次下线，S5 重新上线，并被重新选举为 Term3 的 Leader。然后 S5 覆盖了日志索引 2 处的日志。</li>
<li>阶段 (e)，如果阶段 (d) 还未发生，即 S1 再次下线之前，S1 把自己主导的日志条目复制到了大多数节点上，那么在后续 Term 里面这些新日志条目就会被提交。这样在同一时刻就同时保证了，之前的所有旧日志条目就会被提交。</li>
</ul>
</blockquote>
<p><strong>Raft 永远不会通过计算副本数目的方式去提交一个之前 Term 内的日志条目</strong>。只有 Leader 当前 Term 里的日志条目通过计算副本数目可以被提交；一旦当前 Term 的日志条目以这种方式被提交，那么由于日志匹配特性，之前的日志条目也都会被间接的提交。</p>
<p>当 Leader 复制之前任期里的日志时，Raft 会为所有日志保留原始的 Term，这在提交规则上产生了额外的复杂性。在其他的一致性算法中，如果一个新的领导人要重新复制之前的任期里的日志时，它必须使用当前新的任期号。Raft 使用的方法更加容易辨别出日志，因为它可以随着时间和日志的变化对日志维护着同一个任期编号。另外，和其他的算法相比，Raft 中的新领导人只需要发送更少日志条目（其他算法中必须在他们被提交之前发送更多的冗余日志条目来为他们重新编号）。</p>
<h2 id="日志压缩"><a href="#日志压缩" class="headerlink" title="日志压缩"></a>日志压缩</h2><p>在实际的系统中，不能让日志无限膨胀，否则系统重启时需要花很长的时间进行恢复，从而影响可用性。Raft 采用对整个系统进行快照来解决，快照之前的日志都可以丢弃。</p>
<p>每个副本独立的对自己的系统状态生成快照，并且只能对已经提交的日志条目生成快照。</p>
<p>快照包含以下内容：</p>
<ul>
<li>日志元数据。最后一条已提交的日志条目的日志索引和 Term。这两个值在快照之后的第一条日志条目的 <code>AppendEntries RPC</code> 的完整性检查的时候会被用上。</li>
<li>系统当前状态。</li>
</ul>
<p>当 Leader 要发送某个日志条目，落后太多的 Follower 的日志条目会被丢弃，Leader 会将快照发给 Follower。或者新上线一台机器时，也会发送快照给它。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200201220628.png" alt="img"></p>
<p><strong>生成快照的频率要适中</strong>，频率过高会消耗大量 I&#x2F;O 带宽；频率过低，一旦需要执行恢复操作，会丢失大量数据，影响可用性。推荐当日志达到某个固定的大小时生成快照。</p>
<p>生成一次快照可能耗时过长，影响正常日志同步。可以通过使用 copy-on-write 技术避免快照过程影响正常日志同步。</p>
<blockquote>
<p>说明：本文仅阐述 Raft 算法的核心内容，不包括算法论证、评估等</p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf">Raft 算法论文</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">Raft 算法论文译文</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YbZ3zDzDnrw&feature=youtu.be">Raft 作者讲解视频</a></li>
<li><a target="_blank" rel="noopener" href="http://www2.cs.uh.edu/~paris/6360/PowerPoint/Raft.ppt">Raft 作者讲解视频对应的 PPT</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jdon.com/artichect/raft.html">分布式系统的 Raft 算法</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32052223">Raft 算法详解</a></li>
<li><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft">Raft: Understandable Distributed Consensus</a> - 一个动画教程</li>
<li><a target="_blank" rel="noopener" href="https://raft.github.io/">The Raft Consensus Algorithm</a> - 一个交互式动画教程</li>
<li><a target="_blank" rel="noopener" href="https://github.com/sofastack/sofa-jraft">sofa-jraft</a> - 蚂蚁金服的 Raft 算法实现库（Java 版）</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/476a09/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/476a09/" class="post-title-link" itemprop="url">Redis 事务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-30 21:48:57" itemprop="dateCreated datePublished" datetime="2020-01-30T21:48:57+08:00">2020-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">KV数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis-事务"><a href="#Redis-事务" class="headerlink" title="Redis 事务"></a>Redis 事务</h1><blockquote>
<p><strong>Redis 仅支持“非严格”的事务</strong>。所谓“非严格”是指：Redis 事务保证“全部执行命令”；但是，Redis 事务“不支持回滚”。</p>
<p>关键词：<code>事务</code>、<code>ACID</code>、<code>MULTI</code>、<code>EXEC</code>、<code>DISCARD</code>、<code>WATCH</code></p>
</blockquote>
<h2 id="Redis-事务简介"><a href="#Redis-事务简介" class="headerlink" title="Redis 事务简介"></a>Redis 事务简介</h2><h3 id="什么是-ACID"><a href="#什么是-ACID" class="headerlink" title="什么是 ACID"></a>什么是 ACID</h3><p>ACID 是数据库事务正确执行的四个基本要素。</p>
<ul>
<li><strong>原子性（Atomicity）</strong><ul>
<li>事务被视为不可分割的最小单元，事务中的所有操作<strong>要么全部提交成功，要么全部失败回滚</strong>。</li>
<li>回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</li>
</ul>
</li>
<li><strong>一致性（Consistency）</strong><ul>
<li>数据库在事务执行前后都保持一致性状态。</li>
<li>在一致性状态下，所有事务对一个数据的读取结果都是相同的。</li>
</ul>
</li>
<li><strong>隔离性（Isolation）</strong><ul>
<li>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</li>
</ul>
</li>
<li><strong>持久性（Durability）</strong><ul>
<li>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</li>
<li>可以通过数据库备份和恢复来实现，在系统发生奔溃时，使用备份的数据库进行数据恢复。</li>
</ul>
</li>
</ul>
<p><strong>一个支持事务（Transaction）中的数据库系统，必需要具有这四种特性，否则在事务过程（Transaction processing）当中无法保证数据的正确性，交易过程极可能达不到交易。</strong></p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</li>
<li>事务满足持久化是为了能应对系统崩溃的情况。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/database/RDB/%E6%95%B0%E6%8D%AE%E5%BA%93ACID.png" alt="ACID"></p>
<h3 id="Redis-事务的特性"><a href="#Redis-事务的特性" class="headerlink" title="Redis 事务的特性"></a>Redis 事务的特性</h3><p>Redis 的事务总是支持 ACID 中的原子性、一致性和隔离性， 当服务器运行在 AOF 持久化模式下， 并且 <code>appendfsync</code> 选项的值为 <code>always</code> 时， 事务也具有持久性。</p>
<p>但需要注意的是：<strong>Redis 仅支持“非严格”的事务</strong>。这里的“非严格”，其实指的是 Redis 事务只能部分保证 ACID 中的原子性。</p>
<ul>
<li><strong>Redis 事务保证全部执行命令</strong> - Redis 事务中的多个命令会被打包到事务队列中，然后按先进先出（FIFO）的顺序执行。事务在执行过程中不会被中断，当事务队列中的所有命令都被执行完毕之后，事务才会结束。</li>
<li><strong>Redis 事务不支持回滚</strong> - 如果命令执行失败不会回滚，而是会继续执行下去。</li>
</ul>
<p>Redis 官方的<a target="_blank" rel="noopener" href="https://redis.io/docs/interact/transactions/">事务特性文档</a>给出的不支持回滚的理由是：</p>
<ul>
<li>Redis 命令只会因为错误的语法而失败，或是命令用在了错误类型的键上面。</li>
<li>因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。</li>
</ul>
<h2 id="Redis-事务应用"><a href="#Redis-事务应用" class="headerlink" title="Redis 事务应用"></a>Redis 事务应用</h2><p><a target="_blank" rel="noopener" href="https://redis.io/commands/multi"><code>MULTI</code></a>、<a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a>、<a target="_blank" rel="noopener" href="https://redis.io/commands/discard"><code>DISCARD</code></a> 和 <a target="_blank" rel="noopener" href="https://redis.io/commands/watch"><code>WATCH</code></a> 是 Redis 事务相关的命令。</p>
<p>事务可以一次执行多个命令， 并且有以下两个重要的保证：</p>
<ul>
<li>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>
<li>事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。</li>
</ul>
<h3 id="MULTI"><a href="#MULTI" class="headerlink" title="MULTI"></a>MULTI</h3><p><strong><a target="_blank" rel="noopener" href="https://redis.io/commands/multi"><code>MULTI</code></a> 命令用于开启一个事务，它总是返回 OK 。</strong></p>
<p><code>MULTI</code> 执行之后， 客户端可以继续向服务器发送任意多条命令， 这些命令不会立即被执行， 而是被放到一个队列中， 当 EXEC 命令被调用时， 所有队列中的命令才会被执行。</p>
<p>以下是一个事务例子， 它原子地增加了 <code>foo</code> 和 <code>bar</code> 两个键的值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">&gt; INCR foo</span><br><span class="line">QUEUED</span><br><span class="line">&gt; INCR bar</span><br><span class="line">QUEUED</span><br><span class="line">&gt; EXEC</span><br><span class="line"><span class="number">1</span>) (integer) <span class="number">1</span></span><br><span class="line"><span class="number">2</span>) (integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="EXEC"><a href="#EXEC" class="headerlink" title="EXEC"></a>EXEC</h3><p><strong><a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> 命令负责触发并执行事务中的所有命令。</strong></p>
<ul>
<li>如果客户端在使用 <code>MULTI</code> 开启了一个事务之后，却因为断线而没有成功执行 <code>EXEC</code> ，那么事务中的所有命令都不会被执行。</li>
<li>另一方面，如果客户端成功在开启事务之后执行 <code>EXEC</code> ，那么事务中的所有命令都会被执行。</li>
</ul>
<p><code>MULTI</code> 和 <code>EXEC</code> 中的操作将会一次性发送给服务器，而不是一条一条发送，这种方式称为流水线，它可以减少客户端与服务器之间的网络通信次数从而提升性能。</p>
<h3 id="DISCARD"><a href="#DISCARD" class="headerlink" title="DISCARD"></a>DISCARD</h3><p><strong>当执行 <a target="_blank" rel="noopener" href="https://redis.io/commands/discard"><code>DISCARD</code></a> 命令时， 事务会被放弃， 事务队列会被清空， 并且客户端会从事务状态中退出。</strong></p>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; SET foo <span class="number">1</span></span><br><span class="line">OK</span><br><span class="line">&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">&gt; INCR foo</span><br><span class="line">QUEUED</span><br><span class="line">&gt; DISCARD</span><br><span class="line">OK</span><br><span class="line">&gt; GET foo</span><br><span class="line"><span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="WATCH"><a href="#WATCH" class="headerlink" title="WATCH"></a>WATCH</h3><p><strong><a target="_blank" rel="noopener" href="https://redis.io/commands/watch"><code>WATCH</code></a> 命令可以为 Redis 事务提供 check-and-set （CAS）行为。</strong></p>
<p>被 <code>WATCH</code> 的键会被监视，并会发觉这些键是否被改动过了。 如果有至少一个被监视的键在 <code>EXEC</code> 执行之前被修改了， 那么整个事务都会被取消， <code>EXEC</code> 返回 <code>nil-reply</code> 来表示事务已经失败。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WATCH mykey</span><br><span class="line">val = GET mykey</span><br><span class="line">val = val + <span class="number">1</span></span><br><span class="line">MULTI</span><br><span class="line">SET mykey $val</span><br><span class="line">EXEC</span><br></pre></td></tr></table></figure>

<p>使用上面的代码， 如果在 <code>WATCH</code> 执行之后， <code>EXEC</code> 执行之前， 有其他客户端修改了 <code>mykey</code> 的值， 那么当前客户端的事务就会失败。 程序需要做的， 就是不断重试这个操作， 直到没有发生碰撞为止。</p>
<p>这种形式的锁被称作乐观锁， 它是一种非常强大的锁机制。 并且因为大多数情况下， 不同的客户端会访问不同的键， 碰撞的情况一般都很少， 所以通常并不需要进行重试。</p>
<p><code>WATCH</code> 使得 <code>EXEC</code> 命令需要有条件地执行：事务只能在所有被监视键都没有被修改的前提下执行，如果这个前提不能满足的话，事务就不会被执行。</p>
<p><code>WATCH</code> 命令可以被调用多次。对键的监视从 <code>WATCH</code> 执行之后开始生效，直到调用 <code>EXEC</code> 为止。</p>
<p>用户还可以在单个 <code>WATCH</code> 命令中监视任意多个键，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; WATCH key1 key2 key3</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h4 id="取消-WATCH-的场景"><a href="#取消-WATCH-的场景" class="headerlink" title="取消 WATCH 的场景"></a>取消 WATCH 的场景</h4><p>当 <code>EXEC</code> 被调用时， 不管事务是否成功执行， 对所有键的监视都会被取消。另外， 当客户端断开连接时， 该客户端对键的监视也会被取消。</p>
<p>使用无参数的 <code>UNWATCH</code> 命令可以手动取消对所有键的监视。 对于一些需要改动多个键的事务， 有时候程序需要同时对多个键进行加锁， 然后检查这些键的当前值是否符合程序的要求。 当值达不到要求时， 就可以使用 <code>UNWATCH</code> 命令来取消目前对键的监视， 中途放弃这个事务， 并等待事务的下次尝试。</p>
<h4 id="使用-WATCH-创建原子操作"><a href="#使用-WATCH-创建原子操作" class="headerlink" title="使用 WATCH 创建原子操作"></a>使用 WATCH 创建原子操作</h4><p><code>WATCH</code> 可以用于创建 Redis 没有内置的原子操作。</p>
<p>举个例子，以下代码实现了原创的 <code>ZPOP</code> 命令，它可以原子地弹出有序集合中分值（<code>score</code>）最小的元素：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WATCH zset</span><br><span class="line">element = ZRANGE zset <span class="number">0</span> <span class="number">0</span></span><br><span class="line">MULTI</span><br><span class="line">ZREM zset element</span><br><span class="line">EXEC</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11486101.html">《Redis 设计与实现》</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/30456b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/30456b/" class="post-title-link" itemprop="url">Redis 脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-30 21:48:57" itemprop="dateCreated datePublished" datetime="2020-01-30T21:48:57+08:00">2020-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:52" itemprop="dateModified" datetime="2024-12-12T10:02:52+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">KV数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis-脚本"><a href="#Redis-脚本" class="headerlink" title="Redis 脚本"></a>Redis 脚本</h1><blockquote>
<p>Redis 脚本使用 Lua 解释器来执行脚本。 Redis 2.6 版本通过内嵌支持 Lua 环境。</p>
<p>关键词：<code>Lua</code></p>
</blockquote>
<h2 id="为什么使用-Lua"><a href="#为什么使用-Lua" class="headerlink" title="为什么使用 Lua"></a>为什么使用 Lua</h2><p>Lua 是一种轻量小巧的脚本语言，用标准 C 语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<p>在 Redis 中，执行单一命令是原子性操作，所以不会出现并发问题。但有的业务场景下，需要执行多个命令，同时确保不出现并发问题，这就需要用到 Lua 脚本了。</p>
<p><strong>Redis 执行 Lua 是原子操作</strong>。因为 Redis 使用串行化的方式来执行 Redis 命令， 所以在任何特定时间里， 最多都只会有一个脚本能够被放进 Lua 环境里面运行， 因此， 整个 Redis 服务器只需要创建一个 Lua 环境即可。</p>
<p>由于，Redis 执行 Lua 具有原子性，所以常被用于需要原子性执行多命令的场景。</p>
<h2 id="Redis-脚本命令"><a href="#Redis-脚本命令" class="headerlink" title="Redis 脚本命令"></a>Redis 脚本命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>EVAL</code></td>
<td><code>EVAL</code> 命令为客户端输入的脚本在 Lua 环境中定义一个函数， 并通过调用这个函数来执行脚本。</td>
</tr>
<tr>
<td><code>EVALSHA</code></td>
<td><code>EVALSHA</code> 命令通过直接调用 Lua 环境中已定义的函数来执行脚本。</td>
</tr>
<tr>
<td><code>SCRIPT_FLUSH</code></td>
<td><code>SCRIPT_FLUSH</code> 命令会清空服务器 <code>lua_scripts</code> 字典中保存的脚本， 并重置 Lua 环境。</td>
</tr>
<tr>
<td><code>SCRIPT_EXISTS</code></td>
<td><code>SCRIPT_EXISTS</code> 命令接受一个或多个 SHA1 校验和为参数， 并通过检查 <code>lua_scripts</code> 字典来确认校验和对应的脚本是否存在。</td>
</tr>
<tr>
<td><code>SCRIPT_LOAD</code></td>
<td><code>SCRIPT_LOAD</code> 命令接受一个 Lua 脚本为参数， 为该脚本在 Lua 环境中创建函数， 并将脚本保存到 <code>lua_scripts</code> 字典中。</td>
</tr>
<tr>
<td><code>SCRIPT_KILL</code></td>
<td><code>SCRIPT_KILL</code> 命令用于停止正在执行的脚本。</td>
</tr>
</tbody></table>
<h2 id="Redis-执行-Lua-的工作流程"><a href="#Redis-执行-Lua-的工作流程" class="headerlink" title="Redis 执行 Lua 的工作流程"></a>Redis 执行 Lua 的工作流程</h2><p>为了在 Redis 服务器中执行 Lua 脚本， Redis 在服务器内嵌了一个 Lua 环境（environment）， 并对这个 Lua 环境进行了一系列修改， 从而确保这个 Lua 环境可以满足 Redis 服务器的需要。</p>
<p>Redis 服务器创建并修改 Lua 环境的整个过程由以下步骤组成：</p>
<ol>
<li>创建一个基础的 Lua 环境， 之后的所有修改都是针对这个环境进行的。</li>
<li>载入多个函数库到 Lua 环境里面， 让 Lua 脚本可以使用这些函数库来进行数据操作。</li>
<li>创建全局表格 <code>redis</code> ， 这个表格包含了对 Redis 进行操作的函数， 比如用于在 Lua 脚本中执行 Redis 命令的 <code>redis.call</code> 函数。</li>
<li>使用 Redis 自制的随机函数来替换 Lua 原有的带有副作用的随机函数， 从而避免在脚本中引入副作用。</li>
<li>创建排序辅助函数， Lua 环境使用这个辅佐函数来对一部分 Redis 命令的结果进行排序， 从而消除这些命令的不确定性。</li>
<li>创建 <code>redis.pcall</code> 函数的错误报告辅助函数， 这个函数可以提供更详细的出错信息。</li>
<li>对 Lua 环境里面的全局环境进行保护， 防止用户在执行 Lua 脚本的过程中， 将额外的全局变量添加到了 Lua 环境里面。</li>
<li>将完成修改的 Lua 环境保存到服务器状态的 <code>lua</code> 属性里面， 等待执行服务器传来的 Lua 脚本。</li>
</ol>
<h2 id="Redis-执行-Lua-的要点"><a href="#Redis-执行-Lua-的要点" class="headerlink" title="Redis 执行 Lua 的要点"></a>Redis 执行 Lua 的要点</h2><ul>
<li>Redis 服务器专门使用一个伪客户端来执行 Lua 脚本中包含的 Redis 命令。</li>
<li>Redis 使用脚本字典来保存所有被 <code>EVAL</code> 命令执行过， 或者被 <code>SCRIPT_LOAD</code> 命令载入过的 Lua 脚本， 这些脚本可以用于实现 <code>SCRIPT_EXISTS</code> 命令， 以及实现脚本复制功能。</li>
<li>服务器在执行脚本之前， 会为 Lua 环境设置一个超时处理钩子， 当脚本出现超时运行情况时， 客户端可以通过向服务器发送 <code>SCRIPT_KILL</code> 命令来让钩子停止正在执行的脚本， 或者发送 <code>SHUTDOWN nosave</code> 命令来让钩子关闭整个服务器。</li>
<li>主服务器复制 <code>EVAL</code> 、 <code>SCRIPT_FLUSH</code> 、 <code>SCRIPT_LOAD</code> 三个命令的方法和复制普通 Redis 命令一样 —— 只要将相同的命令传播给从服务器就可以了。</li>
<li>主服务器在复制 <code>EVALSHA</code> 命令时， 必须确保所有从服务器都已经载入了 <code>EVALSHA</code> 命令指定的 SHA1 校验和所对应的 Lua 脚本， 如果不能确保这一点的话， 主服务器会将 <code>EVALSHA</code> 命令转换成等效的 <code>EVAL</code> 命令， 并通过传播 <code>EVAL</code> 命令来获得相同的脚本执行效果。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11486101.html">《Redis 设计与实现》</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/f668c0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/f668c0/" class="post-title-link" itemprop="url">Markdown</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-27 23:41:00" itemprop="dateCreated datePublished" datetime="2020-01-27T23:41:00+08:00">2020-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E4%BD%9C/%E6%95%88%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">效能</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E4%BD%9C/%E6%95%88%E8%83%BD/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Markdown-极简教程"><a href="#Markdown-极简教程" class="headerlink" title="Markdown 极简教程"></a>Markdown 极简教程</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h2 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h2><p>Markdown 支持六个级别的标题。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"># 一级标题</span><br><span class="line">## 二级标题</span><br><span class="line">### 三级标题</span><br><span class="line">#### 四级标题</span><br><span class="line">##### 五级标题</span><br><span class="line">###### 六级标题</span><br></pre></td></tr></table></figure>

<h2 id="文本样式"><a href="#文本样式" class="headerlink" title="文本样式"></a>文本样式</h2><blockquote>
<p>:bulb: 粗体、斜体、删除线可以混合使用。</p>
<p>在 Markdown 中，粗体文本、斜体文本可以使用 <code>*</code> 或 <code>_</code> 符号标记。建议统一风格，始终只用一种符号。</p>
</blockquote>
<table>
<thead>
<tr>
<th>语法</th>
<th>效果</th>
</tr>
</thead>
<tbody><tr>
<td>普通文本</td>
<td>普通文本</td>
</tr>
<tr>
<td><code>*斜体文本*</code> <code>_斜体文本_</code></td>
<td><em>斜体文本</em> <em>斜体文本</em></td>
</tr>
<tr>
<td><code>**粗体文本**</code> <code>__粗体文本__</code></td>
<td><strong>粗体文本</strong> <strong>粗体文本</strong></td>
</tr>
<tr>
<td><code>~~删除文本~~</code></td>
<td><del>删除文本</del></td>
</tr>
<tr>
<td><code>***粗斜体文本***</code> <code>___粗斜体文本___</code></td>
<td><strong><em>粗斜体文本</em></strong> <strong><em>粗斜体文本</em></strong></td>
</tr>
</tbody></table>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><h3 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表"></a>无序列表</h3><ul>
<li>RED</li>
<li>YELLOW</li>
<li>BLUE</li>
</ul>
<h3 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h3><ol>
<li>第一步</li>
<li>第二步</li>
<li>第三步</li>
</ol>
<h3 id="任务列表"><a href="#任务列表" class="headerlink" title="任务列表"></a>任务列表</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 完成任务</li>
<li><input disabled="" type="checkbox"> 计划任务</li>
</ul>
<h3 id="多级列表"><a href="#多级列表" class="headerlink" title="多级列表"></a>多级列表</h3><ul>
<li>数据结构<ul>
<li>线性表<ul>
<li>顺序表</li>
<li>链表<ul>
<li>单链表</li>
<li>双链表</li>
</ul>
</li>
</ul>
</li>
<li>树<ul>
<li>二叉树<ul>
<li>二叉平衡树</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><p><code>***</code>、<code>---</code>、<code>___</code> 都可以作为分割线。</p>
<hr>
<hr>
<hr>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><h3 id="普通链接"><a href="#普通链接" class="headerlink" title="普通链接"></a>普通链接</h3><p>语法：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[钝悟的博客]</span>(<span class="attribute">https</span>:<span class="comment">//dunwu.github.io/waterdrop/)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>[]</code> 中标记链接名。类似 HTML 中 <code>&lt;a&gt;</code> 元素的 <code>title</code> 属性。</li>
<li><code>()</code> 中标记链接的 url，也支持相对路径（前提是资源可以访问）。类似 HTML 中 <code>&lt;a&gt;</code> 元素的 <code>href</code> 属性。</li>
</ul>
<p>效果：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/waterdrop/" title="blog">钝悟的博客</a></li>
</ul>
<h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>Markdown 引用图片的语法：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="selector-attr">[alt]</span>(url title)</span><br></pre></td></tr></table></figure>

<p>alt 和 title 即对应 HTML 中 img 元素的 alt 和 title 属性（都可省略）：</p>
<ul>
<li><p>alt - 表示图片显示失败时的替换文本。</p>
</li>
<li><p>title - 表示鼠标悬停在图片时的显示文本（注意这里要加引号）</p>
</li>
<li><p>url - 即图片的 url 地址</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" alt="logo" title="logo"></p>
<h3 id="图片链接"><a href="#图片链接" class="headerlink" title="图片链接"></a>图片链接</h3><p>可以将图片和链接混合使用。</p>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/waterdrop/"><img src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" alt="logo" title="logo"></a></p>
<h3 id="锚点"><a href="#锚点" class="headerlink" title="锚点"></a>锚点</h3><p>其实呢，每一个标题都是一个锚点，和 HTML 的锚点（<code>#</code>）类似，比如：<a href="#Markdown-%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97">回到顶部</a></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>普通引用：</p>
<blockquote>
<p>:question: 什么是 <code>Markdown</code></p>
<p><strong>Markdown</strong>是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BD%BB%E9%87%8F%E7%BA%A7%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80">轻量级标记语言</a>，创始人为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B4%84%E7%BF%B0%C2%B7%E6%A0%BC%E9%AD%AF%E4%BC%AF">约翰·格鲁伯</a>（英语：John Gruber）。它允许人们“使用易读易写的纯文本格式编写文档，然后转换成有效的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/XHTML">XHTML</a>（或者<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTML">HTML</a>）文档”。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Markdown#cite_note-md-4">4]</a>这种语言吸收了很多在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6">电子邮件</a>中已有的纯文本标记的特性。 —— 摘自 Wiki</p>
</blockquote>
<p>嵌套引用：</p>
<blockquote>
<p>数据结构</p>
<blockquote>
<p>树</p>
<blockquote>
<p>二叉树</p>
<blockquote>
<p>平衡二叉树</p>
<blockquote>
<p>满二叉树</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h2 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h2><h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>语法：</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`Markdown` `Doc`</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><code>Markdown</code>, <code>Doc</code></p>
<h3 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h3><p>语法一：在文本前后都使用三个反引号进行标记。【✔️️️️ 推荐】</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这是一个文本块。</span><br><span class="line">这是一个文本块。</span><br><span class="line">这是一个文本块。</span><br></pre></td></tr></table></figure>

<p>语法二：在连续几行的文本开头加入 1 个 Tab 或者 4 个空格。【❌ 不推荐】</p>
<pre><code>这是一个文本块。
这是一个文本块。
这是一个文本块。
</code></pre>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>在三个反引号后面加上编程语言的名字，另起一行开始写代码，最后一行再加上三个反引号。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span>&#123;&#125; <span class="comment">//Java</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> <span class="comment">//C</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello GitHub&quot;</span> <span class="comment">#Bash</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;myH1&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;Welcome to my Homepage&#x27;</span> <span class="comment">//javascipt</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string &amp;<span class="keyword">operator</span>+(<span class="type">const</span> string&amp; A,<span class="type">const</span> string&amp; B) <span class="comment">//cpp</span></span><br></pre></td></tr></table></figure>

<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><p>一般表格：</p>
<table>
<thead>
<tr>
<th>表头 1</th>
<th>表头 2</th>
</tr>
</thead>
<tbody><tr>
<td>表格单元</td>
<td>表格单元</td>
</tr>
<tr>
<td>表格单元</td>
<td>表格单元</td>
</tr>
</tbody></table>
<p>表格可以指定对齐方式：</p>
<table>
<thead>
<tr>
<th align="center">序号</th>
<th align="left">商品</th>
<th align="right">价格</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="left">电脑</td>
<td align="right">6000.0</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left">鼠标</td>
<td align="right">100.0</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left">键盘</td>
<td align="right">200.0</td>
</tr>
</tbody></table>
<h2 id="Emoji-表情"><a href="#Emoji-表情" class="headerlink" title="Emoji 表情"></a>Emoji 表情</h2><blockquote>
<p>:bulb: 注意：部分 Markdown 引擎支持 Emoji。</p>
</blockquote>
<p>合理使用 Emoji 表情，往往可以使得文章内容更加丰富生动。例如：:heavy_check_mark: :x: :bulb: :bell: :heavy_exclamation_mark: :question:</p>
<blockquote>
<p>更多 Emoji 表情请参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://emojihomepage.com/">http://emojihomepage.com/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.emoji-cheat-sheet.com/">http://www.emoji-cheat-sheet.com</a></li>
</ul>
</blockquote>
<h2 id="注脚"><a href="#注脚" class="headerlink" title="注脚"></a>注脚</h2><blockquote>
<p>:bulb: 注意：部分 Markdown 引擎支持注脚。</p>
</blockquote>
<p>一个具有注脚的文本。<a href="%E6%B3%A8%E8%84%9A%E7%9A%84%E8%A7%A3%E9%87%8A">^1</a></p>
<h2 id="数学公式"><a href="#数学公式" class="headerlink" title="数学公式"></a>数学公式</h2><blockquote>
<p>:bulb: 注意：部分 Markdown 引擎支持 Latex。</p>
</blockquote>
<p>很多文档中，需要引入一些数学符号、特殊符号，其排版问题比较头疼。这种问题，可以用 Latex 来解决，大部分 Markdown 引擎都支持 Latex。</p>
<p>Latex 可以使用 <code>$</code> 符号来标记 Latex 表达式，下面是一个数学公式示例：</p>
<p>$$<br>\Gamma(z) &#x3D; \int_0^\infty t^{z-1}e^{-t}dt,.<br>$$</p>
<p>列举一些常用数学符号：</p>
<table>
<thead>
<tr>
<th align="center">符号</th>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$\leq$</td>
<td><code>$\leq$</code></td>
<td>小于等于</td>
</tr>
<tr>
<td align="center">$\geq$</td>
<td><code>$\geq$</code></td>
<td>大于等于</td>
</tr>
<tr>
<td align="center">$\neq$</td>
<td><code>$\neq$</code></td>
<td>不等于</td>
</tr>
<tr>
<td align="center">$\approx$</td>
<td><code>$\approx$</code></td>
<td>约等于</td>
</tr>
<tr>
<td align="center">$\infty$</td>
<td><code>$\infty$</code></td>
<td>无穷</td>
</tr>
<tr>
<td align="center">$\prod_{x}^{y}$</td>
<td><code>$\prod_&#123;x&#125;^&#123;y&#125;$</code></td>
<td>累乘</td>
</tr>
<tr>
<td align="center">$\sum_{i&#x3D;0}^n$</td>
<td><code>$\sum_&#123;i=0&#125;^n$</code></td>
<td>求和</td>
</tr>
<tr>
<td align="center">$\int$</td>
<td><code>$\int$</code></td>
<td>积分</td>
</tr>
<tr>
<td align="center">$\iint$</td>
<td><code>$\iint$</code></td>
<td>双重积分</td>
</tr>
<tr>
<td align="center">$\log_x{y}$</td>
<td><code>$\log_x&#123;y&#125;$</code></td>
<td>对数</td>
</tr>
<tr>
<td align="center">$x^{y+1}$</td>
<td><code>$x^&#123;y+1&#125;$</code></td>
<td>上标</td>
</tr>
<tr>
<td align="center">$x_{y+1}$</td>
<td><code>$x_&#123;y+1&#125;$</code></td>
<td>下标</td>
</tr>
<tr>
<td align="center">$\frac{x}{y}$</td>
<td><code>$\frac&#123;x&#125;&#123;y&#125;$</code></td>
<td>分数</td>
</tr>
<tr>
<td align="center">$\sqrt[y]{x}$</td>
<td><code>$\sqrt[y]&#123;x&#125;$</code></td>
<td>开方</td>
</tr>
<tr>
<td align="center">$\sin$</td>
<td><code>$\sin$</code></td>
<td>正弦</td>
</tr>
<tr>
<td align="center">$\cos$</td>
<td><code>$\cos$</code></td>
<td>余弦</td>
</tr>
<tr>
<td align="center">$\tan$</td>
<td><code>$\tan$</code></td>
<td>正切</td>
</tr>
</tbody></table>
<blockquote>
<p>更多数学符号支持请参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/luong-komorebi/Begin-Latex-in-minutes">Begin-Latex-in-minutes</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Katherine_hsr/article/details/79179622">Markdown 数学符号&amp;公式</a></li>
</ul>
</blockquote>
<h2 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h2><blockquote>
<p>:bulb: 注意：部分 Markdown 引擎支持 Diff。</p>
</blockquote>
<p>版本控制的系统中都少不了 diff 的功能，即展示一个文件内容的增加与删除。<br>GFM 中可以显示的展示 diff 效果。可以用 <code>+</code> 开头表示新增，<code>-</code> 开头表示删除。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ 新增内容</span></span><br><span class="line"><span class="deletion">- 删除内容</span></span><br></pre></td></tr></table></figure>

<h2 id="UML-图"><a href="#UML-图" class="headerlink" title="UML 图"></a>UML 图</h2><blockquote>
<p>💡 注意：部分 Markdown 引擎支持 <a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/">mermaid</a>。</p>
<p><a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/">mermaid</a> 提供了多种 UML 图。详情请参考：<a target="_blank" rel="noopener" href="https://mermaidjs.github.io/">mermaid 文档</a></p>
</blockquote>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[Hard edge] --&gt;|Link text| B(Round edge)</span><br><span class="line">    B --&gt; C&#123;Decision&#125;</span><br><span class="line">    C --&gt;|One| D[Result one]</span><br><span class="line">    C --&gt;|Two| E[Result two]</span><br></pre></td></tr></table></figure>

<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    Alice-&gt;&gt;Bob: Hello Bob, how are you?</span><br><span class="line">    alt is sick</span><br><span class="line">        Bob-&gt;&gt;Alice: Not so good :(</span><br><span class="line">    else is well</span><br><span class="line">        Bob-&gt;&gt;Alice: Feeling fresh like a daisy</span><br><span class="line">    end</span><br><span class="line">    opt Extra response</span><br><span class="line">        Bob-&gt;&gt;Alice: Thanks for asking</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h3 id="甘特图"><a href="#甘特图" class="headerlink" title="甘特图"></a>甘特图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">gantt</span><br><span class="line">       dateFormat  YYYY-MM-DD</span><br><span class="line">       title Adding GANTT diagram functionality to mermaid</span><br><span class="line"></span><br><span class="line">       section A section</span><br><span class="line">       Completed task            :done,    des1, 2014-01-06,2014-01-08</span><br><span class="line">       Active task               :active,  des2, 2014-01-09, 3d</span><br><span class="line">       Future task               :         des3, after des2, 5d</span><br><span class="line">       Future task2              :         des4, after des3, 5d</span><br><span class="line"></span><br><span class="line">       section Critical tasks</span><br><span class="line">       Completed task in the critical line :crit, done, 2014-01-06,24h</span><br><span class="line">       Implement parser and jison          :crit, done, after des1, 2d</span><br><span class="line">       Create tests for parser             :crit, active, 3d</span><br><span class="line">       Future task in critical line        :crit, 5d</span><br><span class="line">       Create tests for renderer           :2d</span><br><span class="line">       Add to mermaid                      :1d</span><br><span class="line"></span><br><span class="line">       section Documentation</span><br><span class="line">       Describe gantt syntax               :active, a1, after des1, 3d</span><br><span class="line">       Add gantt diagram to demo page      :after a1  , 20h</span><br><span class="line">       Add another diagram to demo page    :doc1, after a1  , 48h</span><br><span class="line"></span><br><span class="line">       section Last section</span><br><span class="line">       Describe gantt syntax               :after doc1, 3d</span><br><span class="line">       Add gantt diagram to demo page      :20h</span><br><span class="line">       Add another diagram to demo page    :48h</span><br></pre></td></tr></table></figure>

<h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><p>有些 Markdown 引擎支持在文档中嵌入的 html 元素。</p>
<p>有些 Markdown 语法所不支持的特性，可以使用 html 元素来支持。</p>
<h3 id="折叠"><a href="#折叠" class="headerlink" title="折叠"></a>折叠</h3><details>
  <summary>折叠内容一</summary>
  <p>展开才能看到的内容</p>
</details>
<details>
  <summary>折叠内容二</summary>
  <p>展开才能看到的内容</p>
</details>

<h3 id="居中"><a href="#居中" class="headerlink" title="居中"></a>居中</h3><div align="center"><p>居中显示的文本</p></div>

<h3 id="图片尺寸"><a href="#图片尺寸" class="headerlink" title="图片尺寸"></a>图片尺寸</h3><div align="center"><img width="100px" src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" /></div>

<h2 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h2><p>推荐 Markdown 编辑器</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.typora.io/">Typora</a> - 个人认为是功能最强的 Markdown 编辑器。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode">Visual Studio Code</a> - 可以通过安装插件，量身打造 Markdown 编辑器。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/marktext/marktext">marktext</a> - 一款简单优雅的 Markdown 编辑器。</li>
<li><a target="_blank" rel="noopener" href="https://stackedit.io/">StackEdit</a> - 在线 Markdown 编辑器。</li>
<li><a target="_blank" rel="noopener" href="https://pandao.github.io/editor.md/">Editor.md</a> - 在线 Markdown 编辑器。</li>
<li><a target="_blank" rel="noopener" href="https://maxiang.io/">Marxico</a> - 一款专为印象笔记（Evernote）打造的 Markdown 编辑器。</li>
</ul>
<blockquote>
<p>想了解更多 Markdown 编辑器可以参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69210764">主流 Markdown 编辑器推荐</a></p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Markdown">https://zh.wikipedia.org/wiki/Markdown</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/guodongxiaren/README">https://github.com/guodongxiaren/README</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tchapi/markdown-cheatsheet">markdown-cheatsheet</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/luong-komorebi/Begin-Latex-in-minutes">Begin-Latex-in-minutes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mermaid-js/mermaid">https://github.com/mermaid-js/mermaid</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.ligoudan.cn/pages/60bb6d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ligoudan.png">
      <meta itemprop="name" content="李狗蛋">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LIGOUDAN">
      <meta itemprop="description" content="天气不错哇，你看这大冰雹下得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LIGOUDAN">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pages/60bb6d/" class="post-title-link" itemprop="url">流量控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-20 11:06:00" itemprop="dateCreated datePublished" datetime="2020-01-20T11:06:00+08:00">2020-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-12 10:02:53" itemprop="dateModified" datetime="2024-12-12T10:02:53+08:00">2024-12-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/" itemprop="url" rel="index"><span itemprop="name">分布式调度</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>13 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h1><blockquote>
<p>在高并发场景下，为了应对瞬时海量请求的压力，保障系统的平稳运行，必须预估系统的流量阈值，通过限流规则阻断处理不过来的请求。</p>
</blockquote>
<h2 id="限流简介"><a href="#限流简介" class="headerlink" title="限流简介"></a>限流简介</h2><p>限流可以认为是服务降级的一种。限流就是<strong>限制系统的输入和输出流量已达到保护系统的目的</strong>。一般来说系统的吞吐量是可以被测算的，为了保证系统的稳定运行，一旦达到的需要限制的阈值，就需要限制流量并采取一些措施以完成限制流量的目的。比如：延迟处理，拒绝处理，或者部分拒绝处理等等。</p>
<p>限流规则包含三个部分：时间粒度，接口粒度，最大限流值。限流规则设置是否合理直接影响到限流是否合理有效。</p>
<h2 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h2><h3 id="固定窗口限流算法"><a href="#固定窗口限流算法" class="headerlink" title="固定窗口限流算法"></a>固定窗口限流算法</h3><h4 id="固定窗口限流算法的原理"><a href="#固定窗口限流算法的原理" class="headerlink" title="固定窗口限流算法的原理"></a>固定窗口限流算法的原理</h4><p>固定窗口限流算法的<strong>基本策略</strong>是：</p>
<ol>
<li>设置一个固定时间窗口，以及这个固定时间窗口内的最大请求数；</li>
<li>为每个固定时间窗口设置一个计数器，用于统计请求数；</li>
<li>一旦请求数超过最大请求数，则请求会被拦截。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748006.png"></p>
<h4 id="固定窗口限流算法的利弊"><a href="#固定窗口限流算法的利弊" class="headerlink" title="固定窗口限流算法的利弊"></a>固定窗口限流算法的利弊</h4><p>固定窗口限流算法的<strong>优点</strong>是：实现简单。</p>
<p>固定窗口限流算法的<strong>缺点</strong>是：存在<strong>临界问题</strong>。所谓临界问题，是指：流量分别集中在一个固定时间窗口的尾部和一个固定时间窗口的头部。举例来说，假设限流规则为每分钟不超过 100 次请求。在第一个时间窗口中，起初没有任何请求，在最后 1 s，收到 100 次请求，由于没有达到阈值，所有请求都通过；在第二个时间窗口中，第 1 秒就收到 100 次请求，而后续没有任何请求。虽然，这两个时间窗口内的流量都符合限流要求，但是在两个时间窗口临界的这 2s 内，实际上有 200 次请求，显然是超过预期吞吐量的，存在压垮系统的可能。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748769.png"></p>
<h4 id="固定窗口限流算法的实现"><a href="#固定窗口限流算法的实现" class="headerlink" title="固定窗口限流算法的实现"></a>固定窗口限流算法的实现</h4><p>【示例】Java 版本的固定窗口限流算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许的最大请求数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxPermits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 窗口期时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> periodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口期时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> shardPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 窗口期截止时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> shardNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求总计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口计数列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AtomicLong&gt; countList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(qps, <span class="number">1000</span>, TimeUnit.MILLISECONDS, shardNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> maxPermits, <span class="type">long</span> period, TimeUnit timeUnit, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">        <span class="built_in">this</span>.periodMillis = timeUnit.toMillis(period);</span><br><span class="line">        <span class="built_in">this</span>.lastPeriodMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">this</span>.shardPeriodMillis = timeUnit.toMillis(period) / shardNum;</span><br><span class="line">        <span class="built_in">this</span>.shardNum = shardNum;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardNum; i++) &#123;</span><br><span class="line">            countList.add(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &gt; lastPeriodMillis) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> <span class="number">0</span>; shardId &lt; shardNum; shardId++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">shardCount</span> <span class="operator">=</span> countList.get(shardId).get();</span><br><span class="line">                totalCount.addAndGet(-shardCount);</span><br><span class="line">                countList.set(shardId, <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">                lastPeriodMillis += shardPeriodMillis;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> (<span class="type">int</span>) (now % periodMillis / shardPeriodMillis);</span><br><span class="line">        <span class="keyword">if</span> (totalCount.get() + <span class="keyword">permits</span> &lt;= maxPermits) &#123;</span><br><span class="line">            countList.get(shardId).addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            totalCount.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="滑动窗口限流算法"><a href="#滑动窗口限流算法" class="headerlink" title="滑动窗口限流算法"></a>滑动窗口限流算法</h3><h4 id="滑动窗口限流算法的原理"><a href="#滑动窗口限流算法的原理" class="headerlink" title="滑动窗口限流算法的原理"></a>滑动窗口限流算法的原理</h4><p>滑动窗口限流算法是对固定窗口限流算法的改进，解决了临界问题。</p>
<p>滑动窗口限流算法的<strong>基本策略</strong>是：</p>
<ul>
<li>将固定时间窗口分片为多个子窗口，每个子窗口的访问次数独立统计；</li>
<li>当请求时间大于当前子窗口的最大时间时，则将当前子窗口废弃，并将计时窗口向前滑动，并将下一个子窗口置为当前窗口。</li>
<li>要保证所有子窗口的统计数之和不能超过阈值。</li>
</ul>
<p>滑动窗口限流算法就是针对固定窗口限流算法的更细粒度的控制，分片越多，则限流越精准。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748277.png"></p>
<h4 id="滑动窗口限流算法的利弊"><a href="#滑动窗口限流算法的利弊" class="headerlink" title="滑动窗口限流算法的利弊"></a>滑动窗口限流算法的利弊</h4><p>滑动窗口限流算法的<strong>优点</strong>是：在滑动窗口限流算法中，临界位置的突发请求都会被算到时间窗口内，因此可以解决计数器算法的临界问题。</p>
<p>滑动窗口限流算法的<strong>缺点</strong>是：</p>
<ul>
<li><strong>额外的内存开销</strong> - 滑动时间窗口限流算法的时间窗口是持续滑动的，并且除了需要一个计数器来记录时间窗口内接口请求次数之外，还需要记录在时间窗口内每个接口请求到达的时间点，所以存在额外的内存开销。</li>
<li><strong>限流的控制粒度受限于窗口分片粒度</strong> - 滑动窗口限流算法，<strong>只能在选定的时间粒度上限流，对选定时间粒度内的更加细粒度的访问频率不做限制</strong>。但是，由于每个分片窗口都有额外的内存开销，所以也并不是分片数越多越好的。</li>
</ul>
<h4 id="滑动窗口限流算法的实现"><a href="#滑动窗口限流算法的实现" class="headerlink" title="滑动窗口限流算法的实现"></a>滑动窗口限流算法的实现</h4><p>【示例】Java 版本的滑动窗口限流算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许的最大请求数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxPermits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 窗口期时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> periodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口期时长</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> shardPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 窗口期截止时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> shardNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求总计数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分片窗口计数列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AtomicLong&gt; countList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(qps, <span class="number">1000</span>, TimeUnit.MILLISECONDS, shardNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> maxPermits, <span class="type">long</span> period, TimeUnit timeUnit, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">        <span class="built_in">this</span>.periodMillis = timeUnit.toMillis(period);</span><br><span class="line">        <span class="built_in">this</span>.lastPeriodMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">this</span>.shardPeriodMillis = timeUnit.toMillis(period) / shardNum;</span><br><span class="line">        <span class="built_in">this</span>.shardNum = shardNum;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardNum; i++) &#123;</span><br><span class="line">            countList.add(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &gt; lastPeriodMillis) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> <span class="number">0</span>; shardId &lt; shardNum; shardId++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">shardCount</span> <span class="operator">=</span> countList.get(shardId).get();</span><br><span class="line">                totalCount.addAndGet(-shardCount);</span><br><span class="line">                countList.set(shardId, <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">                lastPeriodMillis += shardPeriodMillis;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> (<span class="type">int</span>) (now % periodMillis / shardPeriodMillis);</span><br><span class="line">        <span class="keyword">if</span> (totalCount.get() + <span class="keyword">permits</span> &lt;= maxPermits) &#123;</span><br><span class="line">            countList.get(shardId).addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            totalCount.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏桶限流算法"><a href="#漏桶限流算法" class="headerlink" title="漏桶限流算法"></a>漏桶限流算法</h3><h4 id="漏桶限流算法的原理"><a href="#漏桶限流算法的原理" class="headerlink" title="漏桶限流算法的原理"></a>漏桶限流算法的原理</h4><p>漏桶限流算法的<strong>基本策略</strong>是：</p>
<ul>
<li>水（请求）以任意速率由入口进入到漏桶中；</li>
<li>水以固定的速率由出口出水（请求通过）；</li>
<li>漏桶的容量是固定的，如果水的流入速率大于流出速率，最终会导致漏桶中的水溢出（这意味着请求拒绝）。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230749486.png"></p>
<h4 id="漏桶限流算法的利弊"><a href="#漏桶限流算法的利弊" class="headerlink" title="漏桶限流算法的利弊"></a>漏桶限流算法的利弊</h4><p>漏桶限流算法的<strong>优点</strong>是：<strong>消费速率固定</strong>——即无论流量多大，即便是突发的大流量，处理请求的速度始终是固定的。</p>
<p>漏桶限流算法的<strong>缺点</strong>是：不能灵活的调整流量。例如：一个集群通过增减节点的方式，弹性伸缩了其吞吐能力，漏桶限流算法无法随之调整。</p>
<p><strong>漏桶策略适用于间隔性突发流量且流量不用即时处理的场景</strong>。</p>
<h4 id="漏桶限流算法的实现"><a href="#漏桶限流算法的实现" class="headerlink" title="漏桶限流算法的实现"></a>漏桶限流算法的实现</h4><p>【示例】Java 版本的漏桶限流算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QPS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> qps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算的起始时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> beginTimeMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶中当前的水量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">waterNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyBucketRateLimiter</span><span class="params">(<span class="type">int</span> qps, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.qps = qps;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果桶中没有水，直接通过</span></span><br><span class="line">        <span class="keyword">if</span> (waterNum.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            beginTimeMillis = System.currentTimeMillis();</span><br><span class="line">            waterNum.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算水量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">leakedWaterNum</span> <span class="operator">=</span> ((System.currentTimeMillis() - beginTimeMillis) / <span class="number">1000</span>) * qps;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentWaterNum</span> <span class="operator">=</span> waterNum.get() - leakedWaterNum;</span><br><span class="line">        waterNum.set(Math.max(<span class="number">0</span>, currentWaterNum));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重置时间</span></span><br><span class="line">        beginTimeMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (waterNum.get() + <span class="keyword">permits</span> &lt; capacity) &#123;</span><br><span class="line">            waterNum.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="令牌桶限流算法"><a href="#令牌桶限流算法" class="headerlink" title="令牌桶限流算法"></a>令牌桶限流算法</h3><h4 id="令牌桶限流算法的原理"><a href="#令牌桶限流算法的原理" class="headerlink" title="令牌桶限流算法的原理"></a>令牌桶限流算法的原理</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230750231.png"></p>
<p>令牌桶算法的<strong>原理</strong>：</p>
<ol>
<li>接口限制 T 秒内最大访问次数为 N，则每隔 T&#x2F;N 秒会放一个 token 到桶中</li>
<li>桶内最多存放 M 个 token，如果 token 到达时令牌桶已经满了，那么这个 token 就会被丢弃</li>
<li>接口请求会先从令牌桶中取 token，拿到 token 则处理接口请求，拿不到 token 则进行限流处理</li>
</ol>
<h4 id="令牌桶限流算法的利弊"><a href="#令牌桶限流算法的利弊" class="headerlink" title="令牌桶限流算法的利弊"></a>令牌桶限流算法的利弊</h4><p>因为令牌桶存放了很多令牌，那么大量的突发请求会被执行，但是它不会出现临界问题，在令牌用完之后，令牌是以一个恒定的速率添加到令牌桶中的，因此不能再次发送大量突发请求。</p>
<p>规定固定容量的桶，token 以固定速度往桶内填充，当桶满时 token 不会被继续放入，每过来一个请求把 token 从桶中移除,如果桶中没有 token 不能请求。</p>
<p><strong>令牌桶算法适用于有突发特性的流量，且流量需要即时处理的场景</strong>。</p>
<h4 id="令牌桶限流算法的实现"><a href="#令牌桶限流算法的实现" class="headerlink" title="令牌桶限流算法的实现"></a>令牌桶限流算法的实现</h4><p>【示例】Java 实现令牌桶算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 令牌桶限流算法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:forbreak@163.com&quot;&gt;Zhang Peng&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-01-18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QPS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> qps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上一次令牌发放时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> endTimeMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶中当前的令牌数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">tokenNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenBucketRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.qps = qps;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.endTimeMillis = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">gap</span> <span class="operator">=</span> now - endTimeMillis;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算令牌数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">newTokenNum</span> <span class="operator">=</span> (gap * qps / <span class="number">1000</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTokenNum</span> <span class="operator">=</span> tokenNum.get() + newTokenNum;</span><br><span class="line">        tokenNum.set(Math.min(capacity, currentTokenNum));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tokenNum.get() &lt; <span class="keyword">permits</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tokenNum.addAndGet(-<span class="keyword">permits</span>);</span><br><span class="line">            endTimeMillis = now;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>扩展</strong></p>
<p>Guava 的 RateLimiter 工具类就是基于令牌桶算法实现，其源码分析可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter 基于漏桶算法，但它参考了令牌桶算法</a></p>
</blockquote>
<h3 id="限流算法测试"><a href="#限流算法测试" class="headerlink" title="限流算法测试"></a>限流算法测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ThreadUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">qps</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= 固定时间窗口限流算法 =======================&quot;</span>);</span><br><span class="line">        <span class="type">FixedWindowRateLimiter</span> <span class="variable">fixedWindowRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FixedWindowRateLimiter</span>(qps);</span><br><span class="line">        testRateLimit(fixedWindowRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= 滑动时间窗口限流算法 =======================&quot;</span>);</span><br><span class="line">        <span class="type">SlidingWindowRateLimiter</span> <span class="variable">slidingWindowRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SlidingWindowRateLimiter</span>(qps, <span class="number">10</span>);</span><br><span class="line">        testRateLimit(slidingWindowRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= 漏桶限流算法 =======================&quot;</span>);</span><br><span class="line">        <span class="type">LeakyBucketRateLimiter</span> <span class="variable">leakyBucketRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeakyBucketRateLimiter</span>(qps, <span class="number">100</span>);</span><br><span class="line">        testRateLimit(leakyBucketRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= 令牌桶限流算法 =======================&quot;</span>);</span><br><span class="line">        <span class="type">TokenBucketRateLimiter</span> <span class="variable">tokenBucketRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenBucketRateLimiter</span>(qps, <span class="number">100</span>);</span><br><span class="line">        testRateLimit(tokenBucketRateLimiter, qps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testRateLimit</span><span class="params">(RateLimiter rateLimiter, <span class="type">int</span> qps)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">okNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">limitNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> ThreadUtil.newFixedExecutor(<span class="number">10</span>, <span class="string">&quot;限流测试&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">threadNum</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadNum);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadNum; i++) &#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    batchRequest(rateLimiter, okNum, limitNum, <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;发生异常!&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">long</span> <span class="variable">gap</span> <span class="operator">=</span> endTime - beginTime;</span><br><span class="line">            log.info(<span class="string">&quot;限流 QPS: &#123;&#125; -&gt; 实际结果：耗时 &#123;&#125; ms，&#123;&#125; 次请求成功，&#123;&#125; 次请求被限流，实际 QPS: &#123;&#125;&quot;</span>,</span><br><span class="line">                qps, gap, okNum.get(), limitNum.get(), okNum.get() * <span class="number">1000</span> / gap);</span><br><span class="line">            <span class="keyword">if</span> (okNum.get() == qps) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;限流符合预期&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;发生异常!&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">batchRequest</span><span class="params">(RateLimiter rateLimiter, AtomicInteger okNum, AtomicInteger limitNum, <span class="type">int</span> num)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; num; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rateLimiter.tryAcquire(<span class="number">1</span>)) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">                okNum.getAndIncrement();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;请求限流&quot;</span>);</span><br><span class="line">                limitNum.getAndIncrement();</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(RandomUtil.randomInt(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分布式限流"><a href="#分布式限流" class="headerlink" title="分布式限流"></a>分布式限流</h2><p>前文中，基于 Java 实现的限流算法示例只能运行在单节点，无法有效应对集群部署的服务，这中场景下就需要分布式限流。</p>
<p>实现分布式限流的一种简单解决方案是使用 Redis + Lua 来实现。使用二者来开发的原因是：1. Redis 的性能极高；2. Redis 支持以原子操作的方式执行 Lua 脚本。</p>
<h3 id="Redis-Lua-实现的固定窗口限流算法"><a href="#Redis-Lua-实现的固定窗口限流算法" class="headerlink" title="Redis + Lua 实现的固定窗口限流算法"></a>Redis + Lua 实现的固定窗口限流算法</h3><p>Redis + Lua 实现的固定窗口限流算法实现思路：</p>
<ul>
<li>根据实际需要，将当前时间格式化为天（<code>yyyyMMdd</code>）、时（<code>yyyyMMddHH</code>）、分（<code>yyyyMMddHHmm</code>）、秒（<code>yyyyMMddHHmmss</code>），并作为 Redis 的 String 类型 Key。该 Key 可以视为一个固定时间窗口，其中的 value 用于统计访问量；</li>
<li>用于代表不同粒度的时间窗口按需设置过期时间；</li>
<li>一旦达到窗口的限流阈值时，请求被限流；否则请求通过。</li>
</ul>
<p>【示例】Redis + Lua 实现的固定窗口限流算法</p>
<p>下面的代码片段模拟通过一个大小为 1 分钟的固定时间窗口进行限流，阈值为 100，过期时间 60s。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;rate:limit:202401222100&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// -- 缓存 Key</span></span><br><span class="line">    <span class="comment">// local key = KEYS[1]</span></span><br><span class="line">    <span class="comment">// -- 访问请求数</span></span><br><span class="line">    <span class="comment">// local permits = tonumber(ARGV[1])</span></span><br><span class="line">    <span class="comment">// -- 过期时间</span></span><br><span class="line">    <span class="comment">// local seconds = tonumber(ARGV[2])</span></span><br><span class="line">    <span class="comment">// -- 限流阈值</span></span><br><span class="line">    <span class="comment">// local limit = tonumber(ARGV[3])</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// -- 获取统计值</span></span><br><span class="line">    <span class="comment">// local count = tonumber(redis.call(&#x27;GET&#x27;, key) or &quot;0&quot;)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// if count + permits &gt; limit then</span></span><br><span class="line">    <span class="comment">//   -- 触发限流</span></span><br><span class="line">    <span class="comment">//   return 0</span></span><br><span class="line">    <span class="comment">// else</span></span><br><span class="line">    <span class="comment">//   redis.call(&#x27;INCRBY&#x27;, key, permits)</span></span><br><span class="line">    <span class="comment">//   redis.call(&#x27;EXPIRE&#x27;, key, seconds)</span></span><br><span class="line">    <span class="comment">//   return count + permits</span></span><br><span class="line">    <span class="comment">// end</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">        <span class="string">&quot;-- 缓存 Key\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;local key = KEYS[1]\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;-- 访问请求数\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;local permits = tonumber(ARGV[1])\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;-- 过期时间\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;local seconds = tonumber(ARGV[2])\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;-- 限流阈值\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;local limit = tonumber(ARGV[3])\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;-- 获取统计值\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;local count = tonumber(redis.call(&#x27;GET&#x27;, key) or \&quot;0\&quot;)\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;if count + permits &gt; limit then\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;  -- 触发限流\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;  return 0\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;else\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;  redis.call(&#x27;INCRBY&#x27;, key, permits)\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;  redis.call(&#x27;EXPIRE&#x27;, key, seconds)\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;  return count + permits\n&quot;</span></span><br><span class="line">            + <span class="string">&quot;end&quot;</span>;</span><br><span class="line">    List&lt;String&gt; keys = Collections.singletonList(key);</span><br><span class="line">    List&lt;String&gt; args = Arrays.asList(String.valueOf(<span class="keyword">permits</span>), String.valueOf(seconds), String.valueOf(limit));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">eval</span> <span class="operator">=</span> jedis.eval(script, keys, args);</span><br><span class="line">    <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">long</span>) eval;</span><br><span class="line">    <span class="keyword">return</span> value != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryAcquire(<span class="number">10</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="comment">// 请求失败</span></span><br><span class="line"><span class="comment">// rate:limit:202401222100 统计值达到 100</span></span><br></pre></td></tr></table></figure>

<h3 id="Redis-Lua-实现的令牌桶限流算法"><a href="#Redis-Lua-实现的令牌桶限流算法" class="headerlink" title="Redis + Lua 实现的令牌桶限流算法"></a>Redis + Lua 实现的令牌桶限流算法</h3><p>【示例】基于 Redis Lua 令牌桶限流算法实现</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 令牌桶限流</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 令牌的唯一标识</span></span><br><span class="line"><span class="keyword">local</span> bucketKey = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 上次请求的时间</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 令牌桶的容量</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">-- 请求令牌的数量</span></span><br><span class="line"><span class="keyword">local</span> permits = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="comment">-- 令牌流入的速率</span></span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="comment">-- 当前时间</span></span><br><span class="line"><span class="keyword">local</span> curr_mill_time = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加令牌</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前令牌的数量</span></span><br><span class="line"><span class="keyword">local</span> current_limit = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, bucketKey) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"><span class="comment">-- 获取上次请求的时间</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_time = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, last_mill_request_key) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"><span class="comment">-- 计算向桶里添加令牌的数量</span></span><br><span class="line"><span class="keyword">if</span> last_mill_request_time == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">	<span class="comment">-- 令牌桶初始化</span></span><br><span class="line">	<span class="comment">-- 更新上次请求时间</span></span><br><span class="line">	redis.call(<span class="string">&quot;HSET&quot;</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">local</span> add_token_num = <span class="built_in">math</span>.<span class="built_in">floor</span>((curr_mill_time - last_mill_request_time) * rate)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新令牌的数量</span></span><br><span class="line"><span class="keyword">if</span> current_limit + add_token_num &gt; limit <span class="keyword">then</span></span><br><span class="line">    current_limit = limit</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	current_limit = current_limit + add_token_num</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">&quot;HSET&quot;</span>,bucketKey, current_limit)</span><br><span class="line"><span class="comment">-- 设置过期时间</span></span><br><span class="line">redis.call(<span class="string">&quot;EXPIRE&quot;</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 限流判断</span></span><br><span class="line"><span class="keyword">if</span> current_limit - permits &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 达到限流大小</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- 没有达到限流大小</span></span><br><span class="line">	current_limit = current_limit - permits</span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">&quot;HSET&quot;</span>, bucketKey, current_limit)</span><br><span class="line">    <span class="comment">-- 设置过期时间</span></span><br><span class="line">    redis.call(<span class="string">&quot;EXPIRE&quot;</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line">	<span class="comment">-- 更新上次请求的时间</span></span><br><span class="line">	redis.call(<span class="string">&quot;HSET&quot;</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="限流工具"><a href="#限流工具" class="headerlink" title="限流工具"></a>限流工具</h2><p>前面介绍了限流算法的基本原理和一些简单的实现。但在生产环境，我们一般应该使用更成熟的限流工具。</p>
<ul>
<li><blockquote>
<p>Guava 的 <code>RateLimiter</code>：RateLimiter 基于漏桶算法，但它参考了令牌桶算法。具体用法可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter 基于漏桶算法，但它参考了令牌桶算法</a></p>
</blockquote>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix">Hystrix</a>：经典的限流、熔断工具，很值得借鉴学习。注：官方已停止发布版本。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel</a>：阿里的限流、熔断工具。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11322972.html">《大型网站技术架构：核心原理与案例分析》</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/76cc8ba5ca91">谈谈限流算法的几种实现</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/huifer-how-to-limit-current.md">如何限流？在工作中是怎么做的？说一下具体的实现？</a></li>
<li><a target="_blank" rel="noopener" href="https://gongfukangee.github.io/2019/04/04/Limit/">浅析限流算法</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter 基于漏桶算法，但它参考了令牌桶算法</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/29/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><span class="page-number current">30</span><a class="page-number" href="/page/31/">31</a><span class="space">&hellip;</span><a class="page-number" href="/page/47/">47</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/31/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">李狗蛋</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">3.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">53:28</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/yiyirushi/" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
